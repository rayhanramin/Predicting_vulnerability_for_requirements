<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2809:af67b109386e987f723d6c1660ea803f34115dc7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ af67b109386e987f723d6c1660ea803f34115dc7" />
<meta property="og:url" content="/comm-central/rev/af67b109386e987f723d6c1660ea803f34115dc7" />
<meta property="og:description" content="Bug 458159 -- [Vista only] Drag'n'drop attachment out of Shredder (desktop or other folder) creates 0 byte file. The fix is to set the content length correctly for mailnews URLs. Also move a lot of progress code over to 64-bit integers. r=bienvenu, sr=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / af67b109386e987f723d6c1660ea803f34115dc7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/af67b109386e987f723d6c1660ea803f34115dc7">shortlog</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/af67b109386e987f723d6c1660ea803f34115dc7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7">files</a> |
changeset |
<a href="/comm-central/raw-rev/af67b109386e987f723d6c1660ea803f34115dc7">raw</a>  | <a href="/comm-central/archive/af67b109386e987f723d6c1660ea803f34115dc7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=458159">Bug 458159</a> -- [Vista only] Drag'n'drop attachment out of Shredder (desktop or other folder) creates 0 byte file. The fix is to set the content length correctly for mailnews URLs. Also move a lot of progress code over to 64-bit integers. r=bienvenu, sr=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#100;&#100;&#104;&#97;&#114;&#116;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#105;&#100;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 21 May 2009 12:22:51 +0530</td></tr>

<tr>
 <td>changeset 2809</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/af67b109386e987f723d6c1660ea803f34115dc7">af67b109386e987f723d6c1660ea803f34115dc7</a></td>
</tr>



<tr>
<td>parent 2808</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/61d5f8fd0fe2d3bca890b4b7e69af89c270df8f0">61d5f8fd0fe2d3bca890b4b7e69af89c270df8f0</a>
</td>
</tr>

<tr>
<td>child 2810</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7075e80889c6ef4626e6f537f196e1ccd2a5cf9d">7075e80889c6ef4626e6f537f196e1ccd2a5cf9d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=af67b109386e987f723d6c1660ea803f34115dc7">2277</a></td></tr>
<tr><td>push user</td><td>sid.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 09 Jun 2009 11:35:25 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@af67b109386e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=af67b109386e987f723d6c1660ea803f34115dc7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=af67b109386e987f723d6c1660ea803f34115dc7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=af67b109386e987f723d6c1660ea803f34115dc7&newProject=comm-central&newRevision=af67b109386e987f723d6c1660ea803f34115dc7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=af67b109386e987f723d6c1660ea803f34115dc7&newProject=comm-central&newRevision=af67b109386e987f723d6c1660ea803f34115dc7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=af67b109386e987f723d6c1660ea803f34115dc7&newProject=comm-central&newRevision=af67b109386e987f723d6c1660ea803f34115dc7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=458159">458159</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=458159">Bug 458159</a> -- [Vista only] Drag'n'drop attachment out of Shredder (desktop or other folder) creates 0 byte file. The fix is to set the content length correctly for mailnews URLs. Also move a lot of progress code over to 64-bit integers. r=bienvenu, sr=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">mailnews/base/public/nsIMsgMailNewsUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/public/nsIMsgMailNewsUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">mailnews/base/util/nsMsgMailNewsUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgMailNewsUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">mailnews/base/util/nsMsgProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/base/util/nsMsgProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">mailnews/imap/public/nsIImapMailFolderSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/public/nsIImapMailFolderSink.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">mailnews/imap/test/unit/test_imapContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/imap/test/unit/test_imapContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">mailnews/local/src/nsMailboxProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/src/nsMailboxProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">mailnews/local/test/unit/test_mailboxContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/local/test/unit/test_mailboxContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">mailnews/news/src/nsNntpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/src/nsNntpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">mailnews/news/test/unit/test_nntpContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/news/test/unit/test_nntpContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">mailnews/test/data/multipart-complex2</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">file</a> |
<a href="/comm-central/annotate/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">annotate</a> |
<a href="/comm-central/diff/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">diff</a> |
<a href="/comm-central/comparison/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">comparison</a> |
<a href="/comm-central/log/af67b109386e987f723d6c1660ea803f34115dc7/mailnews/test/data/multipart-complex2">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -48,17 +48,17 @@ interface nsIMsgSearchSession;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsICacheEntryDescriptor;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsICacheSession;</span>
<a href="#l1.6"></a><span id="l1.6"> interface nsIMimeHeaders;</span>
<a href="#l1.7"></a><span id="l1.7"> interface nsIStreamListener;</span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIMsgFolder;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIMsgHeaderSink;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgDBHdr;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(2FB327C2-00A3-4e3f-8CD6-93BED40BD621)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(01850820-e382-4b0f-a109-23d69280876b)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l1.15"></a><span id="l1.15">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.16"></a><span id="l1.16">   // Eventually we'd like to push this type of functionality up into nsIURI.</span>
<a href="#l1.17"></a><span id="l1.17">   // The idea is to allow the &quot;application&quot; (the part of the code which wants to </span>
<a href="#l1.18"></a><span id="l1.18">   // run a url in order to perform some action) to register itself as a listener</span>
<a href="#l1.19"></a><span id="l1.19">   // on url. As a url listener, the app will be informed when the url begins to run</span>
<a href="#l1.20"></a><span id="l1.20">   // and when the url is finished. </span>
<a href="#l1.21"></a><span id="l1.21">   ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -80,16 +80,22 @@ interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l1.23"></a><span id="l1.23">    * @exception NS_ERROR_FAILURE    May be thrown if the url does not</span>
<a href="#l1.24"></a><span id="l1.24">    *                                relate to a folder, e.g. standalone</span>
<a href="#l1.25"></a><span id="l1.25">    *                                .eml messages.</span>
<a href="#l1.26"></a><span id="l1.26">    */</span>
<a href="#l1.27"></a><span id="l1.27">   attribute nsIMsgFolder folder;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   attribute nsIMsgStatusFeedback statusFeedback;</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  /**</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   * The maximum progress for this URL. This might be a count, or it might</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * be a number of bytes. A value of -1 indicates that this is unknown.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   */</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  attribute long long maxProgress;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+</span>
<a href="#l1.37"></a><span id="l1.37">   attribute nsIMsgWindow msgWindow;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">   // current mime headers if reading message</span>
<a href="#l1.40"></a><span id="l1.40">   attribute nsIMimeHeaders mimeHeaders;</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   // the load group is computed from the msgWindow</span>
<a href="#l1.43"></a><span id="l1.43">   readonly attribute nsILoadGroup loadGroup;</span>
<a href="#l1.44"></a><span id="l1.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -253,23 +253,23 @@ public:</span>
<a href="#l2.4"></a><span id="l2.4">   }             m_outputFormat;</span>
<a href="#l2.5"></a><span id="l2.5">   nsString      m_msgBuffer;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   nsCString     m_contentType;    // used only when saving attachment</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   nsCOMPtr&lt;nsITransfer&gt; mTransfer;</span>
<a href="#l2.10"></a><span id="l2.10">   nsCOMPtr&lt;nsIUrlListener&gt; mListener;</span>
<a href="#l2.11"></a><span id="l2.11">   nsCOMPtr&lt;nsIURI&gt; mListenerUri;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  PRInt32 mProgress;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  PRInt32 mContentLength;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  PRInt64 mProgress;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  PRInt64 mMaxProgress;</span>
<a href="#l2.16"></a><span id="l2.16">   PRBool  mCanceled;</span>
<a href="#l2.17"></a><span id="l2.17">   PRBool  mInitialized;</span>
<a href="#l2.18"></a><span id="l2.18">   PRBool  mUrlHasStopped;</span>
<a href="#l2.19"></a><span id="l2.19">   PRBool  mRequestHasStopped;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  nsresult InitializeDownload(nsIRequest * aRequest, PRInt32 aBytesDownloaded);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  nsresult InitializeDownload(nsIRequest * aRequest, PRUint32 aBytesDownloaded);</span>
<a href="#l2.22"></a><span id="l2.22"> };</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> class nsSaveAllAttachmentsState</span>
<a href="#l2.25"></a><span id="l2.25"> {</span>
<a href="#l2.26"></a><span id="l2.26"> public:</span>
<a href="#l2.27"></a><span id="l2.27">   nsSaveAllAttachmentsState(PRUint32 count,</span>
<a href="#l2.28"></a><span id="l2.28">                             const char **contentTypeArray,</span>
<a href="#l2.29"></a><span id="l2.29">                             const char **urlArray,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -1432,17 +1432,17 @@ nsSaveMsgListener::nsSaveMsgListener(nsI</span>
<a href="#l2.31"></a><span id="l2.31">   mListener = aListener;</span>
<a href="#l2.32"></a><span id="l2.32">   mUrlHasStopped = PR_FALSE;</span>
<a href="#l2.33"></a><span id="l2.33">   mRequestHasStopped = PR_FALSE;</span>
<a href="#l2.34"></a><span id="l2.34">   </span>
<a href="#l2.35"></a><span id="l2.35">     // rhp: for charset handling</span>
<a href="#l2.36"></a><span id="l2.36">   m_doCharsetConversion = PR_FALSE;</span>
<a href="#l2.37"></a><span id="l2.37">   m_saveAllAttachmentsState = nsnull;</span>
<a href="#l2.38"></a><span id="l2.38">   mProgress = 0;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  mContentLength = -1;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  mMaxProgress = -1;</span>
<a href="#l2.41"></a><span id="l2.41">   mCanceled = PR_FALSE;</span>
<a href="#l2.42"></a><span id="l2.42">   m_outputFormat = eUnknown;</span>
<a href="#l2.43"></a><span id="l2.43">   mInitialized = PR_FALSE;</span>
<a href="#l2.44"></a><span id="l2.44">   m_dataBuffer = new char[FOUR_K];</span>
<a href="#l2.45"></a><span id="l2.45"> }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47"> nsSaveMsgListener::~nsSaveMsgListener()</span>
<a href="#l2.48"></a><span id="l2.48"> {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -1559,44 +1559,51 @@ nsSaveMsgListener::OnStopCopy(nsresult a</span>
<a href="#l2.50"></a><span id="l2.50">   if (m_file)</span>
<a href="#l2.51"></a><span id="l2.51">     m_file-&gt;Remove(PR_FALSE);</span>
<a href="#l2.52"></a><span id="l2.52">   Release(); // all done kill ourself</span>
<a href="#l2.53"></a><span id="l2.53">   return aStatus;</span>
<a href="#l2.54"></a><span id="l2.54"> }</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> // initializes the progress window if we are going to show one</span>
<a href="#l2.57"></a><span id="l2.57"> // and for OSX, sets creator flags on the output file</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest, PRInt32 aBytesDownloaded)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest, PRUint32 aBytesDownloaded)</span>
<a href="#l2.60"></a><span id="l2.60"> {</span>
<a href="#l2.61"></a><span id="l2.61">   nsresult rv = NS_OK;</span>
<a href="#l2.62"></a><span id="l2.62">   </span>
<a href="#l2.63"></a><span id="l2.63">   mInitialized = PR_TRUE;</span>
<a href="#l2.64"></a><span id="l2.64">   nsCOMPtr&lt;nsIChannel&gt; channel (do_QueryInterface(aRequest));</span>
<a href="#l2.65"></a><span id="l2.65">   </span>
<a href="#l2.66"></a><span id="l2.66">   if (!channel)</span>
<a href="#l2.67"></a><span id="l2.67">     return rv;</span>
<a href="#l2.68"></a><span id="l2.68">   </span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  // Set content length if we haven't already got it.</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  if (mContentLength == -1)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    channel-&gt;GetContentLength(&amp;mContentLength);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  // Get the max progress from the URL if we haven't already got it.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  if (mMaxProgress == -1)</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    if (mailnewsUrl)</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+      mailnewsUrl-&gt;GetMaxProgress(&amp;mMaxProgress);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  }</span>
<a href="#l2.81"></a><span id="l2.81">   </span>
<a href="#l2.82"></a><span id="l2.82">   if (!m_contentType.IsEmpty())</span>
<a href="#l2.83"></a><span id="l2.83">   {</span>
<a href="#l2.84"></a><span id="l2.84">     nsCOMPtr&lt;nsIMIMEService&gt; mimeService (do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l2.85"></a><span id="l2.85">     nsCOMPtr&lt;nsIMIMEInfo&gt; mimeinfo;</span>
<a href="#l2.86"></a><span id="l2.86">     </span>
<a href="#l2.87"></a><span id="l2.87">     mimeService-&gt;GetFromTypeAndExtension(m_contentType, EmptyCString(), getter_AddRefs(mimeinfo));</span>
<a href="#l2.88"></a><span id="l2.88">     </span>
<a href="#l2.89"></a><span id="l2.89">     nsCOMPtr&lt;nsILocalFile&gt; outputFile = do_QueryInterface(m_file);</span>
<a href="#l2.90"></a><span id="l2.90">     </span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      // create a download progress window</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-      // XXX: we don't want to show the progress dialog if the download is really small.</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-      // but what is a small download? Well that's kind of arbitrary</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-      // so make an arbitrary decision based on the content length of the attachment</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    if (mContentLength != -1 &amp;&amp; mContentLength &gt; aBytesDownloaded * 2)</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    // create a download progress window</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    // We don't want to show the progress dialog if the download is really small.</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    // but what is a small download? Well that's kind of arbitrary</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    // so make an arbitrary decision based on the content length of the</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+    // attachment -- show it if less than half of the download has completed</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    if (mMaxProgress != -1 &amp;&amp; mMaxProgress &gt; aBytesDownloaded * 2)</span>
<a href="#l2.102"></a><span id="l2.102">     {</span>
<a href="#l2.103"></a><span id="l2.103">       nsCOMPtr&lt;nsITransfer&gt; tr = do_CreateInstance(NS_TRANSFER_CONTRACTID, &amp;rv);</span>
<a href="#l2.104"></a><span id="l2.104">       if (tr &amp;&amp; outputFile)</span>
<a href="#l2.105"></a><span id="l2.105">       {</span>
<a href="#l2.106"></a><span id="l2.106">         PRTime timeDownloadStarted = PR_Now();</span>
<a href="#l2.107"></a><span id="l2.107">         </span>
<a href="#l2.108"></a><span id="l2.108">         nsCOMPtr&lt;nsIURI&gt; outputURI;</span>
<a href="#l2.109"></a><span id="l2.109">         NS_NewFileURI(getter_AddRefs(outputURI), outputFile);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineat">@@ -1753,17 +1760,17 @@ nsSaveMsgListener::OnStopRequest(nsIRequ</span>
<a href="#l2.111"></a><span id="l2.111">       </span>
<a href="#l2.112"></a><span id="l2.112">       delete m_saveAllAttachmentsState;</span>
<a href="#l2.113"></a><span id="l2.113">       m_saveAllAttachmentsState = nsnull;</span>
<a href="#l2.114"></a><span id="l2.114">     }</span>
<a href="#l2.115"></a><span id="l2.115">   }</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">   if(mTransfer)</span>
<a href="#l2.118"></a><span id="l2.118">   {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    mTransfer-&gt;OnProgressChange(nsnull, nsnull, mContentLength, mContentLength, mContentLength, mContentLength);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    mTransfer-&gt;OnProgressChange64(nsnull, nsnull, mMaxProgress, mMaxProgress, mMaxProgress, mMaxProgress);</span>
<a href="#l2.121"></a><span id="l2.121">     mTransfer-&gt;OnStateChange(nsnull, nsnull, nsIWebProgressListener::STATE_STOP |</span>
<a href="#l2.122"></a><span id="l2.122">       nsIWebProgressListener::STATE_IS_NETWORK, NS_OK);</span>
<a href="#l2.123"></a><span id="l2.123">     mTransfer = nsnull; // break any circular dependencies between the progress dialog and use</span>
<a href="#l2.124"></a><span id="l2.124">   }</span>
<a href="#l2.125"></a><span id="l2.125">   </span>
<a href="#l2.126"></a><span id="l2.126">   if (mUrlHasStopped &amp;&amp; mListener)</span>
<a href="#l2.127"></a><span id="l2.127">     mListener-&gt;OnStopRunningUrl(mListenerUri, rv);</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineat">@@ -1811,17 +1818,17 @@ nsSaveMsgListener::OnDataAvailable(nsIRe</span>
<a href="#l2.130"></a><span id="l2.130">         else</span>
<a href="#l2.131"></a><span id="l2.131">           rv = m_outputStream-&gt;Write(m_dataBuffer, readCount, &amp;writeCount);</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133">         available -= readCount;</span>
<a href="#l2.134"></a><span id="l2.134">       }</span>
<a href="#l2.135"></a><span id="l2.135">     }</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137">     if (NS_SUCCEEDED(rv) &amp;&amp; mTransfer) // Send progress notification.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-      mTransfer-&gt;OnProgressChange(nsnull, request, mProgress, mContentLength, mProgress, mContentLength);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      mTransfer-&gt;OnProgressChange64(nsnull, request, mProgress, mMaxProgress, mProgress, mMaxProgress);</span>
<a href="#l2.140"></a><span id="l2.140">   }</span>
<a href="#l2.141"></a><span id="l2.141">   return rv;</span>
<a href="#l2.142"></a><span id="l2.142"> }</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144"> #define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146"> nsresult</span>
<a href="#l2.147"></a><span id="l2.147"> nsMessenger::InitStringBundle()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -60,16 +60,17 @@ nsMsgMailNewsUrl::nsMsgMailNewsUrl()</span>
<a href="#l3.4"></a><span id="l3.4"> {</span>
<a href="#l3.5"></a><span id="l3.5">   // nsIURI specific state</span>
<a href="#l3.6"></a><span id="l3.6">   m_errorMessage = nsnull;</span>
<a href="#l3.7"></a><span id="l3.7">   m_runningUrl = PR_FALSE;</span>
<a href="#l3.8"></a><span id="l3.8">   m_updatingFolder = PR_FALSE;</span>
<a href="#l3.9"></a><span id="l3.9">   m_addContentToCache = PR_FALSE;</span>
<a href="#l3.10"></a><span id="l3.10">   m_msgIsInLocalCache = PR_FALSE;</span>
<a href="#l3.11"></a><span id="l3.11">   m_suppressErrorMsgs = PR_FALSE;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  mMaxProgress = -1;</span>
<a href="#l3.13"></a><span id="l3.13">   </span>
<a href="#l3.14"></a><span id="l3.14">   m_baseURL = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l3.15"></a><span id="l3.15"> }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> #define NOTIFY_URL_LISTENERS(propertyfunc_, params_)                   \</span>
<a href="#l3.18"></a><span id="l3.18">   PR_BEGIN_MACRO                                                       \</span>
<a href="#l3.19"></a><span id="l3.19">   nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt; &gt;::ForwardIterator iter(mUrlListeners); \</span>
<a href="#l3.20"></a><span id="l3.20">   while (iter.HasMore()) {                                             \</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -248,16 +249,28 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetStatu</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> NS_IMETHODIMP nsMsgMailNewsUrl::SetStatusFeedback(nsIMsgStatusFeedback *aMsgFeedback)</span>
<a href="#l3.24"></a><span id="l3.24"> {</span>
<a href="#l3.25"></a><span id="l3.25">   if (aMsgFeedback)</span>
<a href="#l3.26"></a><span id="l3.26">     m_statusFeedbackWeak = do_GetWeakReference(aMsgFeedback);</span>
<a href="#l3.27"></a><span id="l3.27">   return NS_OK;</span>
<a href="#l3.28"></a><span id="l3.28"> }</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMaxProgress(PRInt64 *aMaxProgress)</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+{</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  *aMaxProgress = mMaxProgress;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+}</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMaxProgress(PRInt64 aMaxProgress)</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+{</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  mMaxProgress = aMaxProgress;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+}</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42"> NS_IMETHODIMP nsMsgMailNewsUrl::GetLoadGroup(nsILoadGroup **aLoadGroup)</span>
<a href="#l3.43"></a><span id="l3.43"> {</span>
<a href="#l3.44"></a><span id="l3.44">   *aLoadGroup = nsnull;</span>
<a href="#l3.45"></a><span id="l3.45">   // note: it is okay to return a null load group and not return an error</span>
<a href="#l3.46"></a><span id="l3.46">   // it's possible the url really doesn't have load group</span>
<a href="#l3.47"></a><span id="l3.47">   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup (do_QueryReferent(m_loadGroupWeak));</span>
<a href="#l3.48"></a><span id="l3.48">   if (!loadGroup)</span>
<a href="#l3.49"></a><span id="l3.49">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -87,16 +87,17 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4">   nsWeakPtr m_loadGroupWeak;</span>
<a href="#l4.5"></a><span id="l4.5">   nsCOMPtr&lt;nsIMimeHeaders&gt; mMimeHeaders;</span>
<a href="#l4.6"></a><span id="l4.6">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l4.7"></a><span id="l4.7">   nsCOMPtr&lt;nsICacheEntryDescriptor&gt; m_memCacheEntry;</span>
<a href="#l4.8"></a><span id="l4.8">   nsCOMPtr&lt;nsICacheSession&gt; m_imageCacheSession;</span>
<a href="#l4.9"></a><span id="l4.9">   nsCOMPtr&lt;nsISupportsArray&gt; m_cachedMemCacheEntries;</span>
<a href="#l4.10"></a><span id="l4.10">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; mMsgHeaderSink;</span>
<a href="#l4.11"></a><span id="l4.11">   char *m_errorMessage;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  PRInt64 mMaxProgress;</span>
<a href="#l4.13"></a><span id="l4.13">   PRBool m_runningUrl;</span>
<a href="#l4.14"></a><span id="l4.14">   PRBool m_updatingFolder;</span>
<a href="#l4.15"></a><span id="l4.15">   PRBool m_addContentToCache;</span>
<a href="#l4.16"></a><span id="l4.16">   PRBool m_msgIsInLocalCache;</span>
<a href="#l4.17"></a><span id="l4.17">   PRBool m_suppressErrorMsgs;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   // the following field is really a bit of a hack to make </span>
<a href="#l4.20"></a><span id="l4.20">   // open attachments work. The external applications code sometimes tries to figure out the right</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -82,16 +82,17 @@ static PRUnichar *FormatStringWithHostNa</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> nsMsgProtocol::nsMsgProtocol(nsIURI * aURL)</span>
<a href="#l5.7"></a><span id="l5.7"> {</span>
<a href="#l5.8"></a><span id="l5.8">   m_flags = 0;</span>
<a href="#l5.9"></a><span id="l5.9">   m_readCount = 0;</span>
<a href="#l5.10"></a><span id="l5.10">   mLoadFlags = 0;</span>
<a href="#l5.11"></a><span id="l5.11">   m_socketIsOpen = PR_FALSE;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  mContentLength = -1;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">   GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;tempMessage.eml&quot;,</span>
<a href="#l5.15"></a><span id="l5.15">                                   getter_AddRefs(m_tempMsgFile));</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">   mSuppressListenerNotifications = PR_FALSE;</span>
<a href="#l5.18"></a><span id="l5.18">   InitFromURI(aURL);</span>
<a href="#l5.19"></a><span id="l5.19"> }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -634,17 +635,23 @@ NS_IMETHODIMP nsMsgProtocol::GetContentC</span>
<a href="#l5.22"></a><span id="l5.22"> NS_IMETHODIMP nsMsgProtocol::SetContentCharset(const nsACString &amp;aContentCharset)</span>
<a href="#l5.23"></a><span id="l5.23"> {</span>
<a href="#l5.24"></a><span id="l5.24">   NS_WARNING(&quot;nsMsgProtocol::SetContentCharset() not implemented&quot;);</span>
<a href="#l5.25"></a><span id="l5.25">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.26"></a><span id="l5.26"> }</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> NS_IMETHODIMP nsMsgProtocol::GetContentLength(PRInt32 * aContentLength)</span>
<a href="#l5.29"></a><span id="l5.29"> {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  *aContentLength = -1;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  *aContentLength = mContentLength;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+}</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetContentLength(PRInt32 aContentLength)</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+{</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  mContentLength = aContentLength;</span>
<a href="#l5.38"></a><span id="l5.38">   return NS_OK;</span>
<a href="#l5.39"></a><span id="l5.39"> }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41"> NS_IMETHODIMP nsMsgProtocol::GetSecurityInfo(nsISupports * *aSecurityInfo)</span>
<a href="#l5.42"></a><span id="l5.42"> {</span>
<a href="#l5.43"></a><span id="l5.43">   *aSecurityInfo = nsnull;</span>
<a href="#l5.44"></a><span id="l5.44">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.45"></a><span id="l5.45"> }</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineat">@@ -652,23 +659,16 @@ NS_IMETHODIMP nsMsgProtocol::GetSecurity</span>
<a href="#l5.47"></a><span id="l5.47"> NS_IMETHODIMP nsMsgProtocol::GetName(nsACString &amp;result)</span>
<a href="#l5.48"></a><span id="l5.48"> {</span>
<a href="#l5.49"></a><span id="l5.49">   if (m_url)</span>
<a href="#l5.50"></a><span id="l5.50">     return m_url-&gt;GetSpec(result);</span>
<a href="#l5.51"></a><span id="l5.51">   result.Truncate();</span>
<a href="#l5.52"></a><span id="l5.52">   return NS_OK;</span>
<a href="#l5.53"></a><span id="l5.53"> }</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-nsMsgProtocol::SetContentLength(PRInt32 aContentLength)</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-{</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-}</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62"> NS_IMETHODIMP nsMsgProtocol::GetOwner(nsISupports * *aPrincipal)</span>
<a href="#l5.63"></a><span id="l5.63"> {</span>
<a href="#l5.64"></a><span id="l5.64">   *aPrincipal = mOwner;</span>
<a href="#l5.65"></a><span id="l5.65">   NS_IF_ADDREF(*aPrincipal);</span>
<a href="#l5.66"></a><span id="l5.66">   return NS_OK;</span>
<a href="#l5.67"></a><span id="l5.67"> }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69"> NS_IMETHODIMP nsMsgProtocol::SetOwner(nsISupports * aPrincipal)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -176,16 +176,17 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   nsCOMPtr&lt;nsIStreamListener&gt; m_channelListener;</span>
<a href="#l6.5"></a><span id="l6.5">   nsCOMPtr&lt;nsISupports&gt;        m_channelContext;</span>
<a href="#l6.6"></a><span id="l6.6">   nsCOMPtr&lt;nsILoadGroup&gt;      m_loadGroup;</span>
<a href="#l6.7"></a><span id="l6.7">   nsLoadFlags                 mLoadFlags;</span>
<a href="#l6.8"></a><span id="l6.8">   nsCOMPtr&lt;nsIProgressEventSink&gt; mProgressEventSink;</span>
<a href="#l6.9"></a><span id="l6.9">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; mCallbacks;</span>
<a href="#l6.10"></a><span id="l6.10">   nsCOMPtr&lt;nsISupports&gt;       mOwner;</span>
<a href="#l6.11"></a><span id="l6.11">   nsCString                   m_ContentType;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  PRInt32                     mContentLength;</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14">   nsCString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   // private helper routine used by subclasses to quickly get a reference to the correct prompt dialog</span>
<a href="#l6.17"></a><span id="l6.17">   // for a mailnews url. </span>
<a href="#l6.18"></a><span id="l6.18">   nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   // if a url isn't going to result in any content then we want to suppress calls to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -59,17 +59,17 @@ interface ImapOnlineCopyStateType</span>
<a href="#l7.4"></a><span id="l7.4">    const long kFailedDelete = 4;</span>
<a href="#l7.5"></a><span id="l7.5">    const long kReadyForAppendData = 5;</span>
<a href="#l7.6"></a><span id="l7.6">    const long kFailedAppend = 6;</span>
<a href="#l7.7"></a><span id="l7.7">    const long kInterruptedState = 7;</span>
<a href="#l7.8"></a><span id="l7.8">    const long kFailedCopy = 8;</span>
<a href="#l7.9"></a><span id="l7.9">    const long kFailedMove = 9;</span>
<a href="#l7.10"></a><span id="l7.10"> };</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-[scriptable, uuid(471adbb6-95c2-4a5f-b98e-0055804fce48)]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+[scriptable, uuid(531d4a3a-4921-4b7d-a46d-c66be8bec781)]</span>
<a href="#l7.14"></a><span id="l7.14"> interface nsIImapMailFolderSink : nsISupports {</span>
<a href="#l7.15"></a><span id="l7.15">   attribute boolean folderNeedsACLListed;</span>
<a href="#l7.16"></a><span id="l7.16">   attribute boolean folderNeedsSubscribing;</span>
<a href="#l7.17"></a><span id="l7.17">   attribute boolean folderNeedsAdded;</span>
<a href="#l7.18"></a><span id="l7.18">   attribute unsigned long aclFlags;</span>
<a href="#l7.19"></a><span id="l7.19">   attribute long uidValidity;</span>
<a href="#l7.20"></a><span id="l7.20">   /**</span>
<a href="#l7.21"></a><span id="l7.21">    * Whether we have asked the server for this folder's quota information.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -108,17 +108,17 @@ interface nsIImapMailFolderSink : nsISup</span>
<a href="#l7.23"></a><span id="l7.23">   void closeMockChannel(in nsIImapMockChannel aChannel);</span>
<a href="#l7.24"></a><span id="l7.24">   void setUrlState(in nsIImapProtocol aProtocol, in nsIMsgMailNewsUrl aUrl, in boolean isRunning, in nsresult status);</span>
<a href="#l7.25"></a><span id="l7.25">   void releaseUrlCacheEntry(in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   void headerFetchCompleted(in nsIImapProtocol aProtocol);</span>
<a href="#l7.28"></a><span id="l7.28">   void setBiffStateAndUpdate(in long biffState);</span>
<a href="#l7.29"></a><span id="l7.29">   void progressStatus(in nsIImapProtocol aProtocol, in unsigned long aMsgId, in wstring extraInfo);</span>
<a href="#l7.30"></a><span id="l7.30">   void percentProgress(in nsIImapProtocol aProtocol, in wstring aMessage, </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                       in long aCurrentProgress, in long aMaxProgressProgressInfo);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                       in long long aCurrentProgress, in long long aMaxProgressProgressInfo);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">   void clearFolderRights();</span>
<a href="#l7.35"></a><span id="l7.35">   void setCopyResponseUid(in string msgIdString,</span>
<a href="#l7.36"></a><span id="l7.36">                                 in nsIImapUrl aUrl);</span>
<a href="#l7.37"></a><span id="l7.37">   void setAppendMsgUid(in nsMsgKey newKey,</span>
<a href="#l7.38"></a><span id="l7.38">                              in nsIImapUrl aUrl);</span>
<a href="#l7.39"></a><span id="l7.39">   ACString getMessageId(in nsIImapUrl aUrl);</span>
<a href="#l7.40"></a><span id="l7.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6059,17 +6059,17 @@ nsImapMailFolder::ProgressStatus(nsIImap</span>
<a href="#l8.4"></a><span id="l8.4">     }</span>
<a href="#l8.5"></a><span id="l8.5">   }</span>
<a href="#l8.6"></a><span id="l8.6">   return NS_OK;</span>
<a href="#l8.7"></a><span id="l8.7"> }</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> NS_IMETHODIMP</span>
<a href="#l8.10"></a><span id="l8.10"> nsImapMailFolder::PercentProgress(nsIImapProtocol* aProtocol,</span>
<a href="#l8.11"></a><span id="l8.11">                                   const PRUnichar * aMessage,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                                  PRInt32 aCurrentProgress, PRInt32 aMaxProgress)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                                  PRInt64 aCurrentProgress, PRInt64 aMaxProgress)</span>
<a href="#l8.14"></a><span id="l8.14"> {</span>
<a href="#l8.15"></a><span id="l8.15">   if (aProtocol)</span>
<a href="#l8.16"></a><span id="l8.16">   {</span>
<a href="#l8.17"></a><span id="l8.17">     nsCOMPtr &lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l8.18"></a><span id="l8.18">     aProtocol-&gt;GetRunningImapURL(getter_AddRefs(imapUrl));</span>
<a href="#l8.19"></a><span id="l8.19">     if (imapUrl)</span>
<a href="#l8.20"></a><span id="l8.20">     {</span>
<a href="#l8.21"></a><span id="l8.21">       nsCOMPtr&lt;nsIImapMockChannel&gt; mockChannel;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -6077,20 +6077,19 @@ nsImapMailFolder::PercentProgress(nsIIma</span>
<a href="#l8.23"></a><span id="l8.23">       if (mockChannel)</span>
<a href="#l8.24"></a><span id="l8.24">       {</span>
<a href="#l8.25"></a><span id="l8.25">         nsCOMPtr&lt;nsIProgressEventSink&gt; progressSink;</span>
<a href="#l8.26"></a><span id="l8.26">         mockChannel-&gt;GetProgressEventSink(getter_AddRefs(progressSink));</span>
<a href="#l8.27"></a><span id="l8.27">         if (progressSink)</span>
<a href="#l8.28"></a><span id="l8.28">         {</span>
<a href="#l8.29"></a><span id="l8.29">             nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mockChannel);</span>
<a href="#l8.30"></a><span id="l8.30">             if (!request) return NS_ERROR_FAILURE;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-            // XXX handle 64-bit ints for real</span>
<a href="#l8.32"></a><span id="l8.32">             progressSink-&gt;OnProgress(request, nsnull,</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-                                     nsUint64(aCurrentProgress),</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                                     nsUint64(aMaxProgress));</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+                                     aCurrentProgress,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                                     aMaxProgress);</span>
<a href="#l8.37"></a><span id="l8.37">             if (aMessage)</span>
<a href="#l8.38"></a><span id="l8.38">               progressSink-&gt;OnStatus(request, nsnull, NS_OK, aMessage); // XXX i18n message</span>
<a href="#l8.39"></a><span id="l8.39">         }</span>
<a href="#l8.40"></a><span id="l8.40">       }</span>
<a href="#l8.41"></a><span id="l8.41">     }</span>
<a href="#l8.42"></a><span id="l8.42">   }</span>
<a href="#l8.43"></a><span id="l8.43">   return NS_OK;</span>
<a href="#l8.44"></a><span id="l8.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4979,19 +4979,18 @@ nsImapProtocol::ProgressEventFunctionUsi</span>
<a href="#l9.4"></a><span id="l9.4">     nsString unicodeStr;</span>
<a href="#l9.5"></a><span id="l9.5">     nsresult rv = CopyMUTF7toUTF16(nsDependentCString(aExtraInfo), unicodeStr);</span>
<a href="#l9.6"></a><span id="l9.6">     if (NS_SUCCEEDED(rv))</span>
<a href="#l9.7"></a><span id="l9.7">       m_imapMailFolderSink-&gt;ProgressStatus(this, aMsgId, unicodeStr.get());</span>
<a href="#l9.8"></a><span id="l9.8">   }</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> void</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsImapProtocol::PercentProgressUpdateEvent(PRUnichar *message, PRInt32 currentProgress, PRInt32 maxProgress)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+nsImapProtocol::PercentProgressUpdateEvent(PRUnichar *message, PRInt64 currentProgress, PRInt64 maxProgress)</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+{</span>
<a href="#l9.17"></a><span id="l9.17">   PRInt64 nowMS = LL_ZERO;</span>
<a href="#l9.18"></a><span id="l9.18">   PRInt32 percent = (100 * currentProgress) / maxProgress;</span>
<a href="#l9.19"></a><span id="l9.19">   if (percent == m_lastPercent)</span>
<a href="#l9.20"></a><span id="l9.20">     return; // hasn't changed, right? So just return. Do we need to clear this anywhere?</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">   if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l9.23"></a><span id="l9.23">   {</span>
<a href="#l9.24"></a><span id="l9.24">     int64 minIntervalBetweenProgress;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineat">@@ -5003,23 +5002,25 @@ nsImapProtocol::PercentProgressUpdateEve</span>
<a href="#l9.26"></a><span id="l9.26">     LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l9.27"></a><span id="l9.27">     if (!LL_GE_ZERO(diffSinceLastProgress))</span>
<a href="#l9.28"></a><span id="l9.28">       return;</span>
<a href="#l9.29"></a><span id="l9.29">   }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">   m_lastPercent = percent;</span>
<a href="#l9.32"></a><span id="l9.32">   m_lastProgressTime = nowMS;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  // set our max progress as the content length on the mock channel</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  if (m_mockChannel)</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-      m_mockChannel-&gt;SetContentLength(maxProgress);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  // set our max progress on the running URL</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  if (m_runningUrl)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    mailnewsUrl-&gt;SetMaxProgress(maxProgress);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  }</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45">   if (m_imapMailFolderSink)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      m_imapMailFolderSink-&gt;PercentProgress(this, message, currentProgress, maxProgress);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    m_imapMailFolderSink-&gt;PercentProgress(this, message, currentProgress, maxProgress);</span>
<a href="#l9.48"></a><span id="l9.48"> }</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   // imap commands issued by the parser</span>
<a href="#l9.51"></a><span id="l9.51"> void</span>
<a href="#l9.52"></a><span id="l9.52"> nsImapProtocol::Store(const nsCString &amp;messageList, const char * messageData,</span>
<a href="#l9.53"></a><span id="l9.53">                       PRBool idsAreUid)</span>
<a href="#l9.54"></a><span id="l9.54"> {</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56" class="difflineat">@@ -5683,17 +5684,17 @@ void nsImapProtocol::UploadMessageFromFi</span>
<a href="#l9.57"></a><span id="l9.57">                                             PRTime date,</span>
<a href="#l9.58"></a><span id="l9.58">                                             imapMessageFlagsType flags,</span>
<a href="#l9.59"></a><span id="l9.59">                                             nsCString &amp;keywords)</span>
<a href="#l9.60"></a><span id="l9.60"> {</span>
<a href="#l9.61"></a><span id="l9.61">   if (!file || !mailboxName) return;</span>
<a href="#l9.62"></a><span id="l9.62">   IncrementCommandTagNumber();</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   PRInt64 fileSize = 0;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  PRInt32 totalSize;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  PRInt64 totalSize;</span>
<a href="#l9.67"></a><span id="l9.67">   PRUint32 readCount;</span>
<a href="#l9.68"></a><span id="l9.68">   char *dataBuffer = nsnull;</span>
<a href="#l9.69"></a><span id="l9.69">   nsCString command(GetServerCommandTag());</span>
<a href="#l9.70"></a><span id="l9.70">   nsCString escapedName;</span>
<a href="#l9.71"></a><span id="l9.71">   CreateEscapedMailboxName(mailboxName, escapedName);</span>
<a href="#l9.72"></a><span id="l9.72">   nsresult rv;</span>
<a href="#l9.73"></a><span id="l9.73">   PRBool eof = PR_FALSE;</span>
<a href="#l9.74"></a><span id="l9.74">   nsCString flagString;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineat">@@ -8245,17 +8246,16 @@ NS_INTERFACE_MAP_END_THREADSAFE</span>
<a href="#l9.76"></a><span id="l9.76"> nsImapMockChannel::nsImapMockChannel()</span>
<a href="#l9.77"></a><span id="l9.77"> {</span>
<a href="#l9.78"></a><span id="l9.78">   m_channelContext = nsnull;</span>
<a href="#l9.79"></a><span id="l9.79">   m_cancelStatus = NS_OK;</span>
<a href="#l9.80"></a><span id="l9.80">   mLoadFlags = 0;</span>
<a href="#l9.81"></a><span id="l9.81">   mChannelClosed = PR_FALSE;</span>
<a href="#l9.82"></a><span id="l9.82">   mReadingFromCache = PR_FALSE;</span>
<a href="#l9.83"></a><span id="l9.83">   mTryingToReadPart = PR_FALSE;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  mContentLength = -1;</span>
<a href="#l9.85"></a><span id="l9.85"> }</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87"> nsImapMockChannel::~nsImapMockChannel()</span>
<a href="#l9.88"></a><span id="l9.88"> {</span>
<a href="#l9.89"></a><span id="l9.89">   // if we're offline, we may not get to close the channel correctly.</span>
<a href="#l9.90"></a><span id="l9.90">   // we need to do this to send the url state change notification in</span>
<a href="#l9.91"></a><span id="l9.91">   // the case of mem and disk cache reads.</span>
<a href="#l9.92"></a><span id="l9.92">   NS_WARN_IF_FALSE(NS_IsMainThread(), &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineat">@@ -8411,16 +8411,39 @@ NS_IMETHODIMP nsImapMockChannel::SetURI(</span>
<a href="#l9.94"></a><span id="l9.94">     // if we don't have a progress event sink yet, get it from the url for now...</span>
<a href="#l9.95"></a><span id="l9.95">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l9.96"></a><span id="l9.96">     if (mailnewsUrl &amp;&amp; !mProgressEventSink)</span>
<a href="#l9.97"></a><span id="l9.97">     {</span>
<a href="#l9.98"></a><span id="l9.98">       nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l9.99"></a><span id="l9.99">       mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l9.100"></a><span id="l9.100">       mProgressEventSink = do_QueryInterface(statusFeedback);</span>
<a href="#l9.101"></a><span id="l9.101">     }</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    // If this is a fetch URL and we can, get the message size from the message</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    // header and set it to be the content length.</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    // Note that for an attachment URL, this will set the content length to be</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    // equal to the size of the entire message.</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+    nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(m_url));</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+    imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+    if (imapAction == nsIImapUrl::nsImapMsgFetch)</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    {</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(m_url));</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+      if (msgUrl)</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+      {</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+        // A failure to get a message header isn't an error</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+        msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+        if (msgHdr)</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+        {</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+          PRUint32 messageSize;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+          if (NS_SUCCEEDED(msgHdr-&gt;GetMessageSize(&amp;messageSize)))</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+            SetContentLength(messageSize);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+        }</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+      }</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+    }</span>
<a href="#l9.125"></a><span id="l9.125">   }</span>
<a href="#l9.126"></a><span id="l9.126">   return NS_OK;</span>
<a href="#l9.127"></a><span id="l9.127"> }</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129"> NS_IMETHODIMP nsImapMockChannel::Open(nsIInputStream **_retval)</span>
<a href="#l9.130"></a><span id="l9.130"> {</span>
<a href="#l9.131"></a><span id="l9.131">   return NS_ImplementChannelOpen(this, _retval);</span>
<a href="#l9.132"></a><span id="l9.132"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -261,17 +261,17 @@ public:</span>
<a href="#l10.4"></a><span id="l10.4">   void DiscoverMailboxSpec(nsImapMailboxSpec * adoptedBoxSpec);</span>
<a href="#l10.5"></a><span id="l10.5">   void AlertUserEventUsingId(PRUint32 aMessageId);</span>
<a href="#l10.6"></a><span id="l10.6">   void AlertUserEvent(const char * message);</span>
<a href="#l10.7"></a><span id="l10.7">   void AlertUserEventFromServer(const char * aServerEvent);</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   void ProgressEventFunctionUsingId(PRUint32 aMsgId);</span>
<a href="#l10.10"></a><span id="l10.10">   void ProgressEventFunctionUsingIdWithString(PRUint32 aMsgId, const char *</span>
<a href="#l10.11"></a><span id="l10.11">     aExtraInfo);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  void PercentProgressUpdateEvent(PRUnichar *message, PRInt32 currentProgress, PRInt32 maxProgress);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  void PercentProgressUpdateEvent(PRUnichar *message, PRInt64 currentProgress, PRInt64 maxProgress);</span>
<a href="#l10.14"></a><span id="l10.14">   void ShowProgress();</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">   // utility function calls made by the server</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   void Copy(const char * messageList, const char *destinationMailbox,</span>
<a href="#l10.19"></a><span id="l10.19">     PRBool idsAreUid);</span>
<a href="#l10.20"></a><span id="l10.20">   void Search(const char * searchCriteria,  PRBool useUID,</span>
<a href="#l10.21"></a><span id="l10.21">     PRBool notifyHit = PR_TRUE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,127 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ *</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ *</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+/*</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * Test content length for the IMAP protocol. This focuses on necko URLs</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ */</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+// Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+const gFile = do_get_file(&quot;../../mailnews/data/multipart-complex2&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+var gIMAPDaemon, gIMAPServer, gIMAPIncomingServer, gIMAPInbox;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+const gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+                      .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+                   </span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+// Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+function addMessageToServer(file, mailbox)</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+{</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  let URI = ioService.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  gIMAPInbox.updateFolder(null);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+}</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+var msgFolderListener =</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+{</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+  msgAdded: function(aMsgHdr)</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    do_timeout_function(0, verifyContentLength, null, [aMsgHdr]);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  }</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+};</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+function run_test()</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+{</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  // Disable new mail notifications</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  let prefSvc = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  // Set up nsIMsgFolderListener to get the header when it's received</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  gMFNService.addListener(msgFolderListener, gMFNService.msgAdded);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  // set up IMAP fakeserver and incoming server</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  acctMgr.defaultAccount = imapAccount;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  prefSvc.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  gIMAPInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+  do_test_pending();</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  // Add a message to the IMAP server</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  addMessageToServer(gFile, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  gIMAPInbox.updateFolder(null);</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+}</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+function verifyContentLength(aMsgHdr)</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+{</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+  let messageUri = gIMAPInbox.getUriForMsg(aMsgHdr);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  // Convert this to a URI that necko can run</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+  let neckoURL = {};</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  // URL using the IO service</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  let urlToRun = gIOService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  // Get a channel from this URI, and check its content length</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  let channel = gIOService.newChannelFromURI(urlToRun);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  // Now try an attachment. &amp;part=1.2</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  let attachmentURL = gIOService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+                                        null, null);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  let attachmentChannel = gIOService.newChannelFromURI(attachmentURL);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  // Currently attachments have their content length set to the length of the</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  // entire message</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  do_timeout_function(1000, endTest);</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+}</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+function endTest()</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+{</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  gIMAPServer.resetTest();</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  gIMAPServer.performTest();</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  gIMAPServer.stop();</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -92,41 +92,16 @@ nsMailboxProtocol::nsMailboxProtocol(nsI</span>
<a href="#l12.4"></a><span id="l12.4"> }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> nsMailboxProtocol::~nsMailboxProtocol()</span>
<a href="#l12.7"></a><span id="l12.7"> {</span>
<a href="#l12.8"></a><span id="l12.8">   // free our local state </span>
<a href="#l12.9"></a><span id="l12.9">   delete m_lineStreamBuffer;</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-NS_IMETHODIMP nsMailboxProtocol::GetContentLength(PRInt32 * aContentLength)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  *aContentLength = -1;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox)</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    // our file transport knows the entire length of the berkley mail folder</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    // so get it from there.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-    if (!m_request)</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-      return NS_OK;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; info = do_QueryInterface(m_request);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-    if (info) info-&gt;GetContentLength(aContentLength);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  }</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  else if (m_runningUrl)</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-    PRUint32 msgSize = 0;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    m_runningUrl-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    *aContentLength = (PRInt32) msgSize;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-}</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-</span>
<a href="#l12.37"></a><span id="l12.37"> nsresult nsMailboxProtocol::OpenMultipleMsgTransport(PRUint32 offset, PRInt32 size)</span>
<a href="#l12.38"></a><span id="l12.38"> {</span>
<a href="#l12.39"></a><span id="l12.39">   nsresult rv;</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">   nsCOMPtr&lt;nsIStreamTransportService&gt; serv =</span>
<a href="#l12.42"></a><span id="l12.42">       do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.43"></a><span id="l12.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45" class="difflineat">@@ -178,29 +153,45 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l12.46"></a><span id="l12.46">       // clear stopped flag on msg window, because we care.</span>
<a href="#l12.47"></a><span id="l12.47">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l12.48"></a><span id="l12.48">       if (mailnewsUrl)</span>
<a href="#l12.49"></a><span id="l12.49">       {</span>
<a href="#l12.50"></a><span id="l12.50">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l12.51"></a><span id="l12.51">         if (window)</span>
<a href="#l12.52"></a><span id="l12.52">           window-&gt;SetStopped(PR_FALSE);</span>
<a href="#l12.53"></a><span id="l12.53">       }</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+</span>
<a href="#l12.55"></a><span id="l12.55">       if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox)</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+      {</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+        // Set the length of the file equal to the max progress</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+        GetFileFromURL(aURL, getter_AddRefs(file));</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+        if (file)</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+        {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+          PRInt64 fileSize = 0;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+          file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+          mailnewsUrl-&gt;SetMaxProgress(fileSize);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+        }</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+</span>
<a href="#l12.67"></a><span id="l12.67">         rv = OpenFileSocket(aURL, 0, -1 /* read in all the bytes in the file */);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+      }</span>
<a href="#l12.69"></a><span id="l12.69">       else</span>
<a href="#l12.70"></a><span id="l12.70">       {</span>
<a href="#l12.71"></a><span id="l12.71">         // we need to specify a byte range to read in so we read in JUST the message we want.</span>
<a href="#l12.72"></a><span id="l12.72">         rv = SetupMessageExtraction();</span>
<a href="#l12.73"></a><span id="l12.73">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.74"></a><span id="l12.74">         nsMsgKey aMsgKey;</span>
<a href="#l12.75"></a><span id="l12.75">         PRUint32 aMsgSize = 0;</span>
<a href="#l12.76"></a><span id="l12.76">         rv = m_runningUrl-&gt;GetMessageKey(&amp;aMsgKey);</span>
<a href="#l12.77"></a><span id="l12.77">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l12.78"></a><span id="l12.78">         rv = m_runningUrl-&gt;GetMessageSize(&amp;aMsgSize);</span>
<a href="#l12.79"></a><span id="l12.79">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        SetContentLength(aMsgSize);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+        mailnewsUrl-&gt;SetMaxProgress(aMsgSize);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+</span>
<a href="#l12.83"></a><span id="l12.83">         if (RunningMultipleMsgUrl())</span>
<a href="#l12.84"></a><span id="l12.84">         {</span>
<a href="#l12.85"></a><span id="l12.85">           rv = OpenFileSocketForReuse(aURL, (PRUint32) aMsgKey, aMsgSize);</span>
<a href="#l12.86"></a><span id="l12.86">           // if we're running multiple msg url, we clear the event sink because the multiple</span>
<a href="#l12.87"></a><span id="l12.87">           // msg urls will handle setting the progress.</span>
<a href="#l12.88"></a><span id="l12.88">           mProgressEventSink = nsnull;</span>
<a href="#l12.89"></a><span id="l12.89">         }</span>
<a href="#l12.90"></a><span id="l12.90">         else</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineat">@@ -647,24 +638,24 @@ PRInt32 nsMailboxProtocol::ReadMessageRe</span>
<a href="#l12.92"></a><span id="l12.92">           SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l12.93"></a><span id="l12.93">       } </span>
<a href="#l12.94"></a><span id="l12.94">       PR_Free(saveLine);</span>
<a href="#l12.95"></a><span id="l12.95">     }</span>
<a href="#l12.96"></a><span id="l12.96">     while (line &amp;&amp; !pauseForMoreData);</span>
<a href="#l12.97"></a><span id="l12.97">   }</span>
<a href="#l12.98"></a><span id="l12.98">   </span>
<a href="#l12.99"></a><span id="l12.99">   SetFlag(MAILBOX_PAUSE_FOR_READ); // wait for more data to become available...</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-  if (mProgressEventSink)</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  if (mProgressEventSink &amp;&amp; m_runningUrl)</span>
<a href="#l12.102"></a><span id="l12.102">   {</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    PRInt32 contentLength = 0;</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-    GetContentLength(&amp;contentLength);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    // XXX 64-bit</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    PRInt64 maxProgress;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    mailnewsUrl-&gt;GetMaxProgress(&amp;maxProgress);</span>
<a href="#l12.109"></a><span id="l12.109">     mProgressEventSink-&gt;OnProgress(this, m_channelContext,</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-                                   nsUint64(mCurrentProgress),</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-                                   nsUint64(contentLength));</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+                                   mCurrentProgress,</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                                   maxProgress);</span>
<a href="#l12.114"></a><span id="l12.114">   }</span>
<a href="#l12.115"></a><span id="l12.115">   </span>
<a href="#l12.116"></a><span id="l12.116">   if (NS_FAILED(rv)) return -1;</span>
<a href="#l12.117"></a><span id="l12.117">   </span>
<a href="#l12.118"></a><span id="l12.118">   return 0;</span>
<a href="#l12.119"></a><span id="l12.119"> }</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -90,17 +90,16 @@ public:</span>
<a href="#l13.4"></a><span id="l13.4">   virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.7"></a><span id="l13.7">   // we suppport the nsIStreamListener interface</span>
<a href="#l13.8"></a><span id="l13.8">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   NS_IMETHOD OnStartRequest(nsIRequest *request, nsISupports *ctxt);</span>
<a href="#l13.11"></a><span id="l13.11">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsISupports *ctxt, nsresult aStatus);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  NS_IMETHOD GetContentLength(PRInt32 * aContentLength);</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> private:</span>
<a href="#l13.15"></a><span id="l13.15">   nsCOMPtr&lt;nsIMailboxUrl&gt;  m_runningUrl; // the nsIMailboxURL that is currently running</span>
<a href="#l13.16"></a><span id="l13.16">   nsMailboxAction m_mailboxAction; // current mailbox action associated with this connnection...</span>
<a href="#l13.17"></a><span id="l13.17">   PRInt32      m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">   // Event sink handles</span>
<a href="#l13.20"></a><span id="l13.20">   nsCOMPtr&lt;nsIStreamListener&gt; m_mailboxParser;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -108,17 +107,17 @@ private:</span>
<a href="#l13.22"></a><span id="l13.22">   // Local state for the current operation</span>
<a href="#l13.23"></a><span id="l13.23">   nsMsgLineStreamBuffer   * m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">   // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l13.26"></a><span id="l13.26">   // after the next response? What was the last response code? etc.</span>
<a href="#l13.27"></a><span id="l13.27">   MailboxStatesEnum  m_nextState;</span>
<a href="#l13.28"></a><span id="l13.28">   MailboxStatesEnum  m_initialState;</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  PRInt32 mCurrentProgress;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  PRInt64   mCurrentProgress;</span>
<a href="#l13.32"></a><span id="l13.32">   PRUint32  m_messageID;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">         // can we just use the base class m_tempMsgFile?</span>
<a href="#l13.35"></a><span id="l13.35">   nsCOMPtr&lt;nsIFile&gt; m_tempMessageFile;</span>
<a href="#l13.36"></a><span id="l13.36">         nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileOutputStream;</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">   // this is used to hold the source mailbox file open when move/copying</span>
<a href="#l13.39"></a><span id="l13.39">   // multiple messages.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_mailboxContentLength.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ *</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+/*</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * Test content length for the mailbox protocol. This focuses on necko URLs</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ */</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+// Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+var gFile = do_get_file(&quot;../../mailnews/data/multipart-complex2&quot;);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+var gMessageKey;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+function run_test()</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+{</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  // Set up local folders</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  // Copy a message into the local folder</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    .getService(Ci.nsIMsgCopyService)</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+    .CopyFileMessage(gFile, gLocalInboxFolder, null, false, 0, &quot;&quot;,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+                     gCopyListener, null);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  do_test_pending();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+}</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+var gCopyListener =</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+{</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  OnStartCopy: function() {},</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  SetMessageKey: function(aKey) { gMessageKey = aKey; },</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  GetMessageId: function(aMessageId) {},</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  OnStopCopy: function(aStatus) </span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    do_timeout_function(0, verifyContentLength);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  }</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+};</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+function verifyContentLength()</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+{</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  // First get the message URI</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  let msgHdr = gLocalInboxFolder.GetMessageHeader(gMessageKey);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  let messageUri = gLocalInboxFolder.getUriForMsg(msgHdr);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  // Convert this to a URI that necko can run</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  let neckoURL = {};</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  // URL using the IO service</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  let urlToRun = ioService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  // Get a channel from this URI, and check its content length</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  let channel = ioService.newChannelFromURI(urlToRun);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  // Now try an attachment. &amp;part=1.2</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  let attachmentURL = ioService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+                                       null, null);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  let attachmentChannel = ioService.newChannelFromURI(attachmentURL);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  // Currently attachments have their content length set to the length of the</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  // entire message</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  do_test_finished();</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -460,17 +460,34 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l15.4"></a><span id="l15.4">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l15.5"></a><span id="l15.5">     if (mailnewsUrl)</span>
<a href="#l15.6"></a><span id="l15.6">     {</span>
<a href="#l15.7"></a><span id="l15.7">       if (aMsgWindow)</span>
<a href="#l15.8"></a><span id="l15.8">         mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">       m_runningURL-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l15.11"></a><span id="l15.11">       if (m_newsAction == nsINntpUrl::ActionFetchArticle || m_newsAction == nsINntpUrl::ActionFetchPart</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        || m_newsAction == nsINntpUrl::ActionSaveMessageToDisk) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+          || m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+      {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+        // Look for the content length</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(m_runningURL));</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+        if (msgUrl)</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+        {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+          msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+          if (msgHdr)</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+          {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+            // Note that for attachments, the messageSize is going to be the</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+            // size of the entire message</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+            PRUint32 messageSize;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+            msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+            SetContentLength(messageSize);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+          }</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+        }</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31">         PRBool msgIsInLocalCache = PR_FALSE;</span>
<a href="#l15.32"></a><span id="l15.32">         mailnewsUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInLocalCache);</span>
<a href="#l15.33"></a><span id="l15.33">         if (msgIsInLocalCache || WeAreOffline())</span>
<a href="#l15.34"></a><span id="l15.34">           return NS_OK; // probably don't need to do anything else - definitely don't want</span>
<a href="#l15.35"></a><span id="l15.35">         // to open the socket.</span>
<a href="#l15.36"></a><span id="l15.36">       }</span>
<a href="#l15.37"></a><span id="l15.37">     }</span>
<a href="#l15.38"></a><span id="l15.38">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -264,25 +264,24 @@ NS_IMETHODIMP nsNntpUrl::GetMessageHeade</span>
<a href="#l16.4"></a><span id="l16.4">   nsresult rv;</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l16.7"></a><span id="l16.7">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   nsCOMPtr &lt;nsIMsgMessageService&gt; msgService = do_QueryInterface(nntpService, &amp;rv);</span>
<a href="#l16.10"></a><span id="l16.10">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  if (mOriginalSpec.IsEmpty()) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    // this can happen when viewing a news://host/message-id url</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-  }</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  nsCAutoString spec(mOriginalSpec);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  if (spec.IsEmpty())</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+    // Handle the case where necko directly runs an internal news:// URL,</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+    // one that looks like news://host/message-id?group=mozilla.announce&amp;key=15</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+    // Other sorts of URLs -- e.g. news://host/message-id -- will not succeed.</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+    GetSpec(spec);</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-  rv = msgService-&gt;MessageURIToMsgHdr(mOriginalSpec.get(), aMsgHdr);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  return NS_OK;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  return msgService-&gt;MessageURIToMsgHdr(spec.get(), aMsgHdr);</span>
<a href="#l16.28"></a><span id="l16.28"> }</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30"> NS_IMETHODIMP nsNntpUrl::IsUrlType(PRUint32 type, PRBool *isType)</span>
<a href="#l16.31"></a><span id="l16.31"> {</span>
<a href="#l16.32"></a><span id="l16.32">   NS_ENSURE_ARG(isType);</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   switch(type)</span>
<a href="#l16.35"></a><span id="l16.35">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpContentLength.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ *</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/*</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * Test content length for the news protocol. This focuses on necko URLs</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ */</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+// The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+var daemon = setupNNTPDaemon();</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+var server;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+var localserver;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+function run_test() {</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  // XXX The server doesn't support returning sizes!</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  return;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+  type = &quot;RFC 977&quot;;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  server = new nsMailServer(handler);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  try {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+    // Get the folder and new mail</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    let folder = localserver.rootFolder.getChildNamed(&quot;test.subscribe.simple&quot;);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+    folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+    folder.getNewMessages(null, {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+      OnStopRunningUrl: function () { localserver.closeCachedConnections(); }});</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+    server.performTest();</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+    do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+    do_check_true(folder.hasNewMessages);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+    server.resetTest();</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    // Get the message URI</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+    let msgHdr = folder.firstNewMessage;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+    let messageUri = folder.getUriForMsg(msgHdr);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    // Convert this to a URI that necko can run</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+    let neckoURL = {};</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+    let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+    messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+    // URL using the IO service</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+    let urlToRun = ioService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    // Get a channel from this URI, and check its content length</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+    let channel = ioService.newChannelFromURI(urlToRun);</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    do_check_eq(channel.contentLength, kSimpleNewsArticle.length);</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+    // Now try an attachment. &amp;part=1.2</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+    // XXX the message doesn't really have an attachment</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+    let attachmentURL = ioService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+                                         null, null);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    let attachmentChannel = ioService.newChannelFromURI(attachmentURL);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+    // Currently attachments have their content length set to the length of the</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    // entire message</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+    do_check_eq(channel.contentLength, kSimpleNewsArticle.length);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  }</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  catch (e) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+    server.stop();</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+    do_throw(e);</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  }</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/test/data/multipart-complex2</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/test/data/multipart-complex2</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,9 +1,11 @@</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineplus">+From - Mon Jun 02 19:00:00 2008</span>
<a href="#l18.5"></a><span id="l18.5"> Content-Type: multipart/mixed; boundary=&quot;bou&quot;</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+Message-Id: &lt;123456@example.com&gt;</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> Part 1</span>
<a href="#l18.9"></a><span id="l18.9"> --bou                       </span>
<a href="#l18.10"></a><span id="l18.10"> Content-Type: multipart/related; boundary=&quot;bound&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12"> Part 2</span>
<a href="#l18.13"></a><span id="l18.13"> --bound</span>
<a href="#l18.14"></a><span id="l18.14"> Content-Type: multipart/digest; boundary=&quot;boundar&quot;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

