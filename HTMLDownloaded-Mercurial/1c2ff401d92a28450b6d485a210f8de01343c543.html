<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 16437:1c2ff401d92a28450b6d485a210f8de01343c543</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1c2ff401d92a28450b6d485a210f8de01343c543" />
<meta property="og:url" content="/comm-central/rev/1c2ff401d92a28450b6d485a210f8de01343c543" />
<meta property="og:description" content="Bug 955292 - Read/write chat logs asynchronously. r=aleth, florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1c2ff401d92a28450b6d485a210f8de01343c543 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1c2ff401d92a28450b6d485a210f8de01343c543">shortlog</a> |
<a href="/comm-central/log/1c2ff401d92a28450b6d485a210f8de01343c543">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1c2ff401d92a28450b6d485a210f8de01343c543">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1c2ff401d92a28450b6d485a210f8de01343c543">files</a> |
changeset |
<a href="/comm-central/raw-rev/1c2ff401d92a28450b6d485a210f8de01343c543">raw</a>  | <a href="/comm-central/archive/1c2ff401d92a28450b6d485a210f8de01343c543.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955292">Bug 955292</a> - Read/write chat logs asynchronously. r=aleth, florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#105;&#104;&#97;&#110;&#116;&#104;&#32;&#83;&#117;&#98;&#114;&#97;&#109;&#97;&#110;&#121;&#97;&#32;&#60;&#110;&#104;&#110;&#116;&#49;&#49;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 25 Jun 2014 01:52:42 +0530</td></tr>

<tr>
 <td>changeset 16437</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1c2ff401d92a28450b6d485a210f8de01343c543">1c2ff401d92a28450b6d485a210f8de01343c543</a></td>
</tr>



<tr>
<td>parent 16436</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/92d8085718040c84bba3e86c0517bd8b6a053560">92d8085718040c84bba3e86c0517bd8b6a053560</a>
</td>
</tr>

<tr>
<td>child 16438</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3d0f06e04096c489893d8801de5c15a62cae0aae">3d0f06e04096c489893d8801de5c15a62cae0aae</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1c2ff401d92a28450b6d485a210f8de01343c543">10240</a></td></tr>
<tr><td>push user</td><td>nhnt11@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 04 Jul 2014 18:01:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@144a20da5ab5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=144a20da5ab58b89ede4144308606d92a10aea86">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=144a20da5ab58b89ede4144308606d92a10aea86&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=144a20da5ab58b89ede4144308606d92a10aea86&newProject=comm-central&newRevision=92d8085718040c84bba3e86c0517bd8b6a053560&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=144a20da5ab58b89ede4144308606d92a10aea86&newProject=comm-central&newRevision=92d8085718040c84bba3e86c0517bd8b6a053560&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=144a20da5ab58b89ede4144308606d92a10aea86&newProject=comm-central&newRevision=92d8085718040c84bba3e86c0517bd8b6a053560&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a>, <a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955292">955292</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955292">Bug 955292</a> - Read/write chat logs asynchronously. r=aleth, florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">chat/components/public/imILogger.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">file</a> |
<a href="/comm-central/annotate/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">annotate</a> |
<a href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">diff</a> |
<a href="/comm-central/comparison/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">comparison</a> |
<a href="/comm-central/log/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/imILogger.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">chat/components/public/prplIConversation.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">file</a> |
<a href="/comm-central/annotate/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">annotate</a> |
<a href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">diff</a> |
<a href="/comm-central/comparison/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">comparison</a> |
<a href="/comm-central/log/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIConversation.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">chat/components/public/prplIMessage.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">file</a> |
<a href="/comm-central/annotate/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">annotate</a> |
<a href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">diff</a> |
<a href="/comm-central/comparison/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">comparison</a> |
<a href="/comm-central/log/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/public/prplIMessage.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/1c2ff401d92a28450b6d485a210f8de01343c543/chat/components/src/logger.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/public/imILogger.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/public/imILogger.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -12,16 +12,17 @@ interface imIBuddy;</span>
<a href="#l1.4"></a><span id="l1.4"> interface imIContact;</span>
<a href="#l1.5"></a><span id="l1.5"> interface prplIConversation;</span>
<a href="#l1.6"></a><span id="l1.6"> interface prplIMessage;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> [scriptable, uuid(5bc06f3b-33a1-412b-a4d8-4fc7ba4c962b)]</span>
<a href="#l1.9"></a><span id="l1.9"> interface imILogConversation: nsISupports {</span>
<a href="#l1.10"></a><span id="l1.10">   readonly attribute AUTF8String title;</span>
<a href="#l1.11"></a><span id="l1.11">   readonly attribute AUTF8String name;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  // Value in microseconds.</span>
<a href="#l1.13"></a><span id="l1.13">   readonly attribute PRTime startDate;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">   // Simplified account implementation:</span>
<a href="#l1.16"></a><span id="l1.16">   //  - alias will always be empty</span>
<a href="#l1.17"></a><span id="l1.17">   //  - name (always the normalizedName)</span>
<a href="#l1.18"></a><span id="l1.18">   //  - statusInfo will return Services.core.globalUserStatus</span>
<a href="#l1.19"></a><span id="l1.19">   //  - protocol will only contain a &quot;name&quot; attribute, with the prpl's normalized name.</span>
<a href="#l1.20"></a><span id="l1.20">   // Other methods/attributes aren't implemented.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -34,40 +35,48 @@ interface imILogConversation: nsISupport</span>
<a href="#l1.22"></a><span id="l1.22">                    [retval, array, size_is(messageCount)] out prplIMessage messages);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   // Callers that process the messages asynchronously should use the enumerator</span>
<a href="#l1.25"></a><span id="l1.25">   // instead of the array version of the getMessages* methods to avoid paying</span>
<a href="#l1.26"></a><span id="l1.26">   // up front the cost of xpconnect wrapping all message objects.</span>
<a href="#l1.27"></a><span id="l1.27">   nsISimpleEnumerator getMessagesEnumerator([optional] out unsigned long messageCount);</span>
<a href="#l1.28"></a><span id="l1.28"> };</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-[scriptable, uuid(164ff6c3-ca64-4880-b8f3-67eb1817955f)]</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+[scriptable, uuid(27712ece-ad2c-4504-87d5-9e2c16d40fef)]</span>
<a href="#l1.32"></a><span id="l1.32"> interface imILog: nsISupports {</span>
<a href="#l1.33"></a><span id="l1.33">   readonly attribute AUTF8String path;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  // Value in seconds.</span>
<a href="#l1.35"></a><span id="l1.35">   readonly attribute PRTime time;</span>
<a href="#l1.36"></a><span id="l1.36">   readonly attribute AUTF8String format;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  // Will return null if the log format isn't json.</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  imILogConversation getConversation();</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  // Returns a promise that resolves to an imILogConversation instance, or null</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  // if the log format isn't JSON.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  jsval getConversation();</span>
<a href="#l1.42"></a><span id="l1.42"> };</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-[scriptable, uuid(327ba58c-ee9c-4d1c-9216-fd505c45a3e0)]</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+[scriptable, uuid(b9d5701a-df53-4e0e-99b7-706e0118e075)]</span>
<a href="#l1.46"></a><span id="l1.46"> interface imILogger: nsISupports {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  imILog getLogFromFile(in nsIFile aFile, [optional] in boolean aGroupByDay);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  nsIFile getLogFileForOngoingConversation(in prplIConversation aConversation);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  // Returns a promise that resolves to an imILog instance.</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  jsval getLogFromFile(in AUTF8String aFilePath, [optional] in boolean aGroupByDay);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  // Returns a promise that resolves to the log file path if a log writer</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  // exists for the conversation, or null otherwise. The promise resolves</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  // after any pending I/O operations on the file complete.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  jsval getLogPathForConversation(in prplIConversation aConversation);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  // Below methods return promises that resolve to nsISimpleEnumerator instances.</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58">   // Get logs for a username that may not be in the contact list.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  nsISimpleEnumerator getLogsForAccountAndName(in imIAccount aAccount,</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-                                               in string aNormalizedName,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-                                               [optional] in boolean aGroupByDay);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  jsval getLogsForAccountAndName(in imIAccount aAccount,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+                                 in AUTF8String aNormalizedName,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                                 [optional] in boolean aGroupByDay);</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  nsISimpleEnumerator getLogsForAccountBuddy(in imIAccountBuddy aAccountBuddy,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                                             [optional] in boolean aGroupByDay);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  nsISimpleEnumerator getLogsForBuddy(in imIBuddy aBuddy,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-                                      [optional] in boolean aGroupByDay);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-  nsISimpleEnumerator getLogsForContact(in imIContact aContact,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-                                        [optional] in boolean aGroupByDay);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  jsval getLogsForAccountBuddy(in imIAccountBuddy aAccountBuddy,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+                               [optional] in boolean aGroupByDay);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  jsval getLogsForBuddy(in imIBuddy aBuddy,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+                        [optional] in boolean aGroupByDay);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  jsval getLogsForContact(in imIContact aContact,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                          [optional] in boolean aGroupByDay);</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  nsISimpleEnumerator getLogsForConversation(in prplIConversation aConversation,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-                                             [optional] in boolean aGroupByDay);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  nsISimpleEnumerator getSystemLogsForAccount(in imIAccount aAccount);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  nsISimpleEnumerator getSimilarLogs(in imILog aLog,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-                                     [optional] in boolean aGroupByDay);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  jsval getLogsForConversation(in prplIConversation aConversation,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                               [optional] in boolean aGroupByDay);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  jsval getSystemLogsForAccount(in imIAccount aAccount);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  jsval getSimilarLogs(in imILog aLog,</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+                       [optional] in boolean aGroupByDay);</span>
<a href="#l1.89"></a><span id="l1.89"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/public/prplIConversation.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/public/prplIConversation.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -30,17 +30,17 @@ interface prplIConversation: nsISupports</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   /* A name that can be used to check for duplicates and is the basis</span>
<a href="#l2.6"></a><span id="l2.6">      for the directory name for log storage. */</span>
<a href="#l2.7"></a><span id="l2.7">   readonly attribute AUTF8String normalizedName;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   /* The title of the conversation, typically localized */</span>
<a href="#l2.10"></a><span id="l2.10">   readonly attribute AUTF8String title;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  /* The time and date of the conversation's creation */</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  /* The time and date of the conversation's creation, in microseconds */</span>
<a href="#l2.14"></a><span id="l2.14">   readonly attribute PRTime startDate;</span>
<a href="#l2.15"></a><span id="l2.15">   /* Unique identifier of the conversation */</span>
<a href="#l2.16"></a><span id="l2.16">   /* Setable only once by purpleCoreService while calling addConversation. */</span>
<a href="#l2.17"></a><span id="l2.17">            attribute unsigned long id;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   /* Send a message in the conversation */</span>
<a href="#l2.20"></a><span id="l2.20">   void sendMsg(in AUTF8String aMsg);</span>
<a href="#l2.21"></a><span id="l2.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/public/prplIMessage.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/public/prplIMessage.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -24,16 +24,17 @@ interface prplIMessage: nsISupports {</span>
<a href="#l3.4"></a><span id="l3.4">      messages of a conversation, not across all messages created</span>
<a href="#l3.5"></a><span id="l3.5">      during the execution of the application. */</span>
<a href="#l3.6"></a><span id="l3.6">   readonly attribute unsigned long id;</span>
<a href="#l3.7"></a><span id="l3.7">   readonly attribute AUTF8String who;</span>
<a href="#l3.8"></a><span id="l3.8">   readonly attribute AUTF8String alias;</span>
<a href="#l3.9"></a><span id="l3.9">   readonly attribute AUTF8String originalMessage;</span>
<a href="#l3.10"></a><span id="l3.10">            attribute AUTF8String message;</span>
<a href="#l3.11"></a><span id="l3.11">   readonly attribute AUTF8String iconURL;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  // Value in seconds.</span>
<a href="#l3.13"></a><span id="l3.13">   readonly attribute PRTime time;</span>
<a href="#l3.14"></a><span id="l3.14">   readonly attribute prplIConversation conversation;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   /* Holds the sender color for Chats.</span>
<a href="#l3.17"></a><span id="l3.17">      Empty string by default, it is set by the conversation binding. */</span>
<a href="#l3.18"></a><span id="l3.18">   attribute AUTF8String color;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   /*  PURPLE_MESSAGE_SEND        = 0x0001, /**&lt; Outgoing message. */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,74 +4,132 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> const {classes: Cc, interfaces: Ci, utils: Cu, Constructor: CC} = Components;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> Cu.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;logDir&quot;, function() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  file.append(&quot;logs&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-  return file;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-});</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function()</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  Services.strings.createBundle(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+Cu.import(&quot;resource://gre/modules/AsyncShutdown.jsm&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Task.jsm&quot;)</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+XPCOMUtils.defineLazyModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-const FileInputStream = CC(&quot;@mozilla.org/network/file-input-stream;1&quot;,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-                           &quot;nsIFileInputStream&quot;,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-                           &quot;init&quot;);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-const ConverterInputStream = CC(&quot;@mozilla.org/intl/converter-input-stream;1&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                                &quot;nsIConverterInputStream&quot;,</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                                &quot;init&quot;);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-const LocalFile = CC(&quot;@mozilla.org/file/local;1&quot;,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-                     &quot;nsILocalFile&quot;,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                     &quot;initWithPath&quot;);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+);</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> const kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+/*</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * Maps file paths to promises returned by ongoing OS.File operations on them.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+ * This is so that a file can be read after a pending write operation completes</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ * and vice versa (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+let gFilePromises = new Map();</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+// Uses above map to queue operations on a file.</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+function queueFileOperation(aPath, aOperation) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  // Ensure the operation is queued regardless of whether the last one succeeded.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  // This is safe since the promise is returned and consumers are expected to</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  // handle any errors. If there's no promise existing for the given path already,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  // queue the operation on a dummy pre-resolved promise.</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  let promise =</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    (gFilePromises.get(aPath) || Promise.resolve()).then(aOperation, aOperation);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  gFilePromises.set(aPath, promise);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  let cleanup = () =&gt; {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    // If no further operations have been queued, remove the reference from the map.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    if (gFilePromises.get(aPath) === promise)</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      gFilePromises.delete(aPath);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  };</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  // Ensure we clear unused promises whether they resolved or rejected.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  promise.then(cleanup, cleanup);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  return promise;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+}</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+/*</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+ * Convenience method to append to a file using the above queue system. If any of</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+ * the I/O operations reject, the returned promise will reject with the same reason.</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+ * We open the file, append, and close it immediately. The alternative is to keep</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+ * it open and append as required, but we want to make sure we don't open a file</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+ * for reading while it's already open for writing, so we close it every time</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+ * (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+ * Note: This function creates parent directories if required.</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+ */</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+function appendToFile(aPath, aEncodedString, aCreate) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  return queueFileOperation(aPath, Task.async(function* () {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    yield OS.File.makeDir(OS.Path.dirname(aPath),</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+                          {ignoreExisting: true, from: OS.Constants.Path.profileDir});</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    let file = yield OS.File.open(aPath, {write: true, create: aCreate});</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    try {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+      yield file.write(aEncodedString);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    finally {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+      /*</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+       * If both the write() above and the close() below throw, and we don't</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+       * handle the close error here, the promise will be rejected with the close</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+       * error and the write error will be dropped. To avoid this, we log any</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+       * close error here so that any write error will be propagated.</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+       */</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+      yield file.close().catch(Cu.reportError);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    }</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  }));</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+}</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+AsyncShutdown.profileBeforeChange.addBlocker(</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  &quot;Chat logger: writing all pending messages&quot;,</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  Task.async(function* () {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    for (let promise of gFilePromises.values()) {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+      try {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+        yield promise;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      }</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      catch (aError) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+        // Ignore the error, whatever queued the operation will take care of it.</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      }</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    }</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  })</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+</span>
<a href="#l4.112"></a><span id="l4.112"> // This function checks names against OS naming conventions and alters them</span>
<a href="#l4.113"></a><span id="l4.113"> // accordingly so that they can be used as file/folder names.</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-function encodeName(aName)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-{</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+function encodeName(aName) {</span>
<a href="#l4.117"></a><span id="l4.117">   // Reserved device names by Windows (prefixing &quot;%&quot;).</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-  var reservedNames = /^(CON|PRN|AUX|NUL|COM\d|LPT\d)$/i;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  let reservedNames = /^(CON|PRN|AUX|NUL|COM\d|LPT\d)$/i;</span>
<a href="#l4.120"></a><span id="l4.120">   if (reservedNames.test(aName))</span>
<a href="#l4.121"></a><span id="l4.121">     return &quot;%&quot; + aName;</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">   // &quot;.&quot; and &quot; &quot; must not be at the end of a file or folder name (appending &quot;_&quot;).</span>
<a href="#l4.124"></a><span id="l4.124">   if (/[\. _]/.test(aName.slice(-1)))</span>
<a href="#l4.125"></a><span id="l4.125">     aName += &quot;_&quot;;</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127">   // Reserved characters are replaced by %[hex value]. encodeURIComponent() is</span>
<a href="#l4.128"></a><span id="l4.128">   // not sufficient, nevertheless decodeURIComponent() can be used to decode.</span>
<a href="#l4.129"></a><span id="l4.129">   function encodeReservedChars(match) &quot;%&quot; + match.charCodeAt(0).toString(16);</span>
<a href="#l4.130"></a><span id="l4.130">   return aName.replace(/[&lt;&gt;:&quot;\/\\|?*&amp;%]/g, encodeReservedChars);</span>
<a href="#l4.131"></a><span id="l4.131"> }</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-function getLogFolderForAccount(aAccount, aCreate)</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-{</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  let file = logDir.clone();</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  function createIfNotExists(aFile) {</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-    if (aCreate &amp;&amp; !aFile.exists())</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-      aFile.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-  }</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-  createIfNotExists(file);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-  file.append(aAccount.protocol.normalizedName);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  createIfNotExists(file);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-  file.append(encodeName(aAccount.normalizedName));</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  createIfNotExists(file);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  return file;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+function getLogFolderPathForAccount(aAccount) {</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+  return OS.Path.join(OS.Constants.Path.profileDir,</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+                      &quot;logs&quot;, aAccount.protocol.normalizedName,</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+                      encodeName(aAccount.normalizedName));</span>
<a href="#l4.150"></a><span id="l4.150"> }</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-function getNewLogFileName(aFormat, aDate)</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-{</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+function getLogFilePathForConversation(aConv, aFormat) {</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  let path = getLogFolderPathForAccount(aConv.account);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  let name = aConv.normalizedName;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  if (convIsRealMUC(aConv))</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    name += &quot;.chat&quot;;</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  return OS.Path.join(path, encodeName(name),</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+                      getNewLogFileName(aFormat, aConv.startDate));</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+}</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+function getNewLogFileName(aFormat, aDate) {</span>
<a href="#l4.164"></a><span id="l4.164">   let date = aDate ? new Date(aDate / 1000) : new Date();</span>
<a href="#l4.165"></a><span id="l4.165">   let dateTime = date.toLocaleFormat(&quot;%Y-%m-%d.%H%M%S&quot;);</span>
<a href="#l4.166"></a><span id="l4.166">   let offset = date.getTimezoneOffset();</span>
<a href="#l4.167"></a><span id="l4.167">   if (offset &lt; 0) {</span>
<a href="#l4.168"></a><span id="l4.168">     dateTime += &quot;+&quot;;</span>
<a href="#l4.169"></a><span id="l4.169">     offset *= -1;</span>
<a href="#l4.170"></a><span id="l4.170">   }</span>
<a href="#l4.171"></a><span id="l4.171">   else</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineat">@@ -80,52 +138,39 @@ function getNewLogFileName(aFormat, aDat</span>
<a href="#l4.173"></a><span id="l4.173">   offset = (offset - minutes) / 60;</span>
<a href="#l4.174"></a><span id="l4.174">   function twoDigits(aNumber)</span>
<a href="#l4.175"></a><span id="l4.175">     aNumber == 0 ? &quot;00&quot; : aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l4.176"></a><span id="l4.176">   if (!aFormat)</span>
<a href="#l4.177"></a><span id="l4.177">     aFormat = &quot;txt&quot;;</span>
<a href="#l4.178"></a><span id="l4.178">   return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l4.179"></a><span id="l4.179"> }</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-/* Conversation logs stuff */</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-function ConversationLog(aConversation)</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-{</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+// One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+// a log file and appends to it as required.</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+function LogWriter(aConversation) {</span>
<a href="#l4.188"></a><span id="l4.188">   this._conv = aConversation;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    this.format = &quot;json&quot;;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+  this.path = getLogFilePathForConversation(aConversation, this.format);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  this._initialized =</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+    appendToFile(this.path, this.encoder.encode(this._getHeader()), true);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  // writing the header failed.</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  this._initialized.catch(aError =&gt;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+                          Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError));</span>
<a href="#l4.198"></a><span id="l4.198"> }</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-ConversationLog.prototype = {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  _log: null,</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  file: null,</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+LogWriter.prototype = {</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  path: null,</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  // has been written.</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+  _initialized: null,</span>
<a href="#l4.207"></a><span id="l4.207">   format: &quot;txt&quot;,</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-  _init: function cl_init() {</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-    let file = getLogFolderForAccount(this._conv.account, true);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-    let name = this._conv.normalizedName;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-    if (convIsRealMUC(this._conv))</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-      name += &quot;.chat&quot;;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-    file.append(encodeName(name));</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-    if (!file.exists())</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-      file.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-      this.format = &quot;json&quot;;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-    file.append(getNewLogFileName(this.format, this._conv.startDate));</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-    this.file = file;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-    let os = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-             createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-    const PR_WRITE_ONLY   = 0x02;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-    const PR_CREATE_FILE  = 0x08;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    const PR_APPEND       = 0x10;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    os.init(file, PR_WRITE_ONLY | PR_CREATE_FILE | PR_APPEND, 0666, 0);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-    // just to be really sure everything is in UTF8</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-    let converter = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-                    createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-    converter.init(os, &quot;UTF-8&quot;, 0, 0);</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-    this._log = converter;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-    this._log.writeString(this._getHeader());</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-  },</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-  _getHeader: function cl_getHeader()</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-  {</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  encoder: new TextEncoder(),</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  _getHeader: function cl_getHeader() {</span>
<a href="#l4.237"></a><span id="l4.237">     let account = this._conv.account;</span>
<a href="#l4.238"></a><span id="l4.238">     if (this.format == &quot;json&quot;) {</span>
<a href="#l4.239"></a><span id="l4.239">       return JSON.stringify({date: new Date(this._conv.startDate / 1000),</span>
<a href="#l4.240"></a><span id="l4.240">                              name: this._conv.name,</span>
<a href="#l4.241"></a><span id="l4.241">                              title: this._conv.title,</span>
<a href="#l4.242"></a><span id="l4.242">                              account: account.normalizedName,</span>
<a href="#l4.243"></a><span id="l4.243">                              protocol: account.protocol.normalizedName,</span>
<a href="#l4.244"></a><span id="l4.244">                              isChat: this._conv.isChat,</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineat">@@ -155,313 +200,141 @@ ConversationLog.prototype = {</span>
<a href="#l4.246"></a><span id="l4.246">         if (url != content)</span>
<a href="#l4.247"></a><span id="l4.247">           aNode.textContent = content + &quot; (&quot; + url + &quot;)&quot;;</span>
<a href="#l4.248"></a><span id="l4.248">       }</span>
<a href="#l4.249"></a><span id="l4.249">       return null;</span>
<a href="#l4.250"></a><span id="l4.250">     }});</span>
<a href="#l4.251"></a><span id="l4.251">     return encoder.encodeToString();</span>
<a href="#l4.252"></a><span id="l4.252">   },</span>
<a href="#l4.253"></a><span id="l4.253">   logMessage: function cl_logMessage(aMessage) {</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-    if (!this._log)</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-      this._init();</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+    let lineToWrite;</span>
<a href="#l4.258"></a><span id="l4.258">     if (this.format == &quot;json&quot;) {</span>
<a href="#l4.259"></a><span id="l4.259">       let msg = {</span>
<a href="#l4.260"></a><span id="l4.260">         date: new Date(aMessage.time * 1000),</span>
<a href="#l4.261"></a><span id="l4.261">         who: aMessage.who,</span>
<a href="#l4.262"></a><span id="l4.262">         text: aMessage.originalMessage,</span>
<a href="#l4.263"></a><span id="l4.263">         flags: [&quot;outgoing&quot;, &quot;incoming&quot;, &quot;system&quot;, &quot;autoResponse&quot;,</span>
<a href="#l4.264"></a><span id="l4.264">                 &quot;containsNick&quot;, &quot;error&quot;, &quot;delayed&quot;,</span>
<a href="#l4.265"></a><span id="l4.265">                 &quot;noFormat&quot;, &quot;containsImages&quot;, &quot;notification&quot;,</span>
<a href="#l4.266"></a><span id="l4.266">                 &quot;noLinkification&quot;].filter(function(f) aMessage[f])</span>
<a href="#l4.267"></a><span id="l4.267">       };</span>
<a href="#l4.268"></a><span id="l4.268">       let alias = aMessage.alias;</span>
<a href="#l4.269"></a><span id="l4.269">       if (alias &amp;&amp; alias != msg.who)</span>
<a href="#l4.270"></a><span id="l4.270">         msg.alias = alias;</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-      this._log.writeString(JSON.stringify(msg) + &quot;\n&quot;);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-      return;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-    }</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-    let date = new Date(aMessage.time * 1000);</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-    let line = &quot;(&quot; + date.toLocaleTimeString() + &quot;) &quot;;</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-    let msg = this._serialize(aMessage.originalMessage);</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    if (aMessage.system)</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-      line += msg;</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-    else {</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-      let sender = aMessage.alias || aMessage.who;</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-      if (aMessage.autoResponse)</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-        line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-      else {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-        if (msg.startsWith(&quot;/me &quot;))</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-          line += &quot;***&quot; + sender + &quot; &quot; + msg.substr(4);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-        else</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-          line += sender + &quot;: &quot; + msg;</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-      }</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-    }</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-    this._log.writeString(line + kLineBreak);</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-  },</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-  close: function cl_close() {</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-    if (this._log) {</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-      this._log.close();</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-      this._log = null;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-      this.file = null;</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+      lineToWrite = JSON.stringify(msg) + &quot;\n&quot;;</span>
<a href="#l4.300"></a><span id="l4.300">     }</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  }</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-};</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-const dummyConversationLog = {</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-  file: null,</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-  logMessage: function() {},</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-  close: function() {}</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-};</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-var gConversationLogs = { };</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-function getLogForConversation(aConversation)</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-{</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-  let id = aConversation.id;</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-  if (!(id in gConversationLogs)) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-    let prefName =</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-      &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-    if (Services.prefs.getBoolPref(prefName))</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      gConversationLogs[id] = new ConversationLog(aConversation);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-    else</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-      gConversationLogs[id] = dummyConversationLog;</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-  }</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-  return gConversationLogs[id];</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-}</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-function closeLogForConversation(aConversation)</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-{</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-  let id = aConversation.id;</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-  if (!(id in gConversationLogs))</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-    return;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-  gConversationLogs[id].close();</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-  delete gConversationLogs[id];</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-}</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-/* System logs stuff */</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-function SystemLog(aAccount)</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-{</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-  this._init(aAccount);</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-  this._log.writeString(&quot;System log for account &quot; + aAccount.name +</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-                        &quot; (&quot; + aAccount.protocol.normalizedName +</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-                        &quot;) connected at &quot; +</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-                        (new Date()).toLocaleFormat(&quot;%c&quot;) + kLineBreak);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-}</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-SystemLog.prototype = {</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-  _log: null,</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-  _init: function sl_init(aAccount) {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-    let file = getLogFolderForAccount(aAccount, true);</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-    file.append(&quot;.system&quot;);</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-    if (!file.exists())</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-      file.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-    file.append(getNewLogFileName());</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-    let os = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-             createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-    const PR_WRITE_ONLY   = 0x02;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-    const PR_CREATE_FILE  = 0x08;</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-    const PR_APPEND       = 0x10;</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-    os.init(file, PR_WRITE_ONLY | PR_CREATE_FILE | PR_APPEND, 0666, 0);</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-    // just to be really sure everything is in UTF8</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-    let converter = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-                    createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-    converter.init(os, &quot;UTF-8&quot;, 0, 0);</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-    this._log = converter;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-  },</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-  logEvent: function sl_logEvent(aString) {</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-    if (!this._log)</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-      this._init();</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-    let date = (new Date()).toLocaleFormat(&quot;%x %X&quot;);</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-    this._log.writeString(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-  },</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-  close: function sl_close() {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-    if (this._log) {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-      this._log.close();</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-      this._log = null;</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+    else {</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+      // Text log.</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+      let date = new Date(aMessage.time * 1000);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+      let line = &quot;(&quot; + date.toLocaleTimeString() + &quot;) &quot;;</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+      let msg = this._serialize(aMessage.originalMessage);</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+      if (aMessage.system)</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+        line += msg;</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+      else {</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+        let sender = aMessage.alias || aMessage.who;</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+        if (aMessage.autoResponse)</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+          line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+        else {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+          if (msg.startsWith(&quot;/me &quot;))</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+            line += &quot;***&quot; + sender + &quot; &quot; + msg.substr(4);</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+          else</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+            line += sender + &quot;: &quot; + msg;</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+        }</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+      }</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+      lineToWrite = line + kLineBreak;</span>
<a href="#l4.394"></a><span id="l4.394">     }</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+    lineToWrite = this.encoder.encode(lineToWrite);</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+    this._initialized.then(() =&gt; {</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+      appendToFile(this.path, lineToWrite)</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+        .catch(aError =&gt; Cu.reportError(&quot;Failed to log message:\n&quot; + aError));</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+    });</span>
<a href="#l4.400"></a><span id="l4.400">   }</span>
<a href="#l4.401"></a><span id="l4.401"> };</span>
<a href="#l4.402"></a><span id="l4.402"> </span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-const dummySystemLog = {</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-  logEvent: function(aString) {},</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-  close: function() {}</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+const dummyLogWriter = {</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+  path: null,</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+  logMessage: function() {}</span>
<a href="#l4.409"></a><span id="l4.409"> };</span>
<a href="#l4.410"></a><span id="l4.410"> </span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-var gSystemLogs = { };</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-function getLogForAccount(aAccount, aCreate)</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-{</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-  let id = aAccount.id;</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-  if (aCreate) {</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-    if (id in gSystemLogs)</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-      gSystemLogs[id].close();</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;))</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-      return dummySystemLog;</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-    return (gSystemLogs[id] = new SystemLog(aAccount));</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+let gLogWritersById = new Map();</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+function getLogWriter(aConversation) {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+  let id = aConversation.id;</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+  if (!gLogWritersById.has(id)) {</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+    let prefName =</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+      &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+    if (Services.prefs.getBoolPref(prefName))</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+      gLogWritersById.set(id, new LogWriter(aConversation));</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+    else</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+      gLogWritersById.set(id, dummyLogWriter);</span>
<a href="#l4.432"></a><span id="l4.432">   }</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-  return (id in gSystemLogs) &amp;&amp; gSystemLogs[id] || dummySystemLog;</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+  return gLogWritersById.get(id);</span>
<a href="#l4.436"></a><span id="l4.436"> }</span>
<a href="#l4.437"></a><span id="l4.437"> </span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-function closeLogForAccount(aAccount)</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-{</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-  let id = aAccount.id;</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-  if (!(id in gSystemLogs))</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-    return;</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-  gSystemLogs[id].close();</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-  delete gSystemLogs[id];</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+function closeLogWriter(aConversation) {</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+  gLogWritersById.delete(aConversation.id);</span>
<a href="#l4.447"></a><span id="l4.447"> }</span>
<a href="#l4.448"></a><span id="l4.448"> </span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-function LogMessage(aData, aConversation)</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-{</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-  this._init(aData.who, aData.text);</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-  this._conversation = aConversation;</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-  this.time = Math.round(new Date(aData.date) / 1000);</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-  if (&quot;alias&quot; in aData)</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-    this._alias = aData.alias;</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-  for each (let flag in aData.flags)</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-    this[flag] = true;</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+// LogWriter for system logs.</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+function SystemLogWriter(aAccount) {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+  this.path = OS.Path.join(getLogFolderPathForAccount(aAccount), &quot;.system&quot;,</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+                           getNewLogFileName());</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+  let header = &quot;System log for account &quot; + aAccount.name +</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+               &quot; (&quot; + aAccount.protocol.normalizedName +</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+               &quot;) connected at &quot; +</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+               (new Date()).toLocaleFormat(&quot;%c&quot;) + kLineBreak;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+  this._initialized = appendToFile(this.path, this.encoder.encode(header), true);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+  // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+  // writing the header failed.</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+  this._initialized.catch(aError =&gt;</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+                          Cu.reportError(&quot;Error initializing system log:\n&quot; + aError));</span>
<a href="#l4.472"></a><span id="l4.472"> }</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-LogMessage.prototype = GenericMessagePrototype;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-function LogConversation(aLineInputStreams)</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-{</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-  // If aLineInputStreams isn't an Array, we'll assume that it's a lone</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-  // InputStream, and wrap it in an Array.</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-  if (!Array.isArray(aLineInputStreams))</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-    aLineInputStreams = [aLineInputStreams];</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-  this._messages = [];</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-  // We'll read the name, title, account, and protocol data from the first</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-  // stream, and skip the others.</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-  let firstFile = true;</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineminus">-  for each (let inputStream in aLineInputStreams) {</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-    let stream = inputStream.stream;</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-    let line = {value: &quot;&quot;};</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-    let more = stream.readLine(line);</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-    let sessionMsg = {</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineminus">-      who: &quot;sessionstart&quot;,</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineminus">-      date: getDateFromFilename(inputStream.filename)[0],</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-      text: &quot;&quot;,</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-      flags: [&quot;noLog&quot;, &quot;notification&quot;]</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    }</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-    if (!line.value) {</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-      // Bad log file.</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-      sessionMsg.text = bundle.formatStringFromName(&quot;badLogfile&quot;,</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-                                                    [inputStream.filename], 1);</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-      sessionMsg.flags.push(&quot;error&quot;, &quot;system&quot;);</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-      this._messages.push(sessionMsg);</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-      continue;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    }</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-    this._messages.push(sessionMsg);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-    if (firstFile) {</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-      let data = JSON.parse(line.value);</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-      this.startDate = new Date(data.date) * 1000;</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-      this.name = data.name;</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-      this.title = data.title;</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-      this._accountName = data.account;</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-      this._protocolName = data.protocol;</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-      this._isChat = data.isChat;</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-      this.normalizedName = data.normalizedName;</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-      firstFile = false;</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-    }</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-    while (more) {</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-      more = stream.readLine(line);</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-      if (!line.value)</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-        break;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-      try {</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-        this._messages.push(JSON.parse(line.value));</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-      } catch (e) {</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-        // if a message line contains junk, just ignore the error and</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-        // continue reading the conversation.</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-      }</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    }</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-  }</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-  if (firstFile)</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-    throw &quot;All selected log files are invalid&quot;;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-}</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-LogConversation.prototype = {</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-  __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-  get isChat() this._isChat,</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-  get buddy() null,</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-  get account() ({</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-    alias: &quot;&quot;,</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-    name: this._accountName,</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-    normalizedName: this._accountName,</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-    protocol: {name: this._protocolName},</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-    statusInfo: Services.core.globalUserStatus</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-  }),</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-  getMessages: function(aMessageCount) {</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-    if (aMessageCount)</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-      aMessageCount.value = this._messages.length;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-    return this._messages.map(function(m) new LogMessage(m, this), this);</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-  },</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-  getMessagesEnumerator: function(aMessageCount) {</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-    if (aMessageCount)</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-      aMessageCount.value = this._messages.length;</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-    let enumerator = {</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-      _index: 0,</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-      _conv: this,</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-      _messages: this._messages,</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-      hasMoreElements: function() this._index &lt; this._messages.length,</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-      getNext: function() new LogMessage(this._messages[this._index++], this._conv),</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-      QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-    };</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-    return enumerator;</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+SystemLogWriter.prototype = {</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+  encoder: new TextEncoder(),</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+  // has been written.</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+  _initialized: null,</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+  path: null,</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+  logEvent: function sl_logEvent(aString) {</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+    let date = (new Date()).toLocaleFormat(&quot;%x %X&quot;);</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+    let lineToWrite =</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+      this.encoder.encode(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak);</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+    this._initialized.then(() =&gt; {</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+      appendToFile(this.path, lineToWrite)</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+        .catch(aError =&gt; Cu.reportError(&quot;Failed to log event:\n&quot; + aError));</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+    });</span>
<a href="#l4.578"></a><span id="l4.578">   }</span>
<a href="#l4.579"></a><span id="l4.579"> };</span>
<a href="#l4.580"></a><span id="l4.580"> </span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-/* Generic log enumeration stuff */</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-function Log(aFile)</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-{</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-  this.file = aFile;</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-  this.path = aFile.path;</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+const dummySystemLogWriter = {</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+  path: null,</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+  logEvent: function() {}</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+};</span>
<a href="#l4.590"></a><span id="l4.590"> </span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-  let [date, format] = getDateFromFilename(aFile.leafName);</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-  if (!date || !format) {</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-    this.format = &quot;invalid&quot;;</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-    this.time = 0;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-    return;</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-  }</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-  this.time = date.valueOf() / 1000;</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-  this.format = format;</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-}</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-Log.prototype = {</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-  __proto__: ClassInfo(&quot;imILog&quot;, &quot;Log object&quot;),</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-  getConversation: function() {</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-    if (this.format != &quot;json&quot;)</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-      return null;</span>
<a href="#l4.605"></a><span id="l4.605"> </span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-    const PR_RDONLY = 0x01;</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-    let fis = new FileInputStream(this.file, PR_RDONLY, 0444,</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-                                  Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-    let lis = new ConverterInputStream(fis, &quot;UTF-8&quot;, 1024, 0x0);</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-    lis.QueryInterface(Ci.nsIUnicharLineInputStream);</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    try {</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-      return new LogConversation({</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-        stream: lis,</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-        filename: this.file.leafName</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-      });</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-    } catch (e) {</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-      // If the file contains some junk (invalid JSON), the</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-      // LogConversation code will still read the messages it can parse.</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-      // If the first line of meta data is corrupt, there's really no</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-      // useful data we can extract from the file so the</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineminus">-      // LogConversation constructor will throw.</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-      return null;</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-    }</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+let gSystemLogWritersById = new Map();</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+function getSystemLogWriter(aAccount, aCreate) {</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+  let id = aAccount.id;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+  if (aCreate) {</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;))</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+      return dummySystemLogWriter;</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+    let writer = new SystemLogWriter(aAccount);</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+    gSystemLogWritersById.set(id, writer);</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+    return writer;</span>
<a href="#l4.633"></a><span id="l4.633">   }</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineminus">-};</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+  return gSystemLogWritersById.has(id) &amp;&amp; gSystemLogWritersById.get(id) ||</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+    dummySystemLogWriter;</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+}</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+function closeSystemLogWriter(aAccount) {</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+  gSystemLogWritersById.delete(aAccount.id);</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+}</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+</span>
<a href="#l4.644"></a><span id="l4.644"> </span>
<a href="#l4.645"></a><span id="l4.645"> /**</span>
<a href="#l4.646"></a><span id="l4.646">  * Takes a properly formatted log file name and extracts the date information</span>
<a href="#l4.647"></a><span id="l4.647">  * and filetype, returning the results as an Array.</span>
<a href="#l4.648"></a><span id="l4.648">  *</span>
<a href="#l4.649"></a><span id="l4.649">  * Filenames are expected to be formatted as:</span>
<a href="#l4.650"></a><span id="l4.650">  *</span>
<a href="#l4.651"></a><span id="l4.651">  * YYYY-MM-DD.HHmmSS+ZZzz.format</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineat">@@ -485,276 +358,431 @@ function getDateFromFilename(aFilename) </span>
<a href="#l4.653"></a><span id="l4.653">  * Returns true if a Conversation is both a chat conversation, and not</span>
<a href="#l4.654"></a><span id="l4.654">  * a Twitter conversation.</span>
<a href="#l4.655"></a><span id="l4.655">  */</span>
<a href="#l4.656"></a><span id="l4.656"> function convIsRealMUC(aConversation) {</span>
<a href="#l4.657"></a><span id="l4.657">   return (aConversation.isChat &amp;&amp;</span>
<a href="#l4.658"></a><span id="l4.658">           aConversation.account.protocol.id != &quot;prpl-twitter&quot;);</span>
<a href="#l4.659"></a><span id="l4.659"> }</span>
<a href="#l4.660"></a><span id="l4.660"> </span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-function LogEnumerator(aEntries)</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-{</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-  this._entries = aEntries;</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+function LogMessage(aData, aConversation) {</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+  this._init(aData.who, aData.text);</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+  this._conversation = aConversation;</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+  this.time = Math.round(new Date(aData.date) / 1000);</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+  if (&quot;alias&quot; in aData)</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+    this._alias = aData.alias;</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+  for (let flag of aData.flags)</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+    this[flag] = true;</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+}</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+LogMessage.prototype = GenericMessagePrototype;</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineplus">+</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+function LogConversation(aMessages, aProperties) {</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+  this._messages = aMessages;</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+  for (let property in aProperties)</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+    this[property] = aProperties[property];</span>
<a href="#l4.681"></a><span id="l4.681"> }</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-LogEnumerator.prototype = {</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-  _entries: [],</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-  hasMoreElements: function() {</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineminus">-    while (this._entries.length &gt; 0 &amp;&amp; !this._entries[0].hasMoreElements())</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineminus">-      this._entries.shift();</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineminus">-    return this._entries.length &gt; 0;</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+LogConversation.prototype = {</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+  __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+  get isChat() this._isChat,</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+  get buddy() null,</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+  get account() ({</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+    alias: &quot;&quot;,</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    name: this._accountName,</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+    normalizedName: this._accountName,</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+    protocol: {name: this._protocolName},</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+    statusInfo: Services.core.globalUserStatus</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineplus">+  }),</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineplus">+  getMessages: function(aMessageCount) {</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineplus">+    if (aMessageCount)</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+      aMessageCount.value = this._messages.length;</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+    return this._messages.map(function(m) new LogMessage(m, this), this);</span>
<a href="#l4.703"></a><span id="l4.703">   },</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-  getNext: function()</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-    new Log(this._entries[0].getNext().QueryInterface(Ci.nsIFile)),</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+  getMessagesEnumerator: function(aMessageCount) {</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+    if (aMessageCount)</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+      aMessageCount.value = this._messages.length;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+    let enumerator = {</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+      _index: 0,</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+      _conv: this,</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+      _messages: this._messages,</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+      hasMoreElements: function() this._index &lt; this._messages.length,</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineplus">+      getNext: function() new LogMessage(this._messages[this._index++], this._conv),</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+      QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+    };</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+    return enumerator;</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+  }</span>
<a href="#l4.720"></a><span id="l4.720"> };</span>
<a href="#l4.721"></a><span id="l4.721"> </span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+/**</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+ * A Log object represents one or more log files. The constructor expects one</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+ * argument, which is either a single path to a (json or txt) log file or an</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+ * array of objects each having two properties:</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineplus">+ *   path: The full path of the (json only) log file it represents.</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+ *   time: The Date object extracted from the filename of the logfile.</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+ *</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineplus">+ * The returned Log object's time property will be:</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+ *   For a single file - exact time extracted from the name of the log file.</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+ *   For a set of files - the time extracted, reduced to the day.</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+ */</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+function Log(aEntries) {</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineplus">+  if (typeof aEntries == &quot;string&quot;) {</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineplus">+    // Assume that aEntries is a single path.</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+    let path = aEntries;</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineplus">+    this.path = path;</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+    let [date, format] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+    if (!date || !format) {</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+      this.format = &quot;invalid&quot;;</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+      this.time = 0;</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineplus">+      return;</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+    }</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+    this.time = date.valueOf() / 1000;</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+    this.format = format;</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+    // Wrap the path in an array</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+    this._entryPaths = [path];</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+    return;</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+  }</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+  if (!aEntries.length) {</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+    throw new Error(&quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineplus">+                    &quot;expected a non-empty array or a string.&quot;);</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineplus">+  }</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineplus">+</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+  // Assume aEntries is an array of objects.</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+  // Sort our list of entries for this day in increasing order.</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+  aEntries.sort(function(aLeft, aRight) aLeft.time - aRight.time);</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+  this._entryPaths = [entry.path for (entry of aEntries)];</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+  // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+  let timestamp = new Date(aEntries[0].time);</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+  timestamp.setHours(0);</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+  timestamp.setMinutes(0);</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+  timestamp.setSeconds(0);</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+  this.time = timestamp.valueOf() / 1000;</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineplus">+  // Path is used to uniquely identify a Log, and sometimes used to</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+  // quickly determine which directory a log file is from.  We'll use</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineplus">+  // the first file's path.</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+  this.path = aEntries[0].path;</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+}</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+Log.prototype = {</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+  __proto__: ClassInfo(&quot;imILog&quot;, &quot;Log object&quot;),</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+  _entryPaths: null,</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+  format: &quot;json&quot;,</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+  getConversation: Task.async(function* () {</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+    /*</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+     * Read the set of log files asynchronously and return a promise that</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+     * resolves to a LogConversation instance. Even if a file contains some</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineplus">+     * junk (invalid JSON), messages that are valid will be read. If the first</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineplus">+     * line of metadata is corrupt however, the data isn't useful and the</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+     * promise will resolve to null.</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+     */</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+    if (this.format != &quot;json&quot;)</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+      return null;</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+    let messages = [];</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+    let properties = {};</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+    let firstFile = true;</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+    let decoder = new TextDecoder();</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+    for (let path of this._entryPaths) {</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+      let lines;</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+      try {</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineplus">+        let contents = yield queueFileOperation(path, () =&gt; OS.File.read(path));</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+        lines = decoder.decode(contents).split(&quot;\n&quot;);</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineplus">+      } catch (aError) {</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+        Cu.reportError(&quot;Error reading log file \&quot;&quot; + path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+        continue;</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+      }</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+      let nextLine = lines.shift();</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+      let filename = OS.Path.basename(path);</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineplus">+      let sessionMsg = {</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineplus">+        who: &quot;sessionstart&quot;,</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+        date: getDateFromFilename(filename)[0],</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineplus">+        text: &quot;&quot;,</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+        flags: [&quot;noLog&quot;, &quot;notification&quot;]</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+      };</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineplus">+      let data;</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+      try {</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineplus">+        // This will fail if either nextLine is undefined, or not valid JSON.</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineplus">+        data = JSON.parse(nextLine);</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+      } catch (aError) {</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+        sessionMsg.text = _(&quot;badLogFile&quot;, filename);</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+        sessionMsg.flags.push(&quot;error&quot;, &quot;system&quot;);</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+        messages.push(sessionMsg);</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+        continue;</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+      }</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+      messages.push(sessionMsg);</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+      if (firstFile) {</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+        properties.startDate = new Date(data.date) * 1000;</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+        properties.name = data.name;</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+        properties.title = data.title;</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+        properties._accountName = data.account;</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+        properties._protocolName = data.protocol;</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+        properties._isChat = data.isChat;</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+        properties.normalizedName = data.normalizedName;</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+        firstFile = false;</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+      }</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+      while (lines.length) {</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+        nextLine = lines.shift();</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+        if (!nextLine)</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+          break;</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+        try {</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+          messages.push(JSON.parse(nextLine));</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+        } catch (e) {</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+          // If a message line contains junk, just ignore the error and</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+          // continue reading the conversation.</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+        }</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+      }</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+    }</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineplus">+</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+    if (firstFile) // All selected log files are invalid.</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+      return null;</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineplus">+</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+    return new LogConversation(messages, properties);</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+  })</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+};</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineplus">+</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineplus">+/**</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineplus">+ * Log enumerators provide lists of log files (&quot;entries&quot;). aEntries is an array</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+ * of the OS.File.DirectoryIterator.Entry instances which represent the log</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+ * files to be parsed.</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+ *</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+ * DailyLogEnumerator organizes entries by date, and enumerates them in order.</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+ * LogEnumerator enumerates logs in the same order as the input array.</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+ */</span>
<a href="#l4.861"></a><span id="l4.861"> function DailyLogEnumerator(aEntries) {</span>
<a href="#l4.862"></a><span id="l4.862">   this._entries = {};</span>
<a href="#l4.863"></a><span id="l4.863"> </span>
<a href="#l4.864"></a><span id="l4.864" class="difflineminus">-  for each (let entry in aEntries) {</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineminus">-    while (entry.hasMoreElements()) {</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineminus">-      let file = entry.getNext();</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineminus">-      if (!(file instanceof Ci.nsIFile))</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-        continue;</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+  for (let entry of aEntries) {</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+    let path = entry.path;</span>
<a href="#l4.871"></a><span id="l4.871"> </span>
<a href="#l4.872"></a><span id="l4.872" class="difflineminus">-      let [logDate, logFormat] = getDateFromFilename(file.leafName);</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-      if (!logDate) {</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineminus">-        // We'll skip this one, since it's got a busted filename.</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineminus">-        continue;</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineminus">-      }</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineplus">+    let [logDate, logFormat] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+    if (!logDate) {</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+      // We'll skip this one, since it's got a busted filename.</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+      continue;</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+    }</span>
<a href="#l4.882"></a><span id="l4.882"> </span>
<a href="#l4.883"></a><span id="l4.883" class="difflineminus">-      let dateForID = new Date(logDate);</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineminus">-      let dayID;</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineminus">-      if (logFormat == &quot;json&quot;) {</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineminus">-        // We want to cluster all of the logs that occur on the same day</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineminus">-        // into the same Arrays. We clone the date for the log, reset it to</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineminus">-        // the 0th hour/minute/second, and use that to construct an ID for the</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineminus">-        // Array we'll put the log in.</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineminus">-        dateForID.setHours(0);</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineminus">-        dateForID.setMinutes(0);</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineminus">-        dateForID.setSeconds(0);</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineminus">-        dayID = dateForID.toISOString();</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineminus">-      }</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-      else {</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineminus">-        // Add legacy text logs as individual entries.</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineminus">-        dayID = dateForID.toISOString() + &quot;txt&quot;;</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineminus">-      }</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+    let dateForID = new Date(logDate);</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+    let dayID;</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+    if (logFormat == &quot;json&quot;) {</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+      // We want to cluster all of the logs that occur on the same day</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+      // into the same Arrays. We clone the date for the log, reset it to</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+      // the 0th hour/minute/second, and use that to construct an ID for the</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+      // Array we'll put the log in.</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+      dateForID.setHours(0);</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineplus">+      dateForID.setMinutes(0);</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+      dateForID.setSeconds(0);</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+      dayID = dateForID.toISOString();</span>
<a href="#l4.910"></a><span id="l4.910"> </span>
<a href="#l4.911"></a><span id="l4.911">       if (!(dayID in this._entries))</span>
<a href="#l4.912"></a><span id="l4.912">         this._entries[dayID] = [];</span>
<a href="#l4.913"></a><span id="l4.913"> </span>
<a href="#l4.914"></a><span id="l4.914">       this._entries[dayID].push({</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineminus">-        file: file,</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+        path: path,</span>
<a href="#l4.917"></a><span id="l4.917">         time: logDate</span>
<a href="#l4.918"></a><span id="l4.918">       });</span>
<a href="#l4.919"></a><span id="l4.919">     }</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+    else {</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+      // Add legacy text logs as individual paths.</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+      dayID = dateForID.toISOString() + &quot;txt&quot;;</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+      this._entries[dayID] = path;</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+    }</span>
<a href="#l4.925"></a><span id="l4.925">   }</span>
<a href="#l4.926"></a><span id="l4.926"> </span>
<a href="#l4.927"></a><span id="l4.927">   this._days = Object.keys(this._entries).sort();</span>
<a href="#l4.928"></a><span id="l4.928">   this._index = 0;</span>
<a href="#l4.929"></a><span id="l4.929"> }</span>
<a href="#l4.930"></a><span id="l4.930"> DailyLogEnumerator.prototype = {</span>
<a href="#l4.931"></a><span id="l4.931">   _entries: {},</span>
<a href="#l4.932"></a><span id="l4.932">   _days: [],</span>
<a href="#l4.933"></a><span id="l4.933">   _index: 0,</span>
<a href="#l4.934"></a><span id="l4.934">   hasMoreElements: function() this._index &lt; this._days.length,</span>
<a href="#l4.935"></a><span id="l4.935">   getNext: function() {</span>
<a href="#l4.936"></a><span id="l4.936">     let dayID = this._days[this._index++];</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineminus">-    if (dayID.endsWith(&quot;txt&quot;))</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineminus">-      return new Log(this._entries[dayID][0].file);</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineminus">-    else</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineminus">-      return new LogCluster(this._entries[dayID]);</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+    return new Log(this._entries[dayID]);</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineplus">+  },</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+};</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+function LogEnumerator(aEntries) {</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+  this._entries = aEntries;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+  this._entries.sort((a, b) =&gt; a.name &gt; b.name);</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+}</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+LogEnumerator.prototype = {</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+  _entries: [],</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+  hasMoreElements: function() {</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+    return this._entries.length &gt; 0;</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineplus">+  },</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+  getNext: function() {</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+    // Create and return a log from the first entry.</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+    return new Log(this._entries.shift().path);</span>
<a href="#l4.958"></a><span id="l4.958">   },</span>
<a href="#l4.959"></a><span id="l4.959">   QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l4.960"></a><span id="l4.960"> };</span>
<a href="#l4.961"></a><span id="l4.961"> </span>
<a href="#l4.962"></a><span id="l4.962" class="difflineminus">-/**</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineminus">- * A LogCluster is a Log representing several log files all at once. The</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineminus">- * constructor expects aEntries, which is an array of objects that each</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineminus">- * have two properties: file and time. The file is the nsIFile for the</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">- * log file, and the time is the Date object extracted from the filename for</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineminus">- * the log file.</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineminus">- */</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineminus">-function LogCluster(aEntries) {</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineminus">-  if (!aEntries.length)</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineminus">-    throw new Error(&quot;LogCluster was passed an empty Array&quot;);</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineminus">-</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-  // Sort our list of entries for this day in increasing order.</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineminus">-  aEntries.sort(function(aLeft, aRight) aLeft.time - aRight.time);</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineminus">-</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineminus">-  this._entries = aEntries;</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineminus">-  // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineminus">-  let timestamp = new Date(aEntries[0].time);</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineminus">-  timestamp.setHours(0);</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineminus">-  timestamp.setMinutes(0);</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineminus">-  timestamp.setSeconds(0);</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineminus">-  this.time = timestamp.valueOf() / 1000;</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineminus">-  // Path is used to uniquely identify a Log, and sometimes used to</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineminus">-  // quickly determine which directory a log file is from.  We'll use</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineminus">-  // the first file's path.</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineminus">-  this.path = aEntries[0].file.path;</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineminus">-}</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineminus">-LogCluster.prototype = {</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineminus">-  __proto__: ClassInfo(&quot;imILog&quot;, &quot;LogCluster object&quot;),</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineminus">-  format: &quot;json&quot;,</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineminus">-</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineminus">-  getConversation: function() {</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineminus">-    const PR_RDONLY = 0x01;</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineminus">-    let streams = [];</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineminus">-    for each (let entry in this._entries) {</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineminus">-      let fis = new FileInputStream(entry.file, PR_RDONLY, 0444,</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineminus">-                                    Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineminus">-      // Pass in 0x0 so that we throw exceptions on unknown bytes.</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineminus">-      let lis = new ConverterInputStream(fis, &quot;UTF-8&quot;, 1024, 0x0);</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineminus">-      lis.QueryInterface(Ci.nsIUnicharLineInputStream);</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineminus">-      streams.push({</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineminus">-        stream: lis,</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineminus">-        filename: entry.file.leafName</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineminus">-      });</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineminus">-    }</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineminus">-</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineminus">-    try {</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineminus">-      return new LogConversation(streams);</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineminus">-    } catch (e) {</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineminus">-      // If the file contains some junk (invalid JSON), the</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineminus">-      // LogConversation code will still read the messages it can parse.</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-      // If the first line of meta data is corrupt, there's really no</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-      // useful data we can extract from the file so the</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-      // LogConversation constructor will throw.</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineminus">-      return null;</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineminus">-    }</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineminus">-  }</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineminus">-};</span>
<a href="#l4.1019"></a><span id="l4.1019"> </span>
<a href="#l4.1020"></a><span id="l4.1020"> function Logger() { }</span>
<a href="#l4.1021"></a><span id="l4.1021"> Logger.prototype = {</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineminus">-  _getLogArray: function logger__getLogArray(aAccount, aNormalizedName) {</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineminus">-    let entries = [];</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineminus">-    let file = getLogFolderForAccount(aAccount);</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineminus">-    file.append(encodeName(aNormalizedName));</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineminus">-    if (file.exists())</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineminus">-      entries.push(file.directoryEntries);</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineminus">-    return entries;</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineminus">-  },</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineminus">-  getLogFromFile: function logger_getLogFromFile(aFile, aGroupByDay) {</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineminus">-    if (aGroupByDay)</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineminus">-      return this._getDailyLogFromFile(aFile);</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineminus">-</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineminus">-    return new Log(aFile);</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineminus">-  },</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineminus">-  _getDailyLogFromFile: function logger_getDailyLogsForFile(aFile) {</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineminus">-    let [targetDate] = getDateFromFilename(aFile.leafName);</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineplus">+  // Returned Promise resolves to an array of entries for the</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineplus">+  // log folder if it exists, otherwise null.</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+  _getLogArray: Task.async(function* (aAccount, aNormalizedName) {</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+    let iterator;</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+    try {</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+      let path = OS.Path.join(getLogFolderPathForAccount(aAccount),</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+                              encodeName(aNormalizedName));</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+      if (yield queueFileOperation(path, () =&gt; OS.File.exists(path))) {</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineplus">+        iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineplus">+        let entries = yield iterator.nextBatch();</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineplus">+        iterator.close();</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineplus">+        return entries;</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineplus">+      }</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineplus">+    } catch (aError) {</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineplus">+      if (iterator)</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineplus">+        iterator.close();</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+      Cu.reportError(&quot;Error getting directory entries for \&quot;&quot; +</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineplus">+                     path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineplus">+    }</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+    return [];</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+  }),</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineplus">+  getLogFromFile: function logger_getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineplus">+    if (!aGroupByDay)</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineplus">+      return Promise.resolve(new Log(aFilePath));</span>
<a href="#l4.1062"></a><span id="l4.1062" class="difflineplus">+    let [targetDate] = getDateFromFilename(OS.Path.basename(aFilePath));</span>
<a href="#l4.1063"></a><span id="l4.1063">     if (!targetDate)</span>
<a href="#l4.1064"></a><span id="l4.1064">       return null;</span>
<a href="#l4.1065"></a><span id="l4.1065"> </span>
<a href="#l4.1066"></a><span id="l4.1066">     let targetDay = Math.floor(targetDate / (86400 * 1000));</span>
<a href="#l4.1067"></a><span id="l4.1067"> </span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineminus">-    // Get the path for the log file - we'll assume that the files relevant</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineminus">-    // to our interests are in the same folder.</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineminus">-    let path = aFile.path;</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineminus">-    let folder = aFile.parent.directoryEntries;</span>
<a href="#l4.1072"></a><span id="l4.1072" class="difflineplus">+    // We'll assume that the files relevant to our interests are</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineplus">+    // in the same folder as the one provided.</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineplus">+    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aFilePath));</span>
<a href="#l4.1075"></a><span id="l4.1075">     let relevantEntries = [];</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineminus">-    // Pick out the files that start within our date range.</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineminus">-    while (folder.hasMoreElements()) {</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineminus">-      let file = folder.getNext();</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineminus">-      if (!(file instanceof Ci.nsIFile))</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineminus">-        continue;</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineminus">-</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineminus">-      let [logTime] = getDateFromFilename(file.leafName);</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineplus">+    return iterator.forEach(function(aEntry) {</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineplus">+      if (aEntry.isDir)</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineplus">+        return;</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineplus">+      let path = aEntry.path;</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineplus">+      let [logTime] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l4.1088"></a><span id="l4.1088"> </span>
<a href="#l4.1089"></a><span id="l4.1089">       let day = Math.floor(logTime / (86400 * 1000));</span>
<a href="#l4.1090"></a><span id="l4.1090">       if (targetDay == day) {</span>
<a href="#l4.1091"></a><span id="l4.1091">         relevantEntries.push({</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineminus">-          file: file,</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineplus">+          path: path,</span>
<a href="#l4.1094"></a><span id="l4.1094">           time: logTime</span>
<a href="#l4.1095"></a><span id="l4.1095">         });</span>
<a href="#l4.1096"></a><span id="l4.1096">       }</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineminus">-    }</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineminus">-</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineminus">-    return new LogCluster(relevantEntries);</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+    }).then(() =&gt; {</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+      iterator.close();</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+      return new Log(relevantEntries);</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineplus">+    }, aError =&gt; {</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineplus">+      iterator.close();</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineplus">+      throw aError;</span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineplus">+    });</span>
<a href="#l4.1107"></a><span id="l4.1107">   },</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+  // Creates and returns the appropriate LogEnumerator for the given log array</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineplus">+  // depending on aGroupByDay, or an EmptyEnumerator if the input array is empty.</span>
<a href="#l4.1110"></a><span id="l4.1110">   _getEnumerator: function logger__getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l4.1111"></a><span id="l4.1111">     let enumerator = aGroupByDay ? DailyLogEnumerator : LogEnumerator;</span>
<a href="#l4.1112"></a><span id="l4.1112">     return aLogArray.length ? new enumerator(aLogArray) : EmptyEnumerator;</span>
<a href="#l4.1113"></a><span id="l4.1113">   },</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineminus">-  getLogFileForOngoingConversation: function logger_getLogFileForOngoingConversation(aConversation)</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineminus">-    getLogForConversation(aConversation).file,</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineplus">+  getLogPathForConversation: function logger_getLogPathForConversation(aConversation) {</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineplus">+    let writer = gLogWritersById.get(aConversation.id);</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineplus">+    // Resolve to null if we haven't created a LogWriter yet for this conv, or</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineplus">+    // if logging is disabled (path will be null).</span>
<a href="#l4.1120"></a><span id="l4.1120" class="difflineplus">+    if (!writer || !writer.path)</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineplus">+      return Promise.resolve(null);</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineplus">+    let path = writer.path;</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineplus">+    // Wait for any pending file operations to finish, then resolve to the path</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineplus">+    // regardless of whether these operations succeeded.</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineplus">+    return (gFilePromises.get(path) || Promise.resolve()).then(</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineplus">+      () =&gt; path, () =&gt; path);</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineplus">+  },</span>
<a href="#l4.1128"></a><span id="l4.1128">   getLogsForAccountAndName: function logger_getLogsForAccountAndName(aAccount,</span>
<a href="#l4.1129"></a><span id="l4.1129">                                        aNormalizedName, aGroupByDay) {</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineminus">-    let entries = this._getLogArray(aAccount, aNormalizedName);</span>
<a href="#l4.1131"></a><span id="l4.1131" class="difflineminus">-    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineplus">+    return this._getLogArray(aAccount, aNormalizedName)</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineplus">+               .then(aEntries =&gt; this._getEnumerator(aEntries, aGroupByDay));</span>
<a href="#l4.1134"></a><span id="l4.1134">   },</span>
<a href="#l4.1135"></a><span id="l4.1135">   getLogsForAccountBuddy: function logger_getLogsForAccountBuddy(aAccountBuddy,</span>
<a href="#l4.1136"></a><span id="l4.1136">                                                                  aGroupByDay) {</span>
<a href="#l4.1137"></a><span id="l4.1137">     return this.getLogsForAccountAndName(aAccountBuddy.account,</span>
<a href="#l4.1138"></a><span id="l4.1138">                                          aAccountBuddy.normalizedName, aGroupByDay);</span>
<a href="#l4.1139"></a><span id="l4.1139">   },</span>
<a href="#l4.1140"></a><span id="l4.1140" class="difflineminus">-  getLogsForBuddy: function logger_getLogsForBuddy(aBuddy, aGroupByDay) {</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineplus">+  getLogsForBuddy: Task.async(function* (aBuddy, aGroupByDay) {</span>
<a href="#l4.1142"></a><span id="l4.1142">     let entries = [];</span>
<a href="#l4.1143"></a><span id="l4.1143">     for (let accountBuddy of aBuddy.getAccountBuddies()) {</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineminus">-      entries = entries.concat(this._getLogArray(accountBuddy.account,</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineminus">-                                                 accountBuddy.normalizedName));</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineplus">+      entries = entries.concat(yield this._getLogArray(accountBuddy.account,</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineplus">+                                                       accountBuddy.normalizedName));</span>
<a href="#l4.1148"></a><span id="l4.1148">     }</span>
<a href="#l4.1149"></a><span id="l4.1149">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineminus">-  },</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineminus">-  getLogsForContact: function logger_getLogsForContact(aContact, aGroupByDay) {</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineplus">+  }),</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineplus">+  getLogsForContact: Task.async(function* (aContact, aGroupByDay) {</span>
<a href="#l4.1154"></a><span id="l4.1154">     let entries = [];</span>
<a href="#l4.1155"></a><span id="l4.1155">     for (let buddy of aContact.getBuddies()) {</span>
<a href="#l4.1156"></a><span id="l4.1156">       for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineminus">-        entries = entries.concat(this._getLogArray(accountBuddy.account,</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineminus">-                                                   accountBuddy.normalizedName));</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineplus">+        entries = entries.concat(yield this._getLogArray(accountBuddy.account,</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineplus">+                                                         accountBuddy.normalizedName));</span>
<a href="#l4.1161"></a><span id="l4.1161">       }</span>
<a href="#l4.1162"></a><span id="l4.1162">     }</span>
<a href="#l4.1163"></a><span id="l4.1163">     return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineminus">-  },</span>
<a href="#l4.1165"></a><span id="l4.1165" class="difflineplus">+  }),</span>
<a href="#l4.1166"></a><span id="l4.1166">   getLogsForConversation: function logger_getLogsForConversation(aConversation,</span>
<a href="#l4.1167"></a><span id="l4.1167">                                                                  aGroupByDay) {</span>
<a href="#l4.1168"></a><span id="l4.1168">     let name = aConversation.normalizedName;</span>
<a href="#l4.1169"></a><span id="l4.1169">     if (convIsRealMUC(aConversation))</span>
<a href="#l4.1170"></a><span id="l4.1170">       name += &quot;.chat&quot;;</span>
<a href="#l4.1171"></a><span id="l4.1171">     return this.getLogsForAccountAndName(aConversation.account, name, aGroupByDay);</span>
<a href="#l4.1172"></a><span id="l4.1172">   },</span>
<a href="#l4.1173"></a><span id="l4.1173">   getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount)</span>
<a href="#l4.1174"></a><span id="l4.1174">     this.getLogsForAccountAndName(aAccount, &quot;.system&quot;),</span>
<a href="#l4.1175"></a><span id="l4.1175" class="difflineminus">-  getSimilarLogs: function(aLog, aGroupByDay) {</span>
<a href="#l4.1176"></a><span id="l4.1176" class="difflineminus">-    return this._getEnumerator([new LocalFile(aLog.path).parent.directoryEntries],</span>
<a href="#l4.1177"></a><span id="l4.1177" class="difflineminus">-                               aGroupByDay);</span>
<a href="#l4.1178"></a><span id="l4.1178" class="difflineminus">-  },</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineplus">+  getSimilarLogs: Task.async(function* (aLog, aGroupByDay) {</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineplus">+    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l4.1181"></a><span id="l4.1181" class="difflineplus">+    let entries;</span>
<a href="#l4.1182"></a><span id="l4.1182" class="difflineplus">+    try {</span>
<a href="#l4.1183"></a><span id="l4.1183" class="difflineplus">+      entries = yield iterator.nextBatch();</span>
<a href="#l4.1184"></a><span id="l4.1184" class="difflineplus">+    } catch (aError) {</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineplus">+      Cu.reportError(&quot;Error getting similar logs for \&quot;&quot; +</span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineplus">+                     aLog.path + &quot;\&quot;:\n&quot; + aError);</span>
<a href="#l4.1187"></a><span id="l4.1187" class="difflineplus">+    }</span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineplus">+    // If there was an error, this will return an EmptyEnumerator.</span>
<a href="#l4.1189"></a><span id="l4.1189" class="difflineplus">+    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l4.1190"></a><span id="l4.1190" class="difflineplus">+  }),</span>
<a href="#l4.1191"></a><span id="l4.1191"> </span>
<a href="#l4.1192"></a><span id="l4.1192">   observe: function logger_observe(aSubject, aTopic, aData) {</span>
<a href="#l4.1193"></a><span id="l4.1193">     switch (aTopic) {</span>
<a href="#l4.1194"></a><span id="l4.1194">     case &quot;profile-after-change&quot;:</span>
<a href="#l4.1195"></a><span id="l4.1195">       Services.obs.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l4.1196"></a><span id="l4.1196">       break;</span>
<a href="#l4.1197"></a><span id="l4.1197">     case &quot;final-ui-startup&quot;:</span>
<a href="#l4.1198"></a><span id="l4.1198">       Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l4.1199"></a><span id="l4.1199">       [&quot;new-text&quot;, &quot;conversation-closed&quot;, &quot;conversation-left-chat&quot;,</span>
<a href="#l4.1200"></a><span id="l4.1200">        &quot;account-connected&quot;, &quot;account-disconnected&quot;,</span>
<a href="#l4.1201"></a><span id="l4.1201">        &quot;account-buddy-status-changed&quot;].forEach(function(aEvent) {</span>
<a href="#l4.1202"></a><span id="l4.1202">         Services.obs.addObserver(this, aEvent, false);</span>
<a href="#l4.1203"></a><span id="l4.1203">       }, this);</span>
<a href="#l4.1204"></a><span id="l4.1204">       break;</span>
<a href="#l4.1205"></a><span id="l4.1205">     case &quot;new-text&quot;:</span>
<a href="#l4.1206"></a><span id="l4.1206">       if (!aSubject.noLog) {</span>
<a href="#l4.1207"></a><span id="l4.1207" class="difflineminus">-        let log = getLogForConversation(aSubject.conversation);</span>
<a href="#l4.1208"></a><span id="l4.1208" class="difflineplus">+        let log = getLogWriter(aSubject.conversation);</span>
<a href="#l4.1209"></a><span id="l4.1209">         log.logMessage(aSubject);</span>
<a href="#l4.1210"></a><span id="l4.1210">       }</span>
<a href="#l4.1211"></a><span id="l4.1211">       break;</span>
<a href="#l4.1212"></a><span id="l4.1212">     case &quot;conversation-closed&quot;:</span>
<a href="#l4.1213"></a><span id="l4.1213">     case &quot;conversation-left-chat&quot;:</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineminus">-      closeLogForConversation(aSubject);</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineplus">+      closeLogWriter(aSubject);</span>
<a href="#l4.1216"></a><span id="l4.1216">       break;</span>
<a href="#l4.1217"></a><span id="l4.1217">     case &quot;account-connected&quot;:</span>
<a href="#l4.1218"></a><span id="l4.1218" class="difflineminus">-      getLogForAccount(aSubject, true).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l4.1219"></a><span id="l4.1219" class="difflineplus">+      getSystemLogWriter(aSubject, true).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l4.1220"></a><span id="l4.1220">                                                 &quot; signed on&quot;);</span>
<a href="#l4.1221"></a><span id="l4.1221">       break;</span>
<a href="#l4.1222"></a><span id="l4.1222">     case &quot;account-disconnected&quot;:</span>
<a href="#l4.1223"></a><span id="l4.1223" class="difflineminus">-      getLogForAccount(aSubject).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l4.1224"></a><span id="l4.1224" class="difflineplus">+      getSystemLogWriter(aSubject).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l4.1225"></a><span id="l4.1225">                                           &quot; signed off&quot;);</span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineminus">-      closeLogForAccount(aSubject);</span>
<a href="#l4.1227"></a><span id="l4.1227" class="difflineplus">+      closeSystemLogWriter(aSubject);</span>
<a href="#l4.1228"></a><span id="l4.1228">       break;</span>
<a href="#l4.1229"></a><span id="l4.1229">     case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l4.1230"></a><span id="l4.1230">       let status;</span>
<a href="#l4.1231"></a><span id="l4.1231">       if (!aSubject.online)</span>
<a href="#l4.1232"></a><span id="l4.1232">         status = &quot;Offline&quot;;</span>
<a href="#l4.1233"></a><span id="l4.1233">       else if (aSubject.mobile)</span>
<a href="#l4.1234"></a><span id="l4.1234">         status = &quot;Mobile&quot;;</span>
<a href="#l4.1235"></a><span id="l4.1235">       else if (aSubject.idle)</span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineat">@@ -764,17 +792,17 @@ Logger.prototype = {</span>
<a href="#l4.1237"></a><span id="l4.1237">       else</span>
<a href="#l4.1238"></a><span id="l4.1238">         status = &quot;Unavailable&quot;;</span>
<a href="#l4.1239"></a><span id="l4.1239"> </span>
<a href="#l4.1240"></a><span id="l4.1240">       let statusText = aSubject.statusText;</span>
<a href="#l4.1241"></a><span id="l4.1241">       if (statusText)</span>
<a href="#l4.1242"></a><span id="l4.1242">         status += &quot; (\&quot;&quot; + statusText + &quot;\&quot;)&quot;;</span>
<a href="#l4.1243"></a><span id="l4.1243"> </span>
<a href="#l4.1244"></a><span id="l4.1244">       let nameText = aSubject.displayName + &quot; (&quot; + aSubject.userName + &quot;)&quot;;</span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineminus">-      getLogForAccount(aSubject.account).logEvent(nameText + &quot; is now &quot; + status);</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineplus">+      getSystemLogWriter(aSubject.account).logEvent(nameText + &quot; is now &quot; + status);</span>
<a href="#l4.1247"></a><span id="l4.1247">       break;</span>
<a href="#l4.1248"></a><span id="l4.1248">     default:</span>
<a href="#l4.1249"></a><span id="l4.1249">       throw &quot;Unexpected notification &quot; + aTopic;</span>
<a href="#l4.1250"></a><span id="l4.1250">     }</span>
<a href="#l4.1251"></a><span id="l4.1251">   },</span>
<a href="#l4.1252"></a><span id="l4.1252"> </span>
<a href="#l4.1253"></a><span id="l4.1253">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver, Ci.imILogger]),</span>
<a href="#l4.1254"></a><span id="l4.1254">   classDescription: &quot;Logger&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

