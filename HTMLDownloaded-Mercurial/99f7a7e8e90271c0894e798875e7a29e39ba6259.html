<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15414:99f7a7e8e90271c0894e798875e7a29e39ba6259</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 99f7a7e8e90271c0894e798875e7a29e39ba6259" />
<meta property="og:url" content="/comm-central/rev/99f7a7e8e90271c0894e798875e7a29e39ba6259" />
<meta property="og:description" content="Bug 955507 - Add support for setting Buddy Icons, r=clokep." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 99f7a7e8e90271c0894e798875e7a29e39ba6259 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/99f7a7e8e90271c0894e798875e7a29e39ba6259">shortlog</a> |
<a href="/comm-central/log/99f7a7e8e90271c0894e798875e7a29e39ba6259">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/99f7a7e8e90271c0894e798875e7a29e39ba6259">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/99f7a7e8e90271c0894e798875e7a29e39ba6259">files</a> |
changeset |
<a href="/comm-central/raw-rev/99f7a7e8e90271c0894e798875e7a29e39ba6259">raw</a>  | <a href="/comm-central/archive/99f7a7e8e90271c0894e798875e7a29e39ba6259.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955507">Bug 955507</a> - Add support for setting Buddy Icons, r=clokep.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#81;&#117;&#101;&#110;&#116;&#105;&#110;&#32;&#72;&#101;&#97;&#100;&#101;&#110;&#32;&#60;&#113;&#104;&#101;&#97;&#100;&#101;&#110;&#64;&#112;&#104;&#97;&#115;&#101;&#115;&#104;&#105;&#102;&#116;&#115;&#111;&#102;&#116;&#119;&#97;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 14 Aug 2013 09:40:22 -0400</td></tr>

<tr>
 <td>changeset 15414</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/99f7a7e8e90271c0894e798875e7a29e39ba6259">99f7a7e8e90271c0894e798875e7a29e39ba6259</a></td>
</tr>



<tr>
<td>parent 15413</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8634790720e30b81118390f9f82a325d3479a03b">8634790720e30b81118390f9f82a325d3479a03b</a>
</td>
</tr>

<tr>
<td>child 15415</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6af5272212777147baa3a6533b12b8bf49960290">6af5272212777147baa3a6533b12b8bf49960290</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=99f7a7e8e90271c0894e798875e7a29e39ba6259">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955507">955507</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955507">Bug 955507</a> - Add support for setting Buddy Icons, r=clokep.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">chat/locales/en-US/yahoo.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">file</a> |
<a href="/comm-central/annotate/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">annotate</a> |
<a href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">diff</a> |
<a href="/comm-central/comparison/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">comparison</a> |
<a href="/comm-central/log/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/locales/en-US/yahoo.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">chat/protocols/yahoo/yahoo-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">file</a> |
<a href="/comm-central/annotate/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">annotate</a> |
<a href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">diff</a> |
<a href="/comm-central/comparison/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">comparison</a> |
<a href="/comm-central/log/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/99f7a7e8e90271c0894e798875e7a29e39ba6259/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/locales/en-US/yahoo.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/locales/en-US/yahoo.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -13,18 +13,18 @@ network.error.http=HTTP connection error</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> conference.invite.message=Join my conference.</span>
<a href="#l1.6"></a><span id="l1.6"> buddy.invite.message=Would you be my chat buddy?</span>
<a href="#l1.7"></a><span id="l1.7"> buddy.auth.defaultGroup=Contacts</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> # Some options are commented out because they aren't used. We do the same thing</span>
<a href="#l1.10"></a><span id="l1.10"> # to their description strings.</span>
<a href="#l1.11"></a><span id="l1.11"> options.pagerPort=Pager port</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#options.transferHost=File transfer server</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-#options.transferPort=File transfer port</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+options.transferHost=File transfer server</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+options.transferPort=File transfer port</span>
<a href="#l1.16"></a><span id="l1.16"> #options.chatLocale=Chat room locale</span>
<a href="#l1.17"></a><span id="l1.17"> options.chatEncoding=Encoding</span>
<a href="#l1.18"></a><span id="l1.18"> options.ignoreInvites=Ignore conference and chatroom invitations</span>
<a href="#l1.19"></a><span id="l1.19"> #options.proxySSL=Use account proxy for HTTP and HTTPS connections</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> # In this message, %S is replaced with the username of the user who left.</span>
<a href="#l1.22"></a><span id="l1.22"> system.message.conferenceLogoff=%S has left the conference.</span>
<a href="#l1.23"></a><span id="l1.23"> system.message.conferenceLogon=%S has joined the conference.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,32 +1,38 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> const EXPORTED_SYMBOLS = [&quot;YahooSession&quot;];</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+Cu.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> Cu.import(&quot;resource:///modules/ArrayBufferUtils.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> Cu.import(&quot;resource:///modules/http.jsm&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.17"></a><span id="l2.17"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l2.18"></a><span id="l2.18"> Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l2.21"></a><span id="l2.21">   l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l2.22"></a><span id="l2.22"> );</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;imgTools&quot;,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+                                   &quot;@mozilla.org/image/tools;1&quot;, &quot;imgITools&quot;);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+</span>
<a href="#l2.27"></a><span id="l2.27"> const kProtocolVersion = 16;</span>
<a href="#l2.28"></a><span id="l2.28"> const kVendorId = 0;</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> const kPacketDataDelimiter = &quot;\xC0\x80&quot;;</span>
<a href="#l2.31"></a><span id="l2.31"> const kPacketIdentifier = &quot;YMSG&quot;;</span>
<a href="#l2.32"></a><span id="l2.32"> const kPacketHeaderSize = 20;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+const kProfileIconWidth = 96;</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> const kPacketType = {</span>
<a href="#l2.36"></a><span id="l2.36">   // Sent by a client when logging off of the Yahoo! network.</span>
<a href="#l2.37"></a><span id="l2.37">   Logoff:         0x02,</span>
<a href="#l2.38"></a><span id="l2.38">   // Sent by a client when a message is sent to a buddy.</span>
<a href="#l2.39"></a><span id="l2.39">   Message:        0x06,</span>
<a href="#l2.40"></a><span id="l2.40">   // Used for inviting others to a conference.</span>
<a href="#l2.41"></a><span id="l2.41">   ConfInvite:     0x18,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineat">@@ -44,18 +50,22 @@ const kPacketType = {</span>
<a href="#l2.43"></a><span id="l2.43">   // These two are used during initial authentication with the pager server.</span>
<a href="#l2.44"></a><span id="l2.44">   AuthResponse:   0x54,</span>
<a href="#l2.45"></a><span id="l2.45">   Auth:           0x57,</span>
<a href="#l2.46"></a><span id="l2.46">   // Buddy list controls.</span>
<a href="#l2.47"></a><span id="l2.47">   AddBuddy:       0x83,</span>
<a href="#l2.48"></a><span id="l2.48">   RemoveBuddy:    0x84,</span>
<a href="#l2.49"></a><span id="l2.49">   // This is sent when you reject a Yahoo! user's buddy request.</span>
<a href="#l2.50"></a><span id="l2.50">   BuddyReqReject: 0x86,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  // This is sent after a profile picture has been successfully uploaded.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  PictureUpload:  0xc2,</span>
<a href="#l2.53"></a><span id="l2.53">   // This is sent whenever a buddy changes their status.</span>
<a href="#l2.54"></a><span id="l2.54">   StatusUpdate:   0xc6,</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  // This is sent when we update our icon.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  AvatarUpdate:   0xc7,</span>
<a href="#l2.57"></a><span id="l2.57">   // This is sent when someone wishes to become your buddy.</span>
<a href="#l2.58"></a><span id="l2.58">   BuddyAuth:      0xd6,</span>
<a href="#l2.59"></a><span id="l2.59">   // Holds the initial status of all buddies when a user first logs in.</span>
<a href="#l2.60"></a><span id="l2.60">   StatusInitial:  0xf0,</span>
<a href="#l2.61"></a><span id="l2.61">   // Contains the buddy list sent from the server.</span>
<a href="#l2.62"></a><span id="l2.62">   List:           0xf1,</span>
<a href="#l2.63"></a><span id="l2.63">   // Sent back to the pager server after each received message. Sending this</span>
<a href="#l2.64"></a><span id="l2.64">   // prevents echoed messages when chatting with the official Yahoo! client.</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineat">@@ -131,16 +141,19 @@ YahooSession.prototype = {</span>
<a href="#l2.66"></a><span id="l2.66">   _socket: null,</span>
<a href="#l2.67"></a><span id="l2.67">   _username: null,</span>
<a href="#l2.68"></a><span id="l2.68">   // This is the IPv4 address to the pager server which is the gateway into the</span>
<a href="#l2.69"></a><span id="l2.69">   // Yahoo! Messenger network.</span>
<a href="#l2.70"></a><span id="l2.70">   pagerAddress: null,</span>
<a href="#l2.71"></a><span id="l2.71">   // The session ID is obtained during the login process and is maintained</span>
<a href="#l2.72"></a><span id="l2.72">   // throughout the session. This helps the pager server identify the client.</span>
<a href="#l2.73"></a><span id="l2.73">   sessionId: null,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  // The T and Y cookies obtained by the YahooLoginHelper during login.</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  tCookie: null,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  yCookie: null,</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">   // Public methods.</span>
<a href="#l2.79"></a><span id="l2.79">   login: function() {</span>
<a href="#l2.80"></a><span id="l2.80">     this._account.reportConnecting();</span>
<a href="#l2.81"></a><span id="l2.81">     new YahooLoginHelper(this).login(this._account);</span>
<a href="#l2.82"></a><span id="l2.82">   },</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">   addBuddyToServer: function(aBuddy) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -279,16 +292,33 @@ YahooSession.prototype = {</span>
<a href="#l2.86"></a><span id="l2.86">   sendConferenceLogoff: function(aName, aParticipants, aRoom) {</span>
<a href="#l2.87"></a><span id="l2.87">     let packet = new YahooPacket(kPacketType.ConfLogoff, 0, this.sessionId);</span>
<a href="#l2.88"></a><span id="l2.88">     packet.addValue(1, aName);</span>
<a href="#l2.89"></a><span id="l2.89">     packet.addValues(3, aParticipants);</span>
<a href="#l2.90"></a><span id="l2.90">     packet.addValue(57, aRoom);</span>
<a href="#l2.91"></a><span id="l2.91">     this.sendBinaryData(packet.toArrayBuffer());</span>
<a href="#l2.92"></a><span id="l2.92">   },</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  setProfileIcon: function(aFileName) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    // Try to get a handle to the icon file.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    let file = FileUtils.getFile(&quot;ProfD&quot;, [aFileName]);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    let type = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService)</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+                                        .getTypeFromFile(file);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    NetUtil.asyncFetch(file, (function(aStream, aStatus) {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+      if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+        throw &quot;Could not access icon file.&quot;;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+        return;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+      }</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+      let image = imgTools.decodeImage(aStream, type);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+      let uploader = new YahooProfileIconUploader(this._account, this,</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+                                                  aFileName, image);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+      uploader.uploadIcon();</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    }).bind(this));</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  },</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+</span>
<a href="#l2.111"></a><span id="l2.111">   // Callbacks.</span>
<a href="#l2.112"></a><span id="l2.112">   onLoginComplete: function() {</span>
<a href="#l2.113"></a><span id="l2.113">     this._account.reportConnected();</span>
<a href="#l2.114"></a><span id="l2.114">   },</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">   onSessionError: function(aError, aMessage) {</span>
<a href="#l2.117"></a><span id="l2.117">     this._account.reportDisconnecting(aError, aMessage);</span>
<a href="#l2.118"></a><span id="l2.118">     if (this.isConnected)</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineat">@@ -386,21 +416,19 @@ YahooLoginHelper.prototype = {</span>
<a href="#l2.120"></a><span id="l2.120">   // YahooAccount object passed to login().</span>
<a href="#l2.121"></a><span id="l2.121">   _account: null,</span>
<a href="#l2.122"></a><span id="l2.122">   // The username, stripped of any @yahoo.com or @yahoo.co.jp suffix.</span>
<a href="#l2.123"></a><span id="l2.123">   _username: null,</span>
<a href="#l2.124"></a><span id="l2.124">   // The authentication challenge string sent from the Yahoo!'s login server.</span>
<a href="#l2.125"></a><span id="l2.125">   _challengeString: null,</span>
<a href="#l2.126"></a><span id="l2.126">   // The authentication token sent from Yahoo!'s login server.</span>
<a href="#l2.127"></a><span id="l2.127">   _loginToken: null,</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-  // Crumb and cookie strings sent from Yahoo!'s login server, and used in</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-  // the final authentication request to the pager server.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  // Crumb sent from Yahoo!'s login server, and used in the final authentication</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  // request to the pager server.</span>
<a href="#l2.132"></a><span id="l2.132">   _crumb: null,</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  _yCookie: null,</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  _tCookie: null,</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">   // Public methods.</span>
<a href="#l2.137"></a><span id="l2.137">   login: function(aAccount) {</span>
<a href="#l2.138"></a><span id="l2.138">     this._account = aAccount;</span>
<a href="#l2.139"></a><span id="l2.139">     this._getPagerAddress();</span>
<a href="#l2.140"></a><span id="l2.140">   },</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142">   // Private methods.</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineat">@@ -442,18 +470,18 @@ YahooLoginHelper.prototype = {</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145">   _sendPagerAuthResponse: function() {</span>
<a href="#l2.146"></a><span id="l2.146">     let response = this._calculatePagerResponse();</span>
<a href="#l2.147"></a><span id="l2.147">     let packet = new YahooPacket(kPacketType.AuthResponse, 0,</span>
<a href="#l2.148"></a><span id="l2.148">                                  this._session.sessionId);</span>
<a href="#l2.149"></a><span id="l2.149">     // Build the key/value pairs.</span>
<a href="#l2.150"></a><span id="l2.150">     packet.addValue(1, this._account.cleanUsername);</span>
<a href="#l2.151"></a><span id="l2.151">     packet.addValue(0, this._account.cleanUsername);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    packet.addValue(277, this._yCookie);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-    packet.addValue(278, this._tCookie);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    packet.addValue(277, this._session.yCookie);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    packet.addValue(278, this._session.tCookie);</span>
<a href="#l2.156"></a><span id="l2.156">     packet.addValue(307, response);</span>
<a href="#l2.157"></a><span id="l2.157">     packet.addValue(244, this._account.protocol.buildId);</span>
<a href="#l2.158"></a><span id="l2.158">     packet.addValue(2, this._account.cleanUsername);</span>
<a href="#l2.159"></a><span id="l2.159">     packet.addValue(2, &quot;1&quot;);</span>
<a href="#l2.160"></a><span id="l2.160">     packet.addValue(98, &quot;us&quot;);</span>
<a href="#l2.161"></a><span id="l2.161">     this._session.sendBinaryData(packet.toArrayBuffer());</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163">     // We want to handle a final login confirmation packet when the server</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineat">@@ -528,18 +556,20 @@ YahooLoginHelper.prototype = {</span>
<a href="#l2.165"></a><span id="l2.165">     // Status code &quot;0&quot; means success.</span>
<a href="#l2.166"></a><span id="l2.166">     let statusCode = responseParams[0];</span>
<a href="#l2.167"></a><span id="l2.167">     if (statusCode != &quot;0&quot;) {</span>
<a href="#l2.168"></a><span id="l2.168">       this._handleLoginError(statusCode);</span>
<a href="#l2.169"></a><span id="l2.169">       return;</span>
<a href="#l2.170"></a><span id="l2.170">     }</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172">     this._crumb = responseParams[1].replace(&quot;crumb=&quot;, &quot;&quot;);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-    this._yCookie = responseParams[2].substring(2); // Remove the &quot;Y=&quot; bit.</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    this._tCookie = responseParams[3].substring(2); // Remove the &quot;T=&quot; bit.</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    // Remove the &quot;Y=&quot; bit.</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    this._session.yCookie = responseParams[2].substring(2);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    // Remove the &quot;T=&quot; bit.</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    this._session.tCookie = responseParams[3].substring(2);</span>
<a href="#l2.179"></a><span id="l2.179">     this._sendPagerAuthResponse();</span>
<a href="#l2.180"></a><span id="l2.180">   },</span>
<a href="#l2.181"></a><span id="l2.181"> </span>
<a href="#l2.182"></a><span id="l2.182">   // TCP Response Callbacks.</span>
<a href="#l2.183"></a><span id="l2.183">   _onChallengeStringResponse: function(aData) {</span>
<a href="#l2.184"></a><span id="l2.184">     let packet = new YahooPacket();</span>
<a href="#l2.185"></a><span id="l2.185">     packet.fromArrayBuffer(aData);</span>
<a href="#l2.186"></a><span id="l2.186">     // The value of the challenge string is associated with key 94.</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineat">@@ -820,16 +850,30 @@ const YahooPacketHandler = {</span>
<a href="#l2.188"></a><span id="l2.188"> </span>
<a href="#l2.189"></a><span id="l2.189">   // Legacy Yahoo! buddy list. Packet 0xf1 has replaced this.</span>
<a href="#l2.190"></a><span id="l2.190">   0x55: function(aPacket) {},</span>
<a href="#l2.191"></a><span id="l2.191"> </span>
<a href="#l2.192"></a><span id="l2.192">   // Authentication acknowledgement. We can ignore this since we are known</span>
<a href="#l2.193"></a><span id="l2.193">   // to be authenticated if we are receiving other packets anyway.</span>
<a href="#l2.194"></a><span id="l2.194">   0x57: function(aPacket) {},</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  // Picture upload.</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  0xc2: function(aPacket) {</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    let onlineBuddies = this.getOnlineBuddies();</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+    // Send a notification to each online buddy that your icon has changed.</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+    // Those offline will automatically pick up the change when they log in.</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+    for each (let buddy in onlineBuddies) {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+      let packet = new YahooPacket(kPacketType.AvatarUpdate, 0,</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+                                   this._session.sessionId);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+      packet.addValue(3, buddy.userName);</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+      packet.addValue(213, 2); // A value of 2 means we are using an icon.</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+      this._session.sendBinaryData(packet.toArrayBuffer());</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    }</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  },</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+</span>
<a href="#l2.210"></a><span id="l2.210">   // Buddy status update.</span>
<a href="#l2.211"></a><span id="l2.211">   0xc6: function (aPacket) {</span>
<a href="#l2.212"></a><span id="l2.212">     let name = aPacket.getValue(7);</span>
<a href="#l2.213"></a><span id="l2.213">     // Try to grab a status from the well-used buddy statuses. If we can't</span>
<a href="#l2.214"></a><span id="l2.214">     // find it there, try the extra ones.</span>
<a href="#l2.215"></a><span id="l2.215">     let status = kBuddyStatuses[aPacket.getValue(10)];</span>
<a href="#l2.216"></a><span id="l2.216">     let message = &quot;&quot;;</span>
<a href="#l2.217"></a><span id="l2.217">     if (aPacket.hasKey(19))</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineat">@@ -922,8 +966,87 @@ const YahooPacketHandler = {</span>
<a href="#l2.219"></a><span id="l2.219">         tagName = pair.value;</span>
<a href="#l2.220"></a><span id="l2.220">       else if (pair.key == &quot;7&quot;) {</span>
<a href="#l2.221"></a><span id="l2.221">         let buddyName = pair.value;</span>
<a href="#l2.222"></a><span id="l2.222">         this.addBuddyFromServer(Services.tags.createTag(tagName), buddyName);</span>
<a href="#l2.223"></a><span id="l2.223">       }</span>
<a href="#l2.224"></a><span id="l2.224">     }</span>
<a href="#l2.225"></a><span id="l2.225">   }</span>
<a href="#l2.226"></a><span id="l2.226"> };</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+/* The YahooProfileIconUploader class is specifically designed to set a profile</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+ * image on a Yahoo! Messenger account. The reason this functionality is split</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+ * into a separate class is because of the complexity of the operation. Because</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+ * of special protocol requirements, it is easier to use raw TCP communication</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+ * instead of the doXHRequest() method. */</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+function YahooProfileIconUploader(aAccount, aSession, aFileName, aImage)</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+{</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+  this._session = aSession;</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+  this._fileName = aFileName;</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+  this._image = aImage;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+  // To upload our icon to Yahoo!, we must go through their file transfer</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+  // servers. So we access our file transfer server settings.</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+  this._host = this._account.getString(&quot;xfer_host&quot;);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  this._port = this._account.getString(&quot;xfer_port&quot;);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+}</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+YahooProfileIconUploader.prototype = {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+  __proto__: Socket,</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  _account: null,</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+  _session: null,</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+  _fileName: null,</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+  _image: null,</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+  _host: null,</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+  _port: null,</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+  uploadIcon: function() {</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+    // Connect to the file transfer server, and the onConnection callback</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+    // will do the rest.</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+    this.connect(this._host, this._port);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+  },</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+  // Socket callbacks.</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+  onConnection: function() {</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+    // Scale the image down, and make it a PNG. Icon widths are constant, but</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+    // their height varies depending on the aspect ratio of the original image.</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+    let aspectRatio = this._image.width / this._image.height;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+    let scaledHeight = kProfileIconWidth / aspectRatio;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    let scaledImage = imgTools.encodeScaledImage(this._image, &quot;image/png&quot;,</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+                                                 kProfileIconWidth,</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+                                                 scaledHeight);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+    let imageData = NetUtil.readInputStreamToString(scaledImage,</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+                                                    scaledImage.available());</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+    // Build the Yahoo packet.</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+    let packet = new YahooPacket(kPacketType.Picture, 0, this.sessionId);</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+    packet.addValue(1, this._account.cleanUsername);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+    // TODO - Look into how expiration time works for profile icons, and its</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+    // purpose. We aren't sure if this refers to seconds, days, years, etc.</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+    packet.addValue(38, &quot;604800&quot;); // Expiration time.</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+    packet.addValue(0, this._account.cleanUsername);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+    packet.addValue(28, imageData.length); // Picture size in bytes.</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+    packet.addValue(27, this._fileName); // Picture filename.</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+    packet.addValue(14, &quot;&quot;); // Null string.</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+    let packetBuffer = packet.toArrayBuffer();</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+    // Build the request header.</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+    let headers = [</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+      [&quot;User-Agent&quot;, &quot;Mozilla/5.0&quot;],</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+      [&quot;Cookie&quot;, &quot;T=&quot; + this._session.tCookie + &quot;; Y=&quot; + this._session.yCookie],</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+      [&quot;Host&quot;, this._host + &quot;:&quot; + this._port],</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+      [&quot;Content-Length&quot;, packetBuffer.byteLength + 4 + imageData.length],</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+      [&quot;Cache-Control&quot;, &quot;no-cache&quot;],</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+    ];</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+    let headerString = &quot;POST /notifyft HTTP/1.1\r\n&quot;;</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+    headers.forEach(function(header) {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+      headerString += header[0] + &quot;: &quot; + header[1] + &quot;\r\n&quot;;</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+    });</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    // The POST request uses a special delimeter between the end of the included</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    // Yahoo binary packet, and the image data.</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+    let requestPacketEnd = &quot;29&quot; + kPacketDataDelimiter;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+    // Build the complete POST request data.</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+    let requestData = headerString + &quot;\r\n&quot; +</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+                      ArrayBufferToString(packetBuffer) + requestPacketEnd +</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+                      imageData;</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    this.sendData(requestData);</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+  }</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -201,20 +201,20 @@ YahooAccount.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">       this.reportDisconnected();</span>
<a href="#l3.5"></a><span id="l3.5">     }</span>
<a href="#l3.6"></a><span id="l3.6">     // buddy[1] is the actual object.</span>
<a href="#l3.7"></a><span id="l3.7">     for (let buddy of this._buddies)</span>
<a href="#l3.8"></a><span id="l3.8">       buddy[1].setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-      return;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    this._session.setStatus(aSubject.statusType, aData);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    if (aTopic == &quot;status-changed&quot;)</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      this._session.setStatus(aSubject.statusType, aData);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    else if (aTopic == &quot;user-icon-changed&quot;)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+      this._session.setProfileIcon(aData);</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   remove: function() {</span>
<a href="#l3.23"></a><span id="l3.23">     for each(let conv in this._conversations)</span>
<a href="#l3.24"></a><span id="l3.24">       conv.close();</span>
<a href="#l3.25"></a><span id="l3.25">     delete this._conversations;</span>
<a href="#l3.26"></a><span id="l3.26">     for (let buddy of this._buddies)</span>
<a href="#l3.27"></a><span id="l3.27">       buddy[1].removeLocal(); // buddy[1] is the actual object.</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineat">@@ -321,16 +321,25 @@ YahooAccount.prototype = {</span>
<a href="#l3.29"></a><span id="l3.29">   },</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">   getBuddy: function(aName) {</span>
<a href="#l3.32"></a><span id="l3.32">     if (this._buddies.has(aName))</span>
<a href="#l3.33"></a><span id="l3.33">       return this._buddies.get(aName);</span>
<a href="#l3.34"></a><span id="l3.34">     return null;</span>
<a href="#l3.35"></a><span id="l3.35">   },</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  getOnlineBuddies: function() {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    let onlineBuddies = [];</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      if (buddy[1].statusType != Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+        onlineBuddies.push(buddy[1]);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    }</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    return onlineBuddies;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  },</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span>
<a href="#l3.46"></a><span id="l3.46">   receiveMessage: function(aName, aMessage) {</span>
<a href="#l3.47"></a><span id="l3.47">     let conv;</span>
<a href="#l3.48"></a><span id="l3.48">     // Check if we have an existing converstaion open with this user. If not,</span>
<a href="#l3.49"></a><span id="l3.49">     // create one and add it to the list.</span>
<a href="#l3.50"></a><span id="l3.50">     if (!this._conversations.has(aName))</span>
<a href="#l3.51"></a><span id="l3.51">       conv = this.createConversation(aName);</span>
<a href="#l3.52"></a><span id="l3.52">     else</span>
<a href="#l3.53"></a><span id="l3.53">       conv = this._conversations.get(aName);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -412,18 +421,18 @@ YahooProtocol.prototype = {</span>
<a href="#l3.55"></a><span id="l3.55">   loginTokenLoginUrl: &quot;https://login.yahoo.com/config/pwtoken_login&quot;,</span>
<a href="#l3.56"></a><span id="l3.56">   buildId: &quot;4194239&quot;,</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   get id() &quot;prpl-yahoo&quot;,</span>
<a href="#l3.59"></a><span id="l3.59">   get name() &quot;Yahoo&quot;,</span>
<a href="#l3.60"></a><span id="l3.60">   get iconBaseURI() &quot;chrome://prpl-yahoo/skin/&quot;,</span>
<a href="#l3.61"></a><span id="l3.61">   options: {</span>
<a href="#l3.62"></a><span id="l3.62">     port: {get label() _(&quot;options.pagerPort&quot;), default: 5050},</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    //xfer_host: {get label() _(&quot;options.transferHost&quot;), default: &quot;filetransfer.msg.yahoo.com&quot;},</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    //xfer_port: {get label() _(&quot;options.transferPort&quot;), default: 80},</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    xfer_host: {get label() _(&quot;options.transferHost&quot;), default: &quot;filetransfer.msg.yahoo.com&quot;},</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    xfer_port: {get label() _(&quot;options.transferPort&quot;), default: 80},</span>
<a href="#l3.67"></a><span id="l3.67">     //room_list_locale: {get label() _(&quot;options.chatLocale&quot;), default: &quot;us&quot;},</span>
<a href="#l3.68"></a><span id="l3.68">     local_charset: {get label() _(&quot;options.chatEncoding&quot;), default: &quot;UTF-8&quot;},</span>
<a href="#l3.69"></a><span id="l3.69">     ignore_invites: {get label() _(&quot;options.ignoreInvites&quot;), default: false}</span>
<a href="#l3.70"></a><span id="l3.70">     //proxy_ssl: {get label() _(&quot;options.proxySSL&quot;), default: false}</span>
<a href="#l3.71"></a><span id="l3.71">   },</span>
<a href="#l3.72"></a><span id="l3.72">   commands: [</span>
<a href="#l3.73"></a><span id="l3.73">     {</span>
<a href="#l3.74"></a><span id="l3.74">       name: &quot;invite&quot;,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineat">@@ -468,18 +477,18 @@ YahooJapanProtocol.prototype = {</span>
<a href="#l3.76"></a><span id="l3.76">   loginTokenLoginUrl: &quot;https://login.yahoo.co.jp/config/pwtoken_login&quot;,</span>
<a href="#l3.77"></a><span id="l3.77">   buildId: &quot;4186047&quot;,</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">   get id() &quot;prpl-yahoojp&quot;,</span>
<a href="#l3.80"></a><span id="l3.80">   get name() &quot;Yahoo JAPAN&quot;,</span>
<a href="#l3.81"></a><span id="l3.81">   get iconBaseURI() &quot;chrome://prpl-yahoojp/skin/&quot;,</span>
<a href="#l3.82"></a><span id="l3.82">   options: {</span>
<a href="#l3.83"></a><span id="l3.83">     port: {get label() _(&quot;options.pagerPort&quot;), default: 5050},</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    //xfer_host: {get label() _(&quot;options.transferHost&quot;), default: &quot;filetransfer.msg.yahoo.com&quot;},</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    //xfer_port: {get label() _(&quot;options.transferPort&quot;), default: 80},</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    xfer_host: {get label() _(&quot;options.transferHost&quot;), default: &quot;filetransfer.msg.yahoo.com&quot;},</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    xfer_port: {get label() _(&quot;options.transferPort&quot;), default: 80},</span>
<a href="#l3.88"></a><span id="l3.88">     //room_list_locale: {get label() _(&quot;options.chatLocale&quot;), default: &quot;jp&quot;},</span>
<a href="#l3.89"></a><span id="l3.89">     local_charset: {get label() _(&quot;options.chatEncoding&quot;), default: &quot;UTF-8&quot;},</span>
<a href="#l3.90"></a><span id="l3.90">     ignore_invites: {get label() _(&quot;options.ignoreInvites&quot;), default: false}</span>
<a href="#l3.91"></a><span id="l3.91">     //proxy_ssl: {get label() _(&quot;options.proxySSL&quot;), default: false}</span>
<a href="#l3.92"></a><span id="l3.92">   },</span>
<a href="#l3.93"></a><span id="l3.93">   classID: Components.ID(&quot;{5f6dc733-ec0d-4de8-8adc-e4967064ed38}&quot;)</span>
<a href="#l3.94"></a><span id="l3.94"> };</span>
<a href="#l3.95"></a><span id="l3.95"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

