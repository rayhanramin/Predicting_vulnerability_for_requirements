<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26625:9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744" />
<meta property="og:url" content="/comm-central/rev/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/src (part 1). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">shortlog</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">files</a> |
changeset |
<a href="/comm-central/raw-rev/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">raw</a>  | <a href="/comm-central/archive/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 1). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 16 May 2019 13:01:43 +0200</td></tr>

<tr>
 <td>changeset 26625</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744</a></td>
</tr>



<tr>
<td>parent 26624</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7d081913dbc716feb58c7c1bce6b492745955690">7d081913dbc716feb58c7c1bce6b492745955690</a>
</td>
</tr>

<tr>
<td>child 26626</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d05d70ad9d05bde2e19cab53929c98c1d3058fe9">d05d70ad9d05bde2e19cab53929c98c1d3058fe9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744">15926</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 16 May 2019 22:32:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d05d70ad9d05 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d05d70ad9d05bde2e19cab53929c98c1d3058fe9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d05d70ad9d05bde2e19cab53929c98c1d3058fe9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d05d70ad9d05bde2e19cab53929c98c1d3058fe9&newProject=comm-central&newRevision=7d081913dbc716feb58c7c1bce6b492745955690&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d05d70ad9d05bde2e19cab53929c98c1d3058fe9&newProject=comm-central&newRevision=7d081913dbc716feb58c7c1bce6b492745955690&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d05d70ad9d05bde2e19cab53929c98c1d3058fe9&newProject=comm-central&newRevision=7d081913dbc716feb58c7c1bce6b492745955690&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 1). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">mailnews/base/src/MailNewsDLF.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">mailnews/base/src/MailNewsDLF.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailNewsDLF.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">mailnews/base/src/MailnewsLoadContextInfo.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">mailnews/base/src/MailnewsLoadContextInfo.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/MailnewsLoadContextInfo.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">mailnews/base/src/nsCidProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">mailnews/base/src/nsCidProtocolHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCidProtocolHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">mailnews/base/src/nsCopyMessageStreamListener.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">mailnews/base/src/nsCopyMessageStreamListener.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsCopyMessageStreamListener.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">mailnews/base/src/nsMailDirProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">mailnews/base/src/nsMailDirProvider.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirProvider.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">mailnews/base/src/nsMailDirServiceDefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMailDirServiceDefs.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">mailnews/base/src/nsMessenger.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessenger.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">mailnews/base/src/nsMessengerBootstrap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">mailnews/base/src/nsMessengerBootstrap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerBootstrap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">mailnews/base/src/nsMessengerContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">mailnews/base/src/nsMessengerContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">mailnews/base/src/nsMessengerOSXIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">mailnews/base/src/nsMessengerOSXIntegration.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerOSXIntegration.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">mailnews/base/src/nsMessengerUnixIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">mailnews/base/src/nsMessengerUnixIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerUnixIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">mailnews/base/src/nsMessengerWinIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">mailnews/base/src/nsMessengerWinIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">file</a> |
<a href="/comm-central/annotate/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">annotate</a> |
<a href="/comm-central/diff/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">diff</a> |
<a href="/comm-central/comparison/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">comparison</a> |
<a href="/comm-central/log/9ec6e58a9d52e87a0dc3eb8bf5ad247d40efb744/mailnews/base/src/nsMessengerWinIntegration.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/MailNewsDLF.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/MailNewsDLF.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -14,80 +14,71 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> namespace mozilla {</span>
<a href="#l1.9"></a><span id="l1.9"> namespace mailnews {</span>
<a href="#l1.10"></a><span id="l1.10"> NS_IMPL_ISUPPORTS(MailNewsDLF, nsIDocumentLoaderFactory)</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-MailNewsDLF::MailNewsDLF()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-}</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+MailNewsDLF::MailNewsDLF() {}</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-MailNewsDLF::~MailNewsDLF()</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-{</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-}</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+MailNewsDLF::~MailNewsDLF() {}</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> NS_IMETHODIMP</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-MailNewsDLF::CreateInstance(const char* aCommand,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-                            nsIChannel* aChannel,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+MailNewsDLF::CreateInstance(const char* aCommand, nsIChannel* aChannel,</span>
<a href="#l1.26"></a><span id="l1.26">                             nsILoadGroup* aLoadGroup,</span>
<a href="#l1.27"></a><span id="l1.27">                             const nsACString&amp; aContentType,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                            nsIDocShell* aContainer,</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                            nsISupports* aExtraInfo,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                            nsIDocShell* aContainer, nsISupports* aExtraInfo,</span>
<a href="#l1.31"></a><span id="l1.31">                             nsIStreamListener** aDocListener,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                            nsIContentViewer** aDocViewer)</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-{</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                            nsIContentViewer** aDocViewer) {</span>
<a href="#l1.35"></a><span id="l1.35">   nsresult rv;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  bool viewSource = (PL_strstr(PromiseFlatCString(aContentType).get(),</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-                               &quot;view-source&quot;) != 0);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  bool viewSource =</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      (PL_strstr(PromiseFlatCString(aContentType).get(), &quot;view-source&quot;) != 0);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   aChannel-&gt;SetContentType(NS_LITERAL_CSTRING(TEXT_HTML));</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">   // Get the HTML category</span>
<a href="#l1.45"></a><span id="l1.45">   nsCOMPtr&lt;nsICategoryManager&gt; catMan(</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+      do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l1.48"></a><span id="l1.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50">   nsAutoCString contractID;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  rv = catMan-&gt;GetCategoryEntry(&quot;Gecko-Content-Viewers&quot;, TEXT_HTML,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-                                contractID);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  rv = catMan-&gt;GetCategoryEntry(&quot;Gecko-Content-Viewers&quot;, TEXT_HTML, contractID);</span>
<a href="#l1.54"></a><span id="l1.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  nsCOMPtr&lt;nsIDocumentLoaderFactory&gt; factory(do_GetService(contractID.get(),</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-                                             &amp;rv));</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  nsCOMPtr&lt;nsIDocumentLoaderFactory&gt; factory(</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+      do_GetService(contractID.get(), &amp;rv));</span>
<a href="#l1.60"></a><span id="l1.60">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">   nsCOMPtr&lt;nsIStreamListener&gt; listener;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">   if (viewSource) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    rv = factory-&gt;CreateInstance(&quot;view-source&quot;, aChannel, aLoadGroup,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-                                 NS_LITERAL_CSTRING(TEXT_HTML &quot;; x-view-type=view-source&quot;),</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                                 aContainer, aExtraInfo, getter_AddRefs(listener),</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-                                 aDocViewer);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    rv = factory-&gt;CreateInstance(</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        &quot;view-source&quot;, aChannel, aLoadGroup,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        NS_LITERAL_CSTRING(TEXT_HTML &quot;; x-view-type=view-source&quot;), aContainer,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+        aExtraInfo, getter_AddRefs(listener), aDocViewer);</span>
<a href="#l1.73"></a><span id="l1.73">   } else {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    rv = factory-&gt;CreateInstance(&quot;view&quot;, aChannel, aLoadGroup, NS_LITERAL_CSTRING(TEXT_HTML),</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-                                 aContainer, aExtraInfo, getter_AddRefs(listener),</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-                                 aDocViewer);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    rv = factory-&gt;CreateInstance(</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        &quot;view&quot;, aChannel, aLoadGroup, NS_LITERAL_CSTRING(TEXT_HTML), aContainer,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        aExtraInfo, getter_AddRefs(listener), aDocViewer);</span>
<a href="#l1.80"></a><span id="l1.80">   }</span>
<a href="#l1.81"></a><span id="l1.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">   nsCOMPtr&lt;nsIStreamConverterService&gt; scs(</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    do_GetService(NS_STREAMCONVERTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+      do_GetService(NS_STREAMCONVERTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.86"></a><span id="l1.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88">   return scs-&gt;AsyncConvertData(MESSAGE_RFC822, TEXT_HTML, listener, aChannel,</span>
<a href="#l1.89"></a><span id="l1.89">                                aDocListener);</span>
<a href="#l1.90"></a><span id="l1.90"> }</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92"> NS_IMETHODIMP</span>
<a href="#l1.93"></a><span id="l1.93"> MailNewsDLF::CreateInstanceForDocument(nsISupports* aContainer,</span>
<a href="#l1.94"></a><span id="l1.94">                                        mozilla::dom::Document* aDocument,</span>
<a href="#l1.95"></a><span id="l1.95">                                        const char* aCommand,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                                       nsIContentViewer** aDocViewer)</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-{</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+                                       nsIContentViewer** aDocViewer) {</span>
<a href="#l1.99"></a><span id="l1.99">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.100"></a><span id="l1.100"> }</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-}</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-}</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/MailNewsDLF.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/MailNewsDLF.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -13,26 +13,25 @@</span>
<a href="#l2.4"></a><span id="l2.4"> namespace mozilla {</span>
<a href="#l2.5"></a><span id="l2.5"> namespace mailnews {</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /*</span>
<a href="#l2.8"></a><span id="l2.8">  * This factory is a thin wrapper around the text/html loader factory. All it</span>
<a href="#l2.9"></a><span id="l2.9">  * does is convert message/rfc822 to text/html and delegate the rest of the</span>
<a href="#l2.10"></a><span id="l2.10">  * work to the text/html factory.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class MailNewsDLF : public nsIDocumentLoaderFactory</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-public:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+class MailNewsDLF : public nsIDocumentLoaderFactory {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ public:</span>
<a href="#l2.17"></a><span id="l2.17">   MailNewsDLF();</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   NS_DECL_ISUPPORTS</span>
<a href="#l2.20"></a><span id="l2.20">   NS_DECL_NSIDOCUMENTLOADERFACTORY</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-private:</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ private:</span>
<a href="#l2.24"></a><span id="l2.24">   virtual ~MailNewsDLF();</span>
<a href="#l2.25"></a><span id="l2.25"> };</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-}</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-}</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31"> #define MAILNEWSDLF_CATEGORIES \</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  { &quot;Gecko-Content-Viewers&quot;, MESSAGE_RFC822, NS_MAILNEWSDLF_CONTRACTID }, \</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  {&quot;Gecko-Content-Viewers&quot;, MESSAGE_RFC822, NS_MAILNEWSDLF_CONTRACTID},</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/MailnewsLoadContextInfo.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/MailnewsLoadContextInfo.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -11,45 +11,41 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsILoadContext.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> // MailnewsLoadContextInfo</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> NS_IMPL_ISUPPORTS(MailnewsLoadContextInfo, nsILoadContextInfo)</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-MailnewsLoadContextInfo::MailnewsLoadContextInfo(bool aIsPrivate, bool aIsAnonymous, mozilla::OriginAttributes aOriginAttributes)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  : mIsPrivate(aIsPrivate)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  , mIsAnonymous(aIsAnonymous)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  , mOriginAttributes(aOriginAttributes)</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-{</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+MailnewsLoadContextInfo::MailnewsLoadContextInfo(</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    bool aIsPrivate, bool aIsAnonymous,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    mozilla::OriginAttributes aOriginAttributes)</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    : mIsPrivate(aIsPrivate),</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+      mIsAnonymous(aIsAnonymous),</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      mOriginAttributes(aOriginAttributes) {</span>
<a href="#l3.23"></a><span id="l3.23">   mOriginAttributes.SyncAttributesWithPrivateBrowsing(mIsPrivate);</span>
<a href="#l3.24"></a><span id="l3.24"> }</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-MailnewsLoadContextInfo::~MailnewsLoadContextInfo()</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-{</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-}</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+MailnewsLoadContextInfo::~MailnewsLoadContextInfo() {}</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-NS_IMETHODIMP MailnewsLoadContextInfo::GetIsPrivate(bool *aIsPrivate)</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-{</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+NS_IMETHODIMP MailnewsLoadContextInfo::GetIsPrivate(bool *aIsPrivate) {</span>
<a href="#l3.34"></a><span id="l3.34">   *aIsPrivate = mIsPrivate;</span>
<a href="#l3.35"></a><span id="l3.35">   return NS_OK;</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-NS_IMETHODIMP MailnewsLoadContextInfo::GetIsAnonymous(bool *aIsAnonymous)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-{</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+NS_IMETHODIMP MailnewsLoadContextInfo::GetIsAnonymous(bool *aIsAnonymous) {</span>
<a href="#l3.41"></a><span id="l3.41">   *aIsAnonymous = mIsAnonymous;</span>
<a href="#l3.42"></a><span id="l3.42">   return NS_OK;</span>
<a href="#l3.43"></a><span id="l3.43"> }</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-mozilla::OriginAttributes const* MailnewsLoadContextInfo::OriginAttributesPtr()</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-{</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+mozilla::OriginAttributes const *</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+MailnewsLoadContextInfo::OriginAttributesPtr() {</span>
<a href="#l3.49"></a><span id="l3.49">   return &amp;mOriginAttributes;</span>
<a href="#l3.50"></a><span id="l3.50"> }</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-NS_IMETHODIMP MailnewsLoadContextInfo::GetOriginAttributes(JSContext *aCx,</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-                                                   JS::MutableHandle&lt;JS::Value&gt; aVal)</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-{</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+NS_IMETHODIMP MailnewsLoadContextInfo::GetOriginAttributes(</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    JSContext *aCx, JS::MutableHandle&lt;JS::Value&gt; aVal) {</span>
<a href="#l3.57"></a><span id="l3.57">   if (NS_WARN_IF(!ToJSValue(aCx, mOriginAttributes, aVal))) {</span>
<a href="#l3.58"></a><span id="l3.58">     return NS_ERROR_FAILURE;</span>
<a href="#l3.59"></a><span id="l3.59">   }</span>
<a href="#l3.60"></a><span id="l3.60">   return NS_OK;</span>
<a href="#l3.61"></a><span id="l3.61"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/MailnewsLoadContextInfo.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/MailnewsLoadContextInfo.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -7,26 +7,26 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #ifndef MailnewsLoadContextInfo_h__</span>
<a href="#l4.5"></a><span id="l4.5"> #define MailnewsLoadContextInfo_h__</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsILoadContextInfo.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> class nsIChannel;</span>
<a href="#l4.10"></a><span id="l4.10"> class nsILoadContext;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-class MailnewsLoadContextInfo : public nsILoadContextInfo</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-public:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+class MailnewsLoadContextInfo : public nsILoadContextInfo {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ public:</span>
<a href="#l4.17"></a><span id="l4.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.18"></a><span id="l4.18">   NS_DECL_NSILOADCONTEXTINFO</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  MailnewsLoadContextInfo(bool aIsPrivate, bool aIsAnonymous, mozilla::OriginAttributes aOriginAttributes);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  MailnewsLoadContextInfo(bool aIsPrivate, bool aIsAnonymous,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                          mozilla::OriginAttributes aOriginAttributes);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-private:</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ private:</span>
<a href="#l4.26"></a><span id="l4.26">   virtual ~MailnewsLoadContextInfo();</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-protected:</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ protected:</span>
<a href="#l4.30"></a><span id="l4.30">   bool mIsPrivate : 1;</span>
<a href="#l4.31"></a><span id="l4.31">   bool mIsAnonymous : 1;</span>
<a href="#l4.32"></a><span id="l4.32">   mozilla::OriginAttributes mOriginAttributes;</span>
<a href="#l4.33"></a><span id="l4.33"> };</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsCidProtocolHandler.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsCidProtocolHandler.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5,62 +5,54 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsCidProtocolHandler.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsString.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIURI.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsCidProtocolHandler::nsCidProtocolHandler()</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-}</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+nsCidProtocolHandler::nsCidProtocolHandler() {}</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-nsCidProtocolHandler::~nsCidProtocolHandler()</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-{</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-}</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+nsCidProtocolHandler::~nsCidProtocolHandler() {}</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22"> NS_IMPL_ISUPPORTS(nsCidProtocolHandler, nsIProtocolHandler)</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-NS_IMETHODIMP nsCidProtocolHandler::GetScheme(nsACString &amp; aScheme)</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-{</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+NS_IMETHODIMP nsCidProtocolHandler::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l5.27"></a><span id="l5.27">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.28"></a><span id="l5.28"> }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-NS_IMETHODIMP nsCidProtocolHandler::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-{</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+NS_IMETHODIMP nsCidProtocolHandler::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l5.33"></a><span id="l5.33">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.34"></a><span id="l5.34"> }</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-NS_IMETHODIMP nsCidProtocolHandler::GetProtocolFlags(uint32_t *aProtocolFlags)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-{</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+NS_IMETHODIMP nsCidProtocolHandler::GetProtocolFlags(uint32_t *aProtocolFlags) {</span>
<a href="#l5.39"></a><span id="l5.39">   // XXXbz so why does this protocol handler exist, exactly?</span>
<a href="#l5.40"></a><span id="l5.40">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.41"></a><span id="l5.41"> }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-NS_IMETHODIMP nsCidProtocolHandler::NewURI(const nsACString &amp; aSpec, const char *aOriginCharset, nsIURI *aBaseURI, nsIURI **_retval)</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-{</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+NS_IMETHODIMP nsCidProtocolHandler::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+                                           const char *aOriginCharset,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+                                           nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l5.48"></a><span id="l5.48">   // the right fix is to use the baseSpec (or aBaseUri)</span>
<a href="#l5.49"></a><span id="l5.49">   // and specify the cid, and then fix mime</span>
<a href="#l5.50"></a><span id="l5.50">   // to handle that, like it does with &quot;...&amp;part=1.2&quot;</span>
<a href="#l5.51"></a><span id="l5.51">   // for now, do about blank to prevent spam</span>
<a href="#l5.52"></a><span id="l5.52">   // from popping up annoying alerts about not implementing the cid</span>
<a href="#l5.53"></a><span id="l5.53">   // protocol</span>
<a href="#l5.54"></a><span id="l5.54">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l5.55"></a><span id="l5.55">   nsresult rv = NS_NewURI(getter_AddRefs(url), &quot;about:blank&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">   url.forget(_retval);</span>
<a href="#l5.60"></a><span id="l5.60">   return NS_OK;</span>
<a href="#l5.61"></a><span id="l5.61"> }</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> NS_IMETHODIMP nsCidProtocolHandler::NewChannel(nsIURI *aURI,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-                                               nsILoadInfo* aLoadInfo,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-                                               nsIChannel **_retval)</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-{</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+                                               nsILoadInfo *aLoadInfo,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+                                               nsIChannel **_retval) {</span>
<a href="#l5.69"></a><span id="l5.69">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.70"></a><span id="l5.70"> }</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-NS_IMETHODIMP nsCidProtocolHandler::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-{</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+NS_IMETHODIMP nsCidProtocolHandler::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+                                              bool *_retval) {</span>
<a href="#l5.76"></a><span id="l5.76">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.77"></a><span id="l5.77"> }</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsCidProtocolHandler.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsCidProtocolHandler.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,21 +4,20 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #ifndef nsCidProtocolHandler_h__</span>
<a href="#l6.7"></a><span id="l6.7"> #define nsCidProtocolHandler_h__</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-class nsCidProtocolHandler : public nsIProtocolHandler</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-public:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+class nsCidProtocolHandler : public nsIProtocolHandler {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ public:</span>
<a href="#l6.17"></a><span id="l6.17">   nsCidProtocolHandler();</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   NS_DECL_ISUPPORTS</span>
<a href="#l6.20"></a><span id="l6.20">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-private:</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ private:</span>
<a href="#l6.24"></a><span id="l6.24">   virtual ~nsCidProtocolHandler();</span>
<a href="#l6.25"></a><span id="l6.25"> };</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> #endif /* nsCidProtocolHandler_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -9,151 +9,138 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;netCore.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> NS_IMPL_ISUPPORTS(nsCopyMessageStreamListener, nsIStreamListener,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  nsIRequestObserver, nsICopyMessageStreamListener)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                  nsIRequestObserver, nsICopyMessageStreamListener)</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-static nsresult GetMessage(nsIURI *aURL, nsIMsgDBHdr **message)</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-{</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+static nsresult GetMessage(nsIURI *aURL, nsIMsgDBHdr **message) {</span>
<a href="#l7.18"></a><span id="l7.18">   NS_ENSURE_ARG_POINTER(message);</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; uriURL;</span>
<a href="#l7.21"></a><span id="l7.21">   nsresult rv;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  //Need to get message we are about to copy</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  // Need to get message we are about to copy</span>
<a href="#l7.25"></a><span id="l7.25">   uriURL = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  if(NS_FAILED(rv))</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    return rv;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   // get the uri.  first try and use the original message spec</span>
<a href="#l7.31"></a><span id="l7.31">   // if that fails, use the spec of nsIURI that we're called with</span>
<a href="#l7.32"></a><span id="l7.32">   nsCString uri;</span>
<a href="#l7.33"></a><span id="l7.33">   rv = uriURL-&gt;GetOriginalSpec(getter_Copies(uri));</span>
<a href="#l7.34"></a><span id="l7.34">   if (NS_FAILED(rv) || uri.IsEmpty()) {</span>
<a href="#l7.35"></a><span id="l7.35">     rv = uriURL-&gt;GetUri(getter_Copies(uri));</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.38"></a><span id="l7.38">   }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l7.42"></a><span id="l7.42">   rv = GetMessageServiceFromURI(uri, getter_AddRefs(msgMessageService));</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  if (!msgMessageService)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  if (!msgMessageService) return NS_ERROR_FAILURE;</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">   rv = msgMessageService-&gt;MessageURIToMsgHdr(uri.get(), message);</span>
<a href="#l7.50"></a><span id="l7.50">   return rv;</span>
<a href="#l7.51"></a><span id="l7.51"> }</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-nsCopyMessageStreamListener::nsCopyMessageStreamListener()</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-{</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+nsCopyMessageStreamListener::nsCopyMessageStreamListener() {}</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+nsCopyMessageStreamListener::~nsCopyMessageStreamListener() {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  // All member variables are nsCOMPtr's.</span>
<a href="#l7.59"></a><span id="l7.59"> }</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-nsCopyMessageStreamListener::~nsCopyMessageStreamListener()</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-{</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  //All member variables are nsCOMPtr's.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-}</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::Init(nsIMsgFolder *srcFolder, nsICopyMessageListener *destination, nsISupports *listenerData)</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-{</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::Init(</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    nsIMsgFolder *srcFolder, nsICopyMessageListener *destination,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    nsISupports *listenerData) {</span>
<a href="#l7.71"></a><span id="l7.71">   mSrcFolder = srcFolder;</span>
<a href="#l7.72"></a><span id="l7.72">   mDestination = destination;</span>
<a href="#l7.73"></a><span id="l7.73">   mListenerData = listenerData;</span>
<a href="#l7.74"></a><span id="l7.74">   return NS_OK;</span>
<a href="#l7.75"></a><span id="l7.75"> }</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::StartMessage()</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-{</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  if (mDestination)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    mDestination-&gt;StartMessage();</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::StartMessage() {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  if (mDestination) mDestination-&gt;StartMessage();</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84">   return NS_OK;</span>
<a href="#l7.85"></a><span id="l7.85"> }</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::EndMessage(nsMsgKey key)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-{</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-  if (mDestination)</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    mDestination-&gt;EndMessage(key);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::EndMessage(nsMsgKey key) {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  if (mDestination) mDestination-&gt;EndMessage(key);</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">   return NS_OK;</span>
<a href="#l7.95"></a><span id="l7.95"> }</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::OnDataAvailable(nsIRequest * /* request */, nsIInputStream *aIStream, uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-{</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::OnDataAvailable(</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    nsIRequest * /* request */, nsIInputStream *aIStream, uint64_t sourceOffset,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    uint32_t aLength) {</span>
<a href="#l7.103"></a><span id="l7.103">   nsresult rv;</span>
<a href="#l7.104"></a><span id="l7.104">   rv = mDestination-&gt;CopyData(aIStream, aLength);</span>
<a href="#l7.105"></a><span id="l7.105">   return rv;</span>
<a href="#l7.106"></a><span id="l7.106"> }</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::OnStartRequest(nsIRequest * request)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-{</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::OnStartRequest(nsIRequest *request) {</span>
<a href="#l7.111"></a><span id="l7.111">   nsCOMPtr&lt;nsIMsgDBHdr&gt; message;</span>
<a href="#l7.112"></a><span id="l7.112">   nsresult rv = NS_OK;</span>
<a href="#l7.113"></a><span id="l7.113">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">   // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l7.116"></a><span id="l7.116">   // probably bad form. See Bug 1528662.</span>
<a href="#l7.117"></a><span id="l7.117">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-    rv = GetMessage(uri, getter_AddRefs(message));</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-    rv = mDestination-&gt;BeginCopy(message);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+                       &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = GetMessage(uri, getter_AddRefs(message));</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = mDestination-&gt;BeginCopy(message);</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.132"></a><span id="l7.132">   return rv;</span>
<a href="#l7.133"></a><span id="l7.133"> }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::EndCopy(nsISupports *url, nsresult aStatus)</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-{</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::EndCopy(nsISupports *url,</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+                                                   nsresult aStatus) {</span>
<a href="#l7.139"></a><span id="l7.139">   nsresult rv;</span>
<a href="#l7.140"></a><span id="l7.140">   nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(url, &amp;rv);</span>
<a href="#l7.141"></a><span id="l7.141"> </span>
<a href="#l7.142"></a><span id="l7.142">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.143"></a><span id="l7.143">   bool copySucceeded = (aStatus == NS_BINDING_SUCCEEDED);</span>
<a href="#l7.144"></a><span id="l7.144">   rv = mDestination-&gt;EndCopy(copySucceeded);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-  //If this is a move and we finished the copy, delete the old message.</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  // If this is a move and we finished the copy, delete the old message.</span>
<a href="#l7.147"></a><span id="l7.147">   bool moveMessage = false;</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailURL(do_QueryInterface(uri));</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  if (mailURL)</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    rv = mailURL-&gt;IsUrlType(nsIMsgMailNewsUrl::eMove, &amp;moveMessage);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  if (mailURL) rv = mailURL-&gt;IsUrlType(nsIMsgMailNewsUrl::eMove, &amp;moveMessage);</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    moveMessage = false;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  if (NS_FAILED(rv)) moveMessage = false;</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-  // OK, this is wrong if we're moving to an imap folder, for example. This really says that</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  // we were able to pull the message from the source, NOT that we were able to</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-  // put it in the destination!</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-  if (moveMessage)</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-  {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-    // don't do this if we're moving to an imap folder - that's handled elsewhere.</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+  // OK, this is wrong if we're moving to an imap folder, for example. This</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  // really says that we were able to pull the message from the source, NOT that</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  // we were able to put it in the destination!</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  if (moveMessage) {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    // don't do this if we're moving to an imap folder - that's handled</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    // elsewhere.</span>
<a href="#l7.170"></a><span id="l7.170">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; destImap = do_QueryInterface(mDestination);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-      // if the destination is a local folder, it will handle the delete from the source in EndMove</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    if (!destImap)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-      rv = mDestination-&gt;EndMove(copySucceeded);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    // if the destination is a local folder, it will handle the delete from the</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    // source in EndMove</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    if (!destImap) rv = mDestination-&gt;EndMove(copySucceeded);</span>
<a href="#l7.177"></a><span id="l7.177">   }</span>
<a href="#l7.178"></a><span id="l7.178">   // Even if the above actions failed we probably still want to return NS_OK.</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  // There should probably be some error dialog if either the copy or delete failed.</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  // There should probably be some error dialog if either the copy or delete</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  // failed.</span>
<a href="#l7.182"></a><span id="l7.182">   return NS_OK;</span>
<a href="#l7.183"></a><span id="l7.183"> }</span>
<a href="#l7.184"></a><span id="l7.184"> </span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-NS_IMETHODIMP nsCopyMessageStreamListener::OnStopRequest(nsIRequest* request, nsresult aStatus)</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-{</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+NS_IMETHODIMP nsCopyMessageStreamListener::OnStopRequest(nsIRequest *request,</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+                                                         nsresult aStatus) {</span>
<a href="#l7.189"></a><span id="l7.189">   nsresult rv;</span>
<a href="#l7.190"></a><span id="l7.190">   // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l7.191"></a><span id="l7.191">   // probably bad form. See Bug 1528662.</span>
<a href="#l7.192"></a><span id="l7.192">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+                       &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l7.196"></a><span id="l7.196">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.197"></a><span id="l7.197">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l7.198"></a><span id="l7.198">   rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l7.199"></a><span id="l7.199">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.200"></a><span id="l7.200">   return EndCopy(uri, aStatus);</span>
<a href="#l7.201"></a><span id="l7.201"> }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsCopyMessageStreamListener.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsCopyMessageStreamListener.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -8,28 +8,27 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsICopyMessageListener.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIURI.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsCopyMessageStreamListener : public nsIStreamListener, public nsICopyMessageStreamListener {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+class nsCopyMessageStreamListener : public nsIStreamListener,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                                    public nsICopyMessageStreamListener {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ public:</span>
<a href="#l8.18"></a><span id="l8.18">   nsCopyMessageStreamListener();</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.21"></a><span id="l8.21">   NS_DECL_NSICOPYMESSAGESTREAMLISTENER</span>
<a href="#l8.22"></a><span id="l8.22">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l8.23"></a><span id="l8.23">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-protected:</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ protected:</span>
<a href="#l8.27"></a><span id="l8.27">   virtual ~nsCopyMessageStreamListener();</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   nsCOMPtr&lt;nsICopyMessageListener&gt; mDestination;</span>
<a href="#l8.30"></a><span id="l8.30">   nsCOMPtr&lt;nsISupports&gt; mListenerData;</span>
<a href="#l8.31"></a><span id="l8.31">   nsCOMPtr&lt;nsIMsgFolder&gt; mSrcFolder;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33"> };</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -13,191 +13,174 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIChromeRegistry.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsICategoryManager.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#define MAIL_DIR_50_NAME             &quot;Mail&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-#define IMAP_MAIL_DIR_50_NAME        &quot;ImapMail&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-#define NEWS_DIR_50_NAME             &quot;News&quot;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+#define MAIL_DIR_50_NAME &quot;Mail&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+#define IMAP_MAIL_DIR_50_NAME &quot;ImapMail&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+#define NEWS_DIR_50_NAME &quot;News&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #define MSG_FOLDER_CACHE_DIR_50_NAME &quot;panacea.dat&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-nsresult</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-nsMailDirProvider::EnsureDirectory(nsIFile *aDirectory)</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-{</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+nsresult nsMailDirProvider::EnsureDirectory(nsIFile *aDirectory) {</span>
<a href="#l9.24"></a><span id="l9.24">   bool exists;</span>
<a href="#l9.25"></a><span id="l9.25">   nsresult rv = aDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l9.26"></a><span id="l9.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  if (!exists)</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    rv = aDirectory-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  if (!exists) rv = aDirectory-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">   return rv;</span>
<a href="#l9.33"></a><span id="l9.33"> }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMailDirProvider,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-                   nsIDirectoryServiceProvider,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-                   nsIDirectoryServiceProvider2)</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMailDirProvider, nsIDirectoryServiceProvider,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                  nsIDirectoryServiceProvider2)</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41"> NS_IMETHODIMP</span>
<a href="#l9.42"></a><span id="l9.42"> nsMailDirProvider::GetFile(const char *aKey, bool *aPersist,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-                           nsIFile **aResult)</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-{</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+                           nsIFile **aResult) {</span>
<a href="#l9.46"></a><span id="l9.46">   // NOTE: This function can be reentrant through the NS_GetSpecialDirectory</span>
<a href="#l9.47"></a><span id="l9.47">   // call, so be careful not to cause infinite recursion.</span>
<a href="#l9.48"></a><span id="l9.48">   // i.e. the check for supported files must come first.</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  const char* leafName = nullptr;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  const char *leafName = nullptr;</span>
<a href="#l9.51"></a><span id="l9.51">   bool isDirectory = true;</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   if (!strcmp(aKey, NS_APP_MAIL_50_DIR))</span>
<a href="#l9.54"></a><span id="l9.54">     leafName = MAIL_DIR_50_NAME;</span>
<a href="#l9.55"></a><span id="l9.55">   else if (!strcmp(aKey, NS_APP_IMAP_MAIL_50_DIR))</span>
<a href="#l9.56"></a><span id="l9.56">     leafName = IMAP_MAIL_DIR_50_NAME;</span>
<a href="#l9.57"></a><span id="l9.57">   else if (!strcmp(aKey, NS_APP_NEWS_50_DIR))</span>
<a href="#l9.58"></a><span id="l9.58">     leafName = NEWS_DIR_50_NAME;</span>
<a href="#l9.59"></a><span id="l9.59">   else if (!strcmp(aKey, NS_APP_MESSENGER_FOLDER_CACHE_50_FILE)) {</span>
<a href="#l9.60"></a><span id="l9.60">     isDirectory = false;</span>
<a href="#l9.61"></a><span id="l9.61">     leafName = MSG_FOLDER_CACHE_DIR_50_NAME;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  else</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  } else</span>
<a href="#l9.65"></a><span id="l9.65">     return NS_ERROR_FAILURE;</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67">   nsCOMPtr&lt;nsIFile&gt; parentDir;</span>
<a href="#l9.68"></a><span id="l9.68">   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l9.69"></a><span id="l9.69">                                        getter_AddRefs(parentDir));</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    return rv;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l9.75"></a><span id="l9.75">   rv = parentDir-&gt;Clone(getter_AddRefs(file));</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    return rv;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   nsDependentCString leafStr(leafName);</span>
<a href="#l9.81"></a><span id="l9.81">   rv = file-&gt;AppendNative(leafStr);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-    return rv;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86">   bool exists;</span>
<a href="#l9.87"></a><span id="l9.87">   if (isDirectory &amp;&amp; NS_SUCCEEDED(file-&gt;Exists(&amp;exists)) &amp;&amp; !exists)</span>
<a href="#l9.88"></a><span id="l9.88">     rv = EnsureDirectory(file);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">   *aPersist = true;</span>
<a href="#l9.91"></a><span id="l9.91">   file.forget(aResult);</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   return rv;</span>
<a href="#l9.94"></a><span id="l9.94"> }</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96"> NS_IMETHODIMP</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-nsMailDirProvider::GetFiles(const char *aKey,</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-                            nsISimpleEnumerator **aResult)</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-{</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-  if (strcmp(aKey, ISP_DIRECTORY_LIST) != 0)</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+nsMailDirProvider::GetFiles(const char *aKey, nsISimpleEnumerator **aResult) {</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  if (strcmp(aKey, ISP_DIRECTORY_LIST) != 0) return NS_ERROR_FAILURE;</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105">   // The list of isp directories includes the isp directory</span>
<a href="#l9.106"></a><span id="l9.106">   // in the current process dir (i.e. &lt;path to thunderbird.exe&gt;\isp and</span>
<a href="#l9.107"></a><span id="l9.107">   // &lt;path to thunderbird.exe&gt;\isp\locale</span>
<a href="#l9.108"></a><span id="l9.108">   // and isp and isp\locale for each active extension</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">   nsCOMPtr&lt;nsIProperties&gt; dirSvc =</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-  if (!dirSvc)</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+      do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID);</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  if (!dirSvc) return NS_ERROR_FAILURE;</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117">   nsCOMPtr&lt;nsIFile&gt; currentProcessDir;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  nsresult rv = dirSvc-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-                   NS_GET_IID(nsIFile), getter_AddRefs(currentProcessDir));</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  nsresult rv = dirSvc-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+                            getter_AddRefs(currentProcessDir));</span>
<a href="#l9.122"></a><span id="l9.122">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.123"></a><span id="l9.123"> </span>
<a href="#l9.124"></a><span id="l9.124">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-  rv = NS_NewSingletonEnumerator(getter_AddRefs(directoryEnumerator), currentProcessDir);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+  rv = NS_NewSingletonEnumerator(getter_AddRefs(directoryEnumerator),</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+                                 currentProcessDir);</span>
<a href="#l9.128"></a><span id="l9.128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">   nsCOMPtr&lt;nsISimpleEnumerator&gt; combinedEnumerator;</span>
<a href="#l9.131"></a><span id="l9.131">   nsCOMPtr&lt;nsISimpleEnumerator&gt; extensionsEnum;</span>
<a href="#l9.132"></a><span id="l9.132"> </span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-  // xpcshell-tests don't have XRE_EXTENSIONS_DIR_LIST, so accept a null return here.</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-  dirSvc-&gt;Get(XRE_EXTENSIONS_DIR_LIST,</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-              NS_GET_IID(nsISimpleEnumerator),</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  // xpcshell-tests don't have XRE_EXTENSIONS_DIR_LIST, so accept a null return</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  // here.</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+  dirSvc-&gt;Get(XRE_EXTENSIONS_DIR_LIST, NS_GET_IID(nsISimpleEnumerator),</span>
<a href="#l9.139"></a><span id="l9.139">               getter_AddRefs(extensionsEnum));</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  rv = NS_NewUnionEnumerator(getter_AddRefs(combinedEnumerator), directoryEnumerator, extensionsEnum);</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  rv = NS_NewUnionEnumerator(getter_AddRefs(combinedEnumerator),</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+                             directoryEnumerator, extensionsEnum);</span>
<a href="#l9.144"></a><span id="l9.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.145"></a><span id="l9.145"> </span>
<a href="#l9.146"></a><span id="l9.146">   NS_ADDREF(*aResult = new AppendingEnumerator(combinedEnumerator));</span>
<a href="#l9.147"></a><span id="l9.147">   return NS_SUCCESS_AGGREGATE_RESULT;</span>
<a href="#l9.148"></a><span id="l9.148"> }</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150"> NS_IMETHODIMP</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-nsMailDirProvider::AppendingEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-{</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+nsMailDirProvider::AppendingEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l9.154"></a><span id="l9.154">   *aResult = mNext || mNextWithLocale ? true : false;</span>
<a href="#l9.155"></a><span id="l9.155">   return NS_OK;</span>
<a href="#l9.156"></a><span id="l9.156"> }</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158"> NS_IMETHODIMP</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-nsMailDirProvider::AppendingEnumerator::GetNext(nsISupports* *aResult)</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-{</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+nsMailDirProvider::AppendingEnumerator::GetNext(nsISupports **aResult) {</span>
<a href="#l9.162"></a><span id="l9.162">   // Set the return value to the next directory we want to enumerate over</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-  if (aResult)</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-    NS_ADDREF(*aResult = mNext);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  if (aResult) NS_ADDREF(*aResult = mNext);</span>
<a href="#l9.166"></a><span id="l9.166"> </span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-  if (mNextWithLocale)</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-  {</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  if (mNextWithLocale) {</span>
<a href="#l9.170"></a><span id="l9.170">     mNext = mNextWithLocale;</span>
<a href="#l9.171"></a><span id="l9.171">     mNextWithLocale = nullptr;</span>
<a href="#l9.172"></a><span id="l9.172">     return NS_OK;</span>
<a href="#l9.173"></a><span id="l9.173">   }</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175">   mNext = nullptr;</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177">   // Ignore all errors</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179">   bool more;</span>
<a href="#l9.180"></a><span id="l9.180">   while (NS_SUCCEEDED(mBase-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l9.181"></a><span id="l9.181">     nsCOMPtr&lt;nsISupports&gt; nextbasesupp;</span>
<a href="#l9.182"></a><span id="l9.182">     mBase-&gt;GetNext(getter_AddRefs(nextbasesupp));</span>
<a href="#l9.183"></a><span id="l9.183"> </span>
<a href="#l9.184"></a><span id="l9.184">     nsCOMPtr&lt;nsIFile&gt; nextbase(do_QueryInterface(nextbasesupp));</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-    if (!nextbase)</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-      continue;</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+    if (!nextbase) continue;</span>
<a href="#l9.188"></a><span id="l9.188"> </span>
<a href="#l9.189"></a><span id="l9.189">     nextbase-&gt;Clone(getter_AddRefs(mNext));</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    if (!mNext)</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-      continue;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+    if (!mNext) continue;</span>
<a href="#l9.193"></a><span id="l9.193"> </span>
<a href="#l9.194"></a><span id="l9.194">     mNext-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;isp&quot;));</span>
<a href="#l9.195"></a><span id="l9.195">     bool exists;</span>
<a href="#l9.196"></a><span id="l9.196">     nsresult rv = mNext-&gt;Exists(&amp;exists);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-    {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-      if (!mLocale.IsEmpty())</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-      {</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+      if (!mLocale.IsEmpty()) {</span>
<a href="#l9.203"></a><span id="l9.203">         mNext-&gt;Clone(getter_AddRefs(mNextWithLocale));</span>
<a href="#l9.204"></a><span id="l9.204">         mNextWithLocale-&gt;AppendNative(mLocale);</span>
<a href="#l9.205"></a><span id="l9.205">         rv = mNextWithLocale-&gt;Exists(&amp;exists);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-        if (NS_FAILED(rv) || !exists)</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-          mNextWithLocale = nullptr; // clear out mNextWithLocale, so we don't try to iterate over it</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+        if (NS_FAILED(rv) || !exists) {</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+          // Clear out mNextWithLocale, so we don't try to iterate over it.</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+          mNextWithLocale = nullptr;</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+        }</span>
<a href="#l9.212"></a><span id="l9.212">       }</span>
<a href="#l9.213"></a><span id="l9.213">       break;</span>
<a href="#l9.214"></a><span id="l9.214">     }</span>
<a href="#l9.215"></a><span id="l9.215"> </span>
<a href="#l9.216"></a><span id="l9.216">     mNext = nullptr;</span>
<a href="#l9.217"></a><span id="l9.217">   }</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219">   return NS_OK;</span>
<a href="#l9.220"></a><span id="l9.220"> }</span>
<a href="#l9.221"></a><span id="l9.221"> </span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-nsMailDirProvider::AppendingEnumerator::AppendingEnumerator</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-    (nsISimpleEnumerator* aBase) :</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-  mBase(aBase)</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-{</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+nsMailDirProvider::AppendingEnumerator::AppendingEnumerator(</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+    nsISimpleEnumerator *aBase)</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+    : mBase(aBase) {</span>
<a href="#l9.229"></a><span id="l9.229">   nsCOMPtr&lt;nsIXULChromeRegistry&gt; packageRegistry =</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-    mozilla::services::GetXULChromeRegistryService();</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+      mozilla::services::GetXULChromeRegistryService();</span>
<a href="#l9.232"></a><span id="l9.232">   if (packageRegistry)</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-    packageRegistry-&gt;GetSelectedLocale(NS_LITERAL_CSTRING(&quot;global&quot;), false, mLocale);</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+    packageRegistry-&gt;GetSelectedLocale(NS_LITERAL_CSTRING(&quot;global&quot;), false,</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+                                       mLocale);</span>
<a href="#l9.236"></a><span id="l9.236">   // Initialize mNext to begin</span>
<a href="#l9.237"></a><span id="l9.237">   GetNext(nullptr);</span>
<a href="#l9.238"></a><span id="l9.238"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirProvider.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirProvider.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -7,43 +7,37 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #define nsMailDirProvider_h__</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIDirectoryService.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsString.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-class nsMailDirProvider final : public nsIDirectoryServiceProvider2</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+class nsMailDirProvider final : public nsIDirectoryServiceProvider2 {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ public:</span>
<a href="#l10.17"></a><span id="l10.17">   NS_DECL_ISUPPORTS</span>
<a href="#l10.18"></a><span id="l10.18">   NS_DECL_NSIDIRECTORYSERVICEPROVIDER</span>
<a href="#l10.19"></a><span id="l10.19">   NS_DECL_NSIDIRECTORYSERVICEPROVIDER2</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-private:</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ private:</span>
<a href="#l10.23"></a><span id="l10.23">   ~nsMailDirProvider() {}</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-  nsresult EnsureDirectory(nsIFile *aDirectory);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  nsresult EnsureDirectory(nsIFile* aDirectory);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  class AppendingEnumerator final : public nsSimpleEnumerator</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  public:</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-      return NS_GET_IID(nsIFile);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    }</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  class AppendingEnumerator final : public nsSimpleEnumerator {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+   public:</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    const nsID&amp; DefaultInterface() override { return NS_GET_IID(nsIFile); }</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">     NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">     explicit AppendingEnumerator(nsISimpleEnumerator* aBase);</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  private:</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+   private:</span>
<a href="#l10.46"></a><span id="l10.46">     ~AppendingEnumerator() override = default;</span>
<a href="#l10.47"></a><span id="l10.47">     nsCOMPtr&lt;nsISimpleEnumerator&gt; mBase;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt;             mNext;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt;             mNextWithLocale;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    nsCString                     mLocale;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; mNext;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; mNextWithLocale;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    nsCString mLocale;</span>
<a href="#l10.54"></a><span id="l10.54">   };</span>
<a href="#l10.55"></a><span id="l10.55"> };</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-#endif // nsMailDirProvider_h__</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+#endif  // nsMailDirProvider_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirServiceDefs.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirServiceDefs.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9"> #ifndef nsMailDirectoryServiceDefs_h___</span>
<a href="#l11.10"></a><span id="l11.10"> #define nsMailDirectoryServiceDefs_h___</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12"> //=============================================================================</span>
<a href="#l11.13"></a><span id="l11.13"> //</span>
<a href="#l11.14"></a><span id="l11.14"> // Defines property names for directories available from the mail-specific</span>
<a href="#l11.15"></a><span id="l11.15"> // nsMailDirProvider.</span>
<a href="#l11.16"></a><span id="l11.16"> //</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineat">@@ -15,17 +14,17 @@</span>
<a href="#l11.18"></a><span id="l11.18"> // General application properties are defined in nsAppDirectoryServiceDefs.h.</span>
<a href="#l11.19"></a><span id="l11.19"> //</span>
<a href="#l11.20"></a><span id="l11.20"> //=============================================================================</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> // ----------------------------------------------------------------------------</span>
<a href="#l11.23"></a><span id="l11.23"> // Files and directories that exist on a per-profile basis.</span>
<a href="#l11.24"></a><span id="l11.24"> // ----------------------------------------------------------------------------</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-#define NS_APP_MAIL_50_DIR                      &quot;MailD&quot;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-#define NS_APP_IMAP_MAIL_50_DIR                 &quot;IMapMD&quot;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-#define NS_APP_NEWS_50_DIR                      &quot;NewsD&quot;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+#define NS_APP_MAIL_50_DIR &quot;MailD&quot;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+#define NS_APP_IMAP_MAIL_50_DIR &quot;IMapMD&quot;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+#define NS_APP_NEWS_50_DIR &quot;NewsD&quot;</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-#define NS_APP_MESSENGER_FOLDER_CACHE_50_FILE   &quot;MFCaF&quot;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+#define NS_APP_MESSENGER_FOLDER_CACHE_50_FILE &quot;MFCaF&quot;</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-#define ISP_DIRECTORY_LIST                 &quot;ISPDL&quot;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+#define ISP_DIRECTORY_LIST &quot;ISPDL&quot;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -31,18 +31,18 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMIMEInfo.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> // gecko</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIContentViewer.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> // embedding</span>
<a href="#l12.11"></a><span id="l12.11"> #ifdef NS_PRINTING</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsIWebBrowserPrint.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-#include &quot;nsMsgPrintEngine.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+#  include &quot;nsIWebBrowserPrint.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+#  include &quot;nsMsgPrintEngine.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #endif</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> /* for access to docshell */</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsPIDOMWindow.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l12.22"></a><span id="l12.22"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l12.23"></a><span id="l12.23"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -86,154 +86,148 @@</span>
<a href="#l12.25"></a><span id="l12.25"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l12.26"></a><span id="l12.26"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l12.27"></a><span id="l12.27"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l12.28"></a><span id="l12.28"> #include &quot;nsITransfer.h&quot;</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> #include &quot;nsILinkHandler.h&quot;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32"> #define MESSENGER_SAVE_DIR_PREF_NAME &quot;messenger.save.dir&quot;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-#define MIMETYPE_DELETED    &quot;text/x-moz-deleted&quot;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+#define MIMETYPE_DELETED &quot;text/x-moz-deleted&quot;</span>
<a href="#l12.35"></a><span id="l12.35"> #define ATTACHMENT_PERMISSION 00664</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37"> //</span>
<a href="#l12.38"></a><span id="l12.38"> // Convert an nsString buffer to plain text...</span>
<a href="#l12.39"></a><span id="l12.39"> //</span>
<a href="#l12.40"></a><span id="l12.40"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l12.41"></a><span id="l12.41"> #include &quot;nsCharsetSource.h&quot;</span>
<a href="#l12.42"></a><span id="l12.42"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l12.43"></a><span id="l12.43"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l12.44"></a><span id="l12.44"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l12.45"></a><span id="l12.45"> </span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-static void ConvertAndSanitizeFileName(const char * displayName, nsString&amp; aResult)</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-{</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+static void ConvertAndSanitizeFileName(const char *displayName,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+                                       nsString &amp;aResult) {</span>
<a href="#l12.50"></a><span id="l12.50">   nsCString unescapedName;</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">   /* we need to convert the UTF-8 fileName to platform specific character set.</span>
<a href="#l12.53"></a><span id="l12.53">      The display name is in UTF-8 because it has been escaped from JS</span>
<a href="#l12.54"></a><span id="l12.54">   */</span>
<a href="#l12.55"></a><span id="l12.55">   MsgUnescapeString(nsDependentCString(displayName), 0, unescapedName);</span>
<a href="#l12.56"></a><span id="l12.56">   CopyUTF8toUTF16(unescapedName, aResult);</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  // replace platform specific path separator and illegale characters to avoid any confusion</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  // replace platform specific path separator and illegale characters to avoid</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  // any confusion</span>
<a href="#l12.61"></a><span id="l12.61">   MsgReplaceChar(aResult, FILE_PATH_SEPARATOR FILE_ILLEGAL_CHARACTERS, '-');</span>
<a href="#l12.62"></a><span id="l12.62"> }</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64"> // ***************************************************</span>
<a href="#l12.65"></a><span id="l12.65"> // jefft - this is a rather obscured class serves for Save Message As File,</span>
<a href="#l12.66"></a><span id="l12.66"> // Save Message As Template, and Save Attachment to a file</span>
<a href="#l12.67"></a><span id="l12.67"> //</span>
<a href="#l12.68"></a><span id="l12.68"> class nsSaveAllAttachmentsState;</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70"> class nsSaveMsgListener : public nsIUrlListener,</span>
<a href="#l12.71"></a><span id="l12.71">                           public nsIMsgCopyServiceListener,</span>
<a href="#l12.72"></a><span id="l12.72">                           public nsIStreamListener,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-                          public nsICancelable</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-{</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+                          public nsICancelable {</span>
<a href="#l12.76"></a><span id="l12.76">   using PathChar = mozilla::filesystem::Path::value_type;</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-public:</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  nsSaveMsgListener(nsIFile *file, nsMessenger *aMessenger, nsIUrlListener *aListener);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+ public:</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  nsSaveMsgListener(nsIFile *file, nsMessenger *aMessenger,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+                    nsIUrlListener *aListener);</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84">   NS_DECL_ISUPPORTS</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">   NS_DECL_NSIURLLISTENER</span>
<a href="#l12.87"></a><span id="l12.87">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l12.88"></a><span id="l12.88">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l12.89"></a><span id="l12.89">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l12.90"></a><span id="l12.90">   NS_DECL_NSICANCELABLE</span>
<a href="#l12.91"></a><span id="l12.91"> </span>
<a href="#l12.92"></a><span id="l12.92">   nsCOMPtr&lt;nsIFile&gt; m_file;</span>
<a href="#l12.93"></a><span id="l12.93">   nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l12.94"></a><span id="l12.94">   char m_dataBuffer[FILE_IO_BUFFER_SIZE];</span>
<a href="#l12.95"></a><span id="l12.95">   nsCOMPtr&lt;nsIChannel&gt; m_channel;</span>
<a href="#l12.96"></a><span id="l12.96">   nsCString m_templateUri;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-  nsMessenger *m_messenger; // not ref counted</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  nsMessenger *m_messenger;  // not ref counted</span>
<a href="#l12.99"></a><span id="l12.99">   nsSaveAllAttachmentsState *m_saveAllAttachmentsState;</span>
<a href="#l12.100"></a><span id="l12.100"> </span>
<a href="#l12.101"></a><span id="l12.101">   // rhp: For character set handling</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-  bool          m_doCharsetConversion;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  nsString      m_charset;</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  enum {</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    eUnknown,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-    ePlainText,</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    eHTML</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-  }             m_outputFormat;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-  nsCString     m_msgBuffer;</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  nsCString     m_contentType;    // used only when saving attachment</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  bool m_doCharsetConversion;</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  nsString m_charset;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  enum { eUnknown, ePlainText, eHTML } m_outputFormat;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  nsCString m_msgBuffer;</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  nsCString m_contentType;  // used only when saving attachment</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">   nsCOMPtr&lt;nsITransfer&gt; mTransfer;</span>
<a href="#l12.120"></a><span id="l12.120">   nsCOMPtr&lt;nsIUrlListener&gt; mListener;</span>
<a href="#l12.121"></a><span id="l12.121">   nsCOMPtr&lt;nsIURI&gt; mListenerUri;</span>
<a href="#l12.122"></a><span id="l12.122">   int64_t mProgress;</span>
<a href="#l12.123"></a><span id="l12.123">   int64_t mMaxProgress;</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  bool    mCanceled;</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-  bool    mInitialized;</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-  bool    mUrlHasStopped;</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-  bool    mRequestHasStopped;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-  nsresult InitializeDownload(nsIRequest * aRequest);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-private:</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  bool mCanceled;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+  bool mInitialized;</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  bool mUrlHasStopped;</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  bool mRequestHasStopped;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  nsresult InitializeDownload(nsIRequest *aRequest);</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+ private:</span>
<a href="#l12.138"></a><span id="l12.138">   virtual ~nsSaveMsgListener();</span>
<a href="#l12.139"></a><span id="l12.139"> };</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-class nsSaveAllAttachmentsState</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-{</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+class nsSaveAllAttachmentsState {</span>
<a href="#l12.144"></a><span id="l12.144">   using PathChar = mozilla::filesystem::Path::value_type;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-public:</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  nsSaveAllAttachmentsState(uint32_t count,</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-                            const char **contentTypeArray,</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+ public:</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  nsSaveAllAttachmentsState(uint32_t count, const char **contentTypeArray,</span>
<a href="#l12.151"></a><span id="l12.151">                             const char **urlArray,</span>
<a href="#l12.152"></a><span id="l12.152">                             const char **displayNameArray,</span>
<a href="#l12.153"></a><span id="l12.153">                             const char **messageUriArray,</span>
<a href="#l12.154"></a><span id="l12.154">                             const PathChar *directoryName,</span>
<a href="#l12.155"></a><span id="l12.155">                             bool detachingAttachments);</span>
<a href="#l12.156"></a><span id="l12.156">   virtual ~nsSaveAllAttachmentsState();</span>
<a href="#l12.157"></a><span id="l12.157"> </span>
<a href="#l12.158"></a><span id="l12.158">   uint32_t m_count;</span>
<a href="#l12.159"></a><span id="l12.159">   uint32_t m_curIndex;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-  PathChar* m_directoryName;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-  char** m_contentTypeArray;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-  char** m_urlArray;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-  char** m_displayNameArray;</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-  char** m_messageUriArray;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+  PathChar *m_directoryName;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  char **m_contentTypeArray;</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  char **m_urlArray;</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  char **m_displayNameArray;</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  char **m_messageUriArray;</span>
<a href="#l12.170"></a><span id="l12.170">   bool m_detachingAttachments;</span>
<a href="#l12.171"></a><span id="l12.171"> </span>
<a href="#l12.172"></a><span id="l12.172">   // if detaching, do without warning? Will create unique files instead of</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-  //  prompting if duplicate files exist.</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  // prompting if duplicate files exist.</span>
<a href="#l12.175"></a><span id="l12.175">   bool m_withoutWarning;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-  nsTArray&lt;nsCString&gt; m_savedFiles; // if detaching first, remember where we saved to.</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  // if detaching first, remember where we saved to.</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_savedFiles;</span>
<a href="#l12.179"></a><span id="l12.179"> };</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181"> //</span>
<a href="#l12.182"></a><span id="l12.182"> // nsMessenger</span>
<a href="#l12.183"></a><span id="l12.183"> //</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-nsMessenger::nsMessenger()</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-{</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  mCurHistoryPos = -2; // first message selected goes at position 0.</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+nsMessenger::nsMessenger() {</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  mCurHistoryPos = -2;  // first message selected goes at position 0.</span>
<a href="#l12.189"></a><span id="l12.189">   //  InitializeFolderRoot();</span>
<a href="#l12.190"></a><span id="l12.190"> }</span>
<a href="#l12.191"></a><span id="l12.191"> </span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-nsMessenger::~nsMessenger()</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-{</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-}</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMessenger, nsIMessenger, nsISupportsWeakReference, nsIFolderListener)</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-NS_IMETHODIMP nsMessenger::SetWindow(mozIDOMWindowProxy *aWin, nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-{</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+nsMessenger::~nsMessenger() {}</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMessenger, nsIMessenger, nsISupportsWeakReference,</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                  nsIFolderListener)</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+NS_IMETHODIMP nsMessenger::SetWindow(mozIDOMWindowProxy *aWin,</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+                                     nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.208"></a><span id="l12.208">   nsresult rv;</span>
<a href="#l12.209"></a><span id="l12.209"> </span>
<a href="#l12.210"></a><span id="l12.210">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l12.213"></a><span id="l12.213">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.214"></a><span id="l12.214"> </span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-  if (aWin)</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-  {</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+  if (aWin) {</span>
<a href="#l12.218"></a><span id="l12.218">     mMsgWindow = aMsgWindow;</span>
<a href="#l12.219"></a><span id="l12.219">     mWindow = aWin;</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221">     rv = mailSession-&gt;AddFolderListener(this, nsIFolderListener::removed);</span>
<a href="#l12.222"></a><span id="l12.222">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.223"></a><span id="l12.223"> </span>
<a href="#l12.224"></a><span id="l12.224">     NS_ENSURE_TRUE(aWin, NS_ERROR_FAILURE);</span>
<a href="#l12.225"></a><span id="l12.225">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = nsPIDOMWindowOuter::From(aWin);</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineat">@@ -241,161 +235,148 @@ NS_IMETHODIMP nsMessenger::SetWindow(moz</span>
<a href="#l12.227"></a><span id="l12.227">     nsIDocShell *docShell = win-&gt;GetDocShell();</span>
<a href="#l12.228"></a><span id="l12.228">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(docShell);</span>
<a href="#l12.229"></a><span id="l12.229">     NS_ENSURE_TRUE(docShellAsItem, NS_ERROR_FAILURE);</span>
<a href="#l12.230"></a><span id="l12.230"> </span>
<a href="#l12.231"></a><span id="l12.231">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootDocShellAsItem;</span>
<a href="#l12.232"></a><span id="l12.232">     docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootDocShellAsItem));</span>
<a href="#l12.233"></a><span id="l12.233"> </span>
<a href="#l12.234"></a><span id="l12.234">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; childAsItem;</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-    rv = rootDocShellAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;), true, false,</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-                                               nullptr, nullptr, getter_AddRefs(childAsItem));</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+    rv = rootDocShellAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;),</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+                                               true, false, nullptr, nullptr,</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+                                               getter_AddRefs(childAsItem));</span>
<a href="#l12.240"></a><span id="l12.240"> </span>
<a href="#l12.241"></a><span id="l12.241">     mDocShell = do_QueryInterface(childAsItem);</span>
<a href="#l12.242"></a><span id="l12.242">     if (NS_SUCCEEDED(rv) &amp;&amp; mDocShell) {</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-      mCurrentDisplayCharset = &quot;&quot;; // Important! Clear out mCurrentDisplayCharset so we reset a default charset on mDocshell the next time we try to load something into it.</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      // Important! Clear out mCurrentDisplayCharset so we reset a default</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+      // charset on mDocshell the next time we try to load something into it.</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+      mCurrentDisplayCharset = &quot;&quot;;</span>
<a href="#l12.247"></a><span id="l12.247"> </span>
<a href="#l12.248"></a><span id="l12.248">       if (aMsgWindow)</span>
<a href="#l12.249"></a><span id="l12.249">         aMsgWindow-&gt;GetTransactionManager(getter_AddRefs(mTxnMgr));</span>
<a href="#l12.250"></a><span id="l12.250">     }</span>
<a href="#l12.251"></a><span id="l12.251"> </span>
<a href="#l12.252"></a><span id="l12.252">     // we don't always have a message pane, like in the addressbook</span>
<a href="#l12.253"></a><span id="l12.253">     // so if we don't have a docshell, use the one for the xul window.</span>
<a href="#l12.254"></a><span id="l12.254">     // we do this so OpenURL() will work.</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-    if (!mDocShell)</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-      mDocShell = docShell;</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-  } // if aWin</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  else</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-  {</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+    if (!mDocShell) mDocShell = docShell;</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+  }  // if aWin</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+  else {</span>
<a href="#l12.263"></a><span id="l12.263">     // Remove the folder listener if we added it, i.e. if mWindow is non-null</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-    if (mWindow)</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-    {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+    if (mWindow) {</span>
<a href="#l12.267"></a><span id="l12.267">       rv = mailSession-&gt;RemoveFolderListener(this);</span>
<a href="#l12.268"></a><span id="l12.268">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.269"></a><span id="l12.269">     }</span>
<a href="#l12.270"></a><span id="l12.270"> </span>
<a href="#l12.271"></a><span id="l12.271">     mWindow = nullptr;</span>
<a href="#l12.272"></a><span id="l12.272">   }</span>
<a href="#l12.273"></a><span id="l12.273"> </span>
<a href="#l12.274"></a><span id="l12.274">   return NS_OK;</span>
<a href="#l12.275"></a><span id="l12.275"> }</span>
<a href="#l12.276"></a><span id="l12.276"> </span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-NS_IMETHODIMP nsMessenger::SetDisplayCharset(const nsACString&amp; aCharset)</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineminus">-{</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+NS_IMETHODIMP nsMessenger::SetDisplayCharset(const nsACString &amp;aCharset) {</span>
<a href="#l12.280"></a><span id="l12.280">   // libmime always converts to UTF-8 (both HTML and XML)</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-  if (mDocShell)</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-  {</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+  if (mDocShell) {</span>
<a href="#l12.284"></a><span id="l12.284">     nsCOMPtr&lt;nsIContentViewer&gt; cv;</span>
<a href="#l12.285"></a><span id="l12.285">     mDocShell-&gt;GetContentViewer(getter_AddRefs(cv));</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-    if (cv)</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-    {</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+    if (cv) {</span>
<a href="#l12.289"></a><span id="l12.289">       cv-&gt;SetHintCharacterSet(aCharset);</span>
<a href="#l12.290"></a><span id="l12.290">       cv-&gt;SetHintCharacterSetSource(kCharsetFromChannel);</span>
<a href="#l12.291"></a><span id="l12.291"> </span>
<a href="#l12.292"></a><span id="l12.292">       mCurrentDisplayCharset = aCharset;</span>
<a href="#l12.293"></a><span id="l12.293">     }</span>
<a href="#l12.294"></a><span id="l12.294">   }</span>
<a href="#l12.295"></a><span id="l12.295"> </span>
<a href="#l12.296"></a><span id="l12.296">   return NS_OK;</span>
<a href="#l12.297"></a><span id="l12.297"> }</span>
<a href="#l12.298"></a><span id="l12.298"> </span>
<a href="#l12.299"></a><span id="l12.299"> NS_IMPL_ISUPPORTS(nsMessenger::nsFilePickerShownCallback,</span>
<a href="#l12.300"></a><span id="l12.300">                   nsIFilePickerShownCallback)</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-nsMessenger::nsFilePickerShownCallback::nsFilePickerShownCallback()</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-{</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+nsMessenger::nsFilePickerShownCallback::nsFilePickerShownCallback() {</span>
<a href="#l12.304"></a><span id="l12.304">   mPickerDone = false;</span>
<a href="#l12.305"></a><span id="l12.305"> }</span>
<a href="#l12.306"></a><span id="l12.306"> </span>
<a href="#l12.307"></a><span id="l12.307"> NS_IMETHODIMP</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-nsMessenger::nsFilePickerShownCallback::Done(int16_t aResult)</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-{</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+nsMessenger::nsFilePickerShownCallback::Done(int16_t aResult) {</span>
<a href="#l12.311"></a><span id="l12.311">   mResult = aResult;</span>
<a href="#l12.312"></a><span id="l12.312">   mPickerDone = true;</span>
<a href="#l12.313"></a><span id="l12.313">   return NS_OK;</span>
<a href="#l12.314"></a><span id="l12.314"> }</span>
<a href="#l12.315"></a><span id="l12.315"> </span>
<a href="#l12.316"></a><span id="l12.316" class="difflineminus">-nsresult nsMessenger::ShowPicker(nsIFilePicker *aPicker, int16_t *aResult)</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-{</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+nsresult nsMessenger::ShowPicker(nsIFilePicker *aPicker, int16_t *aResult) {</span>
<a href="#l12.319"></a><span id="l12.319">   nsCOMPtr&lt;nsIFilePickerShownCallback&gt; callback =</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-    new nsMessenger::nsFilePickerShownCallback();</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+      new nsMessenger::nsFilePickerShownCallback();</span>
<a href="#l12.322"></a><span id="l12.322">   nsFilePickerShownCallback *cb =</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-    static_cast&lt;nsFilePickerShownCallback*&gt;(callback.get());</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+      static_cast&lt;nsFilePickerShownCallback *&gt;(callback.get());</span>
<a href="#l12.325"></a><span id="l12.325"> </span>
<a href="#l12.326"></a><span id="l12.326">   nsresult rv;</span>
<a href="#l12.327"></a><span id="l12.327">   rv = aPicker-&gt;Open(callback);</span>
<a href="#l12.328"></a><span id="l12.328">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.329"></a><span id="l12.329"> </span>
<a href="#l12.330"></a><span id="l12.330">   // Spin the event loop until the callback was called.</span>
<a href="#l12.331"></a><span id="l12.331">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l12.332"></a><span id="l12.332">   while (!cb-&gt;mPickerDone) {</span>
<a href="#l12.333"></a><span id="l12.333">     NS_ProcessPendingEvents(thread);</span>
<a href="#l12.334"></a><span id="l12.334">   }</span>
<a href="#l12.335"></a><span id="l12.335"> </span>
<a href="#l12.336"></a><span id="l12.336">   *aResult = cb-&gt;mResult;</span>
<a href="#l12.337"></a><span id="l12.337">   return NS_OK;</span>
<a href="#l12.338"></a><span id="l12.338"> }</span>
<a href="#l12.339"></a><span id="l12.339"> </span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-nsresult</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-nsMessenger::PromptIfFileExists(nsIFile *file)</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineminus">-{</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+nsresult nsMessenger::PromptIfFileExists(nsIFile *file) {</span>
<a href="#l12.344"></a><span id="l12.344">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l12.345"></a><span id="l12.345">   bool exists;</span>
<a href="#l12.346"></a><span id="l12.346">   file-&gt;Exists(&amp;exists);</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineminus">-  if (!exists)</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+  if (!exists) return NS_OK;</span>
<a href="#l12.350"></a><span id="l12.350"> </span>
<a href="#l12.351"></a><span id="l12.351">   nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(mDocShell));</span>
<a href="#l12.352"></a><span id="l12.352">   if (!dialog) return rv;</span>
<a href="#l12.353"></a><span id="l12.353">   nsAutoString path;</span>
<a href="#l12.354"></a><span id="l12.354">   bool dialogResult = false;</span>
<a href="#l12.355"></a><span id="l12.355">   nsString errorMessage;</span>
<a href="#l12.356"></a><span id="l12.356"> </span>
<a href="#l12.357"></a><span id="l12.357">   file-&gt;GetPath(path);</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-  const char16_t *pathFormatStrings[] = { path.get() };</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-  if (!mStringBundle)</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-  {</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+  const char16_t *pathFormatStrings[] = {path.get()};</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+  if (!mStringBundle) {</span>
<a href="#l12.365"></a><span id="l12.365">     rv = InitStringBundle();</span>
<a href="#l12.366"></a><span id="l12.366">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.367"></a><span id="l12.367">   }</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineminus">-  rv = mStringBundle-&gt;FormatStringFromName(&quot;fileExists&quot;,</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-                                           pathFormatStrings, 1,</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+  rv = mStringBundle-&gt;FormatStringFromName(&quot;fileExists&quot;, pathFormatStrings, 1,</span>
<a href="#l12.371"></a><span id="l12.371">                                            errorMessage);</span>
<a href="#l12.372"></a><span id="l12.372">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.373"></a><span id="l12.373">   rv = dialog-&gt;Confirm(nullptr, errorMessage.get(), &amp;dialogResult);</span>
<a href="#l12.374"></a><span id="l12.374">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.375"></a><span id="l12.375"> </span>
<a href="#l12.376"></a><span id="l12.376" class="difflineminus">-  if (dialogResult)</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-    return NS_OK; // user says okay to replace</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+  if (dialogResult) return NS_OK;  // user says okay to replace</span>
<a href="#l12.379"></a><span id="l12.379"> </span>
<a href="#l12.380"></a><span id="l12.380">   // if we don't re-init the path for redisplay the picker will</span>
<a href="#l12.381"></a><span id="l12.381">   // show the full path, not just the file name</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; currentFile = do_CreateInstance(&quot;@mozilla.org/file/local;1&quot;);</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; currentFile =</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/file/local;1&quot;);</span>
<a href="#l12.385"></a><span id="l12.385">   if (!currentFile) return NS_ERROR_FAILURE;</span>
<a href="#l12.386"></a><span id="l12.386"> </span>
<a href="#l12.387"></a><span id="l12.387">   rv = currentFile-&gt;InitWithPath(path);</span>
<a href="#l12.388"></a><span id="l12.388">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.389"></a><span id="l12.389"> </span>
<a href="#l12.390"></a><span id="l12.390">   nsAutoString leafName;</span>
<a href="#l12.391"></a><span id="l12.391">   currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l12.392"></a><span id="l12.392">   if (!leafName.IsEmpty())</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-    path.Assign(leafName); // path should be a copy of leafName</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+    path.Assign(leafName);  // path should be a copy of leafName</span>
<a href="#l12.395"></a><span id="l12.395"> </span>
<a href="#l12.396"></a><span id="l12.396">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.399"></a><span id="l12.399">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.400"></a><span id="l12.400">   nsString saveAttachmentStr;</span>
<a href="#l12.401"></a><span id="l12.401">   GetString(NS_LITERAL_STRING(&quot;SaveAttachment&quot;), saveAttachmentStr);</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineminus">-  filePicker-&gt;Init(mWindow,</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-                   saveAttachmentStr,</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineminus">-                   nsIFilePicker::modeSave);</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+  filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeSave);</span>
<a href="#l12.406"></a><span id="l12.406">   filePicker-&gt;SetDefaultString(path);</span>
<a href="#l12.407"></a><span id="l12.407">   filePicker-&gt;AppendFilters(nsIFilePicker::filterAll);</span>
<a href="#l12.408"></a><span id="l12.408"> </span>
<a href="#l12.409"></a><span id="l12.409" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.411"></a><span id="l12.411">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l12.412"></a><span id="l12.412">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir) {</span>
<a href="#l12.413"></a><span id="l12.413">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l12.414"></a><span id="l12.414">   }</span>
<a href="#l12.415"></a><span id="l12.415"> </span>
<a href="#l12.416"></a><span id="l12.416">   int16_t dialogReturn;</span>
<a href="#l12.417"></a><span id="l12.417">   rv = ShowPicker(filePicker, &amp;dialogReturn);</span>
<a href="#l12.418"></a><span id="l12.418">   if (NS_FAILED(rv) || dialogReturn == nsIFilePicker::returnCancel) {</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineat">@@ -407,637 +388,587 @@ nsMessenger::PromptIfFileExists(nsIFile </span>
<a href="#l12.420"></a><span id="l12.420">   }</span>
<a href="#l12.421"></a><span id="l12.421"> </span>
<a href="#l12.422"></a><span id="l12.422">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l12.423"></a><span id="l12.423"> </span>
<a href="#l12.424"></a><span id="l12.424">   rv = filePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l12.425"></a><span id="l12.425">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.426"></a><span id="l12.426"> </span>
<a href="#l12.427"></a><span id="l12.427">   rv = SetLastSaveDirectory(localFile);</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.430"></a><span id="l12.430"> </span>
<a href="#l12.431"></a><span id="l12.431">   // reset the file to point to the new path</span>
<a href="#l12.432"></a><span id="l12.432">   return file-&gt;InitWithFile(localFile);</span>
<a href="#l12.433"></a><span id="l12.433"> }</span>
<a href="#l12.434"></a><span id="l12.434"> </span>
<a href="#l12.435"></a><span id="l12.435"> NS_IMETHODIMP</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-nsMessenger::AddMsgUrlToNavigateHistory(const nsACString&amp; aURL)</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-{</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+nsMessenger::AddMsgUrlToNavigateHistory(const nsACString &amp;aURL) {</span>
<a href="#l12.439"></a><span id="l12.439">   // mNavigatingToUri is set to a url if we're already doing a back/forward,</span>
<a href="#l12.440"></a><span id="l12.440">   // in which case we don't want to add the url to the history list.</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-  // Or if the entry at the cur history pos is the same as what we're loading, don't</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-  // add it to the list.</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineminus">-  if (!mNavigatingToUri.Equals(aURL) &amp;&amp; (mCurHistoryPos &lt; 0 || !mLoadedMsgHistory[mCurHistoryPos].Equals(aURL)))</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-  {</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+  // Or if the entry at the cur history pos is the same as what we're loading,</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+  // don't add it to the list.</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  if (!mNavigatingToUri.Equals(aURL) &amp;&amp;</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+      (mCurHistoryPos &lt; 0 || !mLoadedMsgHistory[mCurHistoryPos].Equals(aURL))) {</span>
<a href="#l12.449"></a><span id="l12.449">     mNavigatingToUri = aURL;</span>
<a href="#l12.450"></a><span id="l12.450">     nsCString curLoadedFolderUri;</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; curLoadedFolder;</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; curLoadedFolder;</span>
<a href="#l12.453"></a><span id="l12.453"> </span>
<a href="#l12.454"></a><span id="l12.454">     mMsgWindow-&gt;GetOpenFolder(getter_AddRefs(curLoadedFolder));</span>
<a href="#l12.455"></a><span id="l12.455">     // for virtual folders, we want to select the right folder,</span>
<a href="#l12.456"></a><span id="l12.456">     // which isn't the same as the folder specified in the msg uri.</span>
<a href="#l12.457"></a><span id="l12.457">     // So add the uri for the currently loaded folder to the history list.</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-    if (curLoadedFolder)</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-      curLoadedFolder-&gt;GetURI(curLoadedFolderUri);</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+    if (curLoadedFolder) curLoadedFolder-&gt;GetURI(curLoadedFolderUri);</span>
<a href="#l12.461"></a><span id="l12.461"> </span>
<a href="#l12.462"></a><span id="l12.462">     mLoadedMsgHistory.InsertElementAt(mCurHistoryPos++ + 2, mNavigatingToUri);</span>
<a href="#l12.463"></a><span id="l12.463">     mLoadedMsgHistory.InsertElementAt(mCurHistoryPos++ + 2, curLoadedFolderUri);</span>
<a href="#l12.464"></a><span id="l12.464">     // we may want to prune this history if it gets large, but I think it's</span>
<a href="#l12.465"></a><span id="l12.465">     // more interesting to prune the back and forward menu.</span>
<a href="#l12.466"></a><span id="l12.466">   }</span>
<a href="#l12.467"></a><span id="l12.467">   return NS_OK;</span>
<a href="#l12.468"></a><span id="l12.468"> }</span>
<a href="#l12.469"></a><span id="l12.469"> </span>
<a href="#l12.470"></a><span id="l12.470"> NS_IMETHODIMP</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineminus">-nsMessenger::OpenURL(const nsACString&amp; aURL)</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineminus">-{</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+nsMessenger::OpenURL(const nsACString &amp;aURL) {</span>
<a href="#l12.474"></a><span id="l12.474">   // This is to setup the display DocShell as UTF-8 capable...</span>
<a href="#l12.475"></a><span id="l12.475">   SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l12.476"></a><span id="l12.476"> </span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.479"></a><span id="l12.479">   nsresult rv = GetMessageServiceFromURI(aURL, getter_AddRefs(messageService));</span>
<a href="#l12.480"></a><span id="l12.480"> </span>
<a href="#l12.481"></a><span id="l12.481" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; messageService)</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineminus">-  {</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l12.484"></a><span id="l12.484">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.485"></a><span id="l12.485">     messageService-&gt;DisplayMessage(PromiseFlatCString(aURL).get(), mDocShell,</span>
<a href="#l12.486"></a><span id="l12.486" class="difflineminus">-        mMsgWindow, nullptr, nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l12.487"></a><span id="l12.487" class="difflineplus">+                                   mMsgWindow, nullptr, nullptr,</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineplus">+                                   getter_AddRefs(dummyNull));</span>
<a href="#l12.489"></a><span id="l12.489">     AddMsgUrlToNavigateHistory(aURL);</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineminus">-    mLastDisplayURI = aURL; // remember the last uri we displayed....</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineplus">+    mLastDisplayURI = aURL;  // remember the last uri we displayed....</span>
<a href="#l12.492"></a><span id="l12.492">     return NS_OK;</span>
<a href="#l12.493"></a><span id="l12.493">   }</span>
<a href="#l12.494"></a><span id="l12.494"> </span>
<a href="#l12.495"></a><span id="l12.495">   nsCOMPtr&lt;nsIWebNavigation&gt; webNav(do_QueryInterface(mDocShell));</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineminus">-  if(!webNav)</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineplus">+  if (!webNav) return NS_ERROR_FAILURE;</span>
<a href="#l12.499"></a><span id="l12.499">   mozilla::dom::LoadURIOptions loadURIOptions;</span>
<a href="#l12.500"></a><span id="l12.500">   loadURIOptions.mLoadFlags = nsIWebNavigation::LOAD_FLAGS_IS_LINK;</span>
<a href="#l12.501"></a><span id="l12.501">   loadURIOptions.mTriggeringPrincipal = nsContentUtils::GetSystemPrincipal();</span>
<a href="#l12.502"></a><span id="l12.502">   rv = webNav-&gt;LoadURI(NS_ConvertASCIItoUTF16(aURL), loadURIOptions);</span>
<a href="#l12.503"></a><span id="l12.503">   return rv;</span>
<a href="#l12.504"></a><span id="l12.504"> }</span>
<a href="#l12.505"></a><span id="l12.505"> </span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-NS_IMETHODIMP nsMessenger::LaunchExternalURL(const nsACString&amp; aURL)</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineminus">-{</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineplus">+NS_IMETHODIMP nsMessenger::LaunchExternalURL(const nsACString &amp;aURL) {</span>
<a href="#l12.509"></a><span id="l12.509">   nsresult rv;</span>
<a href="#l12.510"></a><span id="l12.510"> </span>
<a href="#l12.511"></a><span id="l12.511">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l12.512"></a><span id="l12.512">   rv = NS_NewURI(getter_AddRefs(uri), PromiseFlatCString(aURL).get());</span>
<a href="#l12.513"></a><span id="l12.513">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.514"></a><span id="l12.514"> </span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-  nsCOMPtr&lt;nsIExternalProtocolService&gt; extProtService = do_GetService(NS_EXTERNALPROTOCOLSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineplus">+  nsCOMPtr&lt;nsIExternalProtocolService&gt; extProtService =</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineplus">+      do_GetService(NS_EXTERNALPROTOCOLSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.520"></a><span id="l12.520">   return extProtService-&gt;LoadURI(uri, nullptr);</span>
<a href="#l12.521"></a><span id="l12.521"> }</span>
<a href="#l12.522"></a><span id="l12.522"> </span>
<a href="#l12.523"></a><span id="l12.523"> NS_IMETHODIMP</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-nsMessenger::LoadURL(mozIDOMWindowProxy *aWin, const nsACString&amp; aURL)</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-{</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineplus">+nsMessenger::LoadURL(mozIDOMWindowProxy *aWin, const nsACString &amp;aURL) {</span>
<a href="#l12.527"></a><span id="l12.527">   nsresult rv;</span>
<a href="#l12.528"></a><span id="l12.528"> </span>
<a href="#l12.529"></a><span id="l12.529">   SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l12.530"></a><span id="l12.530"> </span>
<a href="#l12.531"></a><span id="l12.531">   NS_ConvertASCIItoUTF16 uriString(aURL);</span>
<a href="#l12.532"></a><span id="l12.532">   // Cleanup the empty spaces that might be on each end.</span>
<a href="#l12.533"></a><span id="l12.533">   uriString.Trim(&quot; &quot;);</span>
<a href="#l12.534"></a><span id="l12.534">   // Eliminate embedded newlines, which single-line text fields now allow:</span>
<a href="#l12.535"></a><span id="l12.535">   uriString.StripChars(&quot;\r\n&quot;);</span>
<a href="#l12.536"></a><span id="l12.536">   NS_ENSURE_TRUE(!uriString.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l12.537"></a><span id="l12.537"> </span>
<a href="#l12.538"></a><span id="l12.538">   bool loadingFromFile = false;</span>
<a href="#l12.539"></a><span id="l12.539">   bool getDummyMsgHdr = false;</span>
<a href="#l12.540"></a><span id="l12.540">   int64_t fileSize;</span>
<a href="#l12.541"></a><span id="l12.541"> </span>
<a href="#l12.542"></a><span id="l12.542" class="difflineminus">-  if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;file:&quot;)))</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-  {</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineplus">+  if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;file:&quot;))) {</span>
<a href="#l12.545"></a><span id="l12.545">     nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l12.546"></a><span id="l12.546">     rv = NS_NewURI(getter_AddRefs(fileUri), uriString);</span>
<a href="#l12.547"></a><span id="l12.547">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineminus">-    nsCOMPtr &lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.550"></a><span id="l12.550">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l12.553"></a><span id="l12.553">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l12.554"></a><span id="l12.554">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.555"></a><span id="l12.555">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l12.556"></a><span id="l12.556">     uriString.Replace(0, 5, NS_LITERAL_STRING(&quot;mailbox:&quot;));</span>
<a href="#l12.557"></a><span id="l12.557">     uriString.AppendLiteral(u&quot;&amp;number=0&quot;);</span>
<a href="#l12.558"></a><span id="l12.558">     loadingFromFile = true;</span>
<a href="#l12.559"></a><span id="l12.559">     getDummyMsgHdr = true;</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineminus">-  }</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-  else if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;mailbox:&quot;)) &amp;&amp;</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineminus">-           (CaseInsensitiveFindInReadable(NS_LITERAL_STRING(&quot;.eml?&quot;), uriString)))</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineminus">-  {</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+  } else if (StringBeginsWith(uriString, NS_LITERAL_STRING(&quot;mailbox:&quot;)) &amp;&amp;</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+             (CaseInsensitiveFindInReadable(NS_LITERAL_STRING(&quot;.eml?&quot;),</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+                                            uriString))) {</span>
<a href="#l12.567"></a><span id="l12.567">     // if we have a mailbox:// url that points to an .eml file, we have to read</span>
<a href="#l12.568"></a><span id="l12.568">     // the file size as well</span>
<a href="#l12.569"></a><span id="l12.569">     uriString.Replace(0, 8, NS_LITERAL_STRING(&quot;file:&quot;));</span>
<a href="#l12.570"></a><span id="l12.570">     nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l12.571"></a><span id="l12.571">     rv = NS_NewURI(getter_AddRefs(fileUri), uriString);</span>
<a href="#l12.572"></a><span id="l12.572">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineminus">-    nsCOMPtr &lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.575"></a><span id="l12.575">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l12.578"></a><span id="l12.578">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l12.579"></a><span id="l12.579">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.580"></a><span id="l12.580">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l12.581"></a><span id="l12.581">     uriString.Replace(0, 5, NS_LITERAL_STRING(&quot;mailbox:&quot;));</span>
<a href="#l12.582"></a><span id="l12.582">     loadingFromFile = true;</span>
<a href="#l12.583"></a><span id="l12.583">     getDummyMsgHdr = true;</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineminus">-  }</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineminus">-  else if (uriString.Find(&quot;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineplus">+  } else if (uriString.Find(&quot;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l12.587"></a><span id="l12.587">     getDummyMsgHdr = true;</span>
<a href="#l12.588"></a><span id="l12.588"> </span>
<a href="#l12.589"></a><span id="l12.589">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l12.590"></a><span id="l12.590">   rv = NS_NewURI(getter_AddRefs(uri), uriString);</span>
<a href="#l12.591"></a><span id="l12.591">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.592"></a><span id="l12.592"> </span>
<a href="#l12.593"></a><span id="l12.593">   NS_ENSURE_TRUE(mDocShell, NS_ERROR_FAILURE);</span>
<a href="#l12.594"></a><span id="l12.594">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl = do_QueryInterface(uri);</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-  if (msgurl)</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineminus">-  {</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+  if (msgurl) {</span>
<a href="#l12.598"></a><span id="l12.598">     msgurl-&gt;SetMsgWindow(mMsgWindow);</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineminus">-    if (loadingFromFile || getDummyMsgHdr)</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineminus">-    {</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineminus">-      if (loadingFromFile)</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineminus">-      {</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineminus">-        nsCOMPtr &lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(msgurl, &amp;rv);</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineminus">-        mailboxUrl-&gt;SetMessageSize((uint32_t) fileSize);</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+    if (loadingFromFile || getDummyMsgHdr) {</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineplus">+      if (loadingFromFile) {</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineplus">+        nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(msgurl, &amp;rv);</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineplus">+        mailboxUrl-&gt;SetMessageSize((uint32_t)fileSize);</span>
<a href="#l12.609"></a><span id="l12.609">       }</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineminus">-      if (getDummyMsgHdr)</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-      {</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineminus">-        nsCOMPtr &lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineminus">-         // need to tell the header sink to capture some headers to create a fake db header</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineminus">-         // so we can do reply to a .eml file or a rfc822 msg attachment.</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+      if (getDummyMsgHdr) {</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineplus">+        nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineplus">+        // need to tell the header sink to capture some headers to create a fake</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineplus">+        // db header so we can do reply to a .eml file or a rfc822 msg</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineplus">+        // attachment.</span>
<a href="#l12.620"></a><span id="l12.620">         mMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineminus">-        if (headerSink)</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineminus">-        {</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; dummyHeader;</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+        if (headerSink) {</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; dummyHeader;</span>
<a href="#l12.626"></a><span id="l12.626">           headerSink-&gt;GetDummyMsgHeader(getter_AddRefs(dummyHeader));</span>
<a href="#l12.627"></a><span id="l12.627">           if (dummyHeader &amp;&amp; loadingFromFile)</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineminus">-            dummyHeader-&gt;SetMessageSize((uint32_t) fileSize);</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineplus">+            dummyHeader-&gt;SetMessageSize((uint32_t)fileSize);</span>
<a href="#l12.630"></a><span id="l12.630">         }</span>
<a href="#l12.631"></a><span id="l12.631">       }</span>
<a href="#l12.632"></a><span id="l12.632">     }</span>
<a href="#l12.633"></a><span id="l12.633">   }</span>
<a href="#l12.634"></a><span id="l12.634"> </span>
<a href="#l12.635"></a><span id="l12.635">   AddMsgUrlToNavigateHistory(aURL);</span>
<a href="#l12.636"></a><span id="l12.636">   mNavigatingToUri.Truncate();</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-  mLastDisplayURI = aURL; // Remember the last uri we displayed.</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineplus">+  mLastDisplayURI = aURL;  // Remember the last uri we displayed.</span>
<a href="#l12.639"></a><span id="l12.639">   RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(uri);</span>
<a href="#l12.640"></a><span id="l12.640">   loadState-&gt;SetLoadFlags(nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l12.641"></a><span id="l12.641">   loadState-&gt;SetFirstParty(true);</span>
<a href="#l12.642"></a><span id="l12.642">   loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l12.643"></a><span id="l12.643">   return mDocShell-&gt;LoadURI(loadState);</span>
<a href="#l12.644"></a><span id="l12.644"> }</span>
<a href="#l12.645"></a><span id="l12.645"> </span>
<a href="#l12.646"></a><span id="l12.646"> NS_IMETHODIMP nsMessenger::SaveAttachmentToFile(nsIFile *aFile,</span>
<a href="#l12.647"></a><span id="l12.647">                                                 const nsACString &amp;aURL,</span>
<a href="#l12.648"></a><span id="l12.648">                                                 const nsACString &amp;aMessageUri,</span>
<a href="#l12.649"></a><span id="l12.649">                                                 const nsACString &amp;aContentType,</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineminus">-                                                nsIUrlListener *aListener)</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineminus">-{</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineminus">-  return SaveAttachment(aFile, aURL, aMessageUri, aContentType, nullptr, aListener);</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineplus">+                                                nsIUrlListener *aListener) {</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineplus">+  return SaveAttachment(aFile, aURL, aMessageUri, aContentType, nullptr,</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineplus">+                        aListener);</span>
<a href="#l12.656"></a><span id="l12.656"> }</span>
<a href="#l12.657"></a><span id="l12.657"> </span>
<a href="#l12.658"></a><span id="l12.658"> NS_IMETHODIMP</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineminus">-nsMessenger::DetachAttachmentsWOPrompts(nsIFile* aDestFolder,</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineminus">-                                        uint32_t aCount,</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineplus">+nsMessenger::DetachAttachmentsWOPrompts(nsIFile *aDestFolder, uint32_t aCount,</span>
<a href="#l12.662"></a><span id="l12.662">                                         const char **aContentTypeArray,</span>
<a href="#l12.663"></a><span id="l12.663">                                         const char **aUrlArray,</span>
<a href="#l12.664"></a><span id="l12.664">                                         const char **aDisplayNameArray,</span>
<a href="#l12.665"></a><span id="l12.665">                                         const char **aMessageUriArray,</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-                                        nsIUrlListener *aListener)</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-{</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+                                        nsIUrlListener *aListener) {</span>
<a href="#l12.669"></a><span id="l12.669">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l12.670"></a><span id="l12.670">   NS_ENSURE_ARG_POINTER(aContentTypeArray);</span>
<a href="#l12.671"></a><span id="l12.671">   NS_ENSURE_ARG_POINTER(aUrlArray);</span>
<a href="#l12.672"></a><span id="l12.672">   NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l12.673"></a><span id="l12.673">   NS_ENSURE_ARG_POINTER(aDisplayNameArray);</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-  if (!aCount)</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineplus">+  if (!aCount) return NS_OK;</span>
<a href="#l12.677"></a><span id="l12.677">   nsSaveAllAttachmentsState *saveState;</span>
<a href="#l12.678"></a><span id="l12.678">   nsCOMPtr&lt;nsIFile&gt; attachmentDestination;</span>
<a href="#l12.679"></a><span id="l12.679">   nsresult rv = aDestFolder-&gt;Clone(getter_AddRefs(attachmentDestination));</span>
<a href="#l12.680"></a><span id="l12.680">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.681"></a><span id="l12.681"> </span>
<a href="#l12.682"></a><span id="l12.682">   PathString path = attachmentDestination-&gt;NativePath();</span>
<a href="#l12.683"></a><span id="l12.683"> </span>
<a href="#l12.684"></a><span id="l12.684">   nsAutoString unescapedFileName;</span>
<a href="#l12.685"></a><span id="l12.685">   ConvertAndSanitizeFileName(aDisplayNameArray[0], unescapedFileName);</span>
<a href="#l12.686"></a><span id="l12.686">   rv = attachmentDestination-&gt;Append(unescapedFileName);</span>
<a href="#l12.687"></a><span id="l12.687">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineminus">-  rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, ATTACHMENT_PERMISSION);</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+  rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+                                           ATTACHMENT_PERMISSION);</span>
<a href="#l12.691"></a><span id="l12.691">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.692"></a><span id="l12.692"> </span>
<a href="#l12.693"></a><span id="l12.693" class="difflineminus">-  saveState = new nsSaveAllAttachmentsState(aCount,</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineminus">-                                            aContentTypeArray,</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineminus">-                                            aUrlArray,</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineminus">-                                            aDisplayNameArray,</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineminus">-                                            aMessageUriArray,</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineminus">-                                            path.get(),</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineminus">-                                            true);</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineplus">+  saveState = new nsSaveAllAttachmentsState(aCount, aContentTypeArray,</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineplus">+                                            aUrlArray, aDisplayNameArray,</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineplus">+                                            aMessageUriArray, path.get(), true);</span>
<a href="#l12.703"></a><span id="l12.703"> </span>
<a href="#l12.704"></a><span id="l12.704">   // This method is used in filters, where we don't want to warn</span>
<a href="#l12.705"></a><span id="l12.705">   saveState-&gt;m_withoutWarning = true;</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-  rv = SaveAttachment(attachmentDestination,</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineminus">-                      nsDependentCString(aUrlArray[0]),</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+  rv = SaveAttachment(attachmentDestination, nsDependentCString(aUrlArray[0]),</span>
<a href="#l12.709"></a><span id="l12.709">                       nsDependentCString(aMessageUriArray[0]),</span>
<a href="#l12.710"></a><span id="l12.710">                       nsDependentCString(aContentTypeArray[0]),</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineminus">-                      (void *)saveState,</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineminus">-                      aListener);</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineplus">+                      (void *)saveState, aListener);</span>
<a href="#l12.714"></a><span id="l12.714">   return rv;</span>
<a href="#l12.715"></a><span id="l12.715"> }</span>
<a href="#l12.716"></a><span id="l12.716"> </span>
<a href="#l12.717"></a><span id="l12.717" class="difflineminus">-nsresult nsMessenger::SaveAttachment(nsIFile *aFile,</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineminus">-                                     const nsACString &amp;aURL,</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineplus">+nsresult nsMessenger::SaveAttachment(nsIFile *aFile, const nsACString &amp;aURL,</span>
<a href="#l12.720"></a><span id="l12.720">                                      const nsACString &amp;aMessageUri,</span>
<a href="#l12.721"></a><span id="l12.721">                                      const nsACString &amp;aContentType,</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineminus">-                                     void *closure,</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineminus">-                                     nsIUrlListener *aListener)</span>
<a href="#l12.724"></a><span id="l12.724" class="difflineminus">-{</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineplus">+                                     void *closure, nsIUrlListener *aListener) {</span>
<a href="#l12.726"></a><span id="l12.726">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineminus">-  nsSaveAllAttachmentsState *saveState= (nsSaveAllAttachmentsState*) closure;</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineplus">+  nsSaveAllAttachmentsState *saveState = (nsSaveAllAttachmentsState *)closure;</span>
<a href="#l12.729"></a><span id="l12.729">   nsCOMPtr&lt;nsIMsgMessageFetchPartService&gt; fetchService;</span>
<a href="#l12.730"></a><span id="l12.730">   nsAutoCString urlString;</span>
<a href="#l12.731"></a><span id="l12.731">   nsAutoCString fullMessageUri(aMessageUri);</span>
<a href="#l12.732"></a><span id="l12.732"> </span>
<a href="#l12.733"></a><span id="l12.733">   // This instance will be held onto by the listeners, and will be released once</span>
<a href="#l12.734"></a><span id="l12.734">   // the transfer has been completed.</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineminus">-  RefPtr&lt;nsSaveMsgListener&gt; saveListener(new nsSaveMsgListener(aFile, this, aListener));</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineplus">+  RefPtr&lt;nsSaveMsgListener&gt; saveListener(</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineplus">+      new nsSaveMsgListener(aFile, this, aListener));</span>
<a href="#l12.738"></a><span id="l12.738"> </span>
<a href="#l12.739"></a><span id="l12.739">   saveListener-&gt;m_contentType = aContentType;</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineminus">-  if (saveState)</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineminus">-  {</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineplus">+  if (saveState) {</span>
<a href="#l12.743"></a><span id="l12.743">     saveListener-&gt;m_saveAllAttachmentsState = saveState;</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineminus">-    if (saveState-&gt;m_detachingAttachments)</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineminus">-    {</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineplus">+    if (saveState-&gt;m_detachingAttachments) {</span>
<a href="#l12.747"></a><span id="l12.747">       nsCOMPtr&lt;nsIURI&gt; outputURI;</span>
<a href="#l12.748"></a><span id="l12.748">       nsresult rv = NS_NewFileURI(getter_AddRefs(outputURI), aFile);</span>
<a href="#l12.749"></a><span id="l12.749">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.750"></a><span id="l12.750">       nsAutoCString fileUriSpec;</span>
<a href="#l12.751"></a><span id="l12.751">       rv = outputURI-&gt;GetSpec(fileUriSpec);</span>
<a href="#l12.752"></a><span id="l12.752">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.753"></a><span id="l12.753">       saveState-&gt;m_savedFiles.AppendElement(fileUriSpec);</span>
<a href="#l12.754"></a><span id="l12.754">     }</span>
<a href="#l12.755"></a><span id="l12.755">   }</span>
<a href="#l12.756"></a><span id="l12.756"> </span>
<a href="#l12.757"></a><span id="l12.757">   urlString = aURL;</span>
<a href="#l12.758"></a><span id="l12.758">   // strip out ?type=application/x-message-display because it confuses libmime</span>
<a href="#l12.759"></a><span id="l12.759"> </span>
<a href="#l12.760"></a><span id="l12.760">   int32_t typeIndex = urlString.Find(&quot;?type=application/x-message-display&quot;);</span>
<a href="#l12.761"></a><span id="l12.761" class="difflineminus">-  if (typeIndex != kNotFound)</span>
<a href="#l12.762"></a><span id="l12.762" class="difflineminus">-  {</span>
<a href="#l12.763"></a><span id="l12.763" class="difflineplus">+  if (typeIndex != kNotFound) {</span>
<a href="#l12.764"></a><span id="l12.764">     urlString.Cut(typeIndex, sizeof(&quot;?type=application/x-message-display&quot;) - 1);</span>
<a href="#l12.765"></a><span id="l12.765">     // we also need to replace the next '&amp;' with '?'</span>
<a href="#l12.766"></a><span id="l12.766">     int32_t firstPartIndex = urlString.FindChar('&amp;');</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineminus">-    if (firstPartIndex != kNotFound)</span>
<a href="#l12.768"></a><span id="l12.768" class="difflineminus">-      urlString.SetCharAt('?', firstPartIndex);</span>
<a href="#l12.769"></a><span id="l12.769" class="difflineplus">+    if (firstPartIndex != kNotFound) urlString.SetCharAt('?', firstPartIndex);</span>
<a href="#l12.770"></a><span id="l12.770">   }</span>
<a href="#l12.771"></a><span id="l12.771"> </span>
<a href="#l12.772"></a><span id="l12.772">   MsgReplaceSubstring(urlString, &quot;/;section&quot;, &quot;?section&quot;);</span>
<a href="#l12.773"></a><span id="l12.773">   nsCOMPtr&lt;nsIURI&gt; URL;</span>
<a href="#l12.774"></a><span id="l12.774">   nsresult rv = NS_NewURI(getter_AddRefs(URL), urlString);</span>
<a href="#l12.775"></a><span id="l12.775"> </span>
<a href="#l12.776"></a><span id="l12.776" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.777"></a><span id="l12.777" class="difflineminus">-  {</span>
<a href="#l12.778"></a><span id="l12.778" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.779"></a><span id="l12.779">     rv = GetMessageServiceFromURI(aMessageUri, getter_AddRefs(messageService));</span>
<a href="#l12.780"></a><span id="l12.780" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.781"></a><span id="l12.781" class="difflineminus">-    {</span>
<a href="#l12.782"></a><span id="l12.782" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.783"></a><span id="l12.783">       fetchService = do_QueryInterface(messageService);</span>
<a href="#l12.784"></a><span id="l12.784" class="difflineminus">-      // if the message service has a fetch part service then we know we can fetch mime parts...</span>
<a href="#l12.785"></a><span id="l12.785" class="difflineminus">-      if (fetchService)</span>
<a href="#l12.786"></a><span id="l12.786" class="difflineminus">-      {</span>
<a href="#l12.787"></a><span id="l12.787" class="difflineplus">+      // if the message service has a fetch part service then we know we can</span>
<a href="#l12.788"></a><span id="l12.788" class="difflineplus">+      // fetch mime parts...</span>
<a href="#l12.789"></a><span id="l12.789" class="difflineplus">+      if (fetchService) {</span>
<a href="#l12.790"></a><span id="l12.790">         int32_t partPos = urlString.FindChar('?');</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineminus">-        if (partPos == kNotFound)</span>
<a href="#l12.792"></a><span id="l12.792" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineplus">+        if (partPos == kNotFound) return NS_ERROR_FAILURE;</span>
<a href="#l12.794"></a><span id="l12.794">         fullMessageUri.Append(Substring(urlString, partPos));</span>
<a href="#l12.795"></a><span id="l12.795">       }</span>
<a href="#l12.796"></a><span id="l12.796"> </span>
<a href="#l12.797"></a><span id="l12.797">       nsCOMPtr&lt;nsIStreamListener&gt; convertedListener;</span>
<a href="#l12.798"></a><span id="l12.798">       saveListener-&gt;QueryInterface(NS_GET_IID(nsIStreamListener),</span>
<a href="#l12.799"></a><span id="l12.799" class="difflineminus">-                                 getter_AddRefs(convertedListener));</span>
<a href="#l12.800"></a><span id="l12.800" class="difflineplus">+                                   getter_AddRefs(convertedListener));</span>
<a href="#l12.801"></a><span id="l12.801"> </span>
<a href="#l12.802"></a><span id="l12.802">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.803"></a><span id="l12.803">       if (fetchService)</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineminus">-        rv = fetchService-&gt;FetchMimePart(URL, fullMessageUri.get(),</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineminus">-                                         convertedListener, mMsgWindow,</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineminus">-                                         saveListener, getter_AddRefs(dummyNull));</span>
<a href="#l12.807"></a><span id="l12.807" class="difflineplus">+        rv = fetchService-&gt;FetchMimePart(</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineplus">+            URL, fullMessageUri.get(), convertedListener, mMsgWindow,</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineplus">+            saveListener, getter_AddRefs(dummyNull));</span>
<a href="#l12.810"></a><span id="l12.810">       else</span>
<a href="#l12.811"></a><span id="l12.811" class="difflineminus">-        rv = messageService-&gt;DisplayMessage(fullMessageUri.get(),</span>
<a href="#l12.812"></a><span id="l12.812" class="difflineminus">-                                            convertedListener, mMsgWindow,</span>
<a href="#l12.813"></a><span id="l12.813" class="difflineminus">-                                            nullptr, nullptr,</span>
<a href="#l12.814"></a><span id="l12.814" class="difflineminus">-                                            getter_AddRefs(dummyNull));</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-    } // if we got a message service</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineminus">-  } // if we created a url</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineminus">-</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.819"></a><span id="l12.819" class="difflineminus">-    Alert(&quot;saveAttachmentFailed&quot;);</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineplus">+        rv = messageService-&gt;DisplayMessage(</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineplus">+            fullMessageUri.get(), convertedListener, mMsgWindow, nullptr,</span>
<a href="#l12.822"></a><span id="l12.822" class="difflineplus">+            nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l12.823"></a><span id="l12.823" class="difflineplus">+    }  // if we got a message service</span>
<a href="#l12.824"></a><span id="l12.824" class="difflineplus">+  }    // if we created a url</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineplus">+</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineplus">+  if (NS_FAILED(rv)) Alert(&quot;saveAttachmentFailed&quot;);</span>
<a href="#l12.827"></a><span id="l12.827"> </span>
<a href="#l12.828"></a><span id="l12.828">   return rv;</span>
<a href="#l12.829"></a><span id="l12.829"> }</span>
<a href="#l12.830"></a><span id="l12.830"> </span>
<a href="#l12.831"></a><span id="l12.831"> NS_IMETHODIMP</span>
<a href="#l12.832"></a><span id="l12.832" class="difflineminus">-nsMessenger::OpenAttachment(const nsACString&amp; aContentType, const nsACString&amp; aURL,</span>
<a href="#l12.833"></a><span id="l12.833" class="difflineminus">-                            const nsACString&amp; aDisplayName, const nsACString&amp; aMessageUri, bool aIsExternalAttachment)</span>
<a href="#l12.834"></a><span id="l12.834" class="difflineminus">-{</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineplus">+nsMessenger::OpenAttachment(const nsACString &amp;aContentType,</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineplus">+                            const nsACString &amp;aURL,</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineplus">+                            const nsACString &amp;aDisplayName,</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineplus">+                            const nsACString &amp;aMessageUri,</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineplus">+                            bool aIsExternalAttachment) {</span>
<a href="#l12.840"></a><span id="l12.840">   nsresult rv = NS_OK;</span>
<a href="#l12.841"></a><span id="l12.841"> </span>
<a href="#l12.842"></a><span id="l12.842" class="difflineminus">-  // open external attachments inside our message pane which in turn should trigger the</span>
<a href="#l12.843"></a><span id="l12.843" class="difflineminus">-  // helper app dialog...</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineplus">+  // open external attachments inside our message pane which in turn should</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineplus">+  // trigger the helper app dialog...</span>
<a href="#l12.846"></a><span id="l12.846">   if (aIsExternalAttachment)</span>
<a href="#l12.847"></a><span id="l12.847">     rv = OpenURL(aURL);</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineminus">-  else</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineminus">-  {</span>
<a href="#l12.850"></a><span id="l12.850" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.851"></a><span id="l12.851" class="difflineplus">+  else {</span>
<a href="#l12.852"></a><span id="l12.852" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.853"></a><span id="l12.853">     rv = GetMessageServiceFromURI(aMessageUri, getter_AddRefs(messageService));</span>
<a href="#l12.854"></a><span id="l12.854">     if (messageService)</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineminus">-      rv = messageService-&gt;OpenAttachment(PromiseFlatCString(aContentType).get(), PromiseFlatCString(aDisplayName).get(),</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineminus">-                                          PromiseFlatCString(aURL).get(), PromiseFlatCString(aMessageUri).get(),</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineminus">-                                          mDocShell, mMsgWindow, nullptr);</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineplus">+      rv = messageService-&gt;OpenAttachment(</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineplus">+          PromiseFlatCString(aContentType).get(),</span>
<a href="#l12.860"></a><span id="l12.860" class="difflineplus">+          PromiseFlatCString(aDisplayName).get(),</span>
<a href="#l12.861"></a><span id="l12.861" class="difflineplus">+          PromiseFlatCString(aURL).get(), PromiseFlatCString(aMessageUri).get(),</span>
<a href="#l12.862"></a><span id="l12.862" class="difflineplus">+          mDocShell, mMsgWindow, nullptr);</span>
<a href="#l12.863"></a><span id="l12.863">   }</span>
<a href="#l12.864"></a><span id="l12.864"> </span>
<a href="#l12.865"></a><span id="l12.865">   return rv;</span>
<a href="#l12.866"></a><span id="l12.866"> }</span>
<a href="#l12.867"></a><span id="l12.867"> </span>
<a href="#l12.868"></a><span id="l12.868"> NS_IMETHODIMP</span>
<a href="#l12.869"></a><span id="l12.869" class="difflineminus">-nsMessenger::SaveAttachmentToFolder(const nsACString&amp; contentType, const nsACString&amp; url, const nsACString&amp; displayName,</span>
<a href="#l12.870"></a><span id="l12.870" class="difflineminus">-                                    const nsACString&amp; messageUri, nsIFile * aDestFolder, nsIFile ** aOutFile)</span>
<a href="#l12.871"></a><span id="l12.871" class="difflineminus">-{</span>
<a href="#l12.872"></a><span id="l12.872" class="difflineplus">+nsMessenger::SaveAttachmentToFolder(const nsACString &amp;contentType,</span>
<a href="#l12.873"></a><span id="l12.873" class="difflineplus">+                                    const nsACString &amp;url,</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineplus">+                                    const nsACString &amp;displayName,</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineplus">+                                    const nsACString &amp;messageUri,</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineplus">+                                    nsIFile *aDestFolder, nsIFile **aOutFile) {</span>
<a href="#l12.877"></a><span id="l12.877">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l12.878"></a><span id="l12.878">   nsresult rv;</span>
<a href="#l12.879"></a><span id="l12.879"> </span>
<a href="#l12.880"></a><span id="l12.880">   nsCOMPtr&lt;nsIFile&gt; attachmentDestination;</span>
<a href="#l12.881"></a><span id="l12.881">   rv = aDestFolder-&gt;Clone(getter_AddRefs(attachmentDestination));</span>
<a href="#l12.882"></a><span id="l12.882">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.883"></a><span id="l12.883"> </span>
<a href="#l12.884"></a><span id="l12.884">   nsString unescapedFileName;</span>
<a href="#l12.885"></a><span id="l12.885" class="difflineminus">-  ConvertAndSanitizeFileName(PromiseFlatCString(displayName).get(), unescapedFileName);</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineplus">+  ConvertAndSanitizeFileName(PromiseFlatCString(displayName).get(),</span>
<a href="#l12.887"></a><span id="l12.887" class="difflineplus">+                             unescapedFileName);</span>
<a href="#l12.888"></a><span id="l12.888">   rv = attachmentDestination-&gt;Append(unescapedFileName);</span>
<a href="#l12.889"></a><span id="l12.889">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.890"></a><span id="l12.890"> #ifdef XP_MACOSX</span>
<a href="#l12.891"></a><span id="l12.891" class="difflineminus">-  rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, ATTACHMENT_PERMISSION);</span>
<a href="#l12.892"></a><span id="l12.892" class="difflineplus">+  rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l12.893"></a><span id="l12.893" class="difflineplus">+                                           ATTACHMENT_PERMISSION);</span>
<a href="#l12.894"></a><span id="l12.894">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.895"></a><span id="l12.895"> #endif</span>
<a href="#l12.896"></a><span id="l12.896"> </span>
<a href="#l12.897"></a><span id="l12.897" class="difflineminus">-  rv = SaveAttachment(attachmentDestination, url, messageUri, contentType, nullptr, nullptr);</span>
<a href="#l12.898"></a><span id="l12.898" class="difflineplus">+  rv = SaveAttachment(attachmentDestination, url, messageUri, contentType,</span>
<a href="#l12.899"></a><span id="l12.899" class="difflineplus">+                      nullptr, nullptr);</span>
<a href="#l12.900"></a><span id="l12.900">   attachmentDestination.forget(aOutFile);</span>
<a href="#l12.901"></a><span id="l12.901">   return rv;</span>
<a href="#l12.902"></a><span id="l12.902"> }</span>
<a href="#l12.903"></a><span id="l12.903"> </span>
<a href="#l12.904"></a><span id="l12.904"> NS_IMETHODIMP</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineminus">-nsMessenger::SaveAttachment(const nsACString&amp; aContentType, const nsACString&amp; aURL,</span>
<a href="#l12.906"></a><span id="l12.906" class="difflineminus">-                            const nsACString&amp; aDisplayName, const nsACString&amp; aMessageUri, bool aIsExternalAttachment)</span>
<a href="#l12.907"></a><span id="l12.907" class="difflineminus">-{</span>
<a href="#l12.908"></a><span id="l12.908" class="difflineminus">-  // open external attachments inside our message pane which in turn should trigger the</span>
<a href="#l12.909"></a><span id="l12.909" class="difflineminus">-  // helper app dialog...</span>
<a href="#l12.910"></a><span id="l12.910" class="difflineminus">-  if (aIsExternalAttachment)</span>
<a href="#l12.911"></a><span id="l12.911" class="difflineminus">-    return OpenURL(aURL);</span>
<a href="#l12.912"></a><span id="l12.912" class="difflineplus">+nsMessenger::SaveAttachment(const nsACString &amp;aContentType,</span>
<a href="#l12.913"></a><span id="l12.913" class="difflineplus">+                            const nsACString &amp;aURL,</span>
<a href="#l12.914"></a><span id="l12.914" class="difflineplus">+                            const nsACString &amp;aDisplayName,</span>
<a href="#l12.915"></a><span id="l12.915" class="difflineplus">+                            const nsACString &amp;aMessageUri,</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineplus">+                            bool aIsExternalAttachment) {</span>
<a href="#l12.917"></a><span id="l12.917" class="difflineplus">+  // open external attachments inside our message pane which in turn should</span>
<a href="#l12.918"></a><span id="l12.918" class="difflineplus">+  // trigger the helper app dialog...</span>
<a href="#l12.919"></a><span id="l12.919" class="difflineplus">+  if (aIsExternalAttachment) return OpenURL(aURL);</span>
<a href="#l12.920"></a><span id="l12.920">   return SaveOneAttachment(PromiseFlatCString(aContentType).get(),</span>
<a href="#l12.921"></a><span id="l12.921">                            PromiseFlatCString(aURL).get(),</span>
<a href="#l12.922"></a><span id="l12.922">                            PromiseFlatCString(aDisplayName).get(),</span>
<a href="#l12.923"></a><span id="l12.923" class="difflineminus">-                           PromiseFlatCString(aMessageUri).get(),</span>
<a href="#l12.924"></a><span id="l12.924" class="difflineminus">-                           false);</span>
<a href="#l12.925"></a><span id="l12.925" class="difflineplus">+                           PromiseFlatCString(aMessageUri).get(), false);</span>
<a href="#l12.926"></a><span id="l12.926"> }</span>
<a href="#l12.927"></a><span id="l12.927"> </span>
<a href="#l12.928"></a><span id="l12.928" class="difflineminus">-nsresult</span>
<a href="#l12.929"></a><span id="l12.929" class="difflineminus">-nsMessenger::SaveOneAttachment(const char * aContentType, const char * aURL,</span>
<a href="#l12.930"></a><span id="l12.930" class="difflineminus">-                               const char * aDisplayName, const char * aMessageUri,</span>
<a href="#l12.931"></a><span id="l12.931" class="difflineminus">-                               bool detaching)</span>
<a href="#l12.932"></a><span id="l12.932" class="difflineminus">-{</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineplus">+nsresult nsMessenger::SaveOneAttachment(const char *aContentType,</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineplus">+                                        const char *aURL,</span>
<a href="#l12.935"></a><span id="l12.935" class="difflineplus">+                                        const char *aDisplayName,</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineplus">+                                        const char *aMessageUri,</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineplus">+                                        bool detaching) {</span>
<a href="#l12.938"></a><span id="l12.938">   nsresult rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.939"></a><span id="l12.939">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l12.940"></a><span id="l12.940">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.941"></a><span id="l12.941">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.942"></a><span id="l12.942"> </span>
<a href="#l12.943"></a><span id="l12.943">   int16_t dialogResult;</span>
<a href="#l12.944"></a><span id="l12.944">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l12.945"></a><span id="l12.945">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.946"></a><span id="l12.946">   nsCString filePath;</span>
<a href="#l12.947"></a><span id="l12.947">   nsString saveAttachmentStr;</span>
<a href="#l12.948"></a><span id="l12.948">   nsString defaultDisplayString;</span>
<a href="#l12.949"></a><span id="l12.949">   ConvertAndSanitizeFileName(aDisplayName, defaultDisplayString);</span>
<a href="#l12.950"></a><span id="l12.950"> </span>
<a href="#l12.951"></a><span id="l12.951">   if (detaching) {</span>
<a href="#l12.952"></a><span id="l12.952">     GetString(NS_LITERAL_STRING(&quot;DetachAttachment&quot;), saveAttachmentStr);</span>
<a href="#l12.953"></a><span id="l12.953" class="difflineminus">-  }</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineminus">-  else {</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineplus">+  } else {</span>
<a href="#l12.956"></a><span id="l12.956">     GetString(NS_LITERAL_STRING(&quot;SaveAttachment&quot;), saveAttachmentStr);</span>
<a href="#l12.957"></a><span id="l12.957">   }</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineminus">-  filePicker-&gt;Init(mWindow, saveAttachmentStr,</span>
<a href="#l12.959"></a><span id="l12.959" class="difflineminus">-                   nsIFilePicker::modeSave);</span>
<a href="#l12.960"></a><span id="l12.960" class="difflineplus">+  filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeSave);</span>
<a href="#l12.961"></a><span id="l12.961">   filePicker-&gt;SetDefaultString(defaultDisplayString);</span>
<a href="#l12.962"></a><span id="l12.962"> </span>
<a href="#l12.963"></a><span id="l12.963">   // Check if the attachment file name has an extension (which must not</span>
<a href="#l12.964"></a><span id="l12.964">   // contain spaces) and set it as the default extension for the attachment.</span>
<a href="#l12.965"></a><span id="l12.965">   int32_t extensionIndex = defaultDisplayString.RFindChar('.');</span>
<a href="#l12.966"></a><span id="l12.966">   if (extensionIndex &gt; 0 &amp;&amp;</span>
<a href="#l12.967"></a><span id="l12.967" class="difflineminus">-      defaultDisplayString.FindChar(' ', extensionIndex) == kNotFound)</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineminus">-  {</span>
<a href="#l12.969"></a><span id="l12.969" class="difflineplus">+      defaultDisplayString.FindChar(' ', extensionIndex) == kNotFound) {</span>
<a href="#l12.970"></a><span id="l12.970">     nsString extension;</span>
<a href="#l12.971"></a><span id="l12.971">     extension = Substring(defaultDisplayString, extensionIndex + 1);</span>
<a href="#l12.972"></a><span id="l12.972">     filePicker-&gt;SetDefaultExtension(extension);</span>
<a href="#l12.973"></a><span id="l12.973" class="difflineminus">-    if (!mStringBundle)</span>
<a href="#l12.974"></a><span id="l12.974" class="difflineminus">-    {</span>
<a href="#l12.975"></a><span id="l12.975" class="difflineplus">+    if (!mStringBundle) {</span>
<a href="#l12.976"></a><span id="l12.976">       rv = InitStringBundle();</span>
<a href="#l12.977"></a><span id="l12.977">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.978"></a><span id="l12.978">     }</span>
<a href="#l12.979"></a><span id="l12.979"> </span>
<a href="#l12.980"></a><span id="l12.980">     nsString filterName;</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineminus">-    const char16_t *extensionParam[] = { extension.get() };</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineminus">-    rv = mStringBundle-&gt;FormatStringFromName(</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineminus">-      &quot;saveAsType&quot;, extensionParam, 1, filterName);</span>
<a href="#l12.984"></a><span id="l12.984" class="difflineplus">+    const char16_t *extensionParam[] = {extension.get()};</span>
<a href="#l12.985"></a><span id="l12.985" class="difflineplus">+    rv = mStringBundle-&gt;FormatStringFromName(&quot;saveAsType&quot;, extensionParam, 1,</span>
<a href="#l12.986"></a><span id="l12.986" class="difflineplus">+                                             filterName);</span>
<a href="#l12.987"></a><span id="l12.987">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.988"></a><span id="l12.988"> </span>
<a href="#l12.989"></a><span id="l12.989">     extension.InsertLiteral(u&quot;*.&quot;, 0);</span>
<a href="#l12.990"></a><span id="l12.990">     filePicker-&gt;AppendFilter(filterName, extension);</span>
<a href="#l12.991"></a><span id="l12.991">   }</span>
<a href="#l12.992"></a><span id="l12.992"> </span>
<a href="#l12.993"></a><span id="l12.993">   filePicker-&gt;AppendFilters(nsIFilePicker::filterAll);</span>
<a href="#l12.994"></a><span id="l12.994"> </span>
<a href="#l12.995"></a><span id="l12.995">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l12.996"></a><span id="l12.996">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l12.997"></a><span id="l12.997">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l12.998"></a><span id="l12.998"> </span>
<a href="#l12.999"></a><span id="l12.999">   rv = ShowPicker(filePicker, &amp;dialogResult);</span>
<a href="#l12.1000"></a><span id="l12.1000" class="difflineminus">-  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel)</span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineminus">-    return rv;</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineplus">+  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel) return rv;</span>
<a href="#l12.1003"></a><span id="l12.1003"> </span>
<a href="#l12.1004"></a><span id="l12.1004">   rv = filePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l12.1005"></a><span id="l12.1005">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1006"></a><span id="l12.1006"> </span>
<a href="#l12.1007"></a><span id="l12.1007">   SetLastSaveDirectory(localFile);</span>
<a href="#l12.1008"></a><span id="l12.1008"> </span>
<a href="#l12.1009"></a><span id="l12.1009">   PathString dirName = localFile-&gt;NativePath();</span>
<a href="#l12.1010"></a><span id="l12.1010"> </span>
<a href="#l12.1011"></a><span id="l12.1011">   nsSaveAllAttachmentsState *saveState =</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineminus">-    new nsSaveAllAttachmentsState(1,</span>
<a href="#l12.1013"></a><span id="l12.1013" class="difflineminus">-                                  &amp;aContentType,</span>
<a href="#l12.1014"></a><span id="l12.1014" class="difflineminus">-                                  &amp;aURL,</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineminus">-                                  &amp;aDisplayName,</span>
<a href="#l12.1016"></a><span id="l12.1016" class="difflineminus">-                                  &amp;aMessageUri,</span>
<a href="#l12.1017"></a><span id="l12.1017" class="difflineminus">-                                  dirName.get(),</span>
<a href="#l12.1018"></a><span id="l12.1018" class="difflineminus">-                                  detaching);</span>
<a href="#l12.1019"></a><span id="l12.1019" class="difflineminus">-</span>
<a href="#l12.1020"></a><span id="l12.1020" class="difflineminus">-  return SaveAttachment(localFile, nsDependentCString(aURL), nsDependentCString(aMessageUri),</span>
<a href="#l12.1021"></a><span id="l12.1021" class="difflineminus">-                        nsDependentCString(aContentType), (void *)saveState, nullptr);</span>
<a href="#l12.1022"></a><span id="l12.1022" class="difflineplus">+      new nsSaveAllAttachmentsState(1, &amp;aContentType, &amp;aURL, &amp;aDisplayName,</span>
<a href="#l12.1023"></a><span id="l12.1023" class="difflineplus">+                                    &amp;aMessageUri, dirName.get(), detaching);</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineplus">+</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineplus">+  return SaveAttachment(</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineplus">+      localFile, nsDependentCString(aURL), nsDependentCString(aMessageUri),</span>
<a href="#l12.1027"></a><span id="l12.1027" class="difflineplus">+      nsDependentCString(aContentType), (void *)saveState, nullptr);</span>
<a href="#l12.1028"></a><span id="l12.1028"> }</span>
<a href="#l12.1029"></a><span id="l12.1029"> </span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineminus">-</span>
<a href="#l12.1031"></a><span id="l12.1031"> NS_IMETHODIMP</span>
<a href="#l12.1032"></a><span id="l12.1032" class="difflineminus">-nsMessenger::SaveAllAttachments(uint32_t count,</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineminus">-                                const char **contentTypeArray,</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineplus">+nsMessenger::SaveAllAttachments(uint32_t count, const char **contentTypeArray,</span>
<a href="#l12.1035"></a><span id="l12.1035">                                 const char **urlArray,</span>
<a href="#l12.1036"></a><span id="l12.1036">                                 const char **displayNameArray,</span>
<a href="#l12.1037"></a><span id="l12.1037" class="difflineminus">-                                const char **messageUriArray)</span>
<a href="#l12.1038"></a><span id="l12.1038" class="difflineminus">-{</span>
<a href="#l12.1039"></a><span id="l12.1039" class="difflineminus">-  if (!count)</span>
<a href="#l12.1040"></a><span id="l12.1040" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.1041"></a><span id="l12.1041" class="difflineminus">-  return SaveAllAttachments(count, contentTypeArray, urlArray, displayNameArray, messageUriArray, false);</span>
<a href="#l12.1042"></a><span id="l12.1042" class="difflineplus">+                                const char **messageUriArray) {</span>
<a href="#l12.1043"></a><span id="l12.1043" class="difflineplus">+  if (!count) return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineplus">+  return SaveAllAttachments(count, contentTypeArray, urlArray, displayNameArray,</span>
<a href="#l12.1045"></a><span id="l12.1045" class="difflineplus">+                            messageUriArray, false);</span>
<a href="#l12.1046"></a><span id="l12.1046"> }</span>
<a href="#l12.1047"></a><span id="l12.1047"> </span>
<a href="#l12.1048"></a><span id="l12.1048" class="difflineminus">-nsresult</span>
<a href="#l12.1049"></a><span id="l12.1049" class="difflineminus">-nsMessenger::SaveAllAttachments(uint32_t count,</span>
<a href="#l12.1050"></a><span id="l12.1050" class="difflineminus">-                                const char **contentTypeArray,</span>
<a href="#l12.1051"></a><span id="l12.1051" class="difflineminus">-                                const char **urlArray,</span>
<a href="#l12.1052"></a><span id="l12.1052" class="difflineminus">-                                const char **displayNameArray,</span>
<a href="#l12.1053"></a><span id="l12.1053" class="difflineminus">-                                const char **messageUriArray,</span>
<a href="#l12.1054"></a><span id="l12.1054" class="difflineminus">-                                bool detaching)</span>
<a href="#l12.1055"></a><span id="l12.1055" class="difflineminus">-{</span>
<a href="#l12.1056"></a><span id="l12.1056" class="difflineplus">+nsresult nsMessenger::SaveAllAttachments(uint32_t count,</span>
<a href="#l12.1057"></a><span id="l12.1057" class="difflineplus">+                                         const char **contentTypeArray,</span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineplus">+                                         const char **urlArray,</span>
<a href="#l12.1059"></a><span id="l12.1059" class="difflineplus">+                                         const char **displayNameArray,</span>
<a href="#l12.1060"></a><span id="l12.1060" class="difflineplus">+                                         const char **messageUriArray,</span>
<a href="#l12.1061"></a><span id="l12.1061" class="difflineplus">+                                         bool detaching) {</span>
<a href="#l12.1062"></a><span id="l12.1062">   nsresult rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.1063"></a><span id="l12.1063">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l12.1064"></a><span id="l12.1064" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1065"></a><span id="l12.1065" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1066"></a><span id="l12.1066">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l12.1067"></a><span id="l12.1067">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.1068"></a><span id="l12.1068">   int16_t dialogResult;</span>
<a href="#l12.1069"></a><span id="l12.1069">   nsString saveAttachmentStr;</span>
<a href="#l12.1070"></a><span id="l12.1070"> </span>
<a href="#l12.1071"></a><span id="l12.1071">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1072"></a><span id="l12.1072">   if (detaching) {</span>
<a href="#l12.1073"></a><span id="l12.1073">     GetString(NS_LITERAL_STRING(&quot;DetachAllAttachments&quot;), saveAttachmentStr);</span>
<a href="#l12.1074"></a><span id="l12.1074" class="difflineminus">-  }</span>
<a href="#l12.1075"></a><span id="l12.1075" class="difflineminus">-  else {</span>
<a href="#l12.1076"></a><span id="l12.1076" class="difflineplus">+  } else {</span>
<a href="#l12.1077"></a><span id="l12.1077">     GetString(NS_LITERAL_STRING(&quot;SaveAllAttachments&quot;), saveAttachmentStr);</span>
<a href="#l12.1078"></a><span id="l12.1078">   }</span>
<a href="#l12.1079"></a><span id="l12.1079" class="difflineminus">-  filePicker-&gt;Init(mWindow,</span>
<a href="#l12.1080"></a><span id="l12.1080" class="difflineminus">-                   saveAttachmentStr,</span>
<a href="#l12.1081"></a><span id="l12.1081" class="difflineminus">-                   nsIFilePicker::modeGetFolder);</span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineplus">+  filePicker-&gt;Init(mWindow, saveAttachmentStr, nsIFilePicker::modeGetFolder);</span>
<a href="#l12.1083"></a><span id="l12.1083"> </span>
<a href="#l12.1084"></a><span id="l12.1084">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l12.1085"></a><span id="l12.1085">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l12.1086"></a><span id="l12.1086">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l12.1087"></a><span id="l12.1087"> </span>
<a href="#l12.1088"></a><span id="l12.1088">   rv = ShowPicker(filePicker, &amp;dialogResult);</span>
<a href="#l12.1089"></a><span id="l12.1089" class="difflineminus">-  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel)</span>
<a href="#l12.1090"></a><span id="l12.1090" class="difflineminus">-    return rv;</span>
<a href="#l12.1091"></a><span id="l12.1091" class="difflineplus">+  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel) return rv;</span>
<a href="#l12.1092"></a><span id="l12.1092"> </span>
<a href="#l12.1093"></a><span id="l12.1093">   rv = filePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l12.1094"></a><span id="l12.1094">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1095"></a><span id="l12.1095"> </span>
<a href="#l12.1096"></a><span id="l12.1096">   rv = SetLastSaveDirectory(localFile);</span>
<a href="#l12.1097"></a><span id="l12.1097">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1098"></a><span id="l12.1098"> </span>
<a href="#l12.1099"></a><span id="l12.1099">   nsSaveAllAttachmentsState *saveState = nullptr;</span>
<a href="#l12.1100"></a><span id="l12.1100">   PathString dirName = localFile-&gt;NativePath();</span>
<a href="#l12.1101"></a><span id="l12.1101"> </span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineminus">-  saveState = new nsSaveAllAttachmentsState(count,</span>
<a href="#l12.1103"></a><span id="l12.1103" class="difflineminus">-                                            contentTypeArray,</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineminus">-                                            urlArray,</span>
<a href="#l12.1105"></a><span id="l12.1105" class="difflineminus">-                                            displayNameArray,</span>
<a href="#l12.1106"></a><span id="l12.1106" class="difflineminus">-                                            messageUriArray,</span>
<a href="#l12.1107"></a><span id="l12.1107" class="difflineminus">-                                            dirName.get(),</span>
<a href="#l12.1108"></a><span id="l12.1108" class="difflineminus">-                                            detaching);</span>
<a href="#l12.1109"></a><span id="l12.1109" class="difflineplus">+  saveState = new nsSaveAllAttachmentsState(count, contentTypeArray, urlArray,</span>
<a href="#l12.1110"></a><span id="l12.1110" class="difflineplus">+                                            displayNameArray, messageUriArray,</span>
<a href="#l12.1111"></a><span id="l12.1111" class="difflineplus">+                                            dirName.get(), detaching);</span>
<a href="#l12.1112"></a><span id="l12.1112">   nsString unescapedName;</span>
<a href="#l12.1113"></a><span id="l12.1113">   ConvertAndSanitizeFileName(displayNameArray[0], unescapedName);</span>
<a href="#l12.1114"></a><span id="l12.1114">   rv = localFile-&gt;Append(unescapedName);</span>
<a href="#l12.1115"></a><span id="l12.1115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1116"></a><span id="l12.1116"> </span>
<a href="#l12.1117"></a><span id="l12.1117">   rv = PromptIfFileExists(localFile);</span>
<a href="#l12.1118"></a><span id="l12.1118">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1119"></a><span id="l12.1119"> </span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineminus">-  rv = SaveAttachment(localFile, nsDependentCString(urlArray[0]), nsDependentCString(messageUriArray[0]),</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineminus">-                      nsDependentCString(contentTypeArray[0]), (void *)saveState, nullptr);</span>
<a href="#l12.1122"></a><span id="l12.1122" class="difflineplus">+  rv = SaveAttachment(localFile, nsDependentCString(urlArray[0]),</span>
<a href="#l12.1123"></a><span id="l12.1123" class="difflineplus">+                      nsDependentCString(messageUriArray[0]),</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineplus">+                      nsDependentCString(contentTypeArray[0]),</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineplus">+                      (void *)saveState, nullptr);</span>
<a href="#l12.1126"></a><span id="l12.1126">   return rv;</span>
<a href="#l12.1127"></a><span id="l12.1127"> }</span>
<a href="#l12.1128"></a><span id="l12.1128"> </span>
<a href="#l12.1129"></a><span id="l12.1129" class="difflineminus">-enum MESSENGER_SAVEAS_FILE_TYPE</span>
<a href="#l12.1130"></a><span id="l12.1130" class="difflineminus">-{</span>
<a href="#l12.1131"></a><span id="l12.1131" class="difflineminus">- EML_FILE_TYPE =  0,</span>
<a href="#l12.1132"></a><span id="l12.1132" class="difflineminus">- HTML_FILE_TYPE = 1,</span>
<a href="#l12.1133"></a><span id="l12.1133" class="difflineminus">- TEXT_FILE_TYPE = 2,</span>
<a href="#l12.1134"></a><span id="l12.1134" class="difflineminus">- ANY_FILE_TYPE = 3</span>
<a href="#l12.1135"></a><span id="l12.1135" class="difflineplus">+enum MESSENGER_SAVEAS_FILE_TYPE {</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineplus">+  EML_FILE_TYPE = 0,</span>
<a href="#l12.1137"></a><span id="l12.1137" class="difflineplus">+  HTML_FILE_TYPE = 1,</span>
<a href="#l12.1138"></a><span id="l12.1138" class="difflineplus">+  TEXT_FILE_TYPE = 2,</span>
<a href="#l12.1139"></a><span id="l12.1139" class="difflineplus">+  ANY_FILE_TYPE = 3</span>
<a href="#l12.1140"></a><span id="l12.1140"> };</span>
<a href="#l12.1141"></a><span id="l12.1141"> #define HTML_FILE_EXTENSION &quot;.htm&quot;</span>
<a href="#l12.1142"></a><span id="l12.1142"> #define HTML_FILE_EXTENSION2 &quot;.html&quot;</span>
<a href="#l12.1143"></a><span id="l12.1143"> #define TEXT_FILE_EXTENSION &quot;.txt&quot;</span>
<a href="#l12.1144"></a><span id="l12.1144"> </span>
<a href="#l12.1145"></a><span id="l12.1145"> /**</span>
<a href="#l12.1146"></a><span id="l12.1146">  * Adjust the file name, removing characters from the middle of the name if</span>
<a href="#l12.1147"></a><span id="l12.1147">  * the name would otherwise be too long - too long for what file systems</span>
<a href="#l12.1148"></a><span id="l12.1148">  * usually support.</span>
<a href="#l12.1149"></a><span id="l12.1149">  */</span>
<a href="#l12.1150"></a><span id="l12.1150" class="difflineminus">-nsresult nsMessenger::AdjustFileIfNameTooLong(nsIFile* aFile)</span>
<a href="#l12.1151"></a><span id="l12.1151" class="difflineminus">-{</span>
<a href="#l12.1152"></a><span id="l12.1152" class="difflineplus">+nsresult nsMessenger::AdjustFileIfNameTooLong(nsIFile *aFile) {</span>
<a href="#l12.1153"></a><span id="l12.1153">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l12.1154"></a><span id="l12.1154">   nsAutoString path;</span>
<a href="#l12.1155"></a><span id="l12.1155">   nsresult rv = aFile-&gt;GetPath(path);</span>
<a href="#l12.1156"></a><span id="l12.1156">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1157"></a><span id="l12.1157">   // Most common file systems have a max filename length of 255. On windows, the</span>
<a href="#l12.1158"></a><span id="l12.1158">   // total path length is (at least for all practical purposees) limited to 255.</span>
<a href="#l12.1159"></a><span id="l12.1159">   // Let's just don't allow paths longer than that elsewhere either for</span>
<a href="#l12.1160"></a><span id="l12.1160">   // simplicity.</span>
<a href="#l12.1161"></a><span id="l12.1161">   uint32_t MAX = 255;</span>
<a href="#l12.1162"></a><span id="l12.1162">   if (path.Length() &gt; MAX) {</span>
<a href="#l12.1163"></a><span id="l12.1163">     nsAutoString leafName;</span>
<a href="#l12.1164"></a><span id="l12.1164">     rv = aFile-&gt;GetLeafName(leafName);</span>
<a href="#l12.1165"></a><span id="l12.1165">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1166"></a><span id="l12.1166"> </span>
<a href="#l12.1167"></a><span id="l12.1167">     uint32_t pathLengthUpToLeaf = path.Length() - leafName.Length();</span>
<a href="#l12.1168"></a><span id="l12.1168" class="difflineminus">-    if (pathLengthUpToLeaf &gt;= MAX - 8) { // want at least 8 chars for name</span>
<a href="#l12.1169"></a><span id="l12.1169" class="difflineplus">+    if (pathLengthUpToLeaf &gt;= MAX - 8) {  // want at least 8 chars for name</span>
<a href="#l12.1170"></a><span id="l12.1170">       return NS_ERROR_FILE_NAME_TOO_LONG;</span>
<a href="#l12.1171"></a><span id="l12.1171">     }</span>
<a href="#l12.1172"></a><span id="l12.1172" class="difflineminus">-    uint32_t x = MAX - pathLengthUpToLeaf; // x = max leaf size</span>
<a href="#l12.1173"></a><span id="l12.1173" class="difflineplus">+    uint32_t x = MAX - pathLengthUpToLeaf;  // x = max leaf size</span>
<a href="#l12.1174"></a><span id="l12.1174">     nsAutoString truncatedLeaf;</span>
<a href="#l12.1175"></a><span id="l12.1175" class="difflineminus">-    truncatedLeaf.Append(Substring(leafName, 0, x/2));</span>
<a href="#l12.1176"></a><span id="l12.1176" class="difflineplus">+    truncatedLeaf.Append(Substring(leafName, 0, x / 2));</span>
<a href="#l12.1177"></a><span id="l12.1177">     truncatedLeaf.AppendLiteral(&quot;...&quot;);</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineminus">-    truncatedLeaf.Append(Substring(leafName, leafName.Length() - x/2 + 3,</span>
<a href="#l12.1179"></a><span id="l12.1179" class="difflineminus">-                                   leafName.Length()));</span>
<a href="#l12.1180"></a><span id="l12.1180" class="difflineplus">+    truncatedLeaf.Append(</span>
<a href="#l12.1181"></a><span id="l12.1181" class="difflineplus">+        Substring(leafName, leafName.Length() - x / 2 + 3, leafName.Length()));</span>
<a href="#l12.1182"></a><span id="l12.1182">     rv = aFile-&gt;SetLeafName(truncatedLeaf);</span>
<a href="#l12.1183"></a><span id="l12.1183">   }</span>
<a href="#l12.1184"></a><span id="l12.1184">   return rv;</span>
<a href="#l12.1185"></a><span id="l12.1185"> }</span>
<a href="#l12.1186"></a><span id="l12.1186"> </span>
<a href="#l12.1187"></a><span id="l12.1187"> NS_IMETHODIMP</span>
<a href="#l12.1188"></a><span id="l12.1188" class="difflineminus">-nsMessenger::SaveAs(const nsACString&amp; aURI, bool aAsFile,</span>
<a href="#l12.1189"></a><span id="l12.1189" class="difflineminus">-                    nsIMsgIdentity *aIdentity, const nsAString&amp; aMsgFilename,</span>
<a href="#l12.1190"></a><span id="l12.1190" class="difflineminus">-                    bool aBypassFilePicker)</span>
<a href="#l12.1191"></a><span id="l12.1191" class="difflineminus">-{</span>
<a href="#l12.1192"></a><span id="l12.1192" class="difflineplus">+nsMessenger::SaveAs(const nsACString &amp;aURI, bool aAsFile,</span>
<a href="#l12.1193"></a><span id="l12.1193" class="difflineplus">+                    nsIMsgIdentity *aIdentity, const nsAString &amp;aMsgFilename,</span>
<a href="#l12.1194"></a><span id="l12.1194" class="difflineplus">+                    bool aBypassFilePicker) {</span>
<a href="#l12.1195"></a><span id="l12.1195">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.1196"></a><span id="l12.1196">   nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l12.1197"></a><span id="l12.1197">   RefPtr&lt;nsSaveMsgListener&gt; saveListener;</span>
<a href="#l12.1198"></a><span id="l12.1198">   nsCOMPtr&lt;nsIStreamListener&gt; convertedListener;</span>
<a href="#l12.1199"></a><span id="l12.1199">   int32_t saveAsFileType = EML_FILE_TYPE;</span>
<a href="#l12.1200"></a><span id="l12.1200"> </span>
<a href="#l12.1201"></a><span id="l12.1201">   nsresult rv = GetMessageServiceFromURI(aURI, getter_AddRefs(messageService));</span>
<a href="#l12.1202"></a><span id="l12.1202" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.1203"></a><span id="l12.1203" class="difflineminus">-    goto done;</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineminus">-</span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineminus">-  if (aAsFile)</span>
<a href="#l12.1206"></a><span id="l12.1206" class="difflineminus">-  {</span>
<a href="#l12.1207"></a><span id="l12.1207" class="difflineplus">+  if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1208"></a><span id="l12.1208" class="difflineplus">+</span>
<a href="#l12.1209"></a><span id="l12.1209" class="difflineplus">+  if (aAsFile) {</span>
<a href="#l12.1210"></a><span id="l12.1210">     nsCOMPtr&lt;nsIFile&gt; saveAsFile;</span>
<a href="#l12.1211"></a><span id="l12.1211">     // show the file picker if BypassFilePicker is not specified (null) or false</span>
<a href="#l12.1212"></a><span id="l12.1212">     if (!aBypassFilePicker) {</span>
<a href="#l12.1213"></a><span id="l12.1213" class="difflineminus">-      rv = GetSaveAsFile(aMsgFilename, &amp;saveAsFileType, getter_AddRefs(saveAsFile));</span>
<a href="#l12.1214"></a><span id="l12.1214" class="difflineplus">+      rv = GetSaveAsFile(aMsgFilename, &amp;saveAsFileType,</span>
<a href="#l12.1215"></a><span id="l12.1215" class="difflineplus">+                         getter_AddRefs(saveAsFile));</span>
<a href="#l12.1216"></a><span id="l12.1216">       // A null saveAsFile means that the user canceled the save as</span>
<a href="#l12.1217"></a><span id="l12.1217" class="difflineminus">-      if (NS_FAILED(rv) || !saveAsFile)</span>
<a href="#l12.1218"></a><span id="l12.1218" class="difflineminus">-        goto done;</span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineminus">-    }</span>
<a href="#l12.1220"></a><span id="l12.1220" class="difflineminus">-    else {</span>
<a href="#l12.1221"></a><span id="l12.1221" class="difflineplus">+      if (NS_FAILED(rv) || !saveAsFile) goto done;</span>
<a href="#l12.1222"></a><span id="l12.1222" class="difflineplus">+    } else {</span>
<a href="#l12.1223"></a><span id="l12.1223">       saveAsFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1224"></a><span id="l12.1224">       rv = saveAsFile-&gt;InitWithPath(aMsgFilename);</span>
<a href="#l12.1225"></a><span id="l12.1225" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.1226"></a><span id="l12.1226" class="difflineminus">-        goto done;</span>
<a href="#l12.1227"></a><span id="l12.1227" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1228"></a><span id="l12.1228">       if (StringEndsWith(aMsgFilename, NS_LITERAL_STRING(TEXT_FILE_EXTENSION),</span>
<a href="#l12.1229"></a><span id="l12.1229">                          nsCaseInsensitiveStringComparator()))</span>
<a href="#l12.1230"></a><span id="l12.1230">         saveAsFileType = TEXT_FILE_TYPE;</span>
<a href="#l12.1231"></a><span id="l12.1231">       else if ((StringEndsWith(aMsgFilename,</span>
<a href="#l12.1232"></a><span id="l12.1232">                                NS_LITERAL_STRING(HTML_FILE_EXTENSION),</span>
<a href="#l12.1233"></a><span id="l12.1233">                                nsCaseInsensitiveStringComparator())) ||</span>
<a href="#l12.1234"></a><span id="l12.1234">                (StringEndsWith(aMsgFilename,</span>
<a href="#l12.1235"></a><span id="l12.1235">                                NS_LITERAL_STRING(HTML_FILE_EXTENSION2),</span>
<a href="#l12.1236"></a><span id="l12.1236" class="difflineat">@@ -1053,284 +984,254 @@ nsMessenger::SaveAs(const nsACString&amp; aU</span>
<a href="#l12.1237"></a><span id="l12.1237">     rv = PromptIfFileExists(saveAsFile);</span>
<a href="#l12.1238"></a><span id="l12.1238">     if (NS_FAILED(rv)) {</span>
<a href="#l12.1239"></a><span id="l12.1239">       goto done;</span>
<a href="#l12.1240"></a><span id="l12.1240">     }</span>
<a href="#l12.1241"></a><span id="l12.1241"> </span>
<a href="#l12.1242"></a><span id="l12.1242">     // After saveListener goes out of scope, the listener will be owned by</span>
<a href="#l12.1243"></a><span id="l12.1243">     // whoever the listener is registered with, usually a URL.</span>
<a href="#l12.1244"></a><span id="l12.1244">     saveListener = new nsSaveMsgListener(saveAsFile, this, nullptr);</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineminus">-    rv = saveListener-&gt;QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineminus">-      goto done;</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineminus">-</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineminus">-    if (saveAsFileType == EML_FILE_TYPE)</span>
<a href="#l12.1250"></a><span id="l12.1250" class="difflineminus">-    {</span>
<a href="#l12.1251"></a><span id="l12.1251" class="difflineplus">+    rv = saveListener-&gt;QueryInterface(NS_GET_IID(nsIUrlListener),</span>
<a href="#l12.1252"></a><span id="l12.1252" class="difflineplus">+                                      getter_AddRefs(urlListener));</span>
<a href="#l12.1253"></a><span id="l12.1253" class="difflineplus">+    if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1254"></a><span id="l12.1254" class="difflineplus">+</span>
<a href="#l12.1255"></a><span id="l12.1255" class="difflineplus">+    if (saveAsFileType == EML_FILE_TYPE) {</span>
<a href="#l12.1256"></a><span id="l12.1256">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.1257"></a><span id="l12.1257" class="difflineminus">-      rv = messageService-&gt;SaveMessageToDisk(PromiseFlatCString(aURI).get(), saveAsFile, false,</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineminus">-        urlListener, getter_AddRefs(dummyNull),</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineminus">-        true, mMsgWindow);</span>
<a href="#l12.1260"></a><span id="l12.1260" class="difflineminus">-    }</span>
<a href="#l12.1261"></a><span id="l12.1261" class="difflineminus">-    else</span>
<a href="#l12.1262"></a><span id="l12.1262" class="difflineminus">-    {</span>
<a href="#l12.1263"></a><span id="l12.1263" class="difflineplus">+      rv = messageService-&gt;SaveMessageToDisk(</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineplus">+          PromiseFlatCString(aURI).get(), saveAsFile, false, urlListener,</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+          getter_AddRefs(dummyNull), true, mMsgWindow);</span>
<a href="#l12.1266"></a><span id="l12.1266" class="difflineplus">+    } else {</span>
<a href="#l12.1267"></a><span id="l12.1267">       nsAutoCString urlString(aURI);</span>
<a href="#l12.1268"></a><span id="l12.1268"> </span>
<a href="#l12.1269"></a><span id="l12.1269">       // we can't go RFC822 to TXT until bug #1775 is fixed</span>
<a href="#l12.1270"></a><span id="l12.1270">       // so until then, do the HTML to TXT conversion in</span>
<a href="#l12.1271"></a><span id="l12.1271">       // nsSaveMsgListener::OnStopRequest(), see ConvertBufToPlainText()</span>
<a href="#l12.1272"></a><span id="l12.1272">       //</span>
<a href="#l12.1273"></a><span id="l12.1273">       // Setup the URL for a &quot;Save As...&quot; Operation...</span>
<a href="#l12.1274"></a><span id="l12.1274">       // For now, if this is a save as TEXT operation, then do</span>
<a href="#l12.1275"></a><span id="l12.1275">       // a &quot;printing&quot; operation</span>
<a href="#l12.1276"></a><span id="l12.1276" class="difflineminus">-      if (saveAsFileType == TEXT_FILE_TYPE)</span>
<a href="#l12.1277"></a><span id="l12.1277" class="difflineminus">-      {</span>
<a href="#l12.1278"></a><span id="l12.1278" class="difflineplus">+      if (saveAsFileType == TEXT_FILE_TYPE) {</span>
<a href="#l12.1279"></a><span id="l12.1279">         saveListener-&gt;m_outputFormat = nsSaveMsgListener::ePlainText;</span>
<a href="#l12.1280"></a><span id="l12.1280">         saveListener-&gt;m_doCharsetConversion = true;</span>
<a href="#l12.1281"></a><span id="l12.1281">         urlString.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l12.1282"></a><span id="l12.1282" class="difflineminus">-      }</span>
<a href="#l12.1283"></a><span id="l12.1283" class="difflineminus">-      else</span>
<a href="#l12.1284"></a><span id="l12.1284" class="difflineminus">-      {</span>
<a href="#l12.1285"></a><span id="l12.1285" class="difflineplus">+      } else {</span>
<a href="#l12.1286"></a><span id="l12.1286">         saveListener-&gt;m_outputFormat = nsSaveMsgListener::eHTML;</span>
<a href="#l12.1287"></a><span id="l12.1287">         saveListener-&gt;m_doCharsetConversion = false;</span>
<a href="#l12.1288"></a><span id="l12.1288">         urlString.AppendLiteral(&quot;?header=saveas&quot;);</span>
<a href="#l12.1289"></a><span id="l12.1289">       }</span>
<a href="#l12.1290"></a><span id="l12.1290"> </span>
<a href="#l12.1291"></a><span id="l12.1291">       nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l12.1292"></a><span id="l12.1292">       rv = NS_NewURI(getter_AddRefs(url), urlString);</span>
<a href="#l12.1293"></a><span id="l12.1293">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;NS_NewURI failed&quot;);</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineminus">-        goto done;</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1297"></a><span id="l12.1297"> </span>
<a href="#l12.1298"></a><span id="l12.1298">       nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l12.1299"></a><span id="l12.1299" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l12.1300"></a><span id="l12.1300" class="difflineplus">+          do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l12.1301"></a><span id="l12.1301">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed&quot;);</span>
<a href="#l12.1302"></a><span id="l12.1302" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.1303"></a><span id="l12.1303" class="difflineminus">-        goto done;</span>
<a href="#l12.1304"></a><span id="l12.1304" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1305"></a><span id="l12.1305"> </span>
<a href="#l12.1306"></a><span id="l12.1306">       saveListener-&gt;m_channel = nullptr;</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineminus">-      rv = NS_NewInputStreamChannel(getter_AddRefs(saveListener-&gt;m_channel),</span>
<a href="#l12.1308"></a><span id="l12.1308" class="difflineminus">-                                    url,</span>
<a href="#l12.1309"></a><span id="l12.1309" class="difflineminus">-                                    nullptr,</span>
<a href="#l12.1310"></a><span id="l12.1310" class="difflineminus">-                                    nullPrincipal,</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineminus">-                                    nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineminus">-                                    nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineplus">+      rv = NS_NewInputStreamChannel(</span>
<a href="#l12.1314"></a><span id="l12.1314" class="difflineplus">+          getter_AddRefs(saveListener-&gt;m_channel), url, nullptr, nullPrincipal,</span>
<a href="#l12.1315"></a><span id="l12.1315" class="difflineplus">+          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l12.1316"></a><span id="l12.1316" class="difflineplus">+          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l12.1317"></a><span id="l12.1317">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;NS_NewChannel failed&quot;);</span>
<a href="#l12.1318"></a><span id="l12.1318" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.1319"></a><span id="l12.1319" class="difflineminus">-        goto done;</span>
<a href="#l12.1320"></a><span id="l12.1320" class="difflineminus">-</span>
<a href="#l12.1321"></a><span id="l12.1321" class="difflineminus">-      nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService = do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<a href="#l12.1322"></a><span id="l12.1322" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; channelSupport = do_QueryInterface(saveListener-&gt;m_channel);</span>
<a href="#l12.1323"></a><span id="l12.1323" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1324"></a><span id="l12.1324" class="difflineplus">+</span>
<a href="#l12.1325"></a><span id="l12.1325" class="difflineplus">+      nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService =</span>
<a href="#l12.1326"></a><span id="l12.1326" class="difflineplus">+          do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<a href="#l12.1327"></a><span id="l12.1327" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; channelSupport =</span>
<a href="#l12.1328"></a><span id="l12.1328" class="difflineplus">+          do_QueryInterface(saveListener-&gt;m_channel);</span>
<a href="#l12.1329"></a><span id="l12.1329"> </span>
<a href="#l12.1330"></a><span id="l12.1330">       // we can't go RFC822 to TXT until bug #1775 is fixed</span>
<a href="#l12.1331"></a><span id="l12.1331">       // so until then, do the HTML to TXT conversion in</span>
<a href="#l12.1332"></a><span id="l12.1332">       // nsSaveMsgListener::OnStopRequest(), see ConvertBufToPlainText()</span>
<a href="#l12.1333"></a><span id="l12.1333" class="difflineminus">-      rv = streamConverterService-&gt;AsyncConvertData(MESSAGE_RFC822,</span>
<a href="#l12.1334"></a><span id="l12.1334" class="difflineminus">-        TEXT_HTML,</span>
<a href="#l12.1335"></a><span id="l12.1335" class="difflineminus">-        saveListener,</span>
<a href="#l12.1336"></a><span id="l12.1336" class="difflineminus">-        channelSupport,</span>
<a href="#l12.1337"></a><span id="l12.1337" class="difflineminus">-        getter_AddRefs(convertedListener));</span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineplus">+      rv = streamConverterService-&gt;AsyncConvertData(</span>
<a href="#l12.1339"></a><span id="l12.1339" class="difflineplus">+          MESSAGE_RFC822, TEXT_HTML, saveListener, channelSupport,</span>
<a href="#l12.1340"></a><span id="l12.1340" class="difflineplus">+          getter_AddRefs(convertedListener));</span>
<a href="#l12.1341"></a><span id="l12.1341">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;AsyncConvertData failed&quot;);</span>
<a href="#l12.1342"></a><span id="l12.1342" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.1343"></a><span id="l12.1343" class="difflineminus">-        goto done;</span>
<a href="#l12.1344"></a><span id="l12.1344" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1345"></a><span id="l12.1345"> </span>
<a href="#l12.1346"></a><span id="l12.1346">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineminus">-      rv = messageService-&gt;DisplayMessage(urlString.get(), convertedListener, mMsgWindow,</span>
<a href="#l12.1348"></a><span id="l12.1348" class="difflineminus">-        nullptr, nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l12.1349"></a><span id="l12.1349" class="difflineplus">+      rv = messageService-&gt;DisplayMessage(urlString.get(), convertedListener,</span>
<a href="#l12.1350"></a><span id="l12.1350" class="difflineplus">+                                          mMsgWindow, nullptr, nullptr,</span>
<a href="#l12.1351"></a><span id="l12.1351" class="difflineplus">+                                          getter_AddRefs(dummyNull));</span>
<a href="#l12.1352"></a><span id="l12.1352">     }</span>
<a href="#l12.1353"></a><span id="l12.1353" class="difflineminus">-  }</span>
<a href="#l12.1354"></a><span id="l12.1354" class="difflineminus">-  else</span>
<a href="#l12.1355"></a><span id="l12.1355" class="difflineminus">-  {</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineplus">+  } else {</span>
<a href="#l12.1357"></a><span id="l12.1357">     // ** save as Template</span>
<a href="#l12.1358"></a><span id="l12.1358" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l12.1359"></a><span id="l12.1359" class="difflineminus">-    nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l12.1360"></a><span id="l12.1360" class="difflineminus">-                                                  &quot;nsmail.tmp&quot;,</span>
<a href="#l12.1361"></a><span id="l12.1361" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l12.1362"></a><span id="l12.1362" class="difflineplus">+    nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;nsmail.tmp&quot;,</span>
<a href="#l12.1363"></a><span id="l12.1363">                                                   getter_AddRefs(tmpFile));</span>
<a href="#l12.1364"></a><span id="l12.1364"> </span>
<a href="#l12.1365"></a><span id="l12.1365">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1366"></a><span id="l12.1366"> </span>
<a href="#l12.1367"></a><span id="l12.1367" class="difflineminus">-    // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION</span>
<a href="#l12.1368"></a><span id="l12.1368" class="difflineplus">+    // For temp file, we should use restrictive 00600 instead of</span>
<a href="#l12.1369"></a><span id="l12.1369" class="difflineplus">+    // ATTACHMENT_PERMISSION</span>
<a href="#l12.1370"></a><span id="l12.1370">     rv = tmpFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l12.1371"></a><span id="l12.1371">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1372"></a><span id="l12.1372"> </span>
<a href="#l12.1373"></a><span id="l12.1373">     // The saveListener is owned by whoever we ultimately register the</span>
<a href="#l12.1374"></a><span id="l12.1374">     // listener with, generally a URL.</span>
<a href="#l12.1375"></a><span id="l12.1375">     saveListener = new nsSaveMsgListener(tmpFile, this, nullptr);</span>
<a href="#l12.1376"></a><span id="l12.1376"> </span>
<a href="#l12.1377"></a><span id="l12.1377">     if (aIdentity)</span>
<a href="#l12.1378"></a><span id="l12.1378">       rv = aIdentity-&gt;GetStationeryFolder(saveListener-&gt;m_templateUri);</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineminus">-      goto done;</span>
<a href="#l12.1381"></a><span id="l12.1381" class="difflineminus">-</span>
<a href="#l12.1382"></a><span id="l12.1382" class="difflineminus">-    bool needDummyHeader = StringBeginsWith(saveListener-&gt;m_templateUri, NS_LITERAL_CSTRING(&quot;mailbox://&quot;));</span>
<a href="#l12.1383"></a><span id="l12.1383" class="difflineminus">-    bool canonicalLineEnding = StringBeginsWith(saveListener-&gt;m_templateUri, NS_LITERAL_CSTRING(&quot;imap://&quot;));</span>
<a href="#l12.1384"></a><span id="l12.1384" class="difflineminus">-</span>
<a href="#l12.1385"></a><span id="l12.1385" class="difflineminus">-    rv = saveListener-&gt;QueryInterface(</span>
<a href="#l12.1386"></a><span id="l12.1386" class="difflineminus">-      NS_GET_IID(nsIUrlListener),</span>
<a href="#l12.1387"></a><span id="l12.1387" class="difflineminus">-      getter_AddRefs(urlListener));</span>
<a href="#l12.1388"></a><span id="l12.1388" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.1389"></a><span id="l12.1389" class="difflineminus">-      goto done;</span>
<a href="#l12.1390"></a><span id="l12.1390" class="difflineplus">+    if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1391"></a><span id="l12.1391" class="difflineplus">+</span>
<a href="#l12.1392"></a><span id="l12.1392" class="difflineplus">+    bool needDummyHeader = StringBeginsWith(saveListener-&gt;m_templateUri,</span>
<a href="#l12.1393"></a><span id="l12.1393" class="difflineplus">+                                            NS_LITERAL_CSTRING(&quot;mailbox://&quot;));</span>
<a href="#l12.1394"></a><span id="l12.1394" class="difflineplus">+    bool canonicalLineEnding = StringBeginsWith(saveListener-&gt;m_templateUri,</span>
<a href="#l12.1395"></a><span id="l12.1395" class="difflineplus">+                                                NS_LITERAL_CSTRING(&quot;imap://&quot;));</span>
<a href="#l12.1396"></a><span id="l12.1396" class="difflineplus">+</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineplus">+    rv = saveListener-&gt;QueryInterface(NS_GET_IID(nsIUrlListener),</span>
<a href="#l12.1398"></a><span id="l12.1398" class="difflineplus">+                                      getter_AddRefs(urlListener));</span>
<a href="#l12.1399"></a><span id="l12.1399" class="difflineplus">+    if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.1400"></a><span id="l12.1400"> </span>
<a href="#l12.1401"></a><span id="l12.1401">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.1402"></a><span id="l12.1402" class="difflineminus">-    rv = messageService-&gt;SaveMessageToDisk(PromiseFlatCString(aURI).get(), tmpFile,</span>
<a href="#l12.1403"></a><span id="l12.1403" class="difflineminus">-      needDummyHeader,</span>
<a href="#l12.1404"></a><span id="l12.1404" class="difflineminus">-      urlListener, getter_AddRefs(dummyNull),</span>
<a href="#l12.1405"></a><span id="l12.1405" class="difflineminus">-      canonicalLineEnding, mMsgWindow);</span>
<a href="#l12.1406"></a><span id="l12.1406" class="difflineplus">+    rv = messageService-&gt;SaveMessageToDisk(</span>
<a href="#l12.1407"></a><span id="l12.1407" class="difflineplus">+        PromiseFlatCString(aURI).get(), tmpFile, needDummyHeader, urlListener,</span>
<a href="#l12.1408"></a><span id="l12.1408" class="difflineplus">+        getter_AddRefs(dummyNull), canonicalLineEnding, mMsgWindow);</span>
<a href="#l12.1409"></a><span id="l12.1409">   }</span>
<a href="#l12.1410"></a><span id="l12.1410"> </span>
<a href="#l12.1411"></a><span id="l12.1411"> done:</span>
<a href="#l12.1412"></a><span id="l12.1412" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.1413"></a><span id="l12.1413" class="difflineminus">-  {</span>
<a href="#l12.1414"></a><span id="l12.1414" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.1415"></a><span id="l12.1415">     Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.1416"></a><span id="l12.1416">   }</span>
<a href="#l12.1417"></a><span id="l12.1417">   return rv;</span>
<a href="#l12.1418"></a><span id="l12.1418"> }</span>
<a href="#l12.1419"></a><span id="l12.1419"> </span>
<a href="#l12.1420"></a><span id="l12.1420" class="difflineminus">-nsresult</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineminus">-nsMessenger::GetSaveAsFile(const nsAString&amp; aMsgFilename, int32_t *aSaveAsFileType,</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineminus">-                           nsIFile **aSaveAsFile)</span>
<a href="#l12.1423"></a><span id="l12.1423" class="difflineminus">-{</span>
<a href="#l12.1424"></a><span id="l12.1424" class="difflineplus">+nsresult nsMessenger::GetSaveAsFile(const nsAString &amp;aMsgFilename,</span>
<a href="#l12.1425"></a><span id="l12.1425" class="difflineplus">+                                    int32_t *aSaveAsFileType,</span>
<a href="#l12.1426"></a><span id="l12.1426" class="difflineplus">+                                    nsIFile **aSaveAsFile) {</span>
<a href="#l12.1427"></a><span id="l12.1427">   nsresult rv;</span>
<a href="#l12.1428"></a><span id="l12.1428" class="difflineminus">-  nsCOMPtr&lt;nsIFilePicker&gt; filePicker = do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1429"></a><span id="l12.1429" class="difflineplus">+  nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l12.1430"></a><span id="l12.1430" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1431"></a><span id="l12.1431">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1432"></a><span id="l12.1432">   nsString saveMailAsStr;</span>
<a href="#l12.1433"></a><span id="l12.1433">   GetString(NS_LITERAL_STRING(&quot;SaveMailAs&quot;), saveMailAsStr);</span>
<a href="#l12.1434"></a><span id="l12.1434">   filePicker-&gt;Init(mWindow, saveMailAsStr, nsIFilePicker::modeSave);</span>
<a href="#l12.1435"></a><span id="l12.1435"> </span>
<a href="#l12.1436"></a><span id="l12.1436" class="difflineminus">-  // if we have a non-null filename use it, otherwise use default save message one</span>
<a href="#l12.1437"></a><span id="l12.1437" class="difflineminus">-  if (aMsgFilename.IsEmpty())</span>
<a href="#l12.1438"></a><span id="l12.1438" class="difflineminus">-  {</span>
<a href="#l12.1439"></a><span id="l12.1439" class="difflineplus">+  // if we have a non-null filename use it, otherwise use default save message</span>
<a href="#l12.1440"></a><span id="l12.1440" class="difflineplus">+  // one</span>
<a href="#l12.1441"></a><span id="l12.1441" class="difflineplus">+  if (aMsgFilename.IsEmpty()) {</span>
<a href="#l12.1442"></a><span id="l12.1442">     nsString saveMsgStr;</span>
<a href="#l12.1443"></a><span id="l12.1443">     GetString(NS_LITERAL_STRING(&quot;defaultSaveMessageAsFileName&quot;), saveMsgStr);</span>
<a href="#l12.1444"></a><span id="l12.1444">     filePicker-&gt;SetDefaultString(saveMsgStr);</span>
<a href="#l12.1445"></a><span id="l12.1445" class="difflineminus">-  }</span>
<a href="#l12.1446"></a><span id="l12.1446" class="difflineminus">-  else</span>
<a href="#l12.1447"></a><span id="l12.1447" class="difflineminus">-  {</span>
<a href="#l12.1448"></a><span id="l12.1448" class="difflineplus">+  } else {</span>
<a href="#l12.1449"></a><span id="l12.1449">     filePicker-&gt;SetDefaultString(aMsgFilename);</span>
<a href="#l12.1450"></a><span id="l12.1450">   }</span>
<a href="#l12.1451"></a><span id="l12.1451"> </span>
<a href="#l12.1452"></a><span id="l12.1452">   // because we will be using GetFilterIndex()</span>
<a href="#l12.1453"></a><span id="l12.1453">   // we must call AppendFilters() one at a time,</span>
<a href="#l12.1454"></a><span id="l12.1454">   // in MESSENGER_SAVEAS_FILE_TYPE order</span>
<a href="#l12.1455"></a><span id="l12.1455">   nsString emlFilesStr;</span>
<a href="#l12.1456"></a><span id="l12.1456">   GetString(NS_LITERAL_STRING(&quot;EMLFiles&quot;), emlFilesStr);</span>
<a href="#l12.1457"></a><span id="l12.1457" class="difflineminus">-  filePicker-&gt;AppendFilter(emlFilesStr,</span>
<a href="#l12.1458"></a><span id="l12.1458" class="difflineminus">-                           NS_LITERAL_STRING(&quot;*.eml&quot;));</span>
<a href="#l12.1459"></a><span id="l12.1459" class="difflineplus">+  filePicker-&gt;AppendFilter(emlFilesStr, NS_LITERAL_STRING(&quot;*.eml&quot;));</span>
<a href="#l12.1460"></a><span id="l12.1460">   filePicker-&gt;AppendFilters(nsIFilePicker::filterHTML);</span>
<a href="#l12.1461"></a><span id="l12.1461">   filePicker-&gt;AppendFilters(nsIFilePicker::filterText);</span>
<a href="#l12.1462"></a><span id="l12.1462">   filePicker-&gt;AppendFilters(nsIFilePicker::filterAll);</span>
<a href="#l12.1463"></a><span id="l12.1463"> </span>
<a href="#l12.1464"></a><span id="l12.1464">   // Save as the &quot;All Files&quot; file type by default. We want to save as .eml by</span>
<a href="#l12.1465"></a><span id="l12.1465">   // default, but the filepickers on some platforms don't switch extensions</span>
<a href="#l12.1466"></a><span id="l12.1466">   // based on the file type selected (bug 508597).</span>
<a href="#l12.1467"></a><span id="l12.1467">   filePicker-&gt;SetFilterIndex(ANY_FILE_TYPE);</span>
<a href="#l12.1468"></a><span id="l12.1468">   // Yes, this is fine even if we ultimately save as HTML or text. On Windows,</span>
<a href="#l12.1469"></a><span id="l12.1469">   // this actually is a boolean telling the file picker to automatically add</span>
<a href="#l12.1470"></a><span id="l12.1470">   // the correct extension depending on the filter. On Mac or Linux this is a</span>
<a href="#l12.1471"></a><span id="l12.1471">   // no-op.</span>
<a href="#l12.1472"></a><span id="l12.1472">   filePicker-&gt;SetDefaultExtension(NS_LITERAL_STRING(&quot;eml&quot;));</span>
<a href="#l12.1473"></a><span id="l12.1473"> </span>
<a href="#l12.1474"></a><span id="l12.1474">   int16_t dialogResult;</span>
<a href="#l12.1475"></a><span id="l12.1475"> </span>
<a href="#l12.1476"></a><span id="l12.1476" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.1477"></a><span id="l12.1477" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.1478"></a><span id="l12.1478">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l12.1479"></a><span id="l12.1479">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l12.1480"></a><span id="l12.1480">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l12.1481"></a><span id="l12.1481"> </span>
<a href="#l12.1482"></a><span id="l12.1482">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l12.1483"></a><span id="l12.1483">   rv = ShowPicker(filePicker, &amp;dialogResult);</span>
<a href="#l12.1484"></a><span id="l12.1484">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1485"></a><span id="l12.1485" class="difflineminus">-  if (dialogResult == nsIFilePicker::returnCancel)</span>
<a href="#l12.1486"></a><span id="l12.1486" class="difflineminus">-  {</span>
<a href="#l12.1487"></a><span id="l12.1487" class="difflineplus">+  if (dialogResult == nsIFilePicker::returnCancel) {</span>
<a href="#l12.1488"></a><span id="l12.1488">     // We'll indicate this by setting the outparam to null.</span>
<a href="#l12.1489"></a><span id="l12.1489">     *aSaveAsFile = nullptr;</span>
<a href="#l12.1490"></a><span id="l12.1490">     return NS_OK;</span>
<a href="#l12.1491"></a><span id="l12.1491">   }</span>
<a href="#l12.1492"></a><span id="l12.1492"> </span>
<a href="#l12.1493"></a><span id="l12.1493">   rv = filePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l12.1494"></a><span id="l12.1494">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1495"></a><span id="l12.1495"> </span>
<a href="#l12.1496"></a><span id="l12.1496">   rv = SetLastSaveDirectory(localFile);</span>
<a href="#l12.1497"></a><span id="l12.1497">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1498"></a><span id="l12.1498"> </span>
<a href="#l12.1499"></a><span id="l12.1499">   int32_t selectedSaveAsFileType;</span>
<a href="#l12.1500"></a><span id="l12.1500">   rv = filePicker-&gt;GetFilterIndex(&amp;selectedSaveAsFileType);</span>
<a href="#l12.1501"></a><span id="l12.1501">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1502"></a><span id="l12.1502"> </span>
<a href="#l12.1503"></a><span id="l12.1503">   // If All Files was selected, look at the extension</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineminus">-  if (selectedSaveAsFileType == ANY_FILE_TYPE)</span>
<a href="#l12.1505"></a><span id="l12.1505" class="difflineminus">-  {</span>
<a href="#l12.1506"></a><span id="l12.1506" class="difflineplus">+  if (selectedSaveAsFileType == ANY_FILE_TYPE) {</span>
<a href="#l12.1507"></a><span id="l12.1507">     nsAutoString fileName;</span>
<a href="#l12.1508"></a><span id="l12.1508">     rv = localFile-&gt;GetLeafName(fileName);</span>
<a href="#l12.1509"></a><span id="l12.1509">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1510"></a><span id="l12.1510"> </span>
<a href="#l12.1511"></a><span id="l12.1511">     if (StringEndsWith(fileName, NS_LITERAL_STRING(HTML_FILE_EXTENSION),</span>
<a href="#l12.1512"></a><span id="l12.1512">                        nsCaseInsensitiveStringComparator()) ||</span>
<a href="#l12.1513"></a><span id="l12.1513">         StringEndsWith(fileName, NS_LITERAL_STRING(HTML_FILE_EXTENSION2),</span>
<a href="#l12.1514"></a><span id="l12.1514">                        nsCaseInsensitiveStringComparator()))</span>
<a href="#l12.1515"></a><span id="l12.1515">       *aSaveAsFileType = HTML_FILE_TYPE;</span>
<a href="#l12.1516"></a><span id="l12.1516">     else if (StringEndsWith(fileName, NS_LITERAL_STRING(TEXT_FILE_EXTENSION),</span>
<a href="#l12.1517"></a><span id="l12.1517">                             nsCaseInsensitiveStringComparator()))</span>
<a href="#l12.1518"></a><span id="l12.1518">       *aSaveAsFileType = TEXT_FILE_TYPE;</span>
<a href="#l12.1519"></a><span id="l12.1519">     else</span>
<a href="#l12.1520"></a><span id="l12.1520">       // The default is .eml</span>
<a href="#l12.1521"></a><span id="l12.1521">       *aSaveAsFileType = EML_FILE_TYPE;</span>
<a href="#l12.1522"></a><span id="l12.1522" class="difflineminus">-  }</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineminus">-  else</span>
<a href="#l12.1524"></a><span id="l12.1524" class="difflineminus">-  {</span>
<a href="#l12.1525"></a><span id="l12.1525" class="difflineplus">+  } else {</span>
<a href="#l12.1526"></a><span id="l12.1526">     *aSaveAsFileType = selectedSaveAsFileType;</span>
<a href="#l12.1527"></a><span id="l12.1527">   }</span>
<a href="#l12.1528"></a><span id="l12.1528"> </span>
<a href="#l12.1529"></a><span id="l12.1529" class="difflineminus">-  if (dialogResult == nsIFilePicker::returnReplace)</span>
<a href="#l12.1530"></a><span id="l12.1530" class="difflineminus">-  {</span>
<a href="#l12.1531"></a><span id="l12.1531" class="difflineplus">+  if (dialogResult == nsIFilePicker::returnReplace) {</span>
<a href="#l12.1532"></a><span id="l12.1532">     // be extra safe and only delete when the file is really a file</span>
<a href="#l12.1533"></a><span id="l12.1533">     bool isFile;</span>
<a href="#l12.1534"></a><span id="l12.1534">     rv = localFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l12.1535"></a><span id="l12.1535" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isFile)</span>
<a href="#l12.1536"></a><span id="l12.1536" class="difflineminus">-    {</span>
<a href="#l12.1537"></a><span id="l12.1537" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isFile) {</span>
<a href="#l12.1538"></a><span id="l12.1538">       rv = localFile-&gt;Remove(false /* recursive delete */);</span>
<a href="#l12.1539"></a><span id="l12.1539">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1540"></a><span id="l12.1540" class="difflineminus">-    }</span>
<a href="#l12.1541"></a><span id="l12.1541" class="difflineminus">-    else</span>
<a href="#l12.1542"></a><span id="l12.1542" class="difflineminus">-    {</span>
<a href="#l12.1543"></a><span id="l12.1543" class="difflineplus">+    } else {</span>
<a href="#l12.1544"></a><span id="l12.1544">       // We failed, or this isn't a file. We can't do anything about it.</span>
<a href="#l12.1545"></a><span id="l12.1545">       return NS_ERROR_FAILURE;</span>
<a href="#l12.1546"></a><span id="l12.1546">     }</span>
<a href="#l12.1547"></a><span id="l12.1547">   }</span>
<a href="#l12.1548"></a><span id="l12.1548"> </span>
<a href="#l12.1549"></a><span id="l12.1549">   *aSaveAsFile = nullptr;</span>
<a href="#l12.1550"></a><span id="l12.1550">   localFile.forget(aSaveAsFile);</span>
<a href="#l12.1551"></a><span id="l12.1551">   return NS_OK;</span>
<a href="#l12.1552"></a><span id="l12.1552"> }</span>
<a href="#l12.1553"></a><span id="l12.1553"> </span>
<a href="#l12.1554"></a><span id="l12.1554"> /**</span>
<a href="#l12.1555"></a><span id="l12.1555">  * Show a Save All dialog allowing the user to pick which folder to save</span>
<a href="#l12.1556"></a><span id="l12.1556">  * messages to.</span>
<a href="#l12.1557"></a><span id="l12.1557">  * @param [out] aSaveDir directory to save to. Will be null on cancel.</span>
<a href="#l12.1558"></a><span id="l12.1558">  */</span>
<a href="#l12.1559"></a><span id="l12.1559" class="difflineminus">-nsresult</span>
<a href="#l12.1560"></a><span id="l12.1560" class="difflineminus">-nsMessenger::GetSaveToDir(nsIFile **aSaveDir)</span>
<a href="#l12.1561"></a><span id="l12.1561" class="difflineminus">-{</span>
<a href="#l12.1562"></a><span id="l12.1562" class="difflineplus">+nsresult nsMessenger::GetSaveToDir(nsIFile **aSaveDir) {</span>
<a href="#l12.1563"></a><span id="l12.1563">   nsresult rv;</span>
<a href="#l12.1564"></a><span id="l12.1564">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l12.1565"></a><span id="l12.1565" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1566"></a><span id="l12.1566" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l12.1567"></a><span id="l12.1567">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1568"></a><span id="l12.1568"> </span>
<a href="#l12.1569"></a><span id="l12.1569">   nsString chooseFolderStr;</span>
<a href="#l12.1570"></a><span id="l12.1570">   GetString(NS_LITERAL_STRING(&quot;ChooseFolder&quot;), chooseFolderStr);</span>
<a href="#l12.1571"></a><span id="l12.1571">   filePicker-&gt;Init(mWindow, chooseFolderStr, nsIFilePicker::modeGetFolder);</span>
<a href="#l12.1572"></a><span id="l12.1572"> </span>
<a href="#l12.1573"></a><span id="l12.1573">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l12.1574"></a><span id="l12.1574">   rv = GetLastSaveDirectory(getter_AddRefs(lastSaveDir));</span>
<a href="#l12.1575"></a><span id="l12.1575">   if (NS_SUCCEEDED(rv) &amp;&amp; lastSaveDir)</span>
<a href="#l12.1576"></a><span id="l12.1576">     filePicker-&gt;SetDisplayDirectory(lastSaveDir);</span>
<a href="#l12.1577"></a><span id="l12.1577"> </span>
<a href="#l12.1578"></a><span id="l12.1578">   int16_t dialogResult;</span>
<a href="#l12.1579"></a><span id="l12.1579">   rv = ShowPicker(filePicker, &amp;dialogResult);</span>
<a href="#l12.1580"></a><span id="l12.1580" class="difflineminus">-  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel)</span>
<a href="#l12.1581"></a><span id="l12.1581" class="difflineminus">-  {</span>
<a href="#l12.1582"></a><span id="l12.1582" class="difflineplus">+  if (NS_FAILED(rv) || dialogResult == nsIFilePicker::returnCancel) {</span>
<a href="#l12.1583"></a><span id="l12.1583">     // We'll indicate this by setting the outparam to null.</span>
<a href="#l12.1584"></a><span id="l12.1584">     *aSaveDir = nullptr;</span>
<a href="#l12.1585"></a><span id="l12.1585">     return NS_OK;</span>
<a href="#l12.1586"></a><span id="l12.1586">   }</span>
<a href="#l12.1587"></a><span id="l12.1587"> </span>
<a href="#l12.1588"></a><span id="l12.1588">   nsCOMPtr&lt;nsIFile&gt; dir;</span>
<a href="#l12.1589"></a><span id="l12.1589">   rv = filePicker-&gt;GetFile(getter_AddRefs(dir));</span>
<a href="#l12.1590"></a><span id="l12.1590">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1591"></a><span id="l12.1591" class="difflineat">@@ -1339,1703 +1240,1546 @@ nsMessenger::GetSaveToDir(nsIFile **aSav</span>
<a href="#l12.1592"></a><span id="l12.1592">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1593"></a><span id="l12.1593"> </span>
<a href="#l12.1594"></a><span id="l12.1594">   *aSaveDir = nullptr;</span>
<a href="#l12.1595"></a><span id="l12.1595">   dir.forget(aSaveDir);</span>
<a href="#l12.1596"></a><span id="l12.1596">   return NS_OK;</span>
<a href="#l12.1597"></a><span id="l12.1597"> }</span>
<a href="#l12.1598"></a><span id="l12.1598"> </span>
<a href="#l12.1599"></a><span id="l12.1599"> NS_IMETHODIMP</span>
<a href="#l12.1600"></a><span id="l12.1600" class="difflineminus">-nsMessenger::SaveMessages(uint32_t aCount,</span>
<a href="#l12.1601"></a><span id="l12.1601" class="difflineminus">-                          const char16_t **aFilenameArray,</span>
<a href="#l12.1602"></a><span id="l12.1602" class="difflineminus">-                          const char **aMessageUriArray)</span>
<a href="#l12.1603"></a><span id="l12.1603" class="difflineminus">-{</span>
<a href="#l12.1604"></a><span id="l12.1604" class="difflineplus">+nsMessenger::SaveMessages(uint32_t aCount, const char16_t **aFilenameArray,</span>
<a href="#l12.1605"></a><span id="l12.1605" class="difflineplus">+                          const char **aMessageUriArray) {</span>
<a href="#l12.1606"></a><span id="l12.1606">   NS_ENSURE_ARG_MIN(aCount, 1);</span>
<a href="#l12.1607"></a><span id="l12.1607">   NS_ENSURE_ARG_POINTER(aFilenameArray);</span>
<a href="#l12.1608"></a><span id="l12.1608">   NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l12.1609"></a><span id="l12.1609"> </span>
<a href="#l12.1610"></a><span id="l12.1610">   nsresult rv;</span>
<a href="#l12.1611"></a><span id="l12.1611"> </span>
<a href="#l12.1612"></a><span id="l12.1612">   nsCOMPtr&lt;nsIFile&gt; saveDir;</span>
<a href="#l12.1613"></a><span id="l12.1613">   rv = GetSaveToDir(getter_AddRefs(saveDir));</span>
<a href="#l12.1614"></a><span id="l12.1614">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1615"></a><span id="l12.1615" class="difflineminus">-  if (!saveDir) // A null saveDir means that the user canceled the save.</span>
<a href="#l12.1616"></a><span id="l12.1616" class="difflineplus">+  if (!saveDir)  // A null saveDir means that the user canceled the save.</span>
<a href="#l12.1617"></a><span id="l12.1617">     return NS_OK;</span>
<a href="#l12.1618"></a><span id="l12.1618"> </span>
<a href="#l12.1619"></a><span id="l12.1619">   for (uint32_t i = 0; i &lt; aCount; i++) {</span>
<a href="#l12.1620"></a><span id="l12.1620" class="difflineminus">-    if (!aFilenameArray[i]) // just to be sure</span>
<a href="#l12.1621"></a><span id="l12.1621" class="difflineplus">+    if (!aFilenameArray[i])  // just to be sure</span>
<a href="#l12.1622"></a><span id="l12.1622">       return NS_ERROR_FAILURE;</span>
<a href="#l12.1623"></a><span id="l12.1623"> </span>
<a href="#l12.1624"></a><span id="l12.1624" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; saveToFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1625"></a><span id="l12.1625" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; saveToFile =</span>
<a href="#l12.1626"></a><span id="l12.1626" class="difflineplus">+        do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1627"></a><span id="l12.1627">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1628"></a><span id="l12.1628">     rv = saveToFile-&gt;InitWithFile(saveDir);</span>
<a href="#l12.1629"></a><span id="l12.1629">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1630"></a><span id="l12.1630"> </span>
<a href="#l12.1631"></a><span id="l12.1631">     rv = saveToFile-&gt;Append(nsDependentString(aFilenameArray[i]));</span>
<a href="#l12.1632"></a><span id="l12.1632">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1633"></a><span id="l12.1633"> </span>
<a href="#l12.1634"></a><span id="l12.1634">     rv = AdjustFileIfNameTooLong(saveToFile);</span>
<a href="#l12.1635"></a><span id="l12.1635">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1636"></a><span id="l12.1636"> </span>
<a href="#l12.1637"></a><span id="l12.1637">     rv = PromptIfFileExists(saveToFile);</span>
<a href="#l12.1638"></a><span id="l12.1638" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.1639"></a><span id="l12.1639" class="difflineminus">-      continue;</span>
<a href="#l12.1640"></a><span id="l12.1640" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l12.1641"></a><span id="l12.1641"> </span>
<a href="#l12.1642"></a><span id="l12.1642">     nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.1643"></a><span id="l12.1643">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l12.1644"></a><span id="l12.1644"> </span>
<a href="#l12.1645"></a><span id="l12.1645">     rv = GetMessageServiceFromURI(nsDependentCString(aMessageUriArray[i]),</span>
<a href="#l12.1646"></a><span id="l12.1646">                                   getter_AddRefs(messageService));</span>
<a href="#l12.1647"></a><span id="l12.1647">     if (NS_FAILED(rv)) {</span>
<a href="#l12.1648"></a><span id="l12.1648">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.1649"></a><span id="l12.1649">       return rv;</span>
<a href="#l12.1650"></a><span id="l12.1650">     }</span>
<a href="#l12.1651"></a><span id="l12.1651"> </span>
<a href="#l12.1652"></a><span id="l12.1652" class="difflineminus">-    RefPtr&lt;nsSaveMsgListener&gt; saveListener = new nsSaveMsgListener(saveToFile, this, nullptr);</span>
<a href="#l12.1653"></a><span id="l12.1653" class="difflineplus">+    RefPtr&lt;nsSaveMsgListener&gt; saveListener =</span>
<a href="#l12.1654"></a><span id="l12.1654" class="difflineplus">+        new nsSaveMsgListener(saveToFile, this, nullptr);</span>
<a href="#l12.1655"></a><span id="l12.1655"> </span>
<a href="#l12.1656"></a><span id="l12.1656">     rv = saveListener-&gt;QueryInterface(NS_GET_IID(nsIUrlListener),</span>
<a href="#l12.1657"></a><span id="l12.1657">                                       getter_AddRefs(urlListener));</span>
<a href="#l12.1658"></a><span id="l12.1658">     if (NS_FAILED(rv)) {</span>
<a href="#l12.1659"></a><span id="l12.1659">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.1660"></a><span id="l12.1660">       return rv;</span>
<a href="#l12.1661"></a><span id="l12.1661">     }</span>
<a href="#l12.1662"></a><span id="l12.1662"> </span>
<a href="#l12.1663"></a><span id="l12.1663">     // Ok, now save the message.</span>
<a href="#l12.1664"></a><span id="l12.1664">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.1665"></a><span id="l12.1665" class="difflineminus">-    rv = messageService-&gt;SaveMessageToDisk(aMessageUriArray[i],</span>
<a href="#l12.1666"></a><span id="l12.1666" class="difflineminus">-                                           saveToFile, false,</span>
<a href="#l12.1667"></a><span id="l12.1667" class="difflineminus">-                                           urlListener, getter_AddRefs(dummyNull),</span>
<a href="#l12.1668"></a><span id="l12.1668" class="difflineminus">-                                           true, mMsgWindow);</span>
<a href="#l12.1669"></a><span id="l12.1669" class="difflineplus">+    rv = messageService-&gt;SaveMessageToDisk(</span>
<a href="#l12.1670"></a><span id="l12.1670" class="difflineplus">+        aMessageUriArray[i], saveToFile, false, urlListener,</span>
<a href="#l12.1671"></a><span id="l12.1671" class="difflineplus">+        getter_AddRefs(dummyNull), true, mMsgWindow);</span>
<a href="#l12.1672"></a><span id="l12.1672">     if (NS_FAILED(rv)) {</span>
<a href="#l12.1673"></a><span id="l12.1673">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.1674"></a><span id="l12.1674">       return rv;</span>
<a href="#l12.1675"></a><span id="l12.1675">     }</span>
<a href="#l12.1676"></a><span id="l12.1676">   }</span>
<a href="#l12.1677"></a><span id="l12.1677">   return rv;</span>
<a href="#l12.1678"></a><span id="l12.1678"> }</span>
<a href="#l12.1679"></a><span id="l12.1679"> </span>
<a href="#l12.1680"></a><span id="l12.1680" class="difflineminus">-nsresult</span>
<a href="#l12.1681"></a><span id="l12.1681" class="difflineminus">-nsMessenger::Alert(const char *stringName)</span>
<a href="#l12.1682"></a><span id="l12.1682" class="difflineminus">-{</span>
<a href="#l12.1683"></a><span id="l12.1683" class="difflineplus">+nsresult nsMessenger::Alert(const char *stringName) {</span>
<a href="#l12.1684"></a><span id="l12.1684">   nsresult rv = NS_OK;</span>
<a href="#l12.1685"></a><span id="l12.1685"> </span>
<a href="#l12.1686"></a><span id="l12.1686" class="difflineminus">-  if (mDocShell)</span>
<a href="#l12.1687"></a><span id="l12.1687" class="difflineminus">-  {</span>
<a href="#l12.1688"></a><span id="l12.1688" class="difflineplus">+  if (mDocShell) {</span>
<a href="#l12.1689"></a><span id="l12.1689">     nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(mDocShell));</span>
<a href="#l12.1690"></a><span id="l12.1690"> </span>
<a href="#l12.1691"></a><span id="l12.1691" class="difflineminus">-    if (dialog)</span>
<a href="#l12.1692"></a><span id="l12.1692" class="difflineminus">-    {</span>
<a href="#l12.1693"></a><span id="l12.1693" class="difflineplus">+    if (dialog) {</span>
<a href="#l12.1694"></a><span id="l12.1694">       nsString alertStr;</span>
<a href="#l12.1695"></a><span id="l12.1695">       GetString(NS_ConvertASCIItoUTF16(stringName), alertStr);</span>
<a href="#l12.1696"></a><span id="l12.1696">       rv = dialog-&gt;Alert(nullptr, alertStr.get());</span>
<a href="#l12.1697"></a><span id="l12.1697">     }</span>
<a href="#l12.1698"></a><span id="l12.1698">   }</span>
<a href="#l12.1699"></a><span id="l12.1699">   return rv;</span>
<a href="#l12.1700"></a><span id="l12.1700"> }</span>
<a href="#l12.1701"></a><span id="l12.1701"> </span>
<a href="#l12.1702"></a><span id="l12.1702"> NS_IMETHODIMP</span>
<a href="#l12.1703"></a><span id="l12.1703" class="difflineminus">-nsMessenger::MessageServiceFromURI(const nsACString&amp; aUri, nsIMsgMessageService **aMsgService)</span>
<a href="#l12.1704"></a><span id="l12.1704" class="difflineminus">-{</span>
<a href="#l12.1705"></a><span id="l12.1705" class="difflineplus">+nsMessenger::MessageServiceFromURI(const nsACString &amp;aUri,</span>
<a href="#l12.1706"></a><span id="l12.1706" class="difflineplus">+                                   nsIMsgMessageService **aMsgService) {</span>
<a href="#l12.1707"></a><span id="l12.1707">   NS_ENSURE_ARG_POINTER(aMsgService);</span>
<a href="#l12.1708"></a><span id="l12.1708">   return GetMessageServiceFromURI(aUri, aMsgService);</span>
<a href="#l12.1709"></a><span id="l12.1709"> }</span>
<a href="#l12.1710"></a><span id="l12.1710"> </span>
<a href="#l12.1711"></a><span id="l12.1711"> NS_IMETHODIMP</span>
<a href="#l12.1712"></a><span id="l12.1712" class="difflineminus">-nsMessenger::MsgHdrFromURI(const nsACString&amp; aUri, nsIMsgDBHdr **aMsgHdr)</span>
<a href="#l12.1713"></a><span id="l12.1713" class="difflineminus">-{</span>
<a href="#l12.1714"></a><span id="l12.1714" class="difflineplus">+nsMessenger::MsgHdrFromURI(const nsACString &amp;aUri, nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l12.1715"></a><span id="l12.1715">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l12.1716"></a><span id="l12.1716" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l12.1717"></a><span id="l12.1717" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l12.1718"></a><span id="l12.1718">   nsresult rv;</span>
<a href="#l12.1719"></a><span id="l12.1719"> </span>
<a href="#l12.1720"></a><span id="l12.1720" class="difflineminus">-</span>
<a href="#l12.1721"></a><span id="l12.1721" class="difflineminus">-  if (mMsgWindow &amp;&amp;</span>
<a href="#l12.1722"></a><span id="l12.1722" class="difflineminus">-      (StringBeginsWith(aUri, NS_LITERAL_CSTRING(&quot;file:&quot;)) ||</span>
<a href="#l12.1723"></a><span id="l12.1723" class="difflineminus">-       PromiseFlatCString(aUri).Find(&quot;type=application/x-message-display&quot;) &gt;= 0))</span>
<a href="#l12.1724"></a><span id="l12.1724" class="difflineminus">-  {</span>
<a href="#l12.1725"></a><span id="l12.1725" class="difflineminus">-    nsCOMPtr &lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.1726"></a><span id="l12.1726" class="difflineplus">+  if (mMsgWindow &amp;&amp; (StringBeginsWith(aUri, NS_LITERAL_CSTRING(&quot;file:&quot;)) ||</span>
<a href="#l12.1727"></a><span id="l12.1727" class="difflineplus">+                     PromiseFlatCString(aUri).Find(</span>
<a href="#l12.1728"></a><span id="l12.1728" class="difflineplus">+                         &quot;type=application/x-message-display&quot;) &gt;= 0)) {</span>
<a href="#l12.1729"></a><span id="l12.1729" class="difflineplus">+    nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.1730"></a><span id="l12.1730">     mMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l12.1731"></a><span id="l12.1731" class="difflineminus">-    if (headerSink)</span>
<a href="#l12.1732"></a><span id="l12.1732" class="difflineminus">-    {</span>
<a href="#l12.1733"></a><span id="l12.1733" class="difflineplus">+    if (headerSink) {</span>
<a href="#l12.1734"></a><span id="l12.1734">       rv = headerSink-&gt;GetDummyMsgHeader(aMsgHdr);</span>
<a href="#l12.1735"></a><span id="l12.1735">       // Is there a way to check if they're asking for the hdr currently</span>
<a href="#l12.1736"></a><span id="l12.1736">       // displayed in a stand-alone msg window from a .eml file?</span>
<a href="#l12.1737"></a><span id="l12.1737">       // (pretty likely if this is a file: uri)</span>
<a href="#l12.1738"></a><span id="l12.1738">       return rv;</span>
<a href="#l12.1739"></a><span id="l12.1739">     }</span>
<a href="#l12.1740"></a><span id="l12.1740">   }</span>
<a href="#l12.1741"></a><span id="l12.1741"> </span>
<a href="#l12.1742"></a><span id="l12.1742">   rv = GetMessageServiceFromURI(aUri, getter_AddRefs(msgService));</span>
<a href="#l12.1743"></a><span id="l12.1743">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1744"></a><span id="l12.1744" class="difflineminus">-  return msgService-&gt;MessageURIToMsgHdr(PromiseFlatCString(aUri).get(), aMsgHdr);</span>
<a href="#l12.1745"></a><span id="l12.1745" class="difflineplus">+  return msgService-&gt;MessageURIToMsgHdr(PromiseFlatCString(aUri).get(),</span>
<a href="#l12.1746"></a><span id="l12.1746" class="difflineplus">+                                        aMsgHdr);</span>
<a href="#l12.1747"></a><span id="l12.1747"> }</span>
<a href="#l12.1748"></a><span id="l12.1748"> </span>
<a href="#l12.1749"></a><span id="l12.1749" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetUndoTransactionType(uint32_t *txnType)</span>
<a href="#l12.1750"></a><span id="l12.1750" class="difflineminus">-{</span>
<a href="#l12.1751"></a><span id="l12.1751" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetUndoTransactionType(uint32_t *txnType) {</span>
<a href="#l12.1752"></a><span id="l12.1752">   NS_ENSURE_TRUE(txnType &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1753"></a><span id="l12.1753"> </span>
<a href="#l12.1754"></a><span id="l12.1754">   nsresult rv;</span>
<a href="#l12.1755"></a><span id="l12.1755">   *txnType = nsMessenger::eUnknown;</span>
<a href="#l12.1756"></a><span id="l12.1756">   nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1757"></a><span id="l12.1757">   rv = mTxnMgr-&gt;PeekUndoStack(getter_AddRefs(txn));</span>
<a href="#l12.1758"></a><span id="l12.1758" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; txn)</span>
<a href="#l12.1759"></a><span id="l12.1759" class="difflineminus">-  {</span>
<a href="#l12.1760"></a><span id="l12.1760" class="difflineminus">-    nsCOMPtr &lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l12.1761"></a><span id="l12.1761" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l12.1762"></a><span id="l12.1762" class="difflineplus">+    nsCOMPtr&lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l12.1763"></a><span id="l12.1763">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1764"></a><span id="l12.1764">     return propertyBag-&gt;GetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l12.1765"></a><span id="l12.1765">   }</span>
<a href="#l12.1766"></a><span id="l12.1766">   return rv;</span>
<a href="#l12.1767"></a><span id="l12.1767"> }</span>
<a href="#l12.1768"></a><span id="l12.1768"> </span>
<a href="#l12.1769"></a><span id="l12.1769" class="difflineminus">-NS_IMETHODIMP nsMessenger::CanUndo(bool *bValue)</span>
<a href="#l12.1770"></a><span id="l12.1770" class="difflineminus">-{</span>
<a href="#l12.1771"></a><span id="l12.1771" class="difflineplus">+NS_IMETHODIMP nsMessenger::CanUndo(bool *bValue) {</span>
<a href="#l12.1772"></a><span id="l12.1772">   NS_ENSURE_TRUE(bValue &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1773"></a><span id="l12.1773"> </span>
<a href="#l12.1774"></a><span id="l12.1774">   nsresult rv;</span>
<a href="#l12.1775"></a><span id="l12.1775">   *bValue = false;</span>
<a href="#l12.1776"></a><span id="l12.1776">   int32_t count = 0;</span>
<a href="#l12.1777"></a><span id="l12.1777">   rv = mTxnMgr-&gt;GetNumberOfUndoItems(&amp;count);</span>
<a href="#l12.1778"></a><span id="l12.1778" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0)</span>
<a href="#l12.1779"></a><span id="l12.1779" class="difflineminus">-    *bValue = true;</span>
<a href="#l12.1780"></a><span id="l12.1780" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0) *bValue = true;</span>
<a href="#l12.1781"></a><span id="l12.1781">   return rv;</span>
<a href="#l12.1782"></a><span id="l12.1782"> }</span>
<a href="#l12.1783"></a><span id="l12.1783"> </span>
<a href="#l12.1784"></a><span id="l12.1784" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetRedoTransactionType(uint32_t *txnType)</span>
<a href="#l12.1785"></a><span id="l12.1785" class="difflineminus">-{</span>
<a href="#l12.1786"></a><span id="l12.1786" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetRedoTransactionType(uint32_t *txnType) {</span>
<a href="#l12.1787"></a><span id="l12.1787">   NS_ENSURE_TRUE(txnType &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1788"></a><span id="l12.1788"> </span>
<a href="#l12.1789"></a><span id="l12.1789">   nsresult rv;</span>
<a href="#l12.1790"></a><span id="l12.1790">   *txnType = nsMessenger::eUnknown;</span>
<a href="#l12.1791"></a><span id="l12.1791">   nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1792"></a><span id="l12.1792">   rv = mTxnMgr-&gt;PeekRedoStack(getter_AddRefs(txn));</span>
<a href="#l12.1793"></a><span id="l12.1793" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; txn)</span>
<a href="#l12.1794"></a><span id="l12.1794" class="difflineminus">-  {</span>
<a href="#l12.1795"></a><span id="l12.1795" class="difflineminus">-    nsCOMPtr &lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l12.1796"></a><span id="l12.1796" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l12.1797"></a><span id="l12.1797" class="difflineplus">+    nsCOMPtr&lt;nsIPropertyBag2&gt; propertyBag = do_QueryInterface(txn, &amp;rv);</span>
<a href="#l12.1798"></a><span id="l12.1798">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1799"></a><span id="l12.1799">     return propertyBag-&gt;GetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l12.1800"></a><span id="l12.1800">   }</span>
<a href="#l12.1801"></a><span id="l12.1801">   return rv;</span>
<a href="#l12.1802"></a><span id="l12.1802"> }</span>
<a href="#l12.1803"></a><span id="l12.1803"> </span>
<a href="#l12.1804"></a><span id="l12.1804" class="difflineminus">-NS_IMETHODIMP nsMessenger::CanRedo(bool *bValue)</span>
<a href="#l12.1805"></a><span id="l12.1805" class="difflineminus">-{</span>
<a href="#l12.1806"></a><span id="l12.1806" class="difflineplus">+NS_IMETHODIMP nsMessenger::CanRedo(bool *bValue) {</span>
<a href="#l12.1807"></a><span id="l12.1807">   NS_ENSURE_TRUE(bValue &amp;&amp; mTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1808"></a><span id="l12.1808"> </span>
<a href="#l12.1809"></a><span id="l12.1809">   nsresult rv;</span>
<a href="#l12.1810"></a><span id="l12.1810">   *bValue = false;</span>
<a href="#l12.1811"></a><span id="l12.1811">   int32_t count = 0;</span>
<a href="#l12.1812"></a><span id="l12.1812">   rv = mTxnMgr-&gt;GetNumberOfRedoItems(&amp;count);</span>
<a href="#l12.1813"></a><span id="l12.1813" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0)</span>
<a href="#l12.1814"></a><span id="l12.1814" class="difflineminus">-    *bValue = true;</span>
<a href="#l12.1815"></a><span id="l12.1815" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0) *bValue = true;</span>
<a href="#l12.1816"></a><span id="l12.1816">   return rv;</span>
<a href="#l12.1817"></a><span id="l12.1817"> }</span>
<a href="#l12.1818"></a><span id="l12.1818"> </span>
<a href="#l12.1819"></a><span id="l12.1819"> NS_IMETHODIMP</span>
<a href="#l12.1820"></a><span id="l12.1820" class="difflineminus">-nsMessenger::Undo(nsIMsgWindow *msgWindow)</span>
<a href="#l12.1821"></a><span id="l12.1821" class="difflineminus">-{</span>
<a href="#l12.1822"></a><span id="l12.1822" class="difflineplus">+nsMessenger::Undo(nsIMsgWindow *msgWindow) {</span>
<a href="#l12.1823"></a><span id="l12.1823">   nsresult rv = NS_OK;</span>
<a href="#l12.1824"></a><span id="l12.1824" class="difflineminus">-  if (mTxnMgr)</span>
<a href="#l12.1825"></a><span id="l12.1825" class="difflineminus">-  {</span>
<a href="#l12.1826"></a><span id="l12.1826" class="difflineplus">+  if (mTxnMgr) {</span>
<a href="#l12.1827"></a><span id="l12.1827">     int32_t numTxn = 0;</span>
<a href="#l12.1828"></a><span id="l12.1828">     rv = mTxnMgr-&gt;GetNumberOfUndoItems(&amp;numTxn);</span>
<a href="#l12.1829"></a><span id="l12.1829" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; numTxn &gt; 0)</span>
<a href="#l12.1830"></a><span id="l12.1830" class="difflineminus">-    {</span>
<a href="#l12.1831"></a><span id="l12.1831" class="difflineminus">-        nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1832"></a><span id="l12.1832" class="difflineminus">-        rv = mTxnMgr-&gt;PeekUndoStack(getter_AddRefs(txn));</span>
<a href="#l12.1833"></a><span id="l12.1833" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; txn)</span>
<a href="#l12.1834"></a><span id="l12.1834" class="difflineminus">-        {</span>
<a href="#l12.1835"></a><span id="l12.1835" class="difflineminus">-            static_cast&lt;nsMsgTxn*&gt;(static_cast&lt;nsITransaction*&gt;(txn.get()))-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l12.1836"></a><span id="l12.1836" class="difflineminus">-        }</span>
<a href="#l12.1837"></a><span id="l12.1837" class="difflineminus">-        mTxnMgr-&gt;UndoTransaction();</span>
<a href="#l12.1838"></a><span id="l12.1838" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; numTxn &gt; 0) {</span>
<a href="#l12.1839"></a><span id="l12.1839" class="difflineplus">+      nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1840"></a><span id="l12.1840" class="difflineplus">+      rv = mTxnMgr-&gt;PeekUndoStack(getter_AddRefs(txn));</span>
<a href="#l12.1841"></a><span id="l12.1841" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l12.1842"></a><span id="l12.1842" class="difflineplus">+        static_cast&lt;nsMsgTxn *&gt;(static_cast&lt;nsITransaction *&gt;(txn.get()))</span>
<a href="#l12.1843"></a><span id="l12.1843" class="difflineplus">+            -&gt;SetMsgWindow(msgWindow);</span>
<a href="#l12.1844"></a><span id="l12.1844" class="difflineplus">+      }</span>
<a href="#l12.1845"></a><span id="l12.1845" class="difflineplus">+      mTxnMgr-&gt;UndoTransaction();</span>
<a href="#l12.1846"></a><span id="l12.1846">     }</span>
<a href="#l12.1847"></a><span id="l12.1847">   }</span>
<a href="#l12.1848"></a><span id="l12.1848">   return rv;</span>
<a href="#l12.1849"></a><span id="l12.1849"> }</span>
<a href="#l12.1850"></a><span id="l12.1850"> </span>
<a href="#l12.1851"></a><span id="l12.1851"> NS_IMETHODIMP</span>
<a href="#l12.1852"></a><span id="l12.1852" class="difflineminus">-nsMessenger::Redo(nsIMsgWindow *msgWindow)</span>
<a href="#l12.1853"></a><span id="l12.1853" class="difflineminus">-{</span>
<a href="#l12.1854"></a><span id="l12.1854" class="difflineplus">+nsMessenger::Redo(nsIMsgWindow *msgWindow) {</span>
<a href="#l12.1855"></a><span id="l12.1855">   nsresult rv = NS_OK;</span>
<a href="#l12.1856"></a><span id="l12.1856" class="difflineminus">-  if (mTxnMgr)</span>
<a href="#l12.1857"></a><span id="l12.1857" class="difflineminus">-  {</span>
<a href="#l12.1858"></a><span id="l12.1858" class="difflineplus">+  if (mTxnMgr) {</span>
<a href="#l12.1859"></a><span id="l12.1859">     int32_t numTxn = 0;</span>
<a href="#l12.1860"></a><span id="l12.1860">     rv = mTxnMgr-&gt;GetNumberOfRedoItems(&amp;numTxn);</span>
<a href="#l12.1861"></a><span id="l12.1861" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; numTxn &gt; 0)</span>
<a href="#l12.1862"></a><span id="l12.1862" class="difflineminus">-    {</span>
<a href="#l12.1863"></a><span id="l12.1863" class="difflineminus">-        nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1864"></a><span id="l12.1864" class="difflineminus">-        rv = mTxnMgr-&gt;PeekRedoStack(getter_AddRefs(txn));</span>
<a href="#l12.1865"></a><span id="l12.1865" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; txn)</span>
<a href="#l12.1866"></a><span id="l12.1866" class="difflineminus">-        {</span>
<a href="#l12.1867"></a><span id="l12.1867" class="difflineminus">-            static_cast&lt;nsMsgTxn*&gt;(static_cast&lt;nsITransaction*&gt;(txn.get()))-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l12.1868"></a><span id="l12.1868" class="difflineminus">-        }</span>
<a href="#l12.1869"></a><span id="l12.1869" class="difflineminus">-        mTxnMgr-&gt;RedoTransaction();</span>
<a href="#l12.1870"></a><span id="l12.1870" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; numTxn &gt; 0) {</span>
<a href="#l12.1871"></a><span id="l12.1871" class="difflineplus">+      nsCOMPtr&lt;nsITransaction&gt; txn;</span>
<a href="#l12.1872"></a><span id="l12.1872" class="difflineplus">+      rv = mTxnMgr-&gt;PeekRedoStack(getter_AddRefs(txn));</span>
<a href="#l12.1873"></a><span id="l12.1873" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; txn) {</span>
<a href="#l12.1874"></a><span id="l12.1874" class="difflineplus">+        static_cast&lt;nsMsgTxn *&gt;(static_cast&lt;nsITransaction *&gt;(txn.get()))</span>
<a href="#l12.1875"></a><span id="l12.1875" class="difflineplus">+            -&gt;SetMsgWindow(msgWindow);</span>
<a href="#l12.1876"></a><span id="l12.1876" class="difflineplus">+      }</span>
<a href="#l12.1877"></a><span id="l12.1877" class="difflineplus">+      mTxnMgr-&gt;RedoTransaction();</span>
<a href="#l12.1878"></a><span id="l12.1878">     }</span>
<a href="#l12.1879"></a><span id="l12.1879">   }</span>
<a href="#l12.1880"></a><span id="l12.1880">   return rv;</span>
<a href="#l12.1881"></a><span id="l12.1881"> }</span>
<a href="#l12.1882"></a><span id="l12.1882"> </span>
<a href="#l12.1883"></a><span id="l12.1883"> NS_IMETHODIMP</span>
<a href="#l12.1884"></a><span id="l12.1884" class="difflineminus">-nsMessenger::GetTransactionManager(nsITransactionManager* *aTxnMgr)</span>
<a href="#l12.1885"></a><span id="l12.1885" class="difflineminus">-{</span>
<a href="#l12.1886"></a><span id="l12.1886" class="difflineplus">+nsMessenger::GetTransactionManager(nsITransactionManager **aTxnMgr) {</span>
<a href="#l12.1887"></a><span id="l12.1887">   NS_ENSURE_TRUE(mTxnMgr &amp;&amp; aTxnMgr, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1888"></a><span id="l12.1888">   NS_ADDREF(*aTxnMgr = mTxnMgr);</span>
<a href="#l12.1889"></a><span id="l12.1889">   return NS_OK;</span>
<a href="#l12.1890"></a><span id="l12.1890"> }</span>
<a href="#l12.1891"></a><span id="l12.1891"> </span>
<a href="#l12.1892"></a><span id="l12.1892" class="difflineminus">-NS_IMETHODIMP nsMessenger::SetDocumentCharset(const nsACString&amp; aCharacterSet)</span>
<a href="#l12.1893"></a><span id="l12.1893" class="difflineminus">-{</span>
<a href="#l12.1894"></a><span id="l12.1894" class="difflineminus">-  // We want to redisplay the currently selected message (if any) but forcing the</span>
<a href="#l12.1895"></a><span id="l12.1895" class="difflineminus">-  // redisplay to use characterSet</span>
<a href="#l12.1896"></a><span id="l12.1896" class="difflineminus">-  if (!mLastDisplayURI.IsEmpty())</span>
<a href="#l12.1897"></a><span id="l12.1897" class="difflineminus">-  {</span>
<a href="#l12.1898"></a><span id="l12.1898" class="difflineplus">+NS_IMETHODIMP nsMessenger::SetDocumentCharset(const nsACString &amp;aCharacterSet) {</span>
<a href="#l12.1899"></a><span id="l12.1899" class="difflineplus">+  // We want to redisplay the currently selected message (if any) but forcing</span>
<a href="#l12.1900"></a><span id="l12.1900" class="difflineplus">+  // the redisplay to use characterSet</span>
<a href="#l12.1901"></a><span id="l12.1901" class="difflineplus">+  if (!mLastDisplayURI.IsEmpty()) {</span>
<a href="#l12.1902"></a><span id="l12.1902">     SetDisplayCharset(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l12.1903"></a><span id="l12.1903"> </span>
<a href="#l12.1904"></a><span id="l12.1904" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.1905"></a><span id="l12.1905" class="difflineminus">-    nsresult rv = GetMessageServiceFromURI(mLastDisplayURI, getter_AddRefs(messageService));</span>
<a href="#l12.1906"></a><span id="l12.1906" class="difflineminus">-</span>
<a href="#l12.1907"></a><span id="l12.1907" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; messageService)</span>
<a href="#l12.1908"></a><span id="l12.1908" class="difflineminus">-    {</span>
<a href="#l12.1909"></a><span id="l12.1909" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l12.1910"></a><span id="l12.1910" class="difflineplus">+    nsresult rv = GetMessageServiceFromURI(mLastDisplayURI,</span>
<a href="#l12.1911"></a><span id="l12.1911" class="difflineplus">+                                           getter_AddRefs(messageService));</span>
<a href="#l12.1912"></a><span id="l12.1912" class="difflineplus">+</span>
<a href="#l12.1913"></a><span id="l12.1913" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l12.1914"></a><span id="l12.1914">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.1915"></a><span id="l12.1915" class="difflineminus">-      messageService-&gt;DisplayMessage(mLastDisplayURI.get(), mDocShell, mMsgWindow, nullptr,</span>
<a href="#l12.1916"></a><span id="l12.1916" class="difflineminus">-                                     PromiseFlatCString(aCharacterSet).get(), getter_AddRefs(dummyNull));</span>
<a href="#l12.1917"></a><span id="l12.1917" class="difflineplus">+      messageService-&gt;DisplayMessage(</span>
<a href="#l12.1918"></a><span id="l12.1918" class="difflineplus">+          mLastDisplayURI.get(), mDocShell, mMsgWindow, nullptr,</span>
<a href="#l12.1919"></a><span id="l12.1919" class="difflineplus">+          PromiseFlatCString(aCharacterSet).get(), getter_AddRefs(dummyNull));</span>
<a href="#l12.1920"></a><span id="l12.1920">     }</span>
<a href="#l12.1921"></a><span id="l12.1921">   }</span>
<a href="#l12.1922"></a><span id="l12.1922"> </span>
<a href="#l12.1923"></a><span id="l12.1923">   return NS_OK;</span>
<a href="#l12.1924"></a><span id="l12.1924"> }</span>
<a href="#l12.1925"></a><span id="l12.1925"> </span>
<a href="#l12.1926"></a><span id="l12.1926"> NS_IMETHODIMP</span>
<a href="#l12.1927"></a><span id="l12.1927" class="difflineminus">-nsMessenger::GetLastDisplayedMessageUri(nsACString&amp; aLastDisplayedMessageUri)</span>
<a href="#l12.1928"></a><span id="l12.1928" class="difflineminus">-{</span>
<a href="#l12.1929"></a><span id="l12.1929" class="difflineplus">+nsMessenger::GetLastDisplayedMessageUri(nsACString &amp;aLastDisplayedMessageUri) {</span>
<a href="#l12.1930"></a><span id="l12.1930">   aLastDisplayedMessageUri = mLastDisplayURI;</span>
<a href="#l12.1931"></a><span id="l12.1931">   return NS_OK;</span>
<a href="#l12.1932"></a><span id="l12.1932"> }</span>
<a href="#l12.1933"></a><span id="l12.1933"> </span>
<a href="#l12.1934"></a><span id="l12.1934" class="difflineminus">-nsSaveMsgListener::nsSaveMsgListener(nsIFile* aFile, nsMessenger *aMessenger, nsIUrlListener *aListener)</span>
<a href="#l12.1935"></a><span id="l12.1935" class="difflineminus">-{</span>
<a href="#l12.1936"></a><span id="l12.1936" class="difflineplus">+nsSaveMsgListener::nsSaveMsgListener(nsIFile *aFile, nsMessenger *aMessenger,</span>
<a href="#l12.1937"></a><span id="l12.1937" class="difflineplus">+                                     nsIUrlListener *aListener) {</span>
<a href="#l12.1938"></a><span id="l12.1938">   m_file = aFile;</span>
<a href="#l12.1939"></a><span id="l12.1939">   m_messenger = aMessenger;</span>
<a href="#l12.1940"></a><span id="l12.1940">   mListener = aListener;</span>
<a href="#l12.1941"></a><span id="l12.1941">   mUrlHasStopped = false;</span>
<a href="#l12.1942"></a><span id="l12.1942">   mRequestHasStopped = false;</span>
<a href="#l12.1943"></a><span id="l12.1943"> </span>
<a href="#l12.1944"></a><span id="l12.1944" class="difflineminus">-    // rhp: for charset handling</span>
<a href="#l12.1945"></a><span id="l12.1945" class="difflineplus">+  // rhp: for charset handling</span>
<a href="#l12.1946"></a><span id="l12.1946">   m_doCharsetConversion = false;</span>
<a href="#l12.1947"></a><span id="l12.1947">   m_saveAllAttachmentsState = nullptr;</span>
<a href="#l12.1948"></a><span id="l12.1948">   mProgress = 0;</span>
<a href="#l12.1949"></a><span id="l12.1949">   mMaxProgress = -1;</span>
<a href="#l12.1950"></a><span id="l12.1950">   mCanceled = false;</span>
<a href="#l12.1951"></a><span id="l12.1951">   m_outputFormat = eUnknown;</span>
<a href="#l12.1952"></a><span id="l12.1952">   mInitialized = false;</span>
<a href="#l12.1953"></a><span id="l12.1953"> }</span>
<a href="#l12.1954"></a><span id="l12.1954"> </span>
<a href="#l12.1955"></a><span id="l12.1955" class="difflineminus">-nsSaveMsgListener::~nsSaveMsgListener()</span>
<a href="#l12.1956"></a><span id="l12.1956" class="difflineminus">-{</span>
<a href="#l12.1957"></a><span id="l12.1957" class="difflineminus">-}</span>
<a href="#l12.1958"></a><span id="l12.1958" class="difflineplus">+nsSaveMsgListener::~nsSaveMsgListener() {}</span>
<a href="#l12.1959"></a><span id="l12.1959"> </span>
<a href="#l12.1960"></a><span id="l12.1960"> //</span>
<a href="#l12.1961"></a><span id="l12.1961"> // nsISupports</span>
<a href="#l12.1962"></a><span id="l12.1962"> //</span>
<a href="#l12.1963"></a><span id="l12.1963" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSaveMsgListener,</span>
<a href="#l12.1964"></a><span id="l12.1964" class="difflineminus">-                   nsIUrlListener,</span>
<a href="#l12.1965"></a><span id="l12.1965" class="difflineminus">-                   nsIMsgCopyServiceListener,</span>
<a href="#l12.1966"></a><span id="l12.1966" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l12.1967"></a><span id="l12.1967" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l12.1968"></a><span id="l12.1968" class="difflineminus">-                   nsICancelable)</span>
<a href="#l12.1969"></a><span id="l12.1969" class="difflineplus">+NS_IMPL_ISUPPORTS(nsSaveMsgListener, nsIUrlListener, nsIMsgCopyServiceListener,</span>
<a href="#l12.1970"></a><span id="l12.1970" class="difflineplus">+                  nsIStreamListener, nsIRequestObserver, nsICancelable)</span>
<a href="#l12.1971"></a><span id="l12.1971"> </span>
<a href="#l12.1972"></a><span id="l12.1972"> NS_IMETHODIMP</span>
<a href="#l12.1973"></a><span id="l12.1973" class="difflineminus">-nsSaveMsgListener::Cancel(nsresult status)</span>
<a href="#l12.1974"></a><span id="l12.1974" class="difflineminus">-{</span>
<a href="#l12.1975"></a><span id="l12.1975" class="difflineplus">+nsSaveMsgListener::Cancel(nsresult status) {</span>
<a href="#l12.1976"></a><span id="l12.1976">   mCanceled = true;</span>
<a href="#l12.1977"></a><span id="l12.1977">   return NS_OK;</span>
<a href="#l12.1978"></a><span id="l12.1978"> }</span>
<a href="#l12.1979"></a><span id="l12.1979"> </span>
<a href="#l12.1980"></a><span id="l12.1980"> //</span>
<a href="#l12.1981"></a><span id="l12.1981"> // nsIUrlListener</span>
<a href="#l12.1982"></a><span id="l12.1982"> //</span>
<a href="#l12.1983"></a><span id="l12.1983"> NS_IMETHODIMP</span>
<a href="#l12.1984"></a><span id="l12.1984" class="difflineminus">-nsSaveMsgListener::OnStartRunningUrl(nsIURI* url)</span>
<a href="#l12.1985"></a><span id="l12.1985" class="difflineminus">-{</span>
<a href="#l12.1986"></a><span id="l12.1986" class="difflineminus">-  if (mListener)</span>
<a href="#l12.1987"></a><span id="l12.1987" class="difflineminus">-    mListener-&gt;OnStartRunningUrl(url);</span>
<a href="#l12.1988"></a><span id="l12.1988" class="difflineplus">+nsSaveMsgListener::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l12.1989"></a><span id="l12.1989" class="difflineplus">+  if (mListener) mListener-&gt;OnStartRunningUrl(url);</span>
<a href="#l12.1990"></a><span id="l12.1990">   return NS_OK;</span>
<a href="#l12.1991"></a><span id="l12.1991"> }</span>
<a href="#l12.1992"></a><span id="l12.1992"> </span>
<a href="#l12.1993"></a><span id="l12.1993"> NS_IMETHODIMP</span>
<a href="#l12.1994"></a><span id="l12.1994" class="difflineminus">-nsSaveMsgListener::OnStopRunningUrl(nsIURI *url, nsresult exitCode)</span>
<a href="#l12.1995"></a><span id="l12.1995" class="difflineminus">-{</span>
<a href="#l12.1996"></a><span id="l12.1996" class="difflineplus">+nsSaveMsgListener::OnStopRunningUrl(nsIURI *url, nsresult exitCode) {</span>
<a href="#l12.1997"></a><span id="l12.1997">   nsresult rv = exitCode;</span>
<a href="#l12.1998"></a><span id="l12.1998">   mUrlHasStopped = true;</span>
<a href="#l12.1999"></a><span id="l12.1999"> </span>
<a href="#l12.2000"></a><span id="l12.2000">   // ** save as template goes here</span>
<a href="#l12.2001"></a><span id="l12.2001" class="difflineminus">-  if (!m_templateUri.IsEmpty())</span>
<a href="#l12.2002"></a><span id="l12.2002" class="difflineminus">-  {</span>
<a href="#l12.2003"></a><span id="l12.2003" class="difflineplus">+  if (!m_templateUri.IsEmpty()) {</span>
<a href="#l12.2004"></a><span id="l12.2004">     nsCOMPtr&lt;nsIMsgFolder&gt; templateFolder;</span>
<a href="#l12.2005"></a><span id="l12.2005">     rv = GetOrCreateFolder(m_templateUri, getter_AddRefs(templateFolder));</span>
<a href="#l12.2006"></a><span id="l12.2006">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.2007"></a><span id="l12.2007" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l12.2008"></a><span id="l12.2008" class="difflineminus">-    if (copyService)</span>
<a href="#l12.2009"></a><span id="l12.2009" class="difflineminus">-    {</span>
<a href="#l12.2010"></a><span id="l12.2010" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l12.2011"></a><span id="l12.2011" class="difflineplus">+        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l12.2012"></a><span id="l12.2012" class="difflineplus">+    if (copyService) {</span>
<a href="#l12.2013"></a><span id="l12.2013">       nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l12.2014"></a><span id="l12.2014">       m_file-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l12.2015"></a><span id="l12.2015" class="difflineminus">-      rv = copyService-&gt;CopyFileMessage(clone, templateFolder, nullptr,</span>
<a href="#l12.2016"></a><span id="l12.2016" class="difflineminus">-                                        true, nsMsgMessageFlags::Read,</span>
<a href="#l12.2017"></a><span id="l12.2017" class="difflineminus">-                                        EmptyCString(), this, nullptr);</span>
<a href="#l12.2018"></a><span id="l12.2018" class="difflineplus">+      rv = copyService-&gt;CopyFileMessage(clone, templateFolder, nullptr, true,</span>
<a href="#l12.2019"></a><span id="l12.2019" class="difflineplus">+                                        nsMsgMessageFlags::Read, EmptyCString(),</span>
<a href="#l12.2020"></a><span id="l12.2020" class="difflineplus">+                                        this, nullptr);</span>
<a href="#l12.2021"></a><span id="l12.2021">       // Clear this so we don't end up in a loop if OnStopRunningUrl gets</span>
<a href="#l12.2022"></a><span id="l12.2022">       // called again.</span>
<a href="#l12.2023"></a><span id="l12.2023">       m_templateUri.Truncate();</span>
<a href="#l12.2024"></a><span id="l12.2024">     }</span>
<a href="#l12.2025"></a><span id="l12.2025" class="difflineminus">-  }</span>
<a href="#l12.2026"></a><span id="l12.2026" class="difflineminus">-  else if (m_outputStream &amp;&amp; mRequestHasStopped)</span>
<a href="#l12.2027"></a><span id="l12.2027" class="difflineminus">-  {</span>
<a href="#l12.2028"></a><span id="l12.2028" class="difflineplus">+  } else if (m_outputStream &amp;&amp; mRequestHasStopped) {</span>
<a href="#l12.2029"></a><span id="l12.2029">     m_outputStream-&gt;Close();</span>
<a href="#l12.2030"></a><span id="l12.2030">     m_outputStream = nullptr;</span>
<a href="#l12.2031"></a><span id="l12.2031">   }</span>
<a href="#l12.2032"></a><span id="l12.2032"> </span>
<a href="#l12.2033"></a><span id="l12.2033"> done:</span>
<a href="#l12.2034"></a><span id="l12.2034" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.2035"></a><span id="l12.2035" class="difflineminus">-  {</span>
<a href="#l12.2036"></a><span id="l12.2036" class="difflineminus">-    if (m_file)</span>
<a href="#l12.2037"></a><span id="l12.2037" class="difflineminus">-      m_file-&gt;Remove(false);</span>
<a href="#l12.2038"></a><span id="l12.2038" class="difflineminus">-    if (m_messenger)</span>
<a href="#l12.2039"></a><span id="l12.2039" class="difflineminus">-        m_messenger-&gt;Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.2040"></a><span id="l12.2040" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.2041"></a><span id="l12.2041" class="difflineplus">+    if (m_file) m_file-&gt;Remove(false);</span>
<a href="#l12.2042"></a><span id="l12.2042" class="difflineplus">+    if (m_messenger) m_messenger-&gt;Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l12.2043"></a><span id="l12.2043">   }</span>
<a href="#l12.2044"></a><span id="l12.2044"> </span>
<a href="#l12.2045"></a><span id="l12.2045">   if (mRequestHasStopped &amp;&amp; mListener)</span>
<a href="#l12.2046"></a><span id="l12.2046">     mListener-&gt;OnStopRunningUrl(url, exitCode);</span>
<a href="#l12.2047"></a><span id="l12.2047">   else</span>
<a href="#l12.2048"></a><span id="l12.2048">     mListenerUri = url;</span>
<a href="#l12.2049"></a><span id="l12.2049"> </span>
<a href="#l12.2050"></a><span id="l12.2050">   return rv;</span>
<a href="#l12.2051"></a><span id="l12.2051"> }</span>
<a href="#l12.2052"></a><span id="l12.2052"> </span>
<a href="#l12.2053"></a><span id="l12.2053"> NS_IMETHODIMP</span>
<a href="#l12.2054"></a><span id="l12.2054" class="difflineminus">-nsSaveMsgListener::OnStartCopy(void)</span>
<a href="#l12.2055"></a><span id="l12.2055" class="difflineminus">-{</span>
<a href="#l12.2056"></a><span id="l12.2056" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.2057"></a><span id="l12.2057" class="difflineminus">-}</span>
<a href="#l12.2058"></a><span id="l12.2058" class="difflineplus">+nsSaveMsgListener::OnStartCopy(void) { return NS_OK; }</span>
<a href="#l12.2059"></a><span id="l12.2059"> </span>
<a href="#l12.2060"></a><span id="l12.2060"> NS_IMETHODIMP</span>
<a href="#l12.2061"></a><span id="l12.2061" class="difflineminus">-nsSaveMsgListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l12.2062"></a><span id="l12.2062" class="difflineminus">-{</span>
<a href="#l12.2063"></a><span id="l12.2063" class="difflineplus">+nsSaveMsgListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax) {</span>
<a href="#l12.2064"></a><span id="l12.2064">   return NS_OK;</span>
<a href="#l12.2065"></a><span id="l12.2065"> }</span>
<a href="#l12.2066"></a><span id="l12.2066"> </span>
<a href="#l12.2067"></a><span id="l12.2067"> NS_IMETHODIMP</span>
<a href="#l12.2068"></a><span id="l12.2068" class="difflineminus">-nsSaveMsgListener::SetMessageKey(nsMsgKey aKey)</span>
<a href="#l12.2069"></a><span id="l12.2069" class="difflineminus">-{</span>
<a href="#l12.2070"></a><span id="l12.2070" class="difflineplus">+nsSaveMsgListener::SetMessageKey(nsMsgKey aKey) {</span>
<a href="#l12.2071"></a><span id="l12.2071">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2072"></a><span id="l12.2072"> }</span>
<a href="#l12.2073"></a><span id="l12.2073"> </span>
<a href="#l12.2074"></a><span id="l12.2074"> NS_IMETHODIMP</span>
<a href="#l12.2075"></a><span id="l12.2075" class="difflineminus">-nsSaveMsgListener::GetMessageId(nsACString&amp; aMessageId)</span>
<a href="#l12.2076"></a><span id="l12.2076" class="difflineminus">-{</span>
<a href="#l12.2077"></a><span id="l12.2077" class="difflineplus">+nsSaveMsgListener::GetMessageId(nsACString &amp;aMessageId) {</span>
<a href="#l12.2078"></a><span id="l12.2078">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2079"></a><span id="l12.2079"> }</span>
<a href="#l12.2080"></a><span id="l12.2080"> </span>
<a href="#l12.2081"></a><span id="l12.2081"> NS_IMETHODIMP</span>
<a href="#l12.2082"></a><span id="l12.2082" class="difflineminus">-nsSaveMsgListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l12.2083"></a><span id="l12.2083" class="difflineminus">-{</span>
<a href="#l12.2084"></a><span id="l12.2084" class="difflineminus">-  if (m_file)</span>
<a href="#l12.2085"></a><span id="l12.2085" class="difflineminus">-    m_file-&gt;Remove(false);</span>
<a href="#l12.2086"></a><span id="l12.2086" class="difflineplus">+nsSaveMsgListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l12.2087"></a><span id="l12.2087" class="difflineplus">+  if (m_file) m_file-&gt;Remove(false);</span>
<a href="#l12.2088"></a><span id="l12.2088">   return aStatus;</span>
<a href="#l12.2089"></a><span id="l12.2089"> }</span>
<a href="#l12.2090"></a><span id="l12.2090"> </span>
<a href="#l12.2091"></a><span id="l12.2091"> // initializes the progress window if we are going to show one</span>
<a href="#l12.2092"></a><span id="l12.2092"> // and for OSX, sets creator flags on the output file</span>
<a href="#l12.2093"></a><span id="l12.2093" class="difflineminus">-nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest)</span>
<a href="#l12.2094"></a><span id="l12.2094" class="difflineminus">-{</span>
<a href="#l12.2095"></a><span id="l12.2095" class="difflineplus">+nsresult nsSaveMsgListener::InitializeDownload(nsIRequest *aRequest) {</span>
<a href="#l12.2096"></a><span id="l12.2096">   nsresult rv = NS_OK;</span>
<a href="#l12.2097"></a><span id="l12.2097"> </span>
<a href="#l12.2098"></a><span id="l12.2098">   mInitialized = true;</span>
<a href="#l12.2099"></a><span id="l12.2099" class="difflineminus">-  nsCOMPtr&lt;nsIChannel&gt; channel (do_QueryInterface(aRequest));</span>
<a href="#l12.2100"></a><span id="l12.2100" class="difflineminus">-</span>
<a href="#l12.2101"></a><span id="l12.2101" class="difflineminus">-  if (!channel)</span>
<a href="#l12.2102"></a><span id="l12.2102" class="difflineminus">-    return rv;</span>
<a href="#l12.2103"></a><span id="l12.2103" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; channel(do_QueryInterface(aRequest));</span>
<a href="#l12.2104"></a><span id="l12.2104" class="difflineplus">+</span>
<a href="#l12.2105"></a><span id="l12.2105" class="difflineplus">+  if (!channel) return rv;</span>
<a href="#l12.2106"></a><span id="l12.2106"> </span>
<a href="#l12.2107"></a><span id="l12.2107">   // Get the max progress from the URL if we haven't already got it.</span>
<a href="#l12.2108"></a><span id="l12.2108" class="difflineminus">-  if (mMaxProgress == -1)</span>
<a href="#l12.2109"></a><span id="l12.2109" class="difflineminus">-  {</span>
<a href="#l12.2110"></a><span id="l12.2110" class="difflineplus">+  if (mMaxProgress == -1) {</span>
<a href="#l12.2111"></a><span id="l12.2111">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l12.2112"></a><span id="l12.2112">     channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l12.2113"></a><span id="l12.2113">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l12.2114"></a><span id="l12.2114" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l12.2115"></a><span id="l12.2115" class="difflineminus">-      mailnewsUrl-&gt;GetMaxProgress(&amp;mMaxProgress);</span>
<a href="#l12.2116"></a><span id="l12.2116" class="difflineplus">+    if (mailnewsUrl) mailnewsUrl-&gt;GetMaxProgress(&amp;mMaxProgress);</span>
<a href="#l12.2117"></a><span id="l12.2117">   }</span>
<a href="#l12.2118"></a><span id="l12.2118"> </span>
<a href="#l12.2119"></a><span id="l12.2119" class="difflineminus">-  if (!m_contentType.IsEmpty())</span>
<a href="#l12.2120"></a><span id="l12.2120" class="difflineminus">-  {</span>
<a href="#l12.2121"></a><span id="l12.2121" class="difflineminus">-    nsCOMPtr&lt;nsIMIMEService&gt; mimeService (do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l12.2122"></a><span id="l12.2122" class="difflineplus">+  if (!m_contentType.IsEmpty()) {</span>
<a href="#l12.2123"></a><span id="l12.2123" class="difflineplus">+    nsCOMPtr&lt;nsIMIMEService&gt; mimeService(</span>
<a href="#l12.2124"></a><span id="l12.2124" class="difflineplus">+        do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l12.2125"></a><span id="l12.2125">     nsCOMPtr&lt;nsIMIMEInfo&gt; mimeinfo;</span>
<a href="#l12.2126"></a><span id="l12.2126"> </span>
<a href="#l12.2127"></a><span id="l12.2127" class="difflineminus">-    mimeService-&gt;GetFromTypeAndExtension(m_contentType, EmptyCString(), getter_AddRefs(mimeinfo));</span>
<a href="#l12.2128"></a><span id="l12.2128" class="difflineplus">+    mimeService-&gt;GetFromTypeAndExtension(m_contentType, EmptyCString(),</span>
<a href="#l12.2129"></a><span id="l12.2129" class="difflineplus">+                                         getter_AddRefs(mimeinfo));</span>
<a href="#l12.2130"></a><span id="l12.2130"> </span>
<a href="#l12.2131"></a><span id="l12.2131">     // create a download progress window</span>
<a href="#l12.2132"></a><span id="l12.2132"> </span>
<a href="#l12.2133"></a><span id="l12.2133">     // Set saveToDisk explicitly to avoid launching the saved file.</span>
<a href="#l12.2134"></a><span id="l12.2134" class="difflineminus">-    // See https://hg.mozilla.org/mozilla-central/file/814a6f071472/toolkit/components/jsdownloads/src/DownloadLegacy.js#l164</span>
<a href="#l12.2135"></a><span id="l12.2135" class="difflineplus">+    // See</span>
<a href="#l12.2136"></a><span id="l12.2136" class="difflineplus">+    // https://hg.mozilla.org/mozilla-central/file/814a6f071472/toolkit/components/jsdownloads/src/DownloadLegacy.js#l164</span>
<a href="#l12.2137"></a><span id="l12.2137">     mimeinfo-&gt;SetPreferredAction(nsIHandlerInfo::saveToDisk);</span>
<a href="#l12.2138"></a><span id="l12.2138"> </span>
<a href="#l12.2139"></a><span id="l12.2139">     // When we don't allow warnings, also don't show progress, as this</span>
<a href="#l12.2140"></a><span id="l12.2140">     //  is an environment (typically filters) where we don't want</span>
<a href="#l12.2141"></a><span id="l12.2141">     //  interruption.</span>
<a href="#l12.2142"></a><span id="l12.2142">     bool allowProgress = true;</span>
<a href="#l12.2143"></a><span id="l12.2143">     if (m_saveAllAttachmentsState)</span>
<a href="#l12.2144"></a><span id="l12.2144">       allowProgress = !m_saveAllAttachmentsState-&gt;m_withoutWarning;</span>
<a href="#l12.2145"></a><span id="l12.2145" class="difflineminus">-    if (allowProgress)</span>
<a href="#l12.2146"></a><span id="l12.2146" class="difflineminus">-    {</span>
<a href="#l12.2147"></a><span id="l12.2147" class="difflineplus">+    if (allowProgress) {</span>
<a href="#l12.2148"></a><span id="l12.2148">       nsCOMPtr&lt;nsITransfer&gt; tr = do_CreateInstance(NS_TRANSFER_CONTRACTID, &amp;rv);</span>
<a href="#l12.2149"></a><span id="l12.2149" class="difflineminus">-      if (tr &amp;&amp; m_file)</span>
<a href="#l12.2150"></a><span id="l12.2150" class="difflineminus">-      {</span>
<a href="#l12.2151"></a><span id="l12.2151" class="difflineplus">+      if (tr &amp;&amp; m_file) {</span>
<a href="#l12.2152"></a><span id="l12.2152">         PRTime timeDownloadStarted = PR_Now();</span>
<a href="#l12.2153"></a><span id="l12.2153"> </span>
<a href="#l12.2154"></a><span id="l12.2154">         nsCOMPtr&lt;nsIURI&gt; outputURI;</span>
<a href="#l12.2155"></a><span id="l12.2155">         NS_NewFileURI(getter_AddRefs(outputURI), m_file);</span>
<a href="#l12.2156"></a><span id="l12.2156"> </span>
<a href="#l12.2157"></a><span id="l12.2157">         nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l12.2158"></a><span id="l12.2158">         channel-&gt;GetURI(getter_AddRefs(url));</span>
<a href="#l12.2159"></a><span id="l12.2159">         rv = tr-&gt;Init(url, outputURI, EmptyString(), mimeinfo,</span>
<a href="#l12.2160"></a><span id="l12.2160">                       timeDownloadStarted, nullptr, this, false);</span>
<a href="#l12.2161"></a><span id="l12.2161"> </span>
<a href="#l12.2162"></a><span id="l12.2162" class="difflineminus">-          // now store the web progresslistener</span>
<a href="#l12.2163"></a><span id="l12.2163" class="difflineplus">+        // now store the web progresslistener</span>
<a href="#l12.2164"></a><span id="l12.2164">         mTransfer = tr;</span>
<a href="#l12.2165"></a><span id="l12.2165">       }</span>
<a href="#l12.2166"></a><span id="l12.2166">     }</span>
<a href="#l12.2167"></a><span id="l12.2167">   }</span>
<a href="#l12.2168"></a><span id="l12.2168">   return rv;</span>
<a href="#l12.2169"></a><span id="l12.2169"> }</span>
<a href="#l12.2170"></a><span id="l12.2170"> </span>
<a href="#l12.2171"></a><span id="l12.2171"> NS_IMETHODIMP</span>
<a href="#l12.2172"></a><span id="l12.2172" class="difflineminus">-nsSaveMsgListener::OnStartRequest(nsIRequest* request)</span>
<a href="#l12.2173"></a><span id="l12.2173" class="difflineminus">-{</span>
<a href="#l12.2174"></a><span id="l12.2174" class="difflineplus">+nsSaveMsgListener::OnStartRequest(nsIRequest *request) {</span>
<a href="#l12.2175"></a><span id="l12.2175">   if (m_file)</span>
<a href="#l12.2176"></a><span id="l12.2176" class="difflineminus">-    MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream), m_file, -1, ATTACHMENT_PERMISSION);</span>
<a href="#l12.2177"></a><span id="l12.2177" class="difflineminus">-  if (!m_outputStream)</span>
<a href="#l12.2178"></a><span id="l12.2178" class="difflineminus">-  {</span>
<a href="#l12.2179"></a><span id="l12.2179" class="difflineplus">+    MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream), m_file, -1,</span>
<a href="#l12.2180"></a><span id="l12.2180" class="difflineplus">+                                   ATTACHMENT_PERMISSION);</span>
<a href="#l12.2181"></a><span id="l12.2181" class="difflineplus">+  if (!m_outputStream) {</span>
<a href="#l12.2182"></a><span id="l12.2182">     mCanceled = true;</span>
<a href="#l12.2183"></a><span id="l12.2183" class="difflineminus">-    if (m_messenger)</span>
<a href="#l12.2184"></a><span id="l12.2184" class="difflineminus">-      m_messenger-&gt;Alert(&quot;saveAttachmentFailed&quot;);</span>
<a href="#l12.2185"></a><span id="l12.2185" class="difflineplus">+    if (m_messenger) m_messenger-&gt;Alert(&quot;saveAttachmentFailed&quot;);</span>
<a href="#l12.2186"></a><span id="l12.2186">   }</span>
<a href="#l12.2187"></a><span id="l12.2187">   return NS_OK;</span>
<a href="#l12.2188"></a><span id="l12.2188"> }</span>
<a href="#l12.2189"></a><span id="l12.2189"> </span>
<a href="#l12.2190"></a><span id="l12.2190"> NS_IMETHODIMP</span>
<a href="#l12.2191"></a><span id="l12.2191" class="difflineminus">-nsSaveMsgListener::OnStopRequest(nsIRequest* request, nsresult status)</span>
<a href="#l12.2192"></a><span id="l12.2192" class="difflineminus">-{</span>
<a href="#l12.2193"></a><span id="l12.2193" class="difflineplus">+nsSaveMsgListener::OnStopRequest(nsIRequest *request, nsresult status) {</span>
<a href="#l12.2194"></a><span id="l12.2194">   nsresult rv = NS_OK;</span>
<a href="#l12.2195"></a><span id="l12.2195">   mRequestHasStopped = true;</span>
<a href="#l12.2196"></a><span id="l12.2196"> </span>
<a href="#l12.2197"></a><span id="l12.2197">   // rhp: If we are doing the charset conversion magic, this is different</span>
<a href="#l12.2198"></a><span id="l12.2198">   // processing, otherwise, its just business as usual.</span>
<a href="#l12.2199"></a><span id="l12.2199">   // If we need text/plain, then we need to convert the HTML and then convert</span>
<a href="#l12.2200"></a><span id="l12.2200">   // to the systems charset.</span>
<a href="#l12.2201"></a><span id="l12.2201" class="difflineminus">-  if (m_doCharsetConversion &amp;&amp; m_outputStream)</span>
<a href="#l12.2202"></a><span id="l12.2202" class="difflineminus">-  {</span>
<a href="#l12.2203"></a><span id="l12.2203" class="difflineplus">+  if (m_doCharsetConversion &amp;&amp; m_outputStream) {</span>
<a href="#l12.2204"></a><span id="l12.2204">     // For HTML, code is emitted immediately in OnDataAvailable.</span>
<a href="#l12.2205"></a><span id="l12.2205">     MOZ_ASSERT(m_outputFormat == ePlainText,</span>
<a href="#l12.2206"></a><span id="l12.2206" class="difflineminus">-      &quot;For HTML, m_doCharsetConversion shouldn't be set&quot;);</span>
<a href="#l12.2207"></a><span id="l12.2207" class="difflineplus">+               &quot;For HTML, m_doCharsetConversion shouldn't be set&quot;);</span>
<a href="#l12.2208"></a><span id="l12.2208">     NS_ConvertUTF8toUTF16 utf16Buffer(m_msgBuffer);</span>
<a href="#l12.2209"></a><span id="l12.2209">     ConvertBufToPlainText(utf16Buffer, false, false, false, false);</span>
<a href="#l12.2210"></a><span id="l12.2210"> </span>
<a href="#l12.2211"></a><span id="l12.2211">     nsCString outCString;</span>
<a href="#l12.2212"></a><span id="l12.2212" class="difflineminus">-    // NS_CopyUnicodeToNative() doesn't return an error, so we have no choice but to</span>
<a href="#l12.2213"></a><span id="l12.2213" class="difflineminus">-    // always use UTF-8.</span>
<a href="#l12.2214"></a><span id="l12.2214" class="difflineplus">+    // NS_CopyUnicodeToNative() doesn't return an error, so we have no choice</span>
<a href="#l12.2215"></a><span id="l12.2215" class="difflineplus">+    // but to always use UTF-8.</span>
<a href="#l12.2216"></a><span id="l12.2216">     CopyUTF16toUTF8(utf16Buffer, outCString);</span>
<a href="#l12.2217"></a><span id="l12.2217">     uint32_t writeCount;</span>
<a href="#l12.2218"></a><span id="l12.2218" class="difflineminus">-    rv = m_outputStream-&gt;Write(outCString.get(), outCString.Length(), &amp;writeCount);</span>
<a href="#l12.2219"></a><span id="l12.2219" class="difflineminus">-    if (outCString.Length() != writeCount)</span>
<a href="#l12.2220"></a><span id="l12.2220" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2221"></a><span id="l12.2221" class="difflineplus">+    rv = m_outputStream-&gt;Write(outCString.get(), outCString.Length(),</span>
<a href="#l12.2222"></a><span id="l12.2222" class="difflineplus">+                               &amp;writeCount);</span>
<a href="#l12.2223"></a><span id="l12.2223" class="difflineplus">+    if (outCString.Length() != writeCount) rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2224"></a><span id="l12.2224">   }</span>
<a href="#l12.2225"></a><span id="l12.2225"> </span>
<a href="#l12.2226"></a><span id="l12.2226" class="difflineminus">-  if (m_outputStream)</span>
<a href="#l12.2227"></a><span id="l12.2227" class="difflineminus">-  {</span>
<a href="#l12.2228"></a><span id="l12.2228" class="difflineplus">+  if (m_outputStream) {</span>
<a href="#l12.2229"></a><span id="l12.2229">     m_outputStream-&gt;Close();</span>
<a href="#l12.2230"></a><span id="l12.2230">     m_outputStream = nullptr;</span>
<a href="#l12.2231"></a><span id="l12.2231">   }</span>
<a href="#l12.2232"></a><span id="l12.2232"> </span>
<a href="#l12.2233"></a><span id="l12.2233" class="difflineminus">-  if (m_saveAllAttachmentsState)</span>
<a href="#l12.2234"></a><span id="l12.2234" class="difflineminus">-  {</span>
<a href="#l12.2235"></a><span id="l12.2235" class="difflineplus">+  if (m_saveAllAttachmentsState) {</span>
<a href="#l12.2236"></a><span id="l12.2236">     m_saveAllAttachmentsState-&gt;m_curIndex++;</span>
<a href="#l12.2237"></a><span id="l12.2237" class="difflineminus">-    if (!mCanceled &amp;&amp; m_saveAllAttachmentsState-&gt;m_curIndex &lt; m_saveAllAttachmentsState-&gt;m_count)</span>
<a href="#l12.2238"></a><span id="l12.2238" class="difflineminus">-    {</span>
<a href="#l12.2239"></a><span id="l12.2239" class="difflineplus">+    if (!mCanceled &amp;&amp; m_saveAllAttachmentsState-&gt;m_curIndex &lt;</span>
<a href="#l12.2240"></a><span id="l12.2240" class="difflineplus">+                          m_saveAllAttachmentsState-&gt;m_count) {</span>
<a href="#l12.2241"></a><span id="l12.2241">       nsSaveAllAttachmentsState *state = m_saveAllAttachmentsState;</span>
<a href="#l12.2242"></a><span id="l12.2242">       uint32_t i = state-&gt;m_curIndex;</span>
<a href="#l12.2243"></a><span id="l12.2243">       nsString unescapedName;</span>
<a href="#l12.2244"></a><span id="l12.2244">       RefPtr&lt;nsLocalFile&gt; localFile =</span>
<a href="#l12.2245"></a><span id="l12.2245" class="difflineminus">-        new nsLocalFile(nsTDependentString&lt;PathChar&gt;(state-&gt;m_directoryName));</span>
<a href="#l12.2246"></a><span id="l12.2246" class="difflineplus">+          new nsLocalFile(nsTDependentString&lt;PathChar&gt;(state-&gt;m_directoryName));</span>
<a href="#l12.2247"></a><span id="l12.2247">       if (localFile-&gt;NativePath().IsEmpty()) {</span>
<a href="#l12.2248"></a><span id="l12.2248">         rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2249"></a><span id="l12.2249">         goto done;</span>
<a href="#l12.2250"></a><span id="l12.2250">       }</span>
<a href="#l12.2251"></a><span id="l12.2251"> </span>
<a href="#l12.2252"></a><span id="l12.2252">       ConvertAndSanitizeFileName(state-&gt;m_displayNameArray[i], unescapedName);</span>
<a href="#l12.2253"></a><span id="l12.2253">       rv = localFile-&gt;Append(unescapedName);</span>
<a href="#l12.2254"></a><span id="l12.2254" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l12.2255"></a><span id="l12.2255" class="difflineminus">-        goto done;</span>
<a href="#l12.2256"></a><span id="l12.2256" class="difflineminus">-</span>
<a href="#l12.2257"></a><span id="l12.2257" class="difflineminus">-      // When we are running with no warnings (typically filters and other automatic</span>
<a href="#l12.2258"></a><span id="l12.2258" class="difflineminus">-      //  uses), then don't prompt for duplicates, but create a unique file</span>
<a href="#l12.2259"></a><span id="l12.2259" class="difflineminus">-      //  instead.</span>
<a href="#l12.2260"></a><span id="l12.2260" class="difflineminus">-      if (!m_saveAllAttachmentsState-&gt;m_withoutWarning)</span>
<a href="#l12.2261"></a><span id="l12.2261" class="difflineminus">-      {</span>
<a href="#l12.2262"></a><span id="l12.2262" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.2263"></a><span id="l12.2263" class="difflineplus">+</span>
<a href="#l12.2264"></a><span id="l12.2264" class="difflineplus">+      // When we are running with no warnings (typically filters and other</span>
<a href="#l12.2265"></a><span id="l12.2265" class="difflineplus">+      // automatic uses), then don't prompt for duplicates, but create a unique</span>
<a href="#l12.2266"></a><span id="l12.2266" class="difflineplus">+      // file instead.</span>
<a href="#l12.2267"></a><span id="l12.2267" class="difflineplus">+      if (!m_saveAllAttachmentsState-&gt;m_withoutWarning) {</span>
<a href="#l12.2268"></a><span id="l12.2268">         rv = m_messenger-&gt;PromptIfFileExists(localFile);</span>
<a href="#l12.2269"></a><span id="l12.2269">         if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.2270"></a><span id="l12.2270" class="difflineminus">-      }</span>
<a href="#l12.2271"></a><span id="l12.2271" class="difflineminus">-      else</span>
<a href="#l12.2272"></a><span id="l12.2272" class="difflineminus">-      {</span>
<a href="#l12.2273"></a><span id="l12.2273" class="difflineminus">-        rv = localFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, ATTACHMENT_PERMISSION);</span>
<a href="#l12.2274"></a><span id="l12.2274" class="difflineplus">+      } else {</span>
<a href="#l12.2275"></a><span id="l12.2275" class="difflineplus">+        rv = localFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l12.2276"></a><span id="l12.2276" class="difflineplus">+                                     ATTACHMENT_PERMISSION);</span>
<a href="#l12.2277"></a><span id="l12.2277">         if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.2278"></a><span id="l12.2278">       }</span>
<a href="#l12.2279"></a><span id="l12.2279" class="difflineminus">-      rv = m_messenger-&gt;SaveAttachment(localFile,</span>
<a href="#l12.2280"></a><span id="l12.2280" class="difflineminus">-                                       nsDependentCString(state-&gt;m_urlArray[i]),</span>
<a href="#l12.2281"></a><span id="l12.2281" class="difflineminus">-                                       nsDependentCString(state-&gt;m_messageUriArray[i]),</span>
<a href="#l12.2282"></a><span id="l12.2282" class="difflineminus">-                                       nsDependentCString(state-&gt;m_contentTypeArray[i]),</span>
<a href="#l12.2283"></a><span id="l12.2283" class="difflineminus">-                                       (void *)state, nullptr);</span>
<a href="#l12.2284"></a><span id="l12.2284" class="difflineminus">-      done:</span>
<a href="#l12.2285"></a><span id="l12.2285" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l12.2286"></a><span id="l12.2286" class="difflineminus">-        {</span>
<a href="#l12.2287"></a><span id="l12.2287" class="difflineminus">-          delete state;</span>
<a href="#l12.2288"></a><span id="l12.2288" class="difflineminus">-          m_saveAllAttachmentsState = nullptr;</span>
<a href="#l12.2289"></a><span id="l12.2289" class="difflineminus">-        }</span>
<a href="#l12.2290"></a><span id="l12.2290" class="difflineminus">-    }</span>
<a href="#l12.2291"></a><span id="l12.2291" class="difflineminus">-    else</span>
<a href="#l12.2292"></a><span id="l12.2292" class="difflineminus">-    {</span>
<a href="#l12.2293"></a><span id="l12.2293" class="difflineminus">-          // check if we're saving attachments prior to detaching them.</span>
<a href="#l12.2294"></a><span id="l12.2294" class="difflineminus">-      if (m_saveAllAttachmentsState-&gt;m_detachingAttachments &amp;&amp; !mCanceled)</span>
<a href="#l12.2295"></a><span id="l12.2295" class="difflineminus">-      {</span>
<a href="#l12.2296"></a><span id="l12.2296" class="difflineplus">+      rv = m_messenger-&gt;SaveAttachment(</span>
<a href="#l12.2297"></a><span id="l12.2297" class="difflineplus">+          localFile, nsDependentCString(state-&gt;m_urlArray[i]),</span>
<a href="#l12.2298"></a><span id="l12.2298" class="difflineplus">+          nsDependentCString(state-&gt;m_messageUriArray[i]),</span>
<a href="#l12.2299"></a><span id="l12.2299" class="difflineplus">+          nsDependentCString(state-&gt;m_contentTypeArray[i]), (void *)state,</span>
<a href="#l12.2300"></a><span id="l12.2300" class="difflineplus">+          nullptr);</span>
<a href="#l12.2301"></a><span id="l12.2301" class="difflineplus">+    done:</span>
<a href="#l12.2302"></a><span id="l12.2302" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l12.2303"></a><span id="l12.2303" class="difflineplus">+        delete state;</span>
<a href="#l12.2304"></a><span id="l12.2304" class="difflineplus">+        m_saveAllAttachmentsState = nullptr;</span>
<a href="#l12.2305"></a><span id="l12.2305" class="difflineplus">+      }</span>
<a href="#l12.2306"></a><span id="l12.2306" class="difflineplus">+    } else {</span>
<a href="#l12.2307"></a><span id="l12.2307" class="difflineplus">+      // check if we're saving attachments prior to detaching them.</span>
<a href="#l12.2308"></a><span id="l12.2308" class="difflineplus">+      if (m_saveAllAttachmentsState-&gt;m_detachingAttachments &amp;&amp; !mCanceled) {</span>
<a href="#l12.2309"></a><span id="l12.2309">         nsSaveAllAttachmentsState *state = m_saveAllAttachmentsState;</span>
<a href="#l12.2310"></a><span id="l12.2310" class="difflineminus">-        m_messenger-&gt;DetachAttachments(state-&gt;m_count,</span>
<a href="#l12.2311"></a><span id="l12.2311" class="difflineminus">-                                       (const char **) state-&gt;m_contentTypeArray,</span>
<a href="#l12.2312"></a><span id="l12.2312" class="difflineminus">-                                       (const char **) state-&gt;m_urlArray,</span>
<a href="#l12.2313"></a><span id="l12.2313" class="difflineminus">-                                       (const char **) state-&gt;m_displayNameArray,</span>
<a href="#l12.2314"></a><span id="l12.2314" class="difflineminus">-                                       (const char **) state-&gt;m_messageUriArray,</span>
<a href="#l12.2315"></a><span id="l12.2315" class="difflineminus">-                                       &amp;state-&gt;m_savedFiles,</span>
<a href="#l12.2316"></a><span id="l12.2316" class="difflineminus">-                                       state-&gt;m_withoutWarning);</span>
<a href="#l12.2317"></a><span id="l12.2317" class="difflineplus">+        m_messenger-&gt;DetachAttachments(</span>
<a href="#l12.2318"></a><span id="l12.2318" class="difflineplus">+            state-&gt;m_count, (const char **)state-&gt;m_contentTypeArray,</span>
<a href="#l12.2319"></a><span id="l12.2319" class="difflineplus">+            (const char **)state-&gt;m_urlArray,</span>
<a href="#l12.2320"></a><span id="l12.2320" class="difflineplus">+            (const char **)state-&gt;m_displayNameArray,</span>
<a href="#l12.2321"></a><span id="l12.2321" class="difflineplus">+            (const char **)state-&gt;m_messageUriArray, &amp;state-&gt;m_savedFiles,</span>
<a href="#l12.2322"></a><span id="l12.2322" class="difflineplus">+            state-&gt;m_withoutWarning);</span>
<a href="#l12.2323"></a><span id="l12.2323">       }</span>
<a href="#l12.2324"></a><span id="l12.2324"> </span>
<a href="#l12.2325"></a><span id="l12.2325">       delete m_saveAllAttachmentsState;</span>
<a href="#l12.2326"></a><span id="l12.2326">       m_saveAllAttachmentsState = nullptr;</span>
<a href="#l12.2327"></a><span id="l12.2327">     }</span>
<a href="#l12.2328"></a><span id="l12.2328">   }</span>
<a href="#l12.2329"></a><span id="l12.2329"> </span>
<a href="#l12.2330"></a><span id="l12.2330" class="difflineminus">-  if(mTransfer)</span>
<a href="#l12.2331"></a><span id="l12.2331" class="difflineminus">-  {</span>
<a href="#l12.2332"></a><span id="l12.2332" class="difflineminus">-    mTransfer-&gt;OnProgressChange64(nullptr, nullptr, mMaxProgress, mMaxProgress, mMaxProgress, mMaxProgress);</span>
<a href="#l12.2333"></a><span id="l12.2333" class="difflineminus">-    mTransfer-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_STOP |</span>
<a href="#l12.2334"></a><span id="l12.2334" class="difflineminus">-      nsIWebProgressListener::STATE_IS_NETWORK, NS_OK);</span>
<a href="#l12.2335"></a><span id="l12.2335" class="difflineminus">-    mTransfer = nullptr; // break any circular dependencies between the progress dialog and use</span>
<a href="#l12.2336"></a><span id="l12.2336" class="difflineplus">+  if (mTransfer) {</span>
<a href="#l12.2337"></a><span id="l12.2337" class="difflineplus">+    mTransfer-&gt;OnProgressChange64(nullptr, nullptr, mMaxProgress, mMaxProgress,</span>
<a href="#l12.2338"></a><span id="l12.2338" class="difflineplus">+                                  mMaxProgress, mMaxProgress);</span>
<a href="#l12.2339"></a><span id="l12.2339" class="difflineplus">+    mTransfer-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l12.2340"></a><span id="l12.2340" class="difflineplus">+                             nsIWebProgressListener::STATE_STOP |</span>
<a href="#l12.2341"></a><span id="l12.2341" class="difflineplus">+                                 nsIWebProgressListener::STATE_IS_NETWORK,</span>
<a href="#l12.2342"></a><span id="l12.2342" class="difflineplus">+                             NS_OK);</span>
<a href="#l12.2343"></a><span id="l12.2343" class="difflineplus">+    mTransfer = nullptr;  // break any circular dependencies between the</span>
<a href="#l12.2344"></a><span id="l12.2344" class="difflineplus">+                          // progress dialog and use</span>
<a href="#l12.2345"></a><span id="l12.2345">   }</span>
<a href="#l12.2346"></a><span id="l12.2346"> </span>
<a href="#l12.2347"></a><span id="l12.2347">   if (mUrlHasStopped &amp;&amp; mListener)</span>
<a href="#l12.2348"></a><span id="l12.2348">     mListener-&gt;OnStopRunningUrl(mListenerUri, rv);</span>
<a href="#l12.2349"></a><span id="l12.2349"> </span>
<a href="#l12.2350"></a><span id="l12.2350">   return NS_OK;</span>
<a href="#l12.2351"></a><span id="l12.2351"> }</span>
<a href="#l12.2352"></a><span id="l12.2352"> </span>
<a href="#l12.2353"></a><span id="l12.2353"> NS_IMETHODIMP</span>
<a href="#l12.2354"></a><span id="l12.2354" class="difflineminus">-nsSaveMsgListener::OnDataAvailable(nsIRequest* request,</span>
<a href="#l12.2355"></a><span id="l12.2355" class="difflineminus">-                                  nsIInputStream* inStream,</span>
<a href="#l12.2356"></a><span id="l12.2356" class="difflineminus">-                                  uint64_t srcOffset,</span>
<a href="#l12.2357"></a><span id="l12.2357" class="difflineminus">-                                  uint32_t count)</span>
<a href="#l12.2358"></a><span id="l12.2358" class="difflineminus">-{</span>
<a href="#l12.2359"></a><span id="l12.2359" class="difflineplus">+nsSaveMsgListener::OnDataAvailable(nsIRequest *request,</span>
<a href="#l12.2360"></a><span id="l12.2360" class="difflineplus">+                                   nsIInputStream *inStream, uint64_t srcOffset,</span>
<a href="#l12.2361"></a><span id="l12.2361" class="difflineplus">+                                   uint32_t count) {</span>
<a href="#l12.2362"></a><span id="l12.2362">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2363"></a><span id="l12.2363">   // first, check to see if we've been canceled....</span>
<a href="#l12.2364"></a><span id="l12.2364" class="difflineminus">-  if (mCanceled) // then go cancel our underlying channel too</span>
<a href="#l12.2365"></a><span id="l12.2365" class="difflineplus">+  if (mCanceled)  // then go cancel our underlying channel too</span>
<a href="#l12.2366"></a><span id="l12.2366">     return request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l12.2367"></a><span id="l12.2367"> </span>
<a href="#l12.2368"></a><span id="l12.2368" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l12.2369"></a><span id="l12.2369" class="difflineminus">-    InitializeDownload(request);</span>
<a href="#l12.2370"></a><span id="l12.2370" class="difflineminus">-</span>
<a href="#l12.2371"></a><span id="l12.2371" class="difflineminus">-  if (m_outputStream)</span>
<a href="#l12.2372"></a><span id="l12.2372" class="difflineminus">-  {</span>
<a href="#l12.2373"></a><span id="l12.2373" class="difflineplus">+  if (!mInitialized) InitializeDownload(request);</span>
<a href="#l12.2374"></a><span id="l12.2374" class="difflineplus">+</span>
<a href="#l12.2375"></a><span id="l12.2375" class="difflineplus">+  if (m_outputStream) {</span>
<a href="#l12.2376"></a><span id="l12.2376">     mProgress += count;</span>
<a href="#l12.2377"></a><span id="l12.2377">     uint64_t available;</span>
<a href="#l12.2378"></a><span id="l12.2378">     uint32_t readCount, maxReadCount = sizeof(m_dataBuffer);</span>
<a href="#l12.2379"></a><span id="l12.2379">     uint32_t writeCount;</span>
<a href="#l12.2380"></a><span id="l12.2380">     rv = inStream-&gt;Available(&amp;available);</span>
<a href="#l12.2381"></a><span id="l12.2381" class="difflineminus">-    while (NS_SUCCEEDED(rv) &amp;&amp; available)</span>
<a href="#l12.2382"></a><span id="l12.2382" class="difflineminus">-    {</span>
<a href="#l12.2383"></a><span id="l12.2383" class="difflineminus">-      if (maxReadCount &gt; available)</span>
<a href="#l12.2384"></a><span id="l12.2384" class="difflineminus">-        maxReadCount = (uint32_t)available;</span>
<a href="#l12.2385"></a><span id="l12.2385" class="difflineplus">+    while (NS_SUCCEEDED(rv) &amp;&amp; available) {</span>
<a href="#l12.2386"></a><span id="l12.2386" class="difflineplus">+      if (maxReadCount &gt; available) maxReadCount = (uint32_t)available;</span>
<a href="#l12.2387"></a><span id="l12.2387">       rv = inStream-&gt;Read(m_dataBuffer, maxReadCount, &amp;readCount);</span>
<a href="#l12.2388"></a><span id="l12.2388"> </span>
<a href="#l12.2389"></a><span id="l12.2389">       // rhp:</span>
<a href="#l12.2390"></a><span id="l12.2390">       // Ok, now we do one of two things. If we are sending out HTML, then</span>
<a href="#l12.2391"></a><span id="l12.2391">       // just write it to the HTML stream as it comes along...but if this is</span>
<a href="#l12.2392"></a><span id="l12.2392">       // a save as TEXT operation, we need to buffer this up for conversion</span>
<a href="#l12.2393"></a><span id="l12.2393" class="difflineminus">-      // when we are done. When the stream converter for HTML-TEXT gets in place,</span>
<a href="#l12.2394"></a><span id="l12.2394" class="difflineminus">-      // this magic can go away.</span>
<a href="#l12.2395"></a><span id="l12.2395" class="difflineplus">+      // when we are done. When the stream converter for HTML-TEXT gets in</span>
<a href="#l12.2396"></a><span id="l12.2396" class="difflineplus">+      // place, this magic can go away.</span>
<a href="#l12.2397"></a><span id="l12.2397">       //</span>
<a href="#l12.2398"></a><span id="l12.2398" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l12.2399"></a><span id="l12.2399" class="difflineminus">-      {</span>
<a href="#l12.2400"></a><span id="l12.2400" class="difflineminus">-        if ( (m_doCharsetConversion) &amp;&amp; (m_outputFormat == ePlainText) )</span>
<a href="#l12.2401"></a><span id="l12.2401" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.2402"></a><span id="l12.2402" class="difflineplus">+        if ((m_doCharsetConversion) &amp;&amp; (m_outputFormat == ePlainText))</span>
<a href="#l12.2403"></a><span id="l12.2403">           m_msgBuffer.Append(Substring(m_dataBuffer, m_dataBuffer + readCount));</span>
<a href="#l12.2404"></a><span id="l12.2404">         else</span>
<a href="#l12.2405"></a><span id="l12.2405">           rv = m_outputStream-&gt;Write(m_dataBuffer, readCount, &amp;writeCount);</span>
<a href="#l12.2406"></a><span id="l12.2406"> </span>
<a href="#l12.2407"></a><span id="l12.2407">         available -= readCount;</span>
<a href="#l12.2408"></a><span id="l12.2408">       }</span>
<a href="#l12.2409"></a><span id="l12.2409">     }</span>
<a href="#l12.2410"></a><span id="l12.2410"> </span>
<a href="#l12.2411"></a><span id="l12.2411" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; mTransfer) // Send progress notification.</span>
<a href="#l12.2412"></a><span id="l12.2412" class="difflineminus">-      mTransfer-&gt;OnProgressChange64(nullptr, request, mProgress, mMaxProgress, mProgress, mMaxProgress);</span>
<a href="#l12.2413"></a><span id="l12.2413" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mTransfer)  // Send progress notification.</span>
<a href="#l12.2414"></a><span id="l12.2414" class="difflineplus">+      mTransfer-&gt;OnProgressChange64(nullptr, request, mProgress, mMaxProgress,</span>
<a href="#l12.2415"></a><span id="l12.2415" class="difflineplus">+                                    mProgress, mMaxProgress);</span>
<a href="#l12.2416"></a><span id="l12.2416">   }</span>
<a href="#l12.2417"></a><span id="l12.2417">   return rv;</span>
<a href="#l12.2418"></a><span id="l12.2418"> }</span>
<a href="#l12.2419"></a><span id="l12.2419"> </span>
<a href="#l12.2420"></a><span id="l12.2420" class="difflineminus">-#define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l12.2421"></a><span id="l12.2421" class="difflineminus">-</span>
<a href="#l12.2422"></a><span id="l12.2422" class="difflineminus">-nsresult</span>
<a href="#l12.2423"></a><span id="l12.2423" class="difflineminus">-nsMessenger::InitStringBundle()</span>
<a href="#l12.2424"></a><span id="l12.2424" class="difflineminus">-{</span>
<a href="#l12.2425"></a><span id="l12.2425" class="difflineminus">-  if (mStringBundle)</span>
<a href="#l12.2426"></a><span id="l12.2426" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.2427"></a><span id="l12.2427" class="difflineplus">+#define MESSENGER_STRING_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l12.2428"></a><span id="l12.2428" class="difflineplus">+</span>
<a href="#l12.2429"></a><span id="l12.2429" class="difflineplus">+nsresult nsMessenger::InitStringBundle() {</span>
<a href="#l12.2430"></a><span id="l12.2430" class="difflineplus">+  if (mStringBundle) return NS_OK;</span>
<a href="#l12.2431"></a><span id="l12.2431"> </span>
<a href="#l12.2432"></a><span id="l12.2432">   const char propertyURL[] = MESSENGER_STRING_URL;</span>
<a href="#l12.2433"></a><span id="l12.2433">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l12.2434"></a><span id="l12.2434" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l12.2435"></a><span id="l12.2435" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l12.2436"></a><span id="l12.2436">   NS_ENSURE_TRUE(sBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l12.2437"></a><span id="l12.2437">   return sBundleService-&gt;CreateBundle(propertyURL,</span>
<a href="#l12.2438"></a><span id="l12.2438">                                       getter_AddRefs(mStringBundle));</span>
<a href="#l12.2439"></a><span id="l12.2439"> }</span>
<a href="#l12.2440"></a><span id="l12.2440"> </span>
<a href="#l12.2441"></a><span id="l12.2441" class="difflineminus">-void</span>
<a href="#l12.2442"></a><span id="l12.2442" class="difflineminus">-nsMessenger::GetString(const nsString&amp; aStringName, nsString&amp; aValue)</span>
<a href="#l12.2443"></a><span id="l12.2443" class="difflineminus">-{</span>
<a href="#l12.2444"></a><span id="l12.2444" class="difflineplus">+void nsMessenger::GetString(const nsString &amp;aStringName, nsString &amp;aValue) {</span>
<a href="#l12.2445"></a><span id="l12.2445">   nsresult rv;</span>
<a href="#l12.2446"></a><span id="l12.2446">   aValue.Truncate();</span>
<a href="#l12.2447"></a><span id="l12.2447"> </span>
<a href="#l12.2448"></a><span id="l12.2448" class="difflineminus">-  if (!mStringBundle)</span>
<a href="#l12.2449"></a><span id="l12.2449" class="difflineminus">-    rv = InitStringBundle();</span>
<a href="#l12.2450"></a><span id="l12.2450" class="difflineplus">+  if (!mStringBundle) rv = InitStringBundle();</span>
<a href="#l12.2451"></a><span id="l12.2451"> </span>
<a href="#l12.2452"></a><span id="l12.2452">   if (mStringBundle)</span>
<a href="#l12.2453"></a><span id="l12.2453" class="difflineminus">-    rv = mStringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aStringName).get(), aValue);</span>
<a href="#l12.2454"></a><span id="l12.2454" class="difflineplus">+    rv = mStringBundle-&gt;GetStringFromName(</span>
<a href="#l12.2455"></a><span id="l12.2455" class="difflineplus">+        NS_ConvertUTF16toUTF8(aStringName).get(), aValue);</span>
<a href="#l12.2456"></a><span id="l12.2456">   else</span>
<a href="#l12.2457"></a><span id="l12.2457">     rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2458"></a><span id="l12.2458"> </span>
<a href="#l12.2459"></a><span id="l12.2459" class="difflineminus">-  if (NS_FAILED(rv) || aValue.IsEmpty())</span>
<a href="#l12.2460"></a><span id="l12.2460" class="difflineminus">-    aValue = aStringName;</span>
<a href="#l12.2461"></a><span id="l12.2461" class="difflineplus">+  if (NS_FAILED(rv) || aValue.IsEmpty()) aValue = aStringName;</span>
<a href="#l12.2462"></a><span id="l12.2462">   return;</span>
<a href="#l12.2463"></a><span id="l12.2463"> }</span>
<a href="#l12.2464"></a><span id="l12.2464"> </span>
<a href="#l12.2465"></a><span id="l12.2465" class="difflineminus">-nsSaveAllAttachmentsState::nsSaveAllAttachmentsState(uint32_t count,</span>
<a href="#l12.2466"></a><span id="l12.2466" class="difflineminus">-                                                     const char **contentTypeArray,</span>
<a href="#l12.2467"></a><span id="l12.2467" class="difflineminus">-                                                     const char **urlArray,</span>
<a href="#l12.2468"></a><span id="l12.2468" class="difflineminus">-                                                     const char **nameArray,</span>
<a href="#l12.2469"></a><span id="l12.2469" class="difflineminus">-                                                     const char **uriArray,</span>
<a href="#l12.2470"></a><span id="l12.2470" class="difflineminus">-                                                     const PathChar *dirName,</span>
<a href="#l12.2471"></a><span id="l12.2471" class="difflineminus">-                                                     bool detachingAttachments)</span>
<a href="#l12.2472"></a><span id="l12.2472" class="difflineminus">-    : m_withoutWarning(false)</span>
<a href="#l12.2473"></a><span id="l12.2473" class="difflineminus">-{</span>
<a href="#l12.2474"></a><span id="l12.2474" class="difflineminus">-    uint32_t i;</span>
<a href="#l12.2475"></a><span id="l12.2475" class="difflineminus">-    NS_ASSERTION(count &amp;&amp; urlArray &amp;&amp; nameArray &amp;&amp; uriArray &amp;&amp; dirName,</span>
<a href="#l12.2476"></a><span id="l12.2476" class="difflineminus">-                 &quot;fatal - invalid parameters\n&quot;);</span>
<a href="#l12.2477"></a><span id="l12.2477" class="difflineminus">-</span>
<a href="#l12.2478"></a><span id="l12.2478" class="difflineminus">-    m_count = count;</span>
<a href="#l12.2479"></a><span id="l12.2479" class="difflineminus">-    m_curIndex = 0;</span>
<a href="#l12.2480"></a><span id="l12.2480" class="difflineminus">-    m_contentTypeArray = new char*[count];</span>
<a href="#l12.2481"></a><span id="l12.2481" class="difflineminus">-    m_urlArray = new char*[count];</span>
<a href="#l12.2482"></a><span id="l12.2482" class="difflineminus">-    m_displayNameArray = new char*[count];</span>
<a href="#l12.2483"></a><span id="l12.2483" class="difflineminus">-    m_messageUriArray = new char*[count];</span>
<a href="#l12.2484"></a><span id="l12.2484" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l12.2485"></a><span id="l12.2485" class="difflineminus">-    {</span>
<a href="#l12.2486"></a><span id="l12.2486" class="difflineminus">-        m_contentTypeArray[i] = strdup(contentTypeArray[i]);</span>
<a href="#l12.2487"></a><span id="l12.2487" class="difflineminus">-        m_urlArray[i] = strdup(urlArray[i]);</span>
<a href="#l12.2488"></a><span id="l12.2488" class="difflineminus">-        m_displayNameArray[i] = strdup(nameArray[i]);</span>
<a href="#l12.2489"></a><span id="l12.2489" class="difflineminus">-        m_messageUriArray[i] = strdup(uriArray[i]);</span>
<a href="#l12.2490"></a><span id="l12.2490" class="difflineminus">-    }</span>
<a href="#l12.2491"></a><span id="l12.2491" class="difflineminus">-    m_directoryName = NS_xstrdup(dirName);</span>
<a href="#l12.2492"></a><span id="l12.2492" class="difflineminus">-    m_detachingAttachments = detachingAttachments;</span>
<a href="#l12.2493"></a><span id="l12.2493" class="difflineplus">+nsSaveAllAttachmentsState::nsSaveAllAttachmentsState(</span>
<a href="#l12.2494"></a><span id="l12.2494" class="difflineplus">+    uint32_t count, const char **contentTypeArray, const char **urlArray,</span>
<a href="#l12.2495"></a><span id="l12.2495" class="difflineplus">+    const char **nameArray, const char **uriArray, const PathChar *dirName,</span>
<a href="#l12.2496"></a><span id="l12.2496" class="difflineplus">+    bool detachingAttachments)</span>
<a href="#l12.2497"></a><span id="l12.2497" class="difflineplus">+    : m_withoutWarning(false) {</span>
<a href="#l12.2498"></a><span id="l12.2498" class="difflineplus">+  uint32_t i;</span>
<a href="#l12.2499"></a><span id="l12.2499" class="difflineplus">+  NS_ASSERTION(count &amp;&amp; urlArray &amp;&amp; nameArray &amp;&amp; uriArray &amp;&amp; dirName,</span>
<a href="#l12.2500"></a><span id="l12.2500" class="difflineplus">+               &quot;fatal - invalid parameters\n&quot;);</span>
<a href="#l12.2501"></a><span id="l12.2501" class="difflineplus">+</span>
<a href="#l12.2502"></a><span id="l12.2502" class="difflineplus">+  m_count = count;</span>
<a href="#l12.2503"></a><span id="l12.2503" class="difflineplus">+  m_curIndex = 0;</span>
<a href="#l12.2504"></a><span id="l12.2504" class="difflineplus">+  m_contentTypeArray = new char *[count];</span>
<a href="#l12.2505"></a><span id="l12.2505" class="difflineplus">+  m_urlArray = new char *[count];</span>
<a href="#l12.2506"></a><span id="l12.2506" class="difflineplus">+  m_displayNameArray = new char *[count];</span>
<a href="#l12.2507"></a><span id="l12.2507" class="difflineplus">+  m_messageUriArray = new char *[count];</span>
<a href="#l12.2508"></a><span id="l12.2508" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l12.2509"></a><span id="l12.2509" class="difflineplus">+    m_contentTypeArray[i] = strdup(contentTypeArray[i]);</span>
<a href="#l12.2510"></a><span id="l12.2510" class="difflineplus">+    m_urlArray[i] = strdup(urlArray[i]);</span>
<a href="#l12.2511"></a><span id="l12.2511" class="difflineplus">+    m_displayNameArray[i] = strdup(nameArray[i]);</span>
<a href="#l12.2512"></a><span id="l12.2512" class="difflineplus">+    m_messageUriArray[i] = strdup(uriArray[i]);</span>
<a href="#l12.2513"></a><span id="l12.2513" class="difflineplus">+  }</span>
<a href="#l12.2514"></a><span id="l12.2514" class="difflineplus">+  m_directoryName = NS_xstrdup(dirName);</span>
<a href="#l12.2515"></a><span id="l12.2515" class="difflineplus">+  m_detachingAttachments = detachingAttachments;</span>
<a href="#l12.2516"></a><span id="l12.2516"> }</span>
<a href="#l12.2517"></a><span id="l12.2517"> </span>
<a href="#l12.2518"></a><span id="l12.2518" class="difflineminus">-nsSaveAllAttachmentsState::~nsSaveAllAttachmentsState()</span>
<a href="#l12.2519"></a><span id="l12.2519" class="difflineminus">-{</span>
<a href="#l12.2520"></a><span id="l12.2520" class="difflineminus">-    uint32_t i;</span>
<a href="#l12.2521"></a><span id="l12.2521" class="difflineminus">-    for (i = 0; i &lt; m_count; i++)</span>
<a href="#l12.2522"></a><span id="l12.2522" class="difflineminus">-    {</span>
<a href="#l12.2523"></a><span id="l12.2523" class="difflineminus">-      free(m_contentTypeArray[i]);</span>
<a href="#l12.2524"></a><span id="l12.2524" class="difflineminus">-      free(m_urlArray[i]);</span>
<a href="#l12.2525"></a><span id="l12.2525" class="difflineminus">-      free(m_displayNameArray[i]);</span>
<a href="#l12.2526"></a><span id="l12.2526" class="difflineminus">-      free(m_messageUriArray[i]);</span>
<a href="#l12.2527"></a><span id="l12.2527" class="difflineminus">-    }</span>
<a href="#l12.2528"></a><span id="l12.2528" class="difflineminus">-    delete[] m_contentTypeArray;</span>
<a href="#l12.2529"></a><span id="l12.2529" class="difflineminus">-    delete[] m_urlArray;</span>
<a href="#l12.2530"></a><span id="l12.2530" class="difflineminus">-    delete[] m_displayNameArray;</span>
<a href="#l12.2531"></a><span id="l12.2531" class="difflineminus">-    delete[] m_messageUriArray;</span>
<a href="#l12.2532"></a><span id="l12.2532" class="difflineminus">-    free(m_directoryName);</span>
<a href="#l12.2533"></a><span id="l12.2533" class="difflineplus">+nsSaveAllAttachmentsState::~nsSaveAllAttachmentsState() {</span>
<a href="#l12.2534"></a><span id="l12.2534" class="difflineplus">+  uint32_t i;</span>
<a href="#l12.2535"></a><span id="l12.2535" class="difflineplus">+  for (i = 0; i &lt; m_count; i++) {</span>
<a href="#l12.2536"></a><span id="l12.2536" class="difflineplus">+    free(m_contentTypeArray[i]);</span>
<a href="#l12.2537"></a><span id="l12.2537" class="difflineplus">+    free(m_urlArray[i]);</span>
<a href="#l12.2538"></a><span id="l12.2538" class="difflineplus">+    free(m_displayNameArray[i]);</span>
<a href="#l12.2539"></a><span id="l12.2539" class="difflineplus">+    free(m_messageUriArray[i]);</span>
<a href="#l12.2540"></a><span id="l12.2540" class="difflineplus">+  }</span>
<a href="#l12.2541"></a><span id="l12.2541" class="difflineplus">+  delete[] m_contentTypeArray;</span>
<a href="#l12.2542"></a><span id="l12.2542" class="difflineplus">+  delete[] m_urlArray;</span>
<a href="#l12.2543"></a><span id="l12.2543" class="difflineplus">+  delete[] m_displayNameArray;</span>
<a href="#l12.2544"></a><span id="l12.2544" class="difflineplus">+  delete[] m_messageUriArray;</span>
<a href="#l12.2545"></a><span id="l12.2545" class="difflineplus">+  free(m_directoryName);</span>
<a href="#l12.2546"></a><span id="l12.2546"> }</span>
<a href="#l12.2547"></a><span id="l12.2547"> </span>
<a href="#l12.2548"></a><span id="l12.2548" class="difflineminus">-nsresult</span>
<a href="#l12.2549"></a><span id="l12.2549" class="difflineminus">-nsMessenger::GetLastSaveDirectory(nsIFile **aLastSaveDir)</span>
<a href="#l12.2550"></a><span id="l12.2550" class="difflineminus">-{</span>
<a href="#l12.2551"></a><span id="l12.2551" class="difflineplus">+nsresult nsMessenger::GetLastSaveDirectory(nsIFile **aLastSaveDir) {</span>
<a href="#l12.2552"></a><span id="l12.2552">   nsresult rv;</span>
<a href="#l12.2553"></a><span id="l12.2553" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.2554"></a><span id="l12.2554" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.2555"></a><span id="l12.2555" class="difflineminus">-</span>
<a href="#l12.2556"></a><span id="l12.2556" class="difflineminus">-  // this can fail, and it will, on the first time we call it, as there is no default for this pref.</span>
<a href="#l12.2557"></a><span id="l12.2557" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; localFile;</span>
<a href="#l12.2558"></a><span id="l12.2558" class="difflineminus">-  rv = prefBranch-&gt;GetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME, NS_GET_IID(nsIFile), getter_AddRefs(localFile));</span>
<a href="#l12.2559"></a><span id="l12.2559" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.2560"></a><span id="l12.2560" class="difflineminus">-    localFile.forget(aLastSaveDir);</span>
<a href="#l12.2561"></a><span id="l12.2561" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l12.2562"></a><span id="l12.2562" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.2563"></a><span id="l12.2563" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2564"></a><span id="l12.2564" class="difflineplus">+</span>
<a href="#l12.2565"></a><span id="l12.2565" class="difflineplus">+  // this can fail, and it will, on the first time we call it, as there is no</span>
<a href="#l12.2566"></a><span id="l12.2566" class="difflineplus">+  // default for this pref.</span>
<a href="#l12.2567"></a><span id="l12.2567" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l12.2568"></a><span id="l12.2568" class="difflineplus">+  rv = prefBranch-&gt;GetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME,</span>
<a href="#l12.2569"></a><span id="l12.2569" class="difflineplus">+                                   NS_GET_IID(nsIFile),</span>
<a href="#l12.2570"></a><span id="l12.2570" class="difflineplus">+                                   getter_AddRefs(localFile));</span>
<a href="#l12.2571"></a><span id="l12.2571" class="difflineplus">+  if (NS_SUCCEEDED(rv)) localFile.forget(aLastSaveDir);</span>
<a href="#l12.2572"></a><span id="l12.2572">   return rv;</span>
<a href="#l12.2573"></a><span id="l12.2573"> }</span>
<a href="#l12.2574"></a><span id="l12.2574"> </span>
<a href="#l12.2575"></a><span id="l12.2575" class="difflineminus">-nsresult</span>
<a href="#l12.2576"></a><span id="l12.2576" class="difflineminus">-nsMessenger::SetLastSaveDirectory(nsIFile *aLocalFile)</span>
<a href="#l12.2577"></a><span id="l12.2577" class="difflineminus">-{</span>
<a href="#l12.2578"></a><span id="l12.2578" class="difflineplus">+nsresult nsMessenger::SetLastSaveDirectory(nsIFile *aLocalFile) {</span>
<a href="#l12.2579"></a><span id="l12.2579">   NS_ENSURE_ARG_POINTER(aLocalFile);</span>
<a href="#l12.2580"></a><span id="l12.2580">   nsresult rv;</span>
<a href="#l12.2581"></a><span id="l12.2581" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.2582"></a><span id="l12.2582" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.2583"></a><span id="l12.2583" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l12.2584"></a><span id="l12.2584" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.2585"></a><span id="l12.2585" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2586"></a><span id="l12.2586"> </span>
<a href="#l12.2587"></a><span id="l12.2587">   // if the file is a directory, just use it for the last dir chosen</span>
<a href="#l12.2588"></a><span id="l12.2588">   // otherwise, use the parent of the file as the last dir chosen.</span>
<a href="#l12.2589"></a><span id="l12.2589">   // IsDirectory() will return error on saving a file, as the</span>
<a href="#l12.2590"></a><span id="l12.2590">   // file doesn't exist yet.</span>
<a href="#l12.2591"></a><span id="l12.2591">   bool isDirectory;</span>
<a href="#l12.2592"></a><span id="l12.2592">   rv = aLocalFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l12.2593"></a><span id="l12.2593">   if (NS_SUCCEEDED(rv) &amp;&amp; isDirectory) {</span>
<a href="#l12.2594"></a><span id="l12.2594" class="difflineminus">-    rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME, NS_GET_IID(nsIFile), aLocalFile);</span>
<a href="#l12.2595"></a><span id="l12.2595" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.2596"></a><span id="l12.2596" class="difflineminus">-  }</span>
<a href="#l12.2597"></a><span id="l12.2597" class="difflineminus">-  else {</span>
<a href="#l12.2598"></a><span id="l12.2598" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; parent;</span>
<a href="#l12.2599"></a><span id="l12.2599" class="difflineplus">+    rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME,</span>
<a href="#l12.2600"></a><span id="l12.2600" class="difflineplus">+                                     NS_GET_IID(nsIFile), aLocalFile);</span>
<a href="#l12.2601"></a><span id="l12.2601" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2602"></a><span id="l12.2602" class="difflineplus">+  } else {</span>
<a href="#l12.2603"></a><span id="l12.2603" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l12.2604"></a><span id="l12.2604">     rv = aLocalFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l12.2605"></a><span id="l12.2605" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.2606"></a><span id="l12.2606" class="difflineminus">-</span>
<a href="#l12.2607"></a><span id="l12.2607" class="difflineminus">-    rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME, NS_GET_IID(nsIFile), parent);</span>
<a href="#l12.2608"></a><span id="l12.2608" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.2609"></a><span id="l12.2609" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2610"></a><span id="l12.2610" class="difflineplus">+</span>
<a href="#l12.2611"></a><span id="l12.2611" class="difflineplus">+    rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME,</span>
<a href="#l12.2612"></a><span id="l12.2612" class="difflineplus">+                                     NS_GET_IID(nsIFile), parent);</span>
<a href="#l12.2613"></a><span id="l12.2613" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2614"></a><span id="l12.2614">   }</span>
<a href="#l12.2615"></a><span id="l12.2615">   return NS_OK;</span>
<a href="#l12.2616"></a><span id="l12.2616"> }</span>
<a href="#l12.2617"></a><span id="l12.2617"> </span>
<a href="#l12.2618"></a><span id="l12.2618" class="difflineminus">-/* void getUrisAtNavigatePos (in long aPos, out ACString aFolderUri, out ACString aMsgUri); */</span>
<a href="#l12.2619"></a><span id="l12.2619" class="difflineplus">+/* void getUrisAtNavigatePos (in long aPos, out ACString aFolderUri, out</span>
<a href="#l12.2620"></a><span id="l12.2620" class="difflineplus">+ * ACString aMsgUri); */</span>
<a href="#l12.2621"></a><span id="l12.2621"> // aPos is relative to the current history cursor - 1 is forward, -1 is back.</span>
<a href="#l12.2622"></a><span id="l12.2622" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetMsgUriAtNavigatePos(int32_t aPos, nsACString&amp; aMsgUri)</span>
<a href="#l12.2623"></a><span id="l12.2623" class="difflineminus">-{</span>
<a href="#l12.2624"></a><span id="l12.2624" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetMsgUriAtNavigatePos(int32_t aPos,</span>
<a href="#l12.2625"></a><span id="l12.2625" class="difflineplus">+                                                  nsACString &amp;aMsgUri) {</span>
<a href="#l12.2626"></a><span id="l12.2626">   int32_t desiredArrayIndex = (mCurHistoryPos + (aPos &lt;&lt; 1));</span>
<a href="#l12.2627"></a><span id="l12.2627" class="difflineminus">-  if (desiredArrayIndex &gt;= 0 &amp;&amp; desiredArrayIndex &lt; (int32_t)mLoadedMsgHistory.Length())</span>
<a href="#l12.2628"></a><span id="l12.2628" class="difflineminus">-  {</span>
<a href="#l12.2629"></a><span id="l12.2629" class="difflineplus">+  if (desiredArrayIndex &gt;= 0 &amp;&amp;</span>
<a href="#l12.2630"></a><span id="l12.2630" class="difflineplus">+      desiredArrayIndex &lt; (int32_t)mLoadedMsgHistory.Length()) {</span>
<a href="#l12.2631"></a><span id="l12.2631">     mNavigatingToUri = mLoadedMsgHistory[desiredArrayIndex];</span>
<a href="#l12.2632"></a><span id="l12.2632">     aMsgUri = mNavigatingToUri;</span>
<a href="#l12.2633"></a><span id="l12.2633">     return NS_OK;</span>
<a href="#l12.2634"></a><span id="l12.2634">   }</span>
<a href="#l12.2635"></a><span id="l12.2635">   return NS_ERROR_FAILURE;</span>
<a href="#l12.2636"></a><span id="l12.2636"> }</span>
<a href="#l12.2637"></a><span id="l12.2637"> </span>
<a href="#l12.2638"></a><span id="l12.2638" class="difflineminus">-NS_IMETHODIMP nsMessenger::SetNavigatePos(int32_t aPos)</span>
<a href="#l12.2639"></a><span id="l12.2639" class="difflineminus">-{</span>
<a href="#l12.2640"></a><span id="l12.2640" class="difflineminus">-  if ((aPos &lt;&lt; 1) &lt; (int32_t)mLoadedMsgHistory.Length())</span>
<a href="#l12.2641"></a><span id="l12.2641" class="difflineminus">-  {</span>
<a href="#l12.2642"></a><span id="l12.2642" class="difflineplus">+NS_IMETHODIMP nsMessenger::SetNavigatePos(int32_t aPos) {</span>
<a href="#l12.2643"></a><span id="l12.2643" class="difflineplus">+  if ((aPos &lt;&lt; 1) &lt; (int32_t)mLoadedMsgHistory.Length()) {</span>
<a href="#l12.2644"></a><span id="l12.2644">     mCurHistoryPos = aPos &lt;&lt; 1;</span>
<a href="#l12.2645"></a><span id="l12.2645">     return NS_OK;</span>
<a href="#l12.2646"></a><span id="l12.2646" class="difflineminus">-  }</span>
<a href="#l12.2647"></a><span id="l12.2647" class="difflineminus">-  else</span>
<a href="#l12.2648"></a><span id="l12.2648" class="difflineplus">+  } else</span>
<a href="#l12.2649"></a><span id="l12.2649">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.2650"></a><span id="l12.2650"> }</span>
<a href="#l12.2651"></a><span id="l12.2651"> </span>
<a href="#l12.2652"></a><span id="l12.2652" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetNavigatePos(int32_t *aPos)</span>
<a href="#l12.2653"></a><span id="l12.2653" class="difflineminus">-{</span>
<a href="#l12.2654"></a><span id="l12.2654" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetNavigatePos(int32_t *aPos) {</span>
<a href="#l12.2655"></a><span id="l12.2655">   NS_ENSURE_ARG_POINTER(aPos);</span>
<a href="#l12.2656"></a><span id="l12.2656">   *aPos = mCurHistoryPos &gt;&gt; 1;</span>
<a href="#l12.2657"></a><span id="l12.2657">   return NS_OK;</span>
<a href="#l12.2658"></a><span id="l12.2658"> }</span>
<a href="#l12.2659"></a><span id="l12.2659"> </span>
<a href="#l12.2660"></a><span id="l12.2660"> // aPos is relative to the current history cursor - 1 is forward, -1 is back.</span>
<a href="#l12.2661"></a><span id="l12.2661" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetFolderUriAtNavigatePos(int32_t aPos, nsACString&amp; aFolderUri)</span>
<a href="#l12.2662"></a><span id="l12.2662" class="difflineminus">-{</span>
<a href="#l12.2663"></a><span id="l12.2663" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetFolderUriAtNavigatePos(int32_t aPos,</span>
<a href="#l12.2664"></a><span id="l12.2664" class="difflineplus">+                                                     nsACString &amp;aFolderUri) {</span>
<a href="#l12.2665"></a><span id="l12.2665">   int32_t desiredArrayIndex = (mCurHistoryPos + (aPos &lt;&lt; 1));</span>
<a href="#l12.2666"></a><span id="l12.2666" class="difflineminus">-  if (desiredArrayIndex &gt;= 0 &amp;&amp; desiredArrayIndex &lt; (int32_t)mLoadedMsgHistory.Length())</span>
<a href="#l12.2667"></a><span id="l12.2667" class="difflineminus">-  {</span>
<a href="#l12.2668"></a><span id="l12.2668" class="difflineplus">+  if (desiredArrayIndex &gt;= 0 &amp;&amp;</span>
<a href="#l12.2669"></a><span id="l12.2669" class="difflineplus">+      desiredArrayIndex &lt; (int32_t)mLoadedMsgHistory.Length()) {</span>
<a href="#l12.2670"></a><span id="l12.2670">     mNavigatingToUri = mLoadedMsgHistory[desiredArrayIndex + 1];</span>
<a href="#l12.2671"></a><span id="l12.2671">     aFolderUri = mNavigatingToUri;</span>
<a href="#l12.2672"></a><span id="l12.2672">     return NS_OK;</span>
<a href="#l12.2673"></a><span id="l12.2673">   }</span>
<a href="#l12.2674"></a><span id="l12.2674">   return NS_ERROR_FAILURE;</span>
<a href="#l12.2675"></a><span id="l12.2675"> }</span>
<a href="#l12.2676"></a><span id="l12.2676"> </span>
<a href="#l12.2677"></a><span id="l12.2677" class="difflineminus">-NS_IMETHODIMP nsMessenger::GetNavigateHistory(uint32_t *aCurPos, uint32_t *aCount, char *** aHistoryUris)</span>
<a href="#l12.2678"></a><span id="l12.2678" class="difflineminus">-{</span>
<a href="#l12.2679"></a><span id="l12.2679" class="difflineplus">+NS_IMETHODIMP nsMessenger::GetNavigateHistory(uint32_t *aCurPos,</span>
<a href="#l12.2680"></a><span id="l12.2680" class="difflineplus">+                                              uint32_t *aCount,</span>
<a href="#l12.2681"></a><span id="l12.2681" class="difflineplus">+                                              char ***aHistoryUris) {</span>
<a href="#l12.2682"></a><span id="l12.2682">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l12.2683"></a><span id="l12.2683">   NS_ENSURE_ARG_POINTER(aCurPos);</span>
<a href="#l12.2684"></a><span id="l12.2684"> </span>
<a href="#l12.2685"></a><span id="l12.2685">   *aCurPos = mCurHistoryPos &gt;&gt; 1;</span>
<a href="#l12.2686"></a><span id="l12.2686">   *aCount = mLoadedMsgHistory.Length();</span>
<a href="#l12.2687"></a><span id="l12.2687">   // for just enabling commands, we don't need the history uris.</span>
<a href="#l12.2688"></a><span id="l12.2688" class="difflineminus">-  if (!aHistoryUris)</span>
<a href="#l12.2689"></a><span id="l12.2689" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.2690"></a><span id="l12.2690" class="difflineplus">+  if (!aHistoryUris) return NS_OK;</span>
<a href="#l12.2691"></a><span id="l12.2691"> </span>
<a href="#l12.2692"></a><span id="l12.2692">   char **outArray, **next;</span>
<a href="#l12.2693"></a><span id="l12.2693">   next = outArray = (char **)moz_xmalloc(*aCount * sizeof(char *));</span>
<a href="#l12.2694"></a><span id="l12.2694">   if (!outArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2695"></a><span id="l12.2695" class="difflineminus">-  for (uint32_t i = 0; i &lt; *aCount; i++)</span>
<a href="#l12.2696"></a><span id="l12.2696" class="difflineminus">-  {</span>
<a href="#l12.2697"></a><span id="l12.2697" class="difflineplus">+  for (uint32_t i = 0; i &lt; *aCount; i++) {</span>
<a href="#l12.2698"></a><span id="l12.2698">     *next = ToNewCString(mLoadedMsgHistory[i]);</span>
<a href="#l12.2699"></a><span id="l12.2699" class="difflineminus">-    if (!*next)</span>
<a href="#l12.2700"></a><span id="l12.2700" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2701"></a><span id="l12.2701" class="difflineplus">+    if (!*next) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2702"></a><span id="l12.2702">     next++;</span>
<a href="#l12.2703"></a><span id="l12.2703">   }</span>
<a href="#l12.2704"></a><span id="l12.2704">   *aHistoryUris = outArray;</span>
<a href="#l12.2705"></a><span id="l12.2705">   return NS_OK;</span>
<a href="#l12.2706"></a><span id="l12.2706"> }</span>
<a href="#l12.2707"></a><span id="l12.2707"> </span>
<a href="#l12.2708"></a><span id="l12.2708"> NS_IMETHODIMP</span>
<a href="#l12.2709"></a><span id="l12.2709" class="difflineminus">-nsMessenger::FormatFileSize(uint64_t aSize, bool aUseKB, nsAString&amp; aFormattedSize)</span>
<a href="#l12.2710"></a><span id="l12.2710" class="difflineminus">-{</span>
<a href="#l12.2711"></a><span id="l12.2711" class="difflineplus">+nsMessenger::FormatFileSize(uint64_t aSize, bool aUseKB,</span>
<a href="#l12.2712"></a><span id="l12.2712" class="difflineplus">+                            nsAString &amp;aFormattedSize) {</span>
<a href="#l12.2713"></a><span id="l12.2713">   return ::FormatFileSize(aSize, aUseKB, aFormattedSize);</span>
<a href="#l12.2714"></a><span id="l12.2714"> }</span>
<a href="#l12.2715"></a><span id="l12.2715"> </span>
<a href="#l12.2716"></a><span id="l12.2716" class="difflineminus">-</span>
<a href="#l12.2717"></a><span id="l12.2717" class="difflineminus">-/* void OnItemAdded (in nsIMsgFolder parentItem, in nsISupports item); */</span>
<a href="#l12.2718"></a><span id="l12.2718" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l12.2719"></a><span id="l12.2719" class="difflineminus">-{</span>
<a href="#l12.2720"></a><span id="l12.2720" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemAdded(nsIMsgFolder *parentItem,</span>
<a href="#l12.2721"></a><span id="l12.2721" class="difflineplus">+                                       nsISupports *item) {</span>
<a href="#l12.2722"></a><span id="l12.2722">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2723"></a><span id="l12.2723"> }</span>
<a href="#l12.2724"></a><span id="l12.2724"> </span>
<a href="#l12.2725"></a><span id="l12.2725" class="difflineminus">-/* void OnItemRemoved (in nsIMsgFolder parentItem, in nsISupports item); */</span>
<a href="#l12.2726"></a><span id="l12.2726" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l12.2727"></a><span id="l12.2727" class="difflineminus">-{</span>
<a href="#l12.2728"></a><span id="l12.2728" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemRemoved(nsIMsgFolder *parentItem,</span>
<a href="#l12.2729"></a><span id="l12.2729" class="difflineplus">+                                         nsISupports *item) {</span>
<a href="#l12.2730"></a><span id="l12.2730">   // check if this item is a message header that's in our history list. If so,</span>
<a href="#l12.2731"></a><span id="l12.2731">   // remove it from the history list.</span>
<a href="#l12.2732"></a><span id="l12.2732" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(item);</span>
<a href="#l12.2733"></a><span id="l12.2733" class="difflineminus">-  if (msgHdr)</span>
<a href="#l12.2734"></a><span id="l12.2734" class="difflineminus">-  {</span>
<a href="#l12.2735"></a><span id="l12.2735" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l12.2736"></a><span id="l12.2736" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(item);</span>
<a href="#l12.2737"></a><span id="l12.2737" class="difflineplus">+  if (msgHdr) {</span>
<a href="#l12.2738"></a><span id="l12.2738" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l12.2739"></a><span id="l12.2739">     msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l12.2740"></a><span id="l12.2740" class="difflineminus">-    if (folder)</span>
<a href="#l12.2741"></a><span id="l12.2741" class="difflineminus">-    {</span>
<a href="#l12.2742"></a><span id="l12.2742" class="difflineplus">+    if (folder) {</span>
<a href="#l12.2743"></a><span id="l12.2743">       nsCString msgUri;</span>
<a href="#l12.2744"></a><span id="l12.2744">       nsMsgKey msgKey;</span>
<a href="#l12.2745"></a><span id="l12.2745">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.2746"></a><span id="l12.2746">       folder-&gt;GenerateMessageURI(msgKey, msgUri);</span>
<a href="#l12.2747"></a><span id="l12.2747">       // need to remove the correspnding folder entry, and</span>
<a href="#l12.2748"></a><span id="l12.2748">       // adjust the current history pos.</span>
<a href="#l12.2749"></a><span id="l12.2749">       size_t uriPos = mLoadedMsgHistory.IndexOf(msgUri);</span>
<a href="#l12.2750"></a><span id="l12.2750" class="difflineminus">-      if (uriPos != mLoadedMsgHistory.NoIndex)</span>
<a href="#l12.2751"></a><span id="l12.2751" class="difflineminus">-      {</span>
<a href="#l12.2752"></a><span id="l12.2752" class="difflineplus">+      if (uriPos != mLoadedMsgHistory.NoIndex) {</span>
<a href="#l12.2753"></a><span id="l12.2753">         mLoadedMsgHistory.RemoveElementAt(uriPos);</span>
<a href="#l12.2754"></a><span id="l12.2754" class="difflineminus">-        mLoadedMsgHistory.RemoveElementAt(uriPos); // and the folder uri entry</span>
<a href="#l12.2755"></a><span id="l12.2755" class="difflineminus">-        if (mCurHistoryPos &gt;= (int32_t)uriPos)</span>
<a href="#l12.2756"></a><span id="l12.2756" class="difflineminus">-          mCurHistoryPos -= 2;</span>
<a href="#l12.2757"></a><span id="l12.2757" class="difflineplus">+        mLoadedMsgHistory.RemoveElementAt(uriPos);  // and the folder uri entry</span>
<a href="#l12.2758"></a><span id="l12.2758" class="difflineplus">+        if (mCurHistoryPos &gt;= (int32_t)uriPos) mCurHistoryPos -= 2;</span>
<a href="#l12.2759"></a><span id="l12.2759">       }</span>
<a href="#l12.2760"></a><span id="l12.2760">     }</span>
<a href="#l12.2761"></a><span id="l12.2761">   }</span>
<a href="#l12.2762"></a><span id="l12.2762">   return NS_OK;</span>
<a href="#l12.2763"></a><span id="l12.2763"> }</span>
<a href="#l12.2764"></a><span id="l12.2764"> </span>
<a href="#l12.2765"></a><span id="l12.2765" class="difflineminus">-/* void OnItemPropertyChanged (in nsIMsgFolder item, in ACString property, in string oldValue, in string newValue); */</span>
<a href="#l12.2766"></a><span id="l12.2766" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l12.2767"></a><span id="l12.2767" class="difflineminus">-{</span>
<a href="#l12.2768"></a><span id="l12.2768" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l12.2769"></a><span id="l12.2769" class="difflineplus">+                                                 const nsACString &amp;property,</span>
<a href="#l12.2770"></a><span id="l12.2770" class="difflineplus">+                                                 const char *oldValue,</span>
<a href="#l12.2771"></a><span id="l12.2771" class="difflineplus">+                                                 const char *newValue) {</span>
<a href="#l12.2772"></a><span id="l12.2772">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2773"></a><span id="l12.2773"> }</span>
<a href="#l12.2774"></a><span id="l12.2774"> </span>
<a href="#l12.2775"></a><span id="l12.2775" class="difflineminus">-/* void OnItemIntPropertyChanged (in nsIMsgFolder item, in ACString property, in long long oldValue, in long long newValue); */</span>
<a href="#l12.2776"></a><span id="l12.2776" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemIntPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue, int64_t newValue)</span>
<a href="#l12.2777"></a><span id="l12.2777" class="difflineminus">-{</span>
<a href="#l12.2778"></a><span id="l12.2778" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2779"></a><span id="l12.2779" class="difflineminus">-}</span>
<a href="#l12.2780"></a><span id="l12.2780" class="difflineminus">-</span>
<a href="#l12.2781"></a><span id="l12.2781" class="difflineminus">-/* void OnItemBoolPropertyChanged (in nsIMsgFolder item, in ACString property, in boolean oldValue, in boolean newValue); */</span>
<a href="#l12.2782"></a><span id="l12.2782" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l12.2783"></a><span id="l12.2783" class="difflineminus">-{</span>
<a href="#l12.2784"></a><span id="l12.2784" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemIntPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l12.2785"></a><span id="l12.2785" class="difflineplus">+                                                    const nsACString &amp;property,</span>
<a href="#l12.2786"></a><span id="l12.2786" class="difflineplus">+                                                    int64_t oldValue,</span>
<a href="#l12.2787"></a><span id="l12.2787" class="difflineplus">+                                                    int64_t newValue) {</span>
<a href="#l12.2788"></a><span id="l12.2788">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2789"></a><span id="l12.2789"> }</span>
<a href="#l12.2790"></a><span id="l12.2790"> </span>
<a href="#l12.2791"></a><span id="l12.2791" class="difflineminus">-/* void OnItemUnicharPropertyChanged (in nsIMsgFolder item, in ACString property, in wstring oldValue, in wstring newValue); */</span>
<a href="#l12.2792"></a><span id="l12.2792" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l12.2793"></a><span id="l12.2793" class="difflineminus">-{</span>
<a href="#l12.2794"></a><span id="l12.2794" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemBoolPropertyChanged(nsIMsgFolder *item,</span>
<a href="#l12.2795"></a><span id="l12.2795" class="difflineplus">+                                                     const nsACString &amp;property,</span>
<a href="#l12.2796"></a><span id="l12.2796" class="difflineplus">+                                                     bool oldValue,</span>
<a href="#l12.2797"></a><span id="l12.2797" class="difflineplus">+                                                     bool newValue) {</span>
<a href="#l12.2798"></a><span id="l12.2798">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2799"></a><span id="l12.2799"> }</span>
<a href="#l12.2800"></a><span id="l12.2800"> </span>
<a href="#l12.2801"></a><span id="l12.2801" class="difflineminus">-/* void OnItemPropertyFlagChanged (in nsIMsgDBHdr item, in ACString property, in unsigned long oldFlag, in unsigned long newFlag); */</span>
<a href="#l12.2802"></a><span id="l12.2802" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l12.2803"></a><span id="l12.2803" class="difflineminus">-{</span>
<a href="#l12.2804"></a><span id="l12.2804" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemUnicharPropertyChanged(</span>
<a href="#l12.2805"></a><span id="l12.2805" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue,</span>
<a href="#l12.2806"></a><span id="l12.2806" class="difflineplus">+    const char16_t *newValue) {</span>
<a href="#l12.2807"></a><span id="l12.2807">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2808"></a><span id="l12.2808"> }</span>
<a href="#l12.2809"></a><span id="l12.2809"> </span>
<a href="#l12.2810"></a><span id="l12.2810" class="difflineminus">-/* void OnItemEvent (in nsIMsgFolder item, in string event); */</span>
<a href="#l12.2811"></a><span id="l12.2811" class="difflineminus">-NS_IMETHODIMP nsMessenger::OnItemEvent(nsIMsgFolder *item, const nsACString &amp;event)</span>
<a href="#l12.2812"></a><span id="l12.2812" class="difflineminus">-{</span>
<a href="#l12.2813"></a><span id="l12.2813" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemPropertyFlagChanged(nsIMsgDBHdr *item,</span>
<a href="#l12.2814"></a><span id="l12.2814" class="difflineplus">+                                                     const nsACString &amp;property,</span>
<a href="#l12.2815"></a><span id="l12.2815" class="difflineplus">+                                                     uint32_t oldFlag,</span>
<a href="#l12.2816"></a><span id="l12.2816" class="difflineplus">+                                                     uint32_t newFlag) {</span>
<a href="#l12.2817"></a><span id="l12.2817" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2818"></a><span id="l12.2818" class="difflineplus">+}</span>
<a href="#l12.2819"></a><span id="l12.2819" class="difflineplus">+</span>
<a href="#l12.2820"></a><span id="l12.2820" class="difflineplus">+NS_IMETHODIMP nsMessenger::OnItemEvent(nsIMsgFolder *item,</span>
<a href="#l12.2821"></a><span id="l12.2821" class="difflineplus">+                                       const nsACString &amp;event) {</span>
<a href="#l12.2822"></a><span id="l12.2822">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.2823"></a><span id="l12.2823"> }</span>
<a href="#l12.2824"></a><span id="l12.2824"> </span>
<a href="#l12.2825"></a><span id="l12.2825"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.2826"></a><span id="l12.2826"> // Detach/Delete Attachments</span>
<a href="#l12.2827"></a><span id="l12.2827"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.2828"></a><span id="l12.2828"> </span>
<a href="#l12.2829"></a><span id="l12.2829" class="difflineminus">-static const char * GetAttachmentPartId(const char * aAttachmentUrl)</span>
<a href="#l12.2830"></a><span id="l12.2830" class="difflineminus">-{</span>
<a href="#l12.2831"></a><span id="l12.2831" class="difflineplus">+static const char *GetAttachmentPartId(const char *aAttachmentUrl) {</span>
<a href="#l12.2832"></a><span id="l12.2832">   static const char partIdPrefix[] = &quot;part=&quot;;</span>
<a href="#l12.2833"></a><span id="l12.2833" class="difflineminus">-  const char * partId = PL_strstr(aAttachmentUrl, partIdPrefix);</span>
<a href="#l12.2834"></a><span id="l12.2834" class="difflineplus">+  const char *partId = PL_strstr(aAttachmentUrl, partIdPrefix);</span>
<a href="#l12.2835"></a><span id="l12.2835">   return partId ? (partId + sizeof(partIdPrefix) - 1) : nullptr;</span>
<a href="#l12.2836"></a><span id="l12.2836"> }</span>
<a href="#l12.2837"></a><span id="l12.2837"> </span>
<a href="#l12.2838"></a><span id="l12.2838" class="difflineminus">-static int CompareAttachmentPartId(const char * aAttachUrlLeft, const char * aAttachUrlRight)</span>
<a href="#l12.2839"></a><span id="l12.2839" class="difflineminus">-{</span>
<a href="#l12.2840"></a><span id="l12.2840" class="difflineplus">+static int CompareAttachmentPartId(const char *aAttachUrlLeft,</span>
<a href="#l12.2841"></a><span id="l12.2841" class="difflineplus">+                                   const char *aAttachUrlRight) {</span>
<a href="#l12.2842"></a><span id="l12.2842">   // part ids are numbers separated by periods, like &quot;1.2.3.4&quot;.</span>
<a href="#l12.2843"></a><span id="l12.2843" class="difflineminus">-  // we sort by doing a numerical comparison on each item in turn. e.g. &quot;1.4&quot; &lt; &quot;1.25&quot;</span>
<a href="#l12.2844"></a><span id="l12.2844" class="difflineminus">-  // shorter entries come before longer entries. e.g. &quot;1.4&quot; &lt; &quot;1.4.1.2&quot;</span>
<a href="#l12.2845"></a><span id="l12.2845" class="difflineplus">+  // we sort by doing a numerical comparison on each item in turn. e.g. &quot;1.4&quot; &lt;</span>
<a href="#l12.2846"></a><span id="l12.2846" class="difflineplus">+  // &quot;1.25&quot; shorter entries come before longer entries. e.g. &quot;1.4&quot; &lt; &quot;1.4.1.2&quot;</span>
<a href="#l12.2847"></a><span id="l12.2847">   // return values:</span>
<a href="#l12.2848"></a><span id="l12.2848">   //  -2  left is a parent of right</span>
<a href="#l12.2849"></a><span id="l12.2849">   //  -1  left is less than right</span>
<a href="#l12.2850"></a><span id="l12.2850">   //   0  left == right</span>
<a href="#l12.2851"></a><span id="l12.2851">   //   1  right is greater than left</span>
<a href="#l12.2852"></a><span id="l12.2852">   //   2  right is a parent of left</span>
<a href="#l12.2853"></a><span id="l12.2853"> </span>
<a href="#l12.2854"></a><span id="l12.2854" class="difflineminus">-  const char * partIdLeft  = GetAttachmentPartId(aAttachUrlLeft);</span>
<a href="#l12.2855"></a><span id="l12.2855" class="difflineminus">-  const char * partIdRight = GetAttachmentPartId(aAttachUrlRight);</span>
<a href="#l12.2856"></a><span id="l12.2856" class="difflineplus">+  const char *partIdLeft = GetAttachmentPartId(aAttachUrlLeft);</span>
<a href="#l12.2857"></a><span id="l12.2857" class="difflineplus">+  const char *partIdRight = GetAttachmentPartId(aAttachUrlRight);</span>
<a href="#l12.2858"></a><span id="l12.2858"> </span>
<a href="#l12.2859"></a><span id="l12.2859">   // for detached attachments the URL does not contain any &quot;part=xx&quot;</span>
<a href="#l12.2860"></a><span id="l12.2860" class="difflineminus">-  if(!partIdLeft)</span>
<a href="#l12.2861"></a><span id="l12.2861" class="difflineminus">-    partIdLeft = &quot;0&quot;;</span>
<a href="#l12.2862"></a><span id="l12.2862" class="difflineminus">-</span>
<a href="#l12.2863"></a><span id="l12.2863" class="difflineminus">-  if(!partIdRight)</span>
<a href="#l12.2864"></a><span id="l12.2864" class="difflineminus">-    partIdRight = &quot;0&quot;;</span>
<a href="#l12.2865"></a><span id="l12.2865" class="difflineplus">+  if (!partIdLeft) partIdLeft = &quot;0&quot;;</span>
<a href="#l12.2866"></a><span id="l12.2866" class="difflineplus">+</span>
<a href="#l12.2867"></a><span id="l12.2867" class="difflineplus">+  if (!partIdRight) partIdRight = &quot;0&quot;;</span>
<a href="#l12.2868"></a><span id="l12.2868"> </span>
<a href="#l12.2869"></a><span id="l12.2869">   long idLeft, idRight;</span>
<a href="#l12.2870"></a><span id="l12.2870" class="difflineminus">-  do</span>
<a href="#l12.2871"></a><span id="l12.2871" class="difflineminus">-  {</span>
<a href="#l12.2872"></a><span id="l12.2872" class="difflineminus">-    MOZ_ASSERT(partIdLeft &amp;&amp; IS_DIGIT(*partIdLeft), &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2873"></a><span id="l12.2873" class="difflineminus">-    MOZ_ASSERT(partIdRight &amp;&amp; IS_DIGIT(*partIdRight), &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2874"></a><span id="l12.2874" class="difflineminus">-</span>
<a href="#l12.2875"></a><span id="l12.2875" class="difflineminus">-    // if the part numbers are different then the numerically smaller one is first</span>
<a href="#l12.2876"></a><span id="l12.2876" class="difflineplus">+  do {</span>
<a href="#l12.2877"></a><span id="l12.2877" class="difflineplus">+    MOZ_ASSERT(partIdLeft &amp;&amp; IS_DIGIT(*partIdLeft),</span>
<a href="#l12.2878"></a><span id="l12.2878" class="difflineplus">+               &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2879"></a><span id="l12.2879" class="difflineplus">+    MOZ_ASSERT(partIdRight &amp;&amp; IS_DIGIT(*partIdRight),</span>
<a href="#l12.2880"></a><span id="l12.2880" class="difflineplus">+               &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2881"></a><span id="l12.2881" class="difflineplus">+</span>
<a href="#l12.2882"></a><span id="l12.2882" class="difflineplus">+    // if the part numbers are different then the numerically smaller one is</span>
<a href="#l12.2883"></a><span id="l12.2883" class="difflineplus">+    // first</span>
<a href="#l12.2884"></a><span id="l12.2884">     char *fixConstLoss;</span>
<a href="#l12.2885"></a><span id="l12.2885" class="difflineminus">-    idLeft  = strtol(partIdLeft, &amp;fixConstLoss, 10);</span>
<a href="#l12.2886"></a><span id="l12.2886" class="difflineplus">+    idLeft = strtol(partIdLeft, &amp;fixConstLoss, 10);</span>
<a href="#l12.2887"></a><span id="l12.2887">     partIdLeft = fixConstLoss;</span>
<a href="#l12.2888"></a><span id="l12.2888">     idRight = strtol(partIdRight, &amp;fixConstLoss, 10);</span>
<a href="#l12.2889"></a><span id="l12.2889">     partIdRight = fixConstLoss;</span>
<a href="#l12.2890"></a><span id="l12.2890" class="difflineminus">-    if (idLeft != idRight)</span>
<a href="#l12.2891"></a><span id="l12.2891" class="difflineminus">-      return idLeft &lt; idRight ? -1 : 1;</span>
<a href="#l12.2892"></a><span id="l12.2892" class="difflineplus">+    if (idLeft != idRight) return idLeft &lt; idRight ? -1 : 1;</span>
<a href="#l12.2893"></a><span id="l12.2893"> </span>
<a href="#l12.2894"></a><span id="l12.2894">     // if one part id is complete but the other isn't, then the shortest one</span>
<a href="#l12.2895"></a><span id="l12.2895">     // is first (parents before children)</span>
<a href="#l12.2896"></a><span id="l12.2896" class="difflineminus">-    if (*partIdLeft != *partIdRight)</span>
<a href="#l12.2897"></a><span id="l12.2897" class="difflineminus">-      return *partIdRight ? -2 : 2;</span>
<a href="#l12.2898"></a><span id="l12.2898" class="difflineplus">+    if (*partIdLeft != *partIdRight) return *partIdRight ? -2 : 2;</span>
<a href="#l12.2899"></a><span id="l12.2899"> </span>
<a href="#l12.2900"></a><span id="l12.2900">     // if both part ids are complete (*partIdLeft == *partIdRight now) then</span>
<a href="#l12.2901"></a><span id="l12.2901">     // they are equal</span>
<a href="#l12.2902"></a><span id="l12.2902" class="difflineminus">-    if (!*partIdLeft)</span>
<a href="#l12.2903"></a><span id="l12.2903" class="difflineminus">-      return 0;</span>
<a href="#l12.2904"></a><span id="l12.2904" class="difflineplus">+    if (!*partIdLeft) return 0;</span>
<a href="#l12.2905"></a><span id="l12.2905"> </span>
<a href="#l12.2906"></a><span id="l12.2906">     MOZ_ASSERT(*partIdLeft == '.', &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2907"></a><span id="l12.2907">     MOZ_ASSERT(*partIdRight == '.', &quot;Invalid character in part id string&quot;);</span>
<a href="#l12.2908"></a><span id="l12.2908"> </span>
<a href="#l12.2909"></a><span id="l12.2909">     ++partIdLeft;</span>
<a href="#l12.2910"></a><span id="l12.2910">     ++partIdRight;</span>
<a href="#l12.2911"></a><span id="l12.2911" class="difflineminus">-  }</span>
<a href="#l12.2912"></a><span id="l12.2912" class="difflineminus">-  while (true);</span>
<a href="#l12.2913"></a><span id="l12.2913" class="difflineplus">+  } while (true);</span>
<a href="#l12.2914"></a><span id="l12.2914"> }</span>
<a href="#l12.2915"></a><span id="l12.2915"> </span>
<a href="#l12.2916"></a><span id="l12.2916"> // ------------------------------------</span>
<a href="#l12.2917"></a><span id="l12.2917"> </span>
<a href="#l12.2918"></a><span id="l12.2918"> // struct on purpose -&gt; show that we don't ever want a vtable</span>
<a href="#l12.2919"></a><span id="l12.2919" class="difflineminus">-struct msgAttachment</span>
<a href="#l12.2920"></a><span id="l12.2920" class="difflineminus">-{</span>
<a href="#l12.2921"></a><span id="l12.2921" class="difflineplus">+struct msgAttachment {</span>
<a href="#l12.2922"></a><span id="l12.2922">   msgAttachment()</span>
<a href="#l12.2923"></a><span id="l12.2923" class="difflineminus">-    : mContentType(nullptr),</span>
<a href="#l12.2924"></a><span id="l12.2924" class="difflineminus">-      mUrl(nullptr),</span>
<a href="#l12.2925"></a><span id="l12.2925" class="difflineminus">-      mDisplayName(nullptr),</span>
<a href="#l12.2926"></a><span id="l12.2926" class="difflineminus">-      mMessageUri(nullptr)</span>
<a href="#l12.2927"></a><span id="l12.2927" class="difflineminus">-  {</span>
<a href="#l12.2928"></a><span id="l12.2928" class="difflineminus">-  }</span>
<a href="#l12.2929"></a><span id="l12.2929" class="difflineminus">-</span>
<a href="#l12.2930"></a><span id="l12.2930" class="difflineminus">-  ~msgAttachment()</span>
<a href="#l12.2931"></a><span id="l12.2931" class="difflineminus">-  {</span>
<a href="#l12.2932"></a><span id="l12.2932" class="difflineminus">-    Clear();</span>
<a href="#l12.2933"></a><span id="l12.2933" class="difflineminus">-  }</span>
<a href="#l12.2934"></a><span id="l12.2934" class="difflineminus">-</span>
<a href="#l12.2935"></a><span id="l12.2935" class="difflineminus">-  void Clear()</span>
<a href="#l12.2936"></a><span id="l12.2936" class="difflineminus">-  {</span>
<a href="#l12.2937"></a><span id="l12.2937" class="difflineplus">+      : mContentType(nullptr),</span>
<a href="#l12.2938"></a><span id="l12.2938" class="difflineplus">+        mUrl(nullptr),</span>
<a href="#l12.2939"></a><span id="l12.2939" class="difflineplus">+        mDisplayName(nullptr),</span>
<a href="#l12.2940"></a><span id="l12.2940" class="difflineplus">+        mMessageUri(nullptr) {}</span>
<a href="#l12.2941"></a><span id="l12.2941" class="difflineplus">+</span>
<a href="#l12.2942"></a><span id="l12.2942" class="difflineplus">+  ~msgAttachment() { Clear(); }</span>
<a href="#l12.2943"></a><span id="l12.2943" class="difflineplus">+</span>
<a href="#l12.2944"></a><span id="l12.2944" class="difflineplus">+  void Clear() {</span>
<a href="#l12.2945"></a><span id="l12.2945">     free(mContentType);</span>
<a href="#l12.2946"></a><span id="l12.2946">     free(mUrl);</span>
<a href="#l12.2947"></a><span id="l12.2947">     free(mDisplayName);</span>
<a href="#l12.2948"></a><span id="l12.2948">     free(mMessageUri);</span>
<a href="#l12.2949"></a><span id="l12.2949">   }</span>
<a href="#l12.2950"></a><span id="l12.2950"> </span>
<a href="#l12.2951"></a><span id="l12.2951" class="difflineminus">-  bool Init(const char * aContentType, const char * aUrl,</span>
<a href="#l12.2952"></a><span id="l12.2952" class="difflineminus">-              const char * aDisplayName, const char * aMessageUri)</span>
<a href="#l12.2953"></a><span id="l12.2953" class="difflineminus">-  {</span>
<a href="#l12.2954"></a><span id="l12.2954" class="difflineplus">+  bool Init(const char *aContentType, const char *aUrl,</span>
<a href="#l12.2955"></a><span id="l12.2955" class="difflineplus">+            const char *aDisplayName, const char *aMessageUri) {</span>
<a href="#l12.2956"></a><span id="l12.2956">     Clear();</span>
<a href="#l12.2957"></a><span id="l12.2957">     mContentType = strdup(aContentType);</span>
<a href="#l12.2958"></a><span id="l12.2958">     mUrl = strdup(aUrl);</span>
<a href="#l12.2959"></a><span id="l12.2959">     mDisplayName = strdup(aDisplayName);</span>
<a href="#l12.2960"></a><span id="l12.2960">     mMessageUri = strdup(aMessageUri);</span>
<a href="#l12.2961"></a><span id="l12.2961">     return (mContentType &amp;&amp; mUrl &amp;&amp; mDisplayName &amp;&amp; mMessageUri);</span>
<a href="#l12.2962"></a><span id="l12.2962">   }</span>
<a href="#l12.2963"></a><span id="l12.2963"> </span>
<a href="#l12.2964"></a><span id="l12.2964">   // take the pointers from aSource</span>
<a href="#l12.2965"></a><span id="l12.2965" class="difflineminus">-  void Adopt(msgAttachment &amp; aSource)</span>
<a href="#l12.2966"></a><span id="l12.2966" class="difflineminus">-  {</span>
<a href="#l12.2967"></a><span id="l12.2967" class="difflineplus">+  void Adopt(msgAttachment &amp;aSource) {</span>
<a href="#l12.2968"></a><span id="l12.2968">     Clear();</span>
<a href="#l12.2969"></a><span id="l12.2969"> </span>
<a href="#l12.2970"></a><span id="l12.2970">     mContentType = aSource.mContentType;</span>
<a href="#l12.2971"></a><span id="l12.2971">     mUrl = aSource.mUrl;</span>
<a href="#l12.2972"></a><span id="l12.2972">     mDisplayName = aSource.mDisplayName;</span>
<a href="#l12.2973"></a><span id="l12.2973">     mMessageUri = aSource.mMessageUri;</span>
<a href="#l12.2974"></a><span id="l12.2974"> </span>
<a href="#l12.2975"></a><span id="l12.2975">     aSource.mContentType = nullptr;</span>
<a href="#l12.2976"></a><span id="l12.2976">     aSource.mUrl = nullptr;</span>
<a href="#l12.2977"></a><span id="l12.2977">     aSource.mDisplayName = nullptr;</span>
<a href="#l12.2978"></a><span id="l12.2978">     aSource.mMessageUri = nullptr;</span>
<a href="#l12.2979"></a><span id="l12.2979">   }</span>
<a href="#l12.2980"></a><span id="l12.2980"> </span>
<a href="#l12.2981"></a><span id="l12.2981" class="difflineminus">-  char* mContentType;</span>
<a href="#l12.2982"></a><span id="l12.2982" class="difflineminus">-  char* mUrl;</span>
<a href="#l12.2983"></a><span id="l12.2983" class="difflineminus">-  char* mDisplayName;</span>
<a href="#l12.2984"></a><span id="l12.2984" class="difflineminus">-  char* mMessageUri;</span>
<a href="#l12.2985"></a><span id="l12.2985" class="difflineminus">-</span>
<a href="#l12.2986"></a><span id="l12.2986" class="difflineminus">-private:</span>
<a href="#l12.2987"></a><span id="l12.2987" class="difflineplus">+  char *mContentType;</span>
<a href="#l12.2988"></a><span id="l12.2988" class="difflineplus">+  char *mUrl;</span>
<a href="#l12.2989"></a><span id="l12.2989" class="difflineplus">+  char *mDisplayName;</span>
<a href="#l12.2990"></a><span id="l12.2990" class="difflineplus">+  char *mMessageUri;</span>
<a href="#l12.2991"></a><span id="l12.2991" class="difflineplus">+</span>
<a href="#l12.2992"></a><span id="l12.2992" class="difflineplus">+ private:</span>
<a href="#l12.2993"></a><span id="l12.2993">   // disable by not implementing</span>
<a href="#l12.2994"></a><span id="l12.2994" class="difflineminus">-  msgAttachment(const msgAttachment &amp; rhs);</span>
<a href="#l12.2995"></a><span id="l12.2995" class="difflineminus">-  msgAttachment &amp; operator=(const msgAttachment &amp; rhs);</span>
<a href="#l12.2996"></a><span id="l12.2996" class="difflineplus">+  msgAttachment(const msgAttachment &amp;rhs);</span>
<a href="#l12.2997"></a><span id="l12.2997" class="difflineplus">+  msgAttachment &amp;operator=(const msgAttachment &amp;rhs);</span>
<a href="#l12.2998"></a><span id="l12.2998"> };</span>
<a href="#l12.2999"></a><span id="l12.2999"> </span>
<a href="#l12.3000"></a><span id="l12.3000"> // ------------------------------------</span>
<a href="#l12.3001"></a><span id="l12.3001"> </span>
<a href="#l12.3002"></a><span id="l12.3002" class="difflineminus">-class nsAttachmentState</span>
<a href="#l12.3003"></a><span id="l12.3003" class="difflineminus">-{</span>
<a href="#l12.3004"></a><span id="l12.3004" class="difflineminus">-public:</span>
<a href="#l12.3005"></a><span id="l12.3005" class="difflineplus">+class nsAttachmentState {</span>
<a href="#l12.3006"></a><span id="l12.3006" class="difflineplus">+ public:</span>
<a href="#l12.3007"></a><span id="l12.3007">   nsAttachmentState();</span>
<a href="#l12.3008"></a><span id="l12.3008">   ~nsAttachmentState();</span>
<a href="#l12.3009"></a><span id="l12.3009" class="difflineminus">-  nsresult Init(uint32_t aCount,</span>
<a href="#l12.3010"></a><span id="l12.3010" class="difflineminus">-                const char **aContentTypeArray,</span>
<a href="#l12.3011"></a><span id="l12.3011" class="difflineminus">-                const char **aUrlArray,</span>
<a href="#l12.3012"></a><span id="l12.3012" class="difflineminus">-                const char **aDisplayNameArray,</span>
<a href="#l12.3013"></a><span id="l12.3013" class="difflineplus">+  nsresult Init(uint32_t aCount, const char **aContentTypeArray,</span>
<a href="#l12.3014"></a><span id="l12.3014" class="difflineplus">+                const char **aUrlArray, const char **aDisplayNameArray,</span>
<a href="#l12.3015"></a><span id="l12.3015">                 const char **aMessageUriArray);</span>
<a href="#l12.3016"></a><span id="l12.3016">   nsresult PrepareForAttachmentDelete();</span>
<a href="#l12.3017"></a><span id="l12.3017"> </span>
<a href="#l12.3018"></a><span id="l12.3018" class="difflineminus">-private:</span>
<a href="#l12.3019"></a><span id="l12.3019" class="difflineminus">-  static int SortAttachmentsByPartId(const void * aLeft, const void * aRight);</span>
<a href="#l12.3020"></a><span id="l12.3020" class="difflineminus">-</span>
<a href="#l12.3021"></a><span id="l12.3021" class="difflineminus">-public:</span>
<a href="#l12.3022"></a><span id="l12.3022" class="difflineminus">-  uint32_t        mCount;</span>
<a href="#l12.3023"></a><span id="l12.3023" class="difflineminus">-  uint32_t        mCurIndex;</span>
<a href="#l12.3024"></a><span id="l12.3024" class="difflineminus">-  msgAttachment*  mAttachmentArray;</span>
<a href="#l12.3025"></a><span id="l12.3025" class="difflineplus">+ private:</span>
<a href="#l12.3026"></a><span id="l12.3026" class="difflineplus">+  static int SortAttachmentsByPartId(const void *aLeft, const void *aRight);</span>
<a href="#l12.3027"></a><span id="l12.3027" class="difflineplus">+</span>
<a href="#l12.3028"></a><span id="l12.3028" class="difflineplus">+ public:</span>
<a href="#l12.3029"></a><span id="l12.3029" class="difflineplus">+  uint32_t mCount;</span>
<a href="#l12.3030"></a><span id="l12.3030" class="difflineplus">+  uint32_t mCurIndex;</span>
<a href="#l12.3031"></a><span id="l12.3031" class="difflineplus">+  msgAttachment *mAttachmentArray;</span>
<a href="#l12.3032"></a><span id="l12.3032"> };</span>
<a href="#l12.3033"></a><span id="l12.3033"> </span>
<a href="#l12.3034"></a><span id="l12.3034"> nsAttachmentState::nsAttachmentState()</span>
<a href="#l12.3035"></a><span id="l12.3035" class="difflineminus">-  : mCount(0),</span>
<a href="#l12.3036"></a><span id="l12.3036" class="difflineminus">-    mCurIndex(0),</span>
<a href="#l12.3037"></a><span id="l12.3037" class="difflineminus">-    mAttachmentArray(nullptr)</span>
<a href="#l12.3038"></a><span id="l12.3038" class="difflineminus">-{</span>
<a href="#l12.3039"></a><span id="l12.3039" class="difflineminus">-}</span>
<a href="#l12.3040"></a><span id="l12.3040" class="difflineminus">-</span>
<a href="#l12.3041"></a><span id="l12.3041" class="difflineminus">-nsAttachmentState::~nsAttachmentState()</span>
<a href="#l12.3042"></a><span id="l12.3042" class="difflineminus">-{</span>
<a href="#l12.3043"></a><span id="l12.3043" class="difflineminus">-  delete[] mAttachmentArray;</span>
<a href="#l12.3044"></a><span id="l12.3044" class="difflineminus">-}</span>
<a href="#l12.3045"></a><span id="l12.3045" class="difflineminus">-</span>
<a href="#l12.3046"></a><span id="l12.3046" class="difflineminus">-nsresult</span>
<a href="#l12.3047"></a><span id="l12.3047" class="difflineminus">-nsAttachmentState::Init(uint32_t aCount, const char ** aContentTypeArray,</span>
<a href="#l12.3048"></a><span id="l12.3048" class="difflineminus">-                        const char ** aUrlArray, const char ** aDisplayNameArray,</span>
<a href="#l12.3049"></a><span id="l12.3049" class="difflineminus">-                        const char ** aMessageUriArray)</span>
<a href="#l12.3050"></a><span id="l12.3050" class="difflineminus">-{</span>
<a href="#l12.3051"></a><span id="l12.3051" class="difflineplus">+    : mCount(0), mCurIndex(0), mAttachmentArray(nullptr) {}</span>
<a href="#l12.3052"></a><span id="l12.3052" class="difflineplus">+</span>
<a href="#l12.3053"></a><span id="l12.3053" class="difflineplus">+nsAttachmentState::~nsAttachmentState() { delete[] mAttachmentArray; }</span>
<a href="#l12.3054"></a><span id="l12.3054" class="difflineplus">+</span>
<a href="#l12.3055"></a><span id="l12.3055" class="difflineplus">+nsresult nsAttachmentState::Init(uint32_t aCount,</span>
<a href="#l12.3056"></a><span id="l12.3056" class="difflineplus">+                                 const char **aContentTypeArray,</span>
<a href="#l12.3057"></a><span id="l12.3057" class="difflineplus">+                                 const char **aUrlArray,</span>
<a href="#l12.3058"></a><span id="l12.3058" class="difflineplus">+                                 const char **aDisplayNameArray,</span>
<a href="#l12.3059"></a><span id="l12.3059" class="difflineplus">+                                 const char **aMessageUriArray) {</span>
<a href="#l12.3060"></a><span id="l12.3060">   MOZ_ASSERT(aCount &gt; 0, &quot;count is invalid&quot;);</span>
<a href="#l12.3061"></a><span id="l12.3061"> </span>
<a href="#l12.3062"></a><span id="l12.3062">   mCount = aCount;</span>
<a href="#l12.3063"></a><span id="l12.3063">   mCurIndex = 0;</span>
<a href="#l12.3064"></a><span id="l12.3064">   delete[] mAttachmentArray;</span>
<a href="#l12.3065"></a><span id="l12.3065"> </span>
<a href="#l12.3066"></a><span id="l12.3066">   mAttachmentArray = new msgAttachment[aCount];</span>
<a href="#l12.3067"></a><span id="l12.3067" class="difflineminus">-  if (!mAttachmentArray)</span>
<a href="#l12.3068"></a><span id="l12.3068" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3069"></a><span id="l12.3069" class="difflineminus">-</span>
<a href="#l12.3070"></a><span id="l12.3070" class="difflineminus">-  for(uint32_t u = 0; u &lt; aCount; ++u)</span>
<a href="#l12.3071"></a><span id="l12.3071" class="difflineminus">-  {</span>
<a href="#l12.3072"></a><span id="l12.3072" class="difflineplus">+  if (!mAttachmentArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3073"></a><span id="l12.3073" class="difflineplus">+</span>
<a href="#l12.3074"></a><span id="l12.3074" class="difflineplus">+  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l12.3075"></a><span id="l12.3075">     if (!mAttachmentArray[u].Init(aContentTypeArray[u], aUrlArray[u],</span>
<a href="#l12.3076"></a><span id="l12.3076" class="difflineminus">-      aDisplayNameArray[u], aMessageUriArray[u]))</span>
<a href="#l12.3077"></a><span id="l12.3077" class="difflineplus">+                                  aDisplayNameArray[u], aMessageUriArray[u]))</span>
<a href="#l12.3078"></a><span id="l12.3078">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3079"></a><span id="l12.3079">   }</span>
<a href="#l12.3080"></a><span id="l12.3080"> </span>
<a href="#l12.3081"></a><span id="l12.3081">   return NS_OK;</span>
<a href="#l12.3082"></a><span id="l12.3082"> }</span>
<a href="#l12.3083"></a><span id="l12.3083"> </span>
<a href="#l12.3084"></a><span id="l12.3084" class="difflineminus">-nsresult</span>
<a href="#l12.3085"></a><span id="l12.3085" class="difflineminus">-nsAttachmentState::PrepareForAttachmentDelete()</span>
<a href="#l12.3086"></a><span id="l12.3086" class="difflineminus">-{</span>
<a href="#l12.3087"></a><span id="l12.3087" class="difflineplus">+nsresult nsAttachmentState::PrepareForAttachmentDelete() {</span>
<a href="#l12.3088"></a><span id="l12.3088">   // this must be called before any processing</span>
<a href="#l12.3089"></a><span id="l12.3089" class="difflineminus">-  if (mCurIndex != 0)</span>
<a href="#l12.3090"></a><span id="l12.3090" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l12.3091"></a><span id="l12.3091" class="difflineminus">-</span>
<a href="#l12.3092"></a><span id="l12.3092" class="difflineminus">-  // this prepares the attachment list for use in deletion. In order to prepare, we</span>
<a href="#l12.3093"></a><span id="l12.3093" class="difflineminus">-  // sort the attachments in numerical ascending order on their part id, remove all</span>
<a href="#l12.3094"></a><span id="l12.3094" class="difflineminus">-  // duplicates and remove any subparts which will be removed automatically by the</span>
<a href="#l12.3095"></a><span id="l12.3095" class="difflineminus">-  // removal of the parent.</span>
<a href="#l12.3096"></a><span id="l12.3096" class="difflineplus">+  if (mCurIndex != 0) return NS_ERROR_FAILURE;</span>
<a href="#l12.3097"></a><span id="l12.3097" class="difflineplus">+</span>
<a href="#l12.3098"></a><span id="l12.3098" class="difflineplus">+  // this prepares the attachment list for use in deletion. In order to prepare,</span>
<a href="#l12.3099"></a><span id="l12.3099" class="difflineplus">+  // we sort the attachments in numerical ascending order on their part id,</span>
<a href="#l12.3100"></a><span id="l12.3100" class="difflineplus">+  // remove all duplicates and remove any subparts which will be removed</span>
<a href="#l12.3101"></a><span id="l12.3101" class="difflineplus">+  // automatically by the removal of the parent.</span>
<a href="#l12.3102"></a><span id="l12.3102">   //</span>
<a href="#l12.3103"></a><span id="l12.3103">   // e.g. the attachment list processing (showing only part ids)</span>
<a href="#l12.3104"></a><span id="l12.3104">   // before: 1.11, 1.3, 1.2, 1.2.1.3, 1.4.1.2</span>
<a href="#l12.3105"></a><span id="l12.3105">   // sorted: 1.2, 1.2.1.3, 1.3, 1.4.1.2, 1.11</span>
<a href="#l12.3106"></a><span id="l12.3106">   // after:  1.2, 1.3, 1.4.1.2, 1.11</span>
<a href="#l12.3107"></a><span id="l12.3107"> </span>
<a href="#l12.3108"></a><span id="l12.3108">   // sort</span>
<a href="#l12.3109"></a><span id="l12.3109" class="difflineminus">-  qsort(mAttachmentArray, mCount, sizeof(msgAttachment), SortAttachmentsByPartId);</span>
<a href="#l12.3110"></a><span id="l12.3110" class="difflineplus">+  qsort(mAttachmentArray, mCount, sizeof(msgAttachment),</span>
<a href="#l12.3111"></a><span id="l12.3111" class="difflineplus">+        SortAttachmentsByPartId);</span>
<a href="#l12.3112"></a><span id="l12.3112"> </span>
<a href="#l12.3113"></a><span id="l12.3113">   // remove duplicates and sub-items</span>
<a href="#l12.3114"></a><span id="l12.3114">   int nCompare;</span>
<a href="#l12.3115"></a><span id="l12.3115" class="difflineminus">-  for(uint32_t u = 1; u &lt; mCount;)</span>
<a href="#l12.3116"></a><span id="l12.3116" class="difflineminus">-  {</span>
<a href="#l12.3117"></a><span id="l12.3117" class="difflineminus">-    nCompare = ::CompareAttachmentPartId(mAttachmentArray[u-1].mUrl, mAttachmentArray[u].mUrl);</span>
<a href="#l12.3118"></a><span id="l12.3118" class="difflineminus">-    if (nCompare == 0 || nCompare == -2) // [u-1] is the same as or a parent of [u]</span>
<a href="#l12.3119"></a><span id="l12.3119" class="difflineplus">+  for (uint32_t u = 1; u &lt; mCount;) {</span>
<a href="#l12.3120"></a><span id="l12.3120" class="difflineplus">+    nCompare = ::CompareAttachmentPartId(mAttachmentArray[u - 1].mUrl,</span>
<a href="#l12.3121"></a><span id="l12.3121" class="difflineplus">+                                         mAttachmentArray[u].mUrl);</span>
<a href="#l12.3122"></a><span id="l12.3122" class="difflineplus">+    if (nCompare == 0 ||</span>
<a href="#l12.3123"></a><span id="l12.3123" class="difflineplus">+        nCompare == -2)  // [u-1] is the same as or a parent of [u]</span>
<a href="#l12.3124"></a><span id="l12.3124">     {</span>
<a href="#l12.3125"></a><span id="l12.3125">       // shuffle the array down (and thus keeping the sorted order)</span>
<a href="#l12.3126"></a><span id="l12.3126">       // this will get rid of the current unnecessary element</span>
<a href="#l12.3127"></a><span id="l12.3127" class="difflineminus">-      for (uint32_t i = u + 1; i &lt; mCount; ++i)</span>
<a href="#l12.3128"></a><span id="l12.3128" class="difflineminus">-      {</span>
<a href="#l12.3129"></a><span id="l12.3129" class="difflineminus">-        mAttachmentArray[i-1].Adopt(mAttachmentArray[i]);</span>
<a href="#l12.3130"></a><span id="l12.3130" class="difflineplus">+      for (uint32_t i = u + 1; i &lt; mCount; ++i) {</span>
<a href="#l12.3131"></a><span id="l12.3131" class="difflineplus">+        mAttachmentArray[i - 1].Adopt(mAttachmentArray[i]);</span>
<a href="#l12.3132"></a><span id="l12.3132">       }</span>
<a href="#l12.3133"></a><span id="l12.3133">       --mCount;</span>
<a href="#l12.3134"></a><span id="l12.3134" class="difflineminus">-    }</span>
<a href="#l12.3135"></a><span id="l12.3135" class="difflineminus">-    else</span>
<a href="#l12.3136"></a><span id="l12.3136" class="difflineminus">-    {</span>
<a href="#l12.3137"></a><span id="l12.3137" class="difflineplus">+    } else {</span>
<a href="#l12.3138"></a><span id="l12.3138">       ++u;</span>
<a href="#l12.3139"></a><span id="l12.3139">     }</span>
<a href="#l12.3140"></a><span id="l12.3140">   }</span>
<a href="#l12.3141"></a><span id="l12.3141"> </span>
<a href="#l12.3142"></a><span id="l12.3142">   return NS_OK;</span>
<a href="#l12.3143"></a><span id="l12.3143"> }</span>
<a href="#l12.3144"></a><span id="l12.3144"> </span>
<a href="#l12.3145"></a><span id="l12.3145" class="difflineminus">-int</span>
<a href="#l12.3146"></a><span id="l12.3146" class="difflineminus">-nsAttachmentState::SortAttachmentsByPartId(const void * aLeft, const void * aRight)</span>
<a href="#l12.3147"></a><span id="l12.3147" class="difflineminus">-{</span>
<a href="#l12.3148"></a><span id="l12.3148" class="difflineminus">-  msgAttachment &amp; attachLeft  = *((msgAttachment*) aLeft);</span>
<a href="#l12.3149"></a><span id="l12.3149" class="difflineminus">-  msgAttachment &amp; attachRight = *((msgAttachment*) aRight);</span>
<a href="#l12.3150"></a><span id="l12.3150" class="difflineplus">+int nsAttachmentState::SortAttachmentsByPartId(const void *aLeft,</span>
<a href="#l12.3151"></a><span id="l12.3151" class="difflineplus">+                                               const void *aRight) {</span>
<a href="#l12.3152"></a><span id="l12.3152" class="difflineplus">+  msgAttachment &amp;attachLeft = *((msgAttachment *)aLeft);</span>
<a href="#l12.3153"></a><span id="l12.3153" class="difflineplus">+  msgAttachment &amp;attachRight = *((msgAttachment *)aRight);</span>
<a href="#l12.3154"></a><span id="l12.3154">   return ::CompareAttachmentPartId(attachLeft.mUrl, attachRight.mUrl);</span>
<a href="#l12.3155"></a><span id="l12.3155"> }</span>
<a href="#l12.3156"></a><span id="l12.3156"> </span>
<a href="#l12.3157"></a><span id="l12.3157"> // ------------------------------------</span>
<a href="#l12.3158"></a><span id="l12.3158"> </span>
<a href="#l12.3159"></a><span id="l12.3159"> class nsDelAttachListener : public nsIStreamListener,</span>
<a href="#l12.3160"></a><span id="l12.3160">                             public nsIUrlListener,</span>
<a href="#l12.3161"></a><span id="l12.3161" class="difflineminus">-                            public nsIMsgCopyServiceListener</span>
<a href="#l12.3162"></a><span id="l12.3162" class="difflineminus">-{</span>
<a href="#l12.3163"></a><span id="l12.3163" class="difflineminus">-public:</span>
<a href="#l12.3164"></a><span id="l12.3164" class="difflineplus">+                            public nsIMsgCopyServiceListener {</span>
<a href="#l12.3165"></a><span id="l12.3165" class="difflineplus">+ public:</span>
<a href="#l12.3166"></a><span id="l12.3166">   NS_DECL_ISUPPORTS</span>
<a href="#l12.3167"></a><span id="l12.3167">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l12.3168"></a><span id="l12.3168">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l12.3169"></a><span id="l12.3169">   NS_DECL_NSIURLLISTENER</span>
<a href="#l12.3170"></a><span id="l12.3170">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l12.3171"></a><span id="l12.3171"> </span>
<a href="#l12.3172"></a><span id="l12.3172" class="difflineminus">-public:</span>
<a href="#l12.3173"></a><span id="l12.3173" class="difflineplus">+ public:</span>
<a href="#l12.3174"></a><span id="l12.3174">   nsDelAttachListener();</span>
<a href="#l12.3175"></a><span id="l12.3175" class="difflineminus">-  nsresult StartProcessing(nsMessenger * aMessenger, nsIMsgWindow * aMsgWindow,</span>
<a href="#l12.3176"></a><span id="l12.3176" class="difflineminus">-    nsAttachmentState * aAttach, bool aSaveFirst);</span>
<a href="#l12.3177"></a><span id="l12.3177" class="difflineplus">+  nsresult StartProcessing(nsMessenger *aMessenger, nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.3178"></a><span id="l12.3178" class="difflineplus">+                           nsAttachmentState *aAttach, bool aSaveFirst);</span>
<a href="#l12.3179"></a><span id="l12.3179">   nsresult DeleteOriginalMessage();</span>
<a href="#l12.3180"></a><span id="l12.3180">   void SelectNewMessage();</span>
<a href="#l12.3181"></a><span id="l12.3181"> </span>
<a href="#l12.3182"></a><span id="l12.3182" class="difflineminus">-public:</span>
<a href="#l12.3183"></a><span id="l12.3183" class="difflineminus">-  nsAttachmentState * mAttach;                      // list of attachments to process</span>
<a href="#l12.3184"></a><span id="l12.3184" class="difflineminus">-  bool mSaveFirst;                                // detach (true) or delete (false)</span>
<a href="#l12.3185"></a><span id="l12.3185" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; mMsgFile;                       // temporary file (processed mail)</span>
<a href="#l12.3186"></a><span id="l12.3186" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; mMsgFileStream;         // temporary file (processed mail)</span>
<a href="#l12.3187"></a><span id="l12.3187" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMessageService&gt; mMessageService;   // original message service</span>
<a href="#l12.3188"></a><span id="l12.3188" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOriginalMessage;           // original message header</span>
<a href="#l12.3189"></a><span id="l12.3189" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; mMessageFolder;            // original message folder</span>
<a href="#l12.3190"></a><span id="l12.3190" class="difflineminus">-  nsCOMPtr&lt;nsIMessenger&gt; mMessenger;                // our messenger instance</span>
<a href="#l12.3191"></a><span id="l12.3191" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;                // our UI window</span>
<a href="#l12.3192"></a><span id="l12.3192" class="difflineminus">-  nsMsgKey mNewMessageKey;                          // new message key</span>
<a href="#l12.3193"></a><span id="l12.3193" class="difflineplus">+ public:</span>
<a href="#l12.3194"></a><span id="l12.3194" class="difflineplus">+  nsAttachmentState *mAttach;                // list of attachments to process</span>
<a href="#l12.3195"></a><span id="l12.3195" class="difflineplus">+  bool mSaveFirst;                           // detach (true) or delete (false)</span>
<a href="#l12.3196"></a><span id="l12.3196" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mMsgFile;                // temporary file (processed mail)</span>
<a href="#l12.3197"></a><span id="l12.3197" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mMsgFileStream;  // temporary file (processed mail)</span>
<a href="#l12.3198"></a><span id="l12.3198" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; mMessageService;  // original message service</span>
<a href="#l12.3199"></a><span id="l12.3199" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOriginalMessage;          // original message header</span>
<a href="#l12.3200"></a><span id="l12.3200" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; mMessageFolder;           // original message folder</span>
<a href="#l12.3201"></a><span id="l12.3201" class="difflineplus">+  nsCOMPtr&lt;nsIMessenger&gt; mMessenger;               // our messenger instance</span>
<a href="#l12.3202"></a><span id="l12.3202" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;               // our UI window</span>
<a href="#l12.3203"></a><span id="l12.3203" class="difflineplus">+  nsMsgKey mNewMessageKey;                         // new message key</span>
<a href="#l12.3204"></a><span id="l12.3204">   uint32_t mOrigMsgFlags;</span>
<a href="#l12.3205"></a><span id="l12.3205"> </span>
<a href="#l12.3206"></a><span id="l12.3206" class="difflineminus">-</span>
<a href="#l12.3207"></a><span id="l12.3207" class="difflineminus">-   enum {</span>
<a href="#l12.3208"></a><span id="l12.3208" class="difflineminus">-      eStarting,</span>
<a href="#l12.3209"></a><span id="l12.3209" class="difflineminus">-      eCopyingNewMsg,</span>
<a href="#l12.3210"></a><span id="l12.3210" class="difflineminus">-      eUpdatingFolder, // for IMAP</span>
<a href="#l12.3211"></a><span id="l12.3211" class="difflineminus">-      eDeletingOldMessage,</span>
<a href="#l12.3212"></a><span id="l12.3212" class="difflineminus">-      eSelectingNewMessage</span>
<a href="#l12.3213"></a><span id="l12.3213" class="difflineminus">-    } m_state;</span>
<a href="#l12.3214"></a><span id="l12.3214" class="difflineminus">-   // temp</span>
<a href="#l12.3215"></a><span id="l12.3215" class="difflineplus">+  enum {</span>
<a href="#l12.3216"></a><span id="l12.3216" class="difflineplus">+    eStarting,</span>
<a href="#l12.3217"></a><span id="l12.3217" class="difflineplus">+    eCopyingNewMsg,</span>
<a href="#l12.3218"></a><span id="l12.3218" class="difflineplus">+    eUpdatingFolder,  // for IMAP</span>
<a href="#l12.3219"></a><span id="l12.3219" class="difflineplus">+    eDeletingOldMessage,</span>
<a href="#l12.3220"></a><span id="l12.3220" class="difflineplus">+    eSelectingNewMessage</span>
<a href="#l12.3221"></a><span id="l12.3221" class="difflineplus">+  } m_state;</span>
<a href="#l12.3222"></a><span id="l12.3222" class="difflineplus">+  // temp</span>
<a href="#l12.3223"></a><span id="l12.3223">   bool mWrittenExtra;</span>
<a href="#l12.3224"></a><span id="l12.3224">   bool mDetaching;</span>
<a href="#l12.3225"></a><span id="l12.3225">   nsTArray&lt;nsCString&gt; mDetachedFileUris;</span>
<a href="#l12.3226"></a><span id="l12.3226"> </span>
<a href="#l12.3227"></a><span id="l12.3227" class="difflineminus">-private:</span>
<a href="#l12.3228"></a><span id="l12.3228" class="difflineplus">+ private:</span>
<a href="#l12.3229"></a><span id="l12.3229">   virtual ~nsDelAttachListener();</span>
<a href="#l12.3230"></a><span id="l12.3230"> };</span>
<a href="#l12.3231"></a><span id="l12.3231"> </span>
<a href="#l12.3232"></a><span id="l12.3232"> //</span>
<a href="#l12.3233"></a><span id="l12.3233"> // nsISupports</span>
<a href="#l12.3234"></a><span id="l12.3234"> //</span>
<a href="#l12.3235"></a><span id="l12.3235" class="difflineminus">-NS_IMPL_ISUPPORTS(nsDelAttachListener,</span>
<a href="#l12.3236"></a><span id="l12.3236" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l12.3237"></a><span id="l12.3237" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l12.3238"></a><span id="l12.3238" class="difflineminus">-                   nsIUrlListener,</span>
<a href="#l12.3239"></a><span id="l12.3239" class="difflineminus">-                   nsIMsgCopyServiceListener)</span>
<a href="#l12.3240"></a><span id="l12.3240" class="difflineplus">+NS_IMPL_ISUPPORTS(nsDelAttachListener, nsIStreamListener, nsIRequestObserver,</span>
<a href="#l12.3241"></a><span id="l12.3241" class="difflineplus">+                  nsIUrlListener, nsIMsgCopyServiceListener)</span>
<a href="#l12.3242"></a><span id="l12.3242"> </span>
<a href="#l12.3243"></a><span id="l12.3243"> //</span>
<a href="#l12.3244"></a><span id="l12.3244"> // nsIRequestObserver</span>
<a href="#l12.3245"></a><span id="l12.3245"> //</span>
<a href="#l12.3246"></a><span id="l12.3246"> NS_IMETHODIMP</span>
<a href="#l12.3247"></a><span id="l12.3247" class="difflineminus">-nsDelAttachListener::OnStartRequest(nsIRequest * aRequest)</span>
<a href="#l12.3248"></a><span id="l12.3248" class="difflineminus">-{</span>
<a href="#l12.3249"></a><span id="l12.3249" class="difflineplus">+nsDelAttachListener::OnStartRequest(nsIRequest *aRequest) {</span>
<a href="#l12.3250"></a><span id="l12.3250">   // called when we start processing the StreamMessage request.</span>
<a href="#l12.3251"></a><span id="l12.3251">   // This is called after OnStartRunningUrl().</span>
<a href="#l12.3252"></a><span id="l12.3252">   return NS_OK;</span>
<a href="#l12.3253"></a><span id="l12.3253"> }</span>
<a href="#l12.3254"></a><span id="l12.3254"> </span>
<a href="#l12.3255"></a><span id="l12.3255"> NS_IMETHODIMP</span>
<a href="#l12.3256"></a><span id="l12.3256" class="difflineminus">-nsDelAttachListener::OnStopRequest(nsIRequest * aRequest, nsresult aStatusCode)</span>
<a href="#l12.3257"></a><span id="l12.3257" class="difflineminus">-{</span>
<a href="#l12.3258"></a><span id="l12.3258" class="difflineplus">+nsDelAttachListener::OnStopRequest(nsIRequest *aRequest, nsresult aStatusCode) {</span>
<a href="#l12.3259"></a><span id="l12.3259">   // called when we have completed processing the StreamMessage request.</span>
<a href="#l12.3260"></a><span id="l12.3260">   // This is called after OnStopRequest(). This means that we have now</span>
<a href="#l12.3261"></a><span id="l12.3261">   // received all data of the message and we have completed processing.</span>
<a href="#l12.3262"></a><span id="l12.3262">   // We now start to copy the processed message from the temporary file</span>
<a href="#l12.3263"></a><span id="l12.3263">   // back into the message store, replacing the original message.</span>
<a href="#l12.3264"></a><span id="l12.3264"> </span>
<a href="#l12.3265"></a><span id="l12.3265">   mMessageFolder-&gt;CopyDataDone();</span>
<a href="#l12.3266"></a><span id="l12.3266" class="difflineminus">-  if (NS_FAILED(aStatusCode))</span>
<a href="#l12.3267"></a><span id="l12.3267" class="difflineminus">-    return aStatusCode;</span>
<a href="#l12.3268"></a><span id="l12.3268" class="difflineplus">+  if (NS_FAILED(aStatusCode)) return aStatusCode;</span>
<a href="#l12.3269"></a><span id="l12.3269"> </span>
<a href="#l12.3270"></a><span id="l12.3270">   // called when we complete processing of the StreamMessage request.</span>
<a href="#l12.3271"></a><span id="l12.3271">   // This is called before OnStopRunningUrl().</span>
<a href="#l12.3272"></a><span id="l12.3272">   nsresult rv;</span>
<a href="#l12.3273"></a><span id="l12.3273"> </span>
<a href="#l12.3274"></a><span id="l12.3274">   // copy the file back into the folder. Note: setting msgToReplace only copies</span>
<a href="#l12.3275"></a><span id="l12.3275">   // metadata, so we do the delete ourselves</span>
<a href="#l12.3276"></a><span id="l12.3276">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; listenerCopyService;</span>
<a href="#l12.3277"></a><span id="l12.3277" class="difflineminus">-  rv = this-&gt;QueryInterface( NS_GET_IID(nsIMsgCopyServiceListener), getter_AddRefs(listenerCopyService) );</span>
<a href="#l12.3278"></a><span id="l12.3278" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3279"></a><span id="l12.3279" class="difflineplus">+  rv = this-&gt;QueryInterface(NS_GET_IID(nsIMsgCopyServiceListener),</span>
<a href="#l12.3280"></a><span id="l12.3280" class="difflineplus">+                            getter_AddRefs(listenerCopyService));</span>
<a href="#l12.3281"></a><span id="l12.3281" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3282"></a><span id="l12.3282"> </span>
<a href="#l12.3283"></a><span id="l12.3283">   mMsgFileStream-&gt;Close();</span>
<a href="#l12.3284"></a><span id="l12.3284">   mMsgFileStream = nullptr;</span>
<a href="#l12.3285"></a><span id="l12.3285">   mNewMessageKey = nsMsgKey_None;</span>
<a href="#l12.3286"></a><span id="l12.3286" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l12.3287"></a><span id="l12.3287" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l12.3288"></a><span id="l12.3288" class="difflineplus">+      do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l12.3289"></a><span id="l12.3289">   m_state = eCopyingNewMsg;</span>
<a href="#l12.3290"></a><span id="l12.3290">   // clone file because nsIFile on Windows caches the wrong file size.</span>
<a href="#l12.3291"></a><span id="l12.3291" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; clone;</span>
<a href="#l12.3292"></a><span id="l12.3292" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l12.3293"></a><span id="l12.3293">   mMsgFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l12.3294"></a><span id="l12.3294" class="difflineminus">-  if (copyService)</span>
<a href="#l12.3295"></a><span id="l12.3295" class="difflineminus">-  {</span>
<a href="#l12.3296"></a><span id="l12.3296" class="difflineplus">+  if (copyService) {</span>
<a href="#l12.3297"></a><span id="l12.3297">     nsCString originalKeys;</span>
<a href="#l12.3298"></a><span id="l12.3298" class="difflineminus">-    mOriginalMessage-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(originalKeys));</span>
<a href="#l12.3299"></a><span id="l12.3299" class="difflineminus">-    rv = copyService-&gt;CopyFileMessage(clone, mMessageFolder, mOriginalMessage, false,</span>
<a href="#l12.3300"></a><span id="l12.3300" class="difflineminus">-                                      mOrigMsgFlags, originalKeys, listenerCopyService, mMsgWindow);</span>
<a href="#l12.3301"></a><span id="l12.3301" class="difflineplus">+    mOriginalMessage-&gt;GetStringProperty(&quot;keywords&quot;,</span>
<a href="#l12.3302"></a><span id="l12.3302" class="difflineplus">+                                        getter_Copies(originalKeys));</span>
<a href="#l12.3303"></a><span id="l12.3303" class="difflineplus">+    rv = copyService-&gt;CopyFileMessage(clone, mMessageFolder, mOriginalMessage,</span>
<a href="#l12.3304"></a><span id="l12.3304" class="difflineplus">+                                      false, mOrigMsgFlags, originalKeys,</span>
<a href="#l12.3305"></a><span id="l12.3305" class="difflineplus">+                                      listenerCopyService, mMsgWindow);</span>
<a href="#l12.3306"></a><span id="l12.3306">   }</span>
<a href="#l12.3307"></a><span id="l12.3307">   return rv;</span>
<a href="#l12.3308"></a><span id="l12.3308"> }</span>
<a href="#l12.3309"></a><span id="l12.3309"> </span>
<a href="#l12.3310"></a><span id="l12.3310"> //</span>
<a href="#l12.3311"></a><span id="l12.3311"> // nsIStreamListener</span>
<a href="#l12.3312"></a><span id="l12.3312"> //</span>
<a href="#l12.3313"></a><span id="l12.3313"> </span>
<a href="#l12.3314"></a><span id="l12.3314"> NS_IMETHODIMP</span>
<a href="#l12.3315"></a><span id="l12.3315" class="difflineminus">-nsDelAttachListener::OnDataAvailable(nsIRequest * aRequest,</span>
<a href="#l12.3316"></a><span id="l12.3316" class="difflineminus">-                                     nsIInputStream * aInStream, uint64_t aSrcOffset,</span>
<a href="#l12.3317"></a><span id="l12.3317" class="difflineminus">-                                     uint32_t aCount)</span>
<a href="#l12.3318"></a><span id="l12.3318" class="difflineminus">-{</span>
<a href="#l12.3319"></a><span id="l12.3319" class="difflineminus">-  if (!mMsgFileStream)</span>
<a href="#l12.3320"></a><span id="l12.3320" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3321"></a><span id="l12.3321" class="difflineminus">-  return mMessageFolder-&gt;CopyDataToOutputStreamForAppend(aInStream, aCount, mMsgFileStream);</span>
<a href="#l12.3322"></a><span id="l12.3322" class="difflineplus">+nsDelAttachListener::OnDataAvailable(nsIRequest *aRequest,</span>
<a href="#l12.3323"></a><span id="l12.3323" class="difflineplus">+                                     nsIInputStream *aInStream,</span>
<a href="#l12.3324"></a><span id="l12.3324" class="difflineplus">+                                     uint64_t aSrcOffset, uint32_t aCount) {</span>
<a href="#l12.3325"></a><span id="l12.3325" class="difflineplus">+  if (!mMsgFileStream) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3326"></a><span id="l12.3326" class="difflineplus">+  return mMessageFolder-&gt;CopyDataToOutputStreamForAppend(aInStream, aCount,</span>
<a href="#l12.3327"></a><span id="l12.3327" class="difflineplus">+                                                         mMsgFileStream);</span>
<a href="#l12.3328"></a><span id="l12.3328"> }</span>
<a href="#l12.3329"></a><span id="l12.3329"> </span>
<a href="#l12.3330"></a><span id="l12.3330"> //</span>
<a href="#l12.3331"></a><span id="l12.3331"> // nsIUrlListener</span>
<a href="#l12.3332"></a><span id="l12.3332"> //</span>
<a href="#l12.3333"></a><span id="l12.3333"> </span>
<a href="#l12.3334"></a><span id="l12.3334"> NS_IMETHODIMP</span>
<a href="#l12.3335"></a><span id="l12.3335" class="difflineminus">-nsDelAttachListener::OnStartRunningUrl(nsIURI * aUrl)</span>
<a href="#l12.3336"></a><span id="l12.3336" class="difflineminus">-{</span>
<a href="#l12.3337"></a><span id="l12.3337" class="difflineplus">+nsDelAttachListener::OnStartRunningUrl(nsIURI *aUrl) {</span>
<a href="#l12.3338"></a><span id="l12.3338">   // called when we start processing the StreamMessage request. This is</span>
<a href="#l12.3339"></a><span id="l12.3339">   // called before OnStartRequest().</span>
<a href="#l12.3340"></a><span id="l12.3340">   return NS_OK;</span>
<a href="#l12.3341"></a><span id="l12.3341"> }</span>
<a href="#l12.3342"></a><span id="l12.3342"> </span>
<a href="#l12.3343"></a><span id="l12.3343" class="difflineminus">-nsresult nsDelAttachListener::DeleteOriginalMessage()</span>
<a href="#l12.3344"></a><span id="l12.3344" class="difflineminus">-{</span>
<a href="#l12.3345"></a><span id="l12.3345" class="difflineplus">+nsresult nsDelAttachListener::DeleteOriginalMessage() {</span>
<a href="#l12.3346"></a><span id="l12.3346">   nsresult rv;</span>
<a href="#l12.3347"></a><span id="l12.3347" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.3348"></a><span id="l12.3348" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l12.3349"></a><span id="l12.3349" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.3350"></a><span id="l12.3350">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3351"></a><span id="l12.3351"> </span>
<a href="#l12.3352"></a><span id="l12.3352">   rv = messageArray-&gt;AppendElement(mOriginalMessage);</span>
<a href="#l12.3353"></a><span id="l12.3353" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3354"></a><span id="l12.3354" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3355"></a><span id="l12.3355">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; listenerCopyService;</span>
<a href="#l12.3356"></a><span id="l12.3356"> </span>
<a href="#l12.3357"></a><span id="l12.3357" class="difflineminus">-  QueryInterface( NS_GET_IID(nsIMsgCopyServiceListener), getter_AddRefs(listenerCopyService) );</span>
<a href="#l12.3358"></a><span id="l12.3358" class="difflineplus">+  QueryInterface(NS_GET_IID(nsIMsgCopyServiceListener),</span>
<a href="#l12.3359"></a><span id="l12.3359" class="difflineplus">+                 getter_AddRefs(listenerCopyService));</span>
<a href="#l12.3360"></a><span id="l12.3360"> </span>
<a href="#l12.3361"></a><span id="l12.3361">   mOriginalMessage = nullptr;</span>
<a href="#l12.3362"></a><span id="l12.3362">   m_state = eDeletingOldMessage;</span>
<a href="#l12.3363"></a><span id="l12.3363" class="difflineminus">-  return mMessageFolder-&gt;DeleteMessages(</span>
<a href="#l12.3364"></a><span id="l12.3364" class="difflineminus">-    messageArray,         // messages</span>
<a href="#l12.3365"></a><span id="l12.3365" class="difflineminus">-    mMsgWindow,           // msgWindow</span>
<a href="#l12.3366"></a><span id="l12.3366" class="difflineminus">-    true,              // deleteStorage</span>
<a href="#l12.3367"></a><span id="l12.3367" class="difflineminus">-    false,              // isMove</span>
<a href="#l12.3368"></a><span id="l12.3368" class="difflineminus">-    listenerCopyService,  // listener</span>
<a href="#l12.3369"></a><span id="l12.3369" class="difflineminus">-    false);            // allowUndo</span>
<a href="#l12.3370"></a><span id="l12.3370" class="difflineplus">+  return mMessageFolder-&gt;DeleteMessages(messageArray,         // messages</span>
<a href="#l12.3371"></a><span id="l12.3371" class="difflineplus">+                                        mMsgWindow,           // msgWindow</span>
<a href="#l12.3372"></a><span id="l12.3372" class="difflineplus">+                                        true,                 // deleteStorage</span>
<a href="#l12.3373"></a><span id="l12.3373" class="difflineplus">+                                        false,                // isMove</span>
<a href="#l12.3374"></a><span id="l12.3374" class="difflineplus">+                                        listenerCopyService,  // listener</span>
<a href="#l12.3375"></a><span id="l12.3375" class="difflineplus">+                                        false);               // allowUndo</span>
<a href="#l12.3376"></a><span id="l12.3376"> }</span>
<a href="#l12.3377"></a><span id="l12.3377"> </span>
<a href="#l12.3378"></a><span id="l12.3378" class="difflineminus">-void nsDelAttachListener::SelectNewMessage()</span>
<a href="#l12.3379"></a><span id="l12.3379" class="difflineminus">-{</span>
<a href="#l12.3380"></a><span id="l12.3380" class="difflineplus">+void nsDelAttachListener::SelectNewMessage() {</span>
<a href="#l12.3381"></a><span id="l12.3381">   nsCString displayUri;</span>
<a href="#l12.3382"></a><span id="l12.3382">   // all attachments refer to the same message</span>
<a href="#l12.3383"></a><span id="l12.3383" class="difflineminus">-  const char * messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3384"></a><span id="l12.3384" class="difflineplus">+  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3385"></a><span id="l12.3385">   mMessenger-&gt;GetLastDisplayedMessageUri(displayUri);</span>
<a href="#l12.3386"></a><span id="l12.3386" class="difflineminus">-  if (displayUri.Equals(messageUri))</span>
<a href="#l12.3387"></a><span id="l12.3387" class="difflineminus">-  {</span>
<a href="#l12.3388"></a><span id="l12.3388" class="difflineplus">+  if (displayUri.Equals(messageUri)) {</span>
<a href="#l12.3389"></a><span id="l12.3389">     mMessageFolder-&gt;GenerateMessageURI(mNewMessageKey, displayUri);</span>
<a href="#l12.3390"></a><span id="l12.3390" class="difflineminus">-    if (!displayUri.IsEmpty() &amp;&amp; mMsgWindow)</span>
<a href="#l12.3391"></a><span id="l12.3391" class="difflineminus">-    {</span>
<a href="#l12.3392"></a><span id="l12.3392" class="difflineplus">+    if (!displayUri.IsEmpty() &amp;&amp; mMsgWindow) {</span>
<a href="#l12.3393"></a><span id="l12.3393">       nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l12.3394"></a><span id="l12.3394">       mMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l12.3395"></a><span id="l12.3395" class="difflineminus">-      if (windowCommands)</span>
<a href="#l12.3396"></a><span id="l12.3396" class="difflineminus">-        windowCommands-&gt;SelectMessage(displayUri);</span>
<a href="#l12.3397"></a><span id="l12.3397" class="difflineplus">+      if (windowCommands) windowCommands-&gt;SelectMessage(displayUri);</span>
<a href="#l12.3398"></a><span id="l12.3398">     }</span>
<a href="#l12.3399"></a><span id="l12.3399">   }</span>
<a href="#l12.3400"></a><span id="l12.3400">   mNewMessageKey = nsMsgKey_None;</span>
<a href="#l12.3401"></a><span id="l12.3401"> }</span>
<a href="#l12.3402"></a><span id="l12.3402"> </span>
<a href="#l12.3403"></a><span id="l12.3403"> NS_IMETHODIMP</span>
<a href="#l12.3404"></a><span id="l12.3404" class="difflineminus">-nsDelAttachListener::OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode)</span>
<a href="#l12.3405"></a><span id="l12.3405" class="difflineminus">-{</span>
<a href="#l12.3406"></a><span id="l12.3406" class="difflineplus">+nsDelAttachListener::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l12.3407"></a><span id="l12.3407">   nsresult rv = NS_OK;</span>
<a href="#l12.3408"></a><span id="l12.3408" class="difflineminus">-  const char * messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3409"></a><span id="l12.3409" class="difflineminus">-  if (mOriginalMessage &amp;&amp; !strncmp(messageUri, &quot;imap-message:&quot;, 13))</span>
<a href="#l12.3410"></a><span id="l12.3410" class="difflineminus">-  {</span>
<a href="#l12.3411"></a><span id="l12.3411" class="difflineminus">-    if (m_state == eUpdatingFolder)</span>
<a href="#l12.3412"></a><span id="l12.3412" class="difflineminus">-      rv = DeleteOriginalMessage();</span>
<a href="#l12.3413"></a><span id="l12.3413" class="difflineplus">+  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3414"></a><span id="l12.3414" class="difflineplus">+  if (mOriginalMessage &amp;&amp; !strncmp(messageUri, &quot;imap-message:&quot;, 13)) {</span>
<a href="#l12.3415"></a><span id="l12.3415" class="difflineplus">+    if (m_state == eUpdatingFolder) rv = DeleteOriginalMessage();</span>
<a href="#l12.3416"></a><span id="l12.3416">   }</span>
<a href="#l12.3417"></a><span id="l12.3417">   // check if we've deleted the original message, and we know the new msg id.</span>
<a href="#l12.3418"></a><span id="l12.3418">   else if (m_state == eDeletingOldMessage &amp;&amp; mMsgWindow)</span>
<a href="#l12.3419"></a><span id="l12.3419">     SelectNewMessage();</span>
<a href="#l12.3420"></a><span id="l12.3420"> </span>
<a href="#l12.3421"></a><span id="l12.3421">   return rv;</span>
<a href="#l12.3422"></a><span id="l12.3422"> }</span>
<a href="#l12.3423"></a><span id="l12.3423"> </span>
<a href="#l12.3424"></a><span id="l12.3424"> //</span>
<a href="#l12.3425"></a><span id="l12.3425"> // nsIMsgCopyServiceListener</span>
<a href="#l12.3426"></a><span id="l12.3426"> //</span>
<a href="#l12.3427"></a><span id="l12.3427"> </span>
<a href="#l12.3428"></a><span id="l12.3428"> NS_IMETHODIMP</span>
<a href="#l12.3429"></a><span id="l12.3429" class="difflineminus">-nsDelAttachListener::OnStartCopy(void)</span>
<a href="#l12.3430"></a><span id="l12.3430" class="difflineminus">-{</span>
<a href="#l12.3431"></a><span id="l12.3431" class="difflineplus">+nsDelAttachListener::OnStartCopy(void) {</span>
<a href="#l12.3432"></a><span id="l12.3432">   // never called?</span>
<a href="#l12.3433"></a><span id="l12.3433">   return NS_OK;</span>
<a href="#l12.3434"></a><span id="l12.3434"> }</span>
<a href="#l12.3435"></a><span id="l12.3435"> </span>
<a href="#l12.3436"></a><span id="l12.3436"> NS_IMETHODIMP</span>
<a href="#l12.3437"></a><span id="l12.3437" class="difflineminus">-nsDelAttachListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l12.3438"></a><span id="l12.3438" class="difflineminus">-{</span>
<a href="#l12.3439"></a><span id="l12.3439" class="difflineplus">+nsDelAttachListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax) {</span>
<a href="#l12.3440"></a><span id="l12.3440">   // never called?</span>
<a href="#l12.3441"></a><span id="l12.3441">   return NS_OK;</span>
<a href="#l12.3442"></a><span id="l12.3442"> }</span>
<a href="#l12.3443"></a><span id="l12.3443"> </span>
<a href="#l12.3444"></a><span id="l12.3444"> NS_IMETHODIMP</span>
<a href="#l12.3445"></a><span id="l12.3445" class="difflineminus">-nsDelAttachListener::SetMessageKey(nsMsgKey aKey)</span>
<a href="#l12.3446"></a><span id="l12.3446" class="difflineminus">-{</span>
<a href="#l12.3447"></a><span id="l12.3447" class="difflineplus">+nsDelAttachListener::SetMessageKey(nsMsgKey aKey) {</span>
<a href="#l12.3448"></a><span id="l12.3448">   // called during the copy of the modified message back into the message</span>
<a href="#l12.3449"></a><span id="l12.3449">   // store to notify us of the message key of the newly created message.</span>
<a href="#l12.3450"></a><span id="l12.3450">   mNewMessageKey = aKey;</span>
<a href="#l12.3451"></a><span id="l12.3451">   return NS_OK;</span>
<a href="#l12.3452"></a><span id="l12.3452"> }</span>
<a href="#l12.3453"></a><span id="l12.3453"> </span>
<a href="#l12.3454"></a><span id="l12.3454"> NS_IMETHODIMP</span>
<a href="#l12.3455"></a><span id="l12.3455" class="difflineminus">-nsDelAttachListener::GetMessageId(nsACString&amp; aMessageId)</span>
<a href="#l12.3456"></a><span id="l12.3456" class="difflineminus">-{</span>
<a href="#l12.3457"></a><span id="l12.3457" class="difflineplus">+nsDelAttachListener::GetMessageId(nsACString &amp;aMessageId) {</span>
<a href="#l12.3458"></a><span id="l12.3458">   // never called?</span>
<a href="#l12.3459"></a><span id="l12.3459">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.3460"></a><span id="l12.3460"> }</span>
<a href="#l12.3461"></a><span id="l12.3461"> </span>
<a href="#l12.3462"></a><span id="l12.3462"> NS_IMETHODIMP</span>
<a href="#l12.3463"></a><span id="l12.3463" class="difflineminus">-nsDelAttachListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l12.3464"></a><span id="l12.3464" class="difflineminus">-{</span>
<a href="#l12.3465"></a><span id="l12.3465" class="difflineminus">-  // only if the currently selected message is the one that we are about to delete then we</span>
<a href="#l12.3466"></a><span id="l12.3466" class="difflineminus">-  // change the selection to the new message that we just added. Failures in this code are not fatal.</span>
<a href="#l12.3467"></a><span id="l12.3467" class="difflineminus">-  // Note that can only do this if we have the new message key, which we don't always get from IMAP.</span>
<a href="#l12.3468"></a><span id="l12.3468" class="difflineminus">-  // delete the original message</span>
<a href="#l12.3469"></a><span id="l12.3469" class="difflineminus">-  if (NS_FAILED(aStatus))</span>
<a href="#l12.3470"></a><span id="l12.3470" class="difflineminus">-    return aStatus;</span>
<a href="#l12.3471"></a><span id="l12.3471" class="difflineplus">+nsDelAttachListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l12.3472"></a><span id="l12.3472" class="difflineplus">+  // only if the currently selected message is the one that we are about to</span>
<a href="#l12.3473"></a><span id="l12.3473" class="difflineplus">+  // delete then we change the selection to the new message that we just added.</span>
<a href="#l12.3474"></a><span id="l12.3474" class="difflineplus">+  // Failures in this code are not fatal. Note that can only do this if we have</span>
<a href="#l12.3475"></a><span id="l12.3475" class="difflineplus">+  // the new message key, which we don't always get from IMAP. delete the</span>
<a href="#l12.3476"></a><span id="l12.3476" class="difflineplus">+  // original message</span>
<a href="#l12.3477"></a><span id="l12.3477" class="difflineplus">+  if (NS_FAILED(aStatus)) return aStatus;</span>
<a href="#l12.3478"></a><span id="l12.3478"> </span>
<a href="#l12.3479"></a><span id="l12.3479">   // check if we've deleted the original message, and we know the new msg id.</span>
<a href="#l12.3480"></a><span id="l12.3480" class="difflineminus">-  if (m_state == eDeletingOldMessage &amp;&amp; mMsgWindow)</span>
<a href="#l12.3481"></a><span id="l12.3481" class="difflineminus">-    SelectNewMessage();</span>
<a href="#l12.3482"></a><span id="l12.3482" class="difflineplus">+  if (m_state == eDeletingOldMessage &amp;&amp; mMsgWindow) SelectNewMessage();</span>
<a href="#l12.3483"></a><span id="l12.3483">   // do this for non-imap messages - for imap, we'll do the delete in</span>
<a href="#l12.3484"></a><span id="l12.3484">   // OnStopRunningUrl. For local messages, we won't get an OnStopRunningUrl</span>
<a href="#l12.3485"></a><span id="l12.3485">   // notification. And for imap, it's too late to delete the message here,</span>
<a href="#l12.3486"></a><span id="l12.3486">   // because we'll be updating the folder naturally as a result of</span>
<a href="#l12.3487"></a><span id="l12.3487">   // running an append url. If we delete the header here, that folder</span>
<a href="#l12.3488"></a><span id="l12.3488">   // update will think we need to download the header...If we do it</span>
<a href="#l12.3489"></a><span id="l12.3489">   // in OnStopRunningUrl, we'll issue the delete before we do the</span>
<a href="#l12.3490"></a><span id="l12.3490">   // update....all nasty stuff.</span>
<a href="#l12.3491"></a><span id="l12.3491" class="difflineminus">-  const char * messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3492"></a><span id="l12.3492" class="difflineplus">+  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3493"></a><span id="l12.3493">   if (mOriginalMessage &amp;&amp; strncmp(messageUri, &quot;imap-message:&quot;, 13))</span>
<a href="#l12.3494"></a><span id="l12.3494">     return DeleteOriginalMessage();</span>
<a href="#l12.3495"></a><span id="l12.3495">   else</span>
<a href="#l12.3496"></a><span id="l12.3496">     m_state = eUpdatingFolder;</span>
<a href="#l12.3497"></a><span id="l12.3497">   return NS_OK;</span>
<a href="#l12.3498"></a><span id="l12.3498"> }</span>
<a href="#l12.3499"></a><span id="l12.3499"> </span>
<a href="#l12.3500"></a><span id="l12.3500"> //</span>
<a href="#l12.3501"></a><span id="l12.3501"> // local methods</span>
<a href="#l12.3502"></a><span id="l12.3502"> //</span>
<a href="#l12.3503"></a><span id="l12.3503"> </span>
<a href="#l12.3504"></a><span id="l12.3504" class="difflineminus">-nsDelAttachListener::nsDelAttachListener()</span>
<a href="#l12.3505"></a><span id="l12.3505" class="difflineminus">-{</span>
<a href="#l12.3506"></a><span id="l12.3506" class="difflineplus">+nsDelAttachListener::nsDelAttachListener() {</span>
<a href="#l12.3507"></a><span id="l12.3507">   mAttach = nullptr;</span>
<a href="#l12.3508"></a><span id="l12.3508">   mSaveFirst = false;</span>
<a href="#l12.3509"></a><span id="l12.3509">   mWrittenExtra = false;</span>
<a href="#l12.3510"></a><span id="l12.3510">   mNewMessageKey = nsMsgKey_None;</span>
<a href="#l12.3511"></a><span id="l12.3511">   m_state = eStarting;</span>
<a href="#l12.3512"></a><span id="l12.3512"> }</span>
<a href="#l12.3513"></a><span id="l12.3513"> </span>
<a href="#l12.3514"></a><span id="l12.3514" class="difflineminus">-nsDelAttachListener::~nsDelAttachListener()</span>
<a href="#l12.3515"></a><span id="l12.3515" class="difflineminus">-{</span>
<a href="#l12.3516"></a><span id="l12.3516" class="difflineminus">-  if (mAttach)</span>
<a href="#l12.3517"></a><span id="l12.3517" class="difflineminus">-  {</span>
<a href="#l12.3518"></a><span id="l12.3518" class="difflineplus">+nsDelAttachListener::~nsDelAttachListener() {</span>
<a href="#l12.3519"></a><span id="l12.3519" class="difflineplus">+  if (mAttach) {</span>
<a href="#l12.3520"></a><span id="l12.3520">     delete mAttach;</span>
<a href="#l12.3521"></a><span id="l12.3521">   }</span>
<a href="#l12.3522"></a><span id="l12.3522" class="difflineminus">-  if (mMsgFileStream)</span>
<a href="#l12.3523"></a><span id="l12.3523" class="difflineminus">-  {</span>
<a href="#l12.3524"></a><span id="l12.3524" class="difflineplus">+  if (mMsgFileStream) {</span>
<a href="#l12.3525"></a><span id="l12.3525">     mMsgFileStream-&gt;Close();</span>
<a href="#l12.3526"></a><span id="l12.3526">     mMsgFileStream = nullptr;</span>
<a href="#l12.3527"></a><span id="l12.3527">   }</span>
<a href="#l12.3528"></a><span id="l12.3528" class="difflineminus">-  if (mMsgFile)</span>
<a href="#l12.3529"></a><span id="l12.3529" class="difflineminus">-  {</span>
<a href="#l12.3530"></a><span id="l12.3530" class="difflineplus">+  if (mMsgFile) {</span>
<a href="#l12.3531"></a><span id="l12.3531">     mMsgFile-&gt;Remove(false);</span>
<a href="#l12.3532"></a><span id="l12.3532">   }</span>
<a href="#l12.3533"></a><span id="l12.3533"> }</span>
<a href="#l12.3534"></a><span id="l12.3534"> </span>
<a href="#l12.3535"></a><span id="l12.3535" class="difflineminus">-nsresult</span>
<a href="#l12.3536"></a><span id="l12.3536" class="difflineminus">-nsDelAttachListener::StartProcessing(nsMessenger * aMessenger, nsIMsgWindow * aMsgWindow,</span>
<a href="#l12.3537"></a><span id="l12.3537" class="difflineminus">-                                     nsAttachmentState * aAttach, bool detaching)</span>
<a href="#l12.3538"></a><span id="l12.3538" class="difflineminus">-{</span>
<a href="#l12.3539"></a><span id="l12.3539" class="difflineminus">-  aMessenger-&gt;QueryInterface(NS_GET_IID(nsIMessenger), getter_AddRefs(mMessenger));</span>
<a href="#l12.3540"></a><span id="l12.3540" class="difflineplus">+nsresult nsDelAttachListener::StartProcessing(nsMessenger *aMessenger,</span>
<a href="#l12.3541"></a><span id="l12.3541" class="difflineplus">+                                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.3542"></a><span id="l12.3542" class="difflineplus">+                                              nsAttachmentState *aAttach,</span>
<a href="#l12.3543"></a><span id="l12.3543" class="difflineplus">+                                              bool detaching) {</span>
<a href="#l12.3544"></a><span id="l12.3544" class="difflineplus">+  aMessenger-&gt;QueryInterface(NS_GET_IID(nsIMessenger),</span>
<a href="#l12.3545"></a><span id="l12.3545" class="difflineplus">+                             getter_AddRefs(mMessenger));</span>
<a href="#l12.3546"></a><span id="l12.3546">   mMsgWindow = aMsgWindow;</span>
<a href="#l12.3547"></a><span id="l12.3547" class="difflineminus">-  mAttach    = aAttach;</span>
<a href="#l12.3548"></a><span id="l12.3548" class="difflineplus">+  mAttach = aAttach;</span>
<a href="#l12.3549"></a><span id="l12.3549">   mDetaching = detaching;</span>
<a href="#l12.3550"></a><span id="l12.3550"> </span>
<a href="#l12.3551"></a><span id="l12.3551">   nsresult rv;</span>
<a href="#l12.3552"></a><span id="l12.3552"> </span>
<a href="#l12.3553"></a><span id="l12.3553">   // all attachments refer to the same message</span>
<a href="#l12.3554"></a><span id="l12.3554" class="difflineminus">-  const char * messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3555"></a><span id="l12.3555" class="difflineplus">+  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l12.3556"></a><span id="l12.3556"> </span>
<a href="#l12.3557"></a><span id="l12.3557">   // get the message service, original message and folder for this message</span>
<a href="#l12.3558"></a><span id="l12.3558" class="difflineminus">-  rv = GetMessageServiceFromURI(nsDependentCString(messageUri), getter_AddRefs(mMessageService));</span>
<a href="#l12.3559"></a><span id="l12.3559" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3560"></a><span id="l12.3560" class="difflineminus">-  rv = mMessageService-&gt;MessageURIToMsgHdr(messageUri, getter_AddRefs(mOriginalMessage));</span>
<a href="#l12.3561"></a><span id="l12.3561" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3562"></a><span id="l12.3562" class="difflineplus">+  rv = GetMessageServiceFromURI(nsDependentCString(messageUri),</span>
<a href="#l12.3563"></a><span id="l12.3563" class="difflineplus">+                                getter_AddRefs(mMessageService));</span>
<a href="#l12.3564"></a><span id="l12.3564" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3565"></a><span id="l12.3565" class="difflineplus">+  rv = mMessageService-&gt;MessageURIToMsgHdr(messageUri,</span>
<a href="#l12.3566"></a><span id="l12.3566" class="difflineplus">+                                           getter_AddRefs(mOriginalMessage));</span>
<a href="#l12.3567"></a><span id="l12.3567" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3568"></a><span id="l12.3568">   rv = mOriginalMessage-&gt;GetFolder(getter_AddRefs(mMessageFolder));</span>
<a href="#l12.3569"></a><span id="l12.3569" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3570"></a><span id="l12.3570" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3571"></a><span id="l12.3571">   mOriginalMessage-&gt;GetFlags(&amp;mOrigMsgFlags);</span>
<a href="#l12.3572"></a><span id="l12.3572"> </span>
<a href="#l12.3573"></a><span id="l12.3573">   // ensure that we can store and delete messages in this folder, if we</span>
<a href="#l12.3574"></a><span id="l12.3574">   // can't then we can't do attachment deleting</span>
<a href="#l12.3575"></a><span id="l12.3575">   bool canDelete = false;</span>
<a href="#l12.3576"></a><span id="l12.3576">   mMessageFolder-&gt;GetCanDeleteMessages(&amp;canDelete);</span>
<a href="#l12.3577"></a><span id="l12.3577">   bool canFile = false;</span>
<a href="#l12.3578"></a><span id="l12.3578">   mMessageFolder-&gt;GetCanFileMessages(&amp;canFile);</span>
<a href="#l12.3579"></a><span id="l12.3579" class="difflineminus">-  if (!canDelete || !canFile)</span>
<a href="#l12.3580"></a><span id="l12.3580" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l12.3581"></a><span id="l12.3581" class="difflineminus">-</span>
<a href="#l12.3582"></a><span id="l12.3582" class="difflineminus">-  // create an output stream on a temporary file. This stream will save the modified</span>
<a href="#l12.3583"></a><span id="l12.3583" class="difflineminus">-  // message data to a file which we will later use to replace the existing message.</span>
<a href="#l12.3584"></a><span id="l12.3584" class="difflineminus">-  // The file is removed in the destructor.</span>
<a href="#l12.3585"></a><span id="l12.3585" class="difflineplus">+  if (!canDelete || !canFile) return NS_ERROR_FAILURE;</span>
<a href="#l12.3586"></a><span id="l12.3586" class="difflineplus">+</span>
<a href="#l12.3587"></a><span id="l12.3587" class="difflineplus">+  // create an output stream on a temporary file. This stream will save the</span>
<a href="#l12.3588"></a><span id="l12.3588" class="difflineplus">+  // modified message data to a file which we will later use to replace the</span>
<a href="#l12.3589"></a><span id="l12.3589" class="difflineplus">+  // existing message. The file is removed in the destructor.</span>
<a href="#l12.3590"></a><span id="l12.3590">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;nsmail.tmp&quot;,</span>
<a href="#l12.3591"></a><span id="l12.3591">                                        getter_AddRefs(mMsgFile));</span>
<a href="#l12.3592"></a><span id="l12.3592" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3593"></a><span id="l12.3593" class="difflineminus">-</span>
<a href="#l12.3594"></a><span id="l12.3594" class="difflineminus">-  // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION</span>
<a href="#l12.3595"></a><span id="l12.3595" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3596"></a><span id="l12.3596" class="difflineplus">+</span>
<a href="#l12.3597"></a><span id="l12.3597" class="difflineplus">+  // For temp file, we should use restrictive 00600 instead of</span>
<a href="#l12.3598"></a><span id="l12.3598" class="difflineplus">+  // ATTACHMENT_PERMISSION</span>
<a href="#l12.3599"></a><span id="l12.3599">   rv = mMsgFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l12.3600"></a><span id="l12.3600" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3601"></a><span id="l12.3601" class="difflineminus">-</span>
<a href="#l12.3602"></a><span id="l12.3602" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mMsgFileStream), mMsgFile, -1, ATTACHMENT_PERMISSION);</span>
<a href="#l12.3603"></a><span id="l12.3603" class="difflineminus">-</span>
<a href="#l12.3604"></a><span id="l12.3604" class="difflineminus">-  // create the additional header for data conversion. This will tell the stream converter</span>
<a href="#l12.3605"></a><span id="l12.3605" class="difflineminus">-  // which MIME emitter we want to use, and it will tell the MIME emitter which attachments</span>
<a href="#l12.3606"></a><span id="l12.3606" class="difflineminus">-  // should be deleted.</span>
<a href="#l12.3607"></a><span id="l12.3607" class="difflineminus">-  const char * partId;</span>
<a href="#l12.3608"></a><span id="l12.3608" class="difflineminus">-  const char * nextField;</span>
<a href="#l12.3609"></a><span id="l12.3609" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3610"></a><span id="l12.3610" class="difflineplus">+</span>
<a href="#l12.3611"></a><span id="l12.3611" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mMsgFileStream), mMsgFile,</span>
<a href="#l12.3612"></a><span id="l12.3612" class="difflineplus">+                                      -1, ATTACHMENT_PERMISSION);</span>
<a href="#l12.3613"></a><span id="l12.3613" class="difflineplus">+</span>
<a href="#l12.3614"></a><span id="l12.3614" class="difflineplus">+  // create the additional header for data conversion. This will tell the stream</span>
<a href="#l12.3615"></a><span id="l12.3615" class="difflineplus">+  // converter which MIME emitter we want to use, and it will tell the MIME</span>
<a href="#l12.3616"></a><span id="l12.3616" class="difflineplus">+  // emitter which attachments should be deleted.</span>
<a href="#l12.3617"></a><span id="l12.3617" class="difflineplus">+  const char *partId;</span>
<a href="#l12.3618"></a><span id="l12.3618" class="difflineplus">+  const char *nextField;</span>
<a href="#l12.3619"></a><span id="l12.3619">   nsAutoCString sHeader(&quot;attach&amp;del=&quot;);</span>
<a href="#l12.3620"></a><span id="l12.3620">   nsAutoCString detachToHeader(&quot;&amp;detachTo=&quot;);</span>
<a href="#l12.3621"></a><span id="l12.3621" class="difflineminus">-  for (uint32_t u = 0; u &lt; mAttach-&gt;mCount; ++u)</span>
<a href="#l12.3622"></a><span id="l12.3622" class="difflineminus">-  {</span>
<a href="#l12.3623"></a><span id="l12.3623" class="difflineminus">-    if (u &gt; 0)</span>
<a href="#l12.3624"></a><span id="l12.3624" class="difflineminus">-    {</span>
<a href="#l12.3625"></a><span id="l12.3625" class="difflineplus">+  for (uint32_t u = 0; u &lt; mAttach-&gt;mCount; ++u) {</span>
<a href="#l12.3626"></a><span id="l12.3626" class="difflineplus">+    if (u &gt; 0) {</span>
<a href="#l12.3627"></a><span id="l12.3627">       sHeader.Append(',');</span>
<a href="#l12.3628"></a><span id="l12.3628" class="difflineminus">-      if (detaching)</span>
<a href="#l12.3629"></a><span id="l12.3629" class="difflineminus">-        detachToHeader.Append(',');</span>
<a href="#l12.3630"></a><span id="l12.3630" class="difflineplus">+      if (detaching) detachToHeader.Append(',');</span>
<a href="#l12.3631"></a><span id="l12.3631">     }</span>
<a href="#l12.3632"></a><span id="l12.3632">     partId = GetAttachmentPartId(mAttach-&gt;mAttachmentArray[u].mUrl);</span>
<a href="#l12.3633"></a><span id="l12.3633">     nextField = PL_strchr(partId, '&amp;');</span>
<a href="#l12.3634"></a><span id="l12.3634">     sHeader.Append(partId, nextField ? nextField - partId : -1);</span>
<a href="#l12.3635"></a><span id="l12.3635" class="difflineminus">-    if (detaching)</span>
<a href="#l12.3636"></a><span id="l12.3636" class="difflineminus">-      detachToHeader.Append(mDetachedFileUris[u]);</span>
<a href="#l12.3637"></a><span id="l12.3637" class="difflineplus">+    if (detaching) detachToHeader.Append(mDetachedFileUris[u]);</span>
<a href="#l12.3638"></a><span id="l12.3638">   }</span>
<a href="#l12.3639"></a><span id="l12.3639"> </span>
<a href="#l12.3640"></a><span id="l12.3640" class="difflineminus">-  if (detaching)</span>
<a href="#l12.3641"></a><span id="l12.3641" class="difflineminus">-    sHeader.Append(detachToHeader);</span>
<a href="#l12.3642"></a><span id="l12.3642" class="difflineplus">+  if (detaching) sHeader.Append(detachToHeader);</span>
<a href="#l12.3643"></a><span id="l12.3643">   // stream this message to our listener converting it via the attachment mime</span>
<a href="#l12.3644"></a><span id="l12.3644" class="difflineminus">-  // converter. The listener will just write the converted message straight to disk.</span>
<a href="#l12.3645"></a><span id="l12.3645" class="difflineplus">+  // converter. The listener will just write the converted message straight to</span>
<a href="#l12.3646"></a><span id="l12.3646" class="difflineplus">+  // disk.</span>
<a href="#l12.3647"></a><span id="l12.3647">   nsCOMPtr&lt;nsISupports&gt; listenerSupports;</span>
<a href="#l12.3648"></a><span id="l12.3648" class="difflineminus">-  rv = this-&gt;QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(listenerSupports));</span>
<a href="#l12.3649"></a><span id="l12.3649" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3650"></a><span id="l12.3650" class="difflineminus">-  nsCOMPtr&lt;nsIUrlListener&gt; listenerUrlListener = do_QueryInterface(listenerSupports, &amp;rv);</span>
<a href="#l12.3651"></a><span id="l12.3651" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3652"></a><span id="l12.3652" class="difflineplus">+  rv = this-&gt;QueryInterface(NS_GET_IID(nsISupports),</span>
<a href="#l12.3653"></a><span id="l12.3653" class="difflineplus">+                            getter_AddRefs(listenerSupports));</span>
<a href="#l12.3654"></a><span id="l12.3654" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3655"></a><span id="l12.3655" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; listenerUrlListener =</span>
<a href="#l12.3656"></a><span id="l12.3656" class="difflineplus">+      do_QueryInterface(listenerSupports, &amp;rv);</span>
<a href="#l12.3657"></a><span id="l12.3657" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3658"></a><span id="l12.3658"> </span>
<a href="#l12.3659"></a><span id="l12.3659">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l12.3660"></a><span id="l12.3660">   rv = mMessageService-&gt;StreamMessage(messageUri, listenerSupports, mMsgWindow,</span>
<a href="#l12.3661"></a><span id="l12.3661" class="difflineminus">-                                      listenerUrlListener, true, sHeader,</span>
<a href="#l12.3662"></a><span id="l12.3662" class="difflineminus">-                                      false, getter_AddRefs(dummyNull));</span>
<a href="#l12.3663"></a><span id="l12.3663" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3664"></a><span id="l12.3664" class="difflineplus">+                                      listenerUrlListener, true, sHeader, false,</span>
<a href="#l12.3665"></a><span id="l12.3665" class="difflineplus">+                                      getter_AddRefs(dummyNull));</span>
<a href="#l12.3666"></a><span id="l12.3666" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3667"></a><span id="l12.3667"> </span>
<a href="#l12.3668"></a><span id="l12.3668">   return NS_OK;</span>
<a href="#l12.3669"></a><span id="l12.3669"> }</span>
<a href="#l12.3670"></a><span id="l12.3670"> </span>
<a href="#l12.3671"></a><span id="l12.3671"> // ------------------------------------</span>
<a href="#l12.3672"></a><span id="l12.3672"> </span>
<a href="#l12.3673"></a><span id="l12.3673"> NS_IMETHODIMP</span>
<a href="#l12.3674"></a><span id="l12.3674" class="difflineminus">-nsMessenger::DetachAttachment(const char * aContentType, const char * aUrl,</span>
<a href="#l12.3675"></a><span id="l12.3675" class="difflineminus">-                              const char * aDisplayName, const char * aMessageUri,</span>
<a href="#l12.3676"></a><span id="l12.3676" class="difflineminus">-                              bool aSaveFirst, bool withoutWarning = false)</span>
<a href="#l12.3677"></a><span id="l12.3677" class="difflineminus">-{</span>
<a href="#l12.3678"></a><span id="l12.3678" class="difflineplus">+nsMessenger::DetachAttachment(const char *aContentType, const char *aUrl,</span>
<a href="#l12.3679"></a><span id="l12.3679" class="difflineplus">+                              const char *aDisplayName, const char *aMessageUri,</span>
<a href="#l12.3680"></a><span id="l12.3680" class="difflineplus">+                              bool aSaveFirst, bool withoutWarning = false) {</span>
<a href="#l12.3681"></a><span id="l12.3681">   NS_ENSURE_ARG_POINTER(aContentType);</span>
<a href="#l12.3682"></a><span id="l12.3682">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l12.3683"></a><span id="l12.3683">   NS_ENSURE_ARG_POINTER(aDisplayName);</span>
<a href="#l12.3684"></a><span id="l12.3684">   NS_ENSURE_ARG_POINTER(aMessageUri);</span>
<a href="#l12.3685"></a><span id="l12.3685"> </span>
<a href="#l12.3686"></a><span id="l12.3686">   if (aSaveFirst)</span>
<a href="#l12.3687"></a><span id="l12.3687" class="difflineminus">-    return SaveOneAttachment(aContentType, aUrl, aDisplayName, aMessageUri, true);</span>
<a href="#l12.3688"></a><span id="l12.3688" class="difflineminus">-  return DetachAttachments(1, &amp;aContentType, &amp;aUrl, &amp;aDisplayName, &amp;aMessageUri, nullptr, withoutWarning);</span>
<a href="#l12.3689"></a><span id="l12.3689" class="difflineplus">+    return SaveOneAttachment(aContentType, aUrl, aDisplayName, aMessageUri,</span>
<a href="#l12.3690"></a><span id="l12.3690" class="difflineplus">+                             true);</span>
<a href="#l12.3691"></a><span id="l12.3691" class="difflineplus">+  return DetachAttachments(1, &amp;aContentType, &amp;aUrl, &amp;aDisplayName, &amp;aMessageUri,</span>
<a href="#l12.3692"></a><span id="l12.3692" class="difflineplus">+                           nullptr, withoutWarning);</span>
<a href="#l12.3693"></a><span id="l12.3693"> }</span>
<a href="#l12.3694"></a><span id="l12.3694"> </span>
<a href="#l12.3695"></a><span id="l12.3695"> NS_IMETHODIMP</span>
<a href="#l12.3696"></a><span id="l12.3696" class="difflineminus">-nsMessenger::DetachAllAttachments(uint32_t aCount,</span>
<a href="#l12.3697"></a><span id="l12.3697" class="difflineminus">-                                  const char ** aContentTypeArray,</span>
<a href="#l12.3698"></a><span id="l12.3698" class="difflineminus">-                                  const char ** aUrlArray,</span>
<a href="#l12.3699"></a><span id="l12.3699" class="difflineminus">-                                  const char ** aDisplayNameArray,</span>
<a href="#l12.3700"></a><span id="l12.3700" class="difflineminus">-                                  const char ** aMessageUriArray,</span>
<a href="#l12.3701"></a><span id="l12.3701" class="difflineminus">-                                  bool aSaveFirst,</span>
<a href="#l12.3702"></a><span id="l12.3702" class="difflineminus">-                                  bool withoutWarning = false)</span>
<a href="#l12.3703"></a><span id="l12.3703" class="difflineminus">-{</span>
<a href="#l12.3704"></a><span id="l12.3704" class="difflineplus">+nsMessenger::DetachAllAttachments(</span>
<a href="#l12.3705"></a><span id="l12.3705" class="difflineplus">+    uint32_t aCount, const char **aContentTypeArray, const char **aUrlArray,</span>
<a href="#l12.3706"></a><span id="l12.3706" class="difflineplus">+    const char **aDisplayNameArray, const char **aMessageUriArray,</span>
<a href="#l12.3707"></a><span id="l12.3707" class="difflineplus">+    bool aSaveFirst, bool withoutWarning = false) {</span>
<a href="#l12.3708"></a><span id="l12.3708">   NS_ENSURE_ARG_MIN(aCount, 1);</span>
<a href="#l12.3709"></a><span id="l12.3709">   NS_ENSURE_ARG_POINTER(aContentTypeArray);</span>
<a href="#l12.3710"></a><span id="l12.3710">   NS_ENSURE_ARG_POINTER(aUrlArray);</span>
<a href="#l12.3711"></a><span id="l12.3711">   NS_ENSURE_ARG_POINTER(aDisplayNameArray);</span>
<a href="#l12.3712"></a><span id="l12.3712">   NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l12.3713"></a><span id="l12.3713"> </span>
<a href="#l12.3714"></a><span id="l12.3714">   if (aSaveFirst)</span>
<a href="#l12.3715"></a><span id="l12.3715" class="difflineminus">-    return SaveAllAttachments(aCount, aContentTypeArray, aUrlArray, aDisplayNameArray, aMessageUriArray, true);</span>
<a href="#l12.3716"></a><span id="l12.3716" class="difflineplus">+    return SaveAllAttachments(aCount, aContentTypeArray, aUrlArray,</span>
<a href="#l12.3717"></a><span id="l12.3717" class="difflineplus">+                              aDisplayNameArray, aMessageUriArray, true);</span>
<a href="#l12.3718"></a><span id="l12.3718">   else</span>
<a href="#l12.3719"></a><span id="l12.3719" class="difflineminus">-    return DetachAttachments(aCount, aContentTypeArray, aUrlArray, aDisplayNameArray, aMessageUriArray, nullptr, withoutWarning);</span>
<a href="#l12.3720"></a><span id="l12.3720" class="difflineplus">+    return DetachAttachments(aCount, aContentTypeArray, aUrlArray,</span>
<a href="#l12.3721"></a><span id="l12.3721" class="difflineplus">+                             aDisplayNameArray, aMessageUriArray, nullptr,</span>
<a href="#l12.3722"></a><span id="l12.3722" class="difflineplus">+                             withoutWarning);</span>
<a href="#l12.3723"></a><span id="l12.3723"> }</span>
<a href="#l12.3724"></a><span id="l12.3724"> </span>
<a href="#l12.3725"></a><span id="l12.3725" class="difflineminus">-nsresult</span>
<a href="#l12.3726"></a><span id="l12.3726" class="difflineminus">-nsMessenger::DetachAttachments(uint32_t aCount,</span>
<a href="#l12.3727"></a><span id="l12.3727" class="difflineminus">-                               const char ** aContentTypeArray,</span>
<a href="#l12.3728"></a><span id="l12.3728" class="difflineminus">-                               const char ** aUrlArray,</span>
<a href="#l12.3729"></a><span id="l12.3729" class="difflineminus">-                               const char ** aDisplayNameArray,</span>
<a href="#l12.3730"></a><span id="l12.3730" class="difflineminus">-                               const char ** aMessageUriArray,</span>
<a href="#l12.3731"></a><span id="l12.3731" class="difflineminus">-                               nsTArray&lt;nsCString&gt; *saveFileUris,</span>
<a href="#l12.3732"></a><span id="l12.3732" class="difflineminus">-                               bool withoutWarning)</span>
<a href="#l12.3733"></a><span id="l12.3733" class="difflineminus">-{</span>
<a href="#l12.3734"></a><span id="l12.3734" class="difflineplus">+nsresult nsMessenger::DetachAttachments(</span>
<a href="#l12.3735"></a><span id="l12.3735" class="difflineplus">+    uint32_t aCount, const char **aContentTypeArray, const char **aUrlArray,</span>
<a href="#l12.3736"></a><span id="l12.3736" class="difflineplus">+    const char **aDisplayNameArray, const char **aMessageUriArray,</span>
<a href="#l12.3737"></a><span id="l12.3737" class="difflineplus">+    nsTArray&lt;nsCString&gt; *saveFileUris, bool withoutWarning) {</span>
<a href="#l12.3738"></a><span id="l12.3738">   // if withoutWarning no dialog for user</span>
<a href="#l12.3739"></a><span id="l12.3739" class="difflineminus">-  if (!withoutWarning &amp;&amp; NS_FAILED(PromptIfDeleteAttachments(saveFileUris != nullptr, aCount, aDisplayNameArray)))</span>
<a href="#l12.3740"></a><span id="l12.3740" class="difflineminus">-      return NS_OK;</span>
<a href="#l12.3741"></a><span id="l12.3741" class="difflineplus">+  if (!withoutWarning &amp;&amp;</span>
<a href="#l12.3742"></a><span id="l12.3742" class="difflineplus">+      NS_FAILED(PromptIfDeleteAttachments(saveFileUris != nullptr, aCount,</span>
<a href="#l12.3743"></a><span id="l12.3743" class="difflineplus">+                                          aDisplayNameArray)))</span>
<a href="#l12.3744"></a><span id="l12.3744" class="difflineplus">+    return NS_OK;</span>
<a href="#l12.3745"></a><span id="l12.3745"> </span>
<a href="#l12.3746"></a><span id="l12.3746">   nsresult rv = NS_OK;</span>
<a href="#l12.3747"></a><span id="l12.3747"> </span>
<a href="#l12.3748"></a><span id="l12.3748">   // ensure that our arguments are valid</span>
<a href="#l12.3749"></a><span id="l12.3749" class="difflineminus">-//  char * partId;</span>
<a href="#l12.3750"></a><span id="l12.3750" class="difflineminus">-  for (uint32_t u = 0; u &lt; aCount; ++u)</span>
<a href="#l12.3751"></a><span id="l12.3751" class="difflineminus">-  {</span>
<a href="#l12.3752"></a><span id="l12.3752" class="difflineplus">+  //  char * partId;</span>
<a href="#l12.3753"></a><span id="l12.3753" class="difflineplus">+  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l12.3754"></a><span id="l12.3754">     // ensure all of the message URI are the same, we cannot process</span>
<a href="#l12.3755"></a><span id="l12.3755">     // attachments from different messages</span>
<a href="#l12.3756"></a><span id="l12.3756" class="difflineminus">-    if (u &gt; 0 &amp;&amp; 0 != strcmp(aMessageUriArray[0], aMessageUriArray[u]))</span>
<a href="#l12.3757"></a><span id="l12.3757" class="difflineminus">-    {</span>
<a href="#l12.3758"></a><span id="l12.3758" class="difflineplus">+    if (u &gt; 0 &amp;&amp; 0 != strcmp(aMessageUriArray[0], aMessageUriArray[u])) {</span>
<a href="#l12.3759"></a><span id="l12.3759">       rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l12.3760"></a><span id="l12.3760">       break;</span>
<a href="#l12.3761"></a><span id="l12.3761">     }</span>
<a href="#l12.3762"></a><span id="l12.3762"> </span>
<a href="#l12.3763"></a><span id="l12.3763">     // ensure that we don't have deleted messages in this list</span>
<a href="#l12.3764"></a><span id="l12.3764" class="difflineminus">-    if (0 == strcmp(aContentTypeArray[u], MIMETYPE_DELETED))</span>
<a href="#l12.3765"></a><span id="l12.3765" class="difflineminus">-    {</span>
<a href="#l12.3766"></a><span id="l12.3766" class="difflineplus">+    if (0 == strcmp(aContentTypeArray[u], MIMETYPE_DELETED)) {</span>
<a href="#l12.3767"></a><span id="l12.3767">       rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l12.3768"></a><span id="l12.3768">       break;</span>
<a href="#l12.3769"></a><span id="l12.3769">     }</span>
<a href="#l12.3770"></a><span id="l12.3770"> </span>
<a href="#l12.3771"></a><span id="l12.3771">     // for the moment we prevent any attachments other than root level</span>
<a href="#l12.3772"></a><span id="l12.3772">     // attachments being deleted (i.e. you can't delete attachments from a</span>
<a href="#l12.3773"></a><span id="l12.3773">     // email forwarded as an attachment). We do this by ensuring that the</span>
<a href="#l12.3774"></a><span id="l12.3774">     // part id only has a single period in it (e.g. &quot;1.2&quot;).</span>
<a href="#l12.3775"></a><span id="l12.3775" class="difflineminus">-    //TODO: support non-root level attachment delete</span>
<a href="#l12.3776"></a><span id="l12.3776" class="difflineminus">-//    partId = ::GetAttachmentPartId(aUrlArray[u]);</span>
<a href="#l12.3777"></a><span id="l12.3777" class="difflineminus">-//    if (!partId || PL_strchr(partId, '.') != PL_strrchr(partId, '.'))</span>
<a href="#l12.3778"></a><span id="l12.3778" class="difflineminus">-//    {</span>
<a href="#l12.3779"></a><span id="l12.3779" class="difflineminus">-//      rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l12.3780"></a><span id="l12.3780" class="difflineminus">-//      break;</span>
<a href="#l12.3781"></a><span id="l12.3781" class="difflineminus">-//    }</span>
<a href="#l12.3782"></a><span id="l12.3782" class="difflineplus">+    // TODO: support non-root level attachment delete</span>
<a href="#l12.3783"></a><span id="l12.3783" class="difflineplus">+    //    partId = ::GetAttachmentPartId(aUrlArray[u]);</span>
<a href="#l12.3784"></a><span id="l12.3784" class="difflineplus">+    //    if (!partId || PL_strchr(partId, '.') != PL_strrchr(partId, '.'))</span>
<a href="#l12.3785"></a><span id="l12.3785" class="difflineplus">+    //    {</span>
<a href="#l12.3786"></a><span id="l12.3786" class="difflineplus">+    //      rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l12.3787"></a><span id="l12.3787" class="difflineplus">+    //      break;</span>
<a href="#l12.3788"></a><span id="l12.3788" class="difflineplus">+    //    }</span>
<a href="#l12.3789"></a><span id="l12.3789">   }</span>
<a href="#l12.3790"></a><span id="l12.3790" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.3791"></a><span id="l12.3791" class="difflineminus">-  {</span>
<a href="#l12.3792"></a><span id="l12.3792" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.3793"></a><span id="l12.3793">     Alert(&quot;deleteAttachmentFailure&quot;);</span>
<a href="#l12.3794"></a><span id="l12.3794">     return rv;</span>
<a href="#l12.3795"></a><span id="l12.3795">   }</span>
<a href="#l12.3796"></a><span id="l12.3796"> </span>
<a href="#l12.3797"></a><span id="l12.3797" class="difflineminus">-  //TODO: ensure that nothing else is processing this message uri at the same time</span>
<a href="#l12.3798"></a><span id="l12.3798" class="difflineminus">-</span>
<a href="#l12.3799"></a><span id="l12.3799" class="difflineminus">-  //TODO: if any of the selected attachments are messages that contain other</span>
<a href="#l12.3800"></a><span id="l12.3800" class="difflineplus">+  // TODO: ensure that nothing else is processing this message uri at the same</span>
<a href="#l12.3801"></a><span id="l12.3801" class="difflineplus">+  // time</span>
<a href="#l12.3802"></a><span id="l12.3802" class="difflineplus">+</span>
<a href="#l12.3803"></a><span id="l12.3803" class="difflineplus">+  // TODO: if any of the selected attachments are messages that contain other</span>
<a href="#l12.3804"></a><span id="l12.3804">   // attachments we need to warn the user that all sub-attachments of those</span>
<a href="#l12.3805"></a><span id="l12.3805">   // messages will also be deleted. Best to display a list of them.</span>
<a href="#l12.3806"></a><span id="l12.3806"> </span>
<a href="#l12.3807"></a><span id="l12.3807">   // get the listener for running the url</span>
<a href="#l12.3808"></a><span id="l12.3808" class="difflineminus">-  nsDelAttachListener * listener = new nsDelAttachListener;</span>
<a href="#l12.3809"></a><span id="l12.3809" class="difflineminus">-  if (!listener)</span>
<a href="#l12.3810"></a><span id="l12.3810" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3811"></a><span id="l12.3811" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; listenerSupports; // auto-delete of the listener with error</span>
<a href="#l12.3812"></a><span id="l12.3812" class="difflineminus">-  listener-&gt;QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(listenerSupports));</span>
<a href="#l12.3813"></a><span id="l12.3813" class="difflineminus">-</span>
<a href="#l12.3814"></a><span id="l12.3814" class="difflineminus">-  if (saveFileUris)</span>
<a href="#l12.3815"></a><span id="l12.3815" class="difflineminus">-    listener-&gt;mDetachedFileUris = *saveFileUris;</span>
<a href="#l12.3816"></a><span id="l12.3816" class="difflineplus">+  nsDelAttachListener *listener = new nsDelAttachListener;</span>
<a href="#l12.3817"></a><span id="l12.3817" class="difflineplus">+  if (!listener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3818"></a><span id="l12.3818" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt;</span>
<a href="#l12.3819"></a><span id="l12.3819" class="difflineplus">+      listenerSupports;  // auto-delete of the listener with error</span>
<a href="#l12.3820"></a><span id="l12.3820" class="difflineplus">+  listener-&gt;QueryInterface(NS_GET_IID(nsISupports),</span>
<a href="#l12.3821"></a><span id="l12.3821" class="difflineplus">+                           getter_AddRefs(listenerSupports));</span>
<a href="#l12.3822"></a><span id="l12.3822" class="difflineplus">+</span>
<a href="#l12.3823"></a><span id="l12.3823" class="difflineplus">+  if (saveFileUris) listener-&gt;mDetachedFileUris = *saveFileUris;</span>
<a href="#l12.3824"></a><span id="l12.3824">   // create the attachments for use by the listener</span>
<a href="#l12.3825"></a><span id="l12.3825" class="difflineminus">-  nsAttachmentState * attach = new nsAttachmentState;</span>
<a href="#l12.3826"></a><span id="l12.3826" class="difflineminus">-  if (!attach)</span>
<a href="#l12.3827"></a><span id="l12.3827" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3828"></a><span id="l12.3828" class="difflineminus">-  rv = attach-&gt;Init(aCount, aContentTypeArray, aUrlArray, aDisplayNameArray, aMessageUriArray);</span>
<a href="#l12.3829"></a><span id="l12.3829" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.3830"></a><span id="l12.3830" class="difflineminus">-    rv = attach-&gt;PrepareForAttachmentDelete();</span>
<a href="#l12.3831"></a><span id="l12.3831" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.3832"></a><span id="l12.3832" class="difflineminus">-  {</span>
<a href="#l12.3833"></a><span id="l12.3833" class="difflineplus">+  nsAttachmentState *attach = new nsAttachmentState;</span>
<a href="#l12.3834"></a><span id="l12.3834" class="difflineplus">+  if (!attach) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3835"></a><span id="l12.3835" class="difflineplus">+  rv = attach-&gt;Init(aCount, aContentTypeArray, aUrlArray, aDisplayNameArray,</span>
<a href="#l12.3836"></a><span id="l12.3836" class="difflineplus">+                    aMessageUriArray);</span>
<a href="#l12.3837"></a><span id="l12.3837" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = attach-&gt;PrepareForAttachmentDelete();</span>
<a href="#l12.3838"></a><span id="l12.3838" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.3839"></a><span id="l12.3839">     delete attach;</span>
<a href="#l12.3840"></a><span id="l12.3840">     return rv;</span>
<a href="#l12.3841"></a><span id="l12.3841">   }</span>
<a href="#l12.3842"></a><span id="l12.3842"> </span>
<a href="#l12.3843"></a><span id="l12.3843" class="difflineminus">-  // initialize our listener with the attachments and details. The listener takes ownership</span>
<a href="#l12.3844"></a><span id="l12.3844" class="difflineminus">-  // of 'attach' immediately irrespective of the return value (error or not).</span>
<a href="#l12.3845"></a><span id="l12.3845" class="difflineminus">-  return listener-&gt;StartProcessing(this, mMsgWindow, attach, saveFileUris != nullptr);</span>
<a href="#l12.3846"></a><span id="l12.3846" class="difflineplus">+  // initialize our listener with the attachments and details. The listener</span>
<a href="#l12.3847"></a><span id="l12.3847" class="difflineplus">+  // takes ownership of 'attach' immediately irrespective of the return value</span>
<a href="#l12.3848"></a><span id="l12.3848" class="difflineplus">+  // (error or not).</span>
<a href="#l12.3849"></a><span id="l12.3849" class="difflineplus">+  return listener-&gt;StartProcessing(this, mMsgWindow, attach,</span>
<a href="#l12.3850"></a><span id="l12.3850" class="difflineplus">+                                   saveFileUris != nullptr);</span>
<a href="#l12.3851"></a><span id="l12.3851"> }</span>
<a href="#l12.3852"></a><span id="l12.3852"> </span>
<a href="#l12.3853"></a><span id="l12.3853" class="difflineminus">-nsresult</span>
<a href="#l12.3854"></a><span id="l12.3854" class="difflineminus">-nsMessenger::PromptIfDeleteAttachments(bool aSaveFirst,</span>
<a href="#l12.3855"></a><span id="l12.3855" class="difflineminus">-                                       uint32_t aCount,</span>
<a href="#l12.3856"></a><span id="l12.3856" class="difflineminus">-                                       const char ** aDisplayNameArray)</span>
<a href="#l12.3857"></a><span id="l12.3857" class="difflineminus">-{</span>
<a href="#l12.3858"></a><span id="l12.3858" class="difflineplus">+nsresult nsMessenger::PromptIfDeleteAttachments(</span>
<a href="#l12.3859"></a><span id="l12.3859" class="difflineplus">+    bool aSaveFirst, uint32_t aCount, const char **aDisplayNameArray) {</span>
<a href="#l12.3860"></a><span id="l12.3860">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l12.3861"></a><span id="l12.3861"> </span>
<a href="#l12.3862"></a><span id="l12.3862">   nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(mDocShell));</span>
<a href="#l12.3863"></a><span id="l12.3863">   if (!dialog) return rv;</span>
<a href="#l12.3864"></a><span id="l12.3864"> </span>
<a href="#l12.3865"></a><span id="l12.3865" class="difflineminus">-  if (!mStringBundle)</span>
<a href="#l12.3866"></a><span id="l12.3866" class="difflineminus">-  {</span>
<a href="#l12.3867"></a><span id="l12.3867" class="difflineplus">+  if (!mStringBundle) {</span>
<a href="#l12.3868"></a><span id="l12.3868">     rv = InitStringBundle();</span>
<a href="#l12.3869"></a><span id="l12.3869">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3870"></a><span id="l12.3870">   }</span>
<a href="#l12.3871"></a><span id="l12.3871"> </span>
<a href="#l12.3872"></a><span id="l12.3872">   // create the list of attachments we are removing</span>
<a href="#l12.3873"></a><span id="l12.3873">   nsString displayString;</span>
<a href="#l12.3874"></a><span id="l12.3874">   nsString attachmentList;</span>
<a href="#l12.3875"></a><span id="l12.3875" class="difflineminus">-  for (uint32_t u = 0; u &lt; aCount; ++u)</span>
<a href="#l12.3876"></a><span id="l12.3876" class="difflineminus">-  {</span>
<a href="#l12.3877"></a><span id="l12.3877" class="difflineplus">+  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l12.3878"></a><span id="l12.3878">     ConvertAndSanitizeFileName(aDisplayNameArray[u], displayString);</span>
<a href="#l12.3879"></a><span id="l12.3879">     attachmentList.Append(displayString);</span>
<a href="#l12.3880"></a><span id="l12.3880">     attachmentList.Append(char16_t('\n'));</span>
<a href="#l12.3881"></a><span id="l12.3881">   }</span>
<a href="#l12.3882"></a><span id="l12.3882" class="difflineminus">-  const char16_t *formatStrings[] = { attachmentList.get() };</span>
<a href="#l12.3883"></a><span id="l12.3883" class="difflineplus">+  const char16_t *formatStrings[] = {attachmentList.get()};</span>
<a href="#l12.3884"></a><span id="l12.3884"> </span>
<a href="#l12.3885"></a><span id="l12.3885">   // format the message and display</span>
<a href="#l12.3886"></a><span id="l12.3886">   nsString promptMessage;</span>
<a href="#l12.3887"></a><span id="l12.3887" class="difflineminus">-  const char * propertyName = aSaveFirst ?</span>
<a href="#l12.3888"></a><span id="l12.3888" class="difflineminus">-    &quot;detachAttachments&quot; : &quot;deleteAttachments&quot;;</span>
<a href="#l12.3889"></a><span id="l12.3889" class="difflineminus">-  rv = mStringBundle-&gt;FormatStringFromName(propertyName, formatStrings, 1,promptMessage);</span>
<a href="#l12.3890"></a><span id="l12.3890" class="difflineplus">+  const char *propertyName =</span>
<a href="#l12.3891"></a><span id="l12.3891" class="difflineplus">+      aSaveFirst ? &quot;detachAttachments&quot; : &quot;deleteAttachments&quot;;</span>
<a href="#l12.3892"></a><span id="l12.3892" class="difflineplus">+  rv = mStringBundle-&gt;FormatStringFromName(propertyName, formatStrings, 1,</span>
<a href="#l12.3893"></a><span id="l12.3893" class="difflineplus">+                                           promptMessage);</span>
<a href="#l12.3894"></a><span id="l12.3894">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3895"></a><span id="l12.3895"> </span>
<a href="#l12.3896"></a><span id="l12.3896">   bool dialogResult = false;</span>
<a href="#l12.3897"></a><span id="l12.3897">   rv = dialog-&gt;Confirm(nullptr, promptMessage.get(), &amp;dialogResult);</span>
<a href="#l12.3898"></a><span id="l12.3898">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3899"></a><span id="l12.3899"> </span>
<a href="#l12.3900"></a><span id="l12.3900">   return dialogResult ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l12.3901"></a><span id="l12.3901"> }</span>
<a href="#l12.3902"></a><span id="l12.3902" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -16,108 +16,107 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIFile.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIFilePicker.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsTArray.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-class nsMessenger : public nsIMessenger, public nsSupportsWeakReference, public nsIFolderListener</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+class nsMessenger : public nsIMessenger,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                    public nsSupportsWeakReference,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+                    public nsIFolderListener {</span>
<a href="#l13.17"></a><span id="l13.17">   using PathString = mozilla::PathString;</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-public:</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ public:</span>
<a href="#l13.21"></a><span id="l13.21">   nsMessenger();</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   NS_DECL_ISUPPORTS</span>
<a href="#l13.24"></a><span id="l13.24">   NS_DECL_NSIMESSENGER</span>
<a href="#l13.25"></a><span id="l13.25">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  nsresult Alert(const char * stringName);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  nsresult Alert(const char *stringName);</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  nsresult SaveAttachment(nsIFile *file, const nsACString&amp; unescapedUrl,</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                          const nsACString&amp; messageUri, const nsACString&amp; contentType,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                          void *closure, nsIUrlListener *aListener);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  nsresult SaveAttachment(nsIFile *file, const nsACString &amp;unescapedUrl,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+                          const nsACString &amp;messageUri,</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+                          const nsACString &amp;contentType, void *closure,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+                          nsIUrlListener *aListener);</span>
<a href="#l13.37"></a><span id="l13.37">   nsresult PromptIfFileExists(nsIFile *file);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  nsresult DetachAttachments(uint32_t aCount,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-                             const char ** aContentTypeArray,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-                             const char ** aUrlArray,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-                             const char ** aDisplayNameArray,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-                             const char ** aMessageUriArray,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  nsresult DetachAttachments(uint32_t aCount, const char **aContentTypeArray,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                             const char **aUrlArray,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                             const char **aDisplayNameArray,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+                             const char **aMessageUriArray,</span>
<a href="#l13.47"></a><span id="l13.47">                              nsTArray&lt;nsCString&gt; *saveFileUris,</span>
<a href="#l13.48"></a><span id="l13.48">                              bool withoutWarning = false);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  nsresult SaveAllAttachments(uint32_t count,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-                              const char **contentTypeArray,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  nsresult SaveAllAttachments(uint32_t count, const char **contentTypeArray,</span>
<a href="#l13.52"></a><span id="l13.52">                               const char **urlArray,</span>
<a href="#l13.53"></a><span id="l13.53">                               const char **displayNameArray,</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-                              const char **messageUriArray,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-                              bool detaching);</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-  nsresult SaveOneAttachment(const char* aContentType,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-                             const char* aURL,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-                             const char* aDisplayName,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-                             const char* aMessageUri,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+                              const char **messageUriArray, bool detaching);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  nsresult SaveOneAttachment(const char *aContentType, const char *aURL,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+                             const char *aDisplayName, const char *aMessageUri,</span>
<a href="#l13.63"></a><span id="l13.63">                              bool detaching);</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-protected:</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+ protected:</span>
<a href="#l13.67"></a><span id="l13.67">   virtual ~nsMessenger();</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  void GetString(const nsString&amp; aStringName, nsString&amp; stringValue);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  void GetString(const nsString &amp;aStringName, nsString &amp;stringValue);</span>
<a href="#l13.71"></a><span id="l13.71">   nsresult InitStringBundle();</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  nsresult PromptIfDeleteAttachments(bool saveFirst, uint32_t count, const char **displayNameArray);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  nsresult PromptIfDeleteAttachments(bool saveFirst, uint32_t count,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+                                     const char **displayNameArray);</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-private:</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+ private:</span>
<a href="#l13.78"></a><span id="l13.78">   nsresult GetLastSaveDirectory(nsIFile **aLastSaveAsDir);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-  // if aLocalFile is a dir, we use it.  otherwise, we use the parent of aLocalFile.</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  // if aLocalFile is a dir, we use it.  otherwise, we use the parent of</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+  // aLocalFile.</span>
<a href="#l13.82"></a><span id="l13.82">   nsresult SetLastSaveDirectory(nsIFile *aLocalFile);</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-  nsresult AdjustFileIfNameTooLong(nsIFile* aFile);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  nsresult AdjustFileIfNameTooLong(nsIFile *aFile);</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-  nsresult GetSaveAsFile(const nsAString&amp; aMsgFilename, int32_t *aSaveAsFileType,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-                         nsIFile **aSaveAsFile);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+  nsresult GetSaveAsFile(const nsAString &amp;aMsgFilename,</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+                         int32_t *aSaveAsFileType, nsIFile **aSaveAsFile);</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92">   nsresult GetSaveToDir(nsIFile **aSaveToDir);</span>
<a href="#l13.93"></a><span id="l13.93">   nsresult ShowPicker(nsIFilePicker *aPicker, int16_t *aResult);</span>
<a href="#l13.94"></a><span id="l13.94"> </span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-  class nsFilePickerShownCallback</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-    : public nsIFilePickerShownCallback</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-  {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-    virtual ~nsFilePickerShownCallback()</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-    { }</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  class nsFilePickerShownCallback : public nsIFilePickerShownCallback {</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    virtual ~nsFilePickerShownCallback() {}</span>
<a href="#l13.102"></a><span id="l13.102"> </span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-  public:</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+   public:</span>
<a href="#l13.105"></a><span id="l13.105">     nsFilePickerShownCallback();</span>
<a href="#l13.106"></a><span id="l13.106">     NS_DECL_ISUPPORTS</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108">     NS_IMETHOD Done(int16_t aResult) override;</span>
<a href="#l13.109"></a><span id="l13.109"> </span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  public:</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+   public:</span>
<a href="#l13.112"></a><span id="l13.112">     bool mPickerDone;</span>
<a href="#l13.113"></a><span id="l13.113">     int16_t mResult;</span>
<a href="#l13.114"></a><span id="l13.114">   };</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116">   nsString mId;</span>
<a href="#l13.117"></a><span id="l13.117">   nsCOMPtr&lt;nsITransactionManager&gt; mTxnMgr;</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119">   /* rhp - need this to drive message display */</span>
<a href="#l13.120"></a><span id="l13.120">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; mWindow;</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt;       mMsgWindow;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt;        mDocShell;</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; mDocShell;</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126">   // String bundles...</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   mStringBundle;</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; mStringBundle;</span>
<a href="#l13.129"></a><span id="l13.129"> </span>
<a href="#l13.130"></a><span id="l13.130">   nsCString mCurrentDisplayCharset;</span>
<a href="#l13.131"></a><span id="l13.131"> </span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt;  mSearchContext;</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  nsCString   mLastDisplayURI; // this used when the user attempts to force a charset reload of a message...we need to get the last displayed</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-                               // uri so we can re-display it..</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mSearchContext;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+  // this used when the user attempts to force a charset reload of a message...</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+  // we need to get the last displayed uri so we can re-display it.</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  nsCString mLastDisplayURI;</span>
<a href="#l13.139"></a><span id="l13.139">   nsCString mNavigatingToUri;</span>
<a href="#l13.140"></a><span id="l13.140">   nsTArray&lt;nsCString&gt; mLoadedMsgHistory;</span>
<a href="#l13.141"></a><span id="l13.141">   int32_t mCurHistoryPos;</span>
<a href="#l13.142"></a><span id="l13.142"> };</span>
<a href="#l13.143"></a><span id="l13.143"> </span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-#define NS_MESSENGER_CID \</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-{ /* f436a174-e2c0-4955-9afe-e3feb68aee56 */      \</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-  0xf436a174, 0xe2c0, 0x4955,                     \</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-    {0x9a, 0xfe, 0xe3, 0xfe, 0xb6, 0x8a, 0xee, 0x56}}</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+#define NS_MESSENGER_CID                             \</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+  { /* f436a174-e2c0-4955-9afe-e3feb68aee56 */       \</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    0xf436a174, 0xe2c0, 0x4955, {                    \</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+      0x9a, 0xfe, 0xe3, 0xfe, 0xb6, 0x8a, 0xee, 0x56 \</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    }                                                \</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+  }</span>
<a href="#l13.154"></a><span id="l13.154"> </span>
<a href="#l13.155"></a><span id="l13.155"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -12,72 +12,71 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> NS_IMPL_ISUPPORTS(nsMessengerBootstrap, nsIMessengerWindowService)</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsMessengerBootstrap::nsMessengerBootstrap()</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-}</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+nsMessengerBootstrap::nsMessengerBootstrap() {}</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-nsMessengerBootstrap::~nsMessengerBootstrap()</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-{</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-}</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+nsMessengerBootstrap::~nsMessengerBootstrap() {}</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-NS_IMETHODIMP nsMessengerBootstrap::OpenMessengerWindowWithUri(const char *windowType, const char * aFolderURI, nsMsgKey aMessageKey)</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-{</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+NS_IMETHODIMP nsMessengerBootstrap::OpenMessengerWindowWithUri(</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    const char *windowType, const char *aFolderURI, nsMsgKey aMessageKey) {</span>
<a href="#l14.26"></a><span id="l14.26">   bool standAloneMsgWindow = false;</span>
<a href="#l14.27"></a><span id="l14.27">   nsAutoCString chromeUrl(&quot;chrome://messenger/content/&quot;);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  if (windowType &amp;&amp; !strcmp(windowType, &quot;mail:messageWindow&quot;))</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  if (windowType &amp;&amp; !strcmp(windowType, &quot;mail:messageWindow&quot;)) {</span>
<a href="#l14.31"></a><span id="l14.31">     chromeUrl.AppendLiteral(&quot;messageWindow.xul&quot;);</span>
<a href="#l14.32"></a><span id="l14.32">     standAloneMsgWindow = true;</span>
<a href="#l14.33"></a><span id="l14.33">   }</span>
<a href="#l14.34"></a><span id="l14.34">   nsresult rv;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; argsArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; argsArray(</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l14.38"></a><span id="l14.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  // create scriptable versions of our strings that we can store in our nsIMutableArray....</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  if (aFolderURI)</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    if (standAloneMsgWindow)</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-      rv = GetExistingFolder(nsDependentCString(aFolderURI), getter_AddRefs(folder));</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  // create scriptable versions of our strings that we can store in our</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  // nsIMutableArray....</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  if (aFolderURI) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    if (standAloneMsgWindow) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+      rv = GetExistingFolder(nsDependentCString(aFolderURI),</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                             getter_AddRefs(folder));</span>
<a href="#l14.54"></a><span id="l14.54">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.55"></a><span id="l14.55">       nsAutoCString msgUri;</span>
<a href="#l14.56"></a><span id="l14.56">       folder-&gt;GetBaseMessageURI(msgUri);</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-      nsCOMPtr&lt;nsISupportsCString&gt; scriptableMsgURI (do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID));</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+      nsCOMPtr&lt;nsISupportsCString&gt; scriptableMsgURI(</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+          do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID));</span>
<a href="#l14.61"></a><span id="l14.61">       NS_ENSURE_TRUE(scriptableMsgURI, NS_ERROR_FAILURE);</span>
<a href="#l14.62"></a><span id="l14.62">       msgUri.Append('#');</span>
<a href="#l14.63"></a><span id="l14.63">       msgUri.AppendInt(aMessageKey, 10);</span>
<a href="#l14.64"></a><span id="l14.64">       scriptableMsgURI-&gt;SetData(msgUri);</span>
<a href="#l14.65"></a><span id="l14.65">       argsArray-&gt;AppendElement(scriptableMsgURI);</span>
<a href="#l14.66"></a><span id="l14.66">     }</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    nsCOMPtr&lt;nsISupportsCString&gt; scriptableFolderURI (do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID));</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    nsCOMPtr&lt;nsISupportsCString&gt; scriptableFolderURI(</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID));</span>
<a href="#l14.70"></a><span id="l14.70">     NS_ENSURE_TRUE(scriptableFolderURI, NS_ERROR_FAILURE);</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72">     scriptableFolderURI-&gt;SetData(nsDependentCString(aFolderURI));</span>
<a href="#l14.73"></a><span id="l14.73">     argsArray-&gt;AppendElement(scriptableFolderURI);</span>
<a href="#l14.74"></a><span id="l14.74"> </span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    if (!standAloneMsgWindow)</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-    {</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-      nsCOMPtr&lt;nsISupportsPRUint32&gt; scriptableMessageKey (do_CreateInstance(NS_SUPPORTS_PRUINT32_CONTRACTID));</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+    if (!standAloneMsgWindow) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+      nsCOMPtr&lt;nsISupportsPRUint32&gt; scriptableMessageKey(</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+          do_CreateInstance(NS_SUPPORTS_PRUINT32_CONTRACTID));</span>
<a href="#l14.81"></a><span id="l14.81">       NS_ENSURE_TRUE(scriptableMessageKey, NS_ERROR_FAILURE);</span>
<a href="#l14.82"></a><span id="l14.82">       scriptableMessageKey-&gt;SetData(aMessageKey);</span>
<a href="#l14.83"></a><span id="l14.83">       argsArray-&gt;AppendElement(scriptableMessageKey);</span>
<a href="#l14.84"></a><span id="l14.84">     }</span>
<a href="#l14.85"></a><span id="l14.85">   }</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+      do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l14.90"></a><span id="l14.90">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92">   // we need to use the &quot;mailnews.reuse_thread_window2&quot; pref</span>
<a href="#l14.93"></a><span id="l14.93">   // to determine if we should open a new window, or use an existing one.</span>
<a href="#l14.94"></a><span id="l14.94">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l14.95"></a><span id="l14.95">   return wwatch-&gt;OpenWindow(0, chromeUrl.get(), &quot;_blank&quot;,</span>
<a href="#l14.96"></a><span id="l14.96">                             &quot;chrome,all,dialog=no&quot;, argsArray,</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-                             getter_AddRefs(newWindow));</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+                            getter_AddRefs(newWindow));</span>
<a href="#l14.99"></a><span id="l14.99"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,31 +1,30 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10"> #ifndef __nsMessenger_h</span>
<a href="#l15.11"></a><span id="l15.11"> #define __nsMessenger_h</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> #include &quot;nscore.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-#define NS_MESSENGERBOOTSTRAP_CID                 \</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-{ /* 4a85a5d0-cddd-11d2-b7f6-00805f05ffa5 */      \</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  0x4a85a5d0, 0xcddd, 0x11d2,                     \</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  {0xb7, 0xf6, 0x00, 0x80, 0x5f, 0x05, 0xff, 0xa5}}</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+#define NS_MESSENGERBOOTSTRAP_CID                    \</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+  { /* 4a85a5d0-cddd-11d2-b7f6-00805f05ffa5 */       \</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+    0x4a85a5d0, 0xcddd, 0x11d2, {                    \</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+      0xb7, 0xf6, 0x00, 0x80, 0x5f, 0x05, 0xff, 0xa5 \</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+    }                                                \</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  }</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-class nsMessengerBootstrap :</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    public nsIMessengerWindowService</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-{</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-public:</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+class nsMessengerBootstrap : public nsIMessengerWindowService {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ public:</span>
<a href="#l15.33"></a><span id="l15.33">   nsMessengerBootstrap();</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l15.36"></a><span id="l15.36">   NS_DECL_NSIMESSENGERWINDOWSERVICE</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-private:</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ private:</span>
<a href="#l15.40"></a><span id="l15.40">   virtual ~nsMessengerBootstrap();</span>
<a href="#l15.41"></a><span id="l15.41"> };</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -12,88 +12,81 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsString.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;plstr.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-nsMessengerContentHandler::nsMessengerContentHandler()</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-}</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+nsMessengerContentHandler::nsMessengerContentHandler() {}</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-/* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+/* the following macro actually implement addref, release and query interface</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ * for our component. */</span>
<a href="#l16.20"></a><span id="l16.20"> NS_IMPL_ISUPPORTS(nsMessengerContentHandler, nsIContentHandler)</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-nsMessengerContentHandler::~nsMessengerContentHandler()</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-{</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-}</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+nsMessengerContentHandler::~nsMessengerContentHandler() {}</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-NS_IMETHODIMP nsMessengerContentHandler::HandleContent(const char * aContentType,</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-                                                nsIInterfaceRequestor* aWindowContext, nsIRequest *request)</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-{</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+NS_IMETHODIMP nsMessengerContentHandler::HandleContent(</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+    const char* aContentType, nsIInterfaceRequestor* aWindowContext,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    nsIRequest* request) {</span>
<a href="#l16.33"></a><span id="l16.33">   nsresult rv = NS_OK;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  if (!request)</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  if (!request) return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  // First of all, get the content type and make sure it is a content type we know how to handle!</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  // First of all, get the content type and make sure it is a content type we</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  // know how to handle!</span>
<a href="#l16.41"></a><span id="l16.41">   if (PL_strcasecmp(aContentType, &quot;application/x-message-display&quot;) == 0) {</span>
<a href="#l16.42"></a><span id="l16.42">     nsCOMPtr&lt;nsIURI&gt; aUri;</span>
<a href="#l16.43"></a><span id="l16.43">     nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l16.44"></a><span id="l16.44">     if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">     rv = aChannel-&gt;GetURI(getter_AddRefs(aUri));</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-    if (aUri)</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-    {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+    if (aUri) {</span>
<a href="#l16.50"></a><span id="l16.50">       rv = request-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-      {</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.54"></a><span id="l16.54">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aUri);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-        if (mailnewsurl)</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-        {</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+        if (mailnewsurl) {</span>
<a href="#l16.58"></a><span id="l16.58">           nsAutoCString queryPart;</span>
<a href="#l16.59"></a><span id="l16.59">           mailnewsurl-&gt;GetQuery(queryPart);</span>
<a href="#l16.60"></a><span id="l16.60">           queryPart.Replace(queryPart.Find(&quot;type=message/rfc822&quot;),</span>
<a href="#l16.61"></a><span id="l16.61">                             sizeof(&quot;type=message/rfc822&quot;) - 1,</span>
<a href="#l16.62"></a><span id="l16.62">                             &quot;type=application/x-message-display&quot;);</span>
<a href="#l16.63"></a><span id="l16.63">           // Don't mutate/clone here.</span>
<a href="#l16.64"></a><span id="l16.64">           rv = mailnewsurl-&gt;SetQueryInternal(queryPart);</span>
<a href="#l16.65"></a><span id="l16.65">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.66"></a><span id="l16.66">           rv = OpenWindow(aUri);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-        }</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-        else</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-        {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+        } else {</span>
<a href="#l16.71"></a><span id="l16.71">           // Not an nsIMsgMailNewsUrl, so maybe a file URL, like opening a</span>
<a href="#l16.72"></a><span id="l16.72">           // message attachment (.eml file in a temp directory).</span>
<a href="#l16.73"></a><span id="l16.73">           nsAutoCString scheme;</span>
<a href="#l16.74"></a><span id="l16.74">           rv = aUri-&gt;GetScheme(scheme);</span>
<a href="#l16.75"></a><span id="l16.75">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.76"></a><span id="l16.76">           if (scheme.Equals(&quot;file&quot;)) {</span>
<a href="#l16.77"></a><span id="l16.77">             // Add a special bit like in MsgOpenFromFile().</span>
<a href="#l16.78"></a><span id="l16.78">             rv = NS_MutateURI(aUri)</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-                   .SetQuery(NS_LITERAL_CSTRING(&quot;type=application/x-message-display&quot;))</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-                   .Finalize(aUri);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+                     .SetQuery(NS_LITERAL_CSTRING(</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+                         &quot;type=application/x-message-display&quot;))</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+                     .Finalize(aUri);</span>
<a href="#l16.84"></a><span id="l16.84">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.85"></a><span id="l16.85">           }</span>
<a href="#l16.86"></a><span id="l16.86">           rv = OpenWindow(aUri);</span>
<a href="#l16.87"></a><span id="l16.87">         }</span>
<a href="#l16.88"></a><span id="l16.88">       }</span>
<a href="#l16.89"></a><span id="l16.89">     }</span>
<a href="#l16.90"></a><span id="l16.90">   }</span>
<a href="#l16.91"></a><span id="l16.91"> </span>
<a href="#l16.92"></a><span id="l16.92">   return rv;</span>
<a href="#l16.93"></a><span id="l16.93"> }</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-// Utility function to open a message display window and and load the message in it.</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-nsresult nsMessengerContentHandler::OpenWindow(nsIURI* aURI)</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-{</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+// Utility function to open a message display window and and load the message in</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+// it.</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+nsresult nsMessengerContentHandler::OpenWindow(nsIURI* aURI) {</span>
<a href="#l16.101"></a><span id="l16.101">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch = do_GetService(&quot;@mozilla.org/embedcomp/window-watcher;1&quot;);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-  if (!wwatch)</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch =</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+      do_GetService(&quot;@mozilla.org/embedcomp/window-watcher;1&quot;);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+  if (!wwatch) return NS_ERROR_FAILURE;</span>
<a href="#l16.109"></a><span id="l16.109"> </span>
<a href="#l16.110"></a><span id="l16.110">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l16.111"></a><span id="l16.111">   return wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-                 &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, aURI,</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-                 getter_AddRefs(newWindow));</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+                            &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+                            aURI, getter_AddRefs(newWindow));</span>
<a href="#l16.116"></a><span id="l16.116"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerContentHandler.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerContentHandler.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,20 +1,19 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.5"></a><span id="l17.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsIURI.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-class nsMessengerContentHandler : public nsIContentHandler</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-public:</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+class nsMessengerContentHandler : public nsIContentHandler {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ public:</span>
<a href="#l17.17"></a><span id="l17.17">   nsMessengerContentHandler();</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">   NS_DECL_ISUPPORTS</span>
<a href="#l17.20"></a><span id="l17.20">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-private:</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ private:</span>
<a href="#l17.24"></a><span id="l17.24">   virtual ~nsMessengerContentHandler();</span>
<a href="#l17.25"></a><span id="l17.25">   nsresult OpenWindow(nsIURI* aURI);</span>
<a href="#l17.26"></a><span id="l17.26"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -10,51 +10,57 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsITimer.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsString.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIAlertsService.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;mozINewMailListener.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#define NS_MESSENGEROSXINTEGRATION_CID \</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  {0xaa83266, 0x4225, 0x4c4b, \</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  {0x93, 0xf8, 0x94, 0xb1, 0x82, 0x58, 0x6f, 0x93}}</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+#define NS_MESSENGEROSXINTEGRATION_CID               \</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+  {                                                  \</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+    0xaa83266, 0x4225, 0x4c4b, {                     \</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+      0x93, 0xf8, 0x94, 0xb1, 0x82, 0x58, 0x6f, 0x93 \</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+    }                                                \</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> class nsIStringBundle;</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24"> class nsMessengerOSXIntegration : public nsIMessengerOSIntegration,</span>
<a href="#l18.25"></a><span id="l18.25">                                   public nsIFolderListener,</span>
<a href="#l18.26"></a><span id="l18.26">                                   public nsIObserver,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                                  public mozINewMailListener</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-{</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-public:</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+                                  public mozINewMailListener {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ public:</span>
<a href="#l18.32"></a><span id="l18.32">   nsMessengerOSXIntegration();</span>
<a href="#l18.33"></a><span id="l18.33">   virtual nsresult Init();</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">   NS_DECL_ISUPPORTS</span>
<a href="#l18.36"></a><span id="l18.36">   NS_DECL_NSIMESSENGEROSINTEGRATION</span>
<a href="#l18.37"></a><span id="l18.37">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l18.38"></a><span id="l18.38">   NS_DECL_NSIOBSERVER</span>
<a href="#l18.39"></a><span id="l18.39">   NS_DECL_MOZINEWMAILLISTENER</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-private:</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+ private:</span>
<a href="#l18.43"></a><span id="l18.43">   virtual ~nsMessengerOSXIntegration();</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  nsresult ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  nsresult ShowAlertMessage(const nsAString&amp; aAlertTitle,</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+                            const nsAString&amp; aAlertText,</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+                            const nsACString&amp; aFolderURI);</span>
<a href="#l18.49"></a><span id="l18.49">   nsresult OnAlertFinished();</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-  nsresult OnAlertClicked(const char16_t * aAlertCookie);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  nsresult OnAlertClicked(const char16_t* aAlertCookie);</span>
<a href="#l18.52"></a><span id="l18.52"> #ifdef MOZ_SUITE</span>
<a href="#l18.53"></a><span id="l18.53">   nsresult OnAlertClickedSimple();</span>
<a href="#l18.54"></a><span id="l18.54"> #endif</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  void FillToolTipInfo(nsIMsgFolder *aFolder, int32_t aNewCount);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-  nsresult GetFirstFolderWithNewMail(nsIMsgFolder* aFolder, nsCString&amp; aFolderURI);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+  nsresult GetStringBundle(nsIStringBundle** aBundle);</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  void FillToolTipInfo(nsIMsgFolder* aFolder, int32_t aNewCount);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  nsresult GetFirstFolderWithNewMail(nsIMsgFolder* aFolder,</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+                                     nsCString&amp; aFolderURI);</span>
<a href="#l18.62"></a><span id="l18.62">   nsresult BadgeDockIcon();</span>
<a href="#l18.63"></a><span id="l18.63">   nsresult RestoreDockIcon();</span>
<a href="#l18.64"></a><span id="l18.64">   nsresult BounceDockIcon();</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-  nsresult GetNewMailAuthors(nsIMsgFolder* aFolder, nsString&amp; aAuthors, int32_t aNewCount, int32_t* aNotDisplayed);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  nsresult GetNewMailAuthors(nsIMsgFolder* aFolder, nsString&amp; aAuthors,</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+                             int32_t aNewCount, int32_t* aNotDisplayed);</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69">   int32_t mUnreadTotal;</span>
<a href="#l18.70"></a><span id="l18.70">   int32_t mUnreadChat;</span>
<a href="#l18.71"></a><span id="l18.71"> };</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-#endif // __nsMessengerOSXIntegration_h</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+#endif  // __nsMessengerOSXIntegration_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerOSXIntegration.mm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -57,212 +57,182 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #define kBiffAnimateDockIconPref &quot;mail.biff.animate_dock_icon&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #define kMaxDisplayCount 10</span>
<a href="#l19.6"></a><span id="l19.6"> #define kNewChatMessageTopic &quot;new-directed-incoming-message&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #define kUnreadImCountChangedTopic &quot;unread-im-count-changed&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> using namespace mozilla::mailnews;</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> // HACK: Limitations in Focus/SetFocus on Mac (see bug 465446)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-nsresult FocusAppNative()</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+nsresult FocusAppNative() {</span>
<a href="#l19.15"></a><span id="l19.15">   ProcessSerialNumber psn;</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  if (::GetCurrentProcess(&amp;psn) != 0)</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-   return NS_ERROR_FAILURE;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  if (::GetCurrentProcess(&amp;psn) != 0) return NS_ERROR_FAILURE;</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-  if (::SetFrontProcess(&amp;psn) != 0)</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-   return NS_ERROR_FAILURE;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+  if (::SetFrontProcess(&amp;psn) != 0) return NS_ERROR_FAILURE;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   return NS_OK;</span>
<a href="#l19.26"></a><span id="l19.26"> }</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-static void openMailWindow(const nsCString&amp; aUri)</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-{</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+static void openMailWindow(const nsCString &amp;aUri) {</span>
<a href="#l19.31"></a><span id="l19.31">   nsresult rv;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-    return;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38">   nsCOMPtr&lt;nsIMsgWindow&gt; topMostMsgWindow;</span>
<a href="#l19.39"></a><span id="l19.39">   rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMostMsgWindow));</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  if (topMostMsgWindow)</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-    if (!aUri.IsEmpty())</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-    {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  if (topMostMsgWindow) {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+    if (!aUri.IsEmpty()) {</span>
<a href="#l19.46"></a><span id="l19.46">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUri(do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv));</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-        return;</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+      if (NS_FAILED(rv)) return;</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51">       rv = msgUri-&gt;SetSpecInternal(aUri);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-        return;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+      if (NS_FAILED(rv)) return;</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56">       bool isMessageUri = false;</span>
<a href="#l19.57"></a><span id="l19.57">       msgUri-&gt;GetIsMessageUri(&amp;isMessageUri);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-      if (isMessageUri)</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-      {</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+      if (isMessageUri) {</span>
<a href="#l19.61"></a><span id="l19.61">         nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-          return;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+        if (NS_FAILED(rv)) return;</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-        // SeaMonkey only supports message uris, whereas Thunderbird only</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-        // supports message headers. This should be simplified/removed when</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-        // bug 507593 is implemented.</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+          // SeaMonkey only supports message uris, whereas Thunderbird only</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+          // supports message headers. This should be simplified/removed when</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+          // bug 507593 is implemented.</span>
<a href="#l19.72"></a><span id="l19.72"> #ifdef MOZ_SUITE</span>
<a href="#l19.73"></a><span id="l19.73">         nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-        wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-                           &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, msgUri,</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+        wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+                           &quot;all,chrome,dialog=no,status,toolbar&quot;, msgUri,</span>
<a href="#l19.78"></a><span id="l19.78">                            getter_AddRefs(newWindow));</span>
<a href="#l19.79"></a><span id="l19.79"> #else</span>
<a href="#l19.80"></a><span id="l19.80">         nsCOMPtr&lt;nsIMessenger&gt; messenger(do_CreateInstance(NS_MESSENGER_CONTRACTID, &amp;rv));</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-          return;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+        if (NS_FAILED(rv)) return;</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l19.86"></a><span id="l19.86">         messenger-&gt;MsgHdrFromURI(aUri, getter_AddRefs(msgHdr));</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-        if (msgHdr)</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-        {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+        if (msgHdr) {</span>
<a href="#l19.90"></a><span id="l19.90">           nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-          wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-                             &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, msgHdr,</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+          wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+                             &quot;all,chrome,dialog=no,status,toolbar&quot;, msgHdr,</span>
<a href="#l19.95"></a><span id="l19.95">                              getter_AddRefs(newWindow));</span>
<a href="#l19.96"></a><span id="l19.96">         }</span>
<a href="#l19.97"></a><span id="l19.97"> #endif</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-      }</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-      else</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-      {</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+      } else {</span>
<a href="#l19.102"></a><span id="l19.102">         nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l19.103"></a><span id="l19.103">         topMostMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-        if (windowCommands)</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-          windowCommands-&gt;SelectFolder(aUri);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+        if (windowCommands) windowCommands-&gt;SelectFolder(aUri);</span>
<a href="#l19.107"></a><span id="l19.107">       }</span>
<a href="#l19.108"></a><span id="l19.108">     }</span>
<a href="#l19.109"></a><span id="l19.109"> </span>
<a href="#l19.110"></a><span id="l19.110">     FocusAppNative();</span>
<a href="#l19.111"></a><span id="l19.111">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l19.112"></a><span id="l19.112">     topMostMsgWindow-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l19.113"></a><span id="l19.113">     if (domWindow) {</span>
<a href="#l19.114"></a><span id="l19.114">       nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l19.115"></a><span id="l19.115">       privateWindow-&gt;Focus();</span>
<a href="#l19.116"></a><span id="l19.116">     }</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-  }</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-  else</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-  {</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+  } else {</span>
<a href="#l19.121"></a><span id="l19.121">     // the user doesn't have a mail window open already so open one for them...</span>
<a href="#l19.122"></a><span id="l19.122">     nsCOMPtr&lt;nsIMessengerWindowService&gt; messengerWindowService =</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-      do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+        do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l19.125"></a><span id="l19.125">     // if we want to preselect the first account with new mail,</span>
<a href="#l19.126"></a><span id="l19.126">     // here is where we would try to generate a uri to pass in</span>
<a href="#l19.127"></a><span id="l19.127">     // (and add code to the messenger window service to make that work)</span>
<a href="#l19.128"></a><span id="l19.128">     if (messengerWindowService)</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-      messengerWindowService-&gt;OpenMessengerWindowWithUri(</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-                                &quot;mail:3pane&quot;, aUri.get(), nsMsgKey_None);</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+      messengerWindowService-&gt;OpenMessengerWindowWithUri(&quot;mail:3pane&quot;, aUri.get(), nsMsgKey_None);</span>
<a href="#l19.132"></a><span id="l19.132">   }</span>
<a href="#l19.133"></a><span id="l19.133"> }</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-nsMessengerOSXIntegration::nsMessengerOSXIntegration()</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-{</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+nsMessengerOSXIntegration::nsMessengerOSXIntegration() {</span>
<a href="#l19.138"></a><span id="l19.138">   mUnreadTotal = 0;</span>
<a href="#l19.139"></a><span id="l19.139">   mUnreadChat = 0;</span>
<a href="#l19.140"></a><span id="l19.140"> }</span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-nsMessengerOSXIntegration::~nsMessengerOSXIntegration()</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-{</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-  RestoreDockIcon();</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-}</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+nsMessengerOSXIntegration::~nsMessengerOSXIntegration() { RestoreDockIcon(); }</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148"> NS_IMPL_ADDREF(nsMessengerOSXIntegration)</span>
<a href="#l19.149"></a><span id="l19.149"> NS_IMPL_RELEASE(nsMessengerOSXIntegration)</span>
<a href="#l19.150"></a><span id="l19.150"> </span>
<a href="#l19.151"></a><span id="l19.151"> NS_INTERFACE_MAP_BEGIN(nsMessengerOSXIntegration)</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMessengerOSIntegration)</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMessengerOSIntegration)</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIFolderListener)</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(mozINewMailListener)</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMessengerOSIntegration)</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMessengerOSIntegration)</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIFolderListener)</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozINewMailListener)</span>
<a href="#l19.162"></a><span id="l19.162"> NS_INTERFACE_MAP_END</span>
<a href="#l19.163"></a><span id="l19.163"> </span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-nsresult</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-nsMessengerOSXIntegration::Init()</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-{</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+nsresult nsMessengerOSXIntegration::Init() {</span>
<a href="#l19.169"></a><span id="l19.169">   nsresult rv;</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+      do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.173"></a><span id="l19.173">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.174"></a><span id="l19.174">   return observerService-&gt;AddObserver(this, &quot;mail-startup-done&quot;, false);</span>
<a href="#l19.175"></a><span id="l19.175"> }</span>
<a href="#l19.176"></a><span id="l19.176"> </span>
<a href="#l19.177"></a><span id="l19.177"> NS_IMETHODIMP</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-nsMessengerOSXIntegration::OnItemPropertyChanged(nsIMsgFolder *, const nsACString &amp;, char const *, char const *)</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-{</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+nsMessengerOSXIntegration::OnItemPropertyChanged(nsIMsgFolder *, const nsACString &amp;, char const *,</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+                                                 char const *) {</span>
<a href="#l19.182"></a><span id="l19.182">   return NS_OK;</span>
<a href="#l19.183"></a><span id="l19.183"> }</span>
<a href="#l19.184"></a><span id="l19.184"> </span>
<a href="#l19.185"></a><span id="l19.185"> NS_IMETHODIMP</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-nsMessengerOSXIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *, const nsACString &amp;, const char16_t *, const char16_t *)</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-{</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-}</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-nsMessengerOSXIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *)</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-{</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+nsMessengerOSXIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *, const nsACString &amp;,</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+                                                        const char16_t *, const char16_t *) {</span>
<a href="#l19.196"></a><span id="l19.196">   return NS_OK;</span>
<a href="#l19.197"></a><span id="l19.197"> }</span>
<a href="#l19.198"></a><span id="l19.198"> </span>
<a href="#l19.199"></a><span id="l19.199"> NS_IMETHODIMP</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-nsMessengerOSXIntegration::Observe(nsISupports* aSubject, const char* aTopic, const char16_t* aData)</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-{</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-  if (!strcmp(aTopic, &quot;alertfinished&quot;))</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-    return OnAlertFinished();</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+nsMessengerOSXIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *) { return NS_OK; }</span>
<a href="#l19.205"></a><span id="l19.205"> </span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-  if (!strcmp(aTopic, &quot;alertclickcallback&quot;))</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-    return OnAlertClicked(aData);</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+nsMessengerOSXIntegration::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+                                   const char16_t *aData) {</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+  if (!strcmp(aTopic, &quot;alertfinished&quot;)) return OnAlertFinished();</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+  if (!strcmp(aTopic, &quot;alertclickcallback&quot;)) return OnAlertClicked(aData);</span>
<a href="#l19.214"></a><span id="l19.214"> </span>
<a href="#l19.215"></a><span id="l19.215"> #ifdef MOZ_SUITE</span>
<a href="#l19.216"></a><span id="l19.216">   // SeaMonkey does most of the GUI work in JS code when clicking on a mail</span>
<a href="#l19.217"></a><span id="l19.217">   // notification, so it needs an extra function here</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-  if (!strcmp(aTopic, &quot;alertclicksimplecallback&quot;))</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-    return OnAlertClickedSimple();</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+  if (!strcmp(aTopic, &quot;alertclicksimplecallback&quot;)) return OnAlertClickedSimple();</span>
<a href="#l19.221"></a><span id="l19.221"> #endif</span>
<a href="#l19.222"></a><span id="l19.222"> </span>
<a href="#l19.223"></a><span id="l19.223">   if (!strcmp(aTopic, &quot;mail-startup-done&quot;)) {</span>
<a href="#l19.224"></a><span id="l19.224">     nsresult rv;</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+        do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.228"></a><span id="l19.228">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.229"></a><span id="l19.229">       observerService-&gt;RemoveObserver(this, &quot;mail-startup-done&quot;);</span>
<a href="#l19.230"></a><span id="l19.230"> </span>
<a href="#l19.231"></a><span id="l19.231">       bool chatEnabled = false;</span>
<a href="#l19.232"></a><span id="l19.232">       nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-        rv = pref-&gt;GetBoolPref(kChatEnabledPref, &amp;chatEnabled);</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = pref-&gt;GetBoolPref(kChatEnabledPref, &amp;chatEnabled);</span>
<a href="#l19.236"></a><span id="l19.236">       if (NS_SUCCEEDED(rv) &amp;&amp; chatEnabled) {</span>
<a href="#l19.237"></a><span id="l19.237">         observerService-&gt;AddObserver(this, kNewChatMessageTopic, false);</span>
<a href="#l19.238"></a><span id="l19.238">         observerService-&gt;AddObserver(this, kUnreadImCountChangedTopic, false);</span>
<a href="#l19.239"></a><span id="l19.239">       }</span>
<a href="#l19.240"></a><span id="l19.240">     }</span>
<a href="#l19.241"></a><span id="l19.241"> </span>
<a href="#l19.242"></a><span id="l19.242">     // Register with the new mail service for changes to the unread message count</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-    nsCOMPtr&lt;mozINewMailNotificationService&gt; newmail</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-      = do_GetService(MOZ_NEWMAILNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv); // This should really be an assert with a helpful message</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineplus">+    nsCOMPtr&lt;mozINewMailNotificationService&gt; newmail =</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineplus">+        do_GetService(MOZ_NEWMAILNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);  // This should really be an assert with a helpful message</span>
<a href="#l19.249"></a><span id="l19.249">     rv = newmail-&gt;AddListener(this, mozINewMailNotificationService::count);</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv); // This should really be an assert with a helpful message</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);  // This should really be an assert with a helpful message</span>
<a href="#l19.252"></a><span id="l19.252"> </span>
<a href="#l19.253"></a><span id="l19.253">     // Get the initial unread count. Ignore return value; if code above didn't fail, this won't</span>
<a href="#l19.254"></a><span id="l19.254">     rv = newmail-&gt;GetMessageCount(&amp;mUnreadTotal);</span>
<a href="#l19.255"></a><span id="l19.255">     BadgeDockIcon();</span>
<a href="#l19.256"></a><span id="l19.256"> </span>
<a href="#l19.257"></a><span id="l19.257">     // register with the mail sesson for folder events</span>
<a href="#l19.258"></a><span id="l19.258">     // we care about new count, biff status</span>
<a href="#l19.259"></a><span id="l19.259">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l19.260"></a><span id="l19.260">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.261"></a><span id="l19.261"> </span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-    return mailSession-&gt;AddFolderListener(this, nsIFolderListener::boolPropertyChanged | nsIFolderListener::intPropertyChanged);</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+    return mailSession-&gt;AddFolderListener(</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+        this, nsIFolderListener::boolPropertyChanged | nsIFolderListener::intPropertyChanged);</span>
<a href="#l19.265"></a><span id="l19.265">   }</span>
<a href="#l19.266"></a><span id="l19.266"> </span>
<a href="#l19.267"></a><span id="l19.267">   if (!strcmp(aTopic, kNewChatMessageTopic)) {</span>
<a href="#l19.268"></a><span id="l19.268">     // We don't have to bother about checking if the window is already focused</span>
<a href="#l19.269"></a><span id="l19.269">     // before attempting to bounce the dock icon, as BounceDockIcon is</span>
<a href="#l19.270"></a><span id="l19.270">     // implemented by a getAttention call which won't do anything if the window</span>
<a href="#l19.271"></a><span id="l19.271">     // requesting attention is already focused.</span>
<a href="#l19.272"></a><span id="l19.272">     return BounceDockIcon();</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineat">@@ -277,457 +247,358 @@ nsMessengerOSXIntegration::Observe(nsISu</span>
<a href="#l19.274"></a><span id="l19.274">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.275"></a><span id="l19.275"> </span>
<a href="#l19.276"></a><span id="l19.276">     return BadgeDockIcon();</span>
<a href="#l19.277"></a><span id="l19.277">   }</span>
<a href="#l19.278"></a><span id="l19.278"> </span>
<a href="#l19.279"></a><span id="l19.279">   return NS_OK;</span>
<a href="#l19.280"></a><span id="l19.280"> }</span>
<a href="#l19.281"></a><span id="l19.281"> </span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-nsresult</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-nsMessengerOSXIntegration::GetStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-{</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+nsresult nsMessengerOSXIntegration::GetStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l19.286"></a><span id="l19.286">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l19.287"></a><span id="l19.287">   nsresult rv;</span>
<a href="#l19.288"></a><span id="l19.288">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l19.289"></a><span id="l19.289">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.290"></a><span id="l19.290">   if (bundleService &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-    bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineplus">+    bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+                                getter_AddRefs(bundle));</span>
<a href="#l19.294"></a><span id="l19.294">   bundle.forget(aBundle);</span>
<a href="#l19.295"></a><span id="l19.295">   return rv;</span>
<a href="#l19.296"></a><span id="l19.296"> }</span>
<a href="#l19.297"></a><span id="l19.297"> </span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-void</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-nsMessengerOSXIntegration::FillToolTipInfo(nsIMsgFolder *aFolder, int32_t aNewCount)</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-{</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-  if (aFolder)</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  {</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+void nsMessengerOSXIntegration::FillToolTipInfo(nsIMsgFolder *aFolder, int32_t aNewCount) {</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+  if (aFolder) {</span>
<a href="#l19.305"></a><span id="l19.305">     nsString authors;</span>
<a href="#l19.306"></a><span id="l19.306">     int32_t numNotDisplayed;</span>
<a href="#l19.307"></a><span id="l19.307">     nsresult rv = GetNewMailAuthors(aFolder, authors, aNewCount, &amp;numNotDisplayed);</span>
<a href="#l19.308"></a><span id="l19.308"> </span>
<a href="#l19.309"></a><span id="l19.309">     // If all senders are vetoed, the authors string will be empty.</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-    if (NS_FAILED(rv) || authors.IsEmpty())</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-      return;</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+    if (NS_FAILED(rv) || authors.IsEmpty()) return;</span>
<a href="#l19.313"></a><span id="l19.313"> </span>
<a href="#l19.314"></a><span id="l19.314">     // If this isn't the root folder, get it so we can report for it.</span>
<a href="#l19.315"></a><span id="l19.315">     // GetRootFolder always returns the server's root, so calling on the root itself is fine.</span>
<a href="#l19.316"></a><span id="l19.316">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.317"></a><span id="l19.317">     aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-    if (!rootFolder)</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-      return;</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    if (!rootFolder) return;</span>
<a href="#l19.321"></a><span id="l19.321"> </span>
<a href="#l19.322"></a><span id="l19.322">     nsString accountName;</span>
<a href="#l19.323"></a><span id="l19.323">     rootFolder-&gt;GetPrettyName(accountName);</span>
<a href="#l19.324"></a><span id="l19.324"> </span>
<a href="#l19.325"></a><span id="l19.325">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.326"></a><span id="l19.326">     GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-    if (bundle)</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-    {</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+    if (bundle) {</span>
<a href="#l19.330"></a><span id="l19.330">       nsAutoString numNewMsgsText;</span>
<a href="#l19.331"></a><span id="l19.331">       numNewMsgsText.AppendInt(aNewCount);</span>
<a href="#l19.332"></a><span id="l19.332">       nsString finalText;</span>
<a href="#l19.333"></a><span id="l19.333">       nsCString uri;</span>
<a href="#l19.334"></a><span id="l19.334">       aFolder-&gt;GetURI(uri);</span>
<a href="#l19.335"></a><span id="l19.335"> </span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-      if (numNotDisplayed &gt; 0)</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-      {</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+      if (numNotDisplayed &gt; 0) {</span>
<a href="#l19.339"></a><span id="l19.339">         nsAutoString numNotDisplayedText;</span>
<a href="#l19.340"></a><span id="l19.340">         numNotDisplayedText.AppendInt(numNotDisplayed);</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-        const char16_t *formatStrings[3] = { numNewMsgsText.get(), authors.get(), numNotDisplayedText.get() };</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-        bundle-&gt;FormatStringFromName(&quot;macBiffNotification_messages_extra&quot;,</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-                                     formatStrings,</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-                                     3,</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineplus">+        const char16_t *formatStrings[3] = {numNewMsgsText.get(), authors.get(),</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+                                            numNotDisplayedText.get()};</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;macBiffNotification_messages_extra&quot;, formatStrings, 3,</span>
<a href="#l19.348"></a><span id="l19.348">                                      finalText);</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineminus">-      }</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-      else</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-      {</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-        const char16_t *formatStrings[2] = { numNewMsgsText.get(), authors.get() };</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineplus">+      } else {</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+        const char16_t *formatStrings[2] = {numNewMsgsText.get(), authors.get()};</span>
<a href="#l19.355"></a><span id="l19.355"> </span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-        if (aNewCount == 1)</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineminus">-        {</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineminus">-          bundle-&gt;FormatStringFromName(&quot;macBiffNotification_message&quot;,</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineminus">-                                       formatStrings,</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-                                       2,</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-                                       finalText);</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineplus">+        if (aNewCount == 1) {</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+          bundle-&gt;FormatStringFromName(&quot;macBiffNotification_message&quot;, formatStrings, 2, finalText);</span>
<a href="#l19.364"></a><span id="l19.364">           // Since there is only 1 message, use the most recent mail's URI instead of the folder's</span>
<a href="#l19.365"></a><span id="l19.365">           nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l19.366"></a><span id="l19.366">           rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineminus">-          {</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l19.370"></a><span id="l19.370">             uint32_t numNewKeys;</span>
<a href="#l19.371"></a><span id="l19.371">             uint32_t *newMessageKeys;</span>
<a href="#l19.372"></a><span id="l19.372">             rv = db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-            {</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.376"></a><span id="l19.376">               nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-              rv = db-&gt;GetMsgHdrForKey(newMessageKeys[numNewKeys - 1],</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineminus">-                                       getter_AddRefs(hdr));</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineminus">-              if (NS_SUCCEEDED(rv) &amp;&amp; hdr)</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineminus">-                aFolder-&gt;GetUriForMsg(hdr, uri);</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+              rv = db-&gt;GetMsgHdrForKey(newMessageKeys[numNewKeys - 1], getter_AddRefs(hdr));</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineplus">+              if (NS_SUCCEEDED(rv) &amp;&amp; hdr) aFolder-&gt;GetUriForMsg(hdr, uri);</span>
<a href="#l19.383"></a><span id="l19.383">             }</span>
<a href="#l19.384"></a><span id="l19.384">             free(newMessageKeys);</span>
<a href="#l19.385"></a><span id="l19.385">           }</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineminus">-        }</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-        else</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineminus">-          bundle-&gt;FormatStringFromName(&quot;macBiffNotification_messages&quot;,</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-                                       formatStrings,</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-                                       2,</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineminus">-                                       finalText);</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+        } else</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+          bundle-&gt;FormatStringFromName(&quot;macBiffNotification_messages&quot;, formatStrings, 2, finalText);</span>
<a href="#l19.394"></a><span id="l19.394">       }</span>
<a href="#l19.395"></a><span id="l19.395">       ShowAlertMessage(accountName, finalText, uri);</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineminus">-    } // if we got a bundle</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-  } // if we got a folder</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+    }  // if we got a bundle</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineplus">+  }    // if we got a folder</span>
<a href="#l19.400"></a><span id="l19.400"> }</span>
<a href="#l19.401"></a><span id="l19.401"> </span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-nsresult</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-nsMessengerOSXIntegration::ShowAlertMessage(const nsAString&amp; aAlertTitle,</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-                                            const nsAString&amp; aAlertText,</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-                                            const nsACString&amp; aFolderURI)</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-{</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+nsresult nsMessengerOSXIntegration::ShowAlertMessage(const nsAString &amp;aAlertTitle,</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+                                                     const nsAString &amp;aAlertText,</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+                                                     const nsACString &amp;aFolderURI) {</span>
<a href="#l19.410"></a><span id="l19.410">   nsCOMPtr&lt;nsIAlertsService&gt; alertsService = mozilla::components::Alerts::Service();</span>
<a href="#l19.411"></a><span id="l19.411">   nsresult rv = alertsService ? NS_OK : NS_ERROR_UNEXPECTED;</span>
<a href="#l19.412"></a><span id="l19.412">   // If we have an nsIAlertsService implementation, use it:</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-  {</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-    alertsService-&gt;ShowAlertNotification(EmptyString(),</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-                                         aAlertTitle, aAlertText, true,</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineminus">-                                         NS_ConvertASCIItoUTF16(aFolderURI),</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineminus">-                                         this, EmptyString(),</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineminus">-                                         NS_LITERAL_STRING(&quot;auto&quot;),</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineminus">-                                         EmptyString(), EmptyString(),</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineminus">-                                         nullptr,</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineminus">-                                         false,</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineminus">-                                         false);</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineplus">+    alertsService-&gt;ShowAlertNotification(EmptyString(), aAlertTitle, aAlertText, true,</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineplus">+                                         NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineplus">+                                         NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(),</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineplus">+                                         nullptr, false, false);</span>
<a href="#l19.429"></a><span id="l19.429">   }</span>
<a href="#l19.430"></a><span id="l19.430"> </span>
<a href="#l19.431"></a><span id="l19.431">   BounceDockIcon();</span>
<a href="#l19.432"></a><span id="l19.432"> </span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-    OnAlertFinished();</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineplus">+  if (NS_FAILED(rv)) OnAlertFinished();</span>
<a href="#l19.436"></a><span id="l19.436"> </span>
<a href="#l19.437"></a><span id="l19.437">   return rv;</span>
<a href="#l19.438"></a><span id="l19.438"> }</span>
<a href="#l19.439"></a><span id="l19.439"> </span>
<a href="#l19.440"></a><span id="l19.440"> NS_IMETHODIMP</span>
<a href="#l19.441"></a><span id="l19.441"> nsMessengerOSXIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aFolder,</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineminus">-                                                    const nsACString &amp;aProperty,</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineminus">-                                                    int64_t aOldValue,</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineminus">-                                                    int64_t aNewValue)</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineminus">-{</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineplus">+                                                    const nsACString &amp;aProperty, int64_t aOldValue,</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+                                                    int64_t aNewValue) {</span>
<a href="#l19.448"></a><span id="l19.448">   // if we got new mail show an alert</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-  if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-  {</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineplus">+  if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l19.452"></a><span id="l19.452">     bool performingBiff = false;</span>
<a href="#l19.453"></a><span id="l19.453">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l19.454"></a><span id="l19.454">     aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-    if (server)</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineminus">-      server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-    if (!performingBiff)</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-      return NS_OK; // kick out right now...</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineplus">+    if (server) server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineplus">+    if (!performingBiff) return NS_OK;  // kick out right now...</span>
<a href="#l19.461"></a><span id="l19.461"> </span>
<a href="#l19.462"></a><span id="l19.462">     // Biff happens for the root folder, but we want info for the child with new mail</span>
<a href="#l19.463"></a><span id="l19.463">     nsCString folderUri;</span>
<a href="#l19.464"></a><span id="l19.464">     GetFirstFolderWithNewMail(aFolder, folderUri);</span>
<a href="#l19.465"></a><span id="l19.465">     nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineminus">-    nsresult rv = aFolder-&gt;GetChildWithURI(folderUri, true, true,</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineminus">-                                           getter_AddRefs(childFolder));</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineminus">-    if (NS_FAILED(rv) || !childFolder)</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineplus">+    nsresult rv = aFolder-&gt;GetChildWithURI(folderUri, true, true, getter_AddRefs(childFolder));</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineplus">+    if (NS_FAILED(rv) || !childFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.472"></a><span id="l19.472"> </span>
<a href="#l19.473"></a><span id="l19.473">     int32_t numNewMessages = 0;</span>
<a href="#l19.474"></a><span id="l19.474">     childFolder-&gt;GetNumNewMessages(true, &amp;numNewMessages);</span>
<a href="#l19.475"></a><span id="l19.475">     FillToolTipInfo(childFolder, numNewMessages);</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-  }</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineminus">-  else if (aProperty.Equals(kNewMailReceived))</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineminus">-  {</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineplus">+  } else if (aProperty.Equals(kNewMailReceived)) {</span>
<a href="#l19.480"></a><span id="l19.480">     FillToolTipInfo(aFolder, aNewValue);</span>
<a href="#l19.481"></a><span id="l19.481">   }</span>
<a href="#l19.482"></a><span id="l19.482">   return NS_OK;</span>
<a href="#l19.483"></a><span id="l19.483"> }</span>
<a href="#l19.484"></a><span id="l19.484"> </span>
<a href="#l19.485"></a><span id="l19.485" class="difflineminus">-nsresult</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineminus">-nsMessengerOSXIntegration::OnAlertClicked(const char16_t* aAlertCookie)</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineminus">-{</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+nsresult nsMessengerOSXIntegration::OnAlertClicked(const char16_t *aAlertCookie) {</span>
<a href="#l19.489"></a><span id="l19.489">   openMailWindow(NS_ConvertUTF16toUTF8(aAlertCookie));</span>
<a href="#l19.490"></a><span id="l19.490">   return NS_OK;</span>
<a href="#l19.491"></a><span id="l19.491"> }</span>
<a href="#l19.492"></a><span id="l19.492"> </span>
<a href="#l19.493"></a><span id="l19.493"> #ifdef MOZ_SUITE</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-nsresult</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineminus">-nsMessengerOSXIntegration::OnAlertClickedSimple()</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineminus">-{</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+nsresult nsMessengerOSXIntegration::OnAlertClickedSimple() {</span>
<a href="#l19.498"></a><span id="l19.498">   // SeaMonkey only function; only focus the app here, rest of the work will</span>
<a href="#l19.499"></a><span id="l19.499">   // be done in suite/mailnews/mailWidgets.xml</span>
<a href="#l19.500"></a><span id="l19.500">   FocusAppNative();</span>
<a href="#l19.501"></a><span id="l19.501">   return NS_OK;</span>
<a href="#l19.502"></a><span id="l19.502"> }</span>
<a href="#l19.503"></a><span id="l19.503"> #endif</span>
<a href="#l19.504"></a><span id="l19.504"> </span>
<a href="#l19.505"></a><span id="l19.505" class="difflineminus">-nsresult</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineminus">-nsMessengerOSXIntegration::OnAlertFinished()</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineminus">-{</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineminus">-}</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+nsresult nsMessengerOSXIntegration::OnAlertFinished() { return NS_OK; }</span>
<a href="#l19.511"></a><span id="l19.511"> </span>
<a href="#l19.512"></a><span id="l19.512" class="difflineminus">-nsresult</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineminus">-nsMessengerOSXIntegration::BounceDockIcon()</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineminus">-{</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+nsresult nsMessengerOSXIntegration::BounceDockIcon() {</span>
<a href="#l19.516"></a><span id="l19.516">   nsresult rv;</span>
<a href="#l19.517"></a><span id="l19.517">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.518"></a><span id="l19.518">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.519"></a><span id="l19.519"> </span>
<a href="#l19.520"></a><span id="l19.520">   bool bounceDockIcon = false;</span>
<a href="#l19.521"></a><span id="l19.521">   rv = prefBranch-&gt;GetBoolPref(kBiffAnimateDockIconPref, &amp;bounceDockIcon);</span>
<a href="#l19.522"></a><span id="l19.522">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.523"></a><span id="l19.523"> </span>
<a href="#l19.524"></a><span id="l19.524" class="difflineminus">-  if (!bounceDockIcon)</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+  if (!bounceDockIcon) return NS_OK;</span>
<a href="#l19.527"></a><span id="l19.527"> </span>
<a href="#l19.528"></a><span id="l19.528">   nsCOMPtr&lt;nsIWindowMediator&gt; mediator(do_GetService(NS_WINDOWMEDIATOR_CONTRACTID));</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineminus">-  if (mediator)</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineminus">-  {</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineplus">+  if (mediator) {</span>
<a href="#l19.532"></a><span id="l19.532">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l19.533"></a><span id="l19.533">     mediator-&gt;GetMostRecentWindow(u&quot;mail:3pane&quot;, getter_AddRefs(domWindow));</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineminus">-    if (domWindow)</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineminus">-    {</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineminus">-      nsPIDOMWindowOuter* outer = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineminus">-      nsPIDOMWindowInner* inner = outer-&gt;GetCurrentInnerWindow();</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineplus">+    if (domWindow) {</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineplus">+      nsPIDOMWindowOuter *outer = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+      nsPIDOMWindowInner *inner = outer-&gt;GetCurrentInnerWindow();</span>
<a href="#l19.541"></a><span id="l19.541">       if (inner) {</span>
<a href="#l19.542"></a><span id="l19.542">         mozilla::IgnoredErrorResult rv;</span>
<a href="#l19.543"></a><span id="l19.543">         nsGlobalWindowInner::Cast(inner)-&gt;GetAttention(rv);</span>
<a href="#l19.544"></a><span id="l19.544">       }</span>
<a href="#l19.545"></a><span id="l19.545">     }</span>
<a href="#l19.546"></a><span id="l19.546">   }</span>
<a href="#l19.547"></a><span id="l19.547">   return NS_OK;</span>
<a href="#l19.548"></a><span id="l19.548"> }</span>
<a href="#l19.549"></a><span id="l19.549"> </span>
<a href="#l19.550"></a><span id="l19.550" class="difflineminus">-nsresult</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineminus">-nsMessengerOSXIntegration::RestoreDockIcon()</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineminus">-{</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+nsresult nsMessengerOSXIntegration::RestoreDockIcon() {</span>
<a href="#l19.554"></a><span id="l19.554">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l19.555"></a><span id="l19.555"> </span>
<a href="#l19.556"></a><span id="l19.556">   id tile = [[NSApplication sharedApplication] dockTile];</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineminus">-  [tile setBadgeLabel: nil];</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineplus">+  [tile setBadgeLabel:nil];</span>
<a href="#l19.559"></a><span id="l19.559"> </span>
<a href="#l19.560"></a><span id="l19.560">   return NS_OK;</span>
<a href="#l19.561"></a><span id="l19.561"> </span>
<a href="#l19.562"></a><span id="l19.562">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l19.563"></a><span id="l19.563"> }</span>
<a href="#l19.564"></a><span id="l19.564"> </span>
<a href="#l19.565"></a><span id="l19.565" class="difflineminus">-nsresult</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineminus">-nsMessengerOSXIntegration::BadgeDockIcon()</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-{</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+nsresult nsMessengerOSXIntegration::BadgeDockIcon() {</span>
<a href="#l19.569"></a><span id="l19.569">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l19.570"></a><span id="l19.570"> </span>
<a href="#l19.571"></a><span id="l19.571">   int32_t unreadCount = mUnreadTotal + mUnreadChat;</span>
<a href="#l19.572"></a><span id="l19.572">   // If count is less than one, we should restore the original dock icon.</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineminus">-  if (unreadCount &lt; 1)</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineminus">-  {</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineplus">+  if (unreadCount &lt; 1) {</span>
<a href="#l19.576"></a><span id="l19.576">     RestoreDockIcon();</span>
<a href="#l19.577"></a><span id="l19.577">     return NS_OK;</span>
<a href="#l19.578"></a><span id="l19.578">   }</span>
<a href="#l19.579"></a><span id="l19.579"> </span>
<a href="#l19.580"></a><span id="l19.580">   // Draw the number, first giving extensions a chance to modify.</span>
<a href="#l19.581"></a><span id="l19.581">   // Extensions might wish to transform &quot;1000&quot; into &quot;100+&quot; or some</span>
<a href="#l19.582"></a><span id="l19.582">   // other short string. Getting back the empty string will cause</span>
<a href="#l19.583"></a><span id="l19.583">   // nothing to be drawn and us to return early.</span>
<a href="#l19.584"></a><span id="l19.584">   nsresult rv;</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; os</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineminus">-    (do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv));</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineminus">-  {</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; os(do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv));</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l19.591"></a><span id="l19.591">     RestoreDockIcon();</span>
<a href="#l19.592"></a><span id="l19.592">     return rv;</span>
<a href="#l19.593"></a><span id="l19.593">   }</span>
<a href="#l19.594"></a><span id="l19.594"> </span>
<a href="#l19.595"></a><span id="l19.595" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt; str</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineminus">-    (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineminus">-  {</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; str(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l19.601"></a><span id="l19.601">     RestoreDockIcon();</span>
<a href="#l19.602"></a><span id="l19.602">     return rv;</span>
<a href="#l19.603"></a><span id="l19.603">   }</span>
<a href="#l19.604"></a><span id="l19.604"> </span>
<a href="#l19.605"></a><span id="l19.605">   nsAutoString total;</span>
<a href="#l19.606"></a><span id="l19.606">   total.AppendInt(unreadCount);</span>
<a href="#l19.607"></a><span id="l19.607">   str-&gt;SetData(total);</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineminus">-  os-&gt;NotifyObservers(str, &quot;before-unread-count-display&quot;,</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineminus">-                      total.get());</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+  os-&gt;NotifyObservers(str, &quot;before-unread-count-display&quot;, total.get());</span>
<a href="#l19.611"></a><span id="l19.611">   nsAutoString badgeString;</span>
<a href="#l19.612"></a><span id="l19.612">   str-&gt;GetData(badgeString);</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineminus">-  if (badgeString.IsEmpty())</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineminus">-  {</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+  if (badgeString.IsEmpty()) {</span>
<a href="#l19.616"></a><span id="l19.616">     RestoreDockIcon();</span>
<a href="#l19.617"></a><span id="l19.617">     return NS_OK;</span>
<a href="#l19.618"></a><span id="l19.618">   }</span>
<a href="#l19.619"></a><span id="l19.619"> </span>
<a href="#l19.620"></a><span id="l19.620">   id tile = [[NSApplication sharedApplication] dockTile];</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineminus">-  [tile setBadgeLabel:[NSString stringWithFormat:@&quot;%S&quot;, (const unichar*)badgeString.get()]];</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+  [tile setBadgeLabel:[NSString stringWithFormat:@&quot;%S&quot;, (const unichar *)badgeString.get()]];</span>
<a href="#l19.623"></a><span id="l19.623">   return NS_OK;</span>
<a href="#l19.624"></a><span id="l19.624"> </span>
<a href="#l19.625"></a><span id="l19.625">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l19.626"></a><span id="l19.626"> }</span>
<a href="#l19.627"></a><span id="l19.627"> </span>
<a href="#l19.628"></a><span id="l19.628"> NS_IMETHODIMP</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-nsMessengerOSXIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-{</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineminus">-}</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineminus">-</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineminus">-nsMessengerOSXIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *)</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineminus">-{</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+nsMessengerOSXIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property,</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+                                                     uint32_t oldFlag, uint32_t newFlag) {</span>
<a href="#l19.639"></a><span id="l19.639">   return NS_OK;</span>
<a href="#l19.640"></a><span id="l19.640"> }</span>
<a href="#l19.641"></a><span id="l19.641"> </span>
<a href="#l19.642"></a><span id="l19.642"> NS_IMETHODIMP</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineplus">+nsMessengerOSXIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *) { return NS_OK; }</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineplus">+</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l19.646"></a><span id="l19.646"> nsMessengerOSXIntegration::OnItemBoolPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineminus">-                                                     const nsACString &amp;aProperty,</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineminus">-                                                     bool aOldValue,</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineminus">-                                                     bool aNewValue)</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineminus">-{</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+                                                     const nsACString &amp;aProperty, bool aOldValue,</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+                                                     bool aNewValue) {</span>
<a href="#l19.653"></a><span id="l19.653">   return NS_OK;</span>
<a href="#l19.654"></a><span id="l19.654"> }</span>
<a href="#l19.655"></a><span id="l19.655"> </span>
<a href="#l19.656"></a><span id="l19.656"> NS_IMETHODIMP</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineminus">-nsMessengerOSXIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;)</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineminus">-{</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineminus">-}</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+nsMessengerOSXIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;) { return NS_OK; }</span>
<a href="#l19.662"></a><span id="l19.662"> </span>
<a href="#l19.663"></a><span id="l19.663" class="difflineminus">-nsresult</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineminus">-nsMessengerOSXIntegration::GetNewMailAuthors(nsIMsgFolder* aFolder,</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineminus">-                                             nsString&amp; aAuthors,</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineminus">-                                             int32_t aNewCount,</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineminus">-                                             int32_t* aNotDisplayed)</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineminus">-{</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineplus">+nsresult nsMessengerOSXIntegration::GetNewMailAuthors(nsIMsgFolder *aFolder, nsString &amp;aAuthors,</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+                                                      int32_t aNewCount, int32_t *aNotDisplayed) {</span>
<a href="#l19.671"></a><span id="l19.671">   // Get a list of names or email addresses for the folder's authors</span>
<a href="#l19.672"></a><span id="l19.672">   // with new mail. Note that we only process the most recent &quot;new&quot;</span>
<a href="#l19.673"></a><span id="l19.673">   // mail (aNewCount), working from most recently added. Duplicates</span>
<a href="#l19.674"></a><span id="l19.674">   // are removed, and names are displayed to a set limit</span>
<a href="#l19.675"></a><span id="l19.675">   // (kMaxDisplayCount) with the remaining count being returned in</span>
<a href="#l19.676"></a><span id="l19.676">   // aNotDisplayed. Extension developers can listen for</span>
<a href="#l19.677"></a><span id="l19.677">   // &quot;newmail-notification-requested&quot; and then make a decision about</span>
<a href="#l19.678"></a><span id="l19.678">   // including a given author or not. As a result, it is possible that</span>
<a href="#l19.679"></a><span id="l19.679">   // the resulting length of aAuthors will be 0.</span>
<a href="#l19.680"></a><span id="l19.680">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l19.681"></a><span id="l19.681">   nsresult rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l19.682"></a><span id="l19.682">   uint32_t numNewKeys = 0;</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineminus">-  {</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; os =</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineminus">-      do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; os = do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l19.689"></a><span id="l19.689">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.690"></a><span id="l19.690"> </span>
<a href="#l19.691"></a><span id="l19.691">     // Get proper l10n list separator -- &quot;, &quot; in English</span>
<a href="#l19.692"></a><span id="l19.692">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.693"></a><span id="l19.693">     GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineminus">-    if (!bundle)</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+    if (!bundle) return NS_ERROR_FAILURE;</span>
<a href="#l19.697"></a><span id="l19.697"> </span>
<a href="#l19.698"></a><span id="l19.698">     uint32_t *newMessageKeys;</span>
<a href="#l19.699"></a><span id="l19.699">     rv = db-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineminus">-    {</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.703"></a><span id="l19.703">       nsString listSeparator;</span>
<a href="#l19.704"></a><span id="l19.704">       bundle-&gt;GetStringFromName(&quot;macBiffNotification_separator&quot;, listSeparator);</span>
<a href="#l19.705"></a><span id="l19.705"> </span>
<a href="#l19.706"></a><span id="l19.706">       int32_t displayed = 0;</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineminus">-      for (int32_t i = numNewKeys - 1; i &gt;= 0; i--, aNewCount--)</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineminus">-      {</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineminus">-        if (0 == aNewCount || displayed == kMaxDisplayCount)</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineminus">-          break;</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+      for (int32_t i = numNewKeys - 1; i &gt;= 0; i--, aNewCount--) {</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+        if (0 == aNewCount || displayed == kMaxDisplayCount) break;</span>
<a href="#l19.713"></a><span id="l19.713"> </span>
<a href="#l19.714"></a><span id="l19.714">         nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineminus">-        rv = db-&gt;GetMsgHdrForKey(newMessageKeys[i],</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineminus">-                                 getter_AddRefs(hdr));</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; hdr)</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineminus">-        {</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineplus">+        rv = db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr));</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; hdr) {</span>
<a href="#l19.721"></a><span id="l19.721">           nsString author;</span>
<a href="#l19.722"></a><span id="l19.722">           rv = hdr-&gt;GetMime2DecodedAuthor(author);</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineminus">-            continue;</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineplus">+          if (NS_FAILED(rv)) continue;</span>
<a href="#l19.726"></a><span id="l19.726"> </span>
<a href="#l19.727"></a><span id="l19.727">           nsString name;</span>
<a href="#l19.728"></a><span id="l19.728">           ExtractName(DecodedHeader(author), name);</span>
<a href="#l19.729"></a><span id="l19.729"> </span>
<a href="#l19.730"></a><span id="l19.730">           // Give extensions a chance to suppress notifications for this author</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineminus">-          nsCOMPtr&lt;nsISupportsPRBool&gt; notify =</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineminus">-            do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID);</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+          nsCOMPtr&lt;nsISupportsPRBool&gt; notify = do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID);</span>
<a href="#l19.734"></a><span id="l19.734"> </span>
<a href="#l19.735"></a><span id="l19.735">           notify-&gt;SetData(true);</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineminus">-          os-&gt;NotifyObservers(notify, &quot;newmail-notification-requested&quot;,</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineminus">-                              author.get());</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineplus">+          os-&gt;NotifyObservers(notify, &quot;newmail-notification-requested&quot;, author.get());</span>
<a href="#l19.739"></a><span id="l19.739"> </span>
<a href="#l19.740"></a><span id="l19.740">           bool includeSender;</span>
<a href="#l19.741"></a><span id="l19.741">           notify-&gt;GetData(&amp;includeSender);</span>
<a href="#l19.742"></a><span id="l19.742"> </span>
<a href="#l19.743"></a><span id="l19.743">           // Don't add unwanted or duplicate names</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineminus">-          if (includeSender &amp;&amp; aAuthors.Find(name, true) == -1)</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineminus">-          {</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineminus">-            if (displayed &gt; 0)</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineminus">-              aAuthors.Append(listSeparator);</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineplus">+          if (includeSender &amp;&amp; aAuthors.Find(name, true) == -1) {</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+            if (displayed &gt; 0) aAuthors.Append(listSeparator);</span>
<a href="#l19.750"></a><span id="l19.750">             aAuthors.Append(name);</span>
<a href="#l19.751"></a><span id="l19.751">             displayed++;</span>
<a href="#l19.752"></a><span id="l19.752">           }</span>
<a href="#l19.753"></a><span id="l19.753">         }</span>
<a href="#l19.754"></a><span id="l19.754">       }</span>
<a href="#l19.755"></a><span id="l19.755">     }</span>
<a href="#l19.756"></a><span id="l19.756">     free(newMessageKeys);</span>
<a href="#l19.757"></a><span id="l19.757">   }</span>
<a href="#l19.758"></a><span id="l19.758">   *aNotDisplayed = aNewCount;</span>
<a href="#l19.759"></a><span id="l19.759">   return rv;</span>
<a href="#l19.760"></a><span id="l19.760"> }</span>
<a href="#l19.761"></a><span id="l19.761"> </span>
<a href="#l19.762"></a><span id="l19.762" class="difflineminus">-nsresult</span>
<a href="#l19.763"></a><span id="l19.763" class="difflineminus">-nsMessengerOSXIntegration::GetFirstFolderWithNewMail(nsIMsgFolder* aFolder, nsCString&amp; aFolderURI)</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineminus">-{</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineplus">+nsresult nsMessengerOSXIntegration::GetFirstFolderWithNewMail(nsIMsgFolder *aFolder,</span>
<a href="#l19.766"></a><span id="l19.766" class="difflineplus">+                                                              nsCString &amp;aFolderURI) {</span>
<a href="#l19.767"></a><span id="l19.767">   // Find the subfolder in aFolder with new mail and return the folderURI</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineminus">-  if (aFolder)</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineminus">-  {</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineplus">+  if (aFolder) {</span>
<a href="#l19.771"></a><span id="l19.771">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l19.772"></a><span id="l19.772">     // enumerate over the folders under this root folder till we find one with new mail....</span>
<a href="#l19.773"></a><span id="l19.773">     nsCOMPtr&lt;nsIArray&gt; allFolders;</span>
<a href="#l19.774"></a><span id="l19.774">     nsresult rv = aFolder-&gt;GetDescendants(getter_AddRefs(allFolders));</span>
<a href="#l19.775"></a><span id="l19.775">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.776"></a><span id="l19.776"> </span>
<a href="#l19.777"></a><span id="l19.777">     nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l19.778"></a><span id="l19.778">     rv = allFolders-&gt;Enumerate(getter_AddRefs(enumerator));</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineminus">-    {</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l19.782"></a><span id="l19.782">       nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l19.783"></a><span id="l19.783">       int32_t numNewMessages = 0;</span>
<a href="#l19.784"></a><span id="l19.784">       bool hasMore = false;</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineminus">-      while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineminus">-      {</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineplus">+      while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l19.788"></a><span id="l19.788">         rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineminus">-        {</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l19.792"></a><span id="l19.792">           msgFolder = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineminus">-          if (msgFolder)</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineminus">-          {</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineplus">+          if (msgFolder) {</span>
<a href="#l19.796"></a><span id="l19.796">             numNewMessages = 0;</span>
<a href="#l19.797"></a><span id="l19.797">             msgFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineminus">-            if (numNewMessages)</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineminus">-              break; // kick out of the while loop</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineplus">+            if (numNewMessages) break;  // kick out of the while loop</span>
<a href="#l19.801"></a><span id="l19.801">           }</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineminus">-        } // if we have a folder</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineminus">-      }  // if we have more potential folders to enumerate</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineminus">-    }  // if enumerator</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+        }  // if we have a folder</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineplus">+      }    // if we have more potential folders to enumerate</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineplus">+    }      // if enumerator</span>
<a href="#l19.808"></a><span id="l19.808"> </span>
<a href="#l19.809"></a><span id="l19.809" class="difflineminus">-    if (msgFolder)</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineminus">-      msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineplus">+    if (msgFolder) msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l19.812"></a><span id="l19.812">   }</span>
<a href="#l19.813"></a><span id="l19.813"> </span>
<a href="#l19.814"></a><span id="l19.814">   return NS_OK;</span>
<a href="#l19.815"></a><span id="l19.815"> }</span>
<a href="#l19.816"></a><span id="l19.816"> </span>
<a href="#l19.817"></a><span id="l19.817"> /*</span>
<a href="#l19.818"></a><span id="l19.818">  * Method implementations for mozINewMailListener</span>
<a href="#l19.819"></a><span id="l19.819">  */</span>
<a href="#l19.820"></a><span id="l19.820"> NS_IMETHODIMP</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-nsMessengerOSXIntegration::OnCountChanged(uint32_t count)</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineminus">-{</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineplus">+nsMessengerOSXIntegration::OnCountChanged(uint32_t count) {</span>
<a href="#l19.824"></a><span id="l19.824">   mUnreadTotal = count;</span>
<a href="#l19.825"></a><span id="l19.825">   BadgeDockIcon();</span>
<a href="#l19.826"></a><span id="l19.826">   return NS_OK;</span>
<a href="#l19.827"></a><span id="l19.827"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -52,439 +52,391 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> #define ALERT_CHROME_URL &quot;chrome://messenger/content/newmailalert.xul&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #define NEW_MAIL_ALERT_ICON &quot;chrome://messenger/skin/icons/new-mail-alert.png&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #define SHOW_ALERT_PREF &quot;mail.biff.show_alert&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #define SHOW_ALERT_PREVIEW_LENGTH &quot;mail.biff.alert.preview_length&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #define SHOW_ALERT_PREVIEW_LENGTH_DEFAULT 40</span>
<a href="#l20.11"></a><span id="l20.11"> #define SHOW_ALERT_PREVIEW &quot;mail.biff.alert.show_preview&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#define SHOW_ALERT_SENDER  &quot;mail.biff.alert.show_sender&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+#define SHOW_ALERT_SENDER &quot;mail.biff.alert.show_sender&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> #define SHOW_ALERT_SUBJECT &quot;mail.biff.alert.show_subject&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-#define SHOW_ALERT_SYSTEM  &quot;mail.biff.use_system_alert&quot;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+#define SHOW_ALERT_SYSTEM &quot;mail.biff.use_system_alert&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> using namespace mozilla::mailnews;</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-static void openMailWindow(const nsACString&amp; aFolderUri)</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-{</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+static void openMailWindow(const nsACString &amp;aFolderUri) {</span>
<a href="#l20.23"></a><span id="l20.23">   nsresult rv;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-    return;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31">   nsCOMPtr&lt;nsIMsgWindow&gt; topMostMsgWindow;</span>
<a href="#l20.32"></a><span id="l20.32">   rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMostMsgWindow));</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  if (topMostMsgWindow)</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  {</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-    if (!aFolderUri.IsEmpty())</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-    {</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  if (topMostMsgWindow) {</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+    if (!aFolderUri.IsEmpty()) {</span>
<a href="#l20.39"></a><span id="l20.39">       nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l20.40"></a><span id="l20.40">       topMostMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-      if (windowCommands)</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-        windowCommands-&gt;SelectFolder(aFolderUri);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+      if (windowCommands) windowCommands-&gt;SelectFolder(aFolderUri);</span>
<a href="#l20.44"></a><span id="l20.44">     }</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l20.47"></a><span id="l20.47">     topMostMsgWindow-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l20.48"></a><span id="l20.48">     if (domWindow) {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-      nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+      nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow =</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+          nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l20.52"></a><span id="l20.52">       privateWindow-&gt;Focus();</span>
<a href="#l20.53"></a><span id="l20.53">     }</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  }</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  else</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-  {</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  } else {</span>
<a href="#l20.58"></a><span id="l20.58">     // the user doesn't have a mail window open already so open one for them...</span>
<a href="#l20.59"></a><span id="l20.59">     nsCOMPtr&lt;nsIMessengerWindowService&gt; messengerWindowService =</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-      do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+        do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l20.62"></a><span id="l20.62">     // if we want to preselect the first account with new mail,</span>
<a href="#l20.63"></a><span id="l20.63">     // here is where we would try to generate a uri to pass in</span>
<a href="#l20.64"></a><span id="l20.64">     // (and add code to the messenger window service to make that work)</span>
<a href="#l20.65"></a><span id="l20.65">     if (messengerWindowService)</span>
<a href="#l20.66"></a><span id="l20.66">       messengerWindowService-&gt;OpenMessengerWindowWithUri(</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-                                &quot;mail:3pane&quot;, nsCString(aFolderUri).get(), nsMsgKey_None);</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+          &quot;mail:3pane&quot;, nsCString(aFolderUri).get(), nsMsgKey_None);</span>
<a href="#l20.69"></a><span id="l20.69">   }</span>
<a href="#l20.70"></a><span id="l20.70"> }</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-nsMessengerUnixIntegration::nsMessengerUnixIntegration()</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-{</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+nsMessengerUnixIntegration::nsMessengerUnixIntegration() {</span>
<a href="#l20.75"></a><span id="l20.75">   mAlertInProgress = false;</span>
<a href="#l20.76"></a><span id="l20.76">   mFoldersWithNewMail = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l20.77"></a><span id="l20.77"> }</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79"> NS_IMPL_ISUPPORTS(nsMessengerUnixIntegration, nsIFolderListener, nsIObserver,</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-                   nsIMessengerOSIntegration, nsIUrlListener)</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+                  nsIMessengerOSIntegration, nsIUrlListener)</span>
<a href="#l20.82"></a><span id="l20.82"> </span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-nsresult</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-nsMessengerUnixIntegration::Init()</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-{</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+nsresult nsMessengerUnixIntegration::Init() {</span>
<a href="#l20.87"></a><span id="l20.87">   nsresult rv;</span>
<a href="#l20.88"></a><span id="l20.88"> </span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-  return mailSession-&gt;AddFolderListener(this, nsIFolderListener::intPropertyChanged);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+  return mailSession-&gt;AddFolderListener(this,</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+                                        nsIFolderListener::intPropertyChanged);</span>
<a href="#l20.97"></a><span id="l20.97"> }</span>
<a href="#l20.98"></a><span id="l20.98"> </span>
<a href="#l20.99"></a><span id="l20.99"> NS_IMETHODIMP</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-nsMessengerUnixIntegration::OnItemPropertyChanged(nsIMsgFolder *, const nsACString &amp;, char const *, char const *)</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-{</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+nsMessengerUnixIntegration::OnItemPropertyChanged(nsIMsgFolder *,</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+                                                  const nsACString &amp;,</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+                                                  char const *, char const *) {</span>
<a href="#l20.105"></a><span id="l20.105">   return NS_OK;</span>
<a href="#l20.106"></a><span id="l20.106"> }</span>
<a href="#l20.107"></a><span id="l20.107"> </span>
<a href="#l20.108"></a><span id="l20.108"> NS_IMETHODIMP</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-nsMessengerUnixIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *, const nsACString &amp;, const char16_t *, const char16_t *)</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-{</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+nsMessengerUnixIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *,</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+                                                         const nsACString &amp;,</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+                                                         const char16_t *,</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+                                                         const char16_t *) {</span>
<a href="#l20.115"></a><span id="l20.115">   return NS_OK;</span>
<a href="#l20.116"></a><span id="l20.116"> }</span>
<a href="#l20.117"></a><span id="l20.117"> </span>
<a href="#l20.118"></a><span id="l20.118"> NS_IMETHODIMP</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-nsMessengerUnixIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *)</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-{</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+nsMessengerUnixIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *) {</span>
<a href="#l20.122"></a><span id="l20.122">   return NS_OK;</span>
<a href="#l20.123"></a><span id="l20.123"> }</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-nsresult nsMessengerUnixIntegration::GetStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-{</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+nsresult nsMessengerUnixIntegration::GetStringBundle(</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+    nsIStringBundle **aBundle) {</span>
<a href="#l20.129"></a><span id="l20.129">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l20.130"></a><span id="l20.130">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l20.133"></a><span id="l20.133">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l20.134"></a><span id="l20.134">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l20.135"></a><span id="l20.135">   bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l20.136"></a><span id="l20.136">                               getter_AddRefs(bundle));</span>
<a href="#l20.137"></a><span id="l20.137">   bundle.forget(aBundle);</span>
<a href="#l20.138"></a><span id="l20.138">   return NS_OK;</span>
<a href="#l20.139"></a><span id="l20.139"> }</span>
<a href="#l20.140"></a><span id="l20.140"> </span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-bool</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-nsMessengerUnixIntegration::BuildNotificationTitle(nsIMsgFolder *aFolder, nsIStringBundle *aBundle, nsString &amp;aTitle)</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-{</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+bool nsMessengerUnixIntegration::BuildNotificationTitle(</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+    nsIMsgFolder *aFolder, nsIStringBundle *aBundle, nsString &amp;aTitle) {</span>
<a href="#l20.146"></a><span id="l20.146">   nsString accountName;</span>
<a href="#l20.147"></a><span id="l20.147">   aFolder-&gt;GetPrettyName(accountName);</span>
<a href="#l20.148"></a><span id="l20.148"> </span>
<a href="#l20.149"></a><span id="l20.149">   int32_t numNewMessages = 0;</span>
<a href="#l20.150"></a><span id="l20.150">   aFolder-&gt;GetNumNewMessages(true, &amp;numNewMessages);</span>
<a href="#l20.151"></a><span id="l20.151"> </span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-  if (!numNewMessages)</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    return false;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+  if (!numNewMessages) return false;</span>
<a href="#l20.155"></a><span id="l20.155"> </span>
<a href="#l20.156"></a><span id="l20.156">   nsAutoString numNewMsgsText;</span>
<a href="#l20.157"></a><span id="l20.157">   numNewMsgsText.AppendInt(numNewMessages);</span>
<a href="#l20.158"></a><span id="l20.158"> </span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  const char16_t *formatStrings[] =</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-  {</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    accountName.get(), numNewMsgsText.get()</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  };</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  const char16_t *formatStrings[] = {accountName.get(), numNewMsgsText.get()};</span>
<a href="#l20.164"></a><span id="l20.164"> </span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-  aBundle-&gt;FormatStringFromName(numNewMessages == 1 ?</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-                                  &quot;newMailNotification_message&quot; :</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-                                  &quot;newMailNotification_messages&quot;,</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+  aBundle-&gt;FormatStringFromName(numNewMessages == 1</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+                                    ? &quot;newMailNotification_message&quot;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+                                    : &quot;newMailNotification_messages&quot;,</span>
<a href="#l20.171"></a><span id="l20.171">                                 formatStrings, 2, aTitle);</span>
<a href="#l20.172"></a><span id="l20.172">   return true;</span>
<a href="#l20.173"></a><span id="l20.173"> }</span>
<a href="#l20.174"></a><span id="l20.174"> </span>
<a href="#l20.175"></a><span id="l20.175"> /* This comparator lets us sort an nsCOMArray of nsIMsgDBHdr's by</span>
<a href="#l20.176"></a><span id="l20.176">  * their dateInSeconds attributes in ascending order.</span>
<a href="#l20.177"></a><span id="l20.177">  */</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-static int</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-nsMsgDbHdrTimestampComparator(nsIMsgDBHdr *aElement1,</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-                              nsIMsgDBHdr *aElement2,</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-                              void *aData)</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-{</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+static int nsMsgDbHdrTimestampComparator(nsIMsgDBHdr *aElement1,</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+                                         nsIMsgDBHdr *aElement2, void *aData) {</span>
<a href="#l20.185"></a><span id="l20.185">   uint32_t aElement1Timestamp;</span>
<a href="#l20.186"></a><span id="l20.186">   nsresult rv = aElement1-&gt;GetDateInSeconds(&amp;aElement1Timestamp);</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    return 0;</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+  if (NS_FAILED(rv)) return 0;</span>
<a href="#l20.190"></a><span id="l20.190"> </span>
<a href="#l20.191"></a><span id="l20.191">   uint32_t aElement2Timestamp;</span>
<a href="#l20.192"></a><span id="l20.192">   rv = aElement2-&gt;GetDateInSeconds(&amp;aElement2Timestamp);</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-    return 0;</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+  if (NS_FAILED(rv)) return 0;</span>
<a href="#l20.196"></a><span id="l20.196"> </span>
<a href="#l20.197"></a><span id="l20.197">   return aElement1Timestamp - aElement2Timestamp;</span>
<a href="#l20.198"></a><span id="l20.198"> }</span>
<a href="#l20.199"></a><span id="l20.199"> </span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-bool</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-nsMessengerUnixIntegration::BuildNotificationBody(nsIMsgDBHdr *aHdr,</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-                                                  nsIStringBundle *aBundle,</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-                                                  nsString &amp;aBody)</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-{</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+bool nsMessengerUnixIntegration::BuildNotificationBody(nsIMsgDBHdr *aHdr,</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+                                                       nsIStringBundle *aBundle,</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+                                                       nsString &amp;aBody) {</span>
<a href="#l20.209"></a><span id="l20.209">   nsAutoString alertBody;</span>
<a href="#l20.210"></a><span id="l20.210"> </span>
<a href="#l20.211"></a><span id="l20.211">   bool showPreview = true;</span>
<a href="#l20.212"></a><span id="l20.212">   bool showSubject = true;</span>
<a href="#l20.213"></a><span id="l20.213">   bool showSender = true;</span>
<a href="#l20.214"></a><span id="l20.214">   int32_t previewLength = SHOW_ALERT_PREVIEW_LENGTH_DEFAULT;</span>
<a href="#l20.215"></a><span id="l20.215"> </span>
<a href="#l20.216"></a><span id="l20.216">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-  if (!prefBranch)</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-    return false;</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+  if (!prefBranch) return false;</span>
<a href="#l20.220"></a><span id="l20.220"> </span>
<a href="#l20.221"></a><span id="l20.221">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREVIEW, &amp;showPreview);</span>
<a href="#l20.222"></a><span id="l20.222">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_SENDER, &amp;showSender);</span>
<a href="#l20.223"></a><span id="l20.223">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_SUBJECT, &amp;showSubject);</span>
<a href="#l20.224"></a><span id="l20.224">   prefBranch-&gt;GetIntPref(SHOW_ALERT_PREVIEW_LENGTH, &amp;previewLength);</span>
<a href="#l20.225"></a><span id="l20.225"> </span>
<a href="#l20.226"></a><span id="l20.226">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l20.227"></a><span id="l20.227">   aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l20.228"></a><span id="l20.228"> </span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-  if (!folder)</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-    return false;</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+  if (!folder) return false;</span>
<a href="#l20.232"></a><span id="l20.232"> </span>
<a href="#l20.233"></a><span id="l20.233">   nsCString msgURI;</span>
<a href="#l20.234"></a><span id="l20.234">   folder-&gt;GetUriForMsg(aHdr, msgURI);</span>
<a href="#l20.235"></a><span id="l20.235"> </span>
<a href="#l20.236"></a><span id="l20.236">   bool localOnly;</span>
<a href="#l20.237"></a><span id="l20.237"> </span>
<a href="#l20.238"></a><span id="l20.238">   size_t msgURIIndex = mFetchingURIs.IndexOf(msgURI);</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-  if (msgURIIndex == mFetchingURIs.NoIndex)</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-  {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+  if (msgURIIndex == mFetchingURIs.NoIndex) {</span>
<a href="#l20.242"></a><span id="l20.242">     localOnly = false;</span>
<a href="#l20.243"></a><span id="l20.243">     mFetchingURIs.AppendElement(msgURI);</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-  }</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-  else</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+  } else</span>
<a href="#l20.247"></a><span id="l20.247">     localOnly = true;</span>
<a href="#l20.248"></a><span id="l20.248"> </span>
<a href="#l20.249"></a><span id="l20.249">   nsMsgKey messageKey;</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  if (NS_FAILED(aHdr-&gt;GetMessageKey(&amp;messageKey)))</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-    return false;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+  if (NS_FAILED(aHdr-&gt;GetMessageKey(&amp;messageKey))) return false;</span>
<a href="#l20.253"></a><span id="l20.253"> </span>
<a href="#l20.254"></a><span id="l20.254">   bool asyncResult = false;</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-  nsresult rv = folder-&gt;FetchMsgPreviewText(&amp;messageKey, 1,</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-                                            localOnly, this,</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+  nsresult rv = folder-&gt;FetchMsgPreviewText(&amp;messageKey, 1, localOnly, this,</span>
<a href="#l20.258"></a><span id="l20.258">                                             &amp;asyncResult);</span>
<a href="#l20.259"></a><span id="l20.259">   // If we're still waiting on getting the message previews,</span>
<a href="#l20.260"></a><span id="l20.260">   // bail early.  We'll come back later when the async operation</span>
<a href="#l20.261"></a><span id="l20.261">   // finishes.</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  if (NS_FAILED(rv) || asyncResult)</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-    return false;</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+  if (NS_FAILED(rv) || asyncResult) return false;</span>
<a href="#l20.265"></a><span id="l20.265"> </span>
<a href="#l20.266"></a><span id="l20.266">   // If we got here, that means that we've retrieved the message preview,</span>
<a href="#l20.267"></a><span id="l20.267">   // so we can stop tracking it with our mFetchingURIs array.</span>
<a href="#l20.268"></a><span id="l20.268">   if (msgURIIndex != mFetchingURIs.NoIndex)</span>
<a href="#l20.269"></a><span id="l20.269">     mFetchingURIs.RemoveElementAt(msgURIIndex);</span>
<a href="#l20.270"></a><span id="l20.270"> </span>
<a href="#l20.271"></a><span id="l20.271">   nsCString utf8previewString;</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-  if (showPreview &amp;&amp;</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-      NS_FAILED(aHdr-&gt;GetStringProperty(&quot;preview&quot;, getter_Copies(utf8previewString))))</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+  if (showPreview &amp;&amp; NS_FAILED(aHdr-&gt;GetStringProperty(</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+                         &quot;preview&quot;, getter_Copies(utf8previewString))))</span>
<a href="#l20.276"></a><span id="l20.276">     return false;</span>
<a href="#l20.277"></a><span id="l20.277"> </span>
<a href="#l20.278"></a><span id="l20.278">   // need listener that mailbox is remote such as IMAP</span>
<a href="#l20.279"></a><span id="l20.279">   // to generate preview message</span>
<a href="#l20.280"></a><span id="l20.280">   nsString previewString;</span>
<a href="#l20.281"></a><span id="l20.281">   CopyUTF8toUTF16(utf8previewString, previewString);</span>
<a href="#l20.282"></a><span id="l20.282"> </span>
<a href="#l20.283"></a><span id="l20.283">   nsString subject;</span>
<a href="#l20.284"></a><span id="l20.284">   if (showSubject &amp;&amp; NS_FAILED(aHdr-&gt;GetMime2DecodedSubject(subject)))</span>
<a href="#l20.285"></a><span id="l20.285">     return false;</span>
<a href="#l20.286"></a><span id="l20.286"> </span>
<a href="#l20.287"></a><span id="l20.287">   nsString author;</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-  if (showSender)</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-  {</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+  if (showSender) {</span>
<a href="#l20.291"></a><span id="l20.291">     nsString fullHeader;</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-    if (NS_FAILED(aHdr-&gt;GetMime2DecodedAuthor(fullHeader)))</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-      return false;</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+    if (NS_FAILED(aHdr-&gt;GetMime2DecodedAuthor(fullHeader))) return false;</span>
<a href="#l20.295"></a><span id="l20.295"> </span>
<a href="#l20.296"></a><span id="l20.296">     ExtractName(DecodedHeader(fullHeader), author);</span>
<a href="#l20.297"></a><span id="l20.297">   }</span>
<a href="#l20.298"></a><span id="l20.298"> </span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-  if (showSubject &amp;&amp; showSender)</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-  {</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+  if (showSubject &amp;&amp; showSender) {</span>
<a href="#l20.302"></a><span id="l20.302">     nsString msgTitle;</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-    const char16_t *formatStrings[] =</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-    {</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-      subject.get(), author.get()</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-    };</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+    const char16_t *formatStrings[] = {subject.get(), author.get()};</span>
<a href="#l20.308"></a><span id="l20.308">     aBundle-&gt;FormatStringFromName(&quot;newMailNotification_messagetitle&quot;,</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-        formatStrings, 2, msgTitle);</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+                                  formatStrings, 2, msgTitle);</span>
<a href="#l20.311"></a><span id="l20.311">     alertBody.Append(msgTitle);</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-  }</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-  else if (showSubject)</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineplus">+  } else if (showSubject)</span>
<a href="#l20.315"></a><span id="l20.315">     alertBody.Append(subject);</span>
<a href="#l20.316"></a><span id="l20.316">   else if (showSender)</span>
<a href="#l20.317"></a><span id="l20.317">     alertBody.Append(author);</span>
<a href="#l20.318"></a><span id="l20.318"> </span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-  if (showPreview &amp;&amp; (showSubject || showSender))</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-  {</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineplus">+  if (showPreview &amp;&amp; (showSubject || showSender)) {</span>
<a href="#l20.322"></a><span id="l20.322">     alertBody.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l20.323"></a><span id="l20.323">   }</span>
<a href="#l20.324"></a><span id="l20.324"> </span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-  if (showPreview)</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-    alertBody.Append(StringHead(previewString, previewLength));</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineplus">+  if (showPreview) alertBody.Append(StringHead(previewString, previewLength));</span>
<a href="#l20.328"></a><span id="l20.328"> </span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-  if (alertBody.IsEmpty())</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-    return false;</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineplus">+  if (alertBody.IsEmpty()) return false;</span>
<a href="#l20.332"></a><span id="l20.332"> </span>
<a href="#l20.333"></a><span id="l20.333">   aBody.Assign(alertBody);</span>
<a href="#l20.334"></a><span id="l20.334">   return true;</span>
<a href="#l20.335"></a><span id="l20.335"> }</span>
<a href="#l20.336"></a><span id="l20.336"> </span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-nsresult nsMessengerUnixIntegration::ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI)</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-{</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+nsresult nsMessengerUnixIntegration::ShowAlertMessage(</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+    const nsAString &amp;aAlertTitle, const nsAString &amp;aAlertText,</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+    const nsACString &amp;aFolderURI) {</span>
<a href="#l20.342"></a><span id="l20.342">   nsresult rv;</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineminus">-  // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-  if (mAlertInProgress)</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineplus">+  // if we are already in the process of showing an alert, don't try to show</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+  // another....</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineplus">+  if (mAlertInProgress) return NS_OK;</span>
<a href="#l20.349"></a><span id="l20.349"> </span>
<a href="#l20.350"></a><span id="l20.350">   mAlertInProgress = true;</span>
<a href="#l20.351"></a><span id="l20.351"> </span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.355"></a><span id="l20.355">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.356"></a><span id="l20.356"> </span>
<a href="#l20.357"></a><span id="l20.357">   // determine if we should use libnotify or the built-in alert system</span>
<a href="#l20.358"></a><span id="l20.358">   bool useSystemAlert = true;</span>
<a href="#l20.359"></a><span id="l20.359">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_SYSTEM, &amp;useSystemAlert);</span>
<a href="#l20.360"></a><span id="l20.360"> </span>
<a href="#l20.361"></a><span id="l20.361">   if (useSystemAlert) {</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-    nsCOMPtr&lt;nsIAlertsService&gt; alertsService(do_GetService(NS_SYSTEMALERTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+    nsCOMPtr&lt;nsIAlertsService&gt; alertsService(</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineplus">+        do_GetService(NS_SYSTEMALERTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.365"></a><span id="l20.365">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-      rv = alertsService-&gt;ShowAlertNotification(NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON),</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-                                                aAlertTitle,</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-                                                aAlertText,</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-                                                false,</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-                                                NS_ConvertASCIItoUTF16(aFolderURI),</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-                                                this,</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-                                                EmptyString(),</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineminus">-                                                NS_LITERAL_STRING(&quot;auto&quot;),</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-                                                EmptyString(),</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-                                                EmptyString(),</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-                                                nullptr,</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-                                                false,</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-                                                false);</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-        return rv;</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+      rv = alertsService-&gt;ShowAlertNotification(</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+          NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle, aAlertText,</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+          false, NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+          NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(), nullptr,</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+          false, false);</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+      if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l20.387"></a><span id="l20.387">     }</span>
<a href="#l20.388"></a><span id="l20.388">   }</span>
<a href="#l20.389"></a><span id="l20.389">   AlertFinished();</span>
<a href="#l20.390"></a><span id="l20.390">   rv = ShowNewAlertNotification(false);</span>
<a href="#l20.391"></a><span id="l20.391"> </span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-  if (NS_FAILED(rv)) // go straight to showing the system tray icon.</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+  if (NS_FAILED(rv))  // go straight to showing the system tray icon.</span>
<a href="#l20.394"></a><span id="l20.394">     AlertFinished();</span>
<a href="#l20.395"></a><span id="l20.395"> </span>
<a href="#l20.396"></a><span id="l20.396">   return rv;</span>
<a href="#l20.397"></a><span id="l20.397"> }</span>
<a href="#l20.398"></a><span id="l20.398"> </span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-// Opening Thunderbird's new mail alert notification window for not supporting libnotify</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-// aUserInitiated --&gt; true if we are opening the alert notification in response to a user action</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+// Opening Thunderbird's new mail alert notification window for not supporting</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+// libnotify aUserInitiated --&gt; true if we are opening the alert notification in</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineplus">+// response to a user action</span>
<a href="#l20.404"></a><span id="l20.404"> //                    like clicking on the biff icon</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-nsresult nsMessengerUnixIntegration::ShowNewAlertNotification(bool aUserInitiated)</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineminus">-{</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineminus">-</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+nsresult nsMessengerUnixIntegration::ShowNewAlertNotification(</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+    bool aUserInitiated) {</span>
<a href="#l20.410"></a><span id="l20.410">   nsresult rv;</span>
<a href="#l20.411"></a><span id="l20.411"> </span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-  // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-  if (mAlertInProgress)</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineplus">+  // if we are already in the process of showing an alert, don't try to show</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineplus">+  // another....</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineplus">+  if (mAlertInProgress) return NS_OK;</span>
<a href="#l20.418"></a><span id="l20.418"> </span>
<a href="#l20.419"></a><span id="l20.419">   nsCOMPtr&lt;nsIMutableArray&gt; argsArray = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-  if (!argsArray)</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineplus">+  if (!argsArray) return NS_ERROR_FAILURE;</span>
<a href="#l20.423"></a><span id="l20.423"> </span>
<a href="#l20.424"></a><span id="l20.424">   // pass in the array of folders with unread messages</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-  nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineplus">+  nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l20.428"></a><span id="l20.428">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.429"></a><span id="l20.429">   ifptr-&gt;SetData(mFoldersWithNewMail);</span>
<a href="#l20.430"></a><span id="l20.430">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIArray));</span>
<a href="#l20.431"></a><span id="l20.431">   argsArray-&gt;AppendElement(ifptr);</span>
<a href="#l20.432"></a><span id="l20.432"> </span>
<a href="#l20.433"></a><span id="l20.433">   // pass in the observer</span>
<a href="#l20.434"></a><span id="l20.434">   ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l20.435"></a><span id="l20.435">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMessengerOSIntegration*&gt;(this));</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIMessengerOSIntegration *&gt;(this));</span>
<a href="#l20.439"></a><span id="l20.439">   ifptr-&gt;SetData(supports);</span>
<a href="#l20.440"></a><span id="l20.440">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIObserver));</span>
<a href="#l20.441"></a><span id="l20.441">   argsArray-&gt;AppendElement(ifptr);</span>
<a href="#l20.442"></a><span id="l20.442"> </span>
<a href="#l20.443"></a><span id="l20.443">   // pass in the animation flag</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-  nsCOMPtr&lt;nsISupportsPRBool&gt; scriptableUserInitiated (do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv));</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+  nsCOMPtr&lt;nsISupportsPRBool&gt; scriptableUserInitiated(</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv));</span>
<a href="#l20.447"></a><span id="l20.447">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.448"></a><span id="l20.448">   scriptableUserInitiated-&gt;SetData(aUserInitiated);</span>
<a href="#l20.449"></a><span id="l20.449">   argsArray-&gt;AppendElement(scriptableUserInitiated);</span>
<a href="#l20.450"></a><span id="l20.450"> </span>
<a href="#l20.451"></a><span id="l20.451">   nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l20.452"></a><span id="l20.452">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l20.453"></a><span id="l20.453"> </span>
<a href="#l20.454"></a><span id="l20.454">   mAlertInProgress = true;</span>
<a href="#l20.455"></a><span id="l20.455">   rv = wwatch-&gt;OpenWindow(0, ALERT_CHROME_URL, &quot;_blank&quot;,</span>
<a href="#l20.456"></a><span id="l20.456">                           &quot;chrome,dialog=yes,titlebar=no,popup=yes&quot;, argsArray,</span>
<a href="#l20.457"></a><span id="l20.457">                           getter_AddRefs(newWindow));</span>
<a href="#l20.458"></a><span id="l20.458"> </span>
<a href="#l20.459"></a><span id="l20.459" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineminus">-    AlertFinished();</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+  if (NS_FAILED(rv)) AlertFinished();</span>
<a href="#l20.462"></a><span id="l20.462"> </span>
<a href="#l20.463"></a><span id="l20.463">   return rv;</span>
<a href="#l20.464"></a><span id="l20.464"> }</span>
<a href="#l20.465"></a><span id="l20.465"> </span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-nsresult nsMessengerUnixIntegration::AlertFinished()</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-{</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineplus">+nsresult nsMessengerUnixIntegration::AlertFinished() {</span>
<a href="#l20.469"></a><span id="l20.469">   mAlertInProgress = false;</span>
<a href="#l20.470"></a><span id="l20.470">   return NS_OK;</span>
<a href="#l20.471"></a><span id="l20.471"> }</span>
<a href="#l20.472"></a><span id="l20.472"> </span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-nsresult nsMessengerUnixIntegration::AlertClicked()</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineminus">-{</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+nsresult nsMessengerUnixIntegration::AlertClicked() {</span>
<a href="#l20.476"></a><span id="l20.476">   nsCString folderURI;</span>
<a href="#l20.477"></a><span id="l20.477">   GetFirstFolderWithNewMail(folderURI);</span>
<a href="#l20.478"></a><span id="l20.478">   openMailWindow(folderURI);</span>
<a href="#l20.479"></a><span id="l20.479">   return NS_OK;</span>
<a href="#l20.480"></a><span id="l20.480"> }</span>
<a href="#l20.481"></a><span id="l20.481"> </span>
<a href="#l20.482"></a><span id="l20.482"> NS_IMETHODIMP</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineminus">-nsMessengerUnixIntegration::Observe(nsISupports* aSubject, const char* aTopic, const char16_t* aData)</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-{</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-  if (strcmp(aTopic, &quot;alertfinished&quot;) == 0)</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineminus">-    return AlertFinished();</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineminus">-  if (strcmp(aTopic, &quot;alertclickcallback&quot;) == 0)</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineminus">-    return AlertClicked();</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineplus">+nsMessengerUnixIntegration::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+                                    const char16_t *aData) {</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineplus">+  if (strcmp(aTopic, &quot;alertfinished&quot;) == 0) return AlertFinished();</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineplus">+  if (strcmp(aTopic, &quot;alertclickcallback&quot;) == 0) return AlertClicked();</span>
<a href="#l20.493"></a><span id="l20.493"> </span>
<a href="#l20.494"></a><span id="l20.494">   return NS_OK;</span>
<a href="#l20.495"></a><span id="l20.495"> }</span>
<a href="#l20.496"></a><span id="l20.496"> </span>
<a href="#l20.497"></a><span id="l20.497" class="difflineminus">-void nsMessengerUnixIntegration::FillToolTipInfo()</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineminus">-{</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineplus">+void nsMessengerUnixIntegration::FillToolTipInfo() {</span>
<a href="#l20.500"></a><span id="l20.500">   nsresult rv;</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,);</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l20.506"></a><span id="l20.506"> </span>
<a href="#l20.507"></a><span id="l20.507">   bool showAlert = true;</span>
<a href="#l20.508"></a><span id="l20.508">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineminus">-  if (!showAlert)</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineminus">-    return;</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineplus">+  if (!showAlert) return;</span>
<a href="#l20.512"></a><span id="l20.512"> </span>
<a href="#l20.513"></a><span id="l20.513">   nsCString folderUri;</span>
<a href="#l20.514"></a><span id="l20.514">   GetFirstFolderWithNewMail(folderUri);</span>
<a href="#l20.515"></a><span id="l20.515"> </span>
<a href="#l20.516"></a><span id="l20.516">   uint32_t count = 0;</span>
<a href="#l20.517"></a><span id="l20.517">   NS_ENSURE_SUCCESS_VOID(mFoldersWithNewMail-&gt;GetLength(&amp;count));</span>
<a href="#l20.518"></a><span id="l20.518"> </span>
<a href="#l20.519"></a><span id="l20.519">   nsWeakPtr weakReference;</span>
<a href="#l20.520"></a><span id="l20.520">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = nullptr;</span>
<a href="#l20.521"></a><span id="l20.521">   nsCOMPtr&lt;nsIMsgFolder&gt; folderWithNewMail = nullptr;</span>
<a href="#l20.522"></a><span id="l20.522"> </span>
<a href="#l20.523"></a><span id="l20.523">   uint32_t i;</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineminus">-  for (i = 0; i &lt; count &amp;&amp; !folderWithNewMail; i++)</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineminus">-  {</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineplus">+  for (i = 0; i &lt; count &amp;&amp; !folderWithNewMail; i++) {</span>
<a href="#l20.527"></a><span id="l20.527">     weakReference = do_QueryElementAt(mFoldersWithNewMail, i);</span>
<a href="#l20.528"></a><span id="l20.528">     folder = do_QueryReferent(weakReference);</span>
<a href="#l20.529"></a><span id="l20.529">     folder-&gt;GetChildWithURI(folderUri, true, true,</span>
<a href="#l20.530"></a><span id="l20.530">                             getter_AddRefs(folderWithNewMail));</span>
<a href="#l20.531"></a><span id="l20.531">   }</span>
<a href="#l20.532"></a><span id="l20.532"> </span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-  if (folder &amp;&amp; folderWithNewMail)</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-  {</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineplus">+  if (folder &amp;&amp; folderWithNewMail) {</span>
<a href="#l20.536"></a><span id="l20.536">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l20.537"></a><span id="l20.537">     GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l20.538"></a><span id="l20.538"> </span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-    if (!bundle)</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-      return;</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineplus">+    if (!bundle) return;</span>
<a href="#l20.542"></a><span id="l20.542"> </span>
<a href="#l20.543"></a><span id="l20.543">     // Create the notification title</span>
<a href="#l20.544"></a><span id="l20.544">     nsString alertTitle;</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-    if (!BuildNotificationTitle(folder, bundle, alertTitle))</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-      return;</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineplus">+    if (!BuildNotificationTitle(folder, bundle, alertTitle)) return;</span>
<a href="#l20.548"></a><span id="l20.548"> </span>
<a href="#l20.549"></a><span id="l20.549">     // Let's get the new mail for this folder</span>
<a href="#l20.550"></a><span id="l20.550">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l20.551"></a><span id="l20.551">     if (NS_FAILED(folderWithNewMail-&gt;GetMsgDatabase(getter_AddRefs(db))))</span>
<a href="#l20.552"></a><span id="l20.552">       return;</span>
<a href="#l20.553"></a><span id="l20.553"> </span>
<a href="#l20.554"></a><span id="l20.554">     uint32_t numNewKeys = 0;</span>
<a href="#l20.555"></a><span id="l20.555">     uint32_t *newMessageKeys;</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineat">@@ -503,259 +455,229 @@ void nsMessengerUnixIntegration::FillToo</span>
<a href="#l20.557"></a><span id="l20.557">     if (NS_FAILED(GetMRUTimestampForFolder(folder, &amp;lastMRUTime)))</span>
<a href="#l20.558"></a><span id="l20.558">       lastMRUTime = 0;</span>
<a href="#l20.559"></a><span id="l20.559"> </span>
<a href="#l20.560"></a><span id="l20.560">     // Next, add the new message headers to an nsCOMArray.  We</span>
<a href="#l20.561"></a><span id="l20.561">     // only add message headers that are newer than lastMRUTime.</span>
<a href="#l20.562"></a><span id="l20.562">     nsCOMArray&lt;nsIMsgDBHdr&gt; newMsgHdrs;</span>
<a href="#l20.563"></a><span id="l20.563">     for (unsigned int i = 0; i &lt; numNewKeys; ++i) {</span>
<a href="#l20.564"></a><span id="l20.564">       nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineminus">-      if (NS_FAILED(db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr))))</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineplus">+      if (NS_FAILED(</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineplus">+              db-&gt;GetMsgHdrForKey(newMessageKeys[i], getter_AddRefs(hdr))))</span>
<a href="#l20.568"></a><span id="l20.568">         continue;</span>
<a href="#l20.569"></a><span id="l20.569"> </span>
<a href="#l20.570"></a><span id="l20.570">       uint32_t dateInSeconds = 0;</span>
<a href="#l20.571"></a><span id="l20.571">       hdr-&gt;GetDateInSeconds(&amp;dateInSeconds);</span>
<a href="#l20.572"></a><span id="l20.572"> </span>
<a href="#l20.573"></a><span id="l20.573" class="difflineminus">-      if (dateInSeconds &gt; lastMRUTime)</span>
<a href="#l20.574"></a><span id="l20.574" class="difflineminus">-        newMsgHdrs.AppendObject(hdr);</span>
<a href="#l20.575"></a><span id="l20.575" class="difflineminus">-</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineplus">+      if (dateInSeconds &gt; lastMRUTime) newMsgHdrs.AppendObject(hdr);</span>
<a href="#l20.577"></a><span id="l20.577">     }</span>
<a href="#l20.578"></a><span id="l20.578"> </span>
<a href="#l20.579"></a><span id="l20.579">     // At this point, we don't need newMessageKeys any more,</span>
<a href="#l20.580"></a><span id="l20.580">     // so let's free it.</span>
<a href="#l20.581"></a><span id="l20.581">     free(newMessageKeys);</span>
<a href="#l20.582"></a><span id="l20.582"> </span>
<a href="#l20.583"></a><span id="l20.583">     // If we didn't happen to add any message headers, bail out</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-    if (!newMsgHdrs.Count())</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-      return;</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineplus">+    if (!newMsgHdrs.Count()) return;</span>
<a href="#l20.587"></a><span id="l20.587"> </span>
<a href="#l20.588"></a><span id="l20.588">     // Sort the message headers by dateInSeconds, in ascending</span>
<a href="#l20.589"></a><span id="l20.589">     // order</span>
<a href="#l20.590"></a><span id="l20.590">     newMsgHdrs.Sort(nsMsgDbHdrTimestampComparator, nullptr);</span>
<a href="#l20.591"></a><span id="l20.591"> </span>
<a href="#l20.592"></a><span id="l20.592">     nsString alertBody;</span>
<a href="#l20.593"></a><span id="l20.593"> </span>
<a href="#l20.594"></a><span id="l20.594">     // Build the body text of the notification.</span>
<a href="#l20.595"></a><span id="l20.595" class="difflineminus">-    if (!BuildNotificationBody(newMsgHdrs[0], bundle, alertBody))</span>
<a href="#l20.596"></a><span id="l20.596" class="difflineminus">-      return;</span>
<a href="#l20.597"></a><span id="l20.597" class="difflineplus">+    if (!BuildNotificationBody(newMsgHdrs[0], bundle, alertBody)) return;</span>
<a href="#l20.598"></a><span id="l20.598"> </span>
<a href="#l20.599"></a><span id="l20.599">     // Show the notification</span>
<a href="#l20.600"></a><span id="l20.600">     ShowAlertMessage(alertTitle, alertBody, EmptyCString());</span>
<a href="#l20.601"></a><span id="l20.601"> </span>
<a href="#l20.602"></a><span id="l20.602">     // Find the last, and therefore newest message header</span>
<a href="#l20.603"></a><span id="l20.603">     // in our nsCOMArray</span>
<a href="#l20.604"></a><span id="l20.604">     nsCOMPtr&lt;nsIMsgDBHdr&gt; lastMsgHdr = newMsgHdrs[newMsgHdrs.Count() - 1];</span>
<a href="#l20.605"></a><span id="l20.605"> </span>
<a href="#l20.606"></a><span id="l20.606">     uint32_t dateInSeconds = 0;</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-    if (NS_FAILED(lastMsgHdr-&gt;GetDateInSeconds(&amp;dateInSeconds)))</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineminus">-      return;</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineplus">+    if (NS_FAILED(lastMsgHdr-&gt;GetDateInSeconds(&amp;dateInSeconds))) return;</span>
<a href="#l20.610"></a><span id="l20.610"> </span>
<a href="#l20.611"></a><span id="l20.611">     // Write the newest message timestamp to the appropriate</span>
<a href="#l20.612"></a><span id="l20.612">     // mapping in our hashtable of MRUTime's.</span>
<a href="#l20.613"></a><span id="l20.613">     PutMRUTimestampForFolder(folder, dateInSeconds);</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineminus">-  } // if we got a folder</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineplus">+  }  // if we got a folder</span>
<a href="#l20.616"></a><span id="l20.616"> }</span>
<a href="#l20.617"></a><span id="l20.617"> </span>
<a href="#l20.618"></a><span id="l20.618" class="difflineminus">-// Get the first top level folder which we know has new mail, then enumerate over</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineminus">-// all the subfolders looking for the first real folder with new mail.</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineplus">+// Get the first top level folder which we know has new mail, then enumerate</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineplus">+// over all the subfolders looking for the first real folder with new mail.</span>
<a href="#l20.622"></a><span id="l20.622"> // Return the folderURI for that folder.</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineminus">-nsresult nsMessengerUnixIntegration::GetFirstFolderWithNewMail(nsACString&amp; aFolderURI)</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineminus">-{</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineplus">+nsresult nsMessengerUnixIntegration::GetFirstFolderWithNewMail(</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineplus">+    nsACString &amp;aFolderURI) {</span>
<a href="#l20.627"></a><span id="l20.627">   NS_ENSURE_TRUE(mFoldersWithNewMail, NS_ERROR_FAILURE);</span>
<a href="#l20.628"></a><span id="l20.628"> </span>
<a href="#l20.629"></a><span id="l20.629">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l20.630"></a><span id="l20.630">   nsWeakPtr weakReference;</span>
<a href="#l20.631"></a><span id="l20.631"> </span>
<a href="#l20.632"></a><span id="l20.632">   uint32_t count = 0;</span>
<a href="#l20.633"></a><span id="l20.633">   nsresult rv = mFoldersWithNewMail-&gt;GetLength(&amp;count);</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineminus">-  if (NS_FAILED(rv) || !count)  // kick out if we don't have any folders with new mail</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineplus">+  if (NS_FAILED(rv) ||</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineplus">+      !count)  // kick out if we don't have any folders with new mail</span>
<a href="#l20.637"></a><span id="l20.637">     return NS_OK;</span>
<a href="#l20.638"></a><span id="l20.638"> </span>
<a href="#l20.639"></a><span id="l20.639">   uint32_t i;</span>
<a href="#l20.640"></a><span id="l20.640" class="difflineminus">-  for(i = 0; i &lt; count; i++)</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineminus">-  {</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l20.643"></a><span id="l20.643">     weakReference = do_QueryElementAt(mFoldersWithNewMail, i);</span>
<a href="#l20.644"></a><span id="l20.644">     folder = do_QueryReferent(weakReference);</span>
<a href="#l20.645"></a><span id="l20.645"> </span>
<a href="#l20.646"></a><span id="l20.646">     // We only want to find folders which haven't been notified</span>
<a href="#l20.647"></a><span id="l20.647">     // yet.  This is specific to Thunderbird.  In Seamonkey, we</span>
<a href="#l20.648"></a><span id="l20.648">     // just return 0, and we don't care about timestamps anymore.</span>
<a href="#l20.649"></a><span id="l20.649">     uint32_t lastMRUTime = 0;</span>
<a href="#l20.650"></a><span id="l20.650">     rv = GetMRUTimestampForFolder(folder, &amp;lastMRUTime);</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineminus">-      lastMRUTime = 0;</span>
<a href="#l20.653"></a><span id="l20.653" class="difflineplus">+    if (NS_FAILED(rv)) lastMRUTime = 0;</span>
<a href="#l20.654"></a><span id="l20.654"> </span>
<a href="#l20.655"></a><span id="l20.655" class="difflineminus">-    if (!folder)</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineminus">-      continue;</span>
<a href="#l20.657"></a><span id="l20.657" class="difflineminus">-    // enumerate over the folders under this root folder till we find one with new mail....</span>
<a href="#l20.658"></a><span id="l20.658" class="difflineplus">+    if (!folder) continue;</span>
<a href="#l20.659"></a><span id="l20.659" class="difflineplus">+    // enumerate over the folders under this root folder till we find one with</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineplus">+    // new mail....</span>
<a href="#l20.661"></a><span id="l20.661">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l20.662"></a><span id="l20.662">     nsCOMPtr&lt;nsIArray&gt; allFolders;</span>
<a href="#l20.663"></a><span id="l20.663">     rv = folder-&gt;GetDescendants(getter_AddRefs(allFolders));</span>
<a href="#l20.664"></a><span id="l20.664">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.665"></a><span id="l20.665"> </span>
<a href="#l20.666"></a><span id="l20.666">     uint32_t subfolderCount = 0;</span>
<a href="#l20.667"></a><span id="l20.667">     allFolders-&gt;GetLength(&amp;subfolderCount);</span>
<a href="#l20.668"></a><span id="l20.668">     uint32_t j;</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineminus">-    for (j = 0; j &lt; subfolderCount; j++)</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineminus">-    {</span>
<a href="#l20.671"></a><span id="l20.671" class="difflineplus">+    for (j = 0; j &lt; subfolderCount; j++) {</span>
<a href="#l20.672"></a><span id="l20.672">       nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryElementAt(allFolders, j);</span>
<a href="#l20.673"></a><span id="l20.673"> </span>
<a href="#l20.674"></a><span id="l20.674" class="difflineminus">-      if (!msgFolder)</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineminus">-        continue;</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineplus">+      if (!msgFolder) continue;</span>
<a href="#l20.677"></a><span id="l20.677"> </span>
<a href="#l20.678"></a><span id="l20.678">       uint32_t flags;</span>
<a href="#l20.679"></a><span id="l20.679">       rv = msgFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l20.680"></a><span id="l20.680"> </span>
<a href="#l20.681"></a><span id="l20.681" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l20.682"></a><span id="l20.682" class="difflineminus">-        continue;</span>
<a href="#l20.683"></a><span id="l20.683" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l20.684"></a><span id="l20.684"> </span>
<a href="#l20.685"></a><span id="l20.685">       bool notify =</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineminus">-        // Any folder which is an inbox or ...</span>
<a href="#l20.687"></a><span id="l20.687" class="difflineminus">-        flags &amp; nsMsgFolderFlags::Inbox ||</span>
<a href="#l20.688"></a><span id="l20.688" class="difflineminus">-        // any non-special or non-virtual folder. In other words, we don't</span>
<a href="#l20.689"></a><span id="l20.689" class="difflineminus">-        // notify for Drafts|Trash|SentMail|Templates|Junk|Archive|Queue or virtual.</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineminus">-        !(flags &amp; (nsMsgFolderFlags::SpecialUse | nsMsgFolderFlags::Virtual));</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineplus">+          // Any folder which is an inbox or ...</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineplus">+          flags &amp; nsMsgFolderFlags::Inbox ||</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineplus">+          // any non-special or non-virtual folder. In other words, we don't</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineplus">+          // notify for Drafts|Trash|SentMail|Templates|Junk|Archive|Queue or</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineplus">+          // virtual.</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineplus">+          !(flags &amp; (nsMsgFolderFlags::SpecialUse | nsMsgFolderFlags::Virtual));</span>
<a href="#l20.697"></a><span id="l20.697"> </span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-      if (!notify)</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-        continue;</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineplus">+      if (!notify) continue;</span>
<a href="#l20.701"></a><span id="l20.701"> </span>
<a href="#l20.702"></a><span id="l20.702">       nsCString folderURI;</span>
<a href="#l20.703"></a><span id="l20.703">       msgFolder-&gt;GetURI(folderURI);</span>
<a href="#l20.704"></a><span id="l20.704">       bool hasNew = false;</span>
<a href="#l20.705"></a><span id="l20.705">       rv = msgFolder-&gt;GetHasNewMessages(&amp;hasNew);</span>
<a href="#l20.706"></a><span id="l20.706"> </span>
<a href="#l20.707"></a><span id="l20.707" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l20.708"></a><span id="l20.708" class="difflineminus">-        continue;</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l20.710"></a><span id="l20.710"> </span>
<a href="#l20.711"></a><span id="l20.711">       // Grab the MRUTime property from the folder</span>
<a href="#l20.712"></a><span id="l20.712">       nsCString dateStr;</span>
<a href="#l20.713"></a><span id="l20.713">       msgFolder-&gt;GetStringProperty(MRU_TIME_PROPERTY, dateStr);</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineminus">-      uint32_t MRUTime = (uint32_t) dateStr.ToInteger(&amp;rv, 10);</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineminus">-        MRUTime = 0;</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineplus">+      uint32_t MRUTime = (uint32_t)dateStr.ToInteger(&amp;rv, 10);</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineplus">+      if (NS_FAILED(rv)) MRUTime = 0;</span>
<a href="#l20.719"></a><span id="l20.719"> </span>
<a href="#l20.720"></a><span id="l20.720" class="difflineminus">-      if (hasNew &amp;&amp; MRUTime &gt; lastMRUTime)</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineminus">-      {</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineplus">+      if (hasNew &amp;&amp; MRUTime &gt; lastMRUTime) {</span>
<a href="#l20.723"></a><span id="l20.723">         rv = msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l20.724"></a><span id="l20.724">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.725"></a><span id="l20.725">         return NS_OK;</span>
<a href="#l20.726"></a><span id="l20.726">       }</span>
<a href="#l20.727"></a><span id="l20.727">     }  // if we have more potential folders to enumerate</span>
<a href="#l20.728"></a><span id="l20.728">   }</span>
<a href="#l20.729"></a><span id="l20.729"> </span>
<a href="#l20.730"></a><span id="l20.730">   // If we got here, then something when pretty wrong.</span>
<a href="#l20.731"></a><span id="l20.731">   return NS_ERROR_FAILURE;</span>
<a href="#l20.732"></a><span id="l20.732"> }</span>
<a href="#l20.733"></a><span id="l20.733"> </span>
<a href="#l20.734"></a><span id="l20.734"> NS_IMETHODIMP</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineminus">-nsMessengerUnixIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineminus">-{</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineplus">+nsMessengerUnixIntegration::OnItemPropertyFlagChanged(</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineplus">+    nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag,</span>
<a href="#l20.739"></a><span id="l20.739" class="difflineplus">+    uint32_t newFlag) {</span>
<a href="#l20.740"></a><span id="l20.740">   return NS_OK;</span>
<a href="#l20.741"></a><span id="l20.741"> }</span>
<a href="#l20.742"></a><span id="l20.742"> </span>
<a href="#l20.743"></a><span id="l20.743"> NS_IMETHODIMP</span>
<a href="#l20.744"></a><span id="l20.744" class="difflineminus">-nsMessengerUnixIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *)</span>
<a href="#l20.745"></a><span id="l20.745" class="difflineminus">-{</span>
<a href="#l20.746"></a><span id="l20.746" class="difflineplus">+nsMessengerUnixIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *) {</span>
<a href="#l20.747"></a><span id="l20.747">   return NS_OK;</span>
<a href="#l20.748"></a><span id="l20.748"> }</span>
<a href="#l20.749"></a><span id="l20.749"> </span>
<a href="#l20.750"></a><span id="l20.750"> NS_IMETHODIMP</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineminus">-nsMessengerUnixIntegration::OnItemBoolPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-                                                      const nsACString &amp;aProperty,</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-                                                      bool aOldValue,</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-                                                      bool aNewValue)</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineminus">-{</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineplus">+nsMessengerUnixIntegration::OnItemBoolPropertyChanged(</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineplus">+    nsIMsgFolder *aItem, const nsACString &amp;aProperty, bool aOldValue,</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineplus">+    bool aNewValue) {</span>
<a href="#l20.759"></a><span id="l20.759">   return NS_OK;</span>
<a href="#l20.760"></a><span id="l20.760"> }</span>
<a href="#l20.761"></a><span id="l20.761"> </span>
<a href="#l20.762"></a><span id="l20.762"> NS_IMETHODIMP</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineminus">-nsMessengerUnixIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;)</span>
<a href="#l20.764"></a><span id="l20.764" class="difflineminus">-{</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineplus">+nsMessengerUnixIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;) {</span>
<a href="#l20.766"></a><span id="l20.766">   return NS_OK;</span>
<a href="#l20.767"></a><span id="l20.767"> }</span>
<a href="#l20.768"></a><span id="l20.768"> </span>
<a href="#l20.769"></a><span id="l20.769"> NS_IMETHODIMP</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineminus">-nsMessengerUnixIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aItem, const nsACString &amp;aProperty, int64_t aOldValue, int64_t aNewValue)</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineminus">-{</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineplus">+nsMessengerUnixIntegration::OnItemIntPropertyChanged(</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineplus">+    nsIMsgFolder *aItem, const nsACString &amp;aProperty, int64_t aOldValue,</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineplus">+    int64_t aNewValue) {</span>
<a href="#l20.775"></a><span id="l20.775">   nsCString atomName;</span>
<a href="#l20.776"></a><span id="l20.776">   // if we got new mail show an icon in the system tray</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineminus">-  if (aProperty.Equals(kBiffState) &amp;&amp; mFoldersWithNewMail)</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineminus">-  {</span>
<a href="#l20.779"></a><span id="l20.779" class="difflineplus">+  if (aProperty.Equals(kBiffState) &amp;&amp; mFoldersWithNewMail) {</span>
<a href="#l20.780"></a><span id="l20.780">     nsWeakPtr weakFolder = do_GetWeakReference(aItem);</span>
<a href="#l20.781"></a><span id="l20.781">     uint32_t indexInNewArray;</span>
<a href="#l20.782"></a><span id="l20.782">     nsresult rv = mFoldersWithNewMail-&gt;IndexOf(0, weakFolder, &amp;indexInNewArray);</span>
<a href="#l20.783"></a><span id="l20.783">     bool folderFound = NS_SUCCEEDED(rv);</span>
<a href="#l20.784"></a><span id="l20.784"> </span>
<a href="#l20.785"></a><span id="l20.785" class="difflineminus">-    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineminus">-    {</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineplus">+    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l20.788"></a><span id="l20.788">       // only show a system tray icon iff we are performing biff</span>
<a href="#l20.789"></a><span id="l20.789">       // (as opposed to the user getting new mail)</span>
<a href="#l20.790"></a><span id="l20.790">       bool performingBiff = false;</span>
<a href="#l20.791"></a><span id="l20.791">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l20.792"></a><span id="l20.792">       aItem-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-      if (server)</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineminus">-        server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineminus">-      if (!performingBiff)</span>
<a href="#l20.796"></a><span id="l20.796" class="difflineminus">-        return NS_OK; // kick out right now...</span>
<a href="#l20.797"></a><span id="l20.797" class="difflineplus">+      if (server) server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineplus">+      if (!performingBiff) return NS_OK;  // kick out right now...</span>
<a href="#l20.799"></a><span id="l20.799"> </span>
<a href="#l20.800"></a><span id="l20.800" class="difflineminus">-      if (!folderFound)</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineminus">-        mFoldersWithNewMail-&gt;AppendElement(weakFolder);</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineplus">+      if (!folderFound) mFoldersWithNewMail-&gt;AppendElement(weakFolder);</span>
<a href="#l20.803"></a><span id="l20.803">       // now regenerate the tooltip</span>
<a href="#l20.804"></a><span id="l20.804">       FillToolTipInfo();</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineminus">-    }</span>
<a href="#l20.806"></a><span id="l20.806" class="difflineminus">-    else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail)</span>
<a href="#l20.807"></a><span id="l20.807" class="difflineminus">-    {</span>
<a href="#l20.808"></a><span id="l20.808" class="difflineplus">+    } else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail) {</span>
<a href="#l20.809"></a><span id="l20.809">       if (folderFound) {</span>
<a href="#l20.810"></a><span id="l20.810">         mFoldersWithNewMail-&gt;RemoveElementAt(indexInNewArray);</span>
<a href="#l20.811"></a><span id="l20.811">       }</span>
<a href="#l20.812"></a><span id="l20.812">     }</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineminus">-  } // if the biff property changed</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineminus">-  else if (aProperty.Equals(kNewMailReceived))</span>
<a href="#l20.815"></a><span id="l20.815" class="difflineminus">-  {</span>
<a href="#l20.816"></a><span id="l20.816" class="difflineplus">+  }  // if the biff property changed</span>
<a href="#l20.817"></a><span id="l20.817" class="difflineplus">+  else if (aProperty.Equals(kNewMailReceived)) {</span>
<a href="#l20.818"></a><span id="l20.818">     FillToolTipInfo();</span>
<a href="#l20.819"></a><span id="l20.819">   }</span>
<a href="#l20.820"></a><span id="l20.820"> </span>
<a href="#l20.821"></a><span id="l20.821">   return NS_OK;</span>
<a href="#l20.822"></a><span id="l20.822"> }</span>
<a href="#l20.823"></a><span id="l20.823"> </span>
<a href="#l20.824"></a><span id="l20.824"> NS_IMETHODIMP</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineminus">-nsMessengerUnixIntegration::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineminus">-{</span>
<a href="#l20.827"></a><span id="l20.827" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.828"></a><span id="l20.828" class="difflineminus">-}</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineplus">+nsMessengerUnixIntegration::OnStartRunningUrl(nsIURI *aUrl) { return NS_OK; }</span>
<a href="#l20.830"></a><span id="l20.830"> </span>
<a href="#l20.831"></a><span id="l20.831"> NS_IMETHODIMP</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineminus">-nsMessengerUnixIntegration::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineminus">-{</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineplus">+nsMessengerUnixIntegration::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l20.835"></a><span id="l20.835">   if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l20.836"></a><span id="l20.836">     // preview fetch is done.</span>
<a href="#l20.837"></a><span id="l20.837">     FillToolTipInfo();</span>
<a href="#l20.838"></a><span id="l20.838">   return NS_OK;</span>
<a href="#l20.839"></a><span id="l20.839"> }</span>
<a href="#l20.840"></a><span id="l20.840"> </span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-nsresult</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-nsMessengerUnixIntegration::GetMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineminus">-                                                     uint32_t *aLastMRUTime)</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineminus">-{</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineplus">+nsresult nsMessengerUnixIntegration::GetMRUTimestampForFolder(</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineplus">+    nsIMsgFolder *aFolder, uint32_t *aLastMRUTime) {</span>
<a href="#l20.847"></a><span id="l20.847">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder = nullptr;</span>
<a href="#l20.848"></a><span id="l20.848">   nsresult rv = aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l20.849"></a><span id="l20.849">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.850"></a><span id="l20.850"> </span>
<a href="#l20.851"></a><span id="l20.851">   nsCString rootFolderURI;</span>
<a href="#l20.852"></a><span id="l20.852">   rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineminus">-  if (!mLastMRUTimes.Get(rootFolderURI, aLastMRUTime))</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineminus">-    aLastMRUTime = 0;</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineplus">+  if (!mLastMRUTimes.Get(rootFolderURI, aLastMRUTime)) aLastMRUTime = 0;</span>
<a href="#l20.856"></a><span id="l20.856"> </span>
<a href="#l20.857"></a><span id="l20.857">   return NS_OK;</span>
<a href="#l20.858"></a><span id="l20.858"> }</span>
<a href="#l20.859"></a><span id="l20.859"> </span>
<a href="#l20.860"></a><span id="l20.860" class="difflineminus">-nsresult</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineminus">-nsMessengerUnixIntegration::PutMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineminus">-                                                     uint32_t aLastMRUTime)</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineminus">-{</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineplus">+nsresult nsMessengerUnixIntegration::PutMRUTimestampForFolder(</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineplus">+    nsIMsgFolder *aFolder, uint32_t aLastMRUTime) {</span>
<a href="#l20.866"></a><span id="l20.866">   nsresult rv;</span>
<a href="#l20.867"></a><span id="l20.867">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder = nullptr;</span>
<a href="#l20.868"></a><span id="l20.868">   rv = aFolder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l20.869"></a><span id="l20.869">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.870"></a><span id="l20.870"> </span>
<a href="#l20.871"></a><span id="l20.871">   nsCString rootFolderURI;</span>
<a href="#l20.872"></a><span id="l20.872">   rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l20.873"></a><span id="l20.873">   mLastMRUTimes.Put(rootFolderURI, aLastMRUTime);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerUnixIntegration.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerUnixIntegration.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -10,51 +10,63 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#define NS_MESSENGERUNIXINTEGRATION_CID \</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  {0xf62f3d3a, 0x1dd1, 0x11b2, \</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-    {0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c}}</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+#define NS_MESSENGERUNIXINTEGRATION_CID              \</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  {                                                  \</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    0xf62f3d3a, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+      0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c \</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+    }                                                \</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+  }</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22"> class nsIStringBundle;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24"> class nsMessengerUnixIntegration : public nsIFolderListener,</span>
<a href="#l21.25"></a><span id="l21.25">                                    public nsIObserver,</span>
<a href="#l21.26"></a><span id="l21.26">                                    public nsIUrlListener,</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-                                   public nsIMessengerOSIntegration</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-{</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-public:</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+                                   public nsIMessengerOSIntegration {</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ public:</span>
<a href="#l21.32"></a><span id="l21.32">   nsMessengerUnixIntegration();</span>
<a href="#l21.33"></a><span id="l21.33">   virtual nsresult Init();</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   NS_DECL_ISUPPORTS</span>
<a href="#l21.36"></a><span id="l21.36">   NS_DECL_NSIMESSENGEROSINTEGRATION</span>
<a href="#l21.37"></a><span id="l21.37">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l21.38"></a><span id="l21.38">   NS_DECL_NSIOBSERVER</span>
<a href="#l21.39"></a><span id="l21.39">   NS_DECL_NSIURLLISTENER</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-private:</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+ private:</span>
<a href="#l21.43"></a><span id="l21.43">   virtual ~nsMessengerUnixIntegration() {}</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  nsresult ShowAlertMessage(const nsAString&amp; aAlertTitle, const nsAString&amp; aAlertText, const nsACString&amp; aFolderURI);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-  nsresult GetFirstFolderWithNewMail(nsACString&amp; aFolderURI);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+  nsresult ShowAlertMessage(const nsAString &amp;aAlertTitle,</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+                            const nsAString &amp;aAlertText,</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+                            const nsACString &amp;aFolderURI);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+  nsresult GetFirstFolderWithNewMail(nsACString &amp;aFolderURI);</span>
<a href="#l21.50"></a><span id="l21.50">   nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l21.51"></a><span id="l21.51">   nsresult AlertFinished();</span>
<a href="#l21.52"></a><span id="l21.52">   nsresult AlertClicked();</span>
<a href="#l21.53"></a><span id="l21.53">   void FillToolTipInfo();</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  nsresult GetMRUTimestampForFolder(nsIMsgFolder *aFolder, uint32_t *aLastMRUTime);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+  nsresult GetMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+                                    uint32_t *aLastMRUTime);</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-  bool BuildNotificationBody(nsIMsgDBHdr *aHdr, nsIStringBundle *Bundle, nsString &amp;aBody);</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  bool BuildNotificationTitle(nsIMsgFolder *aFolder, nsIStringBundle *aBundle, nsString &amp;aTitle);</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  bool BuildNotificationBody(nsIMsgDBHdr *aHdr, nsIStringBundle *Bundle,</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+                             nsString &amp;aBody);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+  bool BuildNotificationTitle(nsIMsgFolder *aFolder, nsIStringBundle *aBundle,</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+                              nsString &amp;aTitle);</span>
<a href="#l21.64"></a><span id="l21.64">   nsresult ShowNewAlertNotification(bool aUserInitiated);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-  nsresult PutMRUTimestampForFolder(nsIMsgFolder *aFolder, uint32_t aLastMRUTime);</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+  nsresult PutMRUTimestampForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+                                    uint32_t aLastMRUTime);</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mFoldersWithNewMail;  // keep track of all the root folders with pending new mail</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+      mFoldersWithNewMail;  // keep track of all the root folders with pending</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+                            // new mail</span>
<a href="#l21.73"></a><span id="l21.73">   bool mAlertInProgress;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  nsDataHashtable&lt;nsCStringHashKey, uint32_t&gt; mLastMRUTimes; // We keep track of the last time we did a new mail notification for each account</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  nsDataHashtable&lt;nsCStringHashKey, uint32_t&gt;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+      mLastMRUTimes;  // We keep track of the last time we did a new mail</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+                      // notification for each account</span>
<a href="#l21.78"></a><span id="l21.78">   nsTArray&lt;nsCString&gt; mFetchingURIs;</span>
<a href="#l21.79"></a><span id="l21.79"> };</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-#endif // __nsMessengerUnixIntegration_h</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+#endif  // __nsMessengerUnixIntegration_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerWinIntegration.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerWinIntegration.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -49,949 +49,890 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;mozilla/Components.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &lt;stdlib.h&gt;</span>
<a href="#l22.9"></a><span id="l22.9"> #define PROFILE_COMMANDLINE_ARG u&quot; -profile &quot;</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> #define NOTIFICATIONCLASSNAME &quot;MailBiffNotificationMessageWindow&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#define UNREADMAILNODEKEY u&quot;Software\\Microsoft\\Windows\\CurrentVersion\\UnreadMail\\&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+#define UNREADMAILNODEKEY \</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+  u&quot;Software\\Microsoft\\Windows\\CurrentVersion\\UnreadMail\\&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #define DOUBLE_QUOTE '&quot;'</span>
<a href="#l22.16"></a><span id="l22.16"> #define MAIL_COMMANDLINE_ARG u&quot; -mail&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #define IDI_MAILBIFF 32576</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-#define UNREAD_UPDATE_INTERVAL  (20 * 1000)  // 20 seconds</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+#define UNREAD_UPDATE_INTERVAL (20 * 1000)  // 20 seconds</span>
<a href="#l22.20"></a><span id="l22.20"> #define ALERT_CHROME_URL &quot;chrome://messenger/content/newmailalert.xul&quot;</span>
<a href="#l22.21"></a><span id="l22.21"> #define NEW_MAIL_ALERT_ICON &quot;chrome://messenger/skin/icons/new-mail-alert.png&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-#define SHOW_ALERT_PREF     &quot;mail.biff.show_alert&quot;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+#define SHOW_ALERT_PREF &quot;mail.biff.show_alert&quot;</span>
<a href="#l22.24"></a><span id="l22.24"> #define SHOW_TRAY_ICON_PREF &quot;mail.biff.show_tray_icon&quot;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-#define SHOW_BALLOON_PREF   &quot;mail.biff.show_balloon&quot;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+#define SHOW_BALLOON_PREF &quot;mail.biff.show_balloon&quot;</span>
<a href="#l22.27"></a><span id="l22.27"> #define SHOW_NEW_ALERT_PREF &quot;mail.biff.show_new_alert&quot;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-#define ALERT_ORIGIN_PREF   &quot;ui.alertNotificationOrigin&quot;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+#define ALERT_ORIGIN_PREF &quot;ui.alertNotificationOrigin&quot;</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31"> // since we are including windows.h in this file, undefine get user name....</span>
<a href="#l22.32"></a><span id="l22.32"> #ifdef GetUserName</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-#undef GetUserName</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+#  undef GetUserName</span>
<a href="#l22.35"></a><span id="l22.35"> #endif</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37"> #ifndef NIIF_USER</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-#define NIIF_USER       0x00000004</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+#  define NIIF_USER 0x00000004</span>
<a href="#l22.40"></a><span id="l22.40"> #endif</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42"> #ifndef NIIF_NOSOUND</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-#define NIIF_NOSOUND    0x00000010</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+#  define NIIF_NOSOUND 0x00000010</span>
<a href="#l22.45"></a><span id="l22.45"> #endif</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47"> #ifndef NIN_BALOONUSERCLICK</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-#define NIN_BALLOONUSERCLICK (WM_USER + 5)</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+#  define NIN_BALLOONUSERCLICK (WM_USER + 5)</span>
<a href="#l22.50"></a><span id="l22.50"> #endif</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52"> using namespace mozilla;</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54"> // begin shameless copying from nsNativeAppSupportWin</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-HWND hwndForDOMWindow( mozIDOMWindowProxy *window )</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-{</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  if ( !window ) {</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+HWND hwndForDOMWindow(mozIDOMWindowProxy *window) {</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+  if (!window) {</span>
<a href="#l22.60"></a><span id="l22.60">     return 0;</span>
<a href="#l22.61"></a><span id="l22.61">   }</span>
<a href="#l22.62"></a><span id="l22.62">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; pidomwindow = nsPIDOMWindowOuter::From(window);</span>
<a href="#l22.63"></a><span id="l22.63"> </span>
<a href="#l22.64"></a><span id="l22.64">   nsCOMPtr&lt;nsIBaseWindow&gt; ppBaseWindow =</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-    do_QueryInterface( pidomwindow-&gt;GetDocShell() );</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-  if (!ppBaseWindow)</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-    return 0;</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+      do_QueryInterface(pidomwindow-&gt;GetDocShell());</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+  if (!ppBaseWindow) return 0;</span>
<a href="#l22.70"></a><span id="l22.70"> </span>
<a href="#l22.71"></a><span id="l22.71">   nsCOMPtr&lt;nsIWidget&gt; ppWidget;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-  ppBaseWindow-&gt;GetMainWidget( getter_AddRefs( ppWidget ) );</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+  ppBaseWindow-&gt;GetMainWidget(getter_AddRefs(ppWidget));</span>
<a href="#l22.74"></a><span id="l22.74"> </span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  return (HWND)( ppWidget-&gt;GetNativeData( NS_NATIVE_WIDGET ) );</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+  return (HWND)(ppWidget-&gt;GetNativeData(NS_NATIVE_WIDGET));</span>
<a href="#l22.77"></a><span id="l22.77"> }</span>
<a href="#l22.78"></a><span id="l22.78"> </span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-static void activateWindow( mozIDOMWindowProxy *win )</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-{</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+static void activateWindow(mozIDOMWindowProxy *win) {</span>
<a href="#l22.82"></a><span id="l22.82">   // Try to get native window handle.</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-  HWND hwnd = hwndForDOMWindow( win );</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-  if ( hwnd )</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-  {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+  HWND hwnd = hwndForDOMWindow(win);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+  if (hwnd) {</span>
<a href="#l22.88"></a><span id="l22.88">     // Restore the window if it is minimized.</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-    if ( ::IsIconic( hwnd ) )</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-      ::ShowWindow( hwnd, SW_RESTORE );</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+    if (::IsIconic(hwnd)) ::ShowWindow(hwnd, SW_RESTORE);</span>
<a href="#l22.92"></a><span id="l22.92">     // Use the OS call, if possible.</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-    ::SetForegroundWindow( hwnd );</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    ::SetForegroundWindow(hwnd);</span>
<a href="#l22.95"></a><span id="l22.95">   } else {</span>
<a href="#l22.96"></a><span id="l22.96">     // Use internal method.</span>
<a href="#l22.97"></a><span id="l22.97">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow = nsPIDOMWindowOuter::From(win);</span>
<a href="#l22.98"></a><span id="l22.98">     privateWindow-&gt;Focus();</span>
<a href="#l22.99"></a><span id="l22.99">   }</span>
<a href="#l22.100"></a><span id="l22.100"> }</span>
<a href="#l22.101"></a><span id="l22.101"> // end shameless copying from nsNativeAppWinSupport.cpp</span>
<a href="#l22.102"></a><span id="l22.102"> </span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-static void openMailWindow(const nsACString&amp; aFolderUri)</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-{</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+static void openMailWindow(const nsACString &amp;aFolderUri) {</span>
<a href="#l22.106"></a><span id="l22.106">   nsresult rv;</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-    return;</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l22.113"></a><span id="l22.113"> </span>
<a href="#l22.114"></a><span id="l22.114">   nsCOMPtr&lt;nsIMsgWindow&gt; topMostMsgWindow;</span>
<a href="#l22.115"></a><span id="l22.115">   rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMostMsgWindow));</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-  if (topMostMsgWindow)</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  {</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  if (topMostMsgWindow) {</span>
<a href="#l22.119"></a><span id="l22.119">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l22.120"></a><span id="l22.120">     topMostMsgWindow-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-    if (domWindow)</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-    {</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-      if (!aFolderUri.IsEmpty())</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-      {</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+    if (domWindow) {</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+      if (!aFolderUri.IsEmpty()) {</span>
<a href="#l22.127"></a><span id="l22.127">         nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l22.128"></a><span id="l22.128">         topMostMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-        if (windowCommands)</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-          windowCommands-&gt;SelectFolder(aFolderUri);</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+        if (windowCommands) windowCommands-&gt;SelectFolder(aFolderUri);</span>
<a href="#l22.132"></a><span id="l22.132">       }</span>
<a href="#l22.133"></a><span id="l22.133">       activateWindow(domWindow);</span>
<a href="#l22.134"></a><span id="l22.134">       return;</span>
<a href="#l22.135"></a><span id="l22.135">     }</span>
<a href="#l22.136"></a><span id="l22.136">   }</span>
<a href="#l22.137"></a><span id="l22.137"> </span>
<a href="#l22.138"></a><span id="l22.138">   {</span>
<a href="#l22.139"></a><span id="l22.139">     // the user doesn't have a mail window open already so open one for them...</span>
<a href="#l22.140"></a><span id="l22.140">     nsCOMPtr&lt;nsIMessengerWindowService&gt; messengerWindowService =</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-      do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+        do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID);</span>
<a href="#l22.143"></a><span id="l22.143">     // if we want to preselect the first account with new mail,</span>
<a href="#l22.144"></a><span id="l22.144">     // here is where we would try to generate a uri to pass in</span>
<a href="#l22.145"></a><span id="l22.145">     // (and add code to the messenger window service to make that work)</span>
<a href="#l22.146"></a><span id="l22.146">     if (messengerWindowService)</span>
<a href="#l22.147"></a><span id="l22.147">       messengerWindowService-&gt;OpenMessengerWindowWithUri(</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-                                &quot;mail:3pane&quot;, nsCString(aFolderUri).get(), nsMsgKey_None);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+          &quot;mail:3pane&quot;, nsCString(aFolderUri).get(), nsMsgKey_None);</span>
<a href="#l22.150"></a><span id="l22.150">   }</span>
<a href="#l22.151"></a><span id="l22.151"> }</span>
<a href="#l22.152"></a><span id="l22.152"> </span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-static void CALLBACK delayedSingleClick(HWND msgWindow, UINT msg, INT_PTR idEvent, DWORD dwTime)</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-{</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+static void CALLBACK delayedSingleClick(HWND msgWindow, UINT msg,</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+                                        INT_PTR idEvent, DWORD dwTime) {</span>
<a href="#l22.157"></a><span id="l22.157">   ::KillTimer(msgWindow, idEvent);</span>
<a href="#l22.158"></a><span id="l22.158"> </span>
<a href="#l22.159"></a><span id="l22.159">   // single clicks on the biff icon should re-open the alert notification</span>
<a href="#l22.160"></a><span id="l22.160">   nsresult rv = NS_OK;</span>
<a href="#l22.161"></a><span id="l22.161">   nsCOMPtr&lt;nsIMessengerOSIntegration&gt; integrationService =</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-    do_GetService(NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;rv);</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-  {</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+      do_GetService(NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;rv);</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.167"></a><span id="l22.167">     // we know we are dealing with the windows integration object</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-    nsMessengerWinIntegration * winIntegrationService = static_cast&lt;nsMessengerWinIntegration*&gt;</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-                                                                   (static_cast&lt;nsIMessengerOSIntegration*&gt;(integrationService.get()));</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-    winIntegrationService-&gt;ShowNewAlertNotification(true, EmptyString(), EmptyString());</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+    nsMessengerWinIntegration *winIntegrationService =</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+        static_cast&lt;nsMessengerWinIntegration *&gt;(</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+            static_cast&lt;nsIMessengerOSIntegration *&gt;(integrationService.get()));</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+    winIntegrationService-&gt;ShowNewAlertNotification(true, EmptyString(),</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+                                                    EmptyString());</span>
<a href="#l22.176"></a><span id="l22.176">   }</span>
<a href="#l22.177"></a><span id="l22.177"> }</span>
<a href="#l22.178"></a><span id="l22.178"> </span>
<a href="#l22.179"></a><span id="l22.179"> // Window proc.</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-static LRESULT CALLBACK MessageWindowProc( HWND msgWindow, UINT msg, WPARAM wp, LPARAM lp )</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-{</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-  if (msg == WM_USER)</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-  {</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-    if (lp == WM_LBUTTONDOWN)</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-    {</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+static LRESULT CALLBACK MessageWindowProc(HWND msgWindow, UINT msg, WPARAM wp,</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+                                          LPARAM lp) {</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+  if (msg == WM_USER) {</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+    if (lp == WM_LBUTTONDOWN) {</span>
<a href="#l22.190"></a><span id="l22.190">       // the only way to tell a single left click</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-      // from a double left click is to fire a timer which gets cleared if we end up getting</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-      // a WM_LBUTTONDBLK event.</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineminus">-      ::SetTimer(msgWindow, 1, GetDoubleClickTime(), (TIMERPROC) delayedSingleClick);</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-    }</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineminus">-    else if (lp == WM_LBUTTONDBLCLK || lp == NIN_BALLOONUSERCLICK)</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineminus">-    {</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+      // from a double left click is to fire a timer which gets cleared if we</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+      // end up getting a WM_LBUTTONDBLK event.</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+      ::SetTimer(msgWindow, 1, GetDoubleClickTime(),</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+                 (TIMERPROC)delayedSingleClick);</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+    } else if (lp == WM_LBUTTONDBLCLK || lp == NIN_BALLOONUSERCLICK) {</span>
<a href="#l22.202"></a><span id="l22.202">       ::KillTimer(msgWindow, 1);</span>
<a href="#l22.203"></a><span id="l22.203">       openMailWindow(EmptyCString());</span>
<a href="#l22.204"></a><span id="l22.204">     }</span>
<a href="#l22.205"></a><span id="l22.205">   }</span>
<a href="#l22.206"></a><span id="l22.206"> </span>
<a href="#l22.207"></a><span id="l22.207">   return TRUE;</span>
<a href="#l22.208"></a><span id="l22.208"> }</span>
<a href="#l22.209"></a><span id="l22.209"> </span>
<a href="#l22.210"></a><span id="l22.210"> static HWND msgWindow;</span>
<a href="#l22.211"></a><span id="l22.211"> </span>
<a href="#l22.212"></a><span id="l22.212"> // Create: Register class and create window.</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineminus">-static nsresult Create()</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineminus">-{</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineminus">-  if (msgWindow)</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+static nsresult Create() {</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+  if (msgWindow) return NS_OK;</span>
<a href="#l22.219"></a><span id="l22.219"> </span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-  WNDCLASS classStruct = { 0,                          // style</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-                           &amp;MessageWindowProc,         // lpfnWndProc</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-                           0,                          // cbClsExtra</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-                           0,                          // cbWndExtra</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-                           0,                          // hInstance</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-                           0,                          // hIcon</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-                           0,                          // hCursor</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-                           0,                          // hbrBackground</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-                           0,                          // lpszMenuName</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-                           NOTIFICATIONCLASSNAME };    // lpszClassName</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+  WNDCLASS classStruct = {0,                       // style</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+                          &amp;MessageWindowProc,      // lpfnWndProc</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+                          0,                       // cbClsExtra</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+                          0,                       // cbWndExtra</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+                          0,                       // hInstance</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+                          0,                       // hIcon</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+                          0,                       // hCursor</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+                          0,                       // hbrBackground</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+                          0,                       // lpszMenuName</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+                          NOTIFICATIONCLASSNAME};  // lpszClassName</span>
<a href="#l22.240"></a><span id="l22.240"> </span>
<a href="#l22.241"></a><span id="l22.241">   // Register the window class.</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-  NS_ENSURE_TRUE( ::RegisterClass( &amp;classStruct ), NS_ERROR_FAILURE );</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+  NS_ENSURE_TRUE(::RegisterClass(&amp;classStruct), NS_ERROR_FAILURE);</span>
<a href="#l22.244"></a><span id="l22.244">   // Create the window.</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-  NS_ENSURE_TRUE( msgWindow = ::CreateWindow( NOTIFICATIONCLASSNAME,</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-                                              0,          // title</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-                                              WS_CAPTION, // style</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-                                              0,0,0,0,    // x, y, cx, cy</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-                                              0,          // parent</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-                                              0,          // menu</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-                                              0,          // instance</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineminus">-                                              0 ),        // create struct</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineminus">-                  NS_ERROR_FAILURE );</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineplus">+  NS_ENSURE_TRUE(msgWindow = ::CreateWindow(NOTIFICATIONCLASSNAME,</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+                                            0,           // title</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+                                            WS_CAPTION,  // style</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+                                            0, 0, 0, 0,  // x, y, cx, cy</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+                                            0,           // parent</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+                                            0,           // menu</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+                                            0,           // instance</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+                                            0),          // create struct</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+                 NS_ERROR_FAILURE);</span>
<a href="#l22.263"></a><span id="l22.263">   return NS_OK;</span>
<a href="#l22.264"></a><span id="l22.264"> }</span>
<a href="#l22.265"></a><span id="l22.265"> </span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-nsMessengerWinIntegration::nsMessengerWinIntegration()</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-{</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+nsMessengerWinIntegration::nsMessengerWinIntegration() {</span>
<a href="#l22.270"></a><span id="l22.270">   mUnreadTimerActive = false;</span>
<a href="#l22.271"></a><span id="l22.271"> </span>
<a href="#l22.272"></a><span id="l22.272">   mBiffIconVisible = false;</span>
<a href="#l22.273"></a><span id="l22.273">   mSuppressBiffIcon = false;</span>
<a href="#l22.274"></a><span id="l22.274">   mAlertInProgress = false;</span>
<a href="#l22.275"></a><span id="l22.275">   mBiffIconInitialized = false;</span>
<a href="#l22.276"></a><span id="l22.276">   mFoldersWithNewMail = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l22.277"></a><span id="l22.277"> }</span>
<a href="#l22.278"></a><span id="l22.278"> </span>
<a href="#l22.279"></a><span id="l22.279" class="difflineminus">-nsMessengerWinIntegration::~nsMessengerWinIntegration()</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineminus">-{</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+nsMessengerWinIntegration::~nsMessengerWinIntegration() {</span>
<a href="#l22.282"></a><span id="l22.282">   if (mUnreadCountUpdateTimer) {</span>
<a href="#l22.283"></a><span id="l22.283">     mUnreadCountUpdateTimer-&gt;Cancel();</span>
<a href="#l22.284"></a><span id="l22.284">     mUnreadCountUpdateTimer = nullptr;</span>
<a href="#l22.285"></a><span id="l22.285">   }</span>
<a href="#l22.286"></a><span id="l22.286"> </span>
<a href="#l22.287"></a><span id="l22.287">   // one last attempt, update the registry</span>
<a href="#l22.288"></a><span id="l22.288">   mozilla::DebugOnly&lt;nsresult&gt; rv = UpdateRegistryWithCurrent();</span>
<a href="#l22.289"></a><span id="l22.289">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to update registry on shutdown&quot;);</span>
<a href="#l22.290"></a><span id="l22.290">   DestroyBiffIcon();</span>
<a href="#l22.291"></a><span id="l22.291"> }</span>
<a href="#l22.292"></a><span id="l22.292"> </span>
<a href="#l22.293"></a><span id="l22.293"> NS_IMPL_ADDREF(nsMessengerWinIntegration)</span>
<a href="#l22.294"></a><span id="l22.294"> NS_IMPL_RELEASE(nsMessengerWinIntegration)</span>
<a href="#l22.295"></a><span id="l22.295"> </span>
<a href="#l22.296"></a><span id="l22.296"> NS_INTERFACE_MAP_BEGIN(nsMessengerWinIntegration)</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMessengerOSIntegration)</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMessengerOSIntegration)</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIFolderListener)</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMessengerOSIntegration)</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMessengerOSIntegration)</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIFolderListener)</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l22.305"></a><span id="l22.305"> NS_INTERFACE_MAP_END</span>
<a href="#l22.306"></a><span id="l22.306"> </span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-nsresult</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-nsMessengerWinIntegration::ResetCurrent()</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineminus">-{</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+nsresult nsMessengerWinIntegration::ResetCurrent() {</span>
<a href="#l22.312"></a><span id="l22.312">   mInboxURI.Truncate();</span>
<a href="#l22.313"></a><span id="l22.313">   mEmail.Truncate();</span>
<a href="#l22.314"></a><span id="l22.314"> </span>
<a href="#l22.315"></a><span id="l22.315">   mCurrentUnreadCount = -1;</span>
<a href="#l22.316"></a><span id="l22.316">   mLastUnreadCountWrittenToRegistry = -1;</span>
<a href="#l22.317"></a><span id="l22.317"> </span>
<a href="#l22.318"></a><span id="l22.318">   mDefaultAccountMightHaveAnInbox = true;</span>
<a href="#l22.319"></a><span id="l22.319">   return NS_OK;</span>
<a href="#l22.320"></a><span id="l22.320"> }</span>
<a href="#l22.321"></a><span id="l22.321"> </span>
<a href="#l22.322"></a><span id="l22.322" class="difflineminus">-NOTIFYICONDATAW sBiffIconData = { (DWORD)NOTIFYICONDATAW_V2_SIZE,</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineminus">-                                  0,</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineminus">-                                  2,</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineminus">-                                  NIF_ICON | NIF_MESSAGE | NIF_TIP | NIF_INFO,</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineminus">-                                  WM_USER,</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineminus">-                                  0,</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-                                  L&quot;&quot;,</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineminus">-                                  0,</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineminus">-                                  0,</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineminus">-                                  L&quot;&quot;,</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineminus">-                                  { 30000 },</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineminus">-                                  L&quot;&quot;,</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineminus">-                                  NIIF_USER | NIIF_NOSOUND };</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineplus">+NOTIFYICONDATAW sBiffIconData = {(DWORD)NOTIFYICONDATAW_V2_SIZE,</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineplus">+                                 0,</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineplus">+                                 2,</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineplus">+                                 NIF_ICON | NIF_MESSAGE | NIF_TIP | NIF_INFO,</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineplus">+                                 WM_USER,</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineplus">+                                 0,</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+                                 L&quot;&quot;,</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineplus">+                                 0,</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineplus">+                                 0,</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineplus">+                                 L&quot;&quot;,</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineplus">+                                 {30000},</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+                                 L&quot;&quot;,</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineplus">+                                 NIIF_USER | NIIF_NOSOUND};</span>
<a href="#l22.348"></a><span id="l22.348"> // allow for the null terminator</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineminus">-static const uint32_t kMaxTooltipSize = sizeof(sBiffIconData.szTip) /</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineminus">-                                        sizeof(sBiffIconData.szTip[0]) - 1;</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineminus">-static const uint32_t kMaxBalloonSize = sizeof(sBiffIconData.szInfo) /</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineminus">-                                        sizeof(sBiffIconData.szInfo[0]) - 1;</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineminus">-static const uint32_t kMaxBalloonTitle = sizeof(sBiffIconData.szInfoTitle) /</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineminus">-                                         sizeof(sBiffIconData.szInfoTitle[0]) - 1;</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineplus">+static const uint32_t kMaxTooltipSize =</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineplus">+    sizeof(sBiffIconData.szTip) / sizeof(sBiffIconData.szTip[0]) - 1;</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineplus">+static const uint32_t kMaxBalloonSize =</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineplus">+    sizeof(sBiffIconData.szInfo) / sizeof(sBiffIconData.szInfo[0]) - 1;</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineplus">+static const uint32_t kMaxBalloonTitle =</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineplus">+    sizeof(sBiffIconData.szInfoTitle) / sizeof(sBiffIconData.szInfoTitle[0]) -</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineplus">+    1;</span>
<a href="#l22.362"></a><span id="l22.362"> </span>
<a href="#l22.363"></a><span id="l22.363" class="difflineminus">-void nsMessengerWinIntegration::InitializeBiffStatusIcon()</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineminus">-{</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineplus">+void nsMessengerWinIntegration::InitializeBiffStatusIcon() {</span>
<a href="#l22.366"></a><span id="l22.366">   // initialize our biff status bar icon</span>
<a href="#l22.367"></a><span id="l22.367">   Create();</span>
<a href="#l22.368"></a><span id="l22.368"> </span>
<a href="#l22.369"></a><span id="l22.369" class="difflineminus">-  sBiffIconData.hWnd = (HWND) msgWindow;</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineminus">-  sBiffIconData.hIcon = ::LoadIcon( ::GetModuleHandle( NULL ), MAKEINTRESOURCE(IDI_MAILBIFF) );</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineplus">+  sBiffIconData.hWnd = (HWND)msgWindow;</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+  sBiffIconData.hIcon =</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineplus">+      ::LoadIcon(::GetModuleHandle(NULL), MAKEINTRESOURCE(IDI_MAILBIFF));</span>
<a href="#l22.374"></a><span id="l22.374"> </span>
<a href="#l22.375"></a><span id="l22.375">   mBiffIconInitialized = true;</span>
<a href="#l22.376"></a><span id="l22.376"> }</span>
<a href="#l22.377"></a><span id="l22.377"> </span>
<a href="#l22.378"></a><span id="l22.378" class="difflineminus">-nsresult</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineminus">-nsMessengerWinIntegration::Init()</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineminus">-{</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineplus">+nsresult nsMessengerWinIntegration::Init() {</span>
<a href="#l22.382"></a><span id="l22.382">   nsresult rv;</span>
<a href="#l22.383"></a><span id="l22.383"> </span>
<a href="#l22.384"></a><span id="l22.384" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.390"></a><span id="l22.390"> </span>
<a href="#l22.391"></a><span id="l22.391">   // because we care if the default server changes</span>
<a href="#l22.392"></a><span id="l22.392">   rv = accountManager-&gt;AddRootFolderListener(this);</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.395"></a><span id="l22.395"> </span>
<a href="#l22.396"></a><span id="l22.396" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l22.400"></a><span id="l22.400" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.401"></a><span id="l22.401"> </span>
<a href="#l22.402"></a><span id="l22.402">   // because we care if the unread total count changes</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineminus">-  rv = mailSession-&gt;AddFolderListener(this, nsIFolderListener::boolPropertyChanged | nsIFolderListener::intPropertyChanged);</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.405"></a><span id="l22.405" class="difflineplus">+  rv = mailSession-&gt;AddFolderListener(</span>
<a href="#l22.406"></a><span id="l22.406" class="difflineplus">+      this, nsIFolderListener::boolPropertyChanged |</span>
<a href="#l22.407"></a><span id="l22.407" class="difflineplus">+                nsIFolderListener::intPropertyChanged);</span>
<a href="#l22.408"></a><span id="l22.408" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.409"></a><span id="l22.409"> </span>
<a href="#l22.410"></a><span id="l22.410">   // get current profile path for the commandliner</span>
<a href="#l22.411"></a><span id="l22.411">   nsCOMPtr&lt;nsIProperties&gt; directoryService =</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineminus">-    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineplus">+      do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.416"></a><span id="l22.416"> </span>
<a href="#l22.417"></a><span id="l22.417">   nsCOMPtr&lt;nsIFile&gt; profilePath;</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineminus">-  rv = directoryService-&gt;Get(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineminus">-                             NS_GET_IID(nsIFile),</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineplus">+  rv = directoryService-&gt;Get(NS_APP_USER_PROFILE_50_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l22.421"></a><span id="l22.421">                              getter_AddRefs(profilePath));</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.424"></a><span id="l22.424"> </span>
<a href="#l22.425"></a><span id="l22.425">   rv = profilePath-&gt;GetPath(mProfilePath);</span>
<a href="#l22.426"></a><span id="l22.426">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.427"></a><span id="l22.427"> </span>
<a href="#l22.428"></a><span id="l22.428">   // get application path</span>
<a href="#l22.429"></a><span id="l22.429">   WCHAR appPath[_MAX_PATH] = {0};</span>
<a href="#l22.430"></a><span id="l22.430">   ::GetModuleFileNameW(nullptr, appPath, sizeof(appPath));</span>
<a href="#l22.431"></a><span id="l22.431">   mAppName.Assign((char16_t *)appPath);</span>
<a href="#l22.432"></a><span id="l22.432"> </span>
<a href="#l22.433"></a><span id="l22.433">   rv = ResetCurrent();</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.436"></a><span id="l22.436"> </span>
<a href="#l22.437"></a><span id="l22.437">   return NS_OK;</span>
<a href="#l22.438"></a><span id="l22.438"> }</span>
<a href="#l22.439"></a><span id="l22.439"> </span>
<a href="#l22.440"></a><span id="l22.440"> NS_IMETHODIMP</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineminus">-nsMessengerWinIntegration::OnItemPropertyChanged(nsIMsgFolder *, const nsACString &amp;, char const *, char const *)</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineminus">-{</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineplus">+nsMessengerWinIntegration::OnItemPropertyChanged(nsIMsgFolder *,</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineplus">+                                                 const nsACString &amp;,</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineplus">+                                                 char const *, char const *) {</span>
<a href="#l22.446"></a><span id="l22.446">   return NS_OK;</span>
<a href="#l22.447"></a><span id="l22.447"> }</span>
<a href="#l22.448"></a><span id="l22.448"> </span>
<a href="#l22.449"></a><span id="l22.449"> NS_IMETHODIMP</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineminus">-nsMessengerWinIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *, const nsACString &amp;, const char16_t *, const char16_t *)</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineminus">-{</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineplus">+nsMessengerWinIntegration::OnItemUnicharPropertyChanged(nsIMsgFolder *,</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineplus">+                                                        const nsACString &amp;,</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineplus">+                                                        const char16_t *,</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineplus">+                                                        const char16_t *) {</span>
<a href="#l22.456"></a><span id="l22.456">   return NS_OK;</span>
<a href="#l22.457"></a><span id="l22.457"> }</span>
<a href="#l22.458"></a><span id="l22.458"> </span>
<a href="#l22.459"></a><span id="l22.459"> NS_IMETHODIMP</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineminus">-nsMessengerWinIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *)</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineminus">-{</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineplus">+nsMessengerWinIntegration::OnItemRemoved(nsIMsgFolder *, nsISupports *) {</span>
<a href="#l22.463"></a><span id="l22.463">   return NS_OK;</span>
<a href="#l22.464"></a><span id="l22.464"> }</span>
<a href="#l22.465"></a><span id="l22.465"> </span>
<a href="#l22.466"></a><span id="l22.466" class="difflineminus">-nsresult nsMessengerWinIntegration::GetStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineminus">-{</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineplus">+nsresult nsMessengerWinIntegration::GetStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l22.469"></a><span id="l22.469">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l22.470"></a><span id="l22.470">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l22.473"></a><span id="l22.473">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l22.474"></a><span id="l22.474">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l22.475"></a><span id="l22.475">   bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l22.476"></a><span id="l22.476">                               getter_AddRefs(bundle));</span>
<a href="#l22.477"></a><span id="l22.477">   bundle.forget(aBundle);</span>
<a href="#l22.478"></a><span id="l22.478">   return NS_OK;</span>
<a href="#l22.479"></a><span id="l22.479"> }</span>
<a href="#l22.480"></a><span id="l22.480"> </span>
<a href="#l22.481"></a><span id="l22.481"> #ifndef MOZ_THUNDERBIRD</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineminus">-nsresult nsMessengerWinIntegration::ShowAlertMessage(const nsString&amp; aAlertTitle,</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineminus">-                                                     const nsString&amp; aAlertText,</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineminus">-                                                     const nsACString&amp; aFolderURI)</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineminus">-{</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineplus">+nsresult nsMessengerWinIntegration::ShowAlertMessage(</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineplus">+    const nsString &amp;aAlertTitle, const nsString &amp;aAlertText,</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineplus">+    const nsACString &amp;aFolderURI) {</span>
<a href="#l22.489"></a><span id="l22.489">   nsresult rv;</span>
<a href="#l22.490"></a><span id="l22.490"> </span>
<a href="#l22.491"></a><span id="l22.491" class="difflineminus">-  // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineminus">-  if (mAlertInProgress)</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineplus">+  // if we are already in the process of showing an alert, don't try to show</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineplus">+  // another....</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineplus">+  if (mAlertInProgress) return NS_OK;</span>
<a href="#l22.497"></a><span id="l22.497"> </span>
<a href="#l22.498"></a><span id="l22.498" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.501"></a><span id="l22.501">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.502"></a><span id="l22.502"> </span>
<a href="#l22.503"></a><span id="l22.503">   bool showBalloon = false;</span>
<a href="#l22.504"></a><span id="l22.504">   prefBranch-&gt;GetBoolPref(SHOW_BALLOON_PREF, &amp;showBalloon);</span>
<a href="#l22.505"></a><span id="l22.505">   sBiffIconData.szInfo[0] = '\0';</span>
<a href="#l22.506"></a><span id="l22.506">   if (showBalloon) {</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineminus">-    ::wcsncpy( sBiffIconData.szInfoTitle, aAlertTitle.get(), kMaxBalloonTitle);</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineminus">-    ::wcsncpy( sBiffIconData.szInfo, aAlertText.get(), kMaxBalloonSize);</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineplus">+    ::wcsncpy(sBiffIconData.szInfoTitle, aAlertTitle.get(), kMaxBalloonTitle);</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineplus">+    ::wcsncpy(sBiffIconData.szInfo, aAlertText.get(), kMaxBalloonSize);</span>
<a href="#l22.511"></a><span id="l22.511">   }</span>
<a href="#l22.512"></a><span id="l22.512"> </span>
<a href="#l22.513"></a><span id="l22.513">   bool showAlert = true;</span>
<a href="#l22.514"></a><span id="l22.514">   prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l22.515"></a><span id="l22.515"> </span>
<a href="#l22.516"></a><span id="l22.516" class="difflineminus">-  if (showAlert)</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineminus">-  {</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineminus">-    nsCOMPtr&lt;nsIAlertsService&gt; alertsService = mozilla::components::Alerts::Service();</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineminus">-    if (alertsService)</span>
<a href="#l22.520"></a><span id="l22.520" class="difflineminus">-    {</span>
<a href="#l22.521"></a><span id="l22.521" class="difflineminus">-      rv = alertsService-&gt;ShowAlertNotification(NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle,</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineminus">-                                                aAlertText, true,</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineminus">-                                                NS_ConvertASCIItoUTF16(aFolderURI), this,</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineminus">-                                                EmptyString(),</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineminus">-                                                NS_LITERAL_STRING(&quot;auto&quot;),</span>
<a href="#l22.526"></a><span id="l22.526" class="difflineminus">-                                                EmptyString(), EmptyString(),</span>
<a href="#l22.527"></a><span id="l22.527" class="difflineminus">-                                                nullptr,</span>
<a href="#l22.528"></a><span id="l22.528" class="difflineminus">-                                                false,</span>
<a href="#l22.529"></a><span id="l22.529" class="difflineminus">-                                                false);</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineplus">+  if (showAlert) {</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineplus">+    nsCOMPtr&lt;nsIAlertsService&gt; alertsService =</span>
<a href="#l22.532"></a><span id="l22.532" class="difflineplus">+        mozilla::components::Alerts::Service();</span>
<a href="#l22.533"></a><span id="l22.533" class="difflineplus">+    if (alertsService) {</span>
<a href="#l22.534"></a><span id="l22.534" class="difflineplus">+      rv = alertsService-&gt;ShowAlertNotification(</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineplus">+          NS_LITERAL_STRING(NEW_MAIL_ALERT_ICON), aAlertTitle, aAlertText, true,</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineplus">+          NS_ConvertASCIItoUTF16(aFolderURI), this, EmptyString(),</span>
<a href="#l22.537"></a><span id="l22.537" class="difflineplus">+          NS_LITERAL_STRING(&quot;auto&quot;), EmptyString(), EmptyString(), nullptr,</span>
<a href="#l22.538"></a><span id="l22.538" class="difflineplus">+          false, false);</span>
<a href="#l22.539"></a><span id="l22.539">       mAlertInProgress = true;</span>
<a href="#l22.540"></a><span id="l22.540">     }</span>
<a href="#l22.541"></a><span id="l22.541">   }</span>
<a href="#l22.542"></a><span id="l22.542"> </span>
<a href="#l22.543"></a><span id="l22.543" class="difflineminus">-  if (!showAlert || NS_FAILED(rv)) // go straight to showing the system tray icon.</span>
<a href="#l22.544"></a><span id="l22.544" class="difflineplus">+  if (!showAlert ||</span>
<a href="#l22.545"></a><span id="l22.545" class="difflineplus">+      NS_FAILED(rv))  // go straight to showing the system tray icon.</span>
<a href="#l22.546"></a><span id="l22.546">     AlertFinished();</span>
<a href="#l22.547"></a><span id="l22.547"> </span>
<a href="#l22.548"></a><span id="l22.548">   return rv;</span>
<a href="#l22.549"></a><span id="l22.549"> }</span>
<a href="#l22.550"></a><span id="l22.550"> #endif</span>
<a href="#l22.551"></a><span id="l22.551"> // Opening Thunderbird's new mail alert notification window</span>
<a href="#l22.552"></a><span id="l22.552" class="difflineminus">-// aUserInitiated --&gt; true if we are opening the alert notification in response to a user action</span>
<a href="#l22.553"></a><span id="l22.553" class="difflineminus">-//                    like clicking on the biff icon</span>
<a href="#l22.554"></a><span id="l22.554" class="difflineminus">-nsresult nsMessengerWinIntegration::ShowNewAlertNotification(bool aUserInitiated, const nsString&amp; aAlertTitle, const nsString&amp; aAlertText)</span>
<a href="#l22.555"></a><span id="l22.555" class="difflineminus">-{</span>
<a href="#l22.556"></a><span id="l22.556" class="difflineplus">+// aUserInitiated --&gt; true if we are opening the alert notification in response</span>
<a href="#l22.557"></a><span id="l22.557" class="difflineplus">+//                    to a user action like clicking on the biff icon</span>
<a href="#l22.558"></a><span id="l22.558" class="difflineplus">+nsresult nsMessengerWinIntegration::ShowNewAlertNotification(</span>
<a href="#l22.559"></a><span id="l22.559" class="difflineplus">+    bool aUserInitiated, const nsString &amp;aAlertTitle,</span>
<a href="#l22.560"></a><span id="l22.560" class="difflineplus">+    const nsString &amp;aAlertText) {</span>
<a href="#l22.561"></a><span id="l22.561">   nsresult rv;</span>
<a href="#l22.562"></a><span id="l22.562"> </span>
<a href="#l22.563"></a><span id="l22.563" class="difflineminus">-  // if we are already in the process of showing an alert, don't try to show another....</span>
<a href="#l22.564"></a><span id="l22.564" class="difflineminus">-  if (mAlertInProgress)</span>
<a href="#l22.565"></a><span id="l22.565" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.566"></a><span id="l22.566" class="difflineplus">+  // if we are already in the process of showing an alert, don't try to show</span>
<a href="#l22.567"></a><span id="l22.567" class="difflineplus">+  // another....</span>
<a href="#l22.568"></a><span id="l22.568" class="difflineplus">+  if (mAlertInProgress) return NS_OK;</span>
<a href="#l22.569"></a><span id="l22.569"> </span>
<a href="#l22.570"></a><span id="l22.570" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.571"></a><span id="l22.571" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l22.572"></a><span id="l22.572" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.573"></a><span id="l22.573">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.574"></a><span id="l22.574"> </span>
<a href="#l22.575"></a><span id="l22.575">   bool showBalloon = false;</span>
<a href="#l22.576"></a><span id="l22.576">   prefBranch-&gt;GetBoolPref(SHOW_BALLOON_PREF, &amp;showBalloon);</span>
<a href="#l22.577"></a><span id="l22.577">   sBiffIconData.szInfo[0] = '\0';</span>
<a href="#l22.578"></a><span id="l22.578">   if (showBalloon) {</span>
<a href="#l22.579"></a><span id="l22.579" class="difflineminus">-    ::wcsncpy( sBiffIconData.szInfoTitle, aAlertTitle.get(), kMaxBalloonTitle);</span>
<a href="#l22.580"></a><span id="l22.580" class="difflineminus">-    ::wcsncpy( sBiffIconData.szInfo, aAlertText.get(), kMaxBalloonSize);</span>
<a href="#l22.581"></a><span id="l22.581" class="difflineplus">+    ::wcsncpy(sBiffIconData.szInfoTitle, aAlertTitle.get(), kMaxBalloonTitle);</span>
<a href="#l22.582"></a><span id="l22.582" class="difflineplus">+    ::wcsncpy(sBiffIconData.szInfo, aAlertText.get(), kMaxBalloonSize);</span>
<a href="#l22.583"></a><span id="l22.583">   }</span>
<a href="#l22.584"></a><span id="l22.584"> </span>
<a href="#l22.585"></a><span id="l22.585">   bool showAlert = true;</span>
<a href="#l22.586"></a><span id="l22.586"> </span>
<a href="#l22.587"></a><span id="l22.587" class="difflineminus">-  if (prefBranch)</span>
<a href="#l22.588"></a><span id="l22.588" class="difflineminus">-    prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l22.589"></a><span id="l22.589" class="difflineplus">+  if (prefBranch) prefBranch-&gt;GetBoolPref(SHOW_ALERT_PREF, &amp;showAlert);</span>
<a href="#l22.590"></a><span id="l22.590"> </span>
<a href="#l22.591"></a><span id="l22.591">   // check if we are allowed to show a notification</span>
<a href="#l22.592"></a><span id="l22.592">   if (showAlert) {</span>
<a href="#l22.593"></a><span id="l22.593">     QUERY_USER_NOTIFICATION_STATE qstate;</span>
<a href="#l22.594"></a><span id="l22.594"> </span>
<a href="#l22.595"></a><span id="l22.595">     if (SUCCEEDED(SHQueryUserNotificationState(&amp;qstate))) {</span>
<a href="#l22.596"></a><span id="l22.596">       if (qstate != QUNS_ACCEPTS_NOTIFICATIONS) {</span>
<a href="#l22.597"></a><span id="l22.597">         showAlert = false;</span>
<a href="#l22.598"></a><span id="l22.598">       }</span>
<a href="#l22.599"></a><span id="l22.599">     }</span>
<a href="#l22.600"></a><span id="l22.600">   }</span>
<a href="#l22.601"></a><span id="l22.601"> </span>
<a href="#l22.602"></a><span id="l22.602" class="difflineminus">-  if (showAlert)</span>
<a href="#l22.603"></a><span id="l22.603" class="difflineminus">-  {</span>
<a href="#l22.604"></a><span id="l22.604" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; argsArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l22.605"></a><span id="l22.605" class="difflineplus">+  if (showAlert) {</span>
<a href="#l22.606"></a><span id="l22.606" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; argsArray(</span>
<a href="#l22.607"></a><span id="l22.607" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l22.608"></a><span id="l22.608">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.609"></a><span id="l22.609"> </span>
<a href="#l22.610"></a><span id="l22.610">     // pass in the array of folders with unread messages</span>
<a href="#l22.611"></a><span id="l22.611" class="difflineminus">-    nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l22.612"></a><span id="l22.612" class="difflineplus">+    nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l22.613"></a><span id="l22.613" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l22.614"></a><span id="l22.614">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.615"></a><span id="l22.615">     ifptr-&gt;SetData(mFoldersWithNewMail);</span>
<a href="#l22.616"></a><span id="l22.616">     ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIArray));</span>
<a href="#l22.617"></a><span id="l22.617">     rv = argsArray-&gt;AppendElement(ifptr);</span>
<a href="#l22.618"></a><span id="l22.618">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.619"></a><span id="l22.619"> </span>
<a href="#l22.620"></a><span id="l22.620">     // pass in the observer</span>
<a href="#l22.621"></a><span id="l22.621">     ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l22.622"></a><span id="l22.622">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.623"></a><span id="l22.623" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMessengerOSIntegration*&gt;(this));</span>
<a href="#l22.624"></a><span id="l22.624" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l22.625"></a><span id="l22.625" class="difflineplus">+        do_QueryInterface(static_cast&lt;nsIMessengerOSIntegration *&gt;(this));</span>
<a href="#l22.626"></a><span id="l22.626">     ifptr-&gt;SetData(supports);</span>
<a href="#l22.627"></a><span id="l22.627">     ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsIObserver));</span>
<a href="#l22.628"></a><span id="l22.628">     rv = argsArray-&gt;AppendElement(ifptr);</span>
<a href="#l22.629"></a><span id="l22.629">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.630"></a><span id="l22.630"> </span>
<a href="#l22.631"></a><span id="l22.631">     // pass in the animation flag</span>
<a href="#l22.632"></a><span id="l22.632" class="difflineminus">-    nsCOMPtr&lt;nsISupportsPRBool&gt; scriptableUserInitiated (do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv));</span>
<a href="#l22.633"></a><span id="l22.633" class="difflineplus">+    nsCOMPtr&lt;nsISupportsPRBool&gt; scriptableUserInitiated(</span>
<a href="#l22.634"></a><span id="l22.634" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv));</span>
<a href="#l22.635"></a><span id="l22.635">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.636"></a><span id="l22.636">     scriptableUserInitiated-&gt;SetData(aUserInitiated);</span>
<a href="#l22.637"></a><span id="l22.637">     rv = argsArray-&gt;AppendElement(scriptableUserInitiated);</span>
<a href="#l22.638"></a><span id="l22.638">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.639"></a><span id="l22.639"> </span>
<a href="#l22.640"></a><span id="l22.640">     // pass in the alert origin</span>
<a href="#l22.641"></a><span id="l22.641" class="difflineminus">-    nsCOMPtr&lt;nsISupportsPRUint8&gt; scriptableOrigin (do_CreateInstance(NS_SUPPORTS_PRUINT8_CONTRACTID));</span>
<a href="#l22.642"></a><span id="l22.642" class="difflineplus">+    nsCOMPtr&lt;nsISupportsPRUint8&gt; scriptableOrigin(</span>
<a href="#l22.643"></a><span id="l22.643" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_PRUINT8_CONTRACTID));</span>
<a href="#l22.644"></a><span id="l22.644">     NS_ENSURE_TRUE(scriptableOrigin, NS_ERROR_FAILURE);</span>
<a href="#l22.645"></a><span id="l22.645">     scriptableOrigin-&gt;SetData(0);</span>
<a href="#l22.646"></a><span id="l22.646">     int32_t origin = 0;</span>
<a href="#l22.647"></a><span id="l22.647">     origin = LookAndFeel::GetInt(LookAndFeel::eIntID_AlertNotificationOrigin);</span>
<a href="#l22.648"></a><span id="l22.648">     scriptableOrigin-&gt;SetData(origin);</span>
<a href="#l22.649"></a><span id="l22.649"> </span>
<a href="#l22.650"></a><span id="l22.650">     rv = argsArray-&gt;AppendElement(scriptableOrigin);</span>
<a href="#l22.651"></a><span id="l22.651">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.652"></a><span id="l22.652"> </span>
<a href="#l22.653"></a><span id="l22.653" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l22.654"></a><span id="l22.654" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l22.655"></a><span id="l22.655" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l22.656"></a><span id="l22.656">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l22.657"></a><span id="l22.657">     rv = wwatch-&gt;OpenWindow(0, ALERT_CHROME_URL, &quot;_blank&quot;,</span>
<a href="#l22.658"></a><span id="l22.658" class="difflineminus">-                &quot;chrome,dialog=yes,titlebar=no,popup=yes&quot;, argsArray,</span>
<a href="#l22.659"></a><span id="l22.659" class="difflineminus">-                 getter_AddRefs(newWindow));</span>
<a href="#l22.660"></a><span id="l22.660" class="difflineplus">+                            &quot;chrome,dialog=yes,titlebar=no,popup=yes&quot;,</span>
<a href="#l22.661"></a><span id="l22.661" class="difflineplus">+                            argsArray, getter_AddRefs(newWindow));</span>
<a href="#l22.662"></a><span id="l22.662"> </span>
<a href="#l22.663"></a><span id="l22.663">     mAlertInProgress = true;</span>
<a href="#l22.664"></a><span id="l22.664">   }</span>
<a href="#l22.665"></a><span id="l22.665"> </span>
<a href="#l22.666"></a><span id="l22.666" class="difflineminus">-  // if the user has turned off the mail alert, or  openWindow generated an error,</span>
<a href="#l22.667"></a><span id="l22.667" class="difflineminus">-  // then go straight to the system tray.</span>
<a href="#l22.668"></a><span id="l22.668" class="difflineminus">-  if (!showAlert || NS_FAILED(rv))</span>
<a href="#l22.669"></a><span id="l22.669" class="difflineminus">-    AlertFinished();</span>
<a href="#l22.670"></a><span id="l22.670" class="difflineplus">+  // if the user has turned off the mail alert, or  openWindow generated an</span>
<a href="#l22.671"></a><span id="l22.671" class="difflineplus">+  // error, then go straight to the system tray.</span>
<a href="#l22.672"></a><span id="l22.672" class="difflineplus">+  if (!showAlert || NS_FAILED(rv)) AlertFinished();</span>
<a href="#l22.673"></a><span id="l22.673"> </span>
<a href="#l22.674"></a><span id="l22.674">   return rv;</span>
<a href="#l22.675"></a><span id="l22.675"> }</span>
<a href="#l22.676"></a><span id="l22.676"> </span>
<a href="#l22.677"></a><span id="l22.677" class="difflineminus">-nsresult nsMessengerWinIntegration::AlertFinished()</span>
<a href="#l22.678"></a><span id="l22.678" class="difflineminus">-{</span>
<a href="#l22.679"></a><span id="l22.679" class="difflineplus">+nsresult nsMessengerWinIntegration::AlertFinished() {</span>
<a href="#l22.680"></a><span id="l22.680">   // okay, we are done showing the alert</span>
<a href="#l22.681"></a><span id="l22.681">   // now put an icon in the system tray, if allowed</span>
<a href="#l22.682"></a><span id="l22.682">   bool showTrayIcon = !mSuppressBiffIcon || sBiffIconData.szInfo[0];</span>
<a href="#l22.683"></a><span id="l22.683" class="difflineminus">-  if (showTrayIcon)</span>
<a href="#l22.684"></a><span id="l22.684" class="difflineminus">-  {</span>
<a href="#l22.685"></a><span id="l22.685" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l22.686"></a><span id="l22.686" class="difflineminus">-    if (prefBranch)</span>
<a href="#l22.687"></a><span id="l22.687" class="difflineminus">-      prefBranch-&gt;GetBoolPref(SHOW_TRAY_ICON_PREF, &amp;showTrayIcon);</span>
<a href="#l22.688"></a><span id="l22.688" class="difflineplus">+  if (showTrayIcon) {</span>
<a href="#l22.689"></a><span id="l22.689" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l22.690"></a><span id="l22.690" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l22.691"></a><span id="l22.691" class="difflineplus">+    if (prefBranch) prefBranch-&gt;GetBoolPref(SHOW_TRAY_ICON_PREF, &amp;showTrayIcon);</span>
<a href="#l22.692"></a><span id="l22.692">   }</span>
<a href="#l22.693"></a><span id="l22.693" class="difflineminus">-  if (showTrayIcon)</span>
<a href="#l22.694"></a><span id="l22.694" class="difflineminus">-  {</span>
<a href="#l22.695"></a><span id="l22.695" class="difflineplus">+  if (showTrayIcon) {</span>
<a href="#l22.696"></a><span id="l22.696">     GenericShellNotify(NIM_ADD);</span>
<a href="#l22.697"></a><span id="l22.697">     mBiffIconVisible = true;</span>
<a href="#l22.698"></a><span id="l22.698">   }</span>
<a href="#l22.699"></a><span id="l22.699">   mSuppressBiffIcon = false;</span>
<a href="#l22.700"></a><span id="l22.700">   mAlertInProgress = false;</span>
<a href="#l22.701"></a><span id="l22.701">   return NS_OK;</span>
<a href="#l22.702"></a><span id="l22.702"> }</span>
<a href="#l22.703"></a><span id="l22.703"> </span>
<a href="#l22.704"></a><span id="l22.704" class="difflineminus">-nsresult nsMessengerWinIntegration::AlertClicked()</span>
<a href="#l22.705"></a><span id="l22.705" class="difflineminus">-{</span>
<a href="#l22.706"></a><span id="l22.706" class="difflineplus">+nsresult nsMessengerWinIntegration::AlertClicked() {</span>
<a href="#l22.707"></a><span id="l22.707">   nsresult rv;</span>
<a href="#l22.708"></a><span id="l22.708" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l22.709"></a><span id="l22.709" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.710"></a><span id="l22.710" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l22.711"></a><span id="l22.711" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l22.712"></a><span id="l22.712" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.713"></a><span id="l22.713">   nsCOMPtr&lt;nsIMsgWindow&gt; topMostMsgWindow;</span>
<a href="#l22.714"></a><span id="l22.714">   rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMostMsgWindow));</span>
<a href="#l22.715"></a><span id="l22.715" class="difflineminus">-  if (topMostMsgWindow)</span>
<a href="#l22.716"></a><span id="l22.716" class="difflineminus">-  {</span>
<a href="#l22.717"></a><span id="l22.717" class="difflineplus">+  if (topMostMsgWindow) {</span>
<a href="#l22.718"></a><span id="l22.718">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l22.719"></a><span id="l22.719">     topMostMsgWindow-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l22.720"></a><span id="l22.720" class="difflineminus">-    if (domWindow)</span>
<a href="#l22.721"></a><span id="l22.721" class="difflineminus">-    {</span>
<a href="#l22.722"></a><span id="l22.722" class="difflineplus">+    if (domWindow) {</span>
<a href="#l22.723"></a><span id="l22.723">       activateWindow(domWindow);</span>
<a href="#l22.724"></a><span id="l22.724">       return NS_OK;</span>
<a href="#l22.725"></a><span id="l22.725">     }</span>
<a href="#l22.726"></a><span id="l22.726">   }</span>
<a href="#l22.727"></a><span id="l22.727" class="difflineminus">-  // make sure we don't insert the icon in the system tray since the user clicked on the alert.</span>
<a href="#l22.728"></a><span id="l22.728" class="difflineplus">+  // make sure we don't insert the icon in the system tray since the user</span>
<a href="#l22.729"></a><span id="l22.729" class="difflineplus">+  // clicked on the alert.</span>
<a href="#l22.730"></a><span id="l22.730">   mSuppressBiffIcon = true;</span>
<a href="#l22.731"></a><span id="l22.731">   nsCString folderURI;</span>
<a href="#l22.732"></a><span id="l22.732">   GetFirstFolderWithNewMail(folderURI);</span>
<a href="#l22.733"></a><span id="l22.733">   openMailWindow(folderURI);</span>
<a href="#l22.734"></a><span id="l22.734">   return NS_OK;</span>
<a href="#l22.735"></a><span id="l22.735"> }</span>
<a href="#l22.736"></a><span id="l22.736"> </span>
<a href="#l22.737"></a><span id="l22.737"> #ifdef MOZ_SUITE</span>
<a href="#l22.738"></a><span id="l22.738" class="difflineminus">-nsresult nsMessengerWinIntegration::AlertClickedSimple()</span>
<a href="#l22.739"></a><span id="l22.739" class="difflineminus">-{</span>
<a href="#l22.740"></a><span id="l22.740" class="difflineplus">+nsresult nsMessengerWinIntegration::AlertClickedSimple() {</span>
<a href="#l22.741"></a><span id="l22.741">   mSuppressBiffIcon = true;</span>
<a href="#l22.742"></a><span id="l22.742">   return NS_OK;</span>
<a href="#l22.743"></a><span id="l22.743"> }</span>
<a href="#l22.744"></a><span id="l22.744"> #endif</span>
<a href="#l22.745"></a><span id="l22.745"> </span>
<a href="#l22.746"></a><span id="l22.746"> NS_IMETHODIMP</span>
<a href="#l22.747"></a><span id="l22.747" class="difflineminus">-nsMessengerWinIntegration::Observe(nsISupports* aSubject, const char* aTopic, const char16_t* aData)</span>
<a href="#l22.748"></a><span id="l22.748" class="difflineminus">-{</span>
<a href="#l22.749"></a><span id="l22.749" class="difflineminus">-  if (strcmp(aTopic, &quot;alertfinished&quot;) == 0)</span>
<a href="#l22.750"></a><span id="l22.750" class="difflineminus">-      return AlertFinished();</span>
<a href="#l22.751"></a><span id="l22.751" class="difflineplus">+nsMessengerWinIntegration::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l22.752"></a><span id="l22.752" class="difflineplus">+                                   const char16_t *aData) {</span>
<a href="#l22.753"></a><span id="l22.753" class="difflineplus">+  if (strcmp(aTopic, &quot;alertfinished&quot;) == 0) return AlertFinished();</span>
<a href="#l22.754"></a><span id="l22.754"> </span>
<a href="#l22.755"></a><span id="l22.755" class="difflineminus">-  if (strcmp(aTopic, &quot;alertclickcallback&quot;) == 0)</span>
<a href="#l22.756"></a><span id="l22.756" class="difflineminus">-      return AlertClicked();</span>
<a href="#l22.757"></a><span id="l22.757" class="difflineplus">+  if (strcmp(aTopic, &quot;alertclickcallback&quot;) == 0) return AlertClicked();</span>
<a href="#l22.758"></a><span id="l22.758"> </span>
<a href="#l22.759"></a><span id="l22.759"> #ifdef MOZ_SUITE</span>
<a href="#l22.760"></a><span id="l22.760">   // SeaMonkey does most of the GUI work in JS code when clicking on a mail</span>
<a href="#l22.761"></a><span id="l22.761">   // notification, so it needs an extra function here</span>
<a href="#l22.762"></a><span id="l22.762">   if (strcmp(aTopic, &quot;alertclicksimplecallback&quot;) == 0)</span>
<a href="#l22.763"></a><span id="l22.763" class="difflineminus">-      return AlertClickedSimple();</span>
<a href="#l22.764"></a><span id="l22.764" class="difflineplus">+    return AlertClickedSimple();</span>
<a href="#l22.765"></a><span id="l22.765"> #endif</span>
<a href="#l22.766"></a><span id="l22.766"> </span>
<a href="#l22.767"></a><span id="l22.767">   return NS_OK;</span>
<a href="#l22.768"></a><span id="l22.768"> }</span>
<a href="#l22.769"></a><span id="l22.769"> </span>
<a href="#l22.770"></a><span id="l22.770" class="difflineminus">-static void EscapeAmpersands(nsString&amp; aToolTip)</span>
<a href="#l22.771"></a><span id="l22.771" class="difflineminus">-{</span>
<a href="#l22.772"></a><span id="l22.772" class="difflineplus">+static void EscapeAmpersands(nsString &amp;aToolTip) {</span>
<a href="#l22.773"></a><span id="l22.773">   // First, check to see whether we have any ampersands.</span>
<a href="#l22.774"></a><span id="l22.774">   int32_t pos = aToolTip.FindChar('&amp;');</span>
<a href="#l22.775"></a><span id="l22.775" class="difflineminus">-  if (pos == kNotFound)</span>
<a href="#l22.776"></a><span id="l22.776" class="difflineminus">-    return;</span>
<a href="#l22.777"></a><span id="l22.777" class="difflineplus">+  if (pos == kNotFound) return;</span>
<a href="#l22.778"></a><span id="l22.778"> </span>
<a href="#l22.779"></a><span id="l22.779">   // Next, see if we only have bare ampersands.</span>
<a href="#l22.780"></a><span id="l22.780">   pos = MsgFind(aToolTip, &quot;&amp;&amp;&quot;, false, pos);</span>
<a href="#l22.781"></a><span id="l22.781"> </span>
<a href="#l22.782"></a><span id="l22.782">   // Windows tooltip code removes one ampersand from each run,</span>
<a href="#l22.783"></a><span id="l22.783">   // then collapses pairs of amperands. This means that in the easy case,</span>
<a href="#l22.784"></a><span id="l22.784">   // we need to replace each ampersand with three.</span>
<a href="#l22.785"></a><span id="l22.785" class="difflineminus">-  MsgReplaceSubstring(aToolTip, NS_LITERAL_STRING(&quot;&amp;&quot;), NS_LITERAL_STRING(&quot;&amp;&amp;&amp;&quot;));</span>
<a href="#l22.786"></a><span id="l22.786" class="difflineminus">-  if (pos == kNotFound)</span>
<a href="#l22.787"></a><span id="l22.787" class="difflineminus">-    return;</span>
<a href="#l22.788"></a><span id="l22.788" class="difflineplus">+  MsgReplaceSubstring(aToolTip, NS_LITERAL_STRING(&quot;&amp;&quot;),</span>
<a href="#l22.789"></a><span id="l22.789" class="difflineplus">+                      NS_LITERAL_STRING(&quot;&amp;&amp;&amp;&quot;));</span>
<a href="#l22.790"></a><span id="l22.790" class="difflineplus">+  if (pos == kNotFound) return;</span>
<a href="#l22.791"></a><span id="l22.791"> </span>
<a href="#l22.792"></a><span id="l22.792">   // We inserted too many ampersands. Remove some.</span>
<a href="#l22.793"></a><span id="l22.793">   for (;;) {</span>
<a href="#l22.794"></a><span id="l22.794">     pos = MsgFind(aToolTip, &quot;&amp;&amp;&amp;&amp;&amp;&amp;&quot;, false, pos);</span>
<a href="#l22.795"></a><span id="l22.795" class="difflineminus">-    if (pos == kNotFound)</span>
<a href="#l22.796"></a><span id="l22.796" class="difflineminus">-      return;</span>
<a href="#l22.797"></a><span id="l22.797" class="difflineplus">+    if (pos == kNotFound) return;</span>
<a href="#l22.798"></a><span id="l22.798"> </span>
<a href="#l22.799"></a><span id="l22.799">     aToolTip.Cut(pos, 1);</span>
<a href="#l22.800"></a><span id="l22.800">     pos += 2;</span>
<a href="#l22.801"></a><span id="l22.801">   }</span>
<a href="#l22.802"></a><span id="l22.802"> }</span>
<a href="#l22.803"></a><span id="l22.803"> </span>
<a href="#l22.804"></a><span id="l22.804" class="difflineminus">-void nsMessengerWinIntegration::FillToolTipInfo()</span>
<a href="#l22.805"></a><span id="l22.805" class="difflineminus">-{</span>
<a href="#l22.806"></a><span id="l22.806" class="difflineplus">+void nsMessengerWinIntegration::FillToolTipInfo() {</span>
<a href="#l22.807"></a><span id="l22.807">   // iterate over all the folders in mFoldersWithNewMail</span>
<a href="#l22.808"></a><span id="l22.808">   nsString accountName;</span>
<a href="#l22.809"></a><span id="l22.809">   nsCString hostName;</span>
<a href="#l22.810"></a><span id="l22.810">   nsString toolTipLine;</span>
<a href="#l22.811"></a><span id="l22.811">   nsAutoString toolTipText;</span>
<a href="#l22.812"></a><span id="l22.812">   nsAutoString animatedAlertText;</span>
<a href="#l22.813"></a><span id="l22.813">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l22.814"></a><span id="l22.814">   nsWeakPtr weakReference;</span>
<a href="#l22.815"></a><span id="l22.815">   int32_t numNewMessages = 0;</span>
<a href="#l22.816"></a><span id="l22.816"> </span>
<a href="#l22.817"></a><span id="l22.817">   uint32_t count = 0;</span>
<a href="#l22.818"></a><span id="l22.818">   NS_ENSURE_SUCCESS_VOID(mFoldersWithNewMail-&gt;GetLength(&amp;count));</span>
<a href="#l22.819"></a><span id="l22.819"> </span>
<a href="#l22.820"></a><span id="l22.820" class="difflineminus">-  for (uint32_t index = 0; index &lt; count; index++)</span>
<a href="#l22.821"></a><span id="l22.821" class="difflineminus">-  {</span>
<a href="#l22.822"></a><span id="l22.822" class="difflineplus">+  for (uint32_t index = 0; index &lt; count; index++) {</span>
<a href="#l22.823"></a><span id="l22.823">     weakReference = do_QueryElementAt(mFoldersWithNewMail, index);</span>
<a href="#l22.824"></a><span id="l22.824">     folder = do_QueryReferent(weakReference);</span>
<a href="#l22.825"></a><span id="l22.825" class="difflineminus">-    if (folder)</span>
<a href="#l22.826"></a><span id="l22.826" class="difflineminus">-    {</span>
<a href="#l22.827"></a><span id="l22.827" class="difflineplus">+    if (folder) {</span>
<a href="#l22.828"></a><span id="l22.828">       folder-&gt;GetPrettyName(accountName);</span>
<a href="#l22.829"></a><span id="l22.829"> </span>
<a href="#l22.830"></a><span id="l22.830">       numNewMessages = 0;</span>
<a href="#l22.831"></a><span id="l22.831">       folder-&gt;GetNumNewMessages(true, &amp;numNewMessages);</span>
<a href="#l22.832"></a><span id="l22.832">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l22.833"></a><span id="l22.833">       GetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l22.834"></a><span id="l22.834" class="difflineminus">-      if (bundle)</span>
<a href="#l22.835"></a><span id="l22.835" class="difflineminus">-      {</span>
<a href="#l22.836"></a><span id="l22.836" class="difflineplus">+      if (bundle) {</span>
<a href="#l22.837"></a><span id="l22.837">         nsAutoString numNewMsgsText;</span>
<a href="#l22.838"></a><span id="l22.838">         numNewMsgsText.AppendInt(numNewMessages);</span>
<a href="#l22.839"></a><span id="l22.839"> </span>
<a href="#l22.840"></a><span id="l22.840" class="difflineminus">-        const char16_t *formatStrings[] =</span>
<a href="#l22.841"></a><span id="l22.841" class="difflineminus">-        {</span>
<a href="#l22.842"></a><span id="l22.842" class="difflineminus">-          numNewMsgsText.get(),</span>
<a href="#l22.843"></a><span id="l22.843" class="difflineplus">+        const char16_t *formatStrings[] = {</span>
<a href="#l22.844"></a><span id="l22.844" class="difflineplus">+            numNewMsgsText.get(),</span>
<a href="#l22.845"></a><span id="l22.845">         };</span>
<a href="#l22.846"></a><span id="l22.846"> </span>
<a href="#l22.847"></a><span id="l22.847">         nsString finalText;</span>
<a href="#l22.848"></a><span id="l22.848">         if (numNewMessages == 1)</span>
<a href="#l22.849"></a><span id="l22.849" class="difflineminus">-          bundle-&gt;FormatStringFromName(&quot;biffNotification_message&quot;, formatStrings, 1, finalText);</span>
<a href="#l22.850"></a><span id="l22.850" class="difflineplus">+          bundle-&gt;FormatStringFromName(&quot;biffNotification_message&quot;,</span>
<a href="#l22.851"></a><span id="l22.851" class="difflineplus">+                                       formatStrings, 1, finalText);</span>
<a href="#l22.852"></a><span id="l22.852">         else</span>
<a href="#l22.853"></a><span id="l22.853" class="difflineminus">-          bundle-&gt;FormatStringFromName(&quot;biffNotification_messages&quot;, formatStrings, 1, finalText);</span>
<a href="#l22.854"></a><span id="l22.854" class="difflineplus">+          bundle-&gt;FormatStringFromName(&quot;biffNotification_messages&quot;,</span>
<a href="#l22.855"></a><span id="l22.855" class="difflineplus">+                                       formatStrings, 1, finalText);</span>
<a href="#l22.856"></a><span id="l22.856"> </span>
<a href="#l22.857"></a><span id="l22.857" class="difflineminus">-        // the alert message is special...we actually only want to show the first account with</span>
<a href="#l22.858"></a><span id="l22.858" class="difflineminus">-        // new mail in the alert.</span>
<a href="#l22.859"></a><span id="l22.859" class="difflineminus">-        if (animatedAlertText.IsEmpty()) // if we haven't filled in the animated alert text yet</span>
<a href="#l22.860"></a><span id="l22.860" class="difflineplus">+        // the alert message is special...we actually only want to show the</span>
<a href="#l22.861"></a><span id="l22.861" class="difflineplus">+        // first account with new mail in the alert.</span>
<a href="#l22.862"></a><span id="l22.862" class="difflineplus">+        if (animatedAlertText.IsEmpty())  // if we haven't filled in the</span>
<a href="#l22.863"></a><span id="l22.863" class="difflineplus">+                                          // animated alert text yet</span>
<a href="#l22.864"></a><span id="l22.864">           animatedAlertText = finalText;</span>
<a href="#l22.865"></a><span id="l22.865"> </span>
<a href="#l22.866"></a><span id="l22.866">         toolTipLine.Append(accountName);</span>
<a href="#l22.867"></a><span id="l22.867">         toolTipLine.Append(' ');</span>
<a href="#l22.868"></a><span id="l22.868">         toolTipLine.Append(finalText);</span>
<a href="#l22.869"></a><span id="l22.869">         EscapeAmpersands(toolTipLine);</span>
<a href="#l22.870"></a><span id="l22.870"> </span>
<a href="#l22.871"></a><span id="l22.871">         // only add this new string if it will fit without truncation....</span>
<a href="#l22.872"></a><span id="l22.872">         if (toolTipLine.Length() + toolTipText.Length() &lt;= kMaxTooltipSize)</span>
<a href="#l22.873"></a><span id="l22.873">           toolTipText.Append(toolTipLine);</span>
<a href="#l22.874"></a><span id="l22.874"> </span>
<a href="#l22.875"></a><span id="l22.875">         // clear out the tooltip line for the next folder</span>
<a href="#l22.876"></a><span id="l22.876">         toolTipLine.Assign('\n');</span>
<a href="#l22.877"></a><span id="l22.877" class="difflineminus">-      } // if we got a bundle</span>
<a href="#l22.878"></a><span id="l22.878" class="difflineminus">-    } // if we got a folder</span>
<a href="#l22.879"></a><span id="l22.879" class="difflineminus">-  } // for each folder</span>
<a href="#l22.880"></a><span id="l22.880" class="difflineplus">+      }  // if we got a bundle</span>
<a href="#l22.881"></a><span id="l22.881" class="difflineplus">+    }    // if we got a folder</span>
<a href="#l22.882"></a><span id="l22.882" class="difflineplus">+  }      // for each folder</span>
<a href="#l22.883"></a><span id="l22.883"> </span>
<a href="#l22.884"></a><span id="l22.884" class="difflineminus">-  ::wcsncpy( sBiffIconData.szTip, toolTipText.get(), kMaxTooltipSize);</span>
<a href="#l22.885"></a><span id="l22.885" class="difflineplus">+  ::wcsncpy(sBiffIconData.szTip, toolTipText.get(), kMaxTooltipSize);</span>
<a href="#l22.886"></a><span id="l22.886"> </span>
<a href="#l22.887"></a><span id="l22.887" class="difflineminus">-  if (!mBiffIconVisible)</span>
<a href="#l22.888"></a><span id="l22.888" class="difflineminus">-  {</span>
<a href="#l22.889"></a><span id="l22.889" class="difflineplus">+  if (!mBiffIconVisible) {</span>
<a href="#l22.890"></a><span id="l22.890"> #ifndef MOZ_THUNDERBIRD</span>
<a href="#l22.891"></a><span id="l22.891" class="difflineminus">-  nsresult rv;</span>
<a href="#l22.892"></a><span id="l22.892" class="difflineminus">-  bool showNewAlert = false;</span>
<a href="#l22.893"></a><span id="l22.893" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.894"></a><span id="l22.894" class="difflineminus">-  NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l22.895"></a><span id="l22.895" class="difflineplus">+    nsresult rv;</span>
<a href="#l22.896"></a><span id="l22.896" class="difflineplus">+    bool showNewAlert = false;</span>
<a href="#l22.897"></a><span id="l22.897" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l22.898"></a><span id="l22.898" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.899"></a><span id="l22.899" class="difflineplus">+    NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l22.900"></a><span id="l22.900"> </span>
<a href="#l22.901"></a><span id="l22.901" class="difflineminus">-  prefBranch-&gt;GetBoolPref(SHOW_NEW_ALERT_PREF, &amp;showNewAlert);</span>
<a href="#l22.902"></a><span id="l22.902" class="difflineminus">-  if (!showNewAlert)</span>
<a href="#l22.903"></a><span id="l22.903" class="difflineminus">-    ShowAlertMessage(accountName, animatedAlertText, EmptyCString());</span>
<a href="#l22.904"></a><span id="l22.904" class="difflineminus">-  else</span>
<a href="#l22.905"></a><span id="l22.905" class="difflineplus">+    prefBranch-&gt;GetBoolPref(SHOW_NEW_ALERT_PREF, &amp;showNewAlert);</span>
<a href="#l22.906"></a><span id="l22.906" class="difflineplus">+    if (!showNewAlert)</span>
<a href="#l22.907"></a><span id="l22.907" class="difflineplus">+      ShowAlertMessage(accountName, animatedAlertText, EmptyCString());</span>
<a href="#l22.908"></a><span id="l22.908" class="difflineplus">+    else</span>
<a href="#l22.909"></a><span id="l22.909"> #endif</span>
<a href="#l22.910"></a><span id="l22.910" class="difflineminus">-    ShowNewAlertNotification(false, accountName, animatedAlertText);</span>
<a href="#l22.911"></a><span id="l22.911" class="difflineminus">-  }</span>
<a href="#l22.912"></a><span id="l22.912" class="difflineminus">-  else</span>
<a href="#l22.913"></a><span id="l22.913" class="difflineminus">-   GenericShellNotify( NIM_MODIFY);</span>
<a href="#l22.914"></a><span id="l22.914" class="difflineplus">+      ShowNewAlertNotification(false, accountName, animatedAlertText);</span>
<a href="#l22.915"></a><span id="l22.915" class="difflineplus">+  } else</span>
<a href="#l22.916"></a><span id="l22.916" class="difflineplus">+    GenericShellNotify(NIM_MODIFY);</span>
<a href="#l22.917"></a><span id="l22.917"> }</span>
<a href="#l22.918"></a><span id="l22.918"> </span>
<a href="#l22.919"></a><span id="l22.919" class="difflineminus">-// Get the first top level folder which we know has new mail, then enumerate over</span>
<a href="#l22.920"></a><span id="l22.920" class="difflineminus">-// all the subfolders looking for the first real folder with new mail.</span>
<a href="#l22.921"></a><span id="l22.921" class="difflineplus">+// Get the first top level folder which we know has new mail, then enumerate</span>
<a href="#l22.922"></a><span id="l22.922" class="difflineplus">+// over all the subfolders looking for the first real folder with new mail.</span>
<a href="#l22.923"></a><span id="l22.923"> // Return the folderURI for that folder.</span>
<a href="#l22.924"></a><span id="l22.924" class="difflineminus">-nsresult nsMessengerWinIntegration::GetFirstFolderWithNewMail(nsACString&amp; aFolderURI)</span>
<a href="#l22.925"></a><span id="l22.925" class="difflineminus">-{</span>
<a href="#l22.926"></a><span id="l22.926" class="difflineplus">+nsresult nsMessengerWinIntegration::GetFirstFolderWithNewMail(</span>
<a href="#l22.927"></a><span id="l22.927" class="difflineplus">+    nsACString &amp;aFolderURI) {</span>
<a href="#l22.928"></a><span id="l22.928">   NS_ENSURE_TRUE(mFoldersWithNewMail, NS_ERROR_FAILURE);</span>
<a href="#l22.929"></a><span id="l22.929"> </span>
<a href="#l22.930"></a><span id="l22.930">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l22.931"></a><span id="l22.931">   nsWeakPtr weakReference;</span>
<a href="#l22.932"></a><span id="l22.932">   int32_t numNewMessages = 0;</span>
<a href="#l22.933"></a><span id="l22.933"> </span>
<a href="#l22.934"></a><span id="l22.934">   uint32_t count = 0;</span>
<a href="#l22.935"></a><span id="l22.935">   nsresult rv = mFoldersWithNewMail-&gt;GetLength(&amp;count);</span>
<a href="#l22.936"></a><span id="l22.936" class="difflineminus">-  if (NS_FAILED(rv) || !count)  // kick out if we don't have any folders with new mail</span>
<a href="#l22.937"></a><span id="l22.937" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.938"></a><span id="l22.938" class="difflineplus">+  // kick out if we don't have any folders with new mail</span>
<a href="#l22.939"></a><span id="l22.939" class="difflineplus">+  if (NS_FAILED(rv) || !count) return NS_OK;</span>
<a href="#l22.940"></a><span id="l22.940"> </span>
<a href="#l22.941"></a><span id="l22.941">   weakReference = do_QueryElementAt(mFoldersWithNewMail, 0);</span>
<a href="#l22.942"></a><span id="l22.942">   folder = do_QueryReferent(weakReference);</span>
<a href="#l22.943"></a><span id="l22.943"> </span>
<a href="#l22.944"></a><span id="l22.944" class="difflineminus">-  if (folder)</span>
<a href="#l22.945"></a><span id="l22.945" class="difflineminus">-  {</span>
<a href="#l22.946"></a><span id="l22.946" class="difflineplus">+  if (folder) {</span>
<a href="#l22.947"></a><span id="l22.947">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l22.948"></a><span id="l22.948" class="difflineminus">-    // enumerate over the folders under this root folder till we find one with new mail....</span>
<a href="#l22.949"></a><span id="l22.949" class="difflineplus">+    // enumerate over the folders under this root folder till we find one with</span>
<a href="#l22.950"></a><span id="l22.950" class="difflineplus">+    // new mail....</span>
<a href="#l22.951"></a><span id="l22.951">     nsCOMPtr&lt;nsIArray&gt; allFolders;</span>
<a href="#l22.952"></a><span id="l22.952">     rv = folder-&gt;GetDescendants(getter_AddRefs(allFolders));</span>
<a href="#l22.953"></a><span id="l22.953">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.954"></a><span id="l22.954"> </span>
<a href="#l22.955"></a><span id="l22.955">     nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l22.956"></a><span id="l22.956">     rv = allFolders-&gt;Enumerate(getter_AddRefs(enumerator));</span>
<a href="#l22.957"></a><span id="l22.957" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l22.958"></a><span id="l22.958" class="difflineminus">-    {</span>
<a href="#l22.959"></a><span id="l22.959" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l22.960"></a><span id="l22.960">       nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l22.961"></a><span id="l22.961">       bool hasMore = false;</span>
<a href="#l22.962"></a><span id="l22.962" class="difflineminus">-      while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l22.963"></a><span id="l22.963" class="difflineminus">-      {</span>
<a href="#l22.964"></a><span id="l22.964" class="difflineplus">+      while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l22.965"></a><span id="l22.965">         rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l22.966"></a><span id="l22.966" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l22.967"></a><span id="l22.967" class="difflineminus">-        {</span>
<a href="#l22.968"></a><span id="l22.968" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l22.969"></a><span id="l22.969">           msgFolder = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l22.970"></a><span id="l22.970" class="difflineminus">-          if (msgFolder)</span>
<a href="#l22.971"></a><span id="l22.971" class="difflineminus">-          {</span>
<a href="#l22.972"></a><span id="l22.972" class="difflineplus">+          if (msgFolder) {</span>
<a href="#l22.973"></a><span id="l22.973">             numNewMessages = 0;</span>
<a href="#l22.974"></a><span id="l22.974">             msgFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l22.975"></a><span id="l22.975" class="difflineminus">-            if (numNewMessages)</span>
<a href="#l22.976"></a><span id="l22.976" class="difflineminus">-              break; // kick out of the while loop</span>
<a href="#l22.977"></a><span id="l22.977" class="difflineplus">+            if (numNewMessages) break;  // kick out of the while loop</span>
<a href="#l22.978"></a><span id="l22.978">           }</span>
<a href="#l22.979"></a><span id="l22.979" class="difflineminus">-        } // if we have a folder</span>
<a href="#l22.980"></a><span id="l22.980" class="difflineminus">-      }  // if we have more potential folders to enumerate</span>
<a href="#l22.981"></a><span id="l22.981" class="difflineminus">-    }  // if enumerator</span>
<a href="#l22.982"></a><span id="l22.982" class="difflineplus">+        }  // if we have a folder</span>
<a href="#l22.983"></a><span id="l22.983" class="difflineplus">+      }    // if we have more potential folders to enumerate</span>
<a href="#l22.984"></a><span id="l22.984" class="difflineplus">+    }      // if enumerator</span>
<a href="#l22.985"></a><span id="l22.985"> </span>
<a href="#l22.986"></a><span id="l22.986" class="difflineminus">-    if (msgFolder)</span>
<a href="#l22.987"></a><span id="l22.987" class="difflineminus">-      msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l22.988"></a><span id="l22.988" class="difflineplus">+    if (msgFolder) msgFolder-&gt;GetURI(aFolderURI);</span>
<a href="#l22.989"></a><span id="l22.989">   }</span>
<a href="#l22.990"></a><span id="l22.990"> </span>
<a href="#l22.991"></a><span id="l22.991">   return NS_OK;</span>
<a href="#l22.992"></a><span id="l22.992"> }</span>
<a href="#l22.993"></a><span id="l22.993"> </span>
<a href="#l22.994"></a><span id="l22.994" class="difflineminus">-void nsMessengerWinIntegration::DestroyBiffIcon()</span>
<a href="#l22.995"></a><span id="l22.995" class="difflineminus">-{</span>
<a href="#l22.996"></a><span id="l22.996" class="difflineplus">+void nsMessengerWinIntegration::DestroyBiffIcon() {</span>
<a href="#l22.997"></a><span id="l22.997">   GenericShellNotify(NIM_DELETE);</span>
<a href="#l22.998"></a><span id="l22.998" class="difflineminus">-  // Don't call DestroyIcon().  see http://bugzilla.mozilla.org/show_bug.cgi?id=134745</span>
<a href="#l22.999"></a><span id="l22.999" class="difflineplus">+  // Don't call DestroyIcon().</span>
<a href="#l22.1000"></a><span id="l22.1000" class="difflineplus">+  // See http://bugzilla.mozilla.org/show_bug.cgi?id=134745</span>
<a href="#l22.1001"></a><span id="l22.1001"> }</span>
<a href="#l22.1002"></a><span id="l22.1002"> </span>
<a href="#l22.1003"></a><span id="l22.1003" class="difflineminus">-void nsMessengerWinIntegration::GenericShellNotify(DWORD aMessage)</span>
<a href="#l22.1004"></a><span id="l22.1004" class="difflineminus">-{</span>
<a href="#l22.1005"></a><span id="l22.1005" class="difflineminus">-  ::Shell_NotifyIconW( aMessage, &amp;sBiffIconData );</span>
<a href="#l22.1006"></a><span id="l22.1006" class="difflineplus">+void nsMessengerWinIntegration::GenericShellNotify(DWORD aMessage) {</span>
<a href="#l22.1007"></a><span id="l22.1007" class="difflineplus">+  ::Shell_NotifyIconW(aMessage, &amp;sBiffIconData);</span>
<a href="#l22.1008"></a><span id="l22.1008"> }</span>
<a href="#l22.1009"></a><span id="l22.1009"> </span>
<a href="#l22.1010"></a><span id="l22.1010"> NS_IMETHODIMP</span>
<a href="#l22.1011"></a><span id="l22.1011" class="difflineminus">-nsMessengerWinIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l22.1012"></a><span id="l22.1012" class="difflineminus">-{</span>
<a href="#l22.1013"></a><span id="l22.1013" class="difflineplus">+nsMessengerWinIntegration::OnItemPropertyFlagChanged(nsIMsgDBHdr *item,</span>
<a href="#l22.1014"></a><span id="l22.1014" class="difflineplus">+                                                     const nsACString &amp;property,</span>
<a href="#l22.1015"></a><span id="l22.1015" class="difflineplus">+                                                     uint32_t oldFlag,</span>
<a href="#l22.1016"></a><span id="l22.1016" class="difflineplus">+                                                     uint32_t newFlag) {</span>
<a href="#l22.1017"></a><span id="l22.1017">   return NS_OK;</span>
<a href="#l22.1018"></a><span id="l22.1018"> }</span>
<a href="#l22.1019"></a><span id="l22.1019"> </span>
<a href="#l22.1020"></a><span id="l22.1020"> NS_IMETHODIMP</span>
<a href="#l22.1021"></a><span id="l22.1021" class="difflineminus">-nsMessengerWinIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *)</span>
<a href="#l22.1022"></a><span id="l22.1022" class="difflineminus">-{</span>
<a href="#l22.1023"></a><span id="l22.1023" class="difflineplus">+nsMessengerWinIntegration::OnItemAdded(nsIMsgFolder *, nsISupports *) {</span>
<a href="#l22.1024"></a><span id="l22.1024">   return NS_OK;</span>
<a href="#l22.1025"></a><span id="l22.1025"> }</span>
<a href="#l22.1026"></a><span id="l22.1026"> </span>
<a href="#l22.1027"></a><span id="l22.1027"> NS_IMETHODIMP</span>
<a href="#l22.1028"></a><span id="l22.1028" class="difflineminus">-nsMessengerWinIntegration::OnItemBoolPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l22.1029"></a><span id="l22.1029" class="difflineminus">-                                                         const nsACString &amp;aProperty,</span>
<a href="#l22.1030"></a><span id="l22.1030" class="difflineminus">-                                                         bool aOldValue,</span>
<a href="#l22.1031"></a><span id="l22.1031" class="difflineminus">-                                                         bool aNewValue)</span>
<a href="#l22.1032"></a><span id="l22.1032" class="difflineminus">-{</span>
<a href="#l22.1033"></a><span id="l22.1033" class="difflineplus">+nsMessengerWinIntegration::OnItemBoolPropertyChanged(</span>
<a href="#l22.1034"></a><span id="l22.1034" class="difflineplus">+    nsIMsgFolder *aItem, const nsACString &amp;aProperty, bool aOldValue,</span>
<a href="#l22.1035"></a><span id="l22.1035" class="difflineplus">+    bool aNewValue) {</span>
<a href="#l22.1036"></a><span id="l22.1036">   if (aProperty.Equals(kDefaultServer)) {</span>
<a href="#l22.1037"></a><span id="l22.1037">     nsresult rv;</span>
<a href="#l22.1038"></a><span id="l22.1038"> </span>
<a href="#l22.1039"></a><span id="l22.1039">     // this property changes multiple times</span>
<a href="#l22.1040"></a><span id="l22.1040">     // on account deletion or when the user changes their</span>
<a href="#l22.1041"></a><span id="l22.1041">     // default account.  ResetCurrent() will set</span>
<a href="#l22.1042"></a><span id="l22.1042">     // mInboxURI to null, so we use that</span>
<a href="#l22.1043"></a><span id="l22.1043">     // to prevent us from attempting to remove</span>
<a href="#l22.1044"></a><span id="l22.1044">     // something from the registry that has already been removed</span>
<a href="#l22.1045"></a><span id="l22.1045">     if (!mInboxURI.IsEmpty() &amp;&amp; !mEmail.IsEmpty()) {</span>
<a href="#l22.1046"></a><span id="l22.1046">       rv = RemoveCurrentFromRegistry();</span>
<a href="#l22.1047"></a><span id="l22.1047" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1048"></a><span id="l22.1048" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1049"></a><span id="l22.1049">     }</span>
<a href="#l22.1050"></a><span id="l22.1050"> </span>
<a href="#l22.1051"></a><span id="l22.1051">     // reset so we'll go get the new default server next time</span>
<a href="#l22.1052"></a><span id="l22.1052">     rv = ResetCurrent();</span>
<a href="#l22.1053"></a><span id="l22.1053" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1054"></a><span id="l22.1054" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1055"></a><span id="l22.1055"> </span>
<a href="#l22.1056"></a><span id="l22.1056">     rv = UpdateUnreadCount();</span>
<a href="#l22.1057"></a><span id="l22.1057" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1058"></a><span id="l22.1058" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1059"></a><span id="l22.1059">   }</span>
<a href="#l22.1060"></a><span id="l22.1060">   return NS_OK;</span>
<a href="#l22.1061"></a><span id="l22.1061"> }</span>
<a href="#l22.1062"></a><span id="l22.1062"> </span>
<a href="#l22.1063"></a><span id="l22.1063"> NS_IMETHODIMP</span>
<a href="#l22.1064"></a><span id="l22.1064" class="difflineminus">-nsMessengerWinIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;)</span>
<a href="#l22.1065"></a><span id="l22.1065" class="difflineminus">-{</span>
<a href="#l22.1066"></a><span id="l22.1066" class="difflineplus">+nsMessengerWinIntegration::OnItemEvent(nsIMsgFolder *, const nsACString &amp;) {</span>
<a href="#l22.1067"></a><span id="l22.1067">   return NS_OK;</span>
<a href="#l22.1068"></a><span id="l22.1068"> }</span>
<a href="#l22.1069"></a><span id="l22.1069"> </span>
<a href="#l22.1070"></a><span id="l22.1070"> NS_IMETHODIMP</span>
<a href="#l22.1071"></a><span id="l22.1071" class="difflineminus">-nsMessengerWinIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aItem, const nsACString &amp;aProperty, int64_t aOldValue, int64_t aNewValue)</span>
<a href="#l22.1072"></a><span id="l22.1072" class="difflineminus">-{</span>
<a href="#l22.1073"></a><span id="l22.1073" class="difflineplus">+nsMessengerWinIntegration::OnItemIntPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l22.1074"></a><span id="l22.1074" class="difflineplus">+                                                    const nsACString &amp;aProperty,</span>
<a href="#l22.1075"></a><span id="l22.1075" class="difflineplus">+                                                    int64_t aOldValue,</span>
<a href="#l22.1076"></a><span id="l22.1076" class="difflineplus">+                                                    int64_t aNewValue) {</span>
<a href="#l22.1077"></a><span id="l22.1077">   // if we got new mail show a icon in the system tray</span>
<a href="#l22.1078"></a><span id="l22.1078" class="difflineminus">-  if (aProperty.Equals(kBiffState) &amp;&amp; mFoldersWithNewMail)</span>
<a href="#l22.1079"></a><span id="l22.1079" class="difflineminus">-  {</span>
<a href="#l22.1080"></a><span id="l22.1080" class="difflineplus">+  if (aProperty.Equals(kBiffState) &amp;&amp; mFoldersWithNewMail) {</span>
<a href="#l22.1081"></a><span id="l22.1081">     nsWeakPtr weakFolder = do_GetWeakReference(aItem);</span>
<a href="#l22.1082"></a><span id="l22.1082">     uint32_t indexInNewArray;</span>
<a href="#l22.1083"></a><span id="l22.1083">     nsresult rv = mFoldersWithNewMail-&gt;IndexOf(0, weakFolder, &amp;indexInNewArray);</span>
<a href="#l22.1084"></a><span id="l22.1084">     bool folderFound = NS_SUCCEEDED(rv);</span>
<a href="#l22.1085"></a><span id="l22.1085"> </span>
<a href="#l22.1086"></a><span id="l22.1086" class="difflineminus">-    if (!mBiffIconInitialized)</span>
<a href="#l22.1087"></a><span id="l22.1087" class="difflineminus">-      InitializeBiffStatusIcon();</span>
<a href="#l22.1088"></a><span id="l22.1088" class="difflineplus">+    if (!mBiffIconInitialized) InitializeBiffStatusIcon();</span>
<a href="#l22.1089"></a><span id="l22.1089"> </span>
<a href="#l22.1090"></a><span id="l22.1090" class="difflineminus">-    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l22.1091"></a><span id="l22.1091" class="difflineminus">-    {</span>
<a href="#l22.1092"></a><span id="l22.1092" class="difflineplus">+    if (aNewValue == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l22.1093"></a><span id="l22.1093">       // if the icon is not already visible, only show a system tray icon iff</span>
<a href="#l22.1094"></a><span id="l22.1094">       // we are performing biff (as opposed to the user getting new mail)</span>
<a href="#l22.1095"></a><span id="l22.1095" class="difflineminus">-      if (!mBiffIconVisible)</span>
<a href="#l22.1096"></a><span id="l22.1096" class="difflineminus">-      {</span>
<a href="#l22.1097"></a><span id="l22.1097" class="difflineplus">+      if (!mBiffIconVisible) {</span>
<a href="#l22.1098"></a><span id="l22.1098">         bool performingBiff = false;</span>
<a href="#l22.1099"></a><span id="l22.1099">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l22.1100"></a><span id="l22.1100">         aItem-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l22.1101"></a><span id="l22.1101" class="difflineminus">-        if (server)</span>
<a href="#l22.1102"></a><span id="l22.1102" class="difflineminus">-          server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l22.1103"></a><span id="l22.1103" class="difflineminus">-        if (!performingBiff)</span>
<a href="#l22.1104"></a><span id="l22.1104" class="difflineminus">-          return NS_OK; // kick out right now...</span>
<a href="#l22.1105"></a><span id="l22.1105" class="difflineplus">+        if (server) server-&gt;GetPerformingBiff(&amp;performingBiff);</span>
<a href="#l22.1106"></a><span id="l22.1106" class="difflineplus">+        if (!performingBiff) return NS_OK;  // kick out right now...</span>
<a href="#l22.1107"></a><span id="l22.1107">       }</span>
<a href="#l22.1108"></a><span id="l22.1108" class="difflineminus">-      if (!folderFound)</span>
<a href="#l22.1109"></a><span id="l22.1109" class="difflineminus">-        mFoldersWithNewMail-&gt;InsertElementAt(weakFolder, 0);</span>
<a href="#l22.1110"></a><span id="l22.1110" class="difflineplus">+      if (!folderFound) mFoldersWithNewMail-&gt;InsertElementAt(weakFolder, 0);</span>
<a href="#l22.1111"></a><span id="l22.1111">       // now regenerate the tooltip</span>
<a href="#l22.1112"></a><span id="l22.1112">       FillToolTipInfo();</span>
<a href="#l22.1113"></a><span id="l22.1113" class="difflineminus">-    }</span>
<a href="#l22.1114"></a><span id="l22.1114" class="difflineminus">-    else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail)</span>
<a href="#l22.1115"></a><span id="l22.1115" class="difflineminus">-    {</span>
<a href="#l22.1116"></a><span id="l22.1116" class="difflineminus">-      // we are always going to remove the icon whenever we get our first no mail</span>
<a href="#l22.1117"></a><span id="l22.1117" class="difflineminus">-      // notification.</span>
<a href="#l22.1118"></a><span id="l22.1118" class="difflineplus">+    } else if (aNewValue == nsIMsgFolder::nsMsgBiffState_NoMail) {</span>
<a href="#l22.1119"></a><span id="l22.1119" class="difflineplus">+      // we are always going to remove the icon whenever we get our first no</span>
<a href="#l22.1120"></a><span id="l22.1120" class="difflineplus">+      // mail notification.</span>
<a href="#l22.1121"></a><span id="l22.1121"> </span>
<a href="#l22.1122"></a><span id="l22.1122" class="difflineminus">-      // avoid a race condition where we are told to remove the icon before we've actually</span>
<a href="#l22.1123"></a><span id="l22.1123" class="difflineminus">-      // added it to the system tray. This happens when the user reads a new message before</span>
<a href="#l22.1124"></a><span id="l22.1124" class="difflineminus">-      // the animated alert has gone away.</span>
<a href="#l22.1125"></a><span id="l22.1125" class="difflineminus">-      if (mAlertInProgress)</span>
<a href="#l22.1126"></a><span id="l22.1126" class="difflineminus">-        mSuppressBiffIcon = true;</span>
<a href="#l22.1127"></a><span id="l22.1127" class="difflineplus">+      // avoid a race condition where we are told to remove the icon before</span>
<a href="#l22.1128"></a><span id="l22.1128" class="difflineplus">+      // we've actually added it to the system tray. This happens when the user</span>
<a href="#l22.1129"></a><span id="l22.1129" class="difflineplus">+      // reads a new message before the animated alert has gone away.</span>
<a href="#l22.1130"></a><span id="l22.1130" class="difflineplus">+      if (mAlertInProgress) mSuppressBiffIcon = true;</span>
<a href="#l22.1131"></a><span id="l22.1131"> </span>
<a href="#l22.1132"></a><span id="l22.1132" class="difflineminus">-      if (folderFound)</span>
<a href="#l22.1133"></a><span id="l22.1133" class="difflineminus">-        mFoldersWithNewMail-&gt;RemoveElementAt(indexInNewArray);</span>
<a href="#l22.1134"></a><span id="l22.1134" class="difflineminus">-      if (mBiffIconVisible)</span>
<a href="#l22.1135"></a><span id="l22.1135" class="difflineminus">-      {</span>
<a href="#l22.1136"></a><span id="l22.1136" class="difflineplus">+      if (folderFound) mFoldersWithNewMail-&gt;RemoveElementAt(indexInNewArray);</span>
<a href="#l22.1137"></a><span id="l22.1137" class="difflineplus">+      if (mBiffIconVisible) {</span>
<a href="#l22.1138"></a><span id="l22.1138">         mBiffIconVisible = false;</span>
<a href="#l22.1139"></a><span id="l22.1139">         GenericShellNotify(NIM_DELETE);</span>
<a href="#l22.1140"></a><span id="l22.1140">       }</span>
<a href="#l22.1141"></a><span id="l22.1141">     }</span>
<a href="#l22.1142"></a><span id="l22.1142" class="difflineminus">-  } // if the biff property changed</span>
<a href="#l22.1143"></a><span id="l22.1143" class="difflineplus">+  }  // if the biff property changed</span>
<a href="#l22.1144"></a><span id="l22.1144"> </span>
<a href="#l22.1145"></a><span id="l22.1145">   if (aProperty.Equals(kTotalUnreadMessages)) {</span>
<a href="#l22.1146"></a><span id="l22.1146">     nsCString itemURI;</span>
<a href="#l22.1147"></a><span id="l22.1147">     nsresult rv;</span>
<a href="#l22.1148"></a><span id="l22.1148">     rv = aItem-&gt;GetURI(itemURI);</span>
<a href="#l22.1149"></a><span id="l22.1149" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1150"></a><span id="l22.1150" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1151"></a><span id="l22.1151"> </span>
<a href="#l22.1152"></a><span id="l22.1152" class="difflineminus">-    if (mInboxURI.Equals(itemURI))</span>
<a href="#l22.1153"></a><span id="l22.1153" class="difflineminus">-      mCurrentUnreadCount = aNewValue;</span>
<a href="#l22.1154"></a><span id="l22.1154" class="difflineplus">+    if (mInboxURI.Equals(itemURI)) mCurrentUnreadCount = aNewValue;</span>
<a href="#l22.1155"></a><span id="l22.1155"> </span>
<a href="#l22.1156"></a><span id="l22.1156">     // If the timer isn't running yet, then we immediately update the</span>
<a href="#l22.1157"></a><span id="l22.1157">     // registry and then start a one-shot timer. If the Unread counter</span>
<a href="#l22.1158"></a><span id="l22.1158">     // has toggled zero / nonzero, we also update immediately.</span>
<a href="#l22.1159"></a><span id="l22.1159">     // Otherwise, if the timer is running, defer the update. This means</span>
<a href="#l22.1160"></a><span id="l22.1160">     // that all counter updates that occur within the timer interval are</span>
<a href="#l22.1161"></a><span id="l22.1161">     // batched into a single registry update, to avoid hitting the</span>
<a href="#l22.1162"></a><span id="l22.1162">     // registry too frequently. We also do a final update on shutdown,</span>
<a href="#l22.1163"></a><span id="l22.1163">     // regardless of the timer.</span>
<a href="#l22.1164"></a><span id="l22.1164">     if (!mUnreadTimerActive ||</span>
<a href="#l22.1165"></a><span id="l22.1165" class="difflineminus">-         (!mCurrentUnreadCount &amp;&amp; mLastUnreadCountWrittenToRegistry) ||</span>
<a href="#l22.1166"></a><span id="l22.1166" class="difflineminus">-         (mCurrentUnreadCount &amp;&amp; mLastUnreadCountWrittenToRegistry &lt; 1)) {</span>
<a href="#l22.1167"></a><span id="l22.1167" class="difflineplus">+        (!mCurrentUnreadCount &amp;&amp; mLastUnreadCountWrittenToRegistry) ||</span>
<a href="#l22.1168"></a><span id="l22.1168" class="difflineplus">+        (mCurrentUnreadCount &amp;&amp; mLastUnreadCountWrittenToRegistry &lt; 1)) {</span>
<a href="#l22.1169"></a><span id="l22.1169">       rv = UpdateUnreadCount();</span>
<a href="#l22.1170"></a><span id="l22.1170" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1171"></a><span id="l22.1171" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1172"></a><span id="l22.1172">       // If timer wasn't running, start it.</span>
<a href="#l22.1173"></a><span id="l22.1173" class="difflineminus">-      if (!mUnreadTimerActive)</span>
<a href="#l22.1174"></a><span id="l22.1174" class="difflineminus">-        rv = SetupUnreadCountUpdateTimer();</span>
<a href="#l22.1175"></a><span id="l22.1175" class="difflineplus">+      if (!mUnreadTimerActive) rv = SetupUnreadCountUpdateTimer();</span>
<a href="#l22.1176"></a><span id="l22.1176">     }</span>
<a href="#l22.1177"></a><span id="l22.1177">   }</span>
<a href="#l22.1178"></a><span id="l22.1178">   return NS_OK;</span>
<a href="#l22.1179"></a><span id="l22.1179"> }</span>
<a href="#l22.1180"></a><span id="l22.1180"> </span>
<a href="#l22.1181"></a><span id="l22.1181" class="difflineminus">-void</span>
<a href="#l22.1182"></a><span id="l22.1182" class="difflineminus">-nsMessengerWinIntegration::OnUnreadCountUpdateTimer(nsITimer *timer, void *osIntegration)</span>
<a href="#l22.1183"></a><span id="l22.1183" class="difflineminus">-{</span>
<a href="#l22.1184"></a><span id="l22.1184" class="difflineminus">-  nsMessengerWinIntegration *winIntegration = (nsMessengerWinIntegration*)osIntegration;</span>
<a href="#l22.1185"></a><span id="l22.1185" class="difflineplus">+void nsMessengerWinIntegration::OnUnreadCountUpdateTimer(nsITimer *timer,</span>
<a href="#l22.1186"></a><span id="l22.1186" class="difflineplus">+                                                         void *osIntegration) {</span>
<a href="#l22.1187"></a><span id="l22.1187" class="difflineplus">+  nsMessengerWinIntegration *winIntegration =</span>
<a href="#l22.1188"></a><span id="l22.1188" class="difflineplus">+      (nsMessengerWinIntegration *)osIntegration;</span>
<a href="#l22.1189"></a><span id="l22.1189"> </span>
<a href="#l22.1190"></a><span id="l22.1190">   winIntegration-&gt;mUnreadTimerActive = false;</span>
<a href="#l22.1191"></a><span id="l22.1191">   mozilla::DebugOnly&lt;nsresult&gt; rv = winIntegration-&gt;UpdateUnreadCount();</span>
<a href="#l22.1192"></a><span id="l22.1192">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;updating unread count failed&quot;);</span>
<a href="#l22.1193"></a><span id="l22.1193"> }</span>
<a href="#l22.1194"></a><span id="l22.1194"> </span>
<a href="#l22.1195"></a><span id="l22.1195" class="difflineminus">-nsresult</span>
<a href="#l22.1196"></a><span id="l22.1196" class="difflineminus">-nsMessengerWinIntegration::RemoveCurrentFromRegistry()</span>
<a href="#l22.1197"></a><span id="l22.1197" class="difflineminus">-{</span>
<a href="#l22.1198"></a><span id="l22.1198" class="difflineminus">-  // If Windows XP, open the registry and get rid of old account registry entries</span>
<a href="#l22.1199"></a><span id="l22.1199" class="difflineminus">-  // If there is a email prefix, get it and use it to build the registry key.</span>
<a href="#l22.1200"></a><span id="l22.1200" class="difflineminus">-  // Otherwise, just the email address will be the registry key.</span>
<a href="#l22.1201"></a><span id="l22.1201" class="difflineplus">+nsresult nsMessengerWinIntegration::RemoveCurrentFromRegistry() {</span>
<a href="#l22.1202"></a><span id="l22.1202" class="difflineplus">+  // If Windows XP, open the registry and get rid of old account registry</span>
<a href="#l22.1203"></a><span id="l22.1203" class="difflineplus">+  // entries If there is a email prefix, get it and use it to build the registry</span>
<a href="#l22.1204"></a><span id="l22.1204" class="difflineplus">+  // key. Otherwise, just the email address will be the registry key.</span>
<a href="#l22.1205"></a><span id="l22.1205">   nsAutoString currentUnreadMailCountKey;</span>
<a href="#l22.1206"></a><span id="l22.1206">   if (!mEmailPrefix.IsEmpty()) {</span>
<a href="#l22.1207"></a><span id="l22.1207">     currentUnreadMailCountKey.Assign(mEmailPrefix);</span>
<a href="#l22.1208"></a><span id="l22.1208">     currentUnreadMailCountKey.Append(NS_ConvertASCIItoUTF16(mEmail));</span>
<a href="#l22.1209"></a><span id="l22.1209" class="difflineminus">-  }</span>
<a href="#l22.1210"></a><span id="l22.1210" class="difflineminus">-  else</span>
<a href="#l22.1211"></a><span id="l22.1211" class="difflineplus">+  } else</span>
<a href="#l22.1212"></a><span id="l22.1212">     CopyASCIItoUTF16(mEmail, currentUnreadMailCountKey);</span>
<a href="#l22.1213"></a><span id="l22.1213"> </span>
<a href="#l22.1214"></a><span id="l22.1214">   WCHAR registryUnreadMailCountKey[_MAX_PATH] = {0};</span>
<a href="#l22.1215"></a><span id="l22.1215">   // Enumerate through registry entries to delete the key matching</span>
<a href="#l22.1216"></a><span id="l22.1216">   // currentUnreadMailCountKey</span>
<a href="#l22.1217"></a><span id="l22.1217">   int index = 0;</span>
<a href="#l22.1218"></a><span id="l22.1218" class="difflineminus">-  while (SUCCEEDED(SHEnumerateUnreadMailAccountsW(HKEY_CURRENT_USER,</span>
<a href="#l22.1219"></a><span id="l22.1219" class="difflineminus">-                                                  index,</span>
<a href="#l22.1220"></a><span id="l22.1220" class="difflineminus">-                                                  registryUnreadMailCountKey,</span>
<a href="#l22.1221"></a><span id="l22.1221" class="difflineminus">-                                                  sizeof(registryUnreadMailCountKey))))</span>
<a href="#l22.1222"></a><span id="l22.1222" class="difflineminus">-  {</span>
<a href="#l22.1223"></a><span id="l22.1223" class="difflineminus">-    if (wcscmp(registryUnreadMailCountKey, currentUnreadMailCountKey.get())==0) {</span>
<a href="#l22.1224"></a><span id="l22.1224" class="difflineplus">+  while (SUCCEEDED(SHEnumerateUnreadMailAccountsW(</span>
<a href="#l22.1225"></a><span id="l22.1225" class="difflineplus">+      HKEY_CURRENT_USER, index, registryUnreadMailCountKey,</span>
<a href="#l22.1226"></a><span id="l22.1226" class="difflineplus">+      sizeof(registryUnreadMailCountKey)))) {</span>
<a href="#l22.1227"></a><span id="l22.1227" class="difflineplus">+    if (wcscmp(registryUnreadMailCountKey, currentUnreadMailCountKey.get()) ==</span>
<a href="#l22.1228"></a><span id="l22.1228" class="difflineplus">+        0) {</span>
<a href="#l22.1229"></a><span id="l22.1229">       nsAutoString deleteKey;</span>
<a href="#l22.1230"></a><span id="l22.1230">       deleteKey.Assign(UNREADMAILNODEKEY);</span>
<a href="#l22.1231"></a><span id="l22.1231">       deleteKey.Append(currentUnreadMailCountKey.get());</span>
<a href="#l22.1232"></a><span id="l22.1232"> </span>
<a href="#l22.1233"></a><span id="l22.1233">       if (!deleteKey.IsEmpty()) {</span>
<a href="#l22.1234"></a><span id="l22.1234">         // delete this key and berak out of the loop</span>
<a href="#l22.1235"></a><span id="l22.1235" class="difflineminus">-        RegDeleteKey(HKEY_CURRENT_USER,</span>
<a href="#l22.1236"></a><span id="l22.1236" class="difflineminus">-                     NS_ConvertUTF16toUTF8(deleteKey).get());</span>
<a href="#l22.1237"></a><span id="l22.1237" class="difflineplus">+        RegDeleteKey(HKEY_CURRENT_USER, NS_ConvertUTF16toUTF8(deleteKey).get());</span>
<a href="#l22.1238"></a><span id="l22.1238">         break;</span>
<a href="#l22.1239"></a><span id="l22.1239" class="difflineminus">-      }</span>
<a href="#l22.1240"></a><span id="l22.1240" class="difflineminus">-      else {</span>
<a href="#l22.1241"></a><span id="l22.1241" class="difflineplus">+      } else {</span>
<a href="#l22.1242"></a><span id="l22.1242">         index++;</span>
<a href="#l22.1243"></a><span id="l22.1243">       }</span>
<a href="#l22.1244"></a><span id="l22.1244" class="difflineminus">-    }</span>
<a href="#l22.1245"></a><span id="l22.1245" class="difflineminus">-    else {</span>
<a href="#l22.1246"></a><span id="l22.1246" class="difflineplus">+    } else {</span>
<a href="#l22.1247"></a><span id="l22.1247">       index++;</span>
<a href="#l22.1248"></a><span id="l22.1248">     }</span>
<a href="#l22.1249"></a><span id="l22.1249">   }</span>
<a href="#l22.1250"></a><span id="l22.1250">   return NS_OK;</span>
<a href="#l22.1251"></a><span id="l22.1251"> }</span>
<a href="#l22.1252"></a><span id="l22.1252"> </span>
<a href="#l22.1253"></a><span id="l22.1253" class="difflineminus">-nsresult</span>
<a href="#l22.1254"></a><span id="l22.1254" class="difflineminus">-nsMessengerWinIntegration::UpdateRegistryWithCurrent()</span>
<a href="#l22.1255"></a><span id="l22.1255" class="difflineminus">-{</span>
<a href="#l22.1256"></a><span id="l22.1256" class="difflineminus">-  if (mInboxURI.IsEmpty() || mEmail.IsEmpty())</span>
<a href="#l22.1257"></a><span id="l22.1257" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.1258"></a><span id="l22.1258" class="difflineplus">+nsresult nsMessengerWinIntegration::UpdateRegistryWithCurrent() {</span>
<a href="#l22.1259"></a><span id="l22.1259" class="difflineplus">+  if (mInboxURI.IsEmpty() || mEmail.IsEmpty()) return NS_OK;</span>
<a href="#l22.1260"></a><span id="l22.1260"> </span>
<a href="#l22.1261"></a><span id="l22.1261">   // only update the registry if the count has changed</span>
<a href="#l22.1262"></a><span id="l22.1262">   // and if the unread count is valid</span>
<a href="#l22.1263"></a><span id="l22.1263" class="difflineminus">-  if ((mCurrentUnreadCount &lt; 0) || (mCurrentUnreadCount == mLastUnreadCountWrittenToRegistry))</span>
<a href="#l22.1264"></a><span id="l22.1264" class="difflineplus">+  if ((mCurrentUnreadCount &lt; 0) ||</span>
<a href="#l22.1265"></a><span id="l22.1265" class="difflineplus">+      (mCurrentUnreadCount == mLastUnreadCountWrittenToRegistry))</span>
<a href="#l22.1266"></a><span id="l22.1266">     return NS_OK;</span>
<a href="#l22.1267"></a><span id="l22.1267"> </span>
<a href="#l22.1268"></a><span id="l22.1268">   // commandliner has to be built in the form of statement</span>
<a href="#l22.1269"></a><span id="l22.1269">   // which can be open the mailer app to the default user account</span>
<a href="#l22.1270"></a><span id="l22.1270">   // For given profile 'foo', commandliner will be built as</span>
<a href="#l22.1271"></a><span id="l22.1271">   // &quot;&quot;&lt;absolute path to application&gt;&quot; -p foo -mail&quot; where absolute</span>
<a href="#l22.1272"></a><span id="l22.1272">   // path to application is extracted from mAppName</span>
<a href="#l22.1273"></a><span id="l22.1273">   nsAutoString commandLinerForAppLaunch;</span>
<a href="#l22.1274"></a><span id="l22.1274" class="difflineat">@@ -999,139 +940,125 @@ nsMessengerWinIntegration::UpdateRegistr</span>
<a href="#l22.1275"></a><span id="l22.1275">   commandLinerForAppLaunch.Append(mAppName);</span>
<a href="#l22.1276"></a><span id="l22.1276">   commandLinerForAppLaunch.Append(DOUBLE_QUOTE);</span>
<a href="#l22.1277"></a><span id="l22.1277">   commandLinerForAppLaunch.AppendLiteral(PROFILE_COMMANDLINE_ARG);</span>
<a href="#l22.1278"></a><span id="l22.1278">   commandLinerForAppLaunch.Append(DOUBLE_QUOTE);</span>
<a href="#l22.1279"></a><span id="l22.1279">   commandLinerForAppLaunch.Append(mProfilePath);</span>
<a href="#l22.1280"></a><span id="l22.1280">   commandLinerForAppLaunch.Append(DOUBLE_QUOTE);</span>
<a href="#l22.1281"></a><span id="l22.1281">   commandLinerForAppLaunch.AppendLiteral(MAIL_COMMANDLINE_ARG);</span>
<a href="#l22.1282"></a><span id="l22.1282"> </span>
<a href="#l22.1283"></a><span id="l22.1283" class="difflineminus">-  if (!commandLinerForAppLaunch.IsEmpty())</span>
<a href="#l22.1284"></a><span id="l22.1284" class="difflineminus">-  {</span>
<a href="#l22.1285"></a><span id="l22.1285" class="difflineplus">+  if (!commandLinerForAppLaunch.IsEmpty()) {</span>
<a href="#l22.1286"></a><span id="l22.1286">     nsAutoString pBuffer;</span>
<a href="#l22.1287"></a><span id="l22.1287"> </span>
<a href="#l22.1288"></a><span id="l22.1288">     if (!mEmailPrefix.IsEmpty()) {</span>
<a href="#l22.1289"></a><span id="l22.1289">       pBuffer.Assign(mEmailPrefix);</span>
<a href="#l22.1290"></a><span id="l22.1290">       pBuffer.Append(NS_ConvertASCIItoUTF16(mEmail));</span>
<a href="#l22.1291"></a><span id="l22.1291" class="difflineminus">-    }</span>
<a href="#l22.1292"></a><span id="l22.1292" class="difflineminus">-    else</span>
<a href="#l22.1293"></a><span id="l22.1293" class="difflineplus">+    } else</span>
<a href="#l22.1294"></a><span id="l22.1294">       CopyASCIItoUTF16(mEmail, pBuffer);</span>
<a href="#l22.1295"></a><span id="l22.1295"> </span>
<a href="#l22.1296"></a><span id="l22.1296">     // Write the info into the registry</span>
<a href="#l22.1297"></a><span id="l22.1297" class="difflineminus">-    SHSetUnreadMailCountW(pBuffer.get(),</span>
<a href="#l22.1298"></a><span id="l22.1298" class="difflineminus">-                          mCurrentUnreadCount,</span>
<a href="#l22.1299"></a><span id="l22.1299" class="difflineplus">+    SHSetUnreadMailCountW(pBuffer.get(), mCurrentUnreadCount,</span>
<a href="#l22.1300"></a><span id="l22.1300">                           commandLinerForAppLaunch.get());</span>
<a href="#l22.1301"></a><span id="l22.1301">   }</span>
<a href="#l22.1302"></a><span id="l22.1302"> </span>
<a href="#l22.1303"></a><span id="l22.1303">   // do this last</span>
<a href="#l22.1304"></a><span id="l22.1304">   mLastUnreadCountWrittenToRegistry = mCurrentUnreadCount;</span>
<a href="#l22.1305"></a><span id="l22.1305"> </span>
<a href="#l22.1306"></a><span id="l22.1306">   return NS_OK;</span>
<a href="#l22.1307"></a><span id="l22.1307"> }</span>
<a href="#l22.1308"></a><span id="l22.1308"> </span>
<a href="#l22.1309"></a><span id="l22.1309" class="difflineminus">-nsresult</span>
<a href="#l22.1310"></a><span id="l22.1310" class="difflineminus">-nsMessengerWinIntegration::SetupInbox()</span>
<a href="#l22.1311"></a><span id="l22.1311" class="difflineminus">-{</span>
<a href="#l22.1312"></a><span id="l22.1312" class="difflineplus">+nsresult nsMessengerWinIntegration::SetupInbox() {</span>
<a href="#l22.1313"></a><span id="l22.1313">   nsresult rv;</span>
<a href="#l22.1314"></a><span id="l22.1314"> </span>
<a href="#l22.1315"></a><span id="l22.1315">   // get default account</span>
<a href="#l22.1316"></a><span id="l22.1316" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.1317"></a><span id="l22.1317" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.1318"></a><span id="l22.1318" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1319"></a><span id="l22.1319" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.1320"></a><span id="l22.1320" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.1321"></a><span id="l22.1321" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1322"></a><span id="l22.1322"> </span>
<a href="#l22.1323"></a><span id="l22.1323" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l22.1324"></a><span id="l22.1324" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l22.1325"></a><span id="l22.1325">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(account));</span>
<a href="#l22.1326"></a><span id="l22.1326">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1327"></a><span id="l22.1327">   if (!account) {</span>
<a href="#l22.1328"></a><span id="l22.1328">     // this can happen if we launch mail on a new profile</span>
<a href="#l22.1329"></a><span id="l22.1329">     // we don't have a default account yet</span>
<a href="#l22.1330"></a><span id="l22.1330">     mDefaultAccountMightHaveAnInbox = false;</span>
<a href="#l22.1331"></a><span id="l22.1331">     return NS_OK;</span>
<a href="#l22.1332"></a><span id="l22.1332">   }</span>
<a href="#l22.1333"></a><span id="l22.1333"> </span>
<a href="#l22.1334"></a><span id="l22.1334">   // get incoming server</span>
<a href="#l22.1335"></a><span id="l22.1335" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l22.1336"></a><span id="l22.1336" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l22.1337"></a><span id="l22.1337">   rv = account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l22.1338"></a><span id="l22.1338" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1339"></a><span id="l22.1339" class="difflineminus">-  if (!server)</span>
<a href="#l22.1340"></a><span id="l22.1340" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l22.1341"></a><span id="l22.1341" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1342"></a><span id="l22.1342" class="difflineplus">+  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l22.1343"></a><span id="l22.1343"> </span>
<a href="#l22.1344"></a><span id="l22.1344">   nsCString type;</span>
<a href="#l22.1345"></a><span id="l22.1345">   rv = server-&gt;GetType(type);</span>
<a href="#l22.1346"></a><span id="l22.1346" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1347"></a><span id="l22.1347" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1348"></a><span id="l22.1348"> </span>
<a href="#l22.1349"></a><span id="l22.1349">   // we only care about imap and pop3</span>
<a href="#l22.1350"></a><span id="l22.1350">   if (type.EqualsLiteral(&quot;imap&quot;) || type.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l22.1351"></a><span id="l22.1351">     // imap and pop3 account should have an Inbox</span>
<a href="#l22.1352"></a><span id="l22.1352">     mDefaultAccountMightHaveAnInbox = true;</span>
<a href="#l22.1353"></a><span id="l22.1353"> </span>
<a href="#l22.1354"></a><span id="l22.1354">     mEmailPrefix.Truncate();</span>
<a href="#l22.1355"></a><span id="l22.1355"> </span>
<a href="#l22.1356"></a><span id="l22.1356">     // Get user's email address</span>
<a href="#l22.1357"></a><span id="l22.1357">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l22.1358"></a><span id="l22.1358">     rv = account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l22.1359"></a><span id="l22.1359" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1360"></a><span id="l22.1360" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1361"></a><span id="l22.1361"> </span>
<a href="#l22.1362"></a><span id="l22.1362" class="difflineminus">-    if (!identity)</span>
<a href="#l22.1363"></a><span id="l22.1363" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l22.1364"></a><span id="l22.1364" class="difflineplus">+    if (!identity) return NS_ERROR_FAILURE;</span>
<a href="#l22.1365"></a><span id="l22.1365"> </span>
<a href="#l22.1366"></a><span id="l22.1366">     rv = identity-&gt;GetEmail(mEmail);</span>
<a href="#l22.1367"></a><span id="l22.1367" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1368"></a><span id="l22.1368" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1369"></a><span id="l22.1369"> </span>
<a href="#l22.1370"></a><span id="l22.1370">     nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l22.1371"></a><span id="l22.1371">     rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l22.1372"></a><span id="l22.1372" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1373"></a><span id="l22.1373" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1374"></a><span id="l22.1374"> </span>
<a href="#l22.1375"></a><span id="l22.1375" class="difflineminus">-    if (!rootMsgFolder)</span>
<a href="#l22.1376"></a><span id="l22.1376" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l22.1377"></a><span id="l22.1377" class="difflineplus">+    if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l22.1378"></a><span id="l22.1378"> </span>
<a href="#l22.1379"></a><span id="l22.1379" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l22.1380"></a><span id="l22.1380" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder;</span>
<a href="#l22.1381"></a><span id="l22.1381">     rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l22.1382"></a><span id="l22.1382">                                       getter_AddRefs(inboxFolder));</span>
<a href="#l22.1383"></a><span id="l22.1383">     NS_ENSURE_TRUE(inboxFolder, NS_ERROR_FAILURE);</span>
<a href="#l22.1384"></a><span id="l22.1384"> </span>
<a href="#l22.1385"></a><span id="l22.1385">     rv = inboxFolder-&gt;GetURI(mInboxURI);</span>
<a href="#l22.1386"></a><span id="l22.1386" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1387"></a><span id="l22.1387" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1388"></a><span id="l22.1388"> </span>
<a href="#l22.1389"></a><span id="l22.1389">     rv = inboxFolder-&gt;GetNumUnread(false, &amp;mCurrentUnreadCount);</span>
<a href="#l22.1390"></a><span id="l22.1390" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1391"></a><span id="l22.1391" class="difflineminus">-  }</span>
<a href="#l22.1392"></a><span id="l22.1392" class="difflineminus">-  else {</span>
<a href="#l22.1393"></a><span id="l22.1393" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1394"></a><span id="l22.1394" class="difflineplus">+  } else {</span>
<a href="#l22.1395"></a><span id="l22.1395">     // the default account is valid, but it's not something</span>
<a href="#l22.1396"></a><span id="l22.1396">     // that we expect to have an inbox.  (local folders, news accounts)</span>
<a href="#l22.1397"></a><span id="l22.1397">     // set this flag to avoid calling SetupInbox() every time</span>
<a href="#l22.1398"></a><span id="l22.1398">     // the timer goes off.</span>
<a href="#l22.1399"></a><span id="l22.1399">     mDefaultAccountMightHaveAnInbox = false;</span>
<a href="#l22.1400"></a><span id="l22.1400">   }</span>
<a href="#l22.1401"></a><span id="l22.1401"> </span>
<a href="#l22.1402"></a><span id="l22.1402">   return NS_OK;</span>
<a href="#l22.1403"></a><span id="l22.1403"> }</span>
<a href="#l22.1404"></a><span id="l22.1404"> </span>
<a href="#l22.1405"></a><span id="l22.1405" class="difflineminus">-nsresult</span>
<a href="#l22.1406"></a><span id="l22.1406" class="difflineminus">-nsMessengerWinIntegration::UpdateUnreadCount()</span>
<a href="#l22.1407"></a><span id="l22.1407" class="difflineminus">-{</span>
<a href="#l22.1408"></a><span id="l22.1408" class="difflineplus">+nsresult nsMessengerWinIntegration::UpdateUnreadCount() {</span>
<a href="#l22.1409"></a><span id="l22.1409">   nsresult rv;</span>
<a href="#l22.1410"></a><span id="l22.1410"> </span>
<a href="#l22.1411"></a><span id="l22.1411">   if (mDefaultAccountMightHaveAnInbox &amp;&amp; mInboxURI.IsEmpty()) {</span>
<a href="#l22.1412"></a><span id="l22.1412">     rv = SetupInbox();</span>
<a href="#l22.1413"></a><span id="l22.1413" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.1414"></a><span id="l22.1414" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.1415"></a><span id="l22.1415">   }</span>
<a href="#l22.1416"></a><span id="l22.1416"> </span>
<a href="#l22.1417"></a><span id="l22.1417">   return UpdateRegistryWithCurrent();</span>
<a href="#l22.1418"></a><span id="l22.1418"> }</span>
<a href="#l22.1419"></a><span id="l22.1419"> </span>
<a href="#l22.1420"></a><span id="l22.1420" class="difflineminus">-nsresult</span>
<a href="#l22.1421"></a><span id="l22.1421" class="difflineminus">-nsMessengerWinIntegration::SetupUnreadCountUpdateTimer()</span>
<a href="#l22.1422"></a><span id="l22.1422" class="difflineminus">-{</span>
<a href="#l22.1423"></a><span id="l22.1423" class="difflineplus">+nsresult nsMessengerWinIntegration::SetupUnreadCountUpdateTimer() {</span>
<a href="#l22.1424"></a><span id="l22.1424">   mUnreadTimerActive = true;</span>
<a href="#l22.1425"></a><span id="l22.1425">   if (mUnreadCountUpdateTimer)</span>
<a href="#l22.1426"></a><span id="l22.1426">     mUnreadCountUpdateTimer-&gt;Cancel();</span>
<a href="#l22.1427"></a><span id="l22.1427">   else</span>
<a href="#l22.1428"></a><span id="l22.1428">     mUnreadCountUpdateTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l22.1429"></a><span id="l22.1429"> </span>
<a href="#l22.1430"></a><span id="l22.1430" class="difflineminus">-  mUnreadCountUpdateTimer-&gt;InitWithNamedFuncCallback(OnUnreadCountUpdateTimer,</span>
<a href="#l22.1431"></a><span id="l22.1431" class="difflineminus">-                                                     (void *)this,</span>
<a href="#l22.1432"></a><span id="l22.1432" class="difflineminus">-                                                     UNREAD_UPDATE_INTERVAL,</span>
<a href="#l22.1433"></a><span id="l22.1433" class="difflineminus">-                                                     nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l22.1434"></a><span id="l22.1434" class="difflineminus">-                                                     &quot;nsMessengerWinIntegration::OnUnreadCountUpdateTimer&quot;);</span>
<a href="#l22.1435"></a><span id="l22.1435" class="difflineplus">+  mUnreadCountUpdateTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l22.1436"></a><span id="l22.1436" class="difflineplus">+      OnUnreadCountUpdateTimer, (void *)this, UNREAD_UPDATE_INTERVAL,</span>
<a href="#l22.1437"></a><span id="l22.1437" class="difflineplus">+      nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l22.1438"></a><span id="l22.1438" class="difflineplus">+      &quot;nsMessengerWinIntegration::OnUnreadCountUpdateTimer&quot;);</span>
<a href="#l22.1439"></a><span id="l22.1439"> </span>
<a href="#l22.1440"></a><span id="l22.1440">   return NS_OK;</span>
<a href="#l22.1441"></a><span id="l22.1441"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerWinIntegration.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerWinIntegration.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -14,86 +14,94 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsIMessengerOSIntegration.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsITimer.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsString.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#define NS_MESSENGERWININTEGRATION_CID \</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  {0xf62f3d3a, 0x1dd1, 0x11b2, \</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    {0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c}}</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+#define NS_MESSENGERWININTEGRATION_CID               \</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  {                                                  \</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+    0xf62f3d3a, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+      0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c \</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+    }                                                \</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+  }</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22"> class nsIStringBundle;</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24"> class nsMessengerWinIntegration : public nsIMessengerOSIntegration,</span>
<a href="#l23.25"></a><span id="l23.25">                                   public nsIFolderListener,</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-                                  public nsIObserver</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-{</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-public:</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+                                  public nsIObserver {</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+ public:</span>
<a href="#l23.31"></a><span id="l23.31">   nsMessengerWinIntegration();</span>
<a href="#l23.32"></a><span id="l23.32">   virtual nsresult Init();</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34">   NS_DECL_ISUPPORTS</span>
<a href="#l23.35"></a><span id="l23.35">   NS_DECL_NSIMESSENGEROSINTEGRATION</span>
<a href="#l23.36"></a><span id="l23.36">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l23.37"></a><span id="l23.37">   NS_DECL_NSIOBSERVER</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-  nsresult ShowNewAlertNotification(bool aUserInitiated, const nsString&amp; aAlertTitle, const nsString&amp; aAlertText);</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  nsresult ShowNewAlertNotification(bool aUserInitiated,</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+                                    const nsString&amp; aAlertTitle,</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+                                    const nsString&amp; aAlertText);</span>
<a href="#l23.43"></a><span id="l23.43"> #ifndef MOZ_THUNDERBIRD</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  nsresult ShowAlertMessage(const nsString&amp; aAlertTitle, const nsString&amp; aAlertText, const nsACString&amp; aFolderURI);</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+  nsresult ShowAlertMessage(const nsString&amp; aAlertTitle,</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+                            const nsString&amp; aAlertText,</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+                            const nsACString&amp; aFolderURI);</span>
<a href="#l23.48"></a><span id="l23.48"> #endif</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-private:</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+ private:</span>
<a href="#l23.52"></a><span id="l23.52">   virtual ~nsMessengerWinIntegration();</span>
<a href="#l23.53"></a><span id="l23.53">   nsresult AlertFinished();</span>
<a href="#l23.54"></a><span id="l23.54">   nsresult AlertClicked();</span>
<a href="#l23.55"></a><span id="l23.55"> #ifdef MOZ_SUITE</span>
<a href="#l23.56"></a><span id="l23.56">   nsresult AlertClickedSimple();</span>
<a href="#l23.57"></a><span id="l23.57"> #endif</span>
<a href="#l23.58"></a><span id="l23.58"> </span>
<a href="#l23.59"></a><span id="l23.59">   void InitializeBiffStatusIcon();</span>
<a href="#l23.60"></a><span id="l23.60">   void FillToolTipInfo();</span>
<a href="#l23.61"></a><span id="l23.61">   void GenericShellNotify(DWORD aMessage);</span>
<a href="#l23.62"></a><span id="l23.62">   void DestroyBiffIcon();</span>
<a href="#l23.63"></a><span id="l23.63"> </span>
<a href="#l23.64"></a><span id="l23.64">   nsresult GetFirstFolderWithNewMail(nsACString&amp; aFolderURI);</span>
<a href="#l23.65"></a><span id="l23.65"> </span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-  nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mFoldersWithNewMail;  // keep track of all the root folders with pending new mail</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+  nsresult GetStringBundle(nsIStringBundle** aBundle);</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt;</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+      mFoldersWithNewMail;  // keep track of all the root folders with pending</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+                            // new mail</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73">   bool mBiffIconVisible;</span>
<a href="#l23.74"></a><span id="l23.74">   bool mBiffIconInitialized;</span>
<a href="#l23.75"></a><span id="l23.75">   bool mSuppressBiffIcon;</span>
<a href="#l23.76"></a><span id="l23.76">   bool mAlertInProgress;</span>
<a href="#l23.77"></a><span id="l23.77"> </span>
<a href="#l23.78"></a><span id="l23.78">   // &quot;might&quot; because we don't know until we check</span>
<a href="#l23.79"></a><span id="l23.79">   // what type of server is associated with the default account</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-  bool            mDefaultAccountMightHaveAnInbox;</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+  bool mDefaultAccountMightHaveAnInbox;</span>
<a href="#l23.82"></a><span id="l23.82"> </span>
<a href="#l23.83"></a><span id="l23.83">   // True if the timer is running</span>
<a href="#l23.84"></a><span id="l23.84">   bool mUnreadTimerActive;</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86">   nsresult ResetCurrent();</span>
<a href="#l23.87"></a><span id="l23.87">   nsresult RemoveCurrentFromRegistry();</span>
<a href="#l23.88"></a><span id="l23.88">   nsresult UpdateRegistryWithCurrent();</span>
<a href="#l23.89"></a><span id="l23.89">   nsresult SetupInbox();</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   nsresult SetupUnreadCountUpdateTimer();</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  static void OnUnreadCountUpdateTimer(nsITimer *timer, void *osIntegration);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  static void OnUnreadCountUpdateTimer(nsITimer* timer, void* osIntegration);</span>
<a href="#l23.94"></a><span id="l23.94">   nsresult UpdateUnreadCount();</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-  nsCOMPtr &lt;nsITimer&gt; mUnreadCountUpdateTimer;</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; mUnreadCountUpdateTimer;</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99">   nsCString mInboxURI;</span>
<a href="#l23.100"></a><span id="l23.100">   nsCString mEmail;</span>
<a href="#l23.101"></a><span id="l23.101"> </span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-  nsString  mAppName;</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-  nsString  mEmailPrefix;</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+  nsString mAppName;</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+  nsString mEmailPrefix;</span>
<a href="#l23.106"></a><span id="l23.106"> </span>
<a href="#l23.107"></a><span id="l23.107">   nsString mProfilePath;</span>
<a href="#l23.108"></a><span id="l23.108"> </span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  int32_t   mCurrentUnreadCount;</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-  int32_t   mLastUnreadCountWrittenToRegistry;</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+  int32_t mCurrentUnreadCount;</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  int32_t mLastUnreadCountWrittenToRegistry;</span>
<a href="#l23.113"></a><span id="l23.113"> };</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-#endif // __nsMessengerWinIntegration_h</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+#endif  // __nsMessengerWinIntegration_h</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

