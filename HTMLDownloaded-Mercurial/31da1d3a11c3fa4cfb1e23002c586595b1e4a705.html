<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10669:31da1d3a11c3fa4cfb1e23002c586595b1e4a705</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 31da1d3a11c3fa4cfb1e23002c586595b1e4a705" />
<meta property="og:url" content="/comm-central/rev/31da1d3a11c3fa4cfb1e23002c586595b1e4a705" />
<meta property="og:description" content="Bug 773782 - Stop using LL_* macros. r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 31da1d3a11c3fa4cfb1e23002c586595b1e4a705 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">shortlog</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">files</a> |
changeset |
<a href="/comm-central/raw-rev/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">raw</a>  | <a href="/comm-central/archive/31da1d3a11c3fa4cfb1e23002c586595b1e4a705.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=773782">Bug 773782</a> - Stop using LL_* macros. r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Jul 2012 14:26:29 -0500</td></tr>

<tr>
 <td>changeset 10669</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/31da1d3a11c3fa4cfb1e23002c586595b1e4a705">31da1d3a11c3fa4cfb1e23002c586595b1e4a705</a></td>
</tr>



<tr>
<td>parent 10668</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/14b9cf5979a35e253a1e3769a348e2d627b54c91">14b9cf5979a35e253a1e3769a348e2d627b54c91</a>
</td>
</tr>

<tr>
<td>child 10670</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a9f658106adb98c9f846170314afda7dc685a3df">a9f658106adb98c9f846170314afda7dc685a3df</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=31da1d3a11c3fa4cfb1e23002c586595b1e4a705">8054</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 16 Jul 2012 23:03:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@31da1d3a11c3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&newProject=comm-central&newRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&newProject=comm-central&newRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&newProject=comm-central&newRevision=31da1d3a11c3fa4cfb1e23002c586595b1e4a705&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=773782">773782</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=773782">Bug 773782</a> - Stop using LL_* macros. r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">ldap/xpcom/src/nsLDAPService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/ldap/xpcom/src/nsLDAPService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">mailnews/base/public/msgCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/public/msgCore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">mailnews/base/search/src/nsMsgLocalSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgLocalSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">mailnews/base/src/nsMsgBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">mailnews/base/src/nsMsgGroupView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgGroupView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">mailnews/base/src/nsMsgPurgeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgPurgeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">mailnews/base/src/nsMsgStatusFeedback.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgStatusFeedback.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">mailnews/base/src/nsMsgXFViewThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsMsgXFViewThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">mailnews/db/msgdb/src/nsMsgThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/db/msgdb/src/nsMsgThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">mailnews/news/src/nsNewsDownloader.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNewsDownloader.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/31da1d3a11c3fa4cfb1e23002c586595b1e4a705/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -26,21 +26,21 @@ static NS_DEFINE_CID(kLDAPOperationCID, </span>
<a href="#l1.4"></a><span id="l1.4"> // First we provide all the methods for the &quot;local&quot; class</span>
<a href="#l1.5"></a><span id="l1.5"> // nsLDAPServiceEntry.</span>
<a href="#l1.6"></a><span id="l1.6"> //</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // constructor</span>
<a href="#l1.9"></a><span id="l1.9"> //</span>
<a href="#l1.10"></a><span id="l1.10"> nsLDAPServiceEntry::nsLDAPServiceEntry()</span>
<a href="#l1.11"></a><span id="l1.11">     : mLeases(0),</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      mTimestamp(0),</span>
<a href="#l1.13"></a><span id="l1.13">       mDelete(false),</span>
<a href="#l1.14"></a><span id="l1.14">       mRebinding(false)</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    mTimestamp = LL_Zero();</span>
<a href="#l1.18"></a><span id="l1.18"> }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // Init function</span>
<a href="#l1.21"></a><span id="l1.21"> //</span>
<a href="#l1.22"></a><span id="l1.22"> bool nsLDAPServiceEntry::Init()</span>
<a href="#l1.23"></a><span id="l1.23"> {</span>
<a href="#l1.24"></a><span id="l1.24">     return true;</span>
<a href="#l1.25"></a><span id="l1.25"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/migration/src/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -26,18 +26,18 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #define FILE_NAME_PREFS_5X NS_LITERAL_STRING(&quot;prefs.js&quot;)</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.8"></a><span id="l2.8"> // nsNetscapeProfileMigratorBase</span>
<a href="#l2.9"></a><span id="l2.9"> nsNetscapeProfileMigratorBase::nsNetscapeProfileMigratorBase()</span>
<a href="#l2.10"></a><span id="l2.10"> {</span>
<a href="#l2.11"></a><span id="l2.11">   mObserverService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  mMaxProgress = LL_ZERO;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  mCurrentProgress = LL_ZERO;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  mMaxProgress = 0;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  mCurrentProgress = 0;</span>
<a href="#l2.16"></a><span id="l2.16">   mFileCopyTransactionIndex = 0;</span>
<a href="#l2.17"></a><span id="l2.17"> }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> NS_IMPL_ISUPPORTS2(nsNetscapeProfileMigratorBase, nsIMailProfileMigrator,</span>
<a href="#l2.20"></a><span id="l2.20">                    nsITimerCallback)</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> nsresult</span>
<a href="#l2.23"></a><span id="l2.23"> nsNetscapeProfileMigratorBase::GetProfileDataFromProfilesIni(nsIFile* aDataDir,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -344,35 +344,29 @@ nsNetscapeProfileMigratorBase::Notify(ns</span>
<a href="#l2.25"></a><span id="l2.25">   CopyNextFolder();</span>
<a href="#l2.26"></a><span id="l2.26">   return NS_OK;</span>
<a href="#l2.27"></a><span id="l2.27"> }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> void nsNetscapeProfileMigratorBase::CopyNextFolder()</span>
<a href="#l2.30"></a><span id="l2.30"> {</span>
<a href="#l2.31"></a><span id="l2.31">   if (mFileCopyTransactionIndex &lt; mFileCopyTransactions.Length())</span>
<a href="#l2.32"></a><span id="l2.32">   {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    PRUint32 percentage = 0;</span>
<a href="#l2.34"></a><span id="l2.34">     fileTransactionEntry fileTransaction =</span>
<a href="#l2.35"></a><span id="l2.35">       mFileCopyTransactions.ElementAt(mFileCopyTransactionIndex++);</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     // copy the file</span>
<a href="#l2.38"></a><span id="l2.38">     fileTransaction.srcFile-&gt;CopyTo(fileTransaction.destFile,</span>
<a href="#l2.39"></a><span id="l2.39">                                     fileTransaction.newName);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">     // add to our current progress</span>
<a href="#l2.42"></a><span id="l2.42">     PRInt64 fileSize;</span>
<a href="#l2.43"></a><span id="l2.43">     fileTransaction.srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    LL_ADD(mCurrentProgress, mCurrentProgress, fileSize);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    mCurrentProgress += fileSize;</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    PRInt64 percentDone;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    LL_MUL(percentDone, mCurrentProgress, 100);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    LL_DIV(percentDone, percentDone, mMaxProgress);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    LL_L2UI(percentage, percentDone);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    PRUint32 percentage = (PRUint32)(mCurrentProgress * 100 / mMaxProgress);</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">     nsAutoString index;</span>
<a href="#l2.56"></a><span id="l2.56">     index.AppendInt(percentage);</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">     NOTIFY_OBSERVERS(MIGRATION_PROGRESS, index.get());</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">     // fire a timer to handle the next one.</span>
<a href="#l2.61"></a><span id="l2.61">     mFileIOTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -96,17 +96,17 @@ nsSeamonkeyProfileMigrator::Migrate(PRUi</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   // Generate the max progress value now that we know all of the files we need to copy</span>
<a href="#l3.6"></a><span id="l3.6">   PRUint32 count = mFileCopyTransactions.Length();</span>
<a href="#l3.7"></a><span id="l3.7">   for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l3.8"></a><span id="l3.8">   {</span>
<a href="#l3.9"></a><span id="l3.9">     fileTransactionEntry fileTransaction = mFileCopyTransactions.ElementAt(i);</span>
<a href="#l3.10"></a><span id="l3.10">     PRInt64 fileSize;</span>
<a href="#l3.11"></a><span id="l3.11">     fileTransaction.srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    LL_ADD(mMaxProgress, mMaxProgress, fileSize);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    mMaxProgress += fileSize;</span>
<a href="#l3.14"></a><span id="l3.14">   }</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   CopyNextFolder();</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   return rv;</span>
<a href="#l3.19"></a><span id="l3.19"> }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/public/msgCore.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/public/msgCore.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -175,10 +175,13 @@ NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODUL</span>
<a href="#l4.4"></a><span id="l4.4"> #else</span>
<a href="#l4.5"></a><span id="l4.5"> #define MSG_LINEBREAK &quot;\012&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #define MSG_LINEBREAK_LEN 1</span>
<a href="#l4.7"></a><span id="l4.7"> #endif</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #define NS_MSG_BASE</span>
<a href="#l4.10"></a><span id="l4.10"> #define NS_MSG_BASE_STATIC_MEMBER_(type) type</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+/// The number of microseconds in a day. This comes up a lot.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#define PR_USEC_PER_DAY (PRTime(PR_USEC_PER_SEC) * 60 * 60 * 24)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15"> #endif // msgCore_h__</span>
<a href="#l4.16"></a><span id="l4.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -249,20 +249,18 @@ nsMsgFilterList::GetLogStream(nsIOutputS</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">     if (!m_logStream)</span>
<a href="#l5.6"></a><span id="l5.6">       return NS_ERROR_FAILURE;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">     PRInt64 fileSize;</span>
<a href="#l5.9"></a><span id="l5.9">     rv = logFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.10"></a><span id="l5.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    PRUint32 fileLen;;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    LL_L2UI(fileLen, fileSize);</span>
<a href="#l5.14"></a><span id="l5.14">     // write the header at the start</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    if (fileLen == 0)</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    if (fileSize == 0)</span>
<a href="#l5.17"></a><span id="l5.17">     {</span>
<a href="#l5.18"></a><span id="l5.18">       PRUint32 writeCount;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">       rv = m_logStream-&gt;Write(LOG_HEADER, LOG_HEADER_LEN, &amp;writeCount);</span>
<a href="#l5.21"></a><span id="l5.21">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.22"></a><span id="l5.22">       NS_ASSERTION(writeCount == LOG_HEADER_LEN, &quot;failed to write out log header&quot;);</span>
<a href="#l5.23"></a><span id="l5.23">     }</span>
<a href="#l5.24"></a><span id="l5.24">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -735,18 +735,17 @@ nsresult nsMsgSearchOfflineMail::Search </span>
<a href="#l6.4"></a><span id="l6.4">           NS_ConvertUTF16toUTF8 charset(folderCharset);</span>
<a href="#l6.5"></a><span id="l6.5">           // Is this message a hit?</span>
<a href="#l6.6"></a><span id="l6.6">           err = MatchTermsForSearch (msgDBHdr, m_searchTerms, charset.get(), m_scope, m_db, &amp;expressionTree, &amp;match);</span>
<a href="#l6.7"></a><span id="l6.7">           // Add search hits to the results list</span>
<a href="#l6.8"></a><span id="l6.8">           if (NS_SUCCEEDED(err) &amp;&amp; match)</span>
<a href="#l6.9"></a><span id="l6.9">           {</span>
<a href="#l6.10"></a><span id="l6.10">             AddResultElement (msgDBHdr);</span>
<a href="#l6.11"></a><span id="l6.11">           }</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-          PRIntervalTime elapsedTime;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-          LL_SUB(elapsedTime, PR_IntervalNow(), startTime);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+          PRIntervalTime elapsedTime = PR_IntervalNow() - startTime;</span>
<a href="#l6.15"></a><span id="l6.15">           // check if more than kTimeSliceInMS milliseconds have elapsed in this time slice started</span>
<a href="#l6.16"></a><span id="l6.16">           if (PR_IntervalToMilliseconds(elapsedTime) &gt; kTimeSliceInMS)</span>
<a href="#l6.17"></a><span id="l6.17">             break;</span>
<a href="#l6.18"></a><span id="l6.18">         }</span>
<a href="#l6.19"></a><span id="l6.19">       }</span>
<a href="#l6.20"></a><span id="l6.20">     }</span>
<a href="#l6.21"></a><span id="l6.21">   }</span>
<a href="#l6.22"></a><span id="l6.22">   else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -467,23 +467,17 @@ nsresult nsMsgSearchAdapter::EncodeImapT</span>
<a href="#l7.4"></a><span id="l7.4">       searchValue-&gt;GetDate(&amp;adjustedDate);</span>
<a href="#l7.5"></a><span id="l7.5">       if (whichMnemonic == m_kImapSince)</span>
<a href="#l7.6"></a><span id="l7.6">       {</span>
<a href="#l7.7"></a><span id="l7.7">         // it looks like the IMAP server searches on Since includes the date in question...</span>
<a href="#l7.8"></a><span id="l7.8">         // our UI presents Is, IsGreater and IsLessThan. For the IsGreater case (m_kImapSince)</span>
<a href="#l7.9"></a><span id="l7.9">         // we need to adjust the date so we get greater than and not greater than or equal to which</span>
<a href="#l7.10"></a><span id="l7.10">         // is what the IMAP server wants to search on</span>
<a href="#l7.11"></a><span id="l7.11">         // won't work on Mac.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        // ack, is this right? is PRTime seconds or microseconds?</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        PRInt64 microSecondsPerSecond, secondsInDay, microSecondsInDay;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-        LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-        LL_UI2L(secondsInDay, 60 * 60 * 24);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-        LL_MUL(microSecondsInDay, secondsInDay, microSecondsPerSecond);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-        LL_ADD(adjustedDate, adjustedDate, microSecondsInDay); // bump up to the day after this one...</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        adjustedDate += PR_USEC_PER_DAY;</span>
<a href="#l7.20"></a><span id="l7.20">       }</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">       PRExplodedTime exploded;</span>
<a href="#l7.23"></a><span id="l7.23">       PR_ExplodeTime(adjustedDate, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l7.24"></a><span id="l7.24">       PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l7.25"></a><span id="l7.25">       //    strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime (/* &amp;term-&gt;m_value.u.date */ &amp;adjustedDate));</span>
<a href="#l7.26"></a><span id="l7.26">       value = dateBuf;</span>
<a href="#l7.27"></a><span id="l7.27">     }</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineat">@@ -493,25 +487,18 @@ nsresult nsMsgSearchAdapter::EncodeImapT</span>
<a href="#l7.29"></a><span id="l7.29">       {</span>
<a href="#l7.30"></a><span id="l7.30">         // okay, take the current date, subtract off the age in days, then do an appropriate Date search on</span>
<a href="#l7.31"></a><span id="l7.31">         // the resulting day.</span>
<a href="#l7.32"></a><span id="l7.32">         PRInt32 ageInDays;</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">         searchValue-&gt;GetAge(&amp;ageInDays);</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">         PRTime now = PR_Now();</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-        PRTime matchDay;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-        PRInt64 microSecondsPerSecond, secondsInDays, microSecondsInDay;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+        PRTime matchDay = now - ageInDays * PR_USEC_PER_DAY;</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-        LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-        LL_I2L(secondsInDays, 60 * 60 * 24 * ageInDays);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-        LL_MUL(microSecondsInDay, secondsInDays, microSecondsPerSecond);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-        LL_SUB(matchDay, now, microSecondsInDay); // = now - term-&gt;m_value.u.age * 60 * 60 * 24;</span>
<a href="#l7.47"></a><span id="l7.47">         PRExplodedTime exploded;</span>
<a href="#l7.48"></a><span id="l7.48">         PR_ExplodeTime(matchDay, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l7.49"></a><span id="l7.49">         PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l7.50"></a><span id="l7.50">         //      strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime (&amp;matchDay));</span>
<a href="#l7.51"></a><span id="l7.51">         value = dateBuf;</span>
<a href="#l7.52"></a><span id="l7.52">       }</span>
<a href="#l7.53"></a><span id="l7.53">       else if (attrib == nsMsgSearchAttrib::Size)</span>
<a href="#l7.54"></a><span id="l7.54">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1278,40 +1278,33 @@ nsresult nsMsgSearchTerm::MatchDate (PRT</span>
<a href="#l8.4"></a><span id="l8.4"> nsresult nsMsgSearchTerm::MatchAge (PRTime msgDate, bool *pResult)</span>
<a href="#l8.5"></a><span id="l8.5"> {</span>
<a href="#l8.6"></a><span id="l8.6">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   bool result = false;</span>
<a href="#l8.9"></a><span id="l8.9">   nsresult err = NS_OK;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   PRTime now = PR_Now();</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  PRTime cutOffDay;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  PRInt64 microSecondsPerSecond, secondsInDays, microSecondsInDays;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  PRTime cutOffDay = now - m_value.u.age * PR_USEC_PER_DAY;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  LL_I2L(secondsInDays, 60 * 60 * 24 * m_value.u.age);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-  LL_MUL(microSecondsInDays, secondsInDays, microSecondsPerSecond);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  LL_SUB(cutOffDay, now, microSecondsInDays); // = now - term-&gt;m_value.u.age * 60 * 60 * 24;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  bool cutOffDayInTheFuture = LL_CMP(m_value.u.age, &lt;, 0);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  bool cutOffDayInTheFuture = m_value.u.age &lt; 0;</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   // So now cutOffDay is the PRTime cut-off point.</span>
<a href="#l8.26"></a><span id="l8.26">   // Any msg with a time less than that will be past the age.</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   switch (m_operator)</span>
<a href="#l8.29"></a><span id="l8.29">   {</span>
<a href="#l8.30"></a><span id="l8.30">     case nsMsgSearchOp::IsGreaterThan: // is older than, or more in the future</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-      if ((!cutOffDayInTheFuture &amp;&amp; LL_CMP(msgDate, &lt;, cutOffDay)) ||</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-          (cutOffDayInTheFuture &amp;&amp; LL_CMP(msgDate, &gt;, cutOffDay)))</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      if ((!cutOffDayInTheFuture &amp;&amp; msgDate &lt; cutOffDay) ||</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+          (cutOffDayInTheFuture &amp;&amp; msgDate &gt; cutOffDay))</span>
<a href="#l8.35"></a><span id="l8.35">         result = true;</span>
<a href="#l8.36"></a><span id="l8.36">       break;</span>
<a href="#l8.37"></a><span id="l8.37">     case nsMsgSearchOp::IsLessThan: // is younger than, or less in the future</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-      if ((!cutOffDayInTheFuture &amp;&amp; LL_CMP(msgDate, &gt;, cutOffDay)) ||</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-          (cutOffDayInTheFuture &amp;&amp; LL_CMP(msgDate, &lt;, cutOffDay)))</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+      if ((!cutOffDayInTheFuture &amp;&amp; msgDate &gt; cutOffDay) ||</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+          (cutOffDayInTheFuture &amp;&amp; msgDate &lt; cutOffDay))</span>
<a href="#l8.42"></a><span id="l8.42">         result = true;</span>
<a href="#l8.43"></a><span id="l8.43">       break;</span>
<a href="#l8.44"></a><span id="l8.44">     case nsMsgSearchOp::Is:</span>
<a href="#l8.45"></a><span id="l8.45">       PRExplodedTime msgDateExploded;</span>
<a href="#l8.46"></a><span id="l8.46">       PRExplodedTime cutOffDayExploded;</span>
<a href="#l8.47"></a><span id="l8.47">       if (NS_SUCCEEDED(GetLocalTimes(msgDate, cutOffDay, msgDateExploded, cutOffDayExploded)))</span>
<a href="#l8.48"></a><span id="l8.48">       {</span>
<a href="#l8.49"></a><span id="l8.49">         if ((msgDateExploded.tm_mday == cutOffDayExploded.tm_mday) &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -277,20 +277,18 @@ nsresult nsMsgBiffManager::SetupNextBiff</span>
<a href="#l9.4"></a><span id="l9.4">     // Get the next biff entry</span>
<a href="#l9.5"></a><span id="l9.5">     const nsBiffEntry &amp;biffEntry = mBiffArray[0];</span>
<a href="#l9.6"></a><span id="l9.6">     PRTime currentTime = PR_Now();</span>
<a href="#l9.7"></a><span id="l9.7">     PRInt64 biffDelay;</span>
<a href="#l9.8"></a><span id="l9.8">     PRInt64 ms(1000);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">     if (currentTime &gt; biffEntry.nextBiffTime)</span>
<a href="#l9.11"></a><span id="l9.11">     {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-      PRInt64 microSecondsPerSecond;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-      LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-      LL_MUL(biffDelay, 30, microSecondsPerSecond); //let's wait 30 seconds before firing biff again</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      // Let's wait 30 seconds before firing biff again</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+      biffDelay = 30 * PR_USEC_PER_SEC;</span>
<a href="#l9.18"></a><span id="l9.18">     }</span>
<a href="#l9.19"></a><span id="l9.19">     else</span>
<a href="#l9.20"></a><span id="l9.20">       biffDelay = biffEntry.nextBiffTime - currentTime;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">     // Convert biffDelay into milliseconds</span>
<a href="#l9.23"></a><span id="l9.23">     PRInt64 timeInMS = biffDelay / ms;</span>
<a href="#l9.24"></a><span id="l9.24">     PRUint32 timeInMSUint32 = (PRUint32)timeInMS;</span>
<a href="#l9.25"></a><span id="l9.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -707,56 +707,34 @@ nsresult nsMsgDBView::FetchDate(nsIMsgDB</span>
<a href="#l10.4"></a><span id="l10.4">       explodedCurrentTime.tm_mday == explodedMsgTime.tm_mday)</span>
<a href="#l10.5"></a><span id="l10.5">   {</span>
<a href="#l10.6"></a><span id="l10.6">     // same day...</span>
<a href="#l10.7"></a><span id="l10.7">     dateFormat = m_dateFormatToday;</span>
<a href="#l10.8"></a><span id="l10.8">   }</span>
<a href="#l10.9"></a><span id="l10.9">   // the following chunk of code allows us to show a day instead of a number if the message was received</span>
<a href="#l10.10"></a><span id="l10.10">   // within the last 7 days. i.e. Mon 5:10pm. (depending on the mail.ui.display.dateformat.thisweek pref)</span>
<a href="#l10.11"></a><span id="l10.11">   // The concrete format used is dependent on a preference setting (see InitDisplayFormats).</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  else if (LL_CMP(currentTime, &gt;, dateOfMsg))</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    // some constants for calculation</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    static PRInt64 microSecondsPerSecond;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-    static PRInt64 secondsPerDay;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    static PRInt64 microSecondsPerDay;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-    static PRInt64 microSecondsPer6Days;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    static bool bGotConstants = false;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-    if ( !bGotConstants )</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-    {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-      // seeds</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-      LL_I2L  ( microSecondsPerSecond,  PR_USEC_PER_SEC );</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-      LL_UI2L ( secondsPerDay,          60 * 60 * 24 );</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-      // derivees</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-      LL_MUL( microSecondsPerDay,   secondsPerDay,      microSecondsPerSecond );</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-      LL_MUL( microSecondsPer6Days, microSecondsPerDay, 6 );</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-      bGotConstants = true;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    }</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    // setting the time variables to local time</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    PRInt64 GMTLocalTimeShift;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    LL_ADD( GMTLocalTimeShift, explodedCurrentTime.tm_params.tp_gmt_offset, explodedCurrentTime.tm_params.tp_dst_offset );</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-    LL_MUL( GMTLocalTimeShift, GMTLocalTimeShift, microSecondsPerSecond );</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-    LL_ADD( currentTime, currentTime, GMTLocalTimeShift );</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    LL_ADD( dateOfMsgLocal, dateOfMsg, GMTLocalTimeShift );</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    // the most recent midnight, counting from current time</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    PRInt64 todaysMicroSeconds, mostRecentMidnight;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-    LL_MOD( todaysMicroSeconds, currentTime, microSecondsPerDay );</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    LL_SUB( mostRecentMidnight, currentTime, todaysMicroSeconds );</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  else if (currentTime &gt; dateOfMsg)</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    // Convert the times from GMT to local time</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    PRInt64 GMTLocalTimeShift = PR_USEC_PER_SEC *</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+      PRInt64(explodedCurrentTime.tm_params.tp_gmt_offset +</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+       explodedCurrentTime.tm_params.tp_dst_offset);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    currentTime += GMTLocalTimeShift;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    dateOfMsgLocal = dateOfMsg + GMTLocalTimeShift;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    // Find the most recent midnight</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    PRInt64 todaysMicroSeconds = currentTime % PR_USEC_PER_DAY;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    PRInt64 mostRecentMidnight = currentTime - todaysMicroSeconds;</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">     // most recent midnight minus 6 days</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-    PRInt64 mostRecentWeek;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    LL_SUB( mostRecentWeek, mostRecentMidnight, microSecondsPer6Days );</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    PRInt64 mostRecentWeek = mostRecentMidnight - (PR_USEC_PER_DAY * 6);</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">     // was the message sent during the last week?</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-    if ( LL_CMP( dateOfMsgLocal, &gt;=, mostRecentWeek ) )</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+    if (dateOfMsgLocal &gt;= mostRecentWeek)</span>
<a href="#l10.66"></a><span id="l10.66">     { // yes ....</span>
<a href="#l10.67"></a><span id="l10.67">       dateFormat = m_dateFormatThisWeek;</span>
<a href="#l10.68"></a><span id="l10.68">     }</span>
<a href="#l10.69"></a><span id="l10.69">   }</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.72"></a><span id="l10.72">     rv = mDateFormatter-&gt;FormatPRTime(nsnull /* nsILocale* locale */,</span>
<a href="#l10.73"></a><span id="l10.73">                                       dateFormat,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -125,66 +125,40 @@ nsresult nsMsgGroupView::GetAgeBucketVal</span>
<a href="#l11.4"></a><span id="l11.4">   if (currentExplodedTime.tm_year == explodedMsgTime.tm_year &amp;&amp;</span>
<a href="#l11.5"></a><span id="l11.5">       currentExplodedTime.tm_month == explodedMsgTime.tm_month &amp;&amp;</span>
<a href="#l11.6"></a><span id="l11.6">       currentExplodedTime.tm_mday == explodedMsgTime.tm_mday)</span>
<a href="#l11.7"></a><span id="l11.7">   {</span>
<a href="#l11.8"></a><span id="l11.8">     // same day...</span>
<a href="#l11.9"></a><span id="l11.9">     *aAgeBucket = 1;</span>
<a href="#l11.10"></a><span id="l11.10">   }</span>
<a href="#l11.11"></a><span id="l11.11">   // figure out how many days ago this msg arrived</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  else if (LL_CMP(currentTime, &gt;, dateOfMsg))</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  else if (currentTime &gt; dateOfMsg)</span>
<a href="#l11.14"></a><span id="l11.14">   {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    // some constants for calculation</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-    static PRInt64 microSecondsPerSecond;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-    static PRInt64 microSecondsPerDay;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-    static PRInt64 secondsPerDay;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    static PRInt64 microSecondsPer6Days;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-    static PRInt64 microSecondsPer13Days;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-    static bool bGotConstants = false;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-    if ( !bGotConstants )</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-    {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-      // seeds</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-      LL_I2L  ( microSecondsPerSecond,  PR_USEC_PER_SEC );</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-      LL_UI2L ( secondsPerDay,          60 * 60 * 24 );</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-      // derivees</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-      LL_MUL( microSecondsPerDay,   secondsPerDay,      microSecondsPerSecond );</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-      LL_MUL( microSecondsPer6Days, microSecondsPerDay, 6 );</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-      LL_MUL( microSecondsPer13Days, microSecondsPerDay, 13 );</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-      bGotConstants = true;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    }</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-</span>
<a href="#l11.36"></a><span id="l11.36">     // setting the time variables to local time</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    PRInt64 GMTLocalTimeShift;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    LL_ADD( GMTLocalTimeShift, currentExplodedTime.tm_params.tp_gmt_offset, currentExplodedTime.tm_params.tp_dst_offset );</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-    LL_MUL( GMTLocalTimeShift, GMTLocalTimeShift, microSecondsPerSecond );</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-    LL_ADD( currentTime, currentTime, GMTLocalTimeShift );</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-    LL_ADD( dateOfMsg, dateOfMsg, GMTLocalTimeShift );</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    PRInt64 GMTLocalTimeShift = currentExplodedTime.tm_params.tp_gmt_offset +</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      currentExplodedTime.tm_params.tp_dst_offset;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    GMTLocalTimeShift *= PR_USEC_PER_SEC;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+    currentTime += GMTLocalTimeShift;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    dateOfMsg += GMTLocalTimeShift;</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">     // the most recent midnight, counting from current time</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    PRInt64 todaysMicroSeconds, mostRecentMidnight;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    LL_MOD( todaysMicroSeconds, currentTime, microSecondsPerDay );</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-    LL_SUB( mostRecentMidnight, currentTime, todaysMicroSeconds );</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    PRInt64 yesterday;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    LL_SUB( yesterday, mostRecentMidnight, microSecondsPerDay );</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    PRInt64 mostRecentMidnight = currentTime - currentTime % PR_USEC_PER_DAY;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    PRInt64 yesterday = mostRecentMidnight - PR_USEC_PER_DAY;</span>
<a href="#l11.56"></a><span id="l11.56">     // most recent midnight minus 6 days</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    PRInt64 mostRecentWeek;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    LL_SUB( mostRecentWeek, mostRecentMidnight, microSecondsPer6Days );</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+    PRInt64 mostRecentWeek = mostRecentMidnight - (PR_USEC_PER_DAY * 6);</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">     // was the message sent yesterday?</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-    if ( LL_CMP( dateOfMsg, &gt;=, yesterday ) ) // yes ....</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+    if (dateOfMsg &gt;= yesterday) // yes ....</span>
<a href="#l11.64"></a><span id="l11.64">       *aAgeBucket = 2;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    else if ( LL_CMP(dateOfMsg, &gt;=, mostRecentWeek) )</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+    else if (dateOfMsg &gt;= mostRecentWeek)</span>
<a href="#l11.67"></a><span id="l11.67">       *aAgeBucket = 3;</span>
<a href="#l11.68"></a><span id="l11.68">     else</span>
<a href="#l11.69"></a><span id="l11.69">     {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-      PRInt64 lastTwoWeeks;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-      LL_SUB( lastTwoWeeks, mostRecentMidnight, microSecondsPer13Days);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-      *aAgeBucket = LL_CMP(dateOfMsg, &gt;=, lastTwoWeeks) ? 4 : 5;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+      PRInt64 lastTwoWeeks = mostRecentMidnight - PR_USEC_PER_DAY * 13;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+      *aAgeBucket = (dateOfMsg &gt;= lastTwoWeeks) ? 4 : 5;</span>
<a href="#l11.75"></a><span id="l11.75">     }</span>
<a href="#l11.76"></a><span id="l11.76">   }</span>
<a href="#l11.77"></a><span id="l11.77">   return NS_OK;</span>
<a href="#l11.78"></a><span id="l11.78"> }</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80"> nsresult nsMsgGroupView::HashHdr(nsIMsgDBHdr *msgHdr, nsString&amp; aHashKey)</span>
<a href="#l11.81"></a><span id="l11.81"> {</span>
<a href="#l11.82"></a><span id="l11.82">   nsCString cStringKey;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -209,18 +209,17 @@ nsresult nsMsgPurgeService::PerformPurge</span>
<a href="#l12.4"></a><span id="l12.4">               PRInt64 minDelayBetweenPurges(mMinDelayBetweenPurges);</span>
<a href="#l12.5"></a><span id="l12.5">               PRInt64 microSecondsPerMinute(60000000);</span>
<a href="#l12.6"></a><span id="l12.6">               PRTime nextPurgeTime = curFolderLastPurgeTime + (minDelayBetweenPurges * microSecondsPerMinute);</span>
<a href="#l12.7"></a><span id="l12.7">               if (nextPurgeTime &lt; PR_Now())</span>
<a href="#l12.8"></a><span id="l12.8">               {</span>
<a href="#l12.9"></a><span id="l12.9">                 PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;purging %s&quot;, curFolderUri.get()));</span>
<a href="#l12.10"></a><span id="l12.10">                 childFolder-&gt;ApplyRetentionSettings();</span>
<a href="#l12.11"></a><span id="l12.11">               }</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-              PRIntervalTime elapsedTime;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-              LL_SUB(elapsedTime, PR_IntervalNow(), startTime);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+              PRIntervalTime elapsedTime = PR_IntervalNow() - startTime;</span>
<a href="#l12.15"></a><span id="l12.15">               // check if more than 500 milliseconds have elapsed in this purge process</span>
<a href="#l12.16"></a><span id="l12.16">               if (PR_IntervalToMilliseconds(elapsedTime) &gt; 500)</span>
<a href="#l12.17"></a><span id="l12.17">               {</span>
<a href="#l12.18"></a><span id="l12.18">                 keepApplyingRetentionSettings = false;</span>
<a href="#l12.19"></a><span id="l12.19">                 break;</span>
<a href="#l12.20"></a><span id="l12.20">               }</span>
<a href="#l12.21"></a><span id="l12.21">             }</span>
<a href="#l12.22"></a><span id="l12.22">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -21,19 +21,19 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> #define MSGFEEDBACK_TIMER_INTERVAL 500</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> nsMsgStatusFeedback::nsMsgStatusFeedback() :</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  m_lastPercent(0)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  m_lastPercent(0),</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  m_lastProgressTime(0)</span>
<a href="#l13.15"></a><span id="l13.15"> {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-  LL_I2L(m_lastProgressTime, 0);</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">   nsresult rv;</span>
<a href="#l13.19"></a><span id="l13.19">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l13.20"></a><span id="l13.20">     mozilla::services::GetStringBundleService();</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">   if (bundleService)</span>
<a href="#l13.23"></a><span id="l13.23">     bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l13.24"></a><span id="l13.24">                                 getter_AddRefs(mBundle));</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineat">@@ -210,28 +210,21 @@ nsMsgStatusFeedback::ShowProgress(PRInt3</span>
<a href="#l13.26"></a><span id="l13.26"> {</span>
<a href="#l13.27"></a><span id="l13.27">   // if the percentage hasn't changed...OR if we are going from 0 to 100% in one step</span>
<a href="#l13.28"></a><span id="l13.28">   // then don't bother....just fall out....</span>
<a href="#l13.29"></a><span id="l13.29">   if (aPercentage == m_lastPercent || (m_lastPercent == 0 &amp;&amp; aPercentage &gt;= 100))</span>
<a href="#l13.30"></a><span id="l13.30">     return NS_OK;</span>
<a href="#l13.31"></a><span id="l13.31">   </span>
<a href="#l13.32"></a><span id="l13.32">   m_lastPercent = aPercentage;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  PRInt64 nowMS;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  LL_I2L(nowMS, 0);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  PRInt64 nowMS = 0;</span>
<a href="#l13.37"></a><span id="l13.37">   if (aPercentage &lt; 100)	// always need to do 100%</span>
<a href="#l13.38"></a><span id="l13.38">   {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-    int64 minIntervalBetweenProgress;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-    LL_I2L(minIntervalBetweenProgress, 250);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    int64 diffSinceLastProgress;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    LL_I2L(nowMS, PR_IntervalToMilliseconds(PR_IntervalNow()));</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-    LL_SUB(diffSinceLastProgress, nowMS, m_lastProgressTime); // r = a - b</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    if (!LL_GE_ZERO(diffSinceLastProgress))</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    if (nowMS &lt; m_lastProgressTime + 250)</span>
<a href="#l13.49"></a><span id="l13.49">       return NS_OK;</span>
<a href="#l13.50"></a><span id="l13.50">   }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">   m_lastProgressTime = nowMS;</span>
<a href="#l13.53"></a><span id="l13.53">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; jsStatusFeedback(do_QueryReferent(mJSStatusFeedbackWeak));</span>
<a href="#l13.54"></a><span id="l13.54">   if (jsStatusFeedback)</span>
<a href="#l13.55"></a><span id="l13.55">     jsStatusFeedback-&gt;ShowProgress(aPercentage);</span>
<a href="#l13.56"></a><span id="l13.56">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -255,17 +255,17 @@ nsresult nsMsgXFViewThread::AddHdr(nsIMs</span>
<a href="#l14.4"></a><span id="l14.4"> //  {</span>
<a href="#l14.5"></a><span id="l14.5"> //    PRTime topLevelHdrDate;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> //    nsCOMPtr&lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l14.8"></a><span id="l14.8"> //    rv = GetRootHdr(nsnull, getter_AddRefs(topLevelHdr));</span>
<a href="#l14.9"></a><span id="l14.9"> //    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr)</span>
<a href="#l14.10"></a><span id="l14.10"> //    {</span>
<a href="#l14.11"></a><span id="l14.11"> //      topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-//      if (LL_CMP(newHdrDate, &lt;, topLevelHdrDate))</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+//      if (newHdrDate &lt; topLevelHdrDate)</span>
<a href="#l14.14"></a><span id="l14.14">       </span>
<a href="#l14.15"></a><span id="l14.15"> //    }</span>
<a href="#l14.16"></a><span id="l14.16"> //  }</span>
<a href="#l14.17"></a><span id="l14.17">   return NS_OK;</span>
<a href="#l14.18"></a><span id="l14.18"> }</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> NS_IMETHODIMP nsMsgXFViewThread::GetChildHdrAt(PRInt32 aIndex, nsIMsgDBHdr **aResult)</span>
<a href="#l14.21"></a><span id="l14.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -213,20 +213,18 @@ nsSpamSettings::GetLogStream(nsIOutputSt</span>
<a href="#l15.4"></a><span id="l15.4">                                         PR_CREATE_FILE | PR_WRONLY | PR_APPEND,</span>
<a href="#l15.5"></a><span id="l15.5">                                         0600);</span>
<a href="#l15.6"></a><span id="l15.6">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8">     PRInt64 fileSize;</span>
<a href="#l15.9"></a><span id="l15.9">     rv = mLogFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l15.10"></a><span id="l15.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    PRUint32 fileLen;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    LL_L2UI(fileLen, fileSize);</span>
<a href="#l15.14"></a><span id="l15.14">     // write the header at the start</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    if (fileLen == 0)</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+    if (fileSize == 0)</span>
<a href="#l15.17"></a><span id="l15.17">     {</span>
<a href="#l15.18"></a><span id="l15.18">       PRUint32 writeCount;</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">       rv = mLogStream-&gt;Write(LOG_HEADER, LOG_HEADER_LEN, &amp;writeCount);</span>
<a href="#l15.21"></a><span id="l15.21">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.22"></a><span id="l15.22">       NS_ASSERTION(writeCount == LOG_HEADER_LEN, &quot;failed to write out log header&quot;);</span>
<a href="#l15.23"></a><span id="l15.23">     }</span>
<a href="#l15.24"></a><span id="l15.24">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -146,17 +146,17 @@ nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l16.4"></a><span id="l16.4">     NS_RegisterStaticAtoms(folder_atoms);</span>
<a href="#l16.5"></a><span id="l16.5"> #else</span>
<a href="#l16.6"></a><span id="l16.6"> #define MSGDBFOLDER_ATOM(name_, value_) name_ = MsgNewPermanentAtom(value_);</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsMsgDBFolderAtomList.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #undef MSGDBFOLDER_ATOM</span>
<a href="#l16.9"></a><span id="l16.9"> #endif</span>
<a href="#l16.10"></a><span id="l16.10">     initializeStrings();</span>
<a href="#l16.11"></a><span id="l16.11">     createCollationKeyGenerator();</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    LL_I2L(gtimeOfLastPurgeCheck, 0);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    gtimeOfLastPurgeCheck = 0;</span>
<a href="#l16.14"></a><span id="l16.14">   }</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">   mProcessingFlag[0].bit = nsMsgProcessingFlags::ClassifyJunk;</span>
<a href="#l16.17"></a><span id="l16.17">   mProcessingFlag[1].bit = nsMsgProcessingFlags::ClassifyTraits;</span>
<a href="#l16.18"></a><span id="l16.18">   mProcessingFlag[2].bit = nsMsgProcessingFlags::TraitsDone;</span>
<a href="#l16.19"></a><span id="l16.19">   mProcessingFlag[3].bit = nsMsgProcessingFlags::FiltersDone;</span>
<a href="#l16.20"></a><span id="l16.20">   mProcessingFlag[4].bit = nsMsgProcessingFlags::FilterToMove;</span>
<a href="#l16.21"></a><span id="l16.21">   mProcessingFlag[5].bit = nsMsgProcessingFlags::NotReportedClassified;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1289,39 +1289,27 @@ NS_MSG_BASE nsresult NS_GetLocalizedUnic</span>
<a href="#l17.4"></a><span id="l17.4">   }</span>
<a href="#l17.5"></a><span id="l17.5">     else</span>
<a href="#l17.6"></a><span id="l17.6">         prefValue = defValue;</span>
<a href="#l17.7"></a><span id="l17.7">     return NS_OK;</span>
<a href="#l17.8"></a><span id="l17.8"> }</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> void PRTime2Seconds(PRTime prTime, PRUint32 *seconds)</span>
<a href="#l17.11"></a><span id="l17.11"> {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  PRInt64 microSecondsPerSecond, intermediateResult;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-  LL_DIV(intermediateResult, prTime, microSecondsPerSecond);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  LL_L2UI((*seconds), intermediateResult);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  *seconds = (PRUint32)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l17.18"></a><span id="l17.18"> }</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> void PRTime2Seconds(PRTime prTime, PRInt32 *seconds)</span>
<a href="#l17.21"></a><span id="l17.21"> {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-  PRInt64 microSecondsPerSecond, intermediateResult;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-  LL_DIV(intermediateResult, prTime, microSecondsPerSecond);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-  LL_L2I((*seconds), intermediateResult);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  *seconds = (PRInt32)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l17.28"></a><span id="l17.28"> }</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> void Seconds2PRTime(PRUint32 seconds, PRTime *prTime)</span>
<a href="#l17.31"></a><span id="l17.31"> {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-  PRInt64 microSecondsPerSecond, intermediateResult;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  LL_UI2L(intermediateResult, seconds);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-  LL_MUL((*prTime), intermediateResult, microSecondsPerSecond);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  *prTime = (PRTime)seconds * PR_USEC_PER_SEC;</span>
<a href="#l17.38"></a><span id="l17.38"> }</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> nsresult GetSummaryFileLocation(nsIFile* fileLocation, nsIFile** summaryLocation)</span>
<a href="#l17.41"></a><span id="l17.41"> {</span>
<a href="#l17.42"></a><span id="l17.42">   nsresult rv;</span>
<a href="#l17.43"></a><span id="l17.43">   nsCOMPtr &lt;nsIFile&gt; newSummaryLocation = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l17.44"></a><span id="l17.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46" class="difflineat">@@ -2136,22 +2124,19 @@ NS_MSG_BASE nsresult MsgPromptLoginFaile</span>
<a href="#l17.47"></a><span id="l17.47">     (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l17.48"></a><span id="l17.48">     (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1) +</span>
<a href="#l17.49"></a><span id="l17.49">     (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_2),</span>
<a href="#l17.50"></a><span id="l17.50">     button0.get(), nsnull, button2.get(), nsnull, &amp;dummyValue, aResult);</span>
<a href="#l17.51"></a><span id="l17.51"> }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53"> NS_MSG_BASE PRTime MsgConvertAgeInDaysToCutoffDate(PRInt32 ageInDays)</span>
<a href="#l17.54"></a><span id="l17.54"> {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-  PRInt64 secondsInDays, microSecondsInDay;</span>
<a href="#l17.56"></a><span id="l17.56">   PRTime now = PR_Now();</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-  secondsInDays = 60 * 60 * 24 * ageInDays;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  microSecondsInDay = secondsInDays * PR_USEC_PER_SEC;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-  return now - microSecondsInDay;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+  return now - PR_USEC_PER_DAY * ageInDays;</span>
<a href="#l17.62"></a><span id="l17.62"> }</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64"> NS_MSG_BASE nsresult MsgTermListToString(nsISupportsArray *aTermList, nsCString &amp;aOutString)</span>
<a href="#l17.65"></a><span id="l17.65"> {</span>
<a href="#l17.66"></a><span id="l17.66">   PRUint32 count;</span>
<a href="#l17.67"></a><span id="l17.67">   aTermList-&gt;Count(&amp;count);</span>
<a href="#l17.68"></a><span id="l17.68">   nsresult rv = NS_OK;</span>
<a href="#l17.69"></a><span id="l17.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -704,19 +704,17 @@ static void</span>
<a href="#l18.4"></a><span id="l18.4"> GenerateGlobalRandomBytes(unsigned char *buf, PRInt32 len)</span>
<a href="#l18.5"></a><span id="l18.5"> {</span>
<a href="#l18.6"></a><span id="l18.6">   static bool      firstTime = true;</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8">   if (firstTime)</span>
<a href="#l18.9"></a><span id="l18.9">   {</span>
<a href="#l18.10"></a><span id="l18.10">     // Seed the random-number generator with current time so that</span>
<a href="#l18.11"></a><span id="l18.11">     // the numbers will be different every time we run.</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    PRInt32 aTime;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-    LL_L2I(aTime, PR_Now());</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-    srand( (unsigned)aTime );</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    srand( (unsigned)PR_Now() );</span>
<a href="#l18.16"></a><span id="l18.16">     firstTime = false;</span>
<a href="#l18.17"></a><span id="l18.17">   }</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   for( PRInt32 i = 0; i &lt; len; i++ )</span>
<a href="#l18.20"></a><span id="l18.20">     buf[i] = rand() % 10;</span>
<a href="#l18.21"></a><span id="l18.21"> }</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> char</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineat">@@ -1080,23 +1078,17 @@ static bool isValidHost( const char* hos</span>
<a href="#l18.25"></a><span id="l18.25">       }</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   return nsnull != host;</span>
<a href="#l18.28"></a><span id="l18.28"> }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> char *</span>
<a href="#l18.31"></a><span id="l18.31"> msg_generate_message_id (nsIMsgIdentity *identity)</span>
<a href="#l18.32"></a><span id="l18.32"> {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  PRUint32 now;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  PRTime prNow = PR_Now();</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  PRInt64 microSecondsPerSecond, intermediateResult;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  LL_DIV(intermediateResult, prNow, microSecondsPerSecond);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-    LL_L2UI(now, intermediateResult);</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  PRUint32 now = (PRUint32)(PR_Now() / PR_USEC_PER_SEC);</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42">   PRUint32 salt = 0;</span>
<a href="#l18.43"></a><span id="l18.43">   const char *host = 0;</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45">   nsCString forcedFQDN;</span>
<a href="#l18.46"></a><span id="l18.46">   nsCString from;</span>
<a href="#l18.47"></a><span id="l18.47">   nsresult rv = NS_OK;</span>
<a href="#l18.48"></a><span id="l18.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -269,19 +269,17 @@ nsURLFetcher::OnStopRequest(nsIRequest *</span>
<a href="#l19.4"></a><span id="l19.4">   if (mOutStream)</span>
<a href="#l19.5"></a><span id="l19.5">   {</span>
<a href="#l19.6"></a><span id="l19.6">     mOutStream-&gt;Close();</span>
<a href="#l19.7"></a><span id="l19.7">     mOutStream = nsnull;</span>
<a href="#l19.8"></a><span id="l19.8">   </span>
<a href="#l19.9"></a><span id="l19.9">     /* In case of multipart/x-mixed-replace, we need to truncate the file to the current part size */</span>
<a href="#l19.10"></a><span id="l19.10">     if (MsgLowerCaseEqualsLiteral(mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l19.11"></a><span id="l19.11">     {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-      PRInt64 fileSize;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-      LL_I2L(fileSize, mTotalWritten);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-      mLocalFile-&gt;SetFileSize(fileSize);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+      mLocalFile-&gt;SetFileSize(mTotalWritten);</span>
<a href="#l19.16"></a><span id="l19.16">     }</span>
<a href="#l19.17"></a><span id="l19.17">   }</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   // Now if there is a callback, we need to call it...</span>
<a href="#l19.20"></a><span id="l19.20">   if (mCallback)</span>
<a href="#l19.21"></a><span id="l19.21">     mCallback (aStatus, mContentType, mCharset, mTotalWritten, nsnull, mTagData);</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">   // Time to return...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5228,26 +5228,18 @@ nsresult nsMsgDatabase::PurgeMessagesOld</span>
<a href="#l20.4"></a><span id="l20.4">   nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l20.5"></a><span id="l20.5">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l20.6"></a><span id="l20.6">   nsTArray&lt;nsMsgKey&gt; keysToDelete;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">   if (NS_FAILED(rv))</span>
<a href="#l20.9"></a><span id="l20.9">     return rv;</span>
<a href="#l20.10"></a><span id="l20.10">   bool hasMore = false;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  PRTime now = PR_Now();</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-  PRTime cutOffDay;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-  PRInt64 microSecondsPerSecond, secondsInDays, microSecondsInDay;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  LL_UI2L(secondsInDays, 60 * 60 * 24 * daysToKeepHdrs);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  LL_MUL(microSecondsInDay, secondsInDays, microSecondsPerSecond);</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  LL_SUB(cutOffDay, now, microSecondsInDay); // = now - term-&gt;m_value.u.age * 60 * 60 * 24;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+  PRTime cutOffDay = PR_Now() - daysToKeepHdrs * PR_USEC_PER_DAY;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+</span>
<a href="#l20.24"></a><span id="l20.24">   // so now cutOffDay is the PRTime cut-off point. Any msg with a date less than that will get purged.</span>
<a href="#l20.25"></a><span id="l20.25">   while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l20.26"></a><span id="l20.26">   {</span>
<a href="#l20.27"></a><span id="l20.27">     bool purgeHdr = false;</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">     rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l20.30"></a><span id="l20.30">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l20.31"></a><span id="l20.31">     if (NS_FAILED(rv))</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineat">@@ -5268,17 +5260,17 @@ nsresult nsMsgDatabase::PurgeMessagesOld</span>
<a href="#l20.33"></a><span id="l20.33">       if (isRead)</span>
<a href="#l20.34"></a><span id="l20.34">         purgeHdr = true;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">     }</span>
<a href="#l20.37"></a><span id="l20.37">     if (!purgeHdr)</span>
<a href="#l20.38"></a><span id="l20.38">     {</span>
<a href="#l20.39"></a><span id="l20.39">       PRTime date;</span>
<a href="#l20.40"></a><span id="l20.40">       pHeader-&gt;GetDate(&amp;date);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-      if (LL_CMP(date, &lt;, cutOffDay))</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+      if (date &lt; cutOffDay)</span>
<a href="#l20.43"></a><span id="l20.43">         purgeHdr = true;</span>
<a href="#l20.44"></a><span id="l20.44">     }</span>
<a href="#l20.45"></a><span id="l20.45">     if (purgeHdr)</span>
<a href="#l20.46"></a><span id="l20.46">     {</span>
<a href="#l20.47"></a><span id="l20.47">       nsMsgKey msgKey;</span>
<a href="#l20.48"></a><span id="l20.48">       pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l20.49"></a><span id="l20.49">       keysToDelete.AppendElement(msgKey);</span>
<a href="#l20.50"></a><span id="l20.50">       if (hdrsToDelete)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -37,17 +37,17 @@ nsMsgHdr::nsMsgHdr(nsMsgDatabase *db, ns</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> void nsMsgHdr::Init()</span>
<a href="#l21.7"></a><span id="l21.7"> {</span>
<a href="#l21.8"></a><span id="l21.8">   m_initedValues = 0;</span>
<a href="#l21.9"></a><span id="l21.9">   m_statusOffset = 0xffffffff;</span>
<a href="#l21.10"></a><span id="l21.10">   m_messageKey = nsMsgKey_None;</span>
<a href="#l21.11"></a><span id="l21.11">   m_messageSize = 0;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  m_date = LL_ZERO;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  m_date = 0;</span>
<a href="#l21.14"></a><span id="l21.14">   m_flags = 0;</span>
<a href="#l21.15"></a><span id="l21.15">   m_mdbRow = NULL;</span>
<a href="#l21.16"></a><span id="l21.16">   m_threadId = nsMsgKey_None;</span>
<a href="#l21.17"></a><span id="l21.17">   m_threadParent = nsMsgKey_None;</span>
<a href="#l21.18"></a><span id="l21.18"> }</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> nsresult nsMsgHdr::InitCachedValues()</span>
<a href="#l21.21"></a><span id="l21.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -324,17 +324,17 @@ NS_IMETHODIMP nsMsgThread::AddChild(nsIM</span>
<a href="#l22.4"></a><span id="l22.4"> #endif</span>
<a href="#l22.5"></a><span id="l22.5">         }</span>
<a href="#l22.6"></a><span id="l22.6">         // Calculate a position for this child in date order</span>
<a href="#l22.7"></a><span id="l22.7">         else if (!hdrMoved &amp;&amp; childIndex &gt; 0 &amp;&amp; moveIndex == 0)</span>
<a href="#l22.8"></a><span id="l22.8">         {</span>
<a href="#l22.9"></a><span id="l22.9">           PRTime curHdrDate;</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">           curHdr-&gt;GetDate(&amp;curHdrDate);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-          if (LL_CMP(newHdrDate, &lt;, curHdrDate))</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+          if (newHdrDate &lt; curHdrDate)</span>
<a href="#l22.14"></a><span id="l22.14">             moveIndex = childIndex;</span>
<a href="#l22.15"></a><span id="l22.15">         }</span>
<a href="#l22.16"></a><span id="l22.16">       }</span>
<a href="#l22.17"></a><span id="l22.17">     }</span>
<a href="#l22.18"></a><span id="l22.18">   }</span>
<a href="#l22.19"></a><span id="l22.19">   // If this header is not a reply to a header in the thread, and isn't a parent</span>
<a href="#l22.20"></a><span id="l22.20">   // check to see if it starts with Re: - if not, and the first header does start</span>
<a href="#l22.21"></a><span id="l22.21">   // with re, should we make this header the top level header?</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -343,17 +343,17 @@ NS_IMETHODIMP nsMsgThread::AddChild(nsIM</span>
<a href="#l22.23"></a><span id="l22.23">   {</span>
<a href="#l22.24"></a><span id="l22.24">     PRTime topLevelHdrDate;</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">     nsCOMPtr &lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l22.27"></a><span id="l22.27">     rv = GetRootHdr(nsnull, getter_AddRefs(topLevelHdr));</span>
<a href="#l22.28"></a><span id="l22.28">     if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr)</span>
<a href="#l22.29"></a><span id="l22.29">     {</span>
<a href="#l22.30"></a><span id="l22.30">       topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-      if (LL_CMP(newHdrDate, &lt;, topLevelHdrDate))</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+      if (newHdrDate &lt; topLevelHdrDate)</span>
<a href="#l22.33"></a><span id="l22.33">       {</span>
<a href="#l22.34"></a><span id="l22.34">         RerootThread(child, topLevelHdr, announcer);</span>
<a href="#l22.35"></a><span id="l22.35">         mdb_pos outPos;</span>
<a href="#l22.36"></a><span id="l22.36">         m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, 0, &amp;outPos);</span>
<a href="#l22.37"></a><span id="l22.37">         hdrMoved = true;</span>
<a href="#l22.38"></a><span id="l22.38">         topLevelHdr-&gt;SetThreadParent(newHdrKey);</span>
<a href="#l22.39"></a><span id="l22.39">         parentKeyNeedsSetting = false;</span>
<a href="#l22.40"></a><span id="l22.40">         // ### need to get ancestor of new hdr here too.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -82,19 +82,17 @@ static void</span>
<a href="#l23.4"></a><span id="l23.4"> GenerateGlobalRandomBytes(unsigned char *buf, PRInt32 len)</span>
<a href="#l23.5"></a><span id="l23.5"> {</span>
<a href="#l23.6"></a><span id="l23.6">   static bool      firstTime = true;</span>
<a href="#l23.7"></a><span id="l23.7">   </span>
<a href="#l23.8"></a><span id="l23.8">   if (firstTime)</span>
<a href="#l23.9"></a><span id="l23.9">   {</span>
<a href="#l23.10"></a><span id="l23.10">     // Seed the random-number generator with current time so that</span>
<a href="#l23.11"></a><span id="l23.11">     // the numbers will be different every time we run.</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    PRInt32 aTime;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-    LL_L2I(aTime, PR_Now());</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    srand( (unsigned)aTime );</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+    srand( (unsigned)PR_Now() );</span>
<a href="#l23.16"></a><span id="l23.16">     firstTime = false;</span>
<a href="#l23.17"></a><span id="l23.17">   }</span>
<a href="#l23.18"></a><span id="l23.18">   </span>
<a href="#l23.19"></a><span id="l23.19">   for( PRInt32 i = 0; i &lt; len; i++ )</span>
<a href="#l23.20"></a><span id="l23.20">     buf[i] = rand() % 10;</span>
<a href="#l23.21"></a><span id="l23.21"> }</span>
<a href="#l23.22"></a><span id="l23.22">    </span>
<a href="#l23.23"></a><span id="l23.23"> char </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -657,28 +657,21 @@ nsImapIncomingServer::ConnectionTimeOut(</span>
<a href="#l24.4"></a><span id="l24.4">   PRInt32 timeoutInMinutes = 0;</span>
<a href="#l24.5"></a><span id="l24.5">   rv = GetTimeOutLimits(&amp;timeoutInMinutes);</span>
<a href="#l24.6"></a><span id="l24.6">   if (NS_FAILED(rv) || timeoutInMinutes &lt;= 0 || timeoutInMinutes &gt; 29)</span>
<a href="#l24.7"></a><span id="l24.7">   {</span>
<a href="#l24.8"></a><span id="l24.8">     timeoutInMinutes = 29;</span>
<a href="#l24.9"></a><span id="l24.9">     SetTimeOutLimits(timeoutInMinutes);</span>
<a href="#l24.10"></a><span id="l24.10">   }</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  PRTime cacheTimeoutLimits;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-  LL_I2L(cacheTimeoutLimits, timeoutInMinutes * 60 * 1000000); // in</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-                                                            // microseconds</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  PRTime cacheTimeoutLimits = timeoutInMinutes * 60 * PR_USEC_PER_SEC;</span>
<a href="#l24.17"></a><span id="l24.17">   PRTime lastActiveTimeStamp;</span>
<a href="#l24.18"></a><span id="l24.18">   rv = aConnection-&gt;GetLastActiveTimeStamp(&amp;lastActiveTimeStamp);</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-  PRTime elapsedTime;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  LL_SUB(elapsedTime, PR_Now(), lastActiveTimeStamp);</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-  PRTime t;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-  LL_SUB(t, elapsedTime, cacheTimeoutLimits);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-  if (LL_GE_ZERO(t))</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+  if (PR_Now() - lastActiveTimeStamp &lt; cacheTimeoutLimits)</span>
<a href="#l24.26"></a><span id="l24.26">   {</span>
<a href="#l24.27"></a><span id="l24.27">       nsCOMPtr&lt;nsIImapProtocol&gt; aProtocol(do_QueryInterface(aConnection,</span>
<a href="#l24.28"></a><span id="l24.28">                                                             &amp;rv));</span>
<a href="#l24.29"></a><span id="l24.29">       if (NS_SUCCEEDED(rv) &amp;&amp; aProtocol)</span>
<a href="#l24.30"></a><span id="l24.30">       {</span>
<a href="#l24.31"></a><span id="l24.31">         RemoveConnection(aConnection);</span>
<a href="#l24.32"></a><span id="l24.32">         aProtocol-&gt;TellThreadToDie(false);</span>
<a href="#l24.33"></a><span id="l24.33">         retVal = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -406,20 +406,20 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l25.4"></a><span id="l25.4">   m_folderNeedsSubscribing = false;</span>
<a href="#l25.5"></a><span id="l25.5">   m_folderNeedsACLRefreshed = false;</span>
<a href="#l25.6"></a><span id="l25.6">   m_threadShouldDie = false;</span>
<a href="#l25.7"></a><span id="l25.7">   m_inThreadShouldDie = false;</span>
<a href="#l25.8"></a><span id="l25.8">   m_pseudoInterrupted = false;</span>
<a href="#l25.9"></a><span id="l25.9">   m_nextUrlReadyToRun = false;</span>
<a href="#l25.10"></a><span id="l25.10">   m_trackingTime = false;</span>
<a href="#l25.11"></a><span id="l25.11">   m_curFetchSize = 0;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  LL_I2L(m_startTime, 0);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  LL_I2L(m_endTime, 0);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  LL_I2L(m_lastActiveTime, 0);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  LL_I2L(m_lastProgressTime, 0);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  m_startTime = 0;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  m_endTime = 0;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  m_lastActiveTime = 0;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+  m_lastProgressTime = 0;</span>
<a href="#l25.20"></a><span id="l25.20">   ResetProgressInfo();</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22">   m_tooFastTime = 0;</span>
<a href="#l25.23"></a><span id="l25.23">   m_idealTime = 0;</span>
<a href="#l25.24"></a><span id="l25.24">   m_chunkAddSize = 0;</span>
<a href="#l25.25"></a><span id="l25.25">   m_chunkStartSize = 0;</span>
<a href="#l25.26"></a><span id="l25.26">   m_fetchByChunks = true;</span>
<a href="#l25.27"></a><span id="l25.27">   m_sendID = true;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineat">@@ -3074,22 +3074,18 @@ nsImapProtocol::GetArbitraryHeadersToDow</span>
<a href="#l25.29"></a><span id="l25.29"> {</span>
<a href="#l25.30"></a><span id="l25.30">   if (m_imapServerSink)</span>
<a href="#l25.31"></a><span id="l25.31">     m_imapServerSink-&gt;GetArbitraryHeaders(aResult);</span>
<a href="#l25.32"></a><span id="l25.32"> }</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34"> void</span>
<a href="#l25.35"></a><span id="l25.35"> nsImapProtocol::AdjustChunkSize()</span>
<a href="#l25.36"></a><span id="l25.36"> {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-  PRTime deltaTime;</span>
<a href="#l25.38"></a><span id="l25.38">   PRInt32 deltaInSeconds;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-  m_endTime = PR_Now();</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-  LL_SUB(deltaTime, m_endTime, m_startTime);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-  PRTime2Seconds(deltaTime, &amp;deltaInSeconds);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+  PRTime2Seconds(m_endTime - m_startTime, &amp;deltaInSeconds);</span>
<a href="#l25.44"></a><span id="l25.44">   m_trackingTime = false;</span>
<a href="#l25.45"></a><span id="l25.45">   if (deltaInSeconds &lt; 0)</span>
<a href="#l25.46"></a><span id="l25.46">     return;            // bogus for some reason</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">   if (deltaInSeconds &lt;= m_tooFastTime &amp;&amp; m_curFetchSize &gt;= m_chunkSize)</span>
<a href="#l25.49"></a><span id="l25.49">   {</span>
<a href="#l25.50"></a><span id="l25.50">     m_chunkSize += m_chunkAddSize;</span>
<a href="#l25.51"></a><span id="l25.51">     m_chunkThreshold = m_chunkSize + (m_chunkSize / 2);</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineat">@@ -4994,17 +4990,17 @@ nsImapProtocol::AlertUserEventFromServer</span>
<a href="#l25.53"></a><span id="l25.53">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l25.54"></a><span id="l25.54">       m_imapServerSink-&gt;FEAlertFromServer(nsDependentCString(aServerEvent),</span>
<a href="#l25.55"></a><span id="l25.55">                                           mailnewsUrl);</span>
<a href="#l25.56"></a><span id="l25.56">     }</span>
<a href="#l25.57"></a><span id="l25.57"> }</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59"> void nsImapProtocol::ResetProgressInfo()</span>
<a href="#l25.60"></a><span id="l25.60"> {</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  LL_I2L(m_lastProgressTime, 0);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  m_lastProgressTime = 0;</span>
<a href="#l25.63"></a><span id="l25.63">   m_lastPercent = -1;</span>
<a href="#l25.64"></a><span id="l25.64">   m_lastProgressStringId = (PRUint32) -1;</span>
<a href="#l25.65"></a><span id="l25.65"> }</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67"> void nsImapProtocol::SetProgressString(PRInt32 stringId)</span>
<a href="#l25.68"></a><span id="l25.68"> {</span>
<a href="#l25.69"></a><span id="l25.69">   m_progressStringId = stringId;</span>
<a href="#l25.70"></a><span id="l25.70">   if (m_progressStringId &amp;&amp; m_imapServerSink)</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineat">@@ -5057,31 +5053,25 @@ nsImapProtocol::ProgressEventFunctionUsi</span>
<a href="#l25.72"></a><span id="l25.72">     if (NS_SUCCEEDED(rv))</span>
<a href="#l25.73"></a><span id="l25.73">       m_imapMailFolderSink-&gt;ProgressStatus(this, aMsgId, unicodeStr.get());</span>
<a href="#l25.74"></a><span id="l25.74">   }</span>
<a href="#l25.75"></a><span id="l25.75"> }</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77"> void</span>
<a href="#l25.78"></a><span id="l25.78"> nsImapProtocol::PercentProgressUpdateEvent(PRUnichar *message, PRInt64 currentProgress, PRInt64 maxProgress)</span>
<a href="#l25.79"></a><span id="l25.79"> {</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  PRInt64 nowMS = LL_ZERO;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+  PRInt64 nowMS = 0;</span>
<a href="#l25.82"></a><span id="l25.82">   PRInt32 percent = (100 * currentProgress) / maxProgress;</span>
<a href="#l25.83"></a><span id="l25.83">   if (percent == m_lastPercent)</span>
<a href="#l25.84"></a><span id="l25.84">     return; // hasn't changed, right? So just return. Do we need to clear this anywhere?</span>
<a href="#l25.85"></a><span id="l25.85"> </span>
<a href="#l25.86"></a><span id="l25.86">   if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l25.87"></a><span id="l25.87">   {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-    int64 minIntervalBetweenProgress;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-    LL_I2L(minIntervalBetweenProgress, 750);</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-    int64 diffSinceLastProgress;</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-    LL_I2L(nowMS, PR_IntervalToMilliseconds(PR_IntervalNow()));</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-    LL_SUB(diffSinceLastProgress, nowMS, m_lastProgressTime); // r = a - b</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-    LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-    if (!LL_GE_ZERO(diffSinceLastProgress))</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+    nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+    if (nowMS - m_lastProgressTime &lt; 750)</span>
<a href="#l25.98"></a><span id="l25.98">       return;</span>
<a href="#l25.99"></a><span id="l25.99">   }</span>
<a href="#l25.100"></a><span id="l25.100"> </span>
<a href="#l25.101"></a><span id="l25.101">   m_lastPercent = percent;</span>
<a href="#l25.102"></a><span id="l25.102">   m_lastProgressTime = nowMS;</span>
<a href="#l25.103"></a><span id="l25.103"> </span>
<a href="#l25.104"></a><span id="l25.104">   // set our max progress on the running URL</span>
<a href="#l25.105"></a><span id="l25.105">   if (m_runningUrl)</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineat">@@ -8476,18 +8466,17 @@ NS_IMETHODIMP nsImapProtocol::OverrideCo</span>
<a href="#l25.107"></a><span id="l25.107"> bool nsImapProtocol::CheckNeeded()</span>
<a href="#l25.108"></a><span id="l25.108"> {</span>
<a href="#l25.109"></a><span id="l25.109">   if (m_flagChangeCount &gt;= kFlagChangesBeforeCheck)</span>
<a href="#l25.110"></a><span id="l25.110">     return true;</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112">   PRTime deltaTime;</span>
<a href="#l25.113"></a><span id="l25.113">   PRInt32 deltaInSeconds;</span>
<a href="#l25.114"></a><span id="l25.114"> </span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-  LL_SUB(deltaTime, PR_Now(), m_lastCheckTime);</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-  PRTime2Seconds(deltaTime, &amp;deltaInSeconds);</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+  PRTime2Seconds(PR_Now() - m_lastCheckTime, &amp;deltaInSeconds);</span>
<a href="#l25.118"></a><span id="l25.118"> </span>
<a href="#l25.119"></a><span id="l25.119">   return (deltaInSeconds &gt;= kMaxSecondsBeforeCheck);</span>
<a href="#l25.120"></a><span id="l25.120"> }</span>
<a href="#l25.121"></a><span id="l25.121"> </span>
<a href="#l25.122"></a><span id="l25.122"> bool nsImapProtocol::UseCondStore()</span>
<a href="#l25.123"></a><span id="l25.123"> {</span>
<a href="#l25.124"></a><span id="l25.124">   // Check that the server is capable of cond store, and the user</span>
<a href="#l25.125"></a><span id="l25.125">   // hasn't disabled the use of constore for this server.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -70,28 +70,28 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.7"></a><span id="l26.7"> // nsLocal</span>
<a href="#l26.8"></a><span id="l26.8"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> nsLocalMailCopyState::nsLocalMailCopyState() :</span>
<a href="#l26.11"></a><span id="l26.11">   m_flags(0),</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+  m_lastProgressTime(PR_IntervalToMilliseconds(PR_IntervalNow())),</span>
<a href="#l26.13"></a><span id="l26.13">   m_curDstKey(0xffffffff),</span>
<a href="#l26.14"></a><span id="l26.14">   m_curCopyIndex(0),</span>
<a href="#l26.15"></a><span id="l26.15">   m_totalMsgCount(0),</span>
<a href="#l26.16"></a><span id="l26.16">   m_dataBufferSize(0),</span>
<a href="#l26.17"></a><span id="l26.17">   m_leftOver(0),</span>
<a href="#l26.18"></a><span id="l26.18">   m_isMove(false),</span>
<a href="#l26.19"></a><span id="l26.19">   m_dummyEnvelopeNeeded(false),</span>
<a href="#l26.20"></a><span id="l26.20">   m_fromLineSeen(false),</span>
<a href="#l26.21"></a><span id="l26.21">   m_writeFailed(false),</span>
<a href="#l26.22"></a><span id="l26.22">   m_notifyFolderLoaded(false)</span>
<a href="#l26.23"></a><span id="l26.23"> {</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-  LL_I2L(m_lastProgressTime, PR_IntervalToMilliseconds(PR_IntervalNow()));</span>
<a href="#l26.25"></a><span id="l26.25"> }</span>
<a href="#l26.26"></a><span id="l26.26"> </span>
<a href="#l26.27"></a><span id="l26.27"> nsLocalMailCopyState::~nsLocalMailCopyState()</span>
<a href="#l26.28"></a><span id="l26.28"> {</span>
<a href="#l26.29"></a><span id="l26.29">   PR_Free(m_dataBuffer);</span>
<a href="#l26.30"></a><span id="l26.30">   if (m_fileStream)</span>
<a href="#l26.31"></a><span id="l26.31">     m_fileStream-&gt;Close();</span>
<a href="#l26.32"></a><span id="l26.32">   if (m_messageService)</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineat">@@ -3182,26 +3182,21 @@ nsresult nsMsgLocalMailFolder::DisplayMo</span>
<a href="#l26.34"></a><span id="l26.34">       numMsgSoFarString.AppendInt((mCopyState-&gt;m_copyingMultipleMessages) ? mCopyState-&gt;m_curCopyIndex : 1);</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">       nsAutoString totalMessagesString;</span>
<a href="#l26.37"></a><span id="l26.37">       totalMessagesString.AppendInt(mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l26.38"></a><span id="l26.38">       nsString finalString;</span>
<a href="#l26.39"></a><span id="l26.39">       const PRUnichar * stringArray[] = { numMsgSoFarString.get(), totalMessagesString.get(), folderName.get() };</span>
<a href="#l26.40"></a><span id="l26.40">       rv = mCopyState-&gt;m_stringBundle-&gt;FormatStringFromID(statusMsgId, stringArray, 3,</span>
<a href="#l26.41"></a><span id="l26.41">                                                getter_Copies(finalString));</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-      PRInt64 minIntervalBetweenProgress;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-      PRInt64 nowMS = LL_ZERO;</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+      PRInt64 nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46">       // only update status/progress every half second</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-      LL_I2L(minIntervalBetweenProgress, 500);</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-      PRInt64 diffSinceLastProgress;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-      LL_I2L(nowMS, PR_IntervalToMilliseconds(PR_IntervalNow()));</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-      LL_SUB(diffSinceLastProgress, nowMS, mCopyState-&gt;m_lastProgressTime); // r = a - b</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-      LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-      if (!LL_GE_ZERO(diffSinceLastProgress) &amp;&amp; mCopyState-&gt;m_curCopyIndex &lt; mCopyState-&gt;m_totalMsgCount)</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+      if (nowMS - mCopyState-&gt;m_lastProgressTime &lt; 500 &amp;&amp;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+          mCopyState-&gt;m_curCopyIndex &lt; mCopyState-&gt;m_totalMsgCount)</span>
<a href="#l26.55"></a><span id="l26.55">         return NS_OK;</span>
<a href="#l26.56"></a><span id="l26.56"> </span>
<a href="#l26.57"></a><span id="l26.57">       mCopyState-&gt;m_lastProgressTime = nowMS;</span>
<a href="#l26.58"></a><span id="l26.58">       mCopyState-&gt;m_statusFeedback-&gt;ShowStatusString(finalString);</span>
<a href="#l26.59"></a><span id="l26.59">       mCopyState-&gt;m_statusFeedback-&gt;ShowProgress(mCopyState-&gt;m_curCopyIndex * 100 / mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l26.60"></a><span id="l26.60">     }</span>
<a href="#l26.61"></a><span id="l26.61">   }</span>
<a href="#l26.62"></a><span id="l26.62">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -595,17 +595,17 @@ NS_IMETHODIMP nsParseMailMessageState::C</span>
<a href="#l27.4"></a><span id="l27.4">   m_bccList.length = 0;</span>
<a href="#l27.5"></a><span id="l27.5">   m_body_lines = 0;</span>
<a href="#l27.6"></a><span id="l27.6">   m_newMsgHdr = nsnull;</span>
<a href="#l27.7"></a><span id="l27.7">   m_envelope_pos = 0;</span>
<a href="#l27.8"></a><span id="l27.8">   ClearAggregateHeader (m_toList);</span>
<a href="#l27.9"></a><span id="l27.9">   ClearAggregateHeader (m_ccList);</span>
<a href="#l27.10"></a><span id="l27.10">   m_headers.ResetWritePos();</span>
<a href="#l27.11"></a><span id="l27.11">   m_envelope.ResetWritePos();</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  m_receivedTime = LL_ZERO;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  m_receivedTime = 0;</span>
<a href="#l27.14"></a><span id="l27.14">   for (PRUint32 i = 0; i &lt; m_customDBHeaders.Length(); i++)</span>
<a href="#l27.15"></a><span id="l27.15">     m_customDBHeaderValues[i].length = 0;</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17">   return NS_OK;</span>
<a href="#l27.18"></a><span id="l27.18"> }</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20"> NS_IMETHODIMP nsParseMailMessageState::SetState(nsMailboxParseState aState)</span>
<a href="#l27.21"></a><span id="l27.21"> {</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -1113,17 +1113,17 @@ SEARCH_NEWLINE:</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">     if (header)</span>
<a href="#l27.25"></a><span id="l27.25">     {</span>
<a href="#l27.26"></a><span id="l27.26">       /* More const short-circuitry... */</span>
<a href="#l27.27"></a><span id="l27.27">       /* strip trailing whitespace */</span>
<a href="#l27.28"></a><span id="l27.28">       while (header-&gt;length &gt; 0 &amp;&amp;</span>
<a href="#l27.29"></a><span id="l27.29">         IS_SPACE (header-&gt;value [header-&gt;length - 1]))</span>
<a href="#l27.30"></a><span id="l27.30">         ((char *) header-&gt;value) [--header-&gt;length] = 0;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-      if (header == &amp;receivedBy &amp;&amp; LL_IS_ZERO(m_receivedTime))</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+      if (header == &amp;receivedBy &amp;&amp; m_receivedTime == 0)</span>
<a href="#l27.33"></a><span id="l27.33">       {</span>
<a href="#l27.34"></a><span id="l27.34">         // parse Received: header for date.</span>
<a href="#l27.35"></a><span id="l27.35">         // We trust the first header as that is closest to recipient,</span>
<a href="#l27.36"></a><span id="l27.36">         // and less likely to be spoofed.</span>
<a href="#l27.37"></a><span id="l27.37">         nsCAutoString receivedHdr(header-&gt;value, header-&gt;length);</span>
<a href="#l27.38"></a><span id="l27.38">         PRInt32 lastSemicolon = receivedHdr.RFindChar(';');</span>
<a href="#l27.39"></a><span id="l27.39">         if (lastSemicolon != -1)</span>
<a href="#l27.40"></a><span id="l27.40">         {</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineat">@@ -1575,17 +1575,17 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l27.42"></a><span id="l27.42">           // couldn't get a valid envelope date, use now as the time.</span>
<a href="#l27.43"></a><span id="l27.43">           // PR_ParseTimeString won't touch resultTime unless it succeeds.</span>
<a href="#l27.44"></a><span id="l27.44">           // This doesn't affect local (POP3) messages, because we use the envelope</span>
<a href="#l27.45"></a><span id="l27.45">           // date if there's no Date: header, but it will affect IMAP msgs</span>
<a href="#l27.46"></a><span id="l27.46">           // w/o a Date: hdr or Received: headers.</span>
<a href="#l27.47"></a><span id="l27.47">           PRTime resultTime = PR_Now();</span>
<a href="#l27.48"></a><span id="l27.48">           m_newMsgHdr-&gt;SetDate(resultTime);</span>
<a href="#l27.49"></a><span id="l27.49">         }</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-        if (!LL_IS_ZERO(m_receivedTime))</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+        if (m_receivedTime != 0)</span>
<a href="#l27.52"></a><span id="l27.52">         {  // Upgrade 'Received' to Received: ?</span>
<a href="#l27.53"></a><span id="l27.53">           PRTime2Seconds(m_receivedTime, &amp;rcvTimeSecs);</span>
<a href="#l27.54"></a><span id="l27.54">         }</span>
<a href="#l27.55"></a><span id="l27.55">         else if (deliveryDate)</span>
<a href="#l27.56"></a><span id="l27.56">         {  // Upgrade 'Received' to Delivery-date: ?</span>
<a href="#l27.57"></a><span id="l27.57">           PRTime resultTime;</span>
<a href="#l27.58"></a><span id="l27.58">           PRStatus timeStatus = PR_ParseTimeString (deliveryDate-&gt;value, false, &amp;resultTime);</span>
<a href="#l27.59"></a><span id="l27.59">           if (PR_SUCCESS == timeStatus)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -58,23 +58,17 @@ net_pop3_remove_messages_marked_delete(P</span>
<a href="#l28.4"></a><span id="l28.4"> {</span>
<a href="#l28.5"></a><span id="l28.5">   Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l28.6"></a><span id="l28.6">   return (uidlEntry-&gt;status == DELETE_CHAR)</span>
<a href="#l28.7"></a><span id="l28.7">     ? HT_ENUMERATE_REMOVE : HT_ENUMERATE_NEXT;</span>
<a href="#l28.8"></a><span id="l28.8"> }</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> PRUint32 TimeInSecondsFromPRTime(PRTime prTime)</span>
<a href="#l28.11"></a><span id="l28.11"> {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  PRUint32 retTimeInSeconds;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  PRInt64 microSecondsPerSecond, intermediateResult;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  LL_DIV(intermediateResult, prTime, microSecondsPerSecond);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-  LL_L2UI(retTimeInSeconds, intermediateResult);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-  return retTimeInSeconds;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+  return (PRUint32)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l28.20"></a><span id="l28.20"> }</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22"> static void</span>
<a href="#l28.23"></a><span id="l28.23"> put_hash(PLHashTable* table, const char* key, char value, PRUint32 dateReceived)</span>
<a href="#l28.24"></a><span id="l28.24"> {</span>
<a href="#l28.25"></a><span id="l28.25">   // don't put not used slots or empty uid into hash</span>
<a href="#l28.26"></a><span id="l28.26">   if (key &amp;&amp; *key)</span>
<a href="#l28.27"></a><span id="l28.27">   {</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineat">@@ -2968,17 +2962,17 @@ PRInt32 nsPop3Protocol::GetMsg()</span>
<a href="#l28.29"></a><span id="l28.29">       return(0);</span>
<a href="#l28.30"></a><span id="l28.30">     }</span>
<a href="#l28.31"></a><span id="l28.31">     /* get the amount of available space on the drive</span>
<a href="#l28.32"></a><span id="l28.32">      * and make sure there is enough</span>
<a href="#l28.33"></a><span id="l28.33">      */</span>
<a href="#l28.34"></a><span id="l28.34">     if (m_totalDownloadSize &gt; 0) // skip all this if there aren't any messages</span>
<a href="#l28.35"></a><span id="l28.35">     {</span>
<a href="#l28.36"></a><span id="l28.36">       nsresult rv;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-      PRInt64 mailboxSpaceLeft = LL_Zero();</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+      PRInt64 mailboxSpaceLeft = 0;</span>
<a href="#l28.39"></a><span id="l28.39">       nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l28.40"></a><span id="l28.40">       nsCOMPtr &lt;nsIFile&gt; path;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">       // Get the path to the current mailbox</span>
<a href="#l28.43"></a><span id="l28.43">       //</span>
<a href="#l28.44"></a><span id="l28.44">       NS_ENSURE_TRUE(m_nsIPop3Sink, NS_ERROR_UNEXPECTED);</span>
<a href="#l28.45"></a><span id="l28.45">       rv = m_nsIPop3Sink-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l28.46"></a><span id="l28.46">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineat">@@ -3010,24 +3004,17 @@ PRInt32 nsPop3Protocol::GetMsg()</span>
<a href="#l28.48"></a><span id="l28.48"> </span>
<a href="#l28.49"></a><span id="l28.49">         /* When checking for disk space available, take into consideration</span>
<a href="#l28.50"></a><span id="l28.50">         * possible database</span>
<a href="#l28.51"></a><span id="l28.51">         * changes, therefore ask for a little more than what the message</span>
<a href="#l28.52"></a><span id="l28.52">         * size is. Also, due to disk sector sizes, allocation blocks,</span>
<a href="#l28.53"></a><span id="l28.53">         * etc. The space &quot;available&quot; may be greater than the actual space</span>
<a href="#l28.54"></a><span id="l28.54">         * usable. */</span>
<a href="#l28.55"></a><span id="l28.55"> </span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-        PRInt64 llResult;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-        PRInt64 llExtraSafetySpace;</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-        PRInt64 llTotalDownloadSize;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-        LL_I2L(llExtraSafetySpace, EXTRA_SAFETY_SPACE);</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-        LL_I2L(llTotalDownloadSize, m_totalDownloadSize);</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-        LL_ADD(llResult, llTotalDownloadSize, llExtraSafetySpace);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-        if (LL_CMP(llResult, &gt;, mailboxSpaceLeft))</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+        if (m_totalDownloadSize + PRInt64(EXTRA_SAFETY_SPACE) &gt; mailboxSpaceLeft)</span>
<a href="#l28.65"></a><span id="l28.65">         {</span>
<a href="#l28.66"></a><span id="l28.66">           // Not enough disk space!</span>
<a href="#l28.67"></a><span id="l28.67"> #ifdef DEBUG</span>
<a href="#l28.68"></a><span id="l28.68">           printf(&quot;Not enough disk space! Raising error! \n&quot;);</span>
<a href="#l28.69"></a><span id="l28.69"> #endif</span>
<a href="#l28.70"></a><span id="l28.70">           return (Error(MK_POP3_OUT_OF_DISK_SPACE));</span>
<a href="#l28.71"></a><span id="l28.71">         }</span>
<a href="#l28.72"></a><span id="l28.72">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -68,25 +68,25 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> nsNNTPNewsgroupList::nsNNTPNewsgroupList()</span>
<a href="#l29.6"></a><span id="l29.6">   : m_finishingXover(false),</span>
<a href="#l29.7"></a><span id="l29.7">   m_getOldMessages(false),</span>
<a href="#l29.8"></a><span id="l29.8">   m_promptedAlready(false),</span>
<a href="#l29.9"></a><span id="l29.9">   m_downloadAll(false),</span>
<a href="#l29.10"></a><span id="l29.10">   m_maxArticles(0),</span>
<a href="#l29.11"></a><span id="l29.11">   m_lastPercent(-1),</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+  m_lastStatusUpdate(0),</span>
<a href="#l29.13"></a><span id="l29.13">   m_lastProcessedNumber(0),</span>
<a href="#l29.14"></a><span id="l29.14">   m_firstMsgNumber(0),</span>
<a href="#l29.15"></a><span id="l29.15">   m_lastMsgNumber(0),</span>
<a href="#l29.16"></a><span id="l29.16">   m_firstMsgToDownload(0),</span>
<a href="#l29.17"></a><span id="l29.17">   m_lastMsgToDownload(0),</span>
<a href="#l29.18"></a><span id="l29.18">   m_set(nsnull)</span>
<a href="#l29.19"></a><span id="l29.19"> {</span>
<a href="#l29.20"></a><span id="l29.20">   memset(&amp;m_knownArts, 0, sizeof(m_knownArts));</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-  m_lastStatusUpdate = LL_Zero();</span>
<a href="#l29.22"></a><span id="l29.22"> }</span>
<a href="#l29.23"></a><span id="l29.23"> </span>
<a href="#l29.24"></a><span id="l29.24"> nsNNTPNewsgroupList::~nsNNTPNewsgroupList()</span>
<a href="#l29.25"></a><span id="l29.25"> {</span>
<a href="#l29.26"></a><span id="l29.26">   CleanUp();</span>
<a href="#l29.27"></a><span id="l29.27"> }</span>
<a href="#l29.28"></a><span id="l29.28"> </span>
<a href="#l29.29"></a><span id="l29.29"> NS_IMPL_ISUPPORTS2(nsNNTPNewsgroupList, nsINNTPNewsgroupList, nsIMsgFilterHitNotify)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -287,17 +287,17 @@ nsNNTPProtocol::nsNNTPProtocol(nsINntpIn</span>
<a href="#l30.4"></a><span id="l30.4">     m_msgWindow = aMsgWindow;</span>
<a href="#l30.5"></a><span id="l30.5">   }</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7">   m_runningURL = nsnull;</span>
<a href="#l30.8"></a><span id="l30.8">   m_fromCache = false;</span>
<a href="#l30.9"></a><span id="l30.9">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) creating&quot;,this));</span>
<a href="#l30.10"></a><span id="l30.10">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) initializing, so unset m_currentGroup&quot;,this));</span>
<a href="#l30.11"></a><span id="l30.11">   m_currentGroup.Truncate();</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  LL_I2L(m_lastActiveTimeStamp, 0);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  m_lastActiveTimeStamp = 0;</span>
<a href="#l30.14"></a><span id="l30.14"> }</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16"> nsNNTPProtocol::~nsNNTPProtocol()</span>
<a href="#l30.17"></a><span id="l30.17"> {</span>
<a href="#l30.18"></a><span id="l30.18">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) destroying&quot;,this));</span>
<a href="#l30.19"></a><span id="l30.19">   if (m_nntpServer) {</span>
<a href="#l30.20"></a><span id="l30.20">     m_nntpServer-&gt;WriteNewsrcFile();</span>
<a href="#l30.21"></a><span id="l30.21">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -1759,20 +1759,17 @@ PRInt32 nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l30.23"></a><span id="l30.23">       if (!last_update)</span>
<a href="#l30.24"></a><span id="l30.24">     {</span>
<a href="#l30.25"></a><span id="l30.25">         NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l30.26"></a><span id="l30.26">       }</span>
<a href="#l30.27"></a><span id="l30.27">     else</span>
<a href="#l30.28"></a><span id="l30.28">       {</span>
<a href="#l30.29"></a><span id="l30.29">         char small_buf[64];</span>
<a href="#l30.30"></a><span id="l30.30">         PRExplodedTime  expandedTime;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-        PRTime t_usec, usec_per_sec;</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-        LL_I2L(t_usec, last_update);</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-        LL_I2L(usec_per_sec, PR_USEC_PER_SEC);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-        LL_MUL(t_usec, t_usec, usec_per_sec);</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+        PRTime t_usec = (PRTime)last_update * PR_USEC_PER_SEC;</span>
<a href="#l30.36"></a><span id="l30.36">         PR_ExplodeTime(t_usec, PR_LocalTimeParameters, &amp;expandedTime);</span>
<a href="#l30.37"></a><span id="l30.37">         PR_FormatTimeUSEnglish(small_buf, sizeof(small_buf),</span>
<a href="#l30.38"></a><span id="l30.38">                                &quot;NEWGROUPS %y%m%d %H%M%S&quot;, &amp;expandedTime);</span>
<a href="#l30.39"></a><span id="l30.39">         NS_MsgSACopy(&amp;command, small_buf);</span>
<a href="#l30.40"></a><span id="l30.40">       }</span>
<a href="#l30.41"></a><span id="l30.41">   }</span>
<a href="#l30.42"></a><span id="l30.42">     else if(m_typeWanted == LIST_WANTED)</span>
<a href="#l30.43"></a><span id="l30.43">     {</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineat">@@ -2722,23 +2719,17 @@ PRInt32 nsNNTPProtocol::BeginReadNewsLis</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46"> #define RATE_CONSTANT 976.5625      /* PR_USEC_PER_SEC / 1024 bytes */</span>
<a href="#l30.47"></a><span id="l30.47"> </span>
<a href="#l30.48"></a><span id="l30.48"> static void ComputeRate(PRInt32 bytes, PRTime startTime, float *rate)</span>
<a href="#l30.49"></a><span id="l30.49"> {</span>
<a href="#l30.50"></a><span id="l30.50">   // rate = (bytes / USECS since start) * RATE_CONSTANT</span>
<a href="#l30.51"></a><span id="l30.51"> </span>
<a href="#l30.52"></a><span id="l30.52">   // compute usecs since we started.</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-  PRTime timeSinceStart;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-  PRTime now = PR_Now();</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-  LL_SUB(timeSinceStart, now, startTime);</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-  // convert PRTime to PRInt32</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-  PRInt32 delta;</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-  LL_L2I(delta, timeSinceStart);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+  PRInt32 delta = (PRInt32)(PR_Now() - startTime);</span>
<a href="#l30.61"></a><span id="l30.61"> </span>
<a href="#l30.62"></a><span id="l30.62">   // compute rate</span>
<a href="#l30.63"></a><span id="l30.63">   if (delta &gt; 0) {</span>
<a href="#l30.64"></a><span id="l30.64">     *rate = (float) ((bytes * RATE_CONSTANT) / delta);</span>
<a href="#l30.65"></a><span id="l30.65">   }</span>
<a href="#l30.66"></a><span id="l30.66">   else {</span>
<a href="#l30.67"></a><span id="l30.67">     *rate = 0.0;</span>
<a href="#l30.68"></a><span id="l30.68">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -57,17 +57,17 @@ nsNewsDownloader::nsNewsDownloader(nsIMs</span>
<a href="#l31.4"></a><span id="l31.4"> {</span>
<a href="#l31.5"></a><span id="l31.5">   m_numwrote = 0;</span>
<a href="#l31.6"></a><span id="l31.6">   m_downloadFromKeys = false;</span>
<a href="#l31.7"></a><span id="l31.7">   m_newsDB = msgDB;</span>
<a href="#l31.8"></a><span id="l31.8">   m_abort = false;</span>
<a href="#l31.9"></a><span id="l31.9">   m_listener = listener;</span>
<a href="#l31.10"></a><span id="l31.10">   m_window = window;</span>
<a href="#l31.11"></a><span id="l31.11">   m_lastPercent = -1;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  LL_I2L(m_lastProgressTime, 0);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  m_lastProgressTime = 0;</span>
<a href="#l31.14"></a><span id="l31.14">   // not the perfect place for this, but I think it will work.</span>
<a href="#l31.15"></a><span id="l31.15">   if (m_window)</span>
<a href="#l31.16"></a><span id="l31.16">     m_window-&gt;SetStopped(false);</span>
<a href="#l31.17"></a><span id="l31.17"> }</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19"> nsNewsDownloader::~nsNewsDownloader()</span>
<a href="#l31.20"></a><span id="l31.20"> {</span>
<a href="#l31.21"></a><span id="l31.21">   if (m_listener)</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -163,27 +163,21 @@ bool nsNewsDownloader::GetNextHdrToRetri</span>
<a href="#l31.23"></a><span id="l31.23">   {</span>
<a href="#l31.24"></a><span id="l31.24">     if (m_numwrote &gt;= (PRInt32) m_keysToDownload.Length())</span>
<a href="#l31.25"></a><span id="l31.25">       return false;</span>
<a href="#l31.26"></a><span id="l31.26"> </span>
<a href="#l31.27"></a><span id="l31.27">     m_keyToDownload = m_keysToDownload[m_numwrote++];</span>
<a href="#l31.28"></a><span id="l31.28">     PRInt32 percent;</span>
<a href="#l31.29"></a><span id="l31.29">     percent = (100 * m_numwrote) / (PRInt32) m_keysToDownload.Length();</span>
<a href="#l31.30"></a><span id="l31.30"> </span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-    PRInt64 nowMS = LL_ZERO;</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+    PRInt64 nowMS = 0;</span>
<a href="#l31.33"></a><span id="l31.33">     if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l31.34"></a><span id="l31.34">     {</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-      int64 minIntervalBetweenProgress;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-      LL_I2L(minIntervalBetweenProgress, 750);</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-      int64 diffSinceLastProgress;</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-      LL_I2L(nowMS, PR_IntervalToMilliseconds(PR_IntervalNow()));</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-      LL_SUB(diffSinceLastProgress, nowMS, m_lastProgressTime); // r = a - b</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-      LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-      if (!LL_GE_ZERO(diffSinceLastProgress))</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+      nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+      if (nowMS - m_lastProgressTime &lt; 750)</span>
<a href="#l31.45"></a><span id="l31.45">         return true;</span>
<a href="#l31.46"></a><span id="l31.46">     }</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48">     m_lastProgressTime = nowMS;</span>
<a href="#l31.49"></a><span id="l31.49">     nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_folder);</span>
<a href="#l31.50"></a><span id="l31.50">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l31.51"></a><span id="l31.51">       mozilla::services::GetStringBundleService();</span>
<a href="#l31.52"></a><span id="l31.52">     NS_ENSURE_TRUE(bundleService, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -447,27 +447,20 @@ NS_IMPL_SERVERPREF_INT(nsNntpIncomingSer</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5"> bool</span>
<a href="#l32.6"></a><span id="l32.6"> nsNntpIncomingServer::ConnectionTimeOut(nsINNTPProtocol* aConnection)</span>
<a href="#l32.7"></a><span id="l32.7"> {</span>
<a href="#l32.8"></a><span id="l32.8">     bool retVal = false;</span>
<a href="#l32.9"></a><span id="l32.9">     if (!aConnection) return retVal;</span>
<a href="#l32.10"></a><span id="l32.10">     nsresult rv;</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    PRTime cacheTimeoutLimits;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-    LL_I2L(cacheTimeoutLimits, 170 * 1000000); // 170 seconds in microseconds</span>
<a href="#l32.15"></a><span id="l32.15">     PRTime lastActiveTimeStamp;</span>
<a href="#l32.16"></a><span id="l32.16">     rv = aConnection-&gt;GetLastActiveTimeStamp(&amp;lastActiveTimeStamp);</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-    PRTime elapsedTime;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-    LL_SUB(elapsedTime, PR_Now(), lastActiveTimeStamp);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-    PRTime t;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-    LL_SUB(t, elapsedTime, cacheTimeoutLimits);</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-    if (LL_GE_ZERO(t))</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+    if (PR_Now() - lastActiveTimeStamp &gt;= PRTime(170) * PR_USEC_PER_SEC)</span>
<a href="#l32.24"></a><span id="l32.24">     {</span>
<a href="#l32.25"></a><span id="l32.25"> #ifdef DEBUG_seth</span>
<a href="#l32.26"></a><span id="l32.26">       printf(&quot;XXX connection timed out, close it, and remove it from the connection cache\n&quot;);</span>
<a href="#l32.27"></a><span id="l32.27"> #endif</span>
<a href="#l32.28"></a><span id="l32.28">       aConnection-&gt;CloseConnection();</span>
<a href="#l32.29"></a><span id="l32.29">       mConnectionCache.RemoveObject(aConnection);</span>
<a href="#l32.30"></a><span id="l32.30">       retVal = true;</span>
<a href="#l32.31"></a><span id="l32.31">     }</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineat">@@ -785,19 +778,17 @@ void nsNntpIncomingServer::WriteLine(nsI</span>
<a href="#l32.33"></a><span id="l32.33">   str.Append(MSG_LINEBREAK);</span>
<a href="#l32.34"></a><span id="l32.34">   stream-&gt;Write(str.get(), str.Length(), &amp;bytesWritten);</span>
<a href="#l32.35"></a><span id="l32.35"> }</span>
<a href="#l32.36"></a><span id="l32.36"> nsresult</span>
<a href="#l32.37"></a><span id="l32.37"> nsNntpIncomingServer::WriteHostInfoFile()</span>
<a href="#l32.38"></a><span id="l32.38"> {</span>
<a href="#l32.39"></a><span id="l32.39">   if (!mHostInfoHasChanged)</span>
<a href="#l32.40"></a><span id="l32.40">     return NS_OK;</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-  PRInt32 firstnewdate;</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-  LL_L2I(firstnewdate, mFirstNewDate);</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+  PRInt32 firstnewdate = (PRInt32)mFirstNewDate;</span>
<a href="#l32.45"></a><span id="l32.45"> </span>
<a href="#l32.46"></a><span id="l32.46">   mLastUpdatedTime = PRUint32(PR_Now() / PR_USEC_PER_SEC);</span>
<a href="#l32.47"></a><span id="l32.47"> </span>
<a href="#l32.48"></a><span id="l32.48">   nsCString hostname;</span>
<a href="#l32.49"></a><span id="l32.49">   nsresult rv = GetHostName(hostname);</span>
<a href="#l32.50"></a><span id="l32.50">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.51"></a><span id="l32.51"> </span>
<a href="#l32.52"></a><span id="l32.52">   if (!mHostInfoFile)</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineat">@@ -1238,18 +1229,17 @@ nsNntpIncomingServer::HandleLine(const c</span>
<a href="#l32.54"></a><span id="l32.54">       mHasSeenBeginGroups = true;</span>
<a href="#l32.55"></a><span id="l32.55">     }</span>
<a href="#l32.56"></a><span id="l32.56">     char*equalPos = (char *) PL_strchr(line, '=');</span>
<a href="#l32.57"></a><span id="l32.57">     if (equalPos) {</span>
<a href="#l32.58"></a><span id="l32.58">       *equalPos++ = '\0';</span>
<a href="#l32.59"></a><span id="l32.59">       if (PL_strcmp(line, &quot;lastgroupdate&quot;) == 0) {</span>
<a href="#l32.60"></a><span id="l32.60">         mLastUpdatedTime = strtoul(equalPos, nsnull, 10);</span>
<a href="#l32.61"></a><span id="l32.61">       } else if (PL_strcmp(line, &quot;firstnewdate&quot;) == 0) {</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-        PRInt32 firstnewdate = strtol(equalPos, nsnull, 16);</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-        LL_I2L(mFirstNewDate, firstnewdate);</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+        mFirstNewDate = strtol(equalPos, nsnull, 16);</span>
<a href="#l32.65"></a><span id="l32.65">       } else if (PL_strcmp(line, &quot;uniqueid&quot;) == 0) {</span>
<a href="#l32.66"></a><span id="l32.66">         mUniqueId = strtol(equalPos, nsnull, 16);</span>
<a href="#l32.67"></a><span id="l32.67">       } else if (PL_strcmp(line, &quot;version&quot;) == 0) {</span>
<a href="#l32.68"></a><span id="l32.68">         mVersion = strtol(equalPos, nsnull, 16);</span>
<a href="#l32.69"></a><span id="l32.69">       }</span>
<a href="#l32.70"></a><span id="l32.70">     }</span>
<a href="#l32.71"></a><span id="l32.71">   }</span>
<a href="#l32.72"></a><span id="l32.72"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

