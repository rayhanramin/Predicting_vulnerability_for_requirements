<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 40:23da5cab793a16a758f400d6f76406ca46987c2d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 23da5cab793a16a758f400d6f76406ca46987c2d" />
<meta property="og:url" content="/comm-central/rev/23da5cab793a16a758f400d6f76406ca46987c2d" />
<meta property="og:description" content="Bug 16913 - Filter on any header, for news. r=bienvenu,Standard8 sr=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 23da5cab793a16a758f400d6f76406ca46987c2d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/23da5cab793a16a758f400d6f76406ca46987c2d">shortlog</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/23da5cab793a16a758f400d6f76406ca46987c2d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d">files</a> |
changeset |
<a href="/comm-central/raw-rev/23da5cab793a16a758f400d6f76406ca46987c2d">raw</a>  | <a href="/comm-central/archive/23da5cab793a16a758f400d6f76406ca46987c2d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=16913">Bug 16913</a> - Filter on any header, for news. r=bienvenu,Standard8 sr=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 28 Jul 2008 12:17:26 -0700</td></tr>

<tr>
 <td>changeset 40</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/23da5cab793a16a758f400d6f76406ca46987c2d">23da5cab793a16a758f400d6f76406ca46987c2d</a></td>
</tr>



<tr>
<td>parent 39</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6e9c4ef897066c0fa97e6d7f8fde11bee064d7f7">6e9c4ef897066c0fa97e6d7f8fde11bee064d7f7</a>
</td>
</tr>

<tr>
<td>child 41</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4cb9ccd2a1ca2a88d630c01adc67517615cfdaf0">4cb9ccd2a1ca2a88d630c01adc67517615cfdaf0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=23da5cab793a16a758f400d6f76406ca46987c2d">35</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 28 Jul 2008 23:37:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@23da5cab793a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=23da5cab793a16a758f400d6f76406ca46987c2d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=23da5cab793a16a758f400d6f76406ca46987c2d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23da5cab793a16a758f400d6f76406ca46987c2d&newProject=comm-central&newRevision=23da5cab793a16a758f400d6f76406ca46987c2d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23da5cab793a16a758f400d6f76406ca46987c2d&newProject=comm-central&newRevision=23da5cab793a16a758f400d6f76406ca46987c2d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23da5cab793a16a758f400d6f76406ca46987c2d&newProject=comm-central&newRevision=23da5cab793a16a758f400d6f76406ca46987c2d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=16913">16913</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=16913">Bug 16913</a> - Filter on any header, for news. r=bienvenu,Standard8 sr=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">mail/locales/en-US/chrome/messenger/news.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mail/locales/en-US/chrome/messenger/news.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">mailnews/base/search/src/nsMsgSearchNews.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/base/search/src/nsMsgSearchNews.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">mailnews/news/public/nsINNTPNewsgroupList.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/public/nsINNTPNewsgroupList.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">mailnews/news/src/nsNNTPNewsgroupList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPNewsgroupList.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">mailnews/news/test/postings/auto-add/post1.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post1.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">mailnews/news/test/postings/auto-add/post2.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post2.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">mailnews/news/test/postings/auto-add/post3.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post3.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">mailnews/news/test/postings/auto-add/post4.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post4.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">mailnews/news/test/postings/auto-add/post5.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post5.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">mailnews/news/test/postings/auto-add/post6.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post6.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">mailnews/news/test/postings/auto-add/post7.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/postings/auto-add/post7.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">mailnews/news/test/unit/head_server_setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/head_server_setup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">mailnews/news/test/unit/test_filter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_filter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">mailnews/news/test/unit/test_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/news/test/unit/test_server.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">mailnews/test/fakeserver/nntpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/mailnews/test/fakeserver/nntpd.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">suite/locales/en-US/chrome/mailnews/news.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">file</a> |
<a href="/comm-central/annotate/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">annotate</a> |
<a href="/comm-central/diff/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">diff</a> |
<a href="/comm-central/comparison/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">comparison</a> |
<a href="/comm-central/log/23da5cab793a16a758f400d6f76406ca46987c2d/suite/locales/en-US/chrome/mailnews/news.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/news.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/news.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -48,16 +48,17 @@ cancelConfirm=Are you sure you want to c</span>
<a href="#l1.4"></a><span id="l1.4"> messageCancelled=Message cancelled.</span>
<a href="#l1.5"></a><span id="l1.5"> enterUsername=Please enter a username for news server access:</span>
<a href="#l1.6"></a><span id="l1.6"> enterPassword=Please enter a password for news server access:</span>
<a href="#l1.7"></a><span id="l1.7"> enterPasswordTitle=News Server Password Required</span>
<a href="#l1.8"></a><span id="l1.8"> okButtonText=Download</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> noNewMessages=There are no new messages on the server.</span>
<a href="#l1.11"></a><span id="l1.11"> downloadingHeaders=Downloading %S of %S headers</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+downloadingFilterHeaders=Getting headers for filters: %S (%S/%S)</span>
<a href="#l1.13"></a><span id="l1.13"> downloadingArticles=Downloading articles %S-%S</span>
<a href="#l1.14"></a><span id="l1.14"> bytesReceived=Downloading newsgroups: %S received (%SKB read at %SKB/sec)</span>
<a href="#l1.15"></a><span id="l1.15"> checkingForNewNews=Checking newsgroup %S of %S on %S for new messages</span>
<a href="#l1.16"></a><span id="l1.16"> downloadingArticlesForOffline=Downloading articles %S-%S in %S</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> onlyCancelOneMessage=You can only cancel one article at a time.</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> # LOCALIZATION NOTE (autoUnsubscribeText): %1$S is the newsgroup and %2$S is the newsgroup-server it is being removed from.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1010,21 +1010,25 @@ NS_IMETHODIMP nsMsgSearchValidityManager</span>
<a href="#l2.4"></a><span id="l2.4">       rv = InitOnlineMailFilterTable ();</span>
<a href="#l2.5"></a><span id="l2.5">     if (m_onlineMailFilterTable)</span>
<a href="#l2.6"></a><span id="l2.6">       rv = SetOtherHeadersInTable(m_onlineMailFilterTable, customHeaders.get());</span>
<a href="#l2.7"></a><span id="l2.7">     *ppOutTable = m_onlineMailFilterTable;</span>
<a href="#l2.8"></a><span id="l2.8">     break;</span>
<a href="#l2.9"></a><span id="l2.9">   case nsMsgSearchScope::news:</span>
<a href="#l2.10"></a><span id="l2.10">     if (!m_newsTable)</span>
<a href="#l2.11"></a><span id="l2.11">       rv = InitNewsTable();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    if (m_newsTable)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      rv = SetOtherHeadersInTable(m_newsTable, customHeaders.get());</span>
<a href="#l2.14"></a><span id="l2.14">     *ppOutTable = m_newsTable;</span>
<a href="#l2.15"></a><span id="l2.15">     break;</span>
<a href="#l2.16"></a><span id="l2.16">   case nsMsgSearchScope::newsFilter:</span>
<a href="#l2.17"></a><span id="l2.17">     if (!m_newsFilterTable)</span>
<a href="#l2.18"></a><span id="l2.18">       rv = InitNewsFilterTable();</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    if (m_newsFilterTable)</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+      rv = SetOtherHeadersInTable(m_newsFilterTable, customHeaders.get());</span>
<a href="#l2.21"></a><span id="l2.21">     *ppOutTable = m_newsFilterTable;</span>
<a href="#l2.22"></a><span id="l2.22">     break;</span>
<a href="#l2.23"></a><span id="l2.23">   case nsMsgSearchScope::localNews:</span>
<a href="#l2.24"></a><span id="l2.24">     if (!m_localNewsTable)</span>
<a href="#l2.25"></a><span id="l2.25">       rv = InitLocalNewsTable();</span>
<a href="#l2.26"></a><span id="l2.26">     if (m_localNewsTable)</span>
<a href="#l2.27"></a><span id="l2.27">       rv = SetOtherHeadersInTable(m_localNewsTable, customHeaders.get());</span>
<a href="#l2.28"></a><span id="l2.28">     *ppOutTable = m_localNewsTable;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchNews.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchNews.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -140,18 +140,24 @@ char *nsMsgSearchNews::EncodeTerm (nsIMs</span>
<a href="#l3.4"></a><span id="l3.4">   {</span>
<a href="#l3.5"></a><span id="l3.5">   case nsMsgSearchAttrib::Sender:</span>
<a href="#l3.6"></a><span id="l3.6">     attribEncoding = m_kNntpFrom;</span>
<a href="#l3.7"></a><span id="l3.7">     break;</span>
<a href="#l3.8"></a><span id="l3.8">   case nsMsgSearchAttrib::Subject:</span>
<a href="#l3.9"></a><span id="l3.9">     attribEncoding = m_kNntpSubject;</span>
<a href="#l3.10"></a><span id="l3.10">     break;</span>
<a href="#l3.11"></a><span id="l3.11">   default:</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    NS_ASSERTION(PR_FALSE,&quot;malformed search&quot;); // malformed search term?</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    return nsnull;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    nsCString header;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    term-&gt;GetArbitraryHeader(header);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    if (header.IsEmpty())</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      NS_ASSERTION(PR_FALSE,&quot;malformed search&quot;); // malformed search term?</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+      return nsnull;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    }</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    attribEncoding = header.get();</span>
<a href="#l3.22"></a><span id="l3.22">   }</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   // Build a string to represent the string pattern</span>
<a href="#l3.25"></a><span id="l3.25">   PRBool leadingStar = PR_FALSE;</span>
<a href="#l3.26"></a><span id="l3.26">   PRBool trailingStar = PR_FALSE;</span>
<a href="#l3.27"></a><span id="l3.27">   int overhead = 1; // null terminator</span>
<a href="#l3.28"></a><span id="l3.28">   nsMsgSearchOpValue op;</span>
<a href="#l3.29"></a><span id="l3.29">   term-&gt;GetOp(&amp;op);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineat">@@ -456,16 +462,33 @@ nsresult nsMsgSearchValidityManager::Ini</span>
<a href="#l3.31"></a><span id="l3.31">     m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.32"></a><span id="l3.32">     m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.33"></a><span id="l3.33">     m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.34"></a><span id="l3.34">     m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.35"></a><span id="l3.35">     m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.36"></a><span id="l3.36">     m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.37"></a><span id="l3.37">     m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.38"></a><span id="l3.38">     m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+#if 0</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    // Size should be handled after the fact...</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+#endif</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    </span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.56"></a><span id="l3.56">   }</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   return rv;</span>
<a href="#l3.59"></a><span id="l3.59"> }</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61"> nsresult nsMsgSearchValidityManager::InitNewsFilterTable()</span>
<a href="#l3.62"></a><span id="l3.62"> {</span>
<a href="#l3.63"></a><span id="l3.63">   NS_ASSERTION (nsnull == m_newsFilterTable, &quot;news filter table already initted&quot;);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineat">@@ -507,12 +530,26 @@ nsresult nsMsgSearchValidityManager::Ini</span>
<a href="#l3.65"></a><span id="l3.65">     m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l3.66"></a><span id="l3.66">     m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l3.67"></a><span id="l3.67">     m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l3.68"></a><span id="l3.68">     m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l3.69"></a><span id="l3.69">     m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.70"></a><span id="l3.70">     m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.71"></a><span id="l3.71">     m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l3.72"></a><span id="l3.72">     m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l3.87"></a><span id="l3.87">   }</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">   return rv;</span>
<a href="#l3.90"></a><span id="l3.90"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2322,24 +2322,28 @@ NS_IMETHODIMP nsMsgDatabase::MarkHdrRead</span>
<a href="#l4.4"></a><span id="l4.4">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   // if the flag is already correct in the db, don't change it.</span>
<a href="#l4.7"></a><span id="l4.7">   // Check msg flags as well as IsHeaderRead in case it's a newsgroup</span>
<a href="#l4.8"></a><span id="l4.8">   // and the msghdr flags are out of sync with the newsrc settings.</span>
<a href="#l4.9"></a><span id="l4.9">   // (we could override this method for news db's, but it's a trivial fix here.</span>
<a href="#l4.10"></a><span id="l4.10">   if (bRead != isRead || isRead != isReadInDB)</span>
<a href="#l4.11"></a><span id="l4.11">   {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l4.13"></a><span id="l4.13">     nsMsgKey msgKey;</span>
<a href="#l4.14"></a><span id="l4.14">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    rv = GetThreadForMsgKey(msgKey, getter_AddRefs(threadHdr));</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    if (threadHdr)</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    PRBool inDB = PR_FALSE;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    (void)ContainsKey(msgKey, &amp;inDB);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    if (inDB)</span>
<a href="#l4.23"></a><span id="l4.23">     {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-      threadHdr-&gt;MarkChildRead(bRead);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+      nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+      rv = GetThreadForMsgKey(msgKey, getter_AddRefs(threadHdr));</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+      if (threadHdr)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        threadHdr-&gt;MarkChildRead(bRead);</span>
<a href="#l4.29"></a><span id="l4.29">     }</span>
<a href="#l4.30"></a><span id="l4.30">     return MarkHdrReadInDB(msgHdr, bRead, instigator);</span>
<a href="#l4.31"></a><span id="l4.31">   }</span>
<a href="#l4.32"></a><span id="l4.32">   return NS_OK;</span>
<a href="#l4.33"></a><span id="l4.33"> }</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> NS_IMETHODIMP nsMsgDatabase::MarkHdrReplied(nsIMsgDBHdr *msgHdr, PRBool bReplied,</span>
<a href="#l4.36"></a><span id="l4.36">                          nsIDBChangeListener *instigator)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/news/public/nsINNTPNewsgroupList.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/news/public/nsINNTPNewsgroupList.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,69 +15,112 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * The Original Code is mozilla.org code.</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * The Initial Developer of the Original Code is</span>
<a href="#l5.7"></a><span id="l5.7">  * Netscape Communications Corporation.</span>
<a href="#l5.8"></a><span id="l5.8">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l5.9"></a><span id="l5.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.10"></a><span id="l5.10">  *</span>
<a href="#l5.11"></a><span id="l5.11">  * Contributor(s):</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *   Joshua Cranmer &lt;Pidgeot18@gmail.com&gt;</span>
<a href="#l5.13"></a><span id="l5.13">  *</span>
<a href="#l5.14"></a><span id="l5.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.15"></a><span id="l5.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.16"></a><span id="l5.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.17"></a><span id="l5.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.18"></a><span id="l5.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.19"></a><span id="l5.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.20"></a><span id="l5.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.21"></a><span id="l5.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.22"></a><span id="l5.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.23"></a><span id="l5.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.24"></a><span id="l5.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.25"></a><span id="l5.25">  *</span>
<a href="#l5.26"></a><span id="l5.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-/* this interface is basically for the old ListNewsGroupState class</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">- * (the implementation of this class probably wants to also implement</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">- * or contain ChangeListener so that it can react to OnAnnouncerGoingAway()</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">- * to destroy the DBView)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">- */</span>
<a href="#l5.33"></a><span id="l5.33"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> interface nsIMsgNewsFolder;</span>
<a href="#l5.36"></a><span id="l5.36"> interface nsINntpUrl;</span>
<a href="#l5.37"></a><span id="l5.37"> interface nsIMsgWindow;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+/**</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ * A utility class for nsINNTPProtocol that handles the list of new headers.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ */</span>
<a href="#l5.42"></a><span id="l5.42"> [scriptable, uuid(E628ED19-9452-11d2-B7EA-00805F05FFA5)]</span>
<a href="#l5.43"></a><span id="l5.43"> interface nsINNTPNewsgroupList : nsISupports {</span>
<a href="#l5.44"></a><span id="l5.44">   </span>
<a href="#l5.45"></a><span id="l5.45">   void initialize(in nsINntpUrl runningURL, in nsIMsgNewsFolder newsFolder);</span>
<a href="#l5.46"></a><span id="l5.46">   </span>
<a href="#l5.47"></a><span id="l5.47">   long getRangeOfArtsToDownload(in nsIMsgWindow aMsgWindow, in long first_message,</span>
<a href="#l5.48"></a><span id="l5.48">                                 in long last_message,</span>
<a href="#l5.49"></a><span id="l5.49">                                 in long maxextra,</span>
<a href="#l5.50"></a><span id="l5.50">                                 out long real_first_message,</span>
<a href="#l5.51"></a><span id="l5.51">                                 out long real_last_message);</span>
<a href="#l5.52"></a><span id="l5.52">   </span>
<a href="#l5.53"></a><span id="l5.53">   void addToKnownArticles(in long first_message, in long last_message);</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  /* The NNTP module of netlib calls these to feed XOVER data to the message</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-     library, in response to a news:group.name URL having been opened.</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-     If MSG_FinishXOVER() returns a message ID, that message will be loaded</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-     next (used for selecting the first unread message in a group after</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-     listing that group.)</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-     deprecated:</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-     The &quot;out&quot; arguments are (if non-NULL) a file descriptor to write the XOVER</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-     line to, followed by a &quot;\n&quot;.  This is used by the XOVER-caching code.</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  */</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  /* the XOVER Sink should maintain the ListNewsGroupState */</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  /**</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+   * Initializes the internal state to get the messages.</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+   *</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+   * This method should be called before sending the line</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+   * &lt;tt&gt;XOVER @arg first_message-@arg last_message&lt;/tt&gt; to the server.</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+   *</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+   * @param first_message  The first message of the download range.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+   * @param last_message   The last message of the download range.</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+   */</span>
<a href="#l5.76"></a><span id="l5.76">   void initXOVER(in long first_message, in long last_message);  </span>
<a href="#l5.77"></a><span id="l5.77">   void processXOVERLINE(in string line, out unsigned long status);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  void processNonXOVER(in string line);</span>
<a href="#l5.79"></a><span id="l5.79">   void resetXOVER();</span>
<a href="#l5.80"></a><span id="l5.80">   void finishXOVERLINE(in long status, out long newstatus);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-  void clearXOVERState();</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  /**</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+   * Initalizes the state in preparation for a call to XHDR.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+   *</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   * @return               The next header to get, or an empty string if done.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   */</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  ACString initXHDR();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  /**</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+   * Processes a line of the server's response to XHDR.</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+   *</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+   * It will calculate the message number and other information itself, so the</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   * unadulterated line itself should be sent.</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+   *</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+   * @param aLine          The line as sent from the server.</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+   */</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  void processXHDRLine(in ACString aLine);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  /**</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+   * Initalizes the internal state to process a HEAD command.</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+   *</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+   * This method should be called before sending the line</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+   * &lt;tt&gt;HEAD @arg aMessage&lt;/tt&gt; to the server.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+   *</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+   * @param aMessage       The message number that will be sent.</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+   */</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  void initHEAD(in long aMessage);</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+  /**</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+   * Processes a line of the server's response to HEAD.</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+   *</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   * This will not check for a quoted '.' at the beginning.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   *</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   * @param aLine          The line the server sent.</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   */</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  void processHEADLine(in ACString aLine);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  /**</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+   * Manages the internal state if the call to HEAD failed.</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+   *</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+   * @param aMessage       The message key that caused the HEAD failure.</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+   */</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  void HEADFailed(in long aMessage);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+  /**</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+   * Calls the filters after all messages have been processed.</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+   *</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+   * This method also cleans out some internal state relating to the messages</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+   * that have been processed, so it should always be called at the end of</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+   * XOVER/XHDR/HEAD processing.</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+   */</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  void callFilters();</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132">   attribute boolean getOldMessages;</span>
<a href="#l5.133"></a><span id="l5.133"> };</span>
<a href="#l5.134"></a><span id="l5.134"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -123,16 +123,45 @@ NS_IMPL_ISUPPORTS2(nsNNTPNewsgroupList, </span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> nsresult</span>
<a href="#l6.6"></a><span id="l6.6"> nsNNTPNewsgroupList::Initialize(nsINntpUrl *runningURL, nsIMsgNewsFolder *newsFolder)</span>
<a href="#l6.7"></a><span id="l6.7"> {</span>
<a href="#l6.8"></a><span id="l6.8">   m_newsFolder = newsFolder;</span>
<a href="#l6.9"></a><span id="l6.9">   m_runningURL = runningURL;</span>
<a href="#l6.10"></a><span id="l6.10">   m_knownArts.set = nsMsgKeySet::Create();</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  rv = folder-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  nsCString ngHeaders;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  m_filterList-&gt;GetArbitraryHeaders(ngHeaders);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  m_filterHeaders.ParseString(ngHeaders.get(), &quot; &quot;);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  rv = server-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_serverFilterList));</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  nsCAutoString servHeaders;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  m_serverFilterList-&gt;GetArbitraryHeaders(servHeaders);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  nsCStringArray servArray;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  servArray.ParseString(servHeaders.get(), &quot; &quot;);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  // servArray may have duplicates already in m_filterHeaders.</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  for (PRInt32 i = 0; i &lt; servArray.Count(); i++)</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    if (m_filterHeaders.IndexOf(*(servArray[i])) == -1)</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+      m_filterHeaders.AppendCString(*(servArray[i]));</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  }</span>
<a href="#l6.41"></a><span id="l6.41">   return NS_OK;</span>
<a href="#l6.42"></a><span id="l6.42"> }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44"> nsresult</span>
<a href="#l6.45"></a><span id="l6.45"> nsNNTPNewsgroupList::CleanUp()</span>
<a href="#l6.46"></a><span id="l6.46"> {</span>
<a href="#l6.47"></a><span id="l6.47">   // here we make sure that there aren't missing articles in the unread set</span>
<a href="#l6.48"></a><span id="l6.48">   // So if an article is the unread set, and the known arts set, but isn't in the</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineat">@@ -151,16 +180,18 @@ nsNNTPNewsgroupList::CleanUp()</span>
<a href="#l6.50"></a><span id="l6.50">         folderInfo-&gt;GetUint32Property(&quot;lastMissingCheck&quot;, 0, &amp;lastMissingCheck);</span>
<a href="#l6.51"></a><span id="l6.51">         if (lastMissingCheck)</span>
<a href="#l6.52"></a><span id="l6.52">           firstKnown = lastMissingCheck + 1;</span>
<a href="#l6.53"></a><span id="l6.53">       }</span>
<a href="#l6.54"></a><span id="l6.54">       PRBool foundMissingArticle = PR_FALSE;</span>
<a href="#l6.55"></a><span id="l6.55">       while (firstKnown &lt;= lastKnown)</span>
<a href="#l6.56"></a><span id="l6.56">       {</span>
<a href="#l6.57"></a><span id="l6.57">         PRInt32 firstUnreadStart, firstUnreadEnd;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+        if (firstKnown == 0)</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+          firstKnown = 1;</span>
<a href="#l6.60"></a><span id="l6.60">         m_set-&gt;FirstMissingRange(firstKnown, lastKnown, &amp;firstUnreadStart, &amp;firstUnreadEnd);</span>
<a href="#l6.61"></a><span id="l6.61">         if (firstUnreadStart)</span>
<a href="#l6.62"></a><span id="l6.62">         {</span>
<a href="#l6.63"></a><span id="l6.63">           while (firstUnreadStart &lt;= firstUnreadEnd)</span>
<a href="#l6.64"></a><span id="l6.64">           {</span>
<a href="#l6.65"></a><span id="l6.65">             PRBool containsKey;</span>
<a href="#l6.66"></a><span id="l6.66">             m_newsDB-&gt;ContainsKey(firstUnreadStart, &amp;containsKey);</span>
<a href="#l6.67"></a><span id="l6.67">             if (!containsKey)</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineat">@@ -468,41 +499,36 @@ nsNNTPNewsgroupList::AddToKnownArticles(</span>
<a href="#l6.69"></a><span id="l6.69">     }</span>
<a href="#l6.70"></a><span id="l6.70">   }</span>
<a href="#l6.71"></a><span id="l6.71">   return status;</span>
<a href="#l6.72"></a><span id="l6.72"> }</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74"> nsresult</span>
<a href="#l6.75"></a><span id="l6.75"> nsNNTPNewsgroupList::InitXOVER(PRInt32 first_msg, PRInt32 last_msg)</span>
<a href="#l6.76"></a><span id="l6.76"> {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  int status = 0;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  // Tell the FE to show the GetNewMessages progress dialog</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-#ifdef HAVE_PANES</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  FE_PaneChanged (m_pane, PR_FALSE, MSG_PanePastPasswordCheck, 0);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-#endif</span>
<a href="#l6.83"></a><span id="l6.83">   /* Consistency checks, not that I know what to do if it fails (it will</span>
<a href="#l6.84"></a><span id="l6.84">    probably handle it OK...) */</span>
<a href="#l6.85"></a><span id="l6.85">   NS_ASSERTION(first_msg &lt;= last_msg, &quot;first &gt; last&quot;);</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">   /* If any XOVER lines from the last time failed to come in, mark those</span>
<a href="#l6.88"></a><span id="l6.88">      messages as read. */</span>
<a href="#l6.89"></a><span id="l6.89">   if (m_lastProcessedNumber &lt; m_lastMsgNumber)</span>
<a href="#l6.90"></a><span id="l6.90">   {</span>
<a href="#l6.91"></a><span id="l6.91">     m_set-&gt;AddRange(m_lastProcessedNumber + 1, m_lastMsgNumber);</span>
<a href="#l6.92"></a><span id="l6.92">   }</span>
<a href="#l6.93"></a><span id="l6.93">   m_firstMsgNumber = first_msg;</span>
<a href="#l6.94"></a><span id="l6.94">   m_lastMsgNumber = last_msg;</span>
<a href="#l6.95"></a><span id="l6.95">   m_lastProcessedNumber = first_msg &gt; 1 ? first_msg - 1 : 1;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  return status;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  m_currentXHDRIndex = -1;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.99"></a><span id="l6.99"> }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101"> // from RFC 822, don't translate</span>
<a href="#l6.102"></a><span id="l6.102"> #define FROM_HEADER &quot;From: &quot;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-#define SUBECT_HEADER &quot;Subject: &quot;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+#define SUBJECT_HEADER &quot;Subject: &quot;</span>
<a href="#l6.105"></a><span id="l6.105"> #define DATE_HEADER &quot;Date: &quot;</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107"> nsresult</span>
<a href="#l6.108"></a><span id="l6.108"> nsNNTPNewsgroupList::ParseLine(char *line, PRUint32 * message_number)</span>
<a href="#l6.109"></a><span id="l6.109"> {</span>
<a href="#l6.110"></a><span id="l6.110">   nsresult rv = NS_OK;</span>
<a href="#l6.111"></a><span id="l6.111">   nsCOMPtr &lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l6.112"></a><span id="l6.112">   char *dateStr = nsnull;  // keep track of date str, for filters</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineat">@@ -536,22 +562,24 @@ nsNNTPNewsgroupList::ParseLine(char *lin</span>
<a href="#l6.114"></a><span id="l6.114">     const char *subject = line;  /* #### const evilness */</span>
<a href="#l6.115"></a><span id="l6.115">     PRUint32 subjectLen = strlen(line);</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117">     PRUint32 flags = 0;</span>
<a href="#l6.118"></a><span id="l6.118">     // ### should call IsHeaderRead here...</span>
<a href="#l6.119"></a><span id="l6.119">     /* strip &quot;Re: &quot; */</span>
<a href="#l6.120"></a><span id="l6.120">     nsCString modifiedSubject;</span>
<a href="#l6.121"></a><span id="l6.121">     if (NS_MsgStripRE(&amp;subject, &amp;subjectLen, getter_Copies(modifiedSubject)))</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      (void) newMsgHdr-&gt;OrFlags(MSG_FLAG_HAS_RE, &amp;flags); // this will make sure read flags agree with newsrc</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+      (void) newMsgHdr-&gt;OrFlags(MSG_FLAG_HAS_RE, &amp;flags);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+    </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    // this will make sure read flags agree with newsrc</span>
<a href="#l6.127"></a><span id="l6.127">     if (! (flags &amp; MSG_FLAG_READ))</span>
<a href="#l6.128"></a><span id="l6.128">       rv = newMsgHdr-&gt;OrFlags(MSG_FLAG_NEW, &amp;flags);</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130">     rv = newMsgHdr-&gt;SetSubject(modifiedSubject.IsEmpty() ? subject : modifiedSubject.get());</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+</span>
<a href="#l6.132"></a><span id="l6.132">     if (NS_FAILED(rv))</span>
<a href="#l6.133"></a><span id="l6.133">       return rv;</span>
<a href="#l6.134"></a><span id="l6.134">   }</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136">   GET_TOKEN (); /* author */</span>
<a href="#l6.137"></a><span id="l6.137">   if (line) {</span>
<a href="#l6.138"></a><span id="l6.138">     authorStr = line;</span>
<a href="#l6.139"></a><span id="l6.139">     rv = newMsgHdr-&gt;SetAuthor(line);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineat">@@ -607,145 +635,17 @@ nsNNTPNewsgroupList::ParseLine(char *lin</span>
<a href="#l6.141"></a><span id="l6.141">     PRUint32 numLines = 0;</span>
<a href="#l6.142"></a><span id="l6.142">     numLines = line ? atol (line) : 0;</span>
<a href="#l6.143"></a><span id="l6.143">     rv = newMsgHdr-&gt;SetLineCount(numLines);</span>
<a href="#l6.144"></a><span id="l6.144">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.145"></a><span id="l6.145">   }</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147">   GET_TOKEN (); /* xref */</span>
<a href="#l6.148"></a><span id="l6.148"> </span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-  // apply filters</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  // XXX TODO</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  // do spam classification for news</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  if (!m_filterList)</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  {</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    rv = folder-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  }</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-  if (!m_serverFilterList)</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  {</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-    rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-    rv = server-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_serverFilterList));</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-  }</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  // flag for kill</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  // if the action is Delete, and we get a hit (see ApplyFilterHit())</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  // we set this to PR_FALSE.  if false, we won't add it to the db.</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  m_addHdrToDB = PR_TRUE;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  PRUint32 filterCount = 0;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  if (m_filterList) {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    rv = m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-  }</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  PRUint32 serverFilterCount = 0;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  if (m_serverFilterList) {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    rv = m_serverFilterList-&gt;GetFilterCount(&amp;serverFilterCount);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  }</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-  // only do this if we have filters</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-  if (filterCount || serverFilterCount)</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-  {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    // build up a &quot;headers&quot; for filter code</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    nsCString subject;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    rv = newMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-    PRUint32 headersSize = 0;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    // +1 to separate headers with a null byte</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    if (authorStr)</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-      headersSize += strlen(FROM_HEADER) + strlen(authorStr) + 1;</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    if (!(subject.IsEmpty()))</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-      headersSize += strlen(SUBECT_HEADER) + subject.Length() + 1;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-    if (dateStr)</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-     headersSize += strlen(DATE_HEADER) + strlen(dateStr) + 1;</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-    if (headersSize) {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-      char *headers = (char *)PR_Malloc(headersSize);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-      char *headerPos = headers;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-      if (!headers)</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-      if (authorStr) {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-        PL_strcpy(headerPos, FROM_HEADER);</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-        headerPos += strlen(FROM_HEADER);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-        PL_strcpy(headerPos, authorStr);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-        headerPos += strlen(authorStr);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-        *headerPos = '\0';</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-        headerPos++;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-      }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-      if (!(subject.IsEmpty())) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-        PL_strcpy(headerPos, SUBECT_HEADER);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-        headerPos += strlen(SUBECT_HEADER);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-        PL_strcpy(headerPos, subject.get());</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-        headerPos += subject.Length();</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-        *headerPos = '\0';</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-        headerPos++;</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-      }</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-      if (dateStr) {</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-        PL_strcpy(headerPos, DATE_HEADER);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-        headerPos += strlen(DATE_HEADER);</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-        PL_strcpy(headerPos, dateStr);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-        headerPos += strlen(dateStr);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-        *headerPos = '\0';</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-        headerPos++;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-      }</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-      // on a filter hit (see ApplyFilterHit()), we'll be modifying the header</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-      // so keep track of the header</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-      m_newMsgHdr = newMsgHdr;</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-      // the per-newsgroup filters should probably go first. It doesn't matter</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-      // right now since nothing stops filter execution for newsgroups, but if something</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-      // does, like adding a &quot;stop execution&quot; action, then users should be able to</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-      // override the global filters in the per-newsgroup filters.</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-      if (filterCount)</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-      {</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-        rv = m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule, newMsgHdr, folder, m_newsDB,</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-          headers, headersSize, this, m_msgWindow, nsnull);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-      }</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-      if (serverFilterCount)</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-      {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-        rv = m_serverFilterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule, newMsgHdr, folder, m_newsDB,</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-          headers, headersSize, this, m_msgWindow, nsnull);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-      }</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-      PR_Free ((void*) headers);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    }</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-  }</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-  // if we deleted it, don't add it</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-  if (m_addHdrToDB) {</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    rv = m_newsDB-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-  }</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+  m_newHeaders.AppendObject(newMsgHdr);</span>
<a href="#l6.279"></a><span id="l6.279">   return NS_OK;</span>
<a href="#l6.280"></a><span id="l6.280"> }</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282"> NS_IMETHODIMP nsNNTPNewsgroupList::ApplyFilterHit(nsIMsgFilter *aFilter, nsIMsgWindow *aMsgWindow, PRBool *aApplyMore)</span>
<a href="#l6.283"></a><span id="l6.283"> {</span>
<a href="#l6.284"></a><span id="l6.284">   NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l6.285"></a><span id="l6.285">   NS_ENSURE_ARG_POINTER(aApplyMore);</span>
<a href="#l6.286"></a><span id="l6.286">   NS_ENSURE_TRUE(m_newMsgHdr, NS_ERROR_UNEXPECTED);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineat">@@ -917,86 +817,32 @@ nsNNTPNewsgroupList::ProcessXOVERLINE(co</span>
<a href="#l6.288"></a><span id="l6.288">   /* Update the progress meter with a percentage of articles retrieved */</span>
<a href="#l6.289"></a><span id="l6.289">   if (m_lastMsgNumber &gt; m_firstMsgNumber)</span>
<a href="#l6.290"></a><span id="l6.290">   {</span>
<a href="#l6.291"></a><span id="l6.291">     PRInt32 totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l6.292"></a><span id="l6.292">     PRInt32 lastIndex = m_lastProcessedNumber - m_firstMsgNumber + 1;</span>
<a href="#l6.293"></a><span id="l6.293">     PRInt32 numDownloaded = lastIndex;</span>
<a href="#l6.294"></a><span id="l6.294">     PRInt32 totIndex = m_lastMsgNumber - m_firstMsgNumber + 1;</span>
<a href="#l6.295"></a><span id="l6.295"> </span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-    PRInt32  percent = (totIndex) ? (PRInt32)(100.0 * (double)numDownloaded / (double)totalToDownload) : 0;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-    PRTime elapsedTime;</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-    LL_SUB(elapsedTime, PR_Now(), m_lastStatusUpdate);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-    if (LL_CMP(elapsedTime, &gt;, MIN_STATUS_UPDATE_INTERVAL) ||</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-        lastIndex == totIndex)</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-    {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-      nsAutoString numDownloadedStr;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-      numDownloadedStr.AppendInt(numDownloaded);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-      nsAutoString totalToDownloadStr;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-      totalToDownloadStr.AppendInt(totalToDownload);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-      nsString statusString;</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-      nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l6.315"></a><span id="l6.315"> </span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-      nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-      rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-      const PRUnichar *formatStrings[2] = { numDownloadedStr.get(), totalToDownloadStr.get() };</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;downloadingHeaders&quot;).get(), formatStrings, 2, getter_Copies(statusString));</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-#ifdef DEBUG_NEWS</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-      PRInt32 elapsed;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-      LL_L2I(elapsed, elapsedTime);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-      printf(&quot;usecs elapsed since last update: %d\n&quot;, elapsed);</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-#endif</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-      SetProgressStatus(statusString.get());</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-      m_lastStatusUpdate = PR_Now();</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-      // only update the progress meter if it has changed</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-      if (percent != m_lastPercent) {</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-        SetProgressBarPercent(percent);</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-        m_lastPercent = percent;</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-      }</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-    }</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+    if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL || lastIndex == totIndex)</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+      UpdateStatus(PR_FALSE, numDownloaded, totalToDownload);</span>
<a href="#l6.341"></a><span id="l6.341">   }</span>
<a href="#l6.342"></a><span id="l6.342">   return NS_OK;</span>
<a href="#l6.343"></a><span id="l6.343"> }</span>
<a href="#l6.344"></a><span id="l6.344"> </span>
<a href="#l6.345"></a><span id="l6.345"> nsresult</span>
<a href="#l6.346"></a><span id="l6.346"> nsNNTPNewsgroupList::ResetXOVER()</span>
<a href="#l6.347"></a><span id="l6.347"> {</span>
<a href="#l6.348"></a><span id="l6.348">   m_lastMsgNumber = m_firstMsgNumber;</span>
<a href="#l6.349"></a><span id="l6.349">   m_lastProcessedNumber = m_lastMsgNumber;</span>
<a href="#l6.350"></a><span id="l6.350">   return 0;</span>
<a href="#l6.351"></a><span id="l6.351"> }</span>
<a href="#l6.352"></a><span id="l6.352"> </span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-/* When we don't have XOVER, but use HEAD, this is called instead.</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-   It reads lines until it has a whole header block, then parses the</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-   headers; then takes selected headers and creates an XOVER line</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-   from them.  This is more for simplicity and code sharing than</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-   anything else; it means we end up parsing some things twice.</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-   But if we don't have XOVER, things are going to be so horribly</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-   slow anyway that this just doesn't matter.</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">- */</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-nsresult</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-nsNNTPNewsgroupList::ProcessNonXOVER (const char * /*line*/)</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-{</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-  // ### dmb write me</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-}</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-</span>
<a href="#l6.369"></a><span id="l6.369"> nsresult</span>
<a href="#l6.370"></a><span id="l6.370"> nsNNTPNewsgroupList::FinishXOVERLINE(int status, int *newstatus)</span>
<a href="#l6.371"></a><span id="l6.371"> {</span>
<a href="#l6.372"></a><span id="l6.372">   nsresult rv;</span>
<a href="#l6.373"></a><span id="l6.373">   struct MSG_NewsKnown* k;</span>
<a href="#l6.374"></a><span id="l6.374"> </span>
<a href="#l6.375"></a><span id="l6.375">   /* If any XOVER lines from the last time failed to come in, mark those</span>
<a href="#l6.376"></a><span id="l6.376">      messages as read. */</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineat">@@ -1056,20 +902,304 @@ nsNNTPNewsgroupList::FinishXOVERLINE(int</span>
<a href="#l6.378"></a><span id="l6.378">   }</span>
<a href="#l6.379"></a><span id="l6.379"> </span>
<a href="#l6.380"></a><span id="l6.380">   if (newstatus)</span>
<a href="#l6.381"></a><span id="l6.381">     *newstatus=0;</span>
<a href="#l6.382"></a><span id="l6.382"> </span>
<a href="#l6.383"></a><span id="l6.383">   return NS_OK;</span>
<a href="#l6.384"></a><span id="l6.384"> }</span>
<a href="#l6.385"></a><span id="l6.385"> </span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+nsNNTPNewsgroupList::InitXHDR(nsACString &amp;header)</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+{</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+  if (++m_currentXHDRIndex &gt;= m_filterHeaders.Count())</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+    header.Truncate();</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+  else</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+    header.Assign(*m_filterHeaders[m_currentXHDRIndex]);</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+  // Don't include these in our XHDR bouts, as they are already provided through</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+  // XOVER. </span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+  if (header.EqualsLiteral(&quot;message-id&quot;) ||</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+      header.EqualsLiteral(&quot;references&quot;))</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+    return InitXHDR(header);</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+}</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+nsNNTPNewsgroupList::ProcessXHDRLine(const nsACString &amp;line)</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+{</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+  PRInt32 middle = line.FindChar(' ');</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+  nsCString value, key = PromiseFlatCString(line);</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+  if (middle == -1)</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+  value = Substring(line, middle+1);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+  key.Truncate((PRUint32)middle);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+  // According to RFC 2980, some will send (none) instead.</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+  // So we don't treat this is an error.</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+  if (key.CharAt(0) &lt; '0' || key.CharAt(0) &gt; '9')</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+  PRInt32 code;</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+  PRInt32 number = key.ToInteger(&amp;code);</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+  if (code != NS_OK)</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+  // RFC 2980 specifies one or more spaces.</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+  value.Trim(&quot; &quot;);</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+  nsresult rv = m_newsDB-&gt;GetMsgHdrForKey(number, getter_AddRefs(header));</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+  rv = header-&gt;SetStringProperty(m_filterHeaders[m_currentXHDRIndex]-&gt;get(), value.get());</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+  PRInt32 totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+  PRInt32 numDownloaded = number - m_firstMsgNumber + 1;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+  PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+  if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL)</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+    UpdateStatus(PR_TRUE, numDownloaded, totalToDownload);</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+  return rv;</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+}</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+nsNNTPNewsgroupList::InitHEAD(PRInt32 number)</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+{</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+  if (m_newMsgHdr)</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+  {</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+    // Finish processing for this header</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+    // If HEAD didn't properly return, then the header won't be set</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+    m_newHeaders.AppendObject(m_newMsgHdr);</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+    PRInt32 totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+    PRInt32 lastIndex = m_lastProcessedNumber - m_firstMsgNumber + 1;</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+    PRInt32 numDownloaded = lastIndex;</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+    PRInt32 totIndex = m_lastMsgNumber - m_firstMsgNumber + 1;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+    PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+    if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL || lastIndex == totIndex)</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+      UpdateStatus(PR_FALSE, numDownloaded, totalToDownload);</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+  }</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+  if (number &gt;= 0)</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+  {</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+    if (m_newHeaders.Count() &gt; 0 &amp;&amp; m_lastMsgNumber == m_lastProcessedNumber)</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    {</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+      // We have done some processing of messages. This means that we have</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+      // relics of headers from XOVER. Since we will get everything from HEAD</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+      // anyways, just clear the array.</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+      m_newHeaders.Clear();</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+    }</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+    nsresult rv = m_newsDB-&gt;CreateNewHdr(number, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+    m_lastProcessedNumber = number;</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+  }</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+  else</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+  {</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+    AddToKnownArticles(m_firstMsgNumber, m_lastProcessedNumber);</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+  }</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+}</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+nsNNTPNewsgroupList::HEADFailed(PRInt32 number)</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+{</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+  m_set-&gt;Add(number);</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+}</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+nsNNTPNewsgroupList::ProcessHEADLine(const nsACString &amp;line)</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+{</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+  PRInt32 colon = line.FindChar(':');</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+  nsCString header = PromiseFlatCString(line), value;</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+  if (colon != -1)</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+  {</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+    value = Substring(line, colon+1);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+    header.Truncate((PRUint32)colon);</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+  }</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+  else if (line.CharAt(0) == ' ' || line.CharAt(0) == '\t') // We are continuing the header</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+  {</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineplus">+    m_thisLine += header; // Preserve whitespace (should we?)</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineplus">+  }</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+  else</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+  {</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+    return NS_OK; // We are malformed. Just ignore and hope for the best...</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+  }</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+  </span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+  if (!m_lastHeader.IsEmpty())</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+  {</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+    rv = AddHeader(m_lastHeader.get(), m_thisLine.get());</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+  }</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+  </span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+  value.Trim(&quot; &quot;);</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+  ToLowerCase(header, m_lastHeader);</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+  m_thisLine.Assign(value);</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+}</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+</span>
<a href="#l6.522"></a><span id="l6.522"> nsresult</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-nsNNTPNewsgroupList::ClearXOVERState()</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+nsNNTPNewsgroupList::AddHeader(const char *header, const char *value)</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+{</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+  // The From, Date, and Subject headers have special requirements.</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+  if (PL_strcmp(header, &quot;from&quot;) == 0)</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+  {</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetAuthor(value);</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+  }</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+  else if (PL_strcmp(header, &quot;date&quot;) == 0)</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+  {</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+    PRTime date;</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+    PRStatus status = PR_ParseTimeString (value, PR_FALSE, &amp;date);</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+    if (PR_SUCCESS == status)</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+      rv = m_newMsgHdr-&gt;SetDate(date);</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+  }</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+  else if (PL_strcmp(header, &quot;subject&quot;) == 0)</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+  {</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+    const char *subject = value;</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+    PRUint32 subjectLen = strlen(value);</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineplus">+</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+    PRUint32 flags = 0;</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+    // ### should call IsHeaderRead here...</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+    /* strip &quot;Re: &quot; */</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+    nsCString modifiedSubject;</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+    if (NS_MsgStripRE(&amp;subject, &amp;subjectLen, getter_Copies(modifiedSubject)))</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+      // this will make sure read flags agree with newsrc</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+     (void) m_newMsgHdr-&gt;OrFlags(MSG_FLAG_HAS_RE, &amp;flags);</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+    if (! (flags &amp; MSG_FLAG_READ))</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+      rv = m_newMsgHdr-&gt;OrFlags(MSG_FLAG_NEW, &amp;flags);</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetSubject(modifiedSubject.IsEmpty() ? subject :</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+      modifiedSubject.get());</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+  }</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+  else if (PL_strcmp(header, &quot;message-id&quot;) == 0)</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+  {</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetMessageId(value);</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineplus">+  }</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineplus">+  else if (PL_strcmp(header, &quot;references&quot;) == 0)</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineplus">+  {</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetReferences(value);</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineplus">+  }</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineplus">+  else if (PL_strcmp(header, &quot;bytes&quot;) == 0)</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineplus">+  {</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetMessageSize(atol(value));</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+  }</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+  else if (PL_strcmp(header, &quot;lines&quot;) == 0)</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineplus">+  {</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetLineCount(atol(value));</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineplus">+  }</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+  else if (m_filterHeaders.IndexOf(nsDependentCString(header)) != -1)</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineplus">+  {</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineplus">+    rv = m_newMsgHdr-&gt;SetStringProperty(header, value);</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineplus">+  }</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineplus">+  return rv;</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineplus">+}</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineplus">+</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+nsresult</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineplus">+nsNNTPNewsgroupList::CallFilters()</span>
<a href="#l6.583"></a><span id="l6.583"> {</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+  nsCString filterString;</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineplus">+  </span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineplus">+</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineplus">+  PRUint32 filterCount = 0;</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineplus">+  if (m_filterList)</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+  {</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+    rv = m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+  }</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineplus">+  PRUint32 serverFilterCount = 0;</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineplus">+  if (m_serverFilterList)</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineplus">+  {</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+    rv = m_serverFilterList-&gt;GetFilterCount(&amp;serverFilterCount);</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineplus">+  }</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineplus">+</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineplus">+  PRUint32 count = m_newHeaders.Count();</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineplus">+  </span>
<a href="#l6.607"></a><span id="l6.607" class="difflineplus">+  for (PRUint32 i = 0; i &lt; count; i++)</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineplus">+  {</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineplus">+    if (!filterCount &amp;&amp; !serverFilterCount)</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+    {</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+      m_newsDB-&gt;AddNewHdrToDB(m_newHeaders[i], PR_TRUE);</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+      continue;</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+    }</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+    m_addHdrToDB = PR_TRUE;</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineplus">+    m_newMsgHdr = m_newHeaders[i];</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+    // build up a &quot;headers&quot; for filter code</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+    nsCString subject, author, date;</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+    rv = m_newMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+    rv = m_newMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineplus">+</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineplus">+    nsCString fullHeaders;</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineplus">+    if (!(author.IsEmpty()))</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineplus">+    {</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineplus">+      fullHeaders.AppendLiteral(FROM_HEADER);</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineplus">+      fullHeaders += author;</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineplus">+      fullHeaders += '\0';</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineplus">+    }</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineplus">+</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineplus">+    if (!(subject.IsEmpty()))</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineplus">+    {</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+      fullHeaders.AppendLiteral(SUBJECT_HEADER);</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+      fullHeaders += subject;</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineplus">+      fullHeaders += '\0';</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineplus">+    }</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineplus">+    for (PRInt32 header = 0; header &lt; m_filterHeaders.Count(); header++)</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineplus">+    {</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineplus">+      nsCString retValue;</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+      m_newMsgHdr-&gt;GetStringProperty(m_filterHeaders[header]-&gt;get(),</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+                                     getter_Copies(retValue));</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+      if (!retValue.IsEmpty())</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+      {</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+        fullHeaders += *(m_filterHeaders[header]);</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+        fullHeaders.AppendLiteral(&quot;: &quot;);</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+        fullHeaders += retValue;</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+        fullHeaders += '\0';</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+      }</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+    }</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+    // The per-newsgroup filters should go first. If something stops filter</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineplus">+    // execution, then users should be able to override the global filters in</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineplus">+    // the per-newsgroup filters.</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+    if (filterCount)</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineplus">+    {</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineplus">+      rv = m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule,</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+          m_newMsgHdr, folder, m_newsDB, fullHeaders.get(),</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+          fullHeaders.Length(), this, m_msgWindow, nsnull);</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+    }</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+    if (serverFilterCount)</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+    {</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+      rv = m_serverFilterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule,</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+          m_newMsgHdr, folder, m_newsDB, fullHeaders.get(),</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+          fullHeaders.Length(), this, m_msgWindow, nsnull);</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+    }</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+    if (m_addHdrToDB)</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+      m_newsDB-&gt;AddNewHdrToDB(m_newMsgHdr, PR_TRUE);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineplus">+  }</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineplus">+  m_newHeaders.Clear();</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.676"></a><span id="l6.676"> }</span>
<a href="#l6.677"></a><span id="l6.677"> </span>
<a href="#l6.678"></a><span id="l6.678"> void</span>
<a href="#l6.679"></a><span id="l6.679"> nsNNTPNewsgroupList::SetProgressBarPercent(PRInt32 percent)</span>
<a href="#l6.680"></a><span id="l6.680"> {</span>
<a href="#l6.681"></a><span id="l6.681">   if (!m_runningURL)</span>
<a href="#l6.682"></a><span id="l6.682">     return;</span>
<a href="#l6.683"></a><span id="l6.683"> </span>
<a href="#l6.684"></a><span id="l6.684" class="difflineat">@@ -1096,16 +1226,69 @@ nsNNTPNewsgroupList::SetProgressStatus(c</span>
<a href="#l6.685"></a><span id="l6.685">     mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(feedback));</span>
<a href="#l6.686"></a><span id="l6.686"> </span>
<a href="#l6.687"></a><span id="l6.687">     if (feedback) {</span>
<a href="#l6.688"></a><span id="l6.688">       feedback-&gt;ShowStatusString(nsDependentString(message));</span>
<a href="#l6.689"></a><span id="l6.689">     }</span>
<a href="#l6.690"></a><span id="l6.690">   }</span>
<a href="#l6.691"></a><span id="l6.691"> }</span>
<a href="#l6.692"></a><span id="l6.692"> </span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+void</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+nsNNTPNewsgroupList::UpdateStatus(PRBool filtering, PRInt32 numDLed, PRInt32 totToDL)</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+{</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineplus">+  PRInt32 numerator = (filtering ? m_currentXHDRIndex + 1 : 1) * numDLed;</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineplus">+  PRInt32 denominator = (m_filterHeaders.Count() + 1) * totToDL;</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineplus">+  PRInt32 percent = numerator * 100 / denominator;</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineplus">+  </span>
<a href="#l6.700"></a><span id="l6.700" class="difflineplus">+  nsAutoString numDownloadedStr;</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineplus">+  numDownloadedStr.AppendInt(numDLed);</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineplus">+</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineplus">+  nsAutoString totalToDownloadStr;</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineplus">+  totalToDownloadStr.AppendInt(totToDL);</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+  nsString statusString;</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+  if (!NS_SUCCEEDED(rv))</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+    return;</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineplus">+</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineplus">+  if (!NS_SUCCEEDED(rv))</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineplus">+    return;</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineplus">+</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineplus">+  if (filtering)</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineplus">+  {</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineplus">+    NS_ConvertUTF8toUTF16 header(*m_filterHeaders[m_currentXHDRIndex]);</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineplus">+    const PRUnichar *formatStrings[3] = { header.get(),</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineplus">+      numDownloadedStr.get(), totalToDownloadStr.get() };</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;downloadingFilterHeaders&quot;).get(),</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineplus">+      formatStrings, 3, getter_Copies(statusString));</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+  }</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineplus">+  else</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+  {</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+    const PRUnichar *formatStrings[2] = { numDownloadedStr.get(),</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+      totalToDownloadStr.get() };</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;downloadingHeaders&quot;).get(),</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+      formatStrings, 2, getter_Copies(statusString));</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+  }</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+  if (!NS_SUCCEEDED(rv))</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineplus">+    return;</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineplus">+</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineplus">+  SetProgressStatus(statusString.get());</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineplus">+  m_lastStatusUpdate = PR_Now();</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineplus">+</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineplus">+  // only update the progress meter if it has changed</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineplus">+  if (percent != m_lastPercent)</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineplus">+  {</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineplus">+    SetProgressBarPercent(percent);</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineplus">+    m_lastPercent = percent;</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineplus">+  }</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineplus">+}</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineplus">+</span>
<a href="#l6.746"></a><span id="l6.746"> NS_IMETHODIMP nsNNTPNewsgroupList::SetGetOldMessages(PRBool aGetOldMessages)</span>
<a href="#l6.747"></a><span id="l6.747"> {</span>
<a href="#l6.748"></a><span id="l6.748">   m_getOldMessages = aGetOldMessages;</span>
<a href="#l6.749"></a><span id="l6.749">   return NS_OK;</span>
<a href="#l6.750"></a><span id="l6.750"> }</span>
<a href="#l6.751"></a><span id="l6.751"> </span>
<a href="#l6.752"></a><span id="l6.752"> NS_IMETHODIMP nsNNTPNewsgroupList::GetGetOldMessages(PRBool *aGetOldMessages)</span>
<a href="#l6.753"></a><span id="l6.753"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -48,16 +48,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsINNTPNewsgroupList.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> /* The below is all stuff that we remember for netlib about which</span>
<a href="#l7.15"></a><span id="l7.15">    articles we've already seen in the current newsgroup. */</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> typedef struct MSG_NewsKnown {</span>
<a href="#l7.18"></a><span id="l7.18">   nsMsgKeySet* set; /* Set of articles we've already gotten</span>
<a href="#l7.19"></a><span id="l7.19">                        from the newsserver (if it's marked</span>
<a href="#l7.20"></a><span id="l7.20">                        &quot;read&quot;, then we've already gotten it).</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -98,39 +99,57 @@ private:</span>
<a href="#l7.22"></a><span id="l7.22"> #ifdef HAVE_CHANGELISTENER</span>
<a href="#l7.23"></a><span id="l7.23">   virtual void OnAnnouncerGoingAway (ChangeAnnouncer *instigator);</span>
<a href="#l7.24"></a><span id="l7.24"> #endif</span>
<a href="#l7.25"></a><span id="l7.25">   nsresult ParseLine(char *line, PRUint32 *message_number);</span>
<a href="#l7.26"></a><span id="l7.26">   nsresult GetDatabase(const char *uri, nsIMsgDatabase **db);</span>
<a href="#l7.27"></a><span id="l7.27">   void SetProgressBarPercent(PRInt32 percent);</span>
<a href="#l7.28"></a><span id="l7.28">   void SetProgressStatus(const PRUnichar *message);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  void UpdateStatus(PRBool filtering, PRInt32 numDled, PRInt32 totToDL);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  nsresult AddHeader(const char * header, const char * value);</span>
<a href="#l7.33"></a><span id="l7.33"> protected:</span>
<a href="#l7.34"></a><span id="l7.34">   PRBool m_getOldMessages;</span>
<a href="#l7.35"></a><span id="l7.35">   PRBool m_promptedAlready;</span>
<a href="#l7.36"></a><span id="l7.36">   PRBool m_downloadAll;</span>
<a href="#l7.37"></a><span id="l7.37">   PRInt32 m_maxArticles;</span>
<a href="#l7.38"></a><span id="l7.38">   PRInt32 m_lastPercent;</span>
<a href="#l7.39"></a><span id="l7.39">   PRTime m_lastStatusUpdate;</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   nsCOMPtr &lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l7.42"></a><span id="l7.42">   nsCOMPtr &lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l7.43"></a><span id="l7.43">   nsCOMPtr &lt;nsINntpUrl&gt; m_runningURL;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  </span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ </span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  /**</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+   * The last message that we have processed (XOVER or HEAD).</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+   */</span>
<a href="#l7.49"></a><span id="l7.49">   nsMsgKey m_lastProcessedNumber;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  nsMsgKey m_firstMsgNumber;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  nsMsgKey m_lastMsgNumber;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  PRInt32 m_firstMsgToDownload;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  PRInt32 m_lastMsgToDownload;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  /**</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+   * The endpoints of the message chunk we are actually downloading.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+   */</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  nsMsgKey m_firstMsgNumber, m_lastMsgNumber;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  /**</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+   * The endpoints of the message chunk we are capable of downloading.</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+   */</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  PRInt32 m_firstMsgToDownload, m_lastMsgToDownload;</span>
<a href="#l7.62"></a><span id="l7.62">   </span>
<a href="#l7.63"></a><span id="l7.63">   struct MSG_NewsKnown m_knownArts;</span>
<a href="#l7.64"></a><span id="l7.64">   nsMsgKeySet *m_set;</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  nsCStringArray m_filterHeaders;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  PRInt32 m_currentXHDRIndex;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  nsCString m_lastHeader;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  nsCString m_thisLine;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+</span>
<a href="#l7.71"></a><span id="l7.71"> private:</span>
<a href="#l7.72"></a><span id="l7.72">   nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l7.73"></a><span id="l7.73">   nsCOMPtr &lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l7.74"></a><span id="l7.74">   nsCOMPtr &lt;nsIMsgFilterList&gt; m_serverFilterList;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_newMsgHdr; // current message header we're building</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  nsCOMArray&lt;nsIMsgDBHdr&gt; m_newHeaders;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79">   PRBool m_addHdrToDB;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+</span>
<a href="#l7.81"></a><span id="l7.81"> };</span>
<a href="#l7.82"></a><span id="l7.82">     </span>
<a href="#l7.83"></a><span id="l7.83"> #endif /* nsNNTPNewsgroupListState_h___ */</span>
<a href="#l7.84"></a><span id="l7.84"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -92,16 +92,18 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14"> // for the memory cache...</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsICacheEntryDescriptor.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -197,16 +199,18 @@ const char *const stateLabels[] = {</span>
<a href="#l8.23"></a><span id="l8.23"> &quot;NNTP_BEGIN_ARTICLE&quot;,</span>
<a href="#l8.24"></a><span id="l8.24"> &quot;NNTP_READ_ARTICLE&quot;,</span>
<a href="#l8.25"></a><span id="l8.25"> &quot;NNTP_XOVER_BEGIN&quot;,</span>
<a href="#l8.26"></a><span id="l8.26"> &quot;NNTP_FIGURE_NEXT_CHUNK&quot;,</span>
<a href="#l8.27"></a><span id="l8.27"> &quot;NNTP_XOVER_SEND&quot;,</span>
<a href="#l8.28"></a><span id="l8.28"> &quot;NNTP_XOVER_RESPONSE&quot;,</span>
<a href="#l8.29"></a><span id="l8.29"> &quot;NNTP_XOVER&quot;,</span>
<a href="#l8.30"></a><span id="l8.30"> &quot;NEWS_PROCESS_XOVER&quot;,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+&quot;NNTP_XHDR_SEND&quot;,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+&quot;NNTP_XHDR_RESPONSE&quot;,</span>
<a href="#l8.33"></a><span id="l8.33"> &quot;NNTP_READ_GROUP&quot;,</span>
<a href="#l8.34"></a><span id="l8.34"> &quot;NNTP_READ_GROUP_RESPONSE&quot;,</span>
<a href="#l8.35"></a><span id="l8.35"> &quot;NNTP_READ_GROUP_BODY&quot;,</span>
<a href="#l8.36"></a><span id="l8.36"> &quot;NNTP_SEND_GROUP_FOR_ARTICLE&quot;,</span>
<a href="#l8.37"></a><span id="l8.37"> &quot;NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE&quot;,</span>
<a href="#l8.38"></a><span id="l8.38"> &quot;NNTP_PROFILE_ADD&quot;,</span>
<a href="#l8.39"></a><span id="l8.39"> &quot;NNTP_PROFILE_ADD_RESPONSE&quot;,</span>
<a href="#l8.40"></a><span id="l8.40"> &quot;NNTP_PROFILE_DELETE&quot;,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -3287,18 +3291,21 @@ void nsNNTPProtocol::HandleAuthenticatio</span>
<a href="#l8.42"></a><span id="l8.42">     // but we need to handle the case where the password has</span>
<a href="#l8.43"></a><span id="l8.43">     // changed while the app is running, and</span>
<a href="#l8.44"></a><span id="l8.44">     // reprompt the user for the (potentially) new password.</span>
<a href="#l8.45"></a><span id="l8.45">     // So clear the userAuthenticated flag.</span>
<a href="#l8.46"></a><span id="l8.46">     m_nntpServer-&gt;SetUserAuthenticated(PR_FALSE);</span>
<a href="#l8.47"></a><span id="l8.47">   }</span>
<a href="#l8.48"></a><span id="l8.48"> }</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-/* start the xover command</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">- */</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+// XOVER, XHDR, and HEAD processing code</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+// Used for filters</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+// State machine explanation located in doxygen comments for nsNNTPProtocol</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58"> PRInt32 nsNNTPProtocol::BeginReadXover()</span>
<a href="#l8.59"></a><span id="l8.59"> {</span>
<a href="#l8.60"></a><span id="l8.60">   PRInt32 count;     /* Response fields */</span>
<a href="#l8.61"></a><span id="l8.61">   nsresult rv = NS_OK;</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63">   rv = SetCurrentGroup();</span>
<a href="#l8.64"></a><span id="l8.64">   if (NS_FAILED(rv)) return -1;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -3372,18 +3379,17 @@ PRInt32 nsNNTPProtocol::FigureNextChunk(</span>
<a href="#l8.66"></a><span id="l8.66">     }</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">     rv = m_newsgroupList-&gt;SetGetOldMessages(getOldMessages);</span>
<a href="#l8.69"></a><span id="l8.69">     if (NS_FAILED(rv)) return status;</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">     rv = m_newsgroupList-&gt;GetRangeOfArtsToDownload(m_msgWindow,</span>
<a href="#l8.72"></a><span id="l8.72">       m_firstPossibleArticle,</span>
<a href="#l8.73"></a><span id="l8.73">       m_lastPossibleArticle,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-      m_numArticlesWanted -</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-      m_numArticlesLoaded,</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      m_numArticlesWanted - m_numArticlesLoaded,</span>
<a href="#l8.77"></a><span id="l8.77">       &amp;(m_firstArticle),</span>
<a href="#l8.78"></a><span id="l8.78">       &amp;(m_lastArticle),</span>
<a href="#l8.79"></a><span id="l8.79">       &amp;status);</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">   if (NS_FAILED(rv)) return status;</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83">   if (m_firstArticle &lt;= 0 || m_firstArticle &gt; m_lastArticle)</span>
<a href="#l8.84"></a><span id="l8.84">   {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineat">@@ -3492,17 +3498,17 @@ PRInt32 nsNNTPProtocol::ReadXover(nsIInp</span>
<a href="#l8.86"></a><span id="l8.86">     return 0;</span>
<a href="#l8.87"></a><span id="l8.87">   }</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">   if(!line)</span>
<a href="#l8.90"></a><span id="l8.90">     return(status);  /* no line yet or TCP error */</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">   if(line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l8.93"></a><span id="l8.93">   {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l8.96"></a><span id="l8.96">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.97"></a><span id="l8.97">     PR_Free(lineToFree);</span>
<a href="#l8.98"></a><span id="l8.98">     return(0);</span>
<a href="#l8.99"></a><span id="l8.99">   }</span>
<a href="#l8.100"></a><span id="l8.100">   else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l8.101"></a><span id="l8.101">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l8.102"></a><span id="l8.102">     line++;</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104" class="difflineat">@@ -3514,51 +3520,127 @@ PRInt32 nsNNTPProtocol::ReadXover(nsIInp</span>
<a href="#l8.105"></a><span id="l8.105">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l8.106"></a><span id="l8.106">   }</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">   rv = m_newsgroupList-&gt;ProcessXOVERLINE(line, &amp;status);</span>
<a href="#l8.109"></a><span id="l8.109">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XOVERLINE&quot;);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">   m_numArticlesLoaded++;</span>
<a href="#l8.112"></a><span id="l8.112">   PR_Free(lineToFree);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-  return NS_SUCCEEDED(rv) ? status : -1; /* keep going if no error */</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  return NS_SUCCEEDED(rv) ? (PRInt32)status : -1; /* keep going if no error */</span>
<a href="#l8.115"></a><span id="l8.115"> }</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117"> /* Finished processing all the XOVER data.</span>
<a href="#l8.118"></a><span id="l8.118"> */</span>
<a href="#l8.119"></a><span id="l8.119"> </span>
<a href="#l8.120"></a><span id="l8.120"> PRInt32 nsNNTPProtocol::ProcessXover()</span>
<a href="#l8.121"></a><span id="l8.121"> {</span>
<a href="#l8.122"></a><span id="l8.122">   nsresult rv;</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124">   /* xover_parse_state stored in MSG_Pane cd-&gt;pane */</span>
<a href="#l8.125"></a><span id="l8.125">   NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l8.126"></a><span id="l8.126">   if (!m_newsgroupList) return -1;</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128">   PRInt32 status = 0;</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  m_newsgroupList-&gt;CallFilters();</span>
<a href="#l8.130"></a><span id="l8.130">   rv = m_newsgroupList-&gt;FinishXOVERLINE(0,&amp;status);</span>
<a href="#l8.131"></a><span id="l8.131">   m_newsgroupList = nsnull;</span>
<a href="#l8.132"></a><span id="l8.132">   if (NS_SUCCEEDED(rv) &amp;&amp; status &lt; 0) return status;</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134">   m_nextState = NEWS_DONE;</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136">   return(MK_DATA_LOADED);</span>
<a href="#l8.137"></a><span id="l8.137"> }</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-PRInt32 nsNNTPProtocol::ReadNewsgroup()</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+PRInt32 nsNNTPProtocol::XhdrSend()</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+{</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  nsCString header;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  m_newsgroupList-&gt;InitXHDR(header);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  if (header.IsEmpty())</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+  {</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+    return 0;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  </span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;XHDR %s %d-%d&quot; CRLF,</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+              header.get(), m_firstArticle, m_lastArticle);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  m_nextStateAfterResponse = NNTP_XHDR_RESPONSE;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  return mailnewsurl ? SendData(mailnewsurl, outputBuffer) : 0;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+}</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+PRInt32 nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream)</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+{</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_XHDR_OK)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  {</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+    m_nextState = NNTP_READ_GROUP;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+    // The reasoning behind setting this flag and not an XHDR flag is that we</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    // are going to have to use HEAD instead. At that point, using XOVER as</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    // well is just wasting bandwidth.</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    SetFlag(NNTP_NO_XOVER_SUPPORT);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    return 0;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  }</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  </span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  char *line, *lineToFree;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  PRUint32 status = 1;</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  PRBool pauseForMoreData = PR_FALSE;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+  if (pauseForMoreData)</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    return 0;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+  }</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+  if (!line)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    return status;  /* no line yet or TCP error */</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+  {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    PR_Free(lineToFree);</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+    return(0);</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  }</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+  if (status &gt; 1)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+  {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    mBytesReceived += status;</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+  }</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+  rv = m_newsgroupList-&gt;ProcessXHDRLine(nsDependentCString(line));</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XHDRLINE&quot;);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  m_numArticlesLoaded++;</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+  PR_Free(lineToFree);</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+  return NS_SUCCEEDED(rv) ? (PRInt32)status : -1; /* keep going if no error */</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+}</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+PRInt32 nsNNTPProtocol::ReadHeaders()</span>
<a href="#l8.213"></a><span id="l8.213"> {</span>
<a href="#l8.214"></a><span id="l8.214">   if(m_articleNumber &gt; m_lastArticle)</span>
<a href="#l8.215"></a><span id="l8.215">   {  /* end of groups */</span>
<a href="#l8.216"></a><span id="l8.216"> </span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+    m_newsgroupList-&gt;InitHEAD(-1);</span>
<a href="#l8.218"></a><span id="l8.218">     m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l8.219"></a><span id="l8.219">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.220"></a><span id="l8.220">     return(0);</span>
<a href="#l8.221"></a><span id="l8.221">   }</span>
<a href="#l8.222"></a><span id="l8.222">   else</span>
<a href="#l8.223"></a><span id="l8.223">   {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+    m_newsgroupList-&gt;InitHEAD(m_articleNumber);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+</span>
<a href="#l8.226"></a><span id="l8.226">     char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.227"></a><span id="l8.227">     PR_snprintf(outputBuffer,</span>
<a href="#l8.228"></a><span id="l8.228">       OUTPUT_BUFFER_SIZE,</span>
<a href="#l8.229"></a><span id="l8.229">       &quot;HEAD %ld&quot; CRLF,</span>
<a href="#l8.230"></a><span id="l8.230">       m_articleNumber++);</span>
<a href="#l8.231"></a><span id="l8.231">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.232"></a><span id="l8.232">     m_nextStateAfterResponse = NNTP_READ_GROUP_RESPONSE;</span>
<a href="#l8.233"></a><span id="l8.233"> </span>
<a href="#l8.234"></a><span id="l8.234" class="difflineat">@@ -3571,35 +3653,30 @@ PRInt32 nsNNTPProtocol::ReadNewsgroup()</span>
<a href="#l8.235"></a><span id="l8.235">   }</span>
<a href="#l8.236"></a><span id="l8.236"> }</span>
<a href="#l8.237"></a><span id="l8.237"> </span>
<a href="#l8.238"></a><span id="l8.238"> /* See if the &quot;HEAD&quot; command was successful</span>
<a href="#l8.239"></a><span id="l8.239"> */</span>
<a href="#l8.240"></a><span id="l8.240"> </span>
<a href="#l8.241"></a><span id="l8.241"> PRInt32 nsNNTPProtocol::ReadNewsgroupResponse()</span>
<a href="#l8.242"></a><span id="l8.242"> {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-</span>
<a href="#l8.245"></a><span id="l8.245">   if (m_responseCode == MK_NNTP_RESPONSE_ARTICLE_HEAD)</span>
<a href="#l8.246"></a><span id="l8.246">   {     /* Head follows - parse it:*/</span>
<a href="#l8.247"></a><span id="l8.247">     m_nextState = NNTP_READ_GROUP_BODY;</span>
<a href="#l8.248"></a><span id="l8.248"> </span>
<a href="#l8.249"></a><span id="l8.249">     if(m_messageID)</span>
<a href="#l8.250"></a><span id="l8.250">       *m_messageID = '\0';</span>
<a href="#l8.251"></a><span id="l8.251"> </span>
<a href="#l8.252"></a><span id="l8.252">     m_key = nsMsgKey_None;</span>
<a href="#l8.253"></a><span id="l8.253"> </span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-    /* Give the message number to the header parser. */</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-    rv = m_newsgroupList-&gt;ProcessNonXOVER(m_responseText);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-    /* convert nsresult-&gt;status */</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-    return NS_FAILED(rv);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+    return 0;</span>
<a href="#l8.259"></a><span id="l8.259">   }</span>
<a href="#l8.260"></a><span id="l8.260">   else</span>
<a href="#l8.261"></a><span id="l8.261">   {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-    NNTP_LOG_NOTE((&quot;Bad group header found!&quot;));</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+    m_newsgroupList-&gt;HEADFailed(m_articleNumber);</span>
<a href="#l8.264"></a><span id="l8.264">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l8.265"></a><span id="l8.265">     return(0);</span>
<a href="#l8.266"></a><span id="l8.266">   }</span>
<a href="#l8.267"></a><span id="l8.267"> }</span>
<a href="#l8.268"></a><span id="l8.268"> </span>
<a href="#l8.269"></a><span id="l8.269"> /* read the body of the &quot;HEAD&quot; command</span>
<a href="#l8.270"></a><span id="l8.270"> */</span>
<a href="#l8.271"></a><span id="l8.271"> PRInt32 nsNNTPProtocol::ReadNewsgroupBody(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineat">@@ -3624,24 +3701,26 @@ PRInt32 nsNNTPProtocol::ReadNewsgroupBod</span>
<a href="#l8.273"></a><span id="l8.273"> </span>
<a href="#l8.274"></a><span id="l8.274">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) read_group_body: got line: %s|&quot;,this,line));</span>
<a href="#l8.275"></a><span id="l8.275"> </span>
<a href="#l8.276"></a><span id="l8.276">   /* End of body? */</span>
<a href="#l8.277"></a><span id="l8.277">   if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l8.278"></a><span id="l8.278">   {</span>
<a href="#l8.279"></a><span id="l8.279">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l8.280"></a><span id="l8.280">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+    return 0;</span>
<a href="#l8.282"></a><span id="l8.282">   }</span>
<a href="#l8.283"></a><span id="l8.283">   else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l8.284"></a><span id="l8.284">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l8.285"></a><span id="l8.285">     line++;</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-  rv = m_newsgroupList-&gt;ProcessNonXOVER(line);</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+  nsCString safe_line(line);</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+  rv = m_newsgroupList-&gt;ProcessHEADLine(safe_line);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+  PR_Free(lineToFree);</span>
<a href="#l8.291"></a><span id="l8.291">   /* convert nsresult-&gt;status */</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-  PR_Free(lineToFree);</span>
<a href="#l8.293"></a><span id="l8.293">   return NS_FAILED(rv);</span>
<a href="#l8.294"></a><span id="l8.294"> }</span>
<a href="#l8.295"></a><span id="l8.295"> </span>
<a href="#l8.296"></a><span id="l8.296"> </span>
<a href="#l8.297"></a><span id="l8.297"> nsresult nsNNTPProtocol::GetNewsStringByID(PRInt32 stringID, PRUnichar **aString)</span>
<a href="#l8.298"></a><span id="l8.298"> {</span>
<a href="#l8.299"></a><span id="l8.299">   nsresult rv;</span>
<a href="#l8.300"></a><span id="l8.300">   nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineat">@@ -5026,29 +5105,37 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l8.302"></a><span id="l8.302">     case NEWS_PROCESS_XOVER:</span>
<a href="#l8.303"></a><span id="l8.303">     case NEWS_PROCESS_BODIES:</span>
<a href="#l8.304"></a><span id="l8.304"> #ifdef UNREADY_CODE</span>
<a href="#l8.305"></a><span id="l8.305">       NET_Progress(ce-&gt;window_id, XP_GetString(XP_PROGRESS_SORT_ARTICLES));</span>
<a href="#l8.306"></a><span id="l8.306"> #endif</span>
<a href="#l8.307"></a><span id="l8.307">       status = ProcessXover();</span>
<a href="#l8.308"></a><span id="l8.308">       break;</span>
<a href="#l8.309"></a><span id="l8.309"> </span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+    case NNTP_XHDR_SEND:</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+      status = XhdrSend();</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+      break;</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+    case NNTP_XHDR_RESPONSE:</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+      status = XhdrResponse(inputStream);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+      break;</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+</span>
<a href="#l8.318"></a><span id="l8.318">     case NNTP_READ_GROUP:</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-      status = ReadNewsgroup();</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+      status = ReadHeaders();</span>
<a href="#l8.321"></a><span id="l8.321">       break;</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323">     case NNTP_READ_GROUP_RESPONSE:</span>
<a href="#l8.324"></a><span id="l8.324">       if (inputStream == nsnull)</span>
<a href="#l8.325"></a><span id="l8.325">         SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.326"></a><span id="l8.326">       else</span>
<a href="#l8.327"></a><span id="l8.327">         status = ReadNewsgroupResponse();</span>
<a href="#l8.328"></a><span id="l8.328">       break;</span>
<a href="#l8.329"></a><span id="l8.329"> </span>
<a href="#l8.330"></a><span id="l8.330">     case NNTP_READ_GROUP_BODY:</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-      status = ReadNewsgroupResponse();</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+      status = ReadNewsgroupBody(inputStream, length);</span>
<a href="#l8.333"></a><span id="l8.333">       break;</span>
<a href="#l8.334"></a><span id="l8.334"> </span>
<a href="#l8.335"></a><span id="l8.335">     case NNTP_SEND_POST_DATA:</span>
<a href="#l8.336"></a><span id="l8.336">       status = PostData();</span>
<a href="#l8.337"></a><span id="l8.337">       break;</span>
<a href="#l8.338"></a><span id="l8.338">     case NNTP_SEND_POST_DATA_RESPONSE:</span>
<a href="#l8.339"></a><span id="l8.339">       if (inputStream == nsnull)</span>
<a href="#l8.340"></a><span id="l8.340">         SetFlag(NNTP_PAUSE_FOR_READ);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -111,16 +111,18 @@ NNTP_NEWGROUPS,</span>
<a href="#l9.4"></a><span id="l9.4"> NNTP_BEGIN_ARTICLE,</span>
<a href="#l9.5"></a><span id="l9.5"> NNTP_READ_ARTICLE,</span>
<a href="#l9.6"></a><span id="l9.6"> NNTP_XOVER_BEGIN,</span>
<a href="#l9.7"></a><span id="l9.7"> NNTP_FIGURE_NEXT_CHUNK,</span>
<a href="#l9.8"></a><span id="l9.8"> NNTP_XOVER_SEND,</span>
<a href="#l9.9"></a><span id="l9.9"> NNTP_XOVER_RESPONSE,</span>
<a href="#l9.10"></a><span id="l9.10"> NNTP_XOVER,</span>
<a href="#l9.11"></a><span id="l9.11"> NEWS_PROCESS_XOVER,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+NNTP_XHDR_SEND,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+NNTP_XHDR_RESPONSE,</span>
<a href="#l9.14"></a><span id="l9.14"> NNTP_READ_GROUP,</span>
<a href="#l9.15"></a><span id="l9.15"> NNTP_READ_GROUP_RESPONSE,</span>
<a href="#l9.16"></a><span id="l9.16"> NNTP_READ_GROUP_BODY,</span>
<a href="#l9.17"></a><span id="l9.17"> NNTP_SEND_GROUP_FOR_ARTICLE,</span>
<a href="#l9.18"></a><span id="l9.18"> NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE,</span>
<a href="#l9.19"></a><span id="l9.19"> NNTP_PROFILE_ADD,</span>
<a href="#l9.20"></a><span id="l9.20"> NNTP_PROFILE_ADD_RESPONSE,</span>
<a href="#l9.21"></a><span id="l9.21"> NNTP_PROFILE_DELETE,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -263,37 +265,36 @@ private:</span>
<a href="#l9.23"></a><span id="l9.23">   // Per news article state information. (article number, author, subject, id, etc</span>
<a href="#l9.24"></a><span id="l9.24">   char   *m_messageID;</span>
<a href="#l9.25"></a><span id="l9.25">   PRInt32   m_articleNumber;   /* current article number */</span>
<a href="#l9.26"></a><span id="l9.26">   char   *m_commandSpecificData;</span>
<a href="#l9.27"></a><span id="l9.27">   char   *m_searchData;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">   PRInt32   m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-</span>
<a href="#l9.32"></a><span id="l9.32">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   nsCOMPtr&lt;nsINntpIncomingServer&gt; m_nntpServer;</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">   nsresult GetNewsStringByName(const char *aName, PRUnichar **aString);</span>
<a href="#l9.37"></a><span id="l9.37">   nsresult GetNewsStringByID(PRInt32 stringID, PRUnichar **aString);</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">   PRInt32 PostMessageInFile(nsIFile * filePath);</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.43"></a><span id="l9.43">   // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">   PRInt32 ReadLine(nsIInputStream * inputStream, PRUint32 length, char ** line);</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  // Protocol Methods --&gt; This protocol is state driven so each protocol method is</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  //            designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  // Protocol Methods --&gt; This protocol is state driven so each protocol method</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  //            is designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l9.55"></a><span id="l9.55">   //            group them together based on functionality.</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   // gets the response code from the nntp server and the response line. Returns the TCP return code</span>
<a href="#l9.60"></a><span id="l9.60">   // from the read.</span>
<a href="#l9.61"></a><span id="l9.61">   PRInt32 NewsResponse(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">   // Interpret the server response after the connect.</span>
<a href="#l9.64"></a><span id="l9.64">   // Returns negative if the server responds unexpectedly</span>
<a href="#l9.65"></a><span id="l9.65">   PRInt32 LoginResponse();</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineat">@@ -341,44 +342,120 @@ private:</span>
<a href="#l9.67"></a><span id="l9.67">   PRInt32 BeginReadNewsList();</span>
<a href="#l9.68"></a><span id="l9.68">   PRInt32 ReadNewsList(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70">   // Newsgroup specific protocol handlers</span>
<a href="#l9.71"></a><span id="l9.71">   PRInt32 DisplayNewsgroups();</span>
<a href="#l9.72"></a><span id="l9.72">   PRInt32 BeginNewsgroups();</span>
<a href="#l9.73"></a><span id="l9.73">   PRInt32 ProcessNewsgroups(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  PRInt32 ReadNewsgroup();</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  PRInt32 ReadNewsgroupResponse();</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-  PRInt32 ReadNewsgroupBody(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-</span>
<a href="#l9.80"></a><span id="l9.80">   // Protocol handlers used for posting data</span>
<a href="#l9.81"></a><span id="l9.81">   PRInt32 PostData();</span>
<a href="#l9.82"></a><span id="l9.82">   PRInt32 PostDataResponse();</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">   PRInt32 CheckForArticle();</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86">   // NewsRC specific</span>
<a href="#l9.87"></a><span id="l9.87">   PRInt32 DisplayNewsRC();</span>
<a href="#l9.88"></a><span id="l9.88">   PRInt32 DisplayNewsRCResponse();</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-  // start off the xover command</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+  // XHDR, XOVER, HEAD filtering process handlers</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  // These are ordered by the rough order of usage</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+ </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  /**</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+   * The first step in the filtering process, the state NNTP_XOVER_BEGIN.</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+   * This method sets up m_newsgroupList.</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+   * Followed by: NNTP_FIGURE_NEXT_CHUNK</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+   */</span>
<a href="#l9.101"></a><span id="l9.101">   PRInt32 BeginReadXover();</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  /**</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+   * The loop control for filtering, the state NNTP_FIGURE_NEXT_CHUNK.</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+   * This method contacts the newsgroupList to figure out which articles to</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+   * download and then prepares it for XOVER support.</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+   * Followed by: NEWS_PROCESS_XOVER       if everything is finished</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+   *              NNTP_READ_GROUP          if XOVER doesn't work</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+   *              NNTP_XOVER_SEND          if XOVER does work</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+   */</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+  PRInt32 FigureNextChunk();</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-  // process the xover list as it comes from the server and load it into the sort list.</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+  // The XOVER process core</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+  /**</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+   * The state NNTP_XOVER_SEND, which actually sends the message.</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+   * Followed by: NNTP_XOVER_RESPONSE</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+   */</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  PRInt32 XoverSend();</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  /**</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+   * This state, NNTP_XOVER_RESPONSE, actually checks the XOVER capabiliity.</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+   * Followed by: NNTP_XOVER               if XOVER is supported</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+   *              NNTP_READ_GROUP          if it isn't</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+   */</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  PRInt32 ReadXoverResponse();</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  /**</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+   * This state, NNTP_XOVER, processes the results from the XOVER command.</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+   * It asks nsNNTPNewsgroupList to process the line using ProcessXOVERLINE.</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+   * Followed by: NNTP_XHDR_SEND</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+   */</span>
<a href="#l9.130"></a><span id="l9.130">   PRInt32 ReadXover(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  // See if the xover response is going to return us data. If the proper code isn't returned then</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-  // assume xover isn't supported and use normal read_group.</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-  PRInt32 ReadXoverResponse();</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+  // The XHDR process core</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  /**</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+   * This state, NNTP_XHDR_SEND, sends the XHDR command.</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+   * The headers are all managed by nsNNTPNewsgroupList, and this picks them up</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+   * one by one as they are needed.</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+   * Followed by: NNTP_XHDR_RESPONSE       if there is a header to be sent</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+   *              NNTP_FIGURE_NEXT_CHUNK   if all headers have been sent</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+   */</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  PRInt32 XhdrSend();</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+  /**</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+   * This state, NNTP_XHDR_RESPONSE, processes the XHDR response.</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+   * It mostly passes the information off to nsNNTPNewsgroupList, and only does</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+   * response code checking and a bit of preprocessing. Note that if XHDR</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+   * doesn't work properly, HEAD fallback is switched on and all subsequent</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+   * chunks will NOT use XOVER.</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+   * Followed by: NNTP_READ_GROUP          if XHDR doesn't work properly</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+   *              NNTP_XHDR_SEND           when finished processing XHR.</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+   */</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+  PRInt32 XhdrResponse(nsIInputStream *inputStream);</span>
<a href="#l9.154"></a><span id="l9.154"> </span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  PRInt32 XoverSend();</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  // HEAD processing core</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  /**</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+   * This state, NNTP_READ_GROUP, is the control for the HEAD processor.</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+   * It sends the HEAD command and increments the article number until it is</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+   * finished. WARNING: HEAD is REALLY SLOW.</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+   * Followed by: NNTP_FIGURE_NEXT_CHUNK   when it is finished </span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+   *              NNTP_READ_GROUP_RESPONSE when it is not</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+   */</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  PRInt32 ReadHeaders();</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  /**</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+   * This state, NNTP_READ_GROUP_RESPONSE, checks if the article exists.</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+   * Because it is required by NNTP, if it doesn't work, the only problem would</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+   * be that the article doesn't exist. Passes off article number data to </span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+   * nsNNTPNewsgroupList.</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+   * Followed by: NNTP_READ_GROUP_BODY     if the article exists</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+   *              NNTP_READ_GROUP          if it doesn't.</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+   */</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  PRInt32 ReadNewsgroupResponse();</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+  /**</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+   * This state, NNTP_READ_GROUP_BODY, reads the body of the HEAD command.</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+   * Once again, it passes information off to nsNNTPNewsgroupList.</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+   * Followed by: NNTP_READ_GROUP</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+   */</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+  PRInt32 ReadNewsgroupBody(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+  /**</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+   * This state, NNTP_PROCESS_XOVER, is the final step of the filter-processing</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+   * code. Currently, all it does is cleans up the unread count and calls the</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+   * filters, both via nsNNTPNewsgroupList.</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+   * Followed by: NEWS_DONE</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+   */</span>
<a href="#l9.187"></a><span id="l9.187">   PRInt32 ProcessXover();</span>
<a href="#l9.188"></a><span id="l9.188"> </span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-  PRInt32 FigureNextChunk();</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192">   // Canceling</span>
<a href="#l9.193"></a><span id="l9.193">   PRInt32 StartCancel();</span>
<a href="#l9.194"></a><span id="l9.194">   PRInt32 DoCancel();</span>
<a href="#l9.195"></a><span id="l9.195"> </span>
<a href="#l9.196"></a><span id="l9.196">   // XPAT</span>
<a href="#l9.197"></a><span id="l9.197">   PRInt32 XPATSend();</span>
<a href="#l9.198"></a><span id="l9.198">   PRInt32 XPATResponse(nsIInputStream * inputStream, PRUint32 length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post1.eml</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+Subject: First post!</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+Message-ID: &lt;1@regular.invalid&gt;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+Xref: test.filter:1</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+This is the first body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post2.eml</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+Subject: Odd Subject</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+Message-ID: &lt;2@regular.invalid&gt;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+Xref: test.filter:2</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+This is the second body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post3.eml</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+From: Odd Person &lt;fake@acme.invalid&gt;</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+Subject: Regular subject</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+Message-ID: &lt;3@regular.invalid&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+Xref: test.filter:3</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+This is the third body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post4.eml</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+Date: Sat, 1 Jan 2000 19:58:07 +0400</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+Subject: Regular subject</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+Message-ID: &lt;4@regular.invalid&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+Xref: test.filter:4</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+This is the fourth body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post5.eml</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,50 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+Subject: Regular subject</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+Message-ID: &lt;5@regular.invalid&gt;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+Xref: test.filter:5</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+Bytes: 2057</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+This is the fifth body post, with extra special padding to make sure</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+that no one else has the same length as it. You see, we have to ensure</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+that we have at least two KB of data because search is stupid and</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+searches in terms of KB. If we didn't, we'd be stuck with a lot of</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+messages merely matching 1, so we use this to pad the size.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+commodo consequat. Duis aute irure dolor in reprehenderit in voluptate</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+occaecat cupidatat non proident, sunt in culpa qui officia deserunt</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+mollit anim id est laborum.</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+commodo consequat. Duis aute irure dolor in reprehenderit in voluptate</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+occaecat cupidatat non proident, sunt in culpa qui officia deserunt</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+mollit anim id est laborum.</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+commodo consequat. Duis aute irure dolor in reprehenderit in voluptate</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+occaecat cupidatat non proident, sunt in culpa qui officia deserunt</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+mollit anim id est laborum.</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+.</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+But that wasn't all :-)</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+-- </span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+A signature for the heck of it.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post6.eml</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+User-Agent: Program/1.0</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+Subject: Regular subject</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+Message-ID: &lt;6.odd@regular.invalid&gt;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+Xref: test.filter:6</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+This is the sixth body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mailnews/news/test/postings/auto-add/post7.eml</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+Path: border1.nntp.dca.giganews.com!nntp.giganews.com!local02.nntp.dca.giganews.com!nntp.mozilla.org!news.mozilla.org.POSTED!not-for-mail</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+Date: Mon, 23 Jun 2008 19:58:07 +0400</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+From: Normal Person &lt;fake@acme.invalid&gt;</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+User-Agent: Odd/1.0</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+Newsgroups: test.filter</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+Subject: Regular subject</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Content-Type: text/plain; charset=ISO-8859-1; format=flowed</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+Message-ID: &lt;7@regular.invalid&gt;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+NNTP-Posting-Host: 127.0.0.1</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+Xref: test.filter:7</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+This is the seventh body post.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -6,38 +6,77 @@ do_import_script(&quot;../mailnews/test/fakes</span>
<a href="#l17.4"></a><span id="l17.4"> do_import_script(&quot;../mailnews/test/resources/mailDirService.js&quot;)</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> // The groups to set up on the fake server.</span>
<a href="#l17.7"></a><span id="l17.7"> // It is an array of tuples, where the first element is the group name and the</span>
<a href="#l17.8"></a><span id="l17.8"> // second element is whether or not we should subscribe to it.</span>
<a href="#l17.9"></a><span id="l17.9"> var groups = [</span>
<a href="#l17.10"></a><span id="l17.10">   [&quot;test.empty&quot;, false],</span>
<a href="#l17.11"></a><span id="l17.11">   [&quot;test.subscribe.empty&quot;, true],</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  [&quot;test.subscribe.simple&quot;, true]</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  [&quot;test.subscribe.simple&quot;, true],</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  [&quot;test.filter&quot;, true]</span>
<a href="#l17.15"></a><span id="l17.15"> ];</span>
<a href="#l17.16"></a><span id="l17.16"> // Sets up the NNTP daemon object for use in fake server</span>
<a href="#l17.17"></a><span id="l17.17"> function setupNNTPDaemon() {</span>
<a href="#l17.18"></a><span id="l17.18">   var daemon = new nntpDaemon();</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">   groups.forEach(function (element) {</span>
<a href="#l17.21"></a><span id="l17.21">     daemon.addGroup(element[0]);</span>
<a href="#l17.22"></a><span id="l17.22">   });</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  var auto_add = do_get_file(&quot;../mailnews/news/test/postings/auto-add/&quot;);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  var files = [];</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  var enumerator = auto_add.directoryEntries;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  while (enumerator.hasMoreElements())</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    files.push(enumerator.getNext().QueryInterface(Ci.nsIFile));</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  files.sort(function (a, b) {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+    if (a.leafName == b.leafName) return 0;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+    return a.leafName &lt; b.leafName ? -1 : 1;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  });</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  files.forEach(function (file) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+      var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+                      .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+      var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+                      .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+      fstream.init(file, -1, 0, 0);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+      sstream.init(fstream);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+      </span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+      var post = &quot;&quot;;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+      for (let part = sstream.read(4096); part.length &gt; 0;) {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+        post += part;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+        part = sstream.read(4096);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+      }</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+      sstream.close();</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+      fstream.close();</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+      daemon.addArticle(new newsArticle(post));</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  });</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+</span>
<a href="#l17.53"></a><span id="l17.53">   var article = new newsArticle(&quot;From: John Doe &lt;john.doe@example.com&gt;\n&quot;+</span>
<a href="#l17.54"></a><span id="l17.54">       &quot;Date: Sat, 24 Mar 1990 10:59:24 -0500\n&quot;+</span>
<a href="#l17.55"></a><span id="l17.55">       &quot;Newsgroups: test.subscribe.simple\n&quot;+</span>
<a href="#l17.56"></a><span id="l17.56">       &quot;Subject: H2G2 -- What does it mean?\n&quot;+</span>
<a href="#l17.57"></a><span id="l17.57">       &quot;Message-ID: &lt;TSS1@nntp.test&gt;\n&quot;+</span>
<a href="#l17.58"></a><span id="l17.58">       &quot;\n&quot;+</span>
<a href="#l17.59"></a><span id="l17.59">       &quot;What does the acronym H2G2 stand for? I've seen it before...\n&quot;);</span>
<a href="#l17.60"></a><span id="l17.60">   daemon.addArticleToGroup(article, &quot;test.subscribe.simple&quot;, 1);</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62">   return daemon;</span>
<a href="#l17.63"></a><span id="l17.63"> }</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+// Enable strict threading</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+              .getService(Ci.nsIPrefBranch);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+prefs.setBoolPref(&quot;mail.strict_threading&quot;, true);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+// Make sure we don't try to use a protected port. I like adding 1024 to the</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+// default port when doing so...</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+const NNTP_PORT = 1024+119;</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75"> var _server = null;</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77"> // Sets up the client-side portion of fakeserver</span>
<a href="#l17.78"></a><span id="l17.78"> function setupLocalServer(port) {</span>
<a href="#l17.79"></a><span id="l17.79">   if (_server != null)</span>
<a href="#l17.80"></a><span id="l17.80">     return _server;</span>
<a href="#l17.81"></a><span id="l17.81">   var acctmgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineat">@@ -110,8 +149,21 @@ function create_post(baseURL, file) {</span>
<a href="#l17.83"></a><span id="l17.83">   url.QueryInterface(Ci.nsINntpUrl);</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85">   var post = Cc[&quot;@mozilla.org/messenger/nntpnewsgrouppost;1&quot;]</span>
<a href="#l17.86"></a><span id="l17.86">                .createInstance(Ci.nsINNTPNewsgroupPost);</span>
<a href="#l17.87"></a><span id="l17.87">   post.postMessageFile = do_get_file(file);</span>
<a href="#l17.88"></a><span id="l17.88">   url.messageToPost = post;</span>
<a href="#l17.89"></a><span id="l17.89">   return url;</span>
<a href="#l17.90"></a><span id="l17.90"> }</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+function resetFolder(folder) {</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  var headerEnum = folder.getMessages(null);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  var headers = [];</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  while (headerEnum.hasMoreElements())</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    headers.push(headerEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+  var db = folder.getMsgDatabase(null);</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  db.dBFolderInfo.knownArtsSet = &quot;&quot;;</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+  for each (var header in headers) {</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+    db.DeleteHeader(header, null, true, false);</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+  }</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mailnews/news/test/unit/test_filter.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,234 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+// Tests for the filtering code of NNTP. The same tests are run for each of the</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+// different NNTP setups, to test code in a variety of cases.</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+//</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+// Different suites:</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+// * Perfect 3977 compliance (not tested)</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+// * Perfect 2980 compliance (XOVER and XHDR work)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+// * Giganews compliance (XHDR doesn't work for practical purposes)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+// * Only 977 compliance (no XOVER support)</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+// Basic operations:</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+// * Test that the following headers trigger:</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+//   - Subject</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+//   - From</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+//   - Date</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+//   - Size</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+//   - Message-ID (header retrievable by XOVER)</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+//   - User-Agent (header not retrievable by XHDR)</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+// * Test all actions</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+var contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+// This maps strings to a filter attribute (excluding the parameter)</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+var ATTRIB_MAP = {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  // Template : [attrib, op, field of value, otherHeader]</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  &quot;subject&quot; : [Ci.nsMsgSearchAttrib.Subject, contains, &quot;str&quot;, null],</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  &quot;from&quot; : [Ci.nsMsgSearchAttrib.Sender, contains, &quot;str&quot;, null],</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  &quot;date&quot; : [Ci.nsMsgSearchAttrib.Date, Ci.nsMsgSearchOp.Is, &quot;date&quot;, null],</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  &quot;size&quot; : [Ci.nsMsgSearchAttrib.Size, Ci.nsMsgSearchOp.Is, &quot;size&quot;, null],</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  &quot;message-id&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+1, contains, &quot;str&quot;,</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+                  &quot;Message-ID&quot;],</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+  &quot;user-agent&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+2, contains, &quot;str&quot;,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                  &quot;User-Agent&quot;]</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+};</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+// And this maps strings to filter actions</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+var ACTION_MAP = {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  // Template : [action, auxiliary attribute field, auxiliary value]</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  &quot;priority&quot; : [Ci.nsMsgFilterAction.ChangePriority, &quot;priority&quot;, 6],</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  &quot;delete&quot; : [Ci.nsMsgFilterAction.Delete],</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  &quot;read&quot; : [Ci.nsMsgFilterAction.MarkRead],</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  &quot;kill&quot; : [Ci.nsMsgFilterAction.KillThread],</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  &quot;watch&quot; : [Ci.nsMsgFilterAction.WatchThread],</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  &quot;flag&quot; : [Ci.nsMsgFilterAction.MarkFlagged],</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  &quot;stop&quot;: [Ci.nsMsgFilterAction.StopExecution],</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  &quot;tag&quot; : [Ci.nsMsgFilterAction.AddTag, &quot;strValue&quot;, &quot;tag&quot;]</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+};</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+function createFilter(list, header, value, action) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  var filter = list.createFilter(header+action+&quot;Test&quot;);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  filter.filterType = Ci.nsMsgFilterType.NewsRule;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+  var searchTerm = filter.createTerm();</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  searchTerm.matchAll = false;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  if (header in ATTRIB_MAP) {</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+    let information = ATTRIB_MAP[header];</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    searchTerm.attrib = information[0];</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    if (information[3] != null)</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+      searchTerm.arbitraryHeader = information[3];</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    searchTerm.op = information[1];</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+    var oldValue = searchTerm.value;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+    oldValue.attrib = information[0];</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    oldValue[information[2]] = value;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    searchTerm.value = oldValue;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+  } else {</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    throw &quot;Unknown header &quot;+header;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  }</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  searchTerm.booleanAnd = true;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  filter.appendTerm(searchTerm);</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  var filterAction = filter.createAction();</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  if (action in ACTION_MAP) {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    let information = ACTION_MAP[action];</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    filterAction.type = information[0];</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+    if (1 in information)</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+      filterAction[information[1]] = information[2];</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+  } else {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+    throw &quot;Unknown action &quot;+action;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  }</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  filter.appendAction(filterAction);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+  filter.enabled = true;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  // Add to the end</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+  list.insertFilterAt(list.filterCount, filter);</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+}</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+// These are the expected results for testing filter triggers</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+var attribResults = {</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  &quot;1@regular.invalid&quot; : [&quot;isRead&quot;, false],</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+  &quot;2@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  &quot;3@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+  &quot;4@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  &quot;5@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  &quot;6.odd@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+  &quot;7@regular.invalid&quot; : [&quot;isRead&quot;, true]</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+};</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+function testAttrib(handler, localserver) {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+  var server = new nsMailServer(handler);</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  // Get the folder and force filters to run</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  var folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  folder.getNewMessages(null, {</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    OnStopRunningUrl: function () { localserver.closeCachedConnections() }});</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  server.performTest();</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  var headerEnum = folder.getMessages(null);</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+  var headers = [];</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+  while (headerEnum.hasMoreElements())</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+    headers.push(headerEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+  try</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+  {</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+    do_check_eq(headers.length, 7);</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+    for each (var header in headers) {</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+      var id = header.messageId;</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+      dump(&quot;Testing message &quot;+id+&quot;\n&quot;);</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+      do_check_eq(header[attribResults[id][0]], attribResults[id][1]);</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+    }</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  } catch (e) {</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+    print(server.playTransaction().them);</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+    throw e;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+  } finally {</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+    server.stop();</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  }</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+  resetFolder(folder);</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+}</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+// These are the results for testing actual actions</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+var actionResults = {</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+  &quot;1@regular.invalid&quot; : [&quot;priority&quot;, 6],</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  // &quot;2@regular.invalid&quot; should not be in database</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  &quot;3@regular.invalid&quot; : function (header, folder) {</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+    var db = folder.getMsgDatabase(null);</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+    var flags = db.GetThreadContainingMsgHdr(header).flags;</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+    // This is checking the thread's kill flag</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+    return (flags &amp; 0x40000) == 0x40000;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+  },</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+  &quot;4@regular.invalid&quot; : function (header, folder) {</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+    var db = folder.getMsgDatabase(null);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+    var flags = db.GetThreadContainingMsgHdr(header).flags;</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+    // This is checking the thread's watch flag</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    return (flags &amp; 0x100) == 0x100;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+  },</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+  &quot;5@regular.invalid&quot; : [&quot;isFlagged&quot;, true],</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+  &quot;6.odd@regular.invalid&quot; : [&quot;isRead&quot;, false],</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+  &quot;7@regular.invalid&quot; : function (header, folder) {</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+    return header.getStringProperty(&quot;keywords&quot;) == &quot;tag&quot;;</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+  }</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+};</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+function testAction(handler, localserver) {</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+  var server = new nsMailServer(handler);</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+  // Get the folder and force filters to run</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+  var folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+  folder.getNewMessages(null, {</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+    OnStopRunningUrl: function () { localserver.closeCachedConnections() }});</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  server.performTest();</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+  var headerEnum = folder.getMessages(null);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+  var headers = [];</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+  while (headerEnum.hasMoreElements())</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+    headers.push(headerEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+  try</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+  {</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+    do_check_eq(headers.length, 6);</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+    for each (var header in headers) {</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+      var id = header.messageId;</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+      dump(&quot;Testing message &quot;+id+&quot;\n&quot;);</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+      if (actionResults[id] instanceof Array)</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+        do_check_eq(header[actionResults[id][0]], actionResults[id][1]);</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+      else</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+        do_check_true(actionResults[id](header, folder));</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+    }</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+  } catch (e) {</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineplus">+    print(server.playTransaction().them);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+    throw e;</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  } finally {</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+    server.stop();</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+  }</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+  resetFolder(folder);</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+}</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+// These are the various server handlers</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+var handlers = [NNTP_RFC977_handler, NNTP_Giganews_handler,</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+                NNTP_RFC2980_handler];</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+function run_test() {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  // Set up the server and add in filters</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+  var daemon = setupNNTPDaemon();</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+  var localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+  var serverFilters = localserver.getFilterList(null);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+  createFilter(serverFilters, &quot;subject&quot;, &quot;Odd&quot;, &quot;read&quot;);</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+  createFilter(serverFilters, &quot;from&quot;, &quot;Odd Person&quot;, &quot;read&quot;);</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+  // A PRTime is the time in s, but a JS date is time in ms.</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+  createFilter(serverFilters, &quot;date&quot;, new Date(2000, 0, 1)*1000, &quot;read&quot;);</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+  createFilter(serverFilters, &quot;size&quot;, 2, &quot;read&quot;);</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+  createFilter(serverFilters, &quot;message-id&quot;, &quot;odd&quot;, &quot;read&quot;);</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+  createFilter(serverFilters, &quot;user-agent&quot;, &quot;Odd/1.0&quot;, &quot;read&quot;);</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+  localserver.setFilterList(serverFilters);</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+  handlers.forEach( function (handler) {</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+    var handlerObj = new handler(daemon);</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+    testAttrib(handlerObj, localserver);</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+  });</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+  // Now we test folder-filters... and actions</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+  // Clear out the server filters</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+  while (serverFilters.filterCount &gt; 0)</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+    serverFilters.removeFilterAt(0);</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+  localserver.setFilterList(serverFilters);</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+  var folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+  var folderFilters = folder.getFilterList(null);</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+  createFilter(folderFilters, &quot;subject&quot;, &quot;First&quot;, &quot;priority&quot;);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+  createFilter(folderFilters, &quot;subject&quot;, &quot;Odd&quot;, &quot;delete&quot;);</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+  createFilter(folderFilters, &quot;from&quot;, &quot;Odd Person&quot;, &quot;kill&quot;);</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+  createFilter(folderFilters, &quot;date&quot;, new Date(2000, 0, 1)*1000, &quot;watch&quot;);</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+  createFilter(folderFilters, &quot;size&quot;, 2, &quot;flag&quot;);</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+  createFilter(folderFilters, &quot;message-id&quot;, &quot;odd&quot;, &quot;stop&quot;);</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+  // This shouldn't be hit, because of the previous filter</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+  createFilter(folderFilters, &quot;message-id&quot;, &quot;6.odd&quot;, &quot;read&quot;);</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+  createFilter(folderFilters, &quot;user-agent&quot;, &quot;Odd/1.0&quot;, &quot;tag&quot;);</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+  folderFilters.loggingEnabled = true;</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+  folder.setFilterList(folderFilters);</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+  handlers.forEach( function (handler) {</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    var handlerObj = new handler(daemon);</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+    testAction(handlerObj, localserver);</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+  });</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/news/test/unit/test_server.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_server.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l19.4"></a><span id="l19.4"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.5"></a><span id="l19.5"> // Protocol tests for NNTP. These actually aren't too important, but their main</span>
<a href="#l19.6"></a><span id="l19.6"> // purpose is to make sure that maild is working properly and to provide</span>
<a href="#l19.7"></a><span id="l19.7"> // examples for how using maild. They also help make sure that I coded nntpd.js</span>
<a href="#l19.8"></a><span id="l19.8"> // right, both logically and for RFC compliance.</span>
<a href="#l19.9"></a><span id="l19.9"> // TODO:</span>
<a href="#l19.10"></a><span id="l19.10"> // * We need to hook up mochitest,</span>
<a href="#l19.11"></a><span id="l19.11"> // * TLS negotiation.</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-// * Filter tests... very important (see UI requests)</span>
<a href="#l19.13"></a><span id="l19.13"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> // The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l19.16"></a><span id="l19.16"> var daemon = setupNNTPDaemon();</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> // Define these up here for checking with the transaction</span>
<a href="#l19.19"></a><span id="l19.19"> var type = null;</span>
<a href="#l19.20"></a><span id="l19.20"> var test = null;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -22,20 +21,16 @@ function do_check_transaction(real, expe</span>
<a href="#l19.22"></a><span id="l19.22">   // excise this from the list</span>
<a href="#l19.23"></a><span id="l19.23">   if (real.them[real.them.length-1] == &quot;QUIT&quot;)</span>
<a href="#l19.24"></a><span id="l19.24">     real.them.pop();</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">   do_check_eq(real.them.join(&quot;,&quot;), expected.join(&quot;,&quot;));</span>
<a href="#l19.27"></a><span id="l19.27">   dump(&quot;Passed test &quot; + test + &quot;\n&quot;);</span>
<a href="#l19.28"></a><span id="l19.28"> }</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-// Make sure we don't try to use a protected port. I like adding 1024 to the</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-// default port when doing so...</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-const NNTP_PORT = 1024+119;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-</span>
<a href="#l19.34"></a><span id="l19.34"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.35"></a><span id="l19.35"> //                             NNTP SERVER TESTS                              //</span>
<a href="#l19.36"></a><span id="l19.36"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.37"></a><span id="l19.37"> // Functions in order as defined in nntpd.js. Each function tests the URLs    //</span>
<a href="#l19.38"></a><span id="l19.38"> // that are located over the implementation of nsNNTPProtocol::LoadURL and    //</span>
<a href="#l19.39"></a><span id="l19.39"> // added in bug 400331. Furthermore, they are tested in rough order as they   //</span>
<a href="#l19.40"></a><span id="l19.40"> // would be expected to be used in a session. If more URL types are modified, //</span>
<a href="#l19.41"></a><span id="l19.41"> // please add a corresponding type to the following tests.                    //</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineat">@@ -71,18 +66,19 @@ function testRFC977() {</span>
<a href="#l19.43"></a><span id="l19.43">     do_check_transaction(transaction, []);*/</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">     // Test - newsrc</span>
<a href="#l19.46"></a><span id="l19.46">     test = &quot;news:&quot;;</span>
<a href="#l19.47"></a><span id="l19.47">     server.resetTest();</span>
<a href="#l19.48"></a><span id="l19.48">     setupProtocolTest(NNTP_PORT, prefix+&quot;&quot;);</span>
<a href="#l19.49"></a><span id="l19.49">     server.performTest();</span>
<a href="#l19.50"></a><span id="l19.50">     transaction = server.playTransaction();</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-    do_check_transaction(transaction, [&quot;MODE READER&quot;,</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-        &quot;GROUP test.subscribe.empty&quot;, &quot;GROUP test.subscribe.simple&quot;]);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    do_check_transaction(transaction, [&quot;MODE READER&quot;].concat(</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+          groups.filter(function (group) { return group[1]; })</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+                .map(function (group) { return &quot;GROUP &quot;+group[0]; })));</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57">     // Test - getting an article</span>
<a href="#l19.58"></a><span id="l19.58">     test = &quot;news:MESSAGE_ID&quot;;</span>
<a href="#l19.59"></a><span id="l19.59">     server.resetTest();</span>
<a href="#l19.60"></a><span id="l19.60">     setupProtocolTest(NNTP_PORT, prefix+&quot;TSS1@nntp.test&quot;);</span>
<a href="#l19.61"></a><span id="l19.61">     server.performTest();</span>
<a href="#l19.62"></a><span id="l19.62">     transaction = server.playTransaction();</span>
<a href="#l19.63"></a><span id="l19.63">     do_check_transaction(transaction, [&quot;MODE READER&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5,22 +5,34 @@ function nntpDaemon(flags) {</span>
<a href="#l20.4"></a><span id="l20.4">   this._messages = {};</span>
<a href="#l20.5"></a><span id="l20.5">   this._flags = flags;</span>
<a href="#l20.6"></a><span id="l20.6"> }</span>
<a href="#l20.7"></a><span id="l20.7"> nntpDaemon.prototype = {</span>
<a href="#l20.8"></a><span id="l20.8">   addGroup : function(group, postable) {</span>
<a href="#l20.9"></a><span id="l20.9">     var flags = 0;</span>
<a href="#l20.10"></a><span id="l20.10">     if (postable)</span>
<a href="#l20.11"></a><span id="l20.11">       flags |= NNTP_POSTABLE;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    this._groups[group] = { keys : [], flags : flags};</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    this._groups[group] = { keys : [], flags : flags, nextKey : 1};</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  },</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+  addArticle : function (article) {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+   this._messages[article.messageID] = article;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+   for each (var group in article.groups) {</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+     if (group in this._groups) {</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+       var key = this._groups[group].nextKey++;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+       this._groups[group][key] = article;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+       this._groups[group]['keys'].push(key);</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+     }</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+   }</span>
<a href="#l20.24"></a><span id="l20.24">   },</span>
<a href="#l20.25"></a><span id="l20.25">   addArticleToGroup : function(article, group, key) {</span>
<a href="#l20.26"></a><span id="l20.26">     this._groups[group][key] = article;</span>
<a href="#l20.27"></a><span id="l20.27">     this._messages[article.messageID] = article;</span>
<a href="#l20.28"></a><span id="l20.28">     this._groups[group]['keys'].push(key);</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+    if (this._groups[group].nextKey &lt;= key)</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+      this._groups[group].nextKey = key+1;</span>
<a href="#l20.31"></a><span id="l20.31">   },</span>
<a href="#l20.32"></a><span id="l20.32">   getGroup : function(group) {</span>
<a href="#l20.33"></a><span id="l20.33">     if (this._groups.hasOwnProperty(group))</span>
<a href="#l20.34"></a><span id="l20.34">       return this._groups[group];</span>
<a href="#l20.35"></a><span id="l20.35">     return null;</span>
<a href="#l20.36"></a><span id="l20.36">   },</span>
<a href="#l20.37"></a><span id="l20.37">   getGroupStats : function (group) {</span>
<a href="#l20.38"></a><span id="l20.38">     if (group['keys'].length == 0)</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineat">@@ -46,34 +58,53 @@ nntpDaemon.prototype = {</span>
<a href="#l20.40"></a><span id="l20.40">     return null;</span>
<a href="#l20.41"></a><span id="l20.41">   }</span>
<a href="#l20.42"></a><span id="l20.42"> }</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44"> function newsArticle(text) {</span>
<a href="#l20.45"></a><span id="l20.45">   this.headers = {};</span>
<a href="#l20.46"></a><span id="l20.46">   this.body = &quot;&quot;;</span>
<a href="#l20.47"></a><span id="l20.47">   this.messageID = &quot;&quot;;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+  this.fullText = text;</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50">   var lines = text.split(&quot;\n&quot;), passedHeaders = false;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+  var preamble = &quot;&quot;;</span>
<a href="#l20.52"></a><span id="l20.52">   for each(var line in lines) {</span>
<a href="#l20.53"></a><span id="l20.53">     if (!passedHeaders) {</span>
<a href="#l20.54"></a><span id="l20.54">       if (line.length == 0) {</span>
<a href="#l20.55"></a><span id="l20.55">         passedHeaders = true;</span>
<a href="#l20.56"></a><span id="l20.56">         continue;</span>
<a href="#l20.57"></a><span id="l20.57">       }</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-      var parts = text.split(&quot;:[ \t]*&quot;);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-      this.headers[parts[0]] = parts[1];</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+      preamble += line + '\n';</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+      var parts = line.split(/:[ \t]*/);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+      this.headers[parts[0].toLowerCase()] = parts[1];</span>
<a href="#l20.63"></a><span id="l20.63">       switch (parts[0].toLowerCase()) {</span>
<a href="#l20.64"></a><span id="l20.64">         case &quot;message-id&quot;:</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-          this.messageID = parts[1];</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+          var start = parts[1].indexOf('&lt;');</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+          var end = parts[1].indexOf('&gt;', start);</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+          this.messageID = parts[1].substring(start, end+1);</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+          break;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        case &quot;newsgroups&quot;:</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+          this.groups = parts[1].split(/[ \t]*,[ \t]*/);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+          break;</span>
<a href="#l20.73"></a><span id="l20.73">       }</span>
<a href="#l20.74"></a><span id="l20.74">     } else {</span>
<a href="#l20.75"></a><span id="l20.75">       this.body += line + &quot;\n&quot;;</span>
<a href="#l20.76"></a><span id="l20.76">     }</span>
<a href="#l20.77"></a><span id="l20.77">   }</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+  // Add in non-existent fields</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+  if (!(&quot;lines&quot; in this.headers))</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+  {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    let lines = this.body.split('\n').length;</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+    this.headers[&quot;lines&quot;] = lines;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+    preamble += &quot;Lines: &quot;+lines;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  }</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  this.fulltext = preamble + '\n' + this.body;</span>
<a href="#l20.88"></a><span id="l20.88"> }</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90"> // NNTP FLAGS</span>
<a href="#l20.91"></a><span id="l20.91"> const NNTP_POSTABLE = 0x0001;</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93"> const NNTP_REAL_LENGTH = 0x0100;</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95"> function hasFlag(flags, flag) {</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineat">@@ -85,141 +116,77 @@ function hasFlag(flags, flag) {</span>
<a href="#l20.97"></a><span id="l20.97"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.98"></a><span id="l20.98"> // To be comprehensive about testing and fallback, we define these varying    //</span>
<a href="#l20.99"></a><span id="l20.99"> // levels of RFC-compliance:                                                  //</span>
<a href="#l20.100"></a><span id="l20.100"> // * RFC 977 solely (there's not a lot there!)                                //</span>
<a href="#l20.101"></a><span id="l20.101"> // * RFC 977 + 2980 (note that there are varying levels of this impl)         //</span>
<a href="#l20.102"></a><span id="l20.102"> // * RFC 3977 bare bones                                                      //</span>
<a href="#l20.103"></a><span id="l20.103"> // * RFC 3977 full                                                            //</span>
<a href="#l20.104"></a><span id="l20.104"> // * RFC 3977 + post-3977 extensions                                          //</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-// * INN 2.4 (Gold standard common implementation; highest importance)        //</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-// * Giganews (Common newsserver for ISP stuff; second highest importance)    //</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+// * Giganews (Common newsserver for ISP stuff; highest importance)           //</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+// * INN 2.4 (Gold standard common implementation; second highest importance) //</span>
<a href="#l20.109"></a><span id="l20.109"> // Note too that we want various levels of brokenness:                        //</span>
<a href="#l20.110"></a><span id="l20.110"> // * Perm errors that require login                                           //</span>
<a href="#l20.111"></a><span id="l20.111"> // * &quot;I can't handle that&quot; (e.g., news.mozilla.org only supports XOVER for    //</span>
<a href="#l20.112"></a><span id="l20.112"> //   searching with XHDR)                                                     //</span>
<a href="#l20.113"></a><span id="l20.113"> // * Naive group counts, missing articles                                     //</span>
<a href="#l20.114"></a><span id="l20.114"> // * Limitations on what can be posted                                        //</span>
<a href="#l20.115"></a><span id="l20.115"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.116"></a><span id="l20.116"> </span>
<a href="#l20.117"></a><span id="l20.117"> </span>
<a href="#l20.118"></a><span id="l20.118"> // This handler implements the bare minimum required by RFC 977. Actually, not</span>
<a href="#l20.119"></a><span id="l20.119"> // even that much: IHAVE and SLAVE are not implemented, as those two are</span>
<a href="#l20.120"></a><span id="l20.120"> // explicitly server implementations.</span>
<a href="#l20.121"></a><span id="l20.121"> function NNTP_RFC977_handler(daemon) {</span>
<a href="#l20.122"></a><span id="l20.122">   this._daemon = daemon;</span>
<a href="#l20.123"></a><span id="l20.123">   this.closing = false;</span>
<a href="#l20.124"></a><span id="l20.124">   this.group = null;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  this.article = null;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  this.articleKey = null;</span>
<a href="#l20.127"></a><span id="l20.127"> }</span>
<a href="#l20.128"></a><span id="l20.128"> NNTP_RFC977_handler.prototype = {</span>
<a href="#l20.129"></a><span id="l20.129">   ARTICLE : function (args) {</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-     var art;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-     if (args == &quot;&quot;) {</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-       if (this.article == null)</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-         return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-       art = this.article;</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-     } else if (args.charAt(0) == '&lt;') {</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-       art = this._daemon.getArticle(args);</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-       if (art == null)</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-         return &quot;430 no such article found&quot;;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-     } else {</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-       if (this.group == null)</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-         return &quot;412 no newsgroup has been selected&quot;;</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+     var info = this._selectArticle(args, 220);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+     if (info[0] == null)</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+       return info[1];</span>
<a href="#l20.146"></a><span id="l20.146"> </span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-       var index = Integer.parseInt(args);</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-       if (index in this.group.keys) {</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-         this.article = this.group.keys[index];</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-         art = this.article;</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-       } else {</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-         return &quot;423 no such article number in this group&quot;;</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-       }</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-     }</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-     var response = &quot;220 &quot; + art.key + &quot; &quot; + art.messageID +</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-                    &quot; article retrieved - head and body follows.\n&quot;;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-     for (var header in art.headers) {</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-       response += header + &quot;: &quot; + art.headers[header] + &quot;\n&quot;;</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-     }</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-     response += art.body.replace(&quot;(?=\n).&quot;, &quot;..&quot;);</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+     var response = info[1]+'\n';</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+     response += info[0].fullText.replace(&quot;(?=\n).&quot;, &quot;..&quot;);</span>
<a href="#l20.164"></a><span id="l20.164">      response += &quot;.&quot;;</span>
<a href="#l20.165"></a><span id="l20.165">      return response;</span>
<a href="#l20.166"></a><span id="l20.166">   },</span>
<a href="#l20.167"></a><span id="l20.167">   BODY : function (args) {</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-     var art;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-     if (args == &quot;&quot;) {</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-       if (this.article == null)</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-         return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-       art = this.article;</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-     } else if (args.charAt(0) == '&lt;') {</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-       art = this._daemon.getArticle(args);</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-       if (article == null)</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-         return &quot;430 no such article found&quot;;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-     } else {</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-       if (this.group == null)</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-         return &quot;412 no newsgroup has been selected&quot;;</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+     var info = this._selectArticle(args, 222);</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+     if (info[0] == null)</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+       return info[1];</span>
<a href="#l20.184"></a><span id="l20.184"> </span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-       var index = Integer.parseInt(args);</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-       if (index in this.group.keys) {</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-         this.article = this.group.keys[index];</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-         art = this.article;</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-       } else {</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-         return &quot;423 no such article number in this group&quot;;</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-       }</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-     }</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-     var response = &quot;222 &quot;+art.key+&quot; &quot;+art.messageID+</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-                    &quot; article retrieved - body follows.\n&quot;;</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-     response += &quot;\n&quot;;</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-     response += art.body.replace(&quot;(?=\n).&quot;,&quot;..&quot;);</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+     var response = info[1]+'\n';</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+     response += info[0].body.replace(&quot;(?=\n).&quot;,&quot;..&quot;);</span>
<a href="#l20.200"></a><span id="l20.200">      response += &quot;.&quot;;</span>
<a href="#l20.201"></a><span id="l20.201">      return response;</span>
<a href="#l20.202"></a><span id="l20.202">   },</span>
<a href="#l20.203"></a><span id="l20.203">   GROUP : function(args) {</span>
<a href="#l20.204"></a><span id="l20.204">     var group = this._daemon.getGroup(args);</span>
<a href="#l20.205"></a><span id="l20.205">     if (group == null)</span>
<a href="#l20.206"></a><span id="l20.206">       return &quot;411 no such news group&quot;;</span>
<a href="#l20.207"></a><span id="l20.207"> </span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-    this.article = null;</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+    this.group = group;</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+    this.articleKey = 0 in this.group.keys ? this.group.keys[0] : null;</span>
<a href="#l20.211"></a><span id="l20.211"> </span>
<a href="#l20.212"></a><span id="l20.212">     var stats = this._daemon.getGroupStats(group);</span>
<a href="#l20.213"></a><span id="l20.213">     return &quot;211 &quot; + stats[0] + &quot; &quot; + stats[1] + &quot; &quot; + stats[2] + &quot; &quot; + args +</span>
<a href="#l20.214"></a><span id="l20.214">            &quot; group selected&quot;;</span>
<a href="#l20.215"></a><span id="l20.215">   },</span>
<a href="#l20.216"></a><span id="l20.216">   HEAD : function (args) {</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-     var art;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-     if (args == &quot;&quot;) {</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-       if (this.article == null)</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineminus">-         return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-       art = this.article;</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-     } else if (args.charAt(0) == '&lt;') {</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-       art = this._daemon.getArticle(args);</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-       if (art == null)</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-         return &quot;430 no such article found&quot;;</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-     } else {</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-       if (this.group == null)</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-         return &quot;412 no newsgroup has been selected&quot;;</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+     var info = this._selectArticle(args, 221);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+     if (info[0] == null)</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+       return info[1];</span>
<a href="#l20.233"></a><span id="l20.233"> </span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-       var index = Integer.parseInt(args);</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-       if (index in this.group.keys) {</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-         this.article = this.group.keys[index];</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-         art = this.article;</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-       } else {</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-         return &quot;423 no such article number in this group&quot;;</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-       }</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-     }</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-     var response = &quot;221 &quot; + art.key + &quot; &quot; + art.messageID +</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-                    &quot; article retrieved - head follows.\n&quot;;</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-     for (var header in art.headers) {</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-       response += header + &quot;: &quot; + article.headers[header] + &quot;\n&quot;;</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-     }</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+     var response = info[1]+'\n';</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+     for (var header in info[0].headers)</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+       response += header + &quot;: &quot; + info[0].headers[header] + &quot;\n&quot;;</span>
<a href="#l20.251"></a><span id="l20.251">      response += &quot;.&quot;;</span>
<a href="#l20.252"></a><span id="l20.252">      return response;</span>
<a href="#l20.253"></a><span id="l20.253">   },</span>
<a href="#l20.254"></a><span id="l20.254">   HELP : function (args) {</span>
<a href="#l20.255"></a><span id="l20.255">     var response = &quot;100 Why certainly, here is my help:\n&quot;;</span>
<a href="#l20.256"></a><span id="l20.256">     response += &quot;Mozilla fake NNTP RFC 977 testing server&quot;;</span>
<a href="#l20.257"></a><span id="l20.257">     response += &quot;Commands supported:\n&quot;;</span>
<a href="#l20.258"></a><span id="l20.258">     response += &quot;\tARTICLE &lt;message-id&gt; | [nnn]\n&quot;;</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineat">@@ -234,19 +201,19 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l20.260"></a><span id="l20.260">     response += &quot;\tNEXT\n&quot;;</span>
<a href="#l20.261"></a><span id="l20.261">     response += &quot;\tPOST\n&quot;;</span>
<a href="#l20.262"></a><span id="l20.262">     response += &quot;\tQUIT\n&quot;;</span>
<a href="#l20.263"></a><span id="l20.263">     response += &quot;\tSTAT\n&quot;;</span>
<a href="#l20.264"></a><span id="l20.264">     response += &quot;.&quot;;</span>
<a href="#l20.265"></a><span id="l20.265">     return response;</span>
<a href="#l20.266"></a><span id="l20.266">   },</span>
<a href="#l20.267"></a><span id="l20.267">   LAST : function (args) {</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-    if (group == null)</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+    if (this.group == null)</span>
<a href="#l20.270"></a><span id="l20.270">       return &quot;412 no newsgroup selected&quot;;</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-    if (article == null)</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+    if (this.articleKey == null)</span>
<a href="#l20.273"></a><span id="l20.273">       return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.274"></a><span id="l20.274">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.275"></a><span id="l20.275">   },</span>
<a href="#l20.276"></a><span id="l20.276">   LIST : function (args) {</span>
<a href="#l20.277"></a><span id="l20.277">     var response = &quot;215 list of newsgroup follows\n&quot;;</span>
<a href="#l20.278"></a><span id="l20.278">     for (group in this._daemon._groups) {</span>
<a href="#l20.279"></a><span id="l20.279">       var stats = this._daemon.getGroupStats(this._daemon._groups[group]);</span>
<a href="#l20.280"></a><span id="l20.280">       response += group + &quot; &quot; + stats[1] + &quot; &quot; + stats[0] + &quot; &quot; +</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineat">@@ -257,67 +224,44 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l20.282"></a><span id="l20.282">   },</span>
<a href="#l20.283"></a><span id="l20.283">   NEWGROUPS : function (args) {</span>
<a href="#l20.284"></a><span id="l20.284">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.285"></a><span id="l20.285">   },</span>
<a href="#l20.286"></a><span id="l20.286">   NEWNEWS : function (args) {</span>
<a href="#l20.287"></a><span id="l20.287">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.288"></a><span id="l20.288">   },</span>
<a href="#l20.289"></a><span id="l20.289">   NEXT : function (args) {</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-    if (group == null)</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineplus">+    if (this.group == null)</span>
<a href="#l20.292"></a><span id="l20.292">       return &quot;412 no newsgroup selected&quot;;</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-    if (article == null)</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+    if (this.articleKey == null)</span>
<a href="#l20.295"></a><span id="l20.295">       return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.296"></a><span id="l20.296">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.297"></a><span id="l20.297">   },</span>
<a href="#l20.298"></a><span id="l20.298">   POST : function(args) {</span>
<a href="#l20.299"></a><span id="l20.299">     this.posting = true;</span>
<a href="#l20.300"></a><span id="l20.300">     this.post = &quot;&quot;;</span>
<a href="#l20.301"></a><span id="l20.301">     return &quot;340 Please continue&quot;;</span>
<a href="#l20.302"></a><span id="l20.302">   },</span>
<a href="#l20.303"></a><span id="l20.303">   QUIT : function(args) {</span>
<a href="#l20.304"></a><span id="l20.304">     this.closing = true;</span>
<a href="#l20.305"></a><span id="l20.305">     return &quot;205 closing connection - goodbye!&quot;;</span>
<a href="#l20.306"></a><span id="l20.306">   },</span>
<a href="#l20.307"></a><span id="l20.307">   STAT : function (args) {</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-     var art;</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-     if (args == &quot;&quot;) {</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-       if (this.article == null)</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-         return &quot;420 no current article has been selected&quot;;</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-       art = this.article;</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-     } else if (args.charAt(0) == '&lt;') {</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-       art = this._daemon.getArticle(args);</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-       if (article == null)</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-         return &quot;430 no such article found&quot;;</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-     } else {</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-       if (this.group == null)</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-         return &quot;412 no newsgroup has been selected&quot;;</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineminus">-</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-       var index = Integer.parseInt(args);</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-       if (index in this.group.keys) {</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-         this.article = this.group.keys[index];</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-         art = this.article;</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-       } else {</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-         return &quot;423 no such article number in this group&quot;;</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineminus">-       }</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-     }</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-     return &quot;223 &quot; + art.key + &quot; &quot; + art.messageID +</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-            &quot; article retrieved - request text separately.&quot;;</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+     var info = this._selectArticle(args, 223);</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+     return info[1];</span>
<a href="#l20.335"></a><span id="l20.335">   },</span>
<a href="#l20.336"></a><span id="l20.336">   LISTGROUP : function (args) {</span>
<a href="#l20.337"></a><span id="l20.337">     // Yes, I know this isn't RFC 977, but I doubt that mailnews will ever drop</span>
<a href="#l20.338"></a><span id="l20.338">     // its requirement for this, so I'll stuff it in here anyways...</span>
<a href="#l20.339"></a><span id="l20.339">     var group = (args == &quot;&quot; ? this.group : this._daemon.getGroup(args));</span>
<a href="#l20.340"></a><span id="l20.340">     if (group == null)</span>
<a href="#l20.341"></a><span id="l20.341">       return &quot;411 This newsgroup does not exist&quot;;</span>
<a href="#l20.342"></a><span id="l20.342"> </span>
<a href="#l20.343"></a><span id="l20.343">     var response = &quot;211 Articles follow:\n&quot;;</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-    for (var key in group['keys'])</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineplus">+    for each (var key in group['keys'])</span>
<a href="#l20.346"></a><span id="l20.346">       response += key + &quot;\n&quot;;</span>
<a href="#l20.347"></a><span id="l20.347">     response += &quot;.\n&quot;;</span>
<a href="#l20.348"></a><span id="l20.348">     return response;</span>
<a href="#l20.349"></a><span id="l20.349">   },</span>
<a href="#l20.350"></a><span id="l20.350"> </span>
<a href="#l20.351"></a><span id="l20.351"> </span>
<a href="#l20.352"></a><span id="l20.352">   onError : function (command, args) {</span>
<a href="#l20.353"></a><span id="l20.353">     return &quot;500 command not recognized&quot;;</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineat">@@ -328,16 +272,17 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l20.355"></a><span id="l20.355">     this.article = null;</span>
<a href="#l20.356"></a><span id="l20.356">     this.posting = false;</span>
<a href="#l20.357"></a><span id="l20.357">     return &quot;200 posting allowed&quot;;</span>
<a href="#l20.358"></a><span id="l20.358">   },</span>
<a href="#l20.359"></a><span id="l20.359">   onMultiline : function (line) {</span>
<a href="#l20.360"></a><span id="l20.360">     if (line == &quot;.&quot;) {</span>
<a href="#l20.361"></a><span id="l20.361">       if (this.posting) {</span>
<a href="#l20.362"></a><span id="l20.362">         var article = new newsArticle(this.post);</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+        this._daemon.addArticle(article);</span>
<a href="#l20.364"></a><span id="l20.364">         this.posting = false;</span>
<a href="#l20.365"></a><span id="l20.365">         return &quot;240 Wonderful article, your style is gorgeous!&quot;;</span>
<a href="#l20.366"></a><span id="l20.366">       }</span>
<a href="#l20.367"></a><span id="l20.367">     }</span>
<a href="#l20.368"></a><span id="l20.368"> </span>
<a href="#l20.369"></a><span id="l20.369">     if (this.posting) {</span>
<a href="#l20.370"></a><span id="l20.370">       if (line[0] == '.')</span>
<a href="#l20.371"></a><span id="l20.371">         line = line.substring(1);</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineat">@@ -346,10 +291,156 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l20.373"></a><span id="l20.373">     }</span>
<a href="#l20.374"></a><span id="l20.374"> </span>
<a href="#l20.375"></a><span id="l20.375">     return undefined;</span>
<a href="#l20.376"></a><span id="l20.376">   },</span>
<a href="#l20.377"></a><span id="l20.377">   postCommand : function (obj) {</span>
<a href="#l20.378"></a><span id="l20.378">     if (this.closing)</span>
<a href="#l20.379"></a><span id="l20.379">       obj.closeSocket();</span>
<a href="#l20.380"></a><span id="l20.380">     obj.setMultiline(this.posting);</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+  },</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+  /**</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+   * Selects an article based on args.</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+   *</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+   * Returns an array of objects consisting of:</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+   * # The selected article (or null if non was selected</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+   * # The first line response</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineplus">+   */</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineplus">+  _selectArticle : function (args, responseCode) {</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+    var art, key;</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineplus">+    if (args == &quot;&quot;) {</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+      if (this.group == null)</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+        return [null, &quot;412 no newsgroup has been selected&quot;];</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+      if (this.articleKey == null)</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+        return [null, &quot;420 no current article has been selected&quot;];</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+      art = this.group[this.articleKey];</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+      key = this.articleKey;</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+    } else if (args.charAt(0) == '&lt;') {</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+      art = this._daemon.getArticle(args);</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+      key = 0;</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineplus">+</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineplus">+      if (art == null)</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineplus">+        return [null, &quot;430 no such article found&quot;];</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+    } else {</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineplus">+      if (this.group == null)</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+        return [null, &quot;412 no newsgroup has been selected&quot;];</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineplus">+      key = parseInt(args);</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineplus">+      if (key in this.group) {</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineplus">+        this.articleKey = key;</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineplus">+        art = this.group[key];</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineplus">+      } else {</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineplus">+        return [null, &quot;423 no such article number in this group&quot;];</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineplus">+      }</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineplus">+    }</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineplus">+</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineplus">+    var respCode = responseCode + &quot; &quot; + key + &quot; &quot; + art.messageID +</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineplus">+      &quot; article selected&quot;;</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineplus">+    return [art, respCode];</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineplus">+  }</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineplus">+}</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineplus">+</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineplus">+/**</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineplus">+ * Utility method to define a subclass</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+ *</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineplus">+ * @param sub   The function object of the subclass</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineplus">+ * @param super The function object of the superclass</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineplus">+ * @param def   The object definition of the subclass prototype.</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineplus">+ */</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineplus">+function subclass(sub, sup, def) {</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineplus">+  sub.prototype = new sup();</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineplus">+  for (var obj in def) {</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineplus">+    sub.prototype[obj] = def[obj];</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineplus">+  }</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineplus">+}</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineplus">+function subconstructor(sub, sup) {</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineplus">+  sup.apply(sub, Array.prototype.slice.call(arguments, 2));</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineplus">+  sub.parent = new Object();</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+  sub.parent.__noSuchMethod__ = function (name, args) {</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineplus">+    return sup.prototype[name].apply(sub, args);</span>
<a href="#l20.443"></a><span id="l20.443">   }</span>
<a href="#l20.444"></a><span id="l20.444"> }</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+function NNTP_RFC2980_handler(daemon) {</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineplus">+  subconstructor(this, NNTP_RFC977_handler, daemon);</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineplus">+}</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineplus">+subclass(NNTP_RFC2980_handler, NNTP_RFC977_handler, {</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineplus">+//NNTP_RFC2980_handler.prototype = new NNTP_RFC977_handler();</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineplus">+//var subprototype = {</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineplus">+  DATE : function (args) {</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineplus">+    return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineplus">+  },</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineplus">+  LIST : function (args) {</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineplus">+    var index = args.indexOf(&quot; &quot;);</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineplus">+    var command = index == -1 ? args : args.substring(0,index);</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+    args = index == -1 ? &quot;&quot; : args.substring(index+1);</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineplus">+    command = command.toUpperCase();</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineplus">+    if (&quot;LIST_&quot;+command in this)</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineplus">+      return this[&quot;LIST_&quot;+command](args);</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+    return this.parent.LIST(command+&quot; &quot;+args);</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineplus">+  },</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineplus">+  LIST_ACTIVE : function (args) {</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineplus">+    return this.parent.LIST(args);</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineplus">+  },</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineplus">+  MODE : function (args) {</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+    if (args == &quot;READER&quot;)</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineplus">+      return this.onStartup();</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineplus">+    return &quot;500 What do you think you're trying to pull here?&quot;;</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineplus">+  },</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineplus">+  XHDR : function (args) {</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineplus">+    if (!this.group)</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineplus">+      return &quot;412 No group selected&quot;;</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineplus">+</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+    args = args.split(&quot; &quot;);</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+    var header = args[0].toLowerCase();</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+    var found = false;</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineplus">+    var response = &quot;221 Headers abound\n&quot;;</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineplus">+    for each (var key in this.group.keys) {</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineplus">+      if (!(header in this.group[key].headers))</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineplus">+        continue;</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineplus">+      found = true;</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineplus">+      response += key + &quot; &quot; +this.group[key].headers[header] + '\n';</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineplus">+    }</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineplus">+    if (!found)</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineplus">+      return &quot;420 No such article&quot;;</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineplus">+    response += '.';</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineplus">+    return response;</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineplus">+  },</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+  XOVER : function (args) {</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineplus">+    if (!this.group)</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineplus">+      return &quot;412 No group selected&quot;;</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+    </span>
<a href="#l20.494"></a><span id="l20.494" class="difflineplus">+    var response = &quot;224 List of articles\n&quot;;</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineplus">+    for each (var key in this.group.keys) {</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineplus">+      response += key + &quot;\t&quot;;</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineplus">+      var article = this.group[key];</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineplus">+      response += article.headers[&quot;subject&quot;] + &quot;\t&quot; +</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineplus">+                  article.headers[&quot;from&quot;] + &quot;\t&quot; +</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineplus">+                  article.headers[&quot;date&quot;] + &quot;\t&quot; +</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineplus">+                  article.headers[&quot;message-id&quot;] + &quot;\t&quot; +</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineplus">+                  (article.headers[&quot;references&quot;] ? article.headers[&quot;references&quot;]</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineplus">+                                                : &quot;&quot;) + &quot;\t&quot; +</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineplus">+                  article.fullText.replace(/\r?\n/,'\r\n').length + &quot;\t&quot; +</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineplus">+                  article.body.split(/\r?\n/).length + &quot;\t&quot; +</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineplus">+                  article.headers[&quot;xref&quot;] + &quot;\n&quot;;</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineplus">+    }</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineplus">+    response += '.\n';</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineplus">+    return response;</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineplus">+  },</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineplus">+  XPAT : function (args) {</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineplus">+    return &quot;502 Command not implemented&quot;;</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineplus">+  }</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineplus">+});</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineplus">+function NNTP_Giganews_handler(daemon) {</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineplus">+  subconstructor(this, NNTP_RFC2980_handler, daemon);</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineplus">+}</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineplus">+subclass(NNTP_Giganews_handler, NNTP_RFC2980_handler, {</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineplus">+  XHDR : function (args) {</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineplus">+    var header = args.split(&quot; &quot;)[0].toLowerCase();</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineplus">+    if (header in [&quot;subject&quot;, &quot;from&quot;, &quot;xref&quot;, &quot;date&quot;, &quot;message-id&quot;,</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineplus">+                   &quot;references&quot;]) {</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineplus">+      return this.parent.XHDR(args);</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineplus">+    }</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineplus">+    return &quot;503 unsupported header field&quot;;</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineplus">+  }</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/news.properties</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/news.properties</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -48,16 +48,17 @@ cancelConfirm=Are you sure you want to c</span>
<a href="#l21.4"></a><span id="l21.4"> messageCancelled=Message cancelled.</span>
<a href="#l21.5"></a><span id="l21.5"> enterUsername=Please enter a username for news server access:</span>
<a href="#l21.6"></a><span id="l21.6"> enterPassword=Please enter a password for news server access:</span>
<a href="#l21.7"></a><span id="l21.7"> enterPasswordTitle=News Server Password Required</span>
<a href="#l21.8"></a><span id="l21.8"> okButtonText=Download</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> noNewMessages=There are no new messages on the server.</span>
<a href="#l21.11"></a><span id="l21.11"> downloadingHeaders=Downloading %S of %S headers</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+downloadingFilterHeaders=Getting headers for filters: %S (%S/%S)</span>
<a href="#l21.13"></a><span id="l21.13"> downloadingArticles=Downloading articles %S-%S</span>
<a href="#l21.14"></a><span id="l21.14"> bytesReceived=Downloading newsgroups: %S received (%SKB read at %SKB/sec)</span>
<a href="#l21.15"></a><span id="l21.15"> checkingForNewNews=Checking newsgroup %S of %S on %S for new messages</span>
<a href="#l21.16"></a><span id="l21.16"> downloadingArticlesForOffline=Downloading articles %S-%S in %S</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> onlyCancelOneMessage=You can only cancel one article at a time.</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> # LOCALIZATION NOTE (autoUnsubscribeText): %1$S is the newsgroup and %2$S is the newsgroup-server it is being removed from.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

