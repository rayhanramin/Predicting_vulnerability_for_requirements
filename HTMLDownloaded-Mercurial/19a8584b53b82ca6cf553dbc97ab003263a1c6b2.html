<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18265:19a8584b53b82ca6cf553dbc97ab003263a1c6b2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 19a8584b53b82ca6cf553dbc97ab003263a1c6b2" />
<meta property="og:url" content="/comm-central/rev/19a8584b53b82ca6cf553dbc97ab003263a1c6b2" />
<meta property="og:description" content="Bug 1151473 - Part 2: Remove use of expression closure in chat/protocols/. r=clokep" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 19a8584b53b82ca6cf553dbc97ab003263a1c6b2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">shortlog</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">files</a> |
changeset |
<a href="/comm-central/raw-rev/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">raw</a>  | <a href="/comm-central/archive/19a8584b53b82ca6cf553dbc97ab003263a1c6b2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">Bug 1151473</a> - Part 2: Remove use of expression closure in chat/protocols/. r=clokep
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#111;&#111;&#114;&#117;&#32;&#70;&#117;&#106;&#105;&#115;&#97;&#119;&#97;&#32;&#60;&#97;&#114;&#97;&#105;&#95;&#97;&#64;&#109;&#97;&#99;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Aug 2015 05:43:41 +0900</td></tr>

<tr>
 <td>changeset 18265</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">19a8584b53b82ca6cf553dbc97ab003263a1c6b2</a></td>
</tr>



<tr>
<td>parent 18264</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">a66c8906fb9c5f4b38b438ed55f10a806c1a19ff</a>
</td>
</tr>

<tr>
<td>child 18266</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ca055511690886e866c4e95150607d4aa1cb4cde">ca055511690886e866c4e95150607d4aa1cb4cde</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=19a8584b53b82ca6cf553dbc97ab003263a1c6b2">11213</a></td></tr>
<tr><td>push user</td><td>arai_a@mac.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 13 Aug 2015 20:46:27 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@19a8584b53b8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">1151473</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">Bug 1151473</a> - Part 2: Remove use of expression closure in chat/protocols/. r=clokep</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">chat/protocols/irc/ircBase.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircBase.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">chat/protocols/irc/ircCAP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCAP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">chat/protocols/irc/ircCommands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">chat/protocols/irc/ircDCC.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircDCC.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">chat/protocols/irc/ircHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">chat/protocols/irc/ircMultiPrefix.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircMultiPrefix.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">chat/protocols/irc/ircNonStandard.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircNonStandard.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">chat/protocols/irc/ircSASL.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircSASL.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">chat/protocols/irc/ircServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">chat/protocols/irc/ircUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">chat/protocols/irc/ircWatchMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/ircWatchMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">chat/protocols/irc/test/test_ctcpDequote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpDequote.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">chat/protocols/irc/test/test_ctcpQuote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ctcpQuote.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">chat/protocols/irc/test/test_ircMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_ircMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">chat/protocols/irc/test/test_tryNewNick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/irc/test/test_tryNewNick.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">chat/protocols/odnoklassniki/odnoklassniki.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/odnoklassniki/odnoklassniki.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">chat/protocols/skype/skype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/skype/skype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">chat/protocols/xmpp/xmpp-commands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-commands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">chat/protocols/yahoo/test/test_yahooAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/test/test_yahooAccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">chat/protocols/yahoo/yahoo-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/19a8584b53b82ca6cf553dbc97ab003263a1c6b2/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/protocols/facebook/facebook.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/protocols/facebook/facebook.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,26 +4,26 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l1.14"></a><span id="l1.14">   l10nHelper(&quot;chrome://chat/locale/facebook.properties&quot;)</span>
<a href="#l1.15"></a><span id="l1.15"> );</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l1.18"></a><span id="l1.18">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l1.19"></a><span id="l1.19"> }</span>
<a href="#l1.20"></a><span id="l1.20"> FacebookAccount.prototype = {</span>
<a href="#l1.21"></a><span id="l1.21">   __proto__: XMPPAccountPrototype,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-  get canJoinChat() false,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  get canJoinChat() { return false; },</span>
<a href="#l1.24"></a><span id="l1.24">   connect: function() {</span>
<a href="#l1.25"></a><span id="l1.25">     if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l1.26"></a><span id="l1.26">       let jid = this.name + &quot;@chat.facebook.com/&quot; + XMPPDefaultResource;</span>
<a href="#l1.27"></a><span id="l1.27">       this._jid = this._parseJID(jid);</span>
<a href="#l1.28"></a><span id="l1.28">     }</span>
<a href="#l1.29"></a><span id="l1.29">     else {</span>
<a href="#l1.30"></a><span id="l1.30">       this._jid = this._parseJID(this.name);</span>
<a href="#l1.31"></a><span id="l1.31">       if (this._jid.domain != &quot;chat.facebook.com&quot;) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineat">@@ -43,16 +43,16 @@ FacebookAccount.prototype = {</span>
<a href="#l1.33"></a><span id="l1.33">                                        this);</span>
<a href="#l1.34"></a><span id="l1.34">   }</span>
<a href="#l1.35"></a><span id="l1.35"> };</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37"> function FacebookProtocol() {</span>
<a href="#l1.38"></a><span id="l1.38"> }</span>
<a href="#l1.39"></a><span id="l1.39"> FacebookProtocol.prototype = {</span>
<a href="#l1.40"></a><span id="l1.40">   __proto__: GenericProtocolPrototype,</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  get normalizedName() &quot;facebook&quot;,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  get name() _(&quot;facebook.chat.name&quot;),</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-facebook/skin/&quot;,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  getAccount: function(aImAccount) new FacebookAccount(this, aImAccount),</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  get normalizedName() { return &quot;facebook&quot;; },</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  get name() { return _(&quot;facebook.chat.name&quot;); },</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-facebook/skin/&quot;; },</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  getAccount: function(aImAccount) { return new FacebookAccount(this, aImAccount); },</span>
<a href="#l1.49"></a><span id="l1.49">   classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;)</span>
<a href="#l1.50"></a><span id="l1.50"> };</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/gtalk/gtalk.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> const Cu = Components.utils;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l2.14"></a><span id="l2.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l2.15"></a><span id="l2.15"> );</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> // PlainFullBindAuth is an authentication mechanism that works like</span>
<a href="#l2.18"></a><span id="l2.18"> // the standard PLAIN mechanism but adds a client-uses-full-bind-result</span>
<a href="#l2.19"></a><span id="l2.19"> // attribute to the auth stanza to tell the Google Talk servers that we</span>
<a href="#l2.20"></a><span id="l2.20"> // support their JID Domain Discovery extension.</span>
<a href="#l2.21"></a><span id="l2.21"> // See https://developers.google.com/talk/jep_extensions/jid_domain_change</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -84,22 +84,22 @@ GTalkAccount.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23"> };</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> function GTalkProtocol() {</span>
<a href="#l2.26"></a><span id="l2.26">   Cu.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l2.27"></a><span id="l2.27">   this.registerCommands();</span>
<a href="#l2.28"></a><span id="l2.28"> }</span>
<a href="#l2.29"></a><span id="l2.29"> GTalkProtocol.prototype = {</span>
<a href="#l2.30"></a><span id="l2.30">   __proto__: GenericProtocolPrototype,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  get normalizedName() &quot;gtalk&quot;,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  get name() _(&quot;gtalk.protocolName&quot;),</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-gtalk/skin/&quot;,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  get usernameEmptyText() _(&quot;gtalk.usernameHint&quot;),</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  getAccount: function(aImAccount) new GTalkAccount(this, aImAccount),</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  get normalizedName() { return &quot;gtalk&quot;; },</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  get name() { return _(&quot;gtalk.protocolName&quot;); },</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-gtalk/skin/&quot;; },</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  get usernameEmptyText() { return _(&quot;gtalk.usernameHint&quot;); },</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  getAccount: function(aImAccount) { return new GTalkAccount(this, aImAccount); },</span>
<a href="#l2.41"></a><span id="l2.41">   options: {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    resource: {get label() _(&quot;options.resource&quot;),</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-               get default() XMPPDefaultResource}</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    resource: {get label() { return _(&quot;options.resource&quot;); },</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+               get default() { return XMPPDefaultResource; }}</span>
<a href="#l2.46"></a><span id="l2.46">   },</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  get chatHasTopic() true,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  get chatHasTopic() { return true; },</span>
<a href="#l2.49"></a><span id="l2.49">   classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;)</span>
<a href="#l2.50"></a><span id="l2.50"> };</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -156,17 +156,17 @@ function _setMode(aAddNewMode, aNewModes</span>
<a href="#l3.4"></a><span id="l3.4"> // Properties / methods shared by both ircChannel and ircConversation.</span>
<a href="#l3.5"></a><span id="l3.5"> const GenericIRCConversation = {</span>
<a href="#l3.6"></a><span id="l3.6">   _observedNicks: [],</span>
<a href="#l3.7"></a><span id="l3.7">   // This is set to true after a message is sent to notify the 401</span>
<a href="#l3.8"></a><span id="l3.8">   // ERR_NOSUCHNICK handler to write an error message to the conversation.</span>
<a href="#l3.9"></a><span id="l3.9">   _pendingMessage: false,</span>
<a href="#l3.10"></a><span id="l3.10">   _waitingForNick: false,</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  normalizeNick: function(aNick) this._account.normalizeNick(aNick),</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  normalizeNick: function(aNick) { return this._account.normalizeNick(aNick); },</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   // This will calculate the maximum number of bytes that are left for a message</span>
<a href="#l3.16"></a><span id="l3.16">   // typed by the user by calculate the amount of bytes that would be used by</span>
<a href="#l3.17"></a><span id="l3.17">   // the IRC messaging.</span>
<a href="#l3.18"></a><span id="l3.18">   getMaxMessageLength: function() {</span>
<a href="#l3.19"></a><span id="l3.19">     // Build the shortest possible message that could be sent to other users.</span>
<a href="#l3.20"></a><span id="l3.20">     let baseMessage = &quot;:&quot; + this._account._nickname + this._account.prefix +</span>
<a href="#l3.21"></a><span id="l3.21">                       &quot; &quot; + this._account.buildMessage(&quot;PRIVMSG&quot;, this.name) +</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -352,17 +352,17 @@ ircChannel.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23">   },</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">   unInit: function() {</span>
<a href="#l3.26"></a><span id="l3.26">     this.unInitIRCConversation();</span>
<a href="#l3.27"></a><span id="l3.27">     GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l3.28"></a><span id="l3.28">   },</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   // Use the normalized nick in order to properly notify the observers.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  getNormalizedChatBuddyName: function(aNick) this.normalizeNick(aNick),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  getNormalizedChatBuddyName: function(aNick) { return this.normalizeNick(aNick); },</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">   getParticipant: function(aNick, aNotifyObservers) {</span>
<a href="#l3.35"></a><span id="l3.35">     if (this._participants.has(aNick))</span>
<a href="#l3.36"></a><span id="l3.36">       return this._participants.get(aNick);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">     let participant = new ircParticipant(aNick, this);</span>
<a href="#l3.39"></a><span id="l3.39">     this._participants.set(aNick, participant);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -508,17 +508,17 @@ ircChannel.prototype = {</span>
<a href="#l3.42"></a><span id="l3.42">         let banMask = getNextParam();</span>
<a href="#l3.43"></a><span id="l3.43">         let msgKey = &quot;message.banMask&quot;;</span>
<a href="#l3.44"></a><span id="l3.44">         if (addNewMode) {</span>
<a href="#l3.45"></a><span id="l3.45">           this.banMasks.push(banMask);</span>
<a href="#l3.46"></a><span id="l3.46">           msgKey += &quot;Added&quot;;</span>
<a href="#l3.47"></a><span id="l3.47">         }</span>
<a href="#l3.48"></a><span id="l3.48">         else {</span>
<a href="#l3.49"></a><span id="l3.49">           this.banMasks =</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-            this.banMasks.filter(function (aBanMask) banMask != aBanMask);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+            this.banMasks.filter(aBanMask =&gt; banMask != aBanMask);</span>
<a href="#l3.52"></a><span id="l3.52">           msgKey += &quot;Removed&quot;;</span>
<a href="#l3.53"></a><span id="l3.53">         }</span>
<a href="#l3.54"></a><span id="l3.54">         this.writeMessage(aSetter, _(msgKey, banMask, aSetter), {system: true});</span>
<a href="#l3.55"></a><span id="l3.55">       }</span>
<a href="#l3.56"></a><span id="l3.56">       else if ([&quot;e&quot;, &quot;I&quot;, &quot;l&quot;].indexOf(aNewMode[i]) != -1) {</span>
<a href="#l3.57"></a><span id="l3.57">         // TODO The following have parameters that must be accounted for.</span>
<a href="#l3.58"></a><span id="l3.58">         getNextParam();</span>
<a href="#l3.59"></a><span id="l3.59">       }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -571,17 +571,17 @@ ircChannel.prototype = {</span>
<a href="#l3.61"></a><span id="l3.61">     // Add the new mode onto the list.</span>
<a href="#l3.62"></a><span id="l3.62">     if (aRestriction in this._account.channelRestrictionToModeMap) {</span>
<a href="#l3.63"></a><span id="l3.63">       let mode = this._account.channelRestrictionToModeMap[aRestriction];</span>
<a href="#l3.64"></a><span id="l3.64">       if (mode)</span>
<a href="#l3.65"></a><span id="l3.65">         this._modes.add(mode);</span>
<a href="#l3.66"></a><span id="l3.66">     }</span>
<a href="#l3.67"></a><span id="l3.67">   },</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  get topic() this._topic, // can't add a setter without redefining the getter</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  get topic() { return this._topic; }, // can't add a setter without redefining the getter</span>
<a href="#l3.71"></a><span id="l3.71">   set topic(aTopic) {</span>
<a href="#l3.72"></a><span id="l3.72">     // Note that the UI isn't updated here because the server will echo back the</span>
<a href="#l3.73"></a><span id="l3.73">     // TOPIC to us and we'll set it on receive.</span>
<a href="#l3.74"></a><span id="l3.74">     this._account.sendMessage(&quot;TOPIC&quot;, [this.name, aTopic]);</span>
<a href="#l3.75"></a><span id="l3.75">   },</span>
<a href="#l3.76"></a><span id="l3.76">   get topicSettable() {</span>
<a href="#l3.77"></a><span id="l3.77">     // Don't use getParticipant since we don't want to lazily create it!</span>
<a href="#l3.78"></a><span id="l3.78">     let participant = this._participants.get(this.nick);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineat">@@ -621,21 +621,21 @@ ircParticipant.prototype = {</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81">     // Notify the UI of changes.</span>
<a href="#l3.82"></a><span id="l3.82">     let msg = _(&quot;message.usermode&quot;, (aAddNewMode ? &quot;+&quot; : &quot;-&quot;) + aNewModes.join(&quot;&quot;),</span>
<a href="#l3.83"></a><span id="l3.83">                 this.name, aSetter);</span>
<a href="#l3.84"></a><span id="l3.84">     this._conv.writeMessage(aSetter, msg, {system: true});</span>
<a href="#l3.85"></a><span id="l3.85">     this._conv.notifyObservers(this, &quot;chat-buddy-update&quot;);</span>
<a href="#l3.86"></a><span id="l3.86">   },</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  get voiced() this._modes.has(&quot;v&quot;),</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  get halfOp() this._modes.has(&quot;h&quot;),</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  get op() this._modes.has(&quot;o&quot;),</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  get founder() this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;),</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  get typing() false</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  get voiced() { return this._modes.has(&quot;v&quot;); },</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  get halfOp() { return this._modes.has(&quot;h&quot;); },</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  get op() { return this._modes.has(&quot;o&quot;); },</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  get founder() { return this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;); },</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  get typing() { return false; }</span>
<a href="#l3.98"></a><span id="l3.98"> };</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100"> function ircConversation(aAccount, aName) {</span>
<a href="#l3.101"></a><span id="l3.101">   let nick = aAccount.normalize(aName);</span>
<a href="#l3.102"></a><span id="l3.102">   if (aAccount.whoisInformation.has(nick))</span>
<a href="#l3.103"></a><span id="l3.103">     aName = aAccount.whoisInformation.get(nick)[&quot;nick&quot;];</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">   this._init(aAccount, aName);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineat">@@ -643,17 +643,17 @@ function ircConversation(aAccount, aName</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108">   // Fetch correctly capitalized name.</span>
<a href="#l3.109"></a><span id="l3.109">   // Always request the info as it may be out of date.</span>
<a href="#l3.110"></a><span id="l3.110">   this._waitingForNick = true;</span>
<a href="#l3.111"></a><span id="l3.111">   this.requestBuddyInfo(aName);</span>
<a href="#l3.112"></a><span id="l3.112"> }</span>
<a href="#l3.113"></a><span id="l3.113"> ircConversation.prototype = {</span>
<a href="#l3.114"></a><span id="l3.114">   __proto__: GenericConvIMPrototype,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  get buddy() this._account.buddies.get(this.name),</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  get buddy() { return this._account.buddies.get(this.name); },</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118">   unInit: function() {</span>
<a href="#l3.119"></a><span id="l3.119">     this.unInitIRCConversation();</span>
<a href="#l3.120"></a><span id="l3.120">     GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l3.121"></a><span id="l3.121">   },</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">   updateNick: function(aNewNick) {</span>
<a href="#l3.124"></a><span id="l3.124">     this._name = aNewNick;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineat">@@ -713,17 +713,17 @@ ircSocket.prototype = {</span>
<a href="#l3.126"></a><span id="l3.126">     if (this._account.connected)</span>
<a href="#l3.127"></a><span id="l3.127">       this.resetPingTimer();</span>
<a href="#l3.128"></a><span id="l3.128"> </span>
<a href="#l3.129"></a><span id="l3.129">     // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l3.130"></a><span id="l3.130">     // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l3.131"></a><span id="l3.131">     // replaced with itself.</span>
<a href="#l3.132"></a><span id="l3.132">     const lowDequote = {&quot;0&quot;: &quot;\0&quot;, &quot;n&quot;: &quot;\n&quot;, &quot;r&quot;: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l3.133"></a><span id="l3.133">     let dequotedMessage = aRawMessage.replace(/\x10./g,</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-      function(aStr) lowDequote[aStr[1]] || aStr[1]);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+      aStr =&gt; lowDequote[aStr[1]] || aStr[1]);</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137">     try {</span>
<a href="#l3.138"></a><span id="l3.138">       let message = new ircMessage(dequotedMessage,</span>
<a href="#l3.139"></a><span id="l3.139">                                    this._account._currentServerName);</span>
<a href="#l3.140"></a><span id="l3.140">       this.DEBUG(JSON.stringify(message) + conversionWarning);</span>
<a href="#l3.141"></a><span id="l3.141">       if (!ircHandlers.handleMessage(this._account, message)) {</span>
<a href="#l3.142"></a><span id="l3.142">         // If the message was not handled, throw a warning containing</span>
<a href="#l3.143"></a><span id="l3.143">         // the original quoted message.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineat">@@ -778,39 +778,39 @@ ircSocket.prototype = {</span>
<a href="#l3.145"></a><span id="l3.145">   },</span>
<a href="#l3.146"></a><span id="l3.146">   onBadCertificate: function(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l3.147"></a><span id="l3.147">     this.ERROR(&quot;Bad certificate or SSL connection for &quot; + this._account.name +</span>
<a href="#l3.148"></a><span id="l3.148">                &quot;:\n&quot; + aNSSErrorMessage);</span>
<a href="#l3.149"></a><span id="l3.149">     let error = this._account.handleBadCertificate(this, aIsSslError);</span>
<a href="#l3.150"></a><span id="l3.150">     this._account.gotDisconnected(error, aNSSErrorMessage);</span>
<a href="#l3.151"></a><span id="l3.151">   },</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-  get DEBUG() this._account.DEBUG,</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  get LOG() this._account.LOG,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-  get WARN() this._account.WARN,</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-  get ERROR() this._account.ERROR</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  get LOG() { return this._account.LOG; },</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  get WARN() { return this._account.WARN; },</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  get ERROR() { return this._account.ERROR; }</span>
<a href="#l3.161"></a><span id="l3.161"> };</span>
<a href="#l3.162"></a><span id="l3.162"> </span>
<a href="#l3.163"></a><span id="l3.163"> function ircAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l3.164"></a><span id="l3.164">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l3.165"></a><span id="l3.165"> }</span>
<a href="#l3.166"></a><span id="l3.166"> ircAccountBuddy.prototype = {</span>
<a href="#l3.167"></a><span id="l3.167">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169">   // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l3.170"></a><span id="l3.170">   // hovers over the buddy.</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-  getTooltipInfo: function() this._account.getBuddyInfo(this.normalizedName),</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  getTooltipInfo: function() { return this._account.getBuddyInfo(this.normalizedName); },</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174">   // Allow sending of messages to buddies even if they are not online since IRC</span>
<a href="#l3.175"></a><span id="l3.175">   // does not always provide status information in a timely fashion. (Note that</span>
<a href="#l3.176"></a><span id="l3.176">   // this is OK since the server will throw an error if the user is not online.)</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-  get canSendMessage() this.account.connected,</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  get canSendMessage() { return this.account.connected; },</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180">   // Called when the user wants to chat with the buddy.</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-  createConversation: function() this._account.createConversation(this.userName),</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  createConversation: function() { return this._account.createConversation(this.userName); },</span>
<a href="#l3.183"></a><span id="l3.183"> </span>
<a href="#l3.184"></a><span id="l3.184">   remove: function() {</span>
<a href="#l3.185"></a><span id="l3.185">     this._account.removeBuddy(this);</span>
<a href="#l3.186"></a><span id="l3.186">     GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l3.187"></a><span id="l3.187">   }</span>
<a href="#l3.188"></a><span id="l3.188"> };</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190"> function ircAccount(aProtocol, aImAccount) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineat">@@ -838,17 +838,17 @@ function ircAccount(aProtocol, aImAccoun</span>
<a href="#l3.192"></a><span id="l3.192">   this._commandBuffers = new Map();</span>
<a href="#l3.193"></a><span id="l3.193">   this._roomInfoCallbacks = new Set();</span>
<a href="#l3.194"></a><span id="l3.194"> }</span>
<a href="#l3.195"></a><span id="l3.195"> ircAccount.prototype = {</span>
<a href="#l3.196"></a><span id="l3.196">   __proto__: GenericAccountPrototype,</span>
<a href="#l3.197"></a><span id="l3.197">   _socket: null,</span>
<a href="#l3.198"></a><span id="l3.198">   _MODE_WALLOPS: 1 &lt;&lt; 2, // mode 'w'</span>
<a href="#l3.199"></a><span id="l3.199">   _MODE_INVISIBLE: 1 &lt;&lt; 3, // mode 'i'</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-  get _mode() 0,</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+  get _mode() { return 0; },</span>
<a href="#l3.202"></a><span id="l3.202"> </span>
<a href="#l3.203"></a><span id="l3.203">   // The name of the server we last connected to.</span>
<a href="#l3.204"></a><span id="l3.204">   _currentServerName: null,</span>
<a href="#l3.205"></a><span id="l3.205">   // Whether to attempt authenticating with NickServ.</span>
<a href="#l3.206"></a><span id="l3.206">   shouldAuthenticate: true,</span>
<a href="#l3.207"></a><span id="l3.207">   // Whether the user has successfully authenticated with NickServ.</span>
<a href="#l3.208"></a><span id="l3.208">   isAuthenticated: false,</span>
<a href="#l3.209"></a><span id="l3.209">   // The current in use nickname.</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineat">@@ -883,17 +883,17 @@ ircAccount.prototype = {</span>
<a href="#l3.211"></a><span id="l3.211">   // server can overwrite them. The defaults given here are from RFC 2812.</span>
<a href="#l3.212"></a><span id="l3.212">   maxNicknameLength: 9, // 1.2.1 Users</span>
<a href="#l3.213"></a><span id="l3.213">   maxChannelLength: 50, // 1.3 Channels</span>
<a href="#l3.214"></a><span id="l3.214">   maxMessageLength: 512, // 2.3 Messages</span>
<a href="#l3.215"></a><span id="l3.215">   maxHostnameLength: 63, // 2.3.1 Message format in Augmented BNF</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">   // The default prefixes to modes.</span>
<a href="#l3.218"></a><span id="l3.218">   userPrefixToModeMap: {&quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot;},</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  get userPrefixes() Object.keys(this.userPrefixToModeMap),</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+  get userPrefixes() { return Object.keys(this.userPrefixToModeMap); },</span>
<a href="#l3.221"></a><span id="l3.221">   // Modes that have a nickname parameter and affect a participant. See 4.1</span>
<a href="#l3.222"></a><span id="l3.222">   // Member Status of RFC 2811.</span>
<a href="#l3.223"></a><span id="l3.223">   memberStatuses: [&quot;a&quot;, &quot;h&quot;, &quot;o&quot;, &quot;O&quot;, &quot;q&quot;, &quot;v&quot;, &quot;!&quot;],</span>
<a href="#l3.224"></a><span id="l3.224">   channelPrefixes: [&quot;&amp;&quot;, &quot;#&quot;, &quot;+&quot;, &quot;!&quot;], // 1.3 Channels</span>
<a href="#l3.225"></a><span id="l3.225">   channelRestrictionToModeMap: {&quot;@&quot;: &quot;s&quot;, &quot;*&quot;: &quot;p&quot;, &quot;=&quot;: null}, // 353 RPL_NAMREPLY</span>
<a href="#l3.226"></a><span id="l3.226"> </span>
<a href="#l3.227"></a><span id="l3.227">   // Handle Scandanavian lower case (optionally remove status indicators).</span>
<a href="#l3.228"></a><span id="l3.228">   // See Section 2.2 of RFC 2812: the characters {}|^ are considered to be the</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineat">@@ -903,19 +903,19 @@ ircAccount.prototype = {</span>
<a href="#l3.230"></a><span id="l3.230">     let str = aStr;</span>
<a href="#l3.231"></a><span id="l3.231"> </span>
<a href="#l3.232"></a><span id="l3.232">     if (aPrefixes) {</span>
<a href="#l3.233"></a><span id="l3.233">       while (aPrefixes.indexOf(str[0]) != -1)</span>
<a href="#l3.234"></a><span id="l3.234">         str = str.slice(1);</span>
<a href="#l3.235"></a><span id="l3.235">     }</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237">     return str.replace(this.normalizeExpression,</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-                       function(c) String.fromCharCode(c.charCodeAt(0) + 0x20));</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+                       c =&gt; String.fromCharCode(c.charCodeAt(0) + 0x20));</span>
<a href="#l3.240"></a><span id="l3.240">   },</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  normalizeNick: function(aNick) this.normalize(aNick, this.userPrefixes),</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  normalizeNick: function(aNick) { return this.normalize(aNick, this.userPrefixes); },</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244">   isMUCName: function(aStr) {</span>
<a href="#l3.245"></a><span id="l3.245">     return (this.channelPrefixes.indexOf(aStr[0]) != -1);</span>
<a href="#l3.246"></a><span id="l3.246">   },</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248">   // Tell the server about status changes. IRC is only away or not away;</span>
<a href="#l3.249"></a><span id="l3.249">   // consider the away, idle and unavailable status type to be away.</span>
<a href="#l3.250"></a><span id="l3.250">   isAway: false,</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineat">@@ -992,17 +992,17 @@ ircAccount.prototype = {</span>
<a href="#l3.252"></a><span id="l3.252">   // Channels are stored as prplIRoomInfo.</span>
<a href="#l3.253"></a><span id="l3.253">   _channelList: [],</span>
<a href="#l3.254"></a><span id="l3.254">   _roomInfoCallbacks: new Set(),</span>
<a href="#l3.255"></a><span id="l3.255">   // If true, we have sent the LIST request and are waiting for replies.</span>
<a href="#l3.256"></a><span id="l3.256">   _pendingList: false,</span>
<a href="#l3.257"></a><span id="l3.257">   // Callbacks receive at most this many channels per call.</span>
<a href="#l3.258"></a><span id="l3.258">   _channelsPerBatch: 25,</span>
<a href="#l3.259"></a><span id="l3.259">   _lastListTime: 0,</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-  get isRoomInfoStale() Date.now() - this._lastListTime &gt; kListRefreshInterval,</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  get isRoomInfoStale() { return Date.now() - this._lastListTime &gt; kListRefreshInterval; },</span>
<a href="#l3.262"></a><span id="l3.262">   // Called by consumers that want a list of available channels, which are</span>
<a href="#l3.263"></a><span id="l3.263">   // provided through the callback (prplIRoomInfoCallback instance).</span>
<a href="#l3.264"></a><span id="l3.264">   requestRoomInfo: function(aCallback, aIsUserRequest) {</span>
<a href="#l3.265"></a><span id="l3.265">     // Ignore the automaticList pref if the user explicitly requests /list.</span>
<a href="#l3.266"></a><span id="l3.266">     if (!aIsUserRequest &amp;&amp;</span>
<a href="#l3.267"></a><span id="l3.267">         !Services.prefs.getBoolPref(&quot;chat.irc.automaticList&quot;))</span>
<a href="#l3.268"></a><span id="l3.268">       throw Cr.NS_ERROR_NOT_IMPLEMENTED; // Pretend we can't return roomInfo.</span>
<a href="#l3.269"></a><span id="l3.269">     if (this._roomInfoCallbacks.has(aCallback)) // Callback is not new.</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineat">@@ -1163,21 +1163,21 @@ ircAccount.prototype = {</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272">     // Sort the list of channels, ignoring the prefixes of channel and user.</span>
<a href="#l3.273"></a><span id="l3.273">     let prefixes = this.userPrefixes.concat(this.channelPrefixes);</span>
<a href="#l3.274"></a><span id="l3.274">     let sortWithoutPrefix = function(a, b) {</span>
<a href="#l3.275"></a><span id="l3.275">       a = this.normalize(a, prefixes);</span>
<a href="#l3.276"></a><span id="l3.276">       b = this.normalize(b, prefixes);</span>
<a href="#l3.277"></a><span id="l3.277">       return a &lt; b ? -1 : a &gt; b ? 1 : 0;</span>
<a href="#l3.278"></a><span id="l3.278">     }.bind(this);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    let sortChannels = function(channels)</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+    let sortChannels = channels =&gt;</span>
<a href="#l3.281"></a><span id="l3.281">       channels.trim().split(/\s+/).sort(sortWithoutPrefix).join(&quot; &quot;);</span>
<a href="#l3.282"></a><span id="l3.282"> </span>
<a href="#l3.283"></a><span id="l3.283">     // Convert booleans into a human-readable form.</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-    let normalizeBool = function(aBool) _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+    let normalizeBool = aBool =&gt; _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287">     // Convert timespan in seconds into a human-readable form.</span>
<a href="#l3.288"></a><span id="l3.288">     let normalizeTime = function(aTime) {</span>
<a href="#l3.289"></a><span id="l3.289">       let valuesAndUnits = DownloadUtils.convertTimeUnits(aTime);</span>
<a href="#l3.290"></a><span id="l3.290">       // If the time is exact to the first set of units, trim off</span>
<a href="#l3.291"></a><span id="l3.291">       // the subsequent zeroes.</span>
<a href="#l3.292"></a><span id="l3.292">       if (!valuesAndUnits[2])</span>
<a href="#l3.293"></a><span id="l3.293">         valuesAndUnits.splice(2, 2);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineat">@@ -1223,17 +1223,17 @@ ircAccount.prototype = {</span>
<a href="#l3.295"></a><span id="l3.295">     else if (&quot;lastActivity&quot; in whoisInformation &amp;&amp;</span>
<a href="#l3.296"></a><span id="l3.296">              whoisInformation[&quot;lastActivity&quot;] &gt; kSetIdleStatusAfterSeconds)</span>
<a href="#l3.297"></a><span id="l3.297">       statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.298"></a><span id="l3.298">     tooltipInfo.push(new TooltipInfo(statusType, statusText, true));</span>
<a href="#l3.299"></a><span id="l3.299"> </span>
<a href="#l3.300"></a><span id="l3.300">     return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l3.301"></a><span id="l3.301">   },</span>
<a href="#l3.302"></a><span id="l3.302">   // Remove a WHOIS entry.</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  removeBuddyInfo: function(aNick) this.whoisInformation.delete(aNick),</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  removeBuddyInfo: function(aNick) { return this.whoisInformation.delete(aNick); },</span>
<a href="#l3.305"></a><span id="l3.305">   // Copies the fields of aFields into the whois table. If the field already</span>
<a href="#l3.306"></a><span id="l3.306">   // exists, that field is ignored (it is assumed that the first server response</span>
<a href="#l3.307"></a><span id="l3.307">   // is the most up to date information, as is the case for 312/314). Note that</span>
<a href="#l3.308"></a><span id="l3.308">   // the whois info for a nick is reset whenever whois information is requested,</span>
<a href="#l3.309"></a><span id="l3.309">   // so the first response from each whois is recorded.</span>
<a href="#l3.310"></a><span id="l3.310">   setWhois: function(aNick, aFields = {}) {</span>
<a href="#l3.311"></a><span id="l3.311">     // If the nickname isn't in the list yet, add it.</span>
<a href="#l3.312"></a><span id="l3.312">     if (!this.whoisInformation.has(aNick))</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineat">@@ -1610,17 +1610,17 @@ ircAccount.prototype = {</span>
<a href="#l3.314"></a><span id="l3.314">     this._requestedNickname = this._accountNickname;</span>
<a href="#l3.315"></a><span id="l3.315"> </span>
<a href="#l3.316"></a><span id="l3.316">     // Give the server 2 seconds to respond, otherwise just forcefully</span>
<a href="#l3.317"></a><span id="l3.317">     // disconnect the socket. This will be cancelled if a response is heard from</span>
<a href="#l3.318"></a><span id="l3.318">     // the server.</span>
<a href="#l3.319"></a><span id="l3.319">     this._quitTimer = setTimeout(this.gotDisconnected.bind(this), 2 * 1000);</span>
<a href="#l3.320"></a><span id="l3.320">   },</span>
<a href="#l3.321"></a><span id="l3.321"> </span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-  createConversation: function(aName) this.getConversation(aName),</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+  createConversation: function(aName) { return this.getConversation(aName); },</span>
<a href="#l3.324"></a><span id="l3.324"> </span>
<a href="#l3.325"></a><span id="l3.325">   // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l3.326"></a><span id="l3.326">   joinChat: function(aComponents) {</span>
<a href="#l3.327"></a><span id="l3.327">     let channel = aComponents.getValue(&quot;channel&quot;);</span>
<a href="#l3.328"></a><span id="l3.328">     // Mildly sanitize input.</span>
<a href="#l3.329"></a><span id="l3.329">     channel = channel.trimLeft().split(&quot;,&quot;)[0].split(&quot; &quot;)[0];</span>
<a href="#l3.330"></a><span id="l3.330">     if (!channel) {</span>
<a href="#l3.331"></a><span id="l3.331">       this.ERROR(&quot;joinChat called without a valid channel name.&quot;);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineat">@@ -1655,30 +1655,30 @@ ircAccount.prototype = {</span>
<a href="#l3.333"></a><span id="l3.333">     // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l3.334"></a><span id="l3.334">     let defaultName = key ? channel + &quot; &quot; + key : channel;</span>
<a href="#l3.335"></a><span id="l3.335">     conv.chatRoomFields = this.getChatRoomDefaultFieldValues(defaultName);</span>
<a href="#l3.336"></a><span id="l3.336"> </span>
<a href="#l3.337"></a><span id="l3.337">     return conv;</span>
<a href="#l3.338"></a><span id="l3.338">   },</span>
<a href="#l3.339"></a><span id="l3.339"> </span>
<a href="#l3.340"></a><span id="l3.340">   chatRoomFields: {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-    &quot;channel&quot;: {get label() _(&quot;joinChat.channel&quot;), required: true},</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-    &quot;password&quot;: {get label() _(&quot;joinChat.password&quot;), isPassword: true}</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+    &quot;channel&quot;: {get label() { return _(&quot;joinChat.channel&quot;); }, required: true},</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+    &quot;password&quot;: {get label() { return _(&quot;joinChat.password&quot;); }, isPassword: true}</span>
<a href="#l3.345"></a><span id="l3.345">   },</span>
<a href="#l3.346"></a><span id="l3.346"> </span>
<a href="#l3.347"></a><span id="l3.347">   parseDefaultChatName: function(aDefaultName) {</span>
<a href="#l3.348"></a><span id="l3.348">     let params = aDefaultName.trim().split(/\s+/);</span>
<a href="#l3.349"></a><span id="l3.349">     let chatFields = {channel: params[0]};</span>
<a href="#l3.350"></a><span id="l3.350">     if (params.length &gt; 1)</span>
<a href="#l3.351"></a><span id="l3.351">       chatFields.password = params[1];</span>
<a href="#l3.352"></a><span id="l3.352">     return chatFields;</span>
<a href="#l3.353"></a><span id="l3.353">   },</span>
<a href="#l3.354"></a><span id="l3.354"> </span>
<a href="#l3.355"></a><span id="l3.355">   // Attributes</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-  get canJoinChat() true,</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+  get canJoinChat() { return true; },</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">   // Returns a conversation (creates it if it doesn't exist)</span>
<a href="#l3.360"></a><span id="l3.360">   getConversation: function(aName) {</span>
<a href="#l3.361"></a><span id="l3.361">     if (!this.conversations.has(aName)) {</span>
<a href="#l3.362"></a><span id="l3.362">       // If the whois information has been received, we have the proper nick</span>
<a href="#l3.363"></a><span id="l3.363">       // capitalization.</span>
<a href="#l3.364"></a><span id="l3.364">       if (this.whoisInformation.has(aName))</span>
<a href="#l3.365"></a><span id="l3.365">         aName = this.whoisInformation.get(aName).nick;</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineat">@@ -1706,17 +1706,17 @@ ircAccount.prototype = {</span>
<a href="#l3.367"></a><span id="l3.367">       return null;</span>
<a href="#l3.368"></a><span id="l3.368">     }</span>
<a href="#l3.369"></a><span id="l3.369"> </span>
<a href="#l3.370"></a><span id="l3.370">     let message = aCommand;</span>
<a href="#l3.371"></a><span id="l3.371">     // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l3.372"></a><span id="l3.372">     // it into an array.</span>
<a href="#l3.373"></a><span id="l3.373">     let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l3.374"></a><span id="l3.374">     if (params.length) {</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-      if (params.slice(0, -1).some(function(p) p.includes(&quot; &quot;))) {</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+      if (params.slice(0, -1).some(p =&gt; p.includes(&quot; &quot;))) {</span>
<a href="#l3.377"></a><span id="l3.377">         this.ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l3.378"></a><span id="l3.378">         return null;</span>
<a href="#l3.379"></a><span id="l3.379">       }</span>
<a href="#l3.380"></a><span id="l3.380">       // Join the parameters with spaces. There are three cases in which the</span>
<a href="#l3.381"></a><span id="l3.381">       // last parameter (&quot;trailing&quot; in RFC 2812) must be prepended with a colon:</span>
<a href="#l3.382"></a><span id="l3.382">       //  1. If the last parameter contains a space.</span>
<a href="#l3.383"></a><span id="l3.383">       //  2. If the first character of the last parameter is a colon.</span>
<a href="#l3.384"></a><span id="l3.384">       //  3. If the last parameter is an empty string.</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineat">@@ -1727,28 +1727,29 @@ ircAccount.prototype = {</span>
<a href="#l3.386"></a><span id="l3.386">     }</span>
<a href="#l3.387"></a><span id="l3.387"> </span>
<a href="#l3.388"></a><span id="l3.388">     return message;</span>
<a href="#l3.389"></a><span id="l3.389">   },</span>
<a href="#l3.390"></a><span id="l3.390"> </span>
<a href="#l3.391"></a><span id="l3.391">   // Shortcut method to build &amp; send a message at once. Use aLoggedData to log</span>
<a href="#l3.392"></a><span id="l3.392">   // something different than what is actually sent.</span>
<a href="#l3.393"></a><span id="l3.393">   // Returns false if the message could not be sent.</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-  sendMessage: function(aCommand, aParams, aLoggedData)</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-    this.sendRawMessage(this.buildMessage(aCommand, aParams), aLoggedData),</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+  sendMessage: function(aCommand, aParams, aLoggedData) {</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+    return this.sendRawMessage(this.buildMessage(aCommand, aParams), aLoggedData);</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+  },</span>
<a href="#l3.399"></a><span id="l3.399"> </span>
<a href="#l3.400"></a><span id="l3.400">   // This sends a message over the socket and catches any errors. Use</span>
<a href="#l3.401"></a><span id="l3.401">   // aLoggedData to log something different than what is actually sent.</span>
<a href="#l3.402"></a><span id="l3.402">   // Returns false if the message could not be sent.</span>
<a href="#l3.403"></a><span id="l3.403">   sendRawMessage: function(aMessage, aLoggedData) {</span>
<a href="#l3.404"></a><span id="l3.404">     // Low level quoting, replace \0, \n, \r or \020 with \0200, \020n, \020r or</span>
<a href="#l3.405"></a><span id="l3.405">     // \020\020, respectively.</span>
<a href="#l3.406"></a><span id="l3.406">     const lowQuote = {&quot;\0&quot;: &quot;0&quot;, &quot;\n&quot;: &quot;n&quot;, &quot;\r&quot;: &quot;r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l3.407"></a><span id="l3.407">     const lowRegex = new RegExp(&quot;[&quot; + Object.keys(lowQuote).join(&quot;&quot;) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-    aMessage = aMessage.replace(lowRegex, function(aChar) &quot;\x10&quot; + lowQuote[aChar]);</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+    aMessage = aMessage.replace(lowRegex, aChar =&gt; &quot;\x10&quot; + lowQuote[aChar]);</span>
<a href="#l3.410"></a><span id="l3.410"> </span>
<a href="#l3.411"></a><span id="l3.411">     if (!this._socket || this._socket.disconnected) {</span>
<a href="#l3.412"></a><span id="l3.412">       this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l3.413"></a><span id="l3.413">                            _(&quot;connection.error.lost&quot;));</span>
<a href="#l3.414"></a><span id="l3.414">     }</span>
<a href="#l3.415"></a><span id="l3.415"> </span>
<a href="#l3.416"></a><span id="l3.416">     let length = this.countBytes(aMessage) + 2;</span>
<a href="#l3.417"></a><span id="l3.417">     if (length &gt; this.maxMessageLength) {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineat">@@ -1787,17 +1788,17 @@ ircAccount.prototype = {</span>
<a href="#l3.419"></a><span id="l3.419">     let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l3.420"></a><span id="l3.420">     if (params.length)</span>
<a href="#l3.421"></a><span id="l3.421">       ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l3.422"></a><span id="l3.422"> </span>
<a href="#l3.423"></a><span id="l3.423">     // High/CTCP level quoting, replace \134 or \001 with \134\134 or \134a,</span>
<a href="#l3.424"></a><span id="l3.424">     // respectively. This is only done inside the extended data message.</span>
<a href="#l3.425"></a><span id="l3.425">     const highRegex = /\\|\x01/g;</span>
<a href="#l3.426"></a><span id="l3.426">     ircParam = ircParam.replace(highRegex,</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-      function(aChar) &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;));</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+      aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;));</span>
<a href="#l3.429"></a><span id="l3.429"> </span>
<a href="#l3.430"></a><span id="l3.430">     // Add the CTCP tagging.</span>
<a href="#l3.431"></a><span id="l3.431">     ircParam = &quot;\x01&quot; + ircParam + &quot;\x01&quot;;</span>
<a href="#l3.432"></a><span id="l3.432"> </span>
<a href="#l3.433"></a><span id="l3.433">     // Send the IRC message as a NOTICE or PRIVMSG.</span>
<a href="#l3.434"></a><span id="l3.434">     return this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [aTarget, ircParam]);</span>
<a href="#l3.435"></a><span id="l3.435">   },</span>
<a href="#l3.436"></a><span id="l3.436"> </span>
<a href="#l3.437"></a><span id="l3.437" class="difflineat">@@ -1821,17 +1822,17 @@ ircAccount.prototype = {</span>
<a href="#l3.438"></a><span id="l3.438"> </span>
<a href="#l3.439"></a><span id="l3.439">   _reportDisconnecting: function(aErrorReason, aErrorMessage) {</span>
<a href="#l3.440"></a><span id="l3.440">     this.reportDisconnecting(aErrorReason, aErrorMessage);</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442">     // Cancel any pending buffered commands.</span>
<a href="#l3.443"></a><span id="l3.443">     this._commandBuffers.clear();</span>
<a href="#l3.444"></a><span id="l3.444"> </span>
<a href="#l3.445"></a><span id="l3.445">     // Mark all contacts on the account as having an unknown status.</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-    this.buddies.forEach(function(aBuddy)</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt;</span>
<a href="#l3.448"></a><span id="l3.448">       aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;));</span>
<a href="#l3.449"></a><span id="l3.449">   },</span>
<a href="#l3.450"></a><span id="l3.450"> </span>
<a href="#l3.451"></a><span id="l3.451">   gotDisconnected: function(aError = Ci.prplIAccount.NO_ERROR,</span>
<a href="#l3.452"></a><span id="l3.452">                             aErrorMessage = &quot;&quot;) {</span>
<a href="#l3.453"></a><span id="l3.453">     if (!this.imAccount || this.disconnected)</span>
<a href="#l3.454"></a><span id="l3.454">        return;</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456" class="difflineat">@@ -1882,17 +1883,17 @@ ircAccount.prototype = {</span>
<a href="#l3.457"></a><span id="l3.457">     this.whoisInformation.clear();</span>
<a href="#l3.458"></a><span id="l3.458"> </span>
<a href="#l3.459"></a><span id="l3.459">     this.reportDisconnected();</span>
<a href="#l3.460"></a><span id="l3.460">   },</span>
<a href="#l3.461"></a><span id="l3.461"> </span>
<a href="#l3.462"></a><span id="l3.462">   remove: function() {</span>
<a href="#l3.463"></a><span id="l3.463">     this.conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l3.464"></a><span id="l3.464">     delete this.conversations;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-    this.buddies.forEach(function(aBuddy) aBuddy.remove());</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l3.467"></a><span id="l3.467">     delete this.buddies;</span>
<a href="#l3.468"></a><span id="l3.468">   },</span>
<a href="#l3.469"></a><span id="l3.469"> </span>
<a href="#l3.470"></a><span id="l3.470">   unInit: function() {</span>
<a href="#l3.471"></a><span id="l3.471">     // Disconnect if we're online while this gets called.</span>
<a href="#l3.472"></a><span id="l3.472">     if (this._socket) {</span>
<a href="#l3.473"></a><span id="l3.473">       if (!this.disconnecting)</span>
<a href="#l3.474"></a><span id="l3.474">         this.quit();</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineat">@@ -1947,40 +1948,40 @@ function ircProtocol() {</span>
<a href="#l3.476"></a><span id="l3.476">   ircHandlers.registerISUPPORTHandler(tempScope.isupportWATCH);</span>
<a href="#l3.477"></a><span id="l3.477">   ircHandlers.registerHandler(tempScope.ircMONITOR);</span>
<a href="#l3.478"></a><span id="l3.478">   ircHandlers.registerISUPPORTHandler(tempScope.isupportMONITOR);</span>
<a href="#l3.479"></a><span id="l3.479">   ircHandlers.registerHandler(tempScope.ircSASL);</span>
<a href="#l3.480"></a><span id="l3.480">   ircHandlers.registerCAPHandler(tempScope.capSASL);</span>
<a href="#l3.481"></a><span id="l3.481"> }</span>
<a href="#l3.482"></a><span id="l3.482"> ircProtocol.prototype = {</span>
<a href="#l3.483"></a><span id="l3.483">   __proto__: GenericProtocolPrototype,</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-  get name() &quot;IRC&quot;,</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-irc/skin/&quot;,</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-  get usernameEmptyText() _(&quot;irc.usernameHint&quot;),</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-  get baseId() &quot;prpl-irc&quot;,</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+  get name() { return &quot;IRC&quot;; },</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-irc/skin/&quot;; },</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+  get usernameEmptyText() { return _(&quot;irc.usernameHint&quot;); },</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+  get baseId() { return &quot;prpl-irc&quot;; },</span>
<a href="#l3.492"></a><span id="l3.492"> </span>
<a href="#l3.493"></a><span id="l3.493">   usernameSplits: [</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-    {get label() _(&quot;options.server&quot;), separator: &quot;@&quot;,</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+    {get label() { return _(&quot;options.server&quot;); }, separator: &quot;@&quot;,</span>
<a href="#l3.496"></a><span id="l3.496">      defaultValue: &quot;chat.freenode.net&quot;, reverse: true}</span>
<a href="#l3.497"></a><span id="l3.497">   ],</span>
<a href="#l3.498"></a><span id="l3.498"> </span>
<a href="#l3.499"></a><span id="l3.499">   options: {</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-    &quot;port&quot;: {get label() _(&quot;options.port&quot;), default: 6697},</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-    &quot;ssl&quot;: {get label() _(&quot;options.ssl&quot;), default: true},</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+    &quot;port&quot;: {get label() { return _(&quot;options.port&quot;); }, default: 6697},</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+    &quot;ssl&quot;: {get label() { return _(&quot;options.ssl&quot;); }, default: true},</span>
<a href="#l3.504"></a><span id="l3.504">     // TODO We should attempt to auto-detect encoding instead.</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-    &quot;encoding&quot;: {get label() _(&quot;options.encoding&quot;), default: &quot;UTF-8&quot;},</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-    &quot;quitmsg&quot;: {get label() _(&quot;options.quitMessage&quot;),</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-                get default() Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;)},</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-    &quot;partmsg&quot;: {get label() _(&quot;options.partMessage&quot;), default: &quot;&quot;},</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-    &quot;showServerTab&quot;: {get label() _(&quot;options.showServerTab&quot;), default: false},</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-    &quot;alternateNicks&quot;: {get label() _(&quot;options.alternateNicks&quot;), default: &quot;&quot;}</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+    &quot;encoding&quot;: {get label() { return _(&quot;options.encoding&quot;); }, default: &quot;UTF-8&quot;},</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+    &quot;quitmsg&quot;: {get label() { return _(&quot;options.quitMessage&quot;); },</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+                get default() { return Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;); }},</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+    &quot;partmsg&quot;: {get label() { return _(&quot;options.partMessage&quot;); }, default: &quot;&quot;},</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+    &quot;showServerTab&quot;: {get label() { return _(&quot;options.showServerTab&quot;); }, default: false},</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+    &quot;alternateNicks&quot;: {get label() { return _(&quot;options.alternateNicks&quot;); }, default: &quot;&quot;}</span>
<a href="#l3.517"></a><span id="l3.517">   },</span>
<a href="#l3.518"></a><span id="l3.518"> </span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  get chatHasTopic() true,</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  get slashCommandsNative() true,</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+  get chatHasTopic() { return true; },</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+  get slashCommandsNative() { return true; },</span>
<a href="#l3.523"></a><span id="l3.523">   //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-  get passwordOptional() true,</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+  get passwordOptional() { return true; },</span>
<a href="#l3.526"></a><span id="l3.526"> </span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-  getAccount: function(aImAccount) new ircAccount(this, aImAccount),</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+  getAccount: function(aImAccount) { return new ircAccount(this, aImAccount); },</span>
<a href="#l3.529"></a><span id="l3.529">   classID: Components.ID(&quot;{607b2c0b-9504-483f-ad62-41de09238aec}&quot;)</span>
<a href="#l3.530"></a><span id="l3.530"> };</span>
<a href="#l3.531"></a><span id="l3.531"> </span>
<a href="#l3.532"></a><span id="l3.532"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([ircProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/irc/ircBase.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/irc/ircBase.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -30,19 +30,20 @@ Cu.import(&quot;resource:///modules/jsProtoHe</span>
<a href="#l4.4"></a><span id="l4.4"> function ircRoomInfo(aName, aTopic, aParticipantCount, aAccount) {</span>
<a href="#l4.5"></a><span id="l4.5">   this.name = aName;</span>
<a href="#l4.6"></a><span id="l4.6">   this.topic = aTopic;</span>
<a href="#l4.7"></a><span id="l4.7">   this.participantCount = aParticipantCount;</span>
<a href="#l4.8"></a><span id="l4.8">   this._account = aAccount;</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> ircRoomInfo.prototype = {</span>
<a href="#l4.11"></a><span id="l4.11">   __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;IRC RoomInfo Object&quot;),</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  get accountId() this._account.imAccount.id,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  get chatRoomFieldValues()</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    this._account.getChatRoomDefaultFieldValues(this.name)</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  get accountId() { return this._account.imAccount.id; },</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  get chatRoomFieldValues() {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    return this._account.getChatRoomDefaultFieldValues(this.name);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  }</span>
<a href="#l4.19"></a><span id="l4.19"> }</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> function privmsg(aAccount, aMessage, aIsNotification) {</span>
<a href="#l4.22"></a><span id="l4.22">   let params = {incoming: true};</span>
<a href="#l4.23"></a><span id="l4.23">   if (aIsNotification)</span>
<a href="#l4.24"></a><span id="l4.24">     params.notification = true;</span>
<a href="#l4.25"></a><span id="l4.25">   aAccount.getConversation(aAccount.isMUCName(aMessage.params[0]) ?</span>
<a href="#l4.26"></a><span id="l4.26">                              aMessage.params[0] : aMessage.origin)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -145,17 +146,17 @@ function addMotd(aAccount, aMessage) {</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> // See RFCs 2811 &amp; 2812 (which obsoletes RFC 1459) for a description of these</span>
<a href="#l4.31"></a><span id="l4.31"> // commands.</span>
<a href="#l4.32"></a><span id="l4.32"> var ircBase = {</span>
<a href="#l4.33"></a><span id="l4.33">   // Parameters</span>
<a href="#l4.34"></a><span id="l4.34">   name: &quot;RFC 2812&quot;, // Name identifier</span>
<a href="#l4.35"></a><span id="l4.35">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">   // The IRC commands that can be handled.</span>
<a href="#l4.40"></a><span id="l4.40">   commands: {</span>
<a href="#l4.41"></a><span id="l4.41">     &quot;ERROR&quot;: function(aMessage) {</span>
<a href="#l4.42"></a><span id="l4.42">       // ERROR &lt;error message&gt;</span>
<a href="#l4.43"></a><span id="l4.43">       // Client connection has been terminated.</span>
<a href="#l4.44"></a><span id="l4.44">       if (!this.disconnecting) {</span>
<a href="#l4.45"></a><span id="l4.45">         // We received an ERROR message when we weren't expecting it, this is</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineat">@@ -927,17 +928,17 @@ var ircBase = {</span>
<a href="#l4.47"></a><span id="l4.47">      */</span>
<a href="#l4.48"></a><span id="l4.48">     &quot;353&quot;: function(aMessage) { // RPL_NAMREPLY</span>
<a href="#l4.49"></a><span id="l4.49">       // &lt;target&gt; ( &quot;=&quot; / &quot;*&quot; / &quot;@&quot; ) &lt;channel&gt; :[ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; *( &quot; &quot; [ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; )</span>
<a href="#l4.50"></a><span id="l4.50">       let conversation = this.getConversation(aMessage.params[2]);</span>
<a href="#l4.51"></a><span id="l4.51">       // Keep if this is secret (@), private (*) or public (=).</span>
<a href="#l4.52"></a><span id="l4.52">       conversation.setModesFromRestriction(aMessage.params[1]);</span>
<a href="#l4.53"></a><span id="l4.53">       // Add the participants.</span>
<a href="#l4.54"></a><span id="l4.54">       let newParticipants = [];</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-      aMessage.params[3].trim().split(&quot; &quot;).forEach(function(aNick)</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      aMessage.params[3].trim().split(&quot; &quot;).forEach(aNick =&gt;</span>
<a href="#l4.57"></a><span id="l4.57">         newParticipants.push(conversation.getParticipant(aNick, false)));</span>
<a href="#l4.58"></a><span id="l4.58">       conversation.notifyObservers(new nsSimpleEnumerator(newParticipants),</span>
<a href="#l4.59"></a><span id="l4.59">                                    &quot;chat-buddy-add&quot;);</span>
<a href="#l4.60"></a><span id="l4.60">       return true;</span>
<a href="#l4.61"></a><span id="l4.61">     },</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">     &quot;361&quot;: function(aMessage) { // RPL_KILLDONE</span>
<a href="#l4.64"></a><span id="l4.64">       // Non-generic</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -54,29 +54,29 @@ function capMessage(aMessage) {</span>
<a href="#l5.4"></a><span id="l5.4">     return message;</span>
<a href="#l5.5"></a><span id="l5.5">   });</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var ircCAP = {</span>
<a href="#l5.9"></a><span id="l5.9">   name: &quot;Client Capabilities&quot;,</span>
<a href="#l5.10"></a><span id="l5.10">   // Slightly above default RFC 2812 priority.</span>
<a href="#l5.11"></a><span id="l5.11">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   commands: {</span>
<a href="#l5.16"></a><span id="l5.16">     &quot;CAP&quot;: function(aMessage) {</span>
<a href="#l5.17"></a><span id="l5.17">       // [* | &lt;nick&gt;] &lt;subcommand&gt; :&lt;parameters&gt;</span>
<a href="#l5.18"></a><span id="l5.18">       let messages = capMessage(aMessage);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-      messages = messages.filter(function(aMessage)</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-        !ircHandlers.handleCAPMessage(this, aMessage), this);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+      messages = messages.filter(aMessage =&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+        !ircHandlers.handleCAPMessage(this, aMessage));</span>
<a href="#l5.24"></a><span id="l5.24">       if (messages.length) {</span>
<a href="#l5.25"></a><span id="l5.25">         // Display the list of unhandled CAP messages.</span>
<a href="#l5.26"></a><span id="l5.26">         let unhandledMessages =</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-          messages.map(function(aMsg) aMsg.cap.parameter).join(&quot; &quot;);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+          messages.map(aMsg =&gt; aMsg.cap.parameter).join(&quot; &quot;);</span>
<a href="#l5.29"></a><span id="l5.29">         this.LOG(&quot;Unhandled CAP messages: &quot; + unhandledMessages +</span>
<a href="#l5.30"></a><span id="l5.30">                  &quot;\nRaw message: &quot; + aMessage.rawMessage);</span>
<a href="#l5.31"></a><span id="l5.31">       }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">       // If no CAP handlers were added, just tell the server we're done.</span>
<a href="#l5.34"></a><span id="l5.34">       if (aMessage.cap.subcommand == &quot;LS&quot; &amp;&amp; !this._caps.size)</span>
<a href="#l5.35"></a><span id="l5.35">         this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l5.36"></a><span id="l5.36">       return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -24,17 +24,17 @@ function CTCPMessage(aMessage, aRawCTCPM</span>
<a href="#l6.4"></a><span id="l6.4">   let message = aMessage;</span>
<a href="#l6.5"></a><span id="l6.5">   message.ctcp = {};</span>
<a href="#l6.6"></a><span id="l6.6">   message.ctcp.rawMessage = aRawCTCPMessage;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   // High/CTCP level dequote: replace the quote char \134 followed by a or \134</span>
<a href="#l6.9"></a><span id="l6.9">   // with \001 or \134, respectively. Any other character after \134 is replaced</span>
<a href="#l6.10"></a><span id="l6.10">   // with itself.</span>
<a href="#l6.11"></a><span id="l6.11">   let dequotedCTCPMessage = message.ctcp.rawMessage.replace(/\\(.|$)/g,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    function(aStr) aStr[1] ? (aStr[1] == &quot;a&quot; ? &quot;\x01&quot; : aStr[1]) : &quot;&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    aStr =&gt; aStr[1] ? (aStr[1] == &quot;a&quot; ? &quot;\x01&quot; : aStr[1]) : &quot;&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">   let separator = dequotedCTCPMessage.indexOf(&quot; &quot;);</span>
<a href="#l6.16"></a><span id="l6.16">   // If there's no space, then only a command is given.</span>
<a href="#l6.17"></a><span id="l6.17">   // Do not capitalize the command, case sensitive</span>
<a href="#l6.18"></a><span id="l6.18">   if (separator == -1) {</span>
<a href="#l6.19"></a><span id="l6.19">     message.ctcp.command = dequotedCTCPMessage;</span>
<a href="#l6.20"></a><span id="l6.20">     message.ctcp.param = &quot;&quot;;</span>
<a href="#l6.21"></a><span id="l6.21">   }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -46,17 +46,17 @@ function CTCPMessage(aMessage, aRawCTCPM</span>
<a href="#l6.23"></a><span id="l6.23"> }</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> // This is the CTCP handler for IRC protocol, it will call each CTCP handler.</span>
<a href="#l6.27"></a><span id="l6.27"> var ircCTCP = {</span>
<a href="#l6.28"></a><span id="l6.28">   name: &quot;CTCP&quot;,</span>
<a href="#l6.29"></a><span id="l6.29">   // Slightly above default RFC 2812 priority.</span>
<a href="#l6.30"></a><span id="l6.30">   priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // CTCP uses only PRIVMSG and NOTICE commands.</span>
<a href="#l6.35"></a><span id="l6.35">   commands: {</span>
<a href="#l6.36"></a><span id="l6.36">     &quot;PRIVMSG&quot;: ctcpHandleMessage,</span>
<a href="#l6.37"></a><span id="l6.37">     &quot;NOTICE&quot;: ctcpHandleMessage</span>
<a href="#l6.38"></a><span id="l6.38">   }</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> // Parse the message and call all CTCP handlers on the message.</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -108,17 +108,17 @@ function ctcpHandleMessage(aMessage) {</span>
<a href="#l6.42"></a><span id="l6.42">   return true;</span>
<a href="#l6.43"></a><span id="l6.43"> }</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45"> // This is the the basic CTCP protocol.</span>
<a href="#l6.46"></a><span id="l6.46"> var ctcpBase = {</span>
<a href="#l6.47"></a><span id="l6.47">   // Parameters</span>
<a href="#l6.48"></a><span id="l6.48">   name: &quot;CTCP&quot;,</span>
<a href="#l6.49"></a><span id="l6.49">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   // These represent CTCP commands.</span>
<a href="#l6.54"></a><span id="l6.54">   commands: {</span>
<a href="#l6.55"></a><span id="l6.55">     &quot;ACTION&quot;: function(aMessage) {</span>
<a href="#l6.56"></a><span id="l6.56">       // ACTION &lt;text&gt;</span>
<a href="#l6.57"></a><span id="l6.57">       // Display message in conversation</span>
<a href="#l6.58"></a><span id="l6.58">       this.getConversation(this.isMUCName(aMessage.params[0]) ?</span>
<a href="#l6.59"></a><span id="l6.59">                              aMessage.params[0] : aMessage.origin)</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineat">@@ -133,17 +133,17 @@ var ctcpBase = {</span>
<a href="#l6.61"></a><span id="l6.61">                 aMessage.ctcp.param);</span>
<a href="#l6.62"></a><span id="l6.62">       return true;</span>
<a href="#l6.63"></a><span id="l6.63">     },</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">     // This is commented out since CLIENTINFO automatically returns the</span>
<a href="#l6.66"></a><span id="l6.66">     // supported CTCP parameters and this is not supported.</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">     // Returns the user's full name, and idle time.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    //&quot;FINGER&quot;: function(aMessage) false,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    //&quot;FINGER&quot;: function(aMessage) { return false; },</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">     // Dynamic master index of what a client knows.</span>
<a href="#l6.73"></a><span id="l6.73">     &quot;CLIENTINFO&quot;: function(aMessage) {</span>
<a href="#l6.74"></a><span id="l6.74">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l6.75"></a><span id="l6.75">         // Received a CLIENTINFO request, respond with the support CTCP</span>
<a href="#l6.76"></a><span id="l6.76">         // messages.</span>
<a href="#l6.77"></a><span id="l6.77">         let info = new Set();</span>
<a href="#l6.78"></a><span id="l6.78">         for (let handler of ircHandlers._ctcpHandlers) {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineat">@@ -180,20 +180,20 @@ var ctcpBase = {</span>
<a href="#l6.80"></a><span id="l6.80">       else</span>
<a href="#l6.81"></a><span id="l6.81">         return this.handlePingReply(aMessage.origin, aMessage.ctcp.param);</span>
<a href="#l6.82"></a><span id="l6.82">     },</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">     // These are commented out since CLIENTINFO automatically returns the</span>
<a href="#l6.85"></a><span id="l6.85">     // supported CTCP parameters and this is not supported.</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">     // An encryption protocol between clients without any known reference.</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    //&quot;SED&quot;: function(aMessage) false,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    //&quot;SED&quot;: function(aMessage) { return false; },</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91">     // Where to obtain a copy of a client.</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    //&quot;SOURCE&quot;: function(aMessage) false,</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    //&quot;SOURCE&quot;: function(aMessage) { return false; },</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95">     // Gets the local date and time from other clients.</span>
<a href="#l6.96"></a><span id="l6.96">     &quot;TIME&quot;: function(aMessage) {</span>
<a href="#l6.97"></a><span id="l6.97">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l6.98"></a><span id="l6.98">         // TIME</span>
<a href="#l6.99"></a><span id="l6.99">         // Received a TIME request, send a human readable response.</span>
<a href="#l6.100"></a><span id="l6.100">         let now = (new Date()).toString();</span>
<a href="#l6.101"></a><span id="l6.101">         this.LOG(&quot;Received TIME request from &quot; + aMessage.origin +</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineat">@@ -212,17 +212,17 @@ var ctcpBase = {</span>
<a href="#l6.103"></a><span id="l6.103">       }</span>
<a href="#l6.104"></a><span id="l6.104">       return true;</span>
<a href="#l6.105"></a><span id="l6.105">     },</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">     // This is commented out since CLIENTINFO automatically returns the</span>
<a href="#l6.108"></a><span id="l6.108">     // supported CTCP parameters and this is not supported.</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110">     // A string set by the user (never the client coder)</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    //&quot;USERINFO&quot;: function(aMessage) false,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    //&quot;USERINFO&quot;: function(aMessage) { return false; },</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114">     // The version and type of the client.</span>
<a href="#l6.115"></a><span id="l6.115">     &quot;VERSION&quot;: function(aMessage) {</span>
<a href="#l6.116"></a><span id="l6.116">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l6.117"></a><span id="l6.117">         // VERSION</span>
<a href="#l6.118"></a><span id="l6.118">         // Received VERSION request, send VERSION response.</span>
<a href="#l6.119"></a><span id="l6.119">         let version = Services.appinfo.name + &quot; &quot; + Services.appinfo.version;</span>
<a href="#l6.120"></a><span id="l6.120">         this.LOG(&quot;Received VERSION request from &quot; + aMessage.origin +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,23 +7,23 @@</span>
<a href="#l7.4"></a><span id="l7.4"> const EXPORTED_SYMBOLS = [&quot;commands&quot;];</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l7.9"></a><span id="l7.9"> Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> // Shortcut to get the JavaScript conversation object.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function getConv(aConv) aConv.wrappedJSObject;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+function getConv(aConv) { return aConv.wrappedJSObject; };</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> // Shortcut to get the JavaScript account object.</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-function getAccount(aConv) getConv(aConv)._account;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+function getAccount(aConv) { return getConv(aConv)._account; };</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> // Trim leading and trailing spaces and split a string by any type of space.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-function splitInput(aString) aString.trim().split(/\s+/);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+function splitInput(aString) { return aString.trim().split(/\s+/); };</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> function OutgoingMessage(aMsg, aConversation, aAction) {</span>
<a href="#l7.24"></a><span id="l7.24">   this.message = aMsg;</span>
<a href="#l7.25"></a><span id="l7.25">   this.conversation = aConversation;</span>
<a href="#l7.26"></a><span id="l7.26">   this.action = !!aAction;</span>
<a href="#l7.27"></a><span id="l7.27"> }</span>
<a href="#l7.28"></a><span id="l7.28"> OutgoingMessage.prototype = {</span>
<a href="#l7.29"></a><span id="l7.29">   __proto__: ClassInfo(&quot;imIOutgoingMessage&quot;, &quot;Outgoing Message&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -85,17 +85,17 @@ function messageCommand(aMsg, aConv, aRe</span>
<a href="#l7.31"></a><span id="l7.31"> }</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33"> // aAdd is true to add a mode, false to remove a mode.</span>
<a href="#l7.34"></a><span id="l7.34"> function setMode(aNickname, aConv, aMode, aAdd) {</span>
<a href="#l7.35"></a><span id="l7.35">   if (!aNickname.length)</span>
<a href="#l7.36"></a><span id="l7.36">     return false;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">   // Change the mode for each nick, as separator by spaces.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  return splitInput(aNickname).every(function(aNick)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  return splitInput(aNickname).every(aNick =&gt;</span>
<a href="#l7.41"></a><span id="l7.41">     simpleCommand(aConv, &quot;MODE&quot;,</span>
<a href="#l7.42"></a><span id="l7.42">                   [aConv.name, (aAdd ? &quot;+&quot; : &quot;-&quot;) + aMode, aNick]));</span>
<a href="#l7.43"></a><span id="l7.43"> }</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45"> function actionCommand(aMsg, aConv) {</span>
<a href="#l7.46"></a><span id="l7.46">   // Don't try to send an empty action.</span>
<a href="#l7.47"></a><span id="l7.47">   if (!aMsg || !aMsg.trim().length)</span>
<a href="#l7.48"></a><span id="l7.48">     return false;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineat">@@ -142,62 +142,63 @@ function simpleCommand(aConv, aCommand, </span>
<a href="#l7.50"></a><span id="l7.50">     getAccount(aConv).sendMessage(aCommand);</span>
<a href="#l7.51"></a><span id="l7.51">   else</span>
<a href="#l7.52"></a><span id="l7.52">     getAccount(aConv).sendMessage(aCommand, aParams);</span>
<a href="#l7.53"></a><span id="l7.53">   return true;</span>
<a href="#l7.54"></a><span id="l7.54"> }</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56"> // Sends a CTCP message to aTarget using the CTCP command aCommand and aMsg as</span>
<a href="#l7.57"></a><span id="l7.57"> // a CTCP paramter.</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-function ctcpCommand(aConv, aTarget, aCommand, aParams)</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  getAccount(aConv).sendCTCPMessage(aTarget, false, aCommand, aParams)</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+function ctcpCommand(aConv, aTarget, aCommand, aParams) {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  return getAccount(aConv).sendCTCPMessage(aTarget, false, aCommand, aParams);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+}</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64"> // Replace the command name in the help string so translators do not attempt to</span>
<a href="#l7.65"></a><span id="l7.65"> // translate it.</span>
<a href="#l7.66"></a><span id="l7.66"> var commands = [</span>
<a href="#l7.67"></a><span id="l7.67">   {</span>
<a href="#l7.68"></a><span id="l7.68">     name: &quot;action&quot;,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    get helpString() _(&quot;command.action&quot;, &quot;action&quot;),</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    get helpString() { return _(&quot;command.action&quot;, &quot;action&quot;); },</span>
<a href="#l7.71"></a><span id="l7.71">     run: actionCommand</span>
<a href="#l7.72"></a><span id="l7.72">   },</span>
<a href="#l7.73"></a><span id="l7.73">   {</span>
<a href="#l7.74"></a><span id="l7.74">     name: &quot;ctcp&quot;,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    get helpString() _(&quot;command.ctcp&quot;, &quot;ctcp&quot;),</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    get helpString() { return _(&quot;command.ctcp&quot;, &quot;ctcp&quot;); },</span>
<a href="#l7.77"></a><span id="l7.77">     run: function(aMsg, aConv) {</span>
<a href="#l7.78"></a><span id="l7.78">       let separator = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l7.79"></a><span id="l7.79">       // Ensure we have two non-empty parameters.</span>
<a href="#l7.80"></a><span id="l7.80">       if (separator &lt; 1 || (separator + 1) == aMsg.length)</span>
<a href="#l7.81"></a><span id="l7.81">         return false;</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">       // The first word is used as the target, the rest is used as CTCP command</span>
<a href="#l7.84"></a><span id="l7.84">       // and parameters.</span>
<a href="#l7.85"></a><span id="l7.85">       ctcpCommand(aConv, aMsg.slice(0, separator), aMsg.slice(separator + 1));</span>
<a href="#l7.86"></a><span id="l7.86">       return true;</span>
<a href="#l7.87"></a><span id="l7.87">     }</span>
<a href="#l7.88"></a><span id="l7.88">   },</span>
<a href="#l7.89"></a><span id="l7.89">   {</span>
<a href="#l7.90"></a><span id="l7.90">     name: &quot;chanserv&quot;,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-    get helpString() _(&quot;command.chanserv&quot;, &quot;chanserv&quot;),</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;ChanServ&quot;)</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    get helpString() { return _(&quot;command.chanserv&quot;, &quot;chanserv&quot;); },</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;ChanServ&quot;)</span>
<a href="#l7.95"></a><span id="l7.95">   },</span>
<a href="#l7.96"></a><span id="l7.96">   {</span>
<a href="#l7.97"></a><span id="l7.97">     name: &quot;deop&quot;,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    get helpString() _(&quot;command.deop&quot;, &quot;deop&quot;),</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    get helpString() { return _(&quot;command.deop&quot;, &quot;deop&quot;); },</span>
<a href="#l7.100"></a><span id="l7.100">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;o&quot;, false)</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;o&quot;, false)</span>
<a href="#l7.103"></a><span id="l7.103">   },</span>
<a href="#l7.104"></a><span id="l7.104">   {</span>
<a href="#l7.105"></a><span id="l7.105">     name: &quot;devoice&quot;,</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    get helpString() _(&quot;command.devoice&quot;, &quot;devoice&quot;),</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    get helpString() { return _(&quot;command.devoice&quot;, &quot;devoice&quot;); },</span>
<a href="#l7.108"></a><span id="l7.108">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;v&quot;, false)</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;v&quot;, false)</span>
<a href="#l7.111"></a><span id="l7.111">   },</span>
<a href="#l7.112"></a><span id="l7.112">   {</span>
<a href="#l7.113"></a><span id="l7.113">     name: &quot;invite&quot;,</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    get helpString() _(&quot;command.invite2&quot;, &quot;invite&quot;),</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    get helpString() { return _(&quot;command.invite2&quot;, &quot;invite&quot;); },</span>
<a href="#l7.116"></a><span id="l7.116">     run: function(aMsg, aConv) {</span>
<a href="#l7.117"></a><span id="l7.117">       let params = splitInput(aMsg);</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119">       // Try to find one, and only one, channel in the list of parameters.</span>
<a href="#l7.120"></a><span id="l7.120">       let channel;</span>
<a href="#l7.121"></a><span id="l7.121">       let account = getAccount(aConv);</span>
<a href="#l7.122"></a><span id="l7.122">       // Find the first param that could be a channel name.</span>
<a href="#l7.123"></a><span id="l7.123">       for (let i = 0; i &lt; params.length; ++i) {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineat">@@ -214,24 +215,24 @@ var commands = [</span>
<a href="#l7.125"></a><span id="l7.125">       // If no parameters or only a channel are given.</span>
<a href="#l7.126"></a><span id="l7.126">       if (!params[0].length)</span>
<a href="#l7.127"></a><span id="l7.127">         return false;</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129">       // Default to using the current conversation as the channel to invite to.</span>
<a href="#l7.130"></a><span id="l7.130">       if (!channel)</span>
<a href="#l7.131"></a><span id="l7.131">         channel = aConv.name;</span>
<a href="#l7.132"></a><span id="l7.132"> </span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      params.forEach(function(p)</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+      params.forEach(p =&gt;</span>
<a href="#l7.135"></a><span id="l7.135">         simpleCommand(aConv, &quot;INVITE&quot;, [p, channel]));</span>
<a href="#l7.136"></a><span id="l7.136">       return true;</span>
<a href="#l7.137"></a><span id="l7.137">     }</span>
<a href="#l7.138"></a><span id="l7.138">   },</span>
<a href="#l7.139"></a><span id="l7.139">   {</span>
<a href="#l7.140"></a><span id="l7.140">     name: &quot;join&quot;,</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-    get helpString() _(&quot;command.join&quot;, &quot;join&quot;),</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    get helpString() { return _(&quot;command.join&quot;, &quot;join&quot;); },</span>
<a href="#l7.143"></a><span id="l7.143">     run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l7.144"></a><span id="l7.144">       let params = aMsg.trim().split(/,\s*/);</span>
<a href="#l7.145"></a><span id="l7.145">       let account = getAccount(aConv);</span>
<a href="#l7.146"></a><span id="l7.146">       let conv;</span>
<a href="#l7.147"></a><span id="l7.147">       if (!params[0]) {</span>
<a href="#l7.148"></a><span id="l7.148">         conv = getConv(aConv);</span>
<a href="#l7.149"></a><span id="l7.149">         if (!conv.isChat || !conv.left)</span>
<a href="#l7.150"></a><span id="l7.150">           return false;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineat">@@ -252,23 +253,23 @@ var commands = [</span>
<a href="#l7.152"></a><span id="l7.152">       });</span>
<a href="#l7.153"></a><span id="l7.153">       if (aReturnedConv)</span>
<a href="#l7.154"></a><span id="l7.154">         aReturnedConv.value = conv;</span>
<a href="#l7.155"></a><span id="l7.155">       return true;</span>
<a href="#l7.156"></a><span id="l7.156">     }</span>
<a href="#l7.157"></a><span id="l7.157">   },</span>
<a href="#l7.158"></a><span id="l7.158">   {</span>
<a href="#l7.159"></a><span id="l7.159">     name: &quot;kick&quot;,</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-    get helpString() _(&quot;command.kick&quot;, &quot;kick&quot;),</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    get helpString() { return _(&quot;command.kick&quot;, &quot;kick&quot;); },</span>
<a href="#l7.162"></a><span id="l7.162">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.163"></a><span id="l7.163">     run: kickCommand</span>
<a href="#l7.164"></a><span id="l7.164">   },</span>
<a href="#l7.165"></a><span id="l7.165">   {</span>
<a href="#l7.166"></a><span id="l7.166">     name: &quot;list&quot;,</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    get helpString() _(&quot;command.list&quot;, &quot;list&quot;),</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    get helpString() { return _(&quot;command.list&quot;, &quot;list&quot;); },</span>
<a href="#l7.169"></a><span id="l7.169">     run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l7.170"></a><span id="l7.170">       let account = getAccount(aConv);</span>
<a href="#l7.171"></a><span id="l7.171">       let serverName = account._currentServerName;</span>
<a href="#l7.172"></a><span id="l7.172">       let serverConv = account.getConversation(serverName);</span>
<a href="#l7.173"></a><span id="l7.173">       account.requestRoomInfo({onRoomInfoAvailable: function(aRooms) {</span>
<a href="#l7.174"></a><span id="l7.174">         aRooms.forEach(function(aRoom) {</span>
<a href="#l7.175"></a><span id="l7.175">           serverConv.writeMessage(serverName,</span>
<a href="#l7.176"></a><span id="l7.176">                                   aRoom.name +</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineat">@@ -279,30 +280,32 @@ var commands = [</span>
<a href="#l7.178"></a><span id="l7.178">       }}, true);</span>
<a href="#l7.179"></a><span id="l7.179">       if (aReturnedConv)</span>
<a href="#l7.180"></a><span id="l7.180">         aReturnedConv.value = serverConv;</span>
<a href="#l7.181"></a><span id="l7.181">       return true;</span>
<a href="#l7.182"></a><span id="l7.182">     }</span>
<a href="#l7.183"></a><span id="l7.183">   },</span>
<a href="#l7.184"></a><span id="l7.184">   {</span>
<a href="#l7.185"></a><span id="l7.185">     name: &quot;me&quot;,</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    get helpString() _(&quot;command.action&quot;, &quot;me&quot;),</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    get helpString() { return _(&quot;command.action&quot;, &quot;me&quot;); },</span>
<a href="#l7.188"></a><span id="l7.188">     run: actionCommand</span>
<a href="#l7.189"></a><span id="l7.189">   },</span>
<a href="#l7.190"></a><span id="l7.190">   {</span>
<a href="#l7.191"></a><span id="l7.191">     name: &quot;memoserv&quot;,</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-    get helpString() _(&quot;command.memoserv&quot;, &quot;memoserv&quot;),</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;MemoServ&quot;)</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    get helpString() { return _(&quot;command.memoserv&quot;, &quot;memoserv&quot;); },</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;MemoServ&quot;)</span>
<a href="#l7.196"></a><span id="l7.196">   },</span>
<a href="#l7.197"></a><span id="l7.197">   {</span>
<a href="#l7.198"></a><span id="l7.198">     name: &quot;mode&quot;,</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-    get helpString() _(&quot;command.modeUser&quot;, &quot;mode&quot;) + &quot;\n&quot; +</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-                     _(&quot;command.modeChannel&quot;, &quot;mode&quot;),</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    get helpString() {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      return _(&quot;command.modeUser&quot;, &quot;mode&quot;) + &quot;\n&quot; +</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+             _(&quot;command.modeChannel&quot;, &quot;mode&quot;);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    },</span>
<a href="#l7.205"></a><span id="l7.205">     run: function(aMsg, aConv) {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-      function isMode(aString) &quot;+-&quot;.includes(aString[0]);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      function isMode(aString) { return &quot;+-&quot;.includes(aString[0]); }</span>
<a href="#l7.208"></a><span id="l7.208">       let params = splitInput(aMsg);</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210">       // Check if we have any params, we can't just check params.length, since</span>
<a href="#l7.211"></a><span id="l7.211">       // that will always be at least 1 (but params[0] would be empty).</span>
<a href="#l7.212"></a><span id="l7.212">       let hasParams = !/^\s*$/.test(aMsg);</span>
<a href="#l7.213"></a><span id="l7.213">       let account = getAccount(aConv);</span>
<a href="#l7.214"></a><span id="l7.214">       // These must be false if we don't have any paramters!</span>
<a href="#l7.215"></a><span id="l7.215">       let isChannelName = hasParams &amp;&amp; account.isMUCName(params[0]);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineat">@@ -338,165 +341,165 @@ var commands = [</span>
<a href="#l7.217"></a><span id="l7.217">       else if (!(isChannelName &amp;&amp; isMode(params[1])))</span>
<a href="#l7.218"></a><span id="l7.218">         return false;</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220">       return simpleCommand(aConv, &quot;MODE&quot;, params);</span>
<a href="#l7.221"></a><span id="l7.221">     }</span>
<a href="#l7.222"></a><span id="l7.222">   },</span>
<a href="#l7.223"></a><span id="l7.223">   {</span>
<a href="#l7.224"></a><span id="l7.224">     name: &quot;msg&quot;,</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-    get helpString() _(&quot;command.msg&quot;, &quot;msg&quot;),</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    get helpString() { return _(&quot;command.msg&quot;, &quot;msg&quot;); },</span>
<a href="#l7.227"></a><span id="l7.227">     run: messageCommand</span>
<a href="#l7.228"></a><span id="l7.228">   },</span>
<a href="#l7.229"></a><span id="l7.229">   {</span>
<a href="#l7.230"></a><span id="l7.230">     name: &quot;nick&quot;,</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    get helpString() _(&quot;command.nick&quot;, &quot;nick&quot;),</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    get helpString() { return _(&quot;command.nick&quot;, &quot;nick&quot;); },</span>
<a href="#l7.233"></a><span id="l7.233">     run: function(aMsg, aConv) {</span>
<a href="#l7.234"></a><span id="l7.234">       let newNick = aMsg.trim();</span>
<a href="#l7.235"></a><span id="l7.235">       if (newNick.indexOf(/\s+/) != -1)</span>
<a href="#l7.236"></a><span id="l7.236">         return false;</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238">       let account = getAccount(aConv)</span>
<a href="#l7.239"></a><span id="l7.239">       // The user wants to change their nick, so overwrite the account</span>
<a href="#l7.240"></a><span id="l7.240">       // nickname for this session.</span>
<a href="#l7.241"></a><span id="l7.241">       account._requestedNickname = newNick;</span>
<a href="#l7.242"></a><span id="l7.242">       account.changeNick(newNick);</span>
<a href="#l7.243"></a><span id="l7.243"> </span>
<a href="#l7.244"></a><span id="l7.244">       return true;</span>
<a href="#l7.245"></a><span id="l7.245">     }</span>
<a href="#l7.246"></a><span id="l7.246">   },</span>
<a href="#l7.247"></a><span id="l7.247">   {</span>
<a href="#l7.248"></a><span id="l7.248">     name: &quot;nickserv&quot;,</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    get helpString() _(&quot;command.nickserv&quot;, &quot;nickserv&quot;),</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;NickServ&quot;)</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    get helpString() { return _(&quot;command.nickserv&quot;, &quot;nickserv&quot;); },</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;NickServ&quot;)</span>
<a href="#l7.253"></a><span id="l7.253">   },</span>
<a href="#l7.254"></a><span id="l7.254">   {</span>
<a href="#l7.255"></a><span id="l7.255">     name: &quot;notice&quot;,</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    get helpString() _(&quot;command.notice&quot;, &quot;notice&quot;),</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-    run: function(aMsg, aConv, aReturnedConv)</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+    get helpString() { return _(&quot;command.notice&quot;, &quot;notice&quot;); },</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    run: (aMsg, aConv, aReturnedConv) =&gt;</span>
<a href="#l7.260"></a><span id="l7.260">       messageCommand(aMsg, aConv, aReturnedConv, true)</span>
<a href="#l7.261"></a><span id="l7.261">   },</span>
<a href="#l7.262"></a><span id="l7.262">   {</span>
<a href="#l7.263"></a><span id="l7.263">     name: &quot;op&quot;,</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    get helpString() _(&quot;command.op&quot;, &quot;op&quot;),</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+    get helpString() { return _(&quot;command.op&quot;, &quot;op&quot;); },</span>
<a href="#l7.266"></a><span id="l7.266">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;o&quot;, true)</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+    run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;o&quot;, true)</span>
<a href="#l7.269"></a><span id="l7.269">   },</span>
<a href="#l7.270"></a><span id="l7.270">   {</span>
<a href="#l7.271"></a><span id="l7.271">     name: &quot;operserv&quot;,</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-    get helpString() _(&quot;command.operserv&quot;, &quot;operserv&quot;),</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;OperServ&quot;)</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+    get helpString() { return _(&quot;command.operserv&quot;, &quot;operserv&quot;); },</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+    run: (aMsg, aConv) =&gt; privateMessage(aConv, aMsg, &quot;OperServ&quot;)</span>
<a href="#l7.276"></a><span id="l7.276">   },</span>
<a href="#l7.277"></a><span id="l7.277">   {</span>
<a href="#l7.278"></a><span id="l7.278">     name: &quot;part&quot;,</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    get helpString() _(&quot;command.part&quot;, &quot;part&quot;),</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    get helpString() { return _(&quot;command.part&quot;, &quot;part&quot;); },</span>
<a href="#l7.281"></a><span id="l7.281">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.282"></a><span id="l7.282">     run: function (aMsg, aConv) {</span>
<a href="#l7.283"></a><span id="l7.283">       getConv(aConv).part(aMsg);</span>
<a href="#l7.284"></a><span id="l7.284">       return true;</span>
<a href="#l7.285"></a><span id="l7.285">     }</span>
<a href="#l7.286"></a><span id="l7.286">   },</span>
<a href="#l7.287"></a><span id="l7.287">   {</span>
<a href="#l7.288"></a><span id="l7.288">     name: &quot;ping&quot;,</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-    get helpString() _(&quot;command.ping&quot;, &quot;ping&quot;),</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+    get helpString() { return _(&quot;command.ping&quot;, &quot;ping&quot;); },</span>
<a href="#l7.291"></a><span id="l7.291">     run: function(aMsg, aConv) {</span>
<a href="#l7.292"></a><span id="l7.292">       // Send a ping to the entered nick using the current time (in</span>
<a href="#l7.293"></a><span id="l7.293">       // milliseconds) as the param. If no nick is entered, ping the</span>
<a href="#l7.294"></a><span id="l7.294">       // server.</span>
<a href="#l7.295"></a><span id="l7.295">       if (aMsg &amp;&amp; aMsg.trim().length)</span>
<a href="#l7.296"></a><span id="l7.296">         ctcpCommand(aConv, aMsg, &quot;PING&quot;, Date.now());</span>
<a href="#l7.297"></a><span id="l7.297">       else</span>
<a href="#l7.298"></a><span id="l7.298">         getAccount(aConv).sendMessage(&quot;PING&quot;, Date.now());</span>
<a href="#l7.299"></a><span id="l7.299"> </span>
<a href="#l7.300"></a><span id="l7.300">       return true;</span>
<a href="#l7.301"></a><span id="l7.301">     }</span>
<a href="#l7.302"></a><span id="l7.302">   },</span>
<a href="#l7.303"></a><span id="l7.303">   {</span>
<a href="#l7.304"></a><span id="l7.304">     name: &quot;query&quot;,</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    get helpString() _(&quot;command.msg&quot;, &quot;query&quot;),</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+    get helpString() { return _(&quot;command.msg&quot;, &quot;query&quot;); },</span>
<a href="#l7.307"></a><span id="l7.307">     run: messageCommand</span>
<a href="#l7.308"></a><span id="l7.308">   },</span>
<a href="#l7.309"></a><span id="l7.309">   {</span>
<a href="#l7.310"></a><span id="l7.310">     name: &quot;quit&quot;,</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-    get helpString() _(&quot;command.quit&quot;, &quot;quit&quot;),</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+    get helpString() { return _(&quot;command.quit&quot;, &quot;quit&quot;); },</span>
<a href="#l7.313"></a><span id="l7.313">     run: function(aMsg, aConv) {</span>
<a href="#l7.314"></a><span id="l7.314">       let account = getAccount(aConv);</span>
<a href="#l7.315"></a><span id="l7.315">       account.disconnect(aMsg);</span>
<a href="#l7.316"></a><span id="l7.316">       // While prpls shouldn't usually touch imAccount, this disconnection</span>
<a href="#l7.317"></a><span id="l7.317">       // is an action the user requested via the UI. Without this call,</span>
<a href="#l7.318"></a><span id="l7.318">       // the imAccount would immediately reconnect the account.</span>
<a href="#l7.319"></a><span id="l7.319">       account.imAccount.disconnect();</span>
<a href="#l7.320"></a><span id="l7.320">       return true;</span>
<a href="#l7.321"></a><span id="l7.321">     }</span>
<a href="#l7.322"></a><span id="l7.322">   },</span>
<a href="#l7.323"></a><span id="l7.323">   {</span>
<a href="#l7.324"></a><span id="l7.324">     name: &quot;quote&quot;,</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-    get helpString() _(&quot;command.quote&quot;, &quot;quote&quot;),</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+    get helpString() { return _(&quot;command.quote&quot;, &quot;quote&quot;); },</span>
<a href="#l7.327"></a><span id="l7.327">     run: function(aMsg, aConv) {</span>
<a href="#l7.328"></a><span id="l7.328">       if (!aMsg.length)</span>
<a href="#l7.329"></a><span id="l7.329">         return false;</span>
<a href="#l7.330"></a><span id="l7.330"> </span>
<a href="#l7.331"></a><span id="l7.331">       getAccount(aConv).sendRawMessage(aMsg);</span>
<a href="#l7.332"></a><span id="l7.332">       return true;</span>
<a href="#l7.333"></a><span id="l7.333">     }</span>
<a href="#l7.334"></a><span id="l7.334">   },</span>
<a href="#l7.335"></a><span id="l7.335">   {</span>
<a href="#l7.336"></a><span id="l7.336">     name: &quot;remove&quot;,</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    get helpString() _(&quot;command.kick&quot;, &quot;remove&quot;),</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+    get helpString() { return _(&quot;command.kick&quot;, &quot;remove&quot;); },</span>
<a href="#l7.339"></a><span id="l7.339">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.340"></a><span id="l7.340">     run: kickCommand</span>
<a href="#l7.341"></a><span id="l7.341">   },</span>
<a href="#l7.342"></a><span id="l7.342">   {</span>
<a href="#l7.343"></a><span id="l7.343">     name: &quot;time&quot;,</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    get helpString() _(&quot;command.time&quot;, &quot;time&quot;),</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+    get helpString() { return _(&quot;command.time&quot;, &quot;time&quot;); },</span>
<a href="#l7.346"></a><span id="l7.346">     run: function(aMsg, aConv) {</span>
<a href="#l7.347"></a><span id="l7.347">       // Send a time command to the entered nick using the current time (in</span>
<a href="#l7.348"></a><span id="l7.348">       // milliseconds) as the param. If no nick is entered, get the current</span>
<a href="#l7.349"></a><span id="l7.349">       // server time.</span>
<a href="#l7.350"></a><span id="l7.350">       if (aMsg &amp;&amp; aMsg.trim().length)</span>
<a href="#l7.351"></a><span id="l7.351">         ctcpCommand(aConv, aMsg, &quot;TIME&quot;);</span>
<a href="#l7.352"></a><span id="l7.352">       else</span>
<a href="#l7.353"></a><span id="l7.353">         getAccount(aConv).sendMessage(&quot;TIME&quot;);</span>
<a href="#l7.354"></a><span id="l7.354"> </span>
<a href="#l7.355"></a><span id="l7.355">       return true;</span>
<a href="#l7.356"></a><span id="l7.356">     }</span>
<a href="#l7.357"></a><span id="l7.357">   },</span>
<a href="#l7.358"></a><span id="l7.358">   {</span>
<a href="#l7.359"></a><span id="l7.359">     name: &quot;topic&quot;,</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-    get helpString() _(&quot;command.topic&quot;, &quot;topic&quot;),</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+    get helpString() { return _(&quot;command.topic&quot;, &quot;topic&quot;); },</span>
<a href="#l7.362"></a><span id="l7.362">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.363"></a><span id="l7.363">     run: function(aMsg, aConv) {</span>
<a href="#l7.364"></a><span id="l7.364">       aConv.topic = aMsg;</span>
<a href="#l7.365"></a><span id="l7.365">       return true;</span>
<a href="#l7.366"></a><span id="l7.366">     }</span>
<a href="#l7.367"></a><span id="l7.367">   },</span>
<a href="#l7.368"></a><span id="l7.368">   {</span>
<a href="#l7.369"></a><span id="l7.369">     name: &quot;umode&quot;,</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    get helpString() _(&quot;command.umode&quot;, &quot;umode&quot;),</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-    run: function(aMsg, aConv) simpleCommand(aConv, &quot;MODE&quot;, aMsg)</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+    get helpString() { return _(&quot;command.umode&quot;, &quot;umode&quot;); },</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+    run: (aMsg, aConv) =&gt; simpleCommand(aConv, &quot;MODE&quot;, aMsg)</span>
<a href="#l7.374"></a><span id="l7.374">   },</span>
<a href="#l7.375"></a><span id="l7.375">   {</span>
<a href="#l7.376"></a><span id="l7.376">     name: &quot;version&quot;,</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-    get helpString() _(&quot;command.version&quot;, &quot;version&quot;),</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+    get helpString() { return _(&quot;command.version&quot;, &quot;version&quot;); },</span>
<a href="#l7.379"></a><span id="l7.379">     run: function(aMsg, aConv) {</span>
<a href="#l7.380"></a><span id="l7.380">       if (!aMsg || !aMsg.trim().length)</span>
<a href="#l7.381"></a><span id="l7.381">         return false;</span>
<a href="#l7.382"></a><span id="l7.382">       ctcpCommand(aConv, aMsg, &quot;VERSION&quot;);</span>
<a href="#l7.383"></a><span id="l7.383">       return true;</span>
<a href="#l7.384"></a><span id="l7.384">     }</span>
<a href="#l7.385"></a><span id="l7.385">   },</span>
<a href="#l7.386"></a><span id="l7.386">   {</span>
<a href="#l7.387"></a><span id="l7.387">     name: &quot;voice&quot;,</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-    get helpString() _(&quot;command.voice&quot;, &quot;voice&quot;),</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+    get helpString() { return _(&quot;command.voice&quot;, &quot;voice&quot;); },</span>
<a href="#l7.390"></a><span id="l7.390">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;v&quot;, true)</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+    run: (aMsg, aConv) =&gt; setMode(aMsg, aConv, &quot;v&quot;, true)</span>
<a href="#l7.393"></a><span id="l7.393">   },</span>
<a href="#l7.394"></a><span id="l7.394">   {</span>
<a href="#l7.395"></a><span id="l7.395">     name: &quot;whois&quot;,</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-    get helpString() _(&quot;command.whois2&quot;, &quot;whois&quot;),</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+    get helpString() { return _(&quot;command.whois2&quot;, &quot;whois&quot;); },</span>
<a href="#l7.398"></a><span id="l7.398">     run: function(aMsg, aConv) {</span>
<a href="#l7.399"></a><span id="l7.399">       // Note that this will automatically run whowas if the nick is offline.</span>
<a href="#l7.400"></a><span id="l7.400">       aMsg = aMsg.trim();</span>
<a href="#l7.401"></a><span id="l7.401">       // If multiple parameters are given, this is an error.</span>
<a href="#l7.402"></a><span id="l7.402">       if (aMsg.includes(&quot; &quot;))</span>
<a href="#l7.403"></a><span id="l7.403">         return false;</span>
<a href="#l7.404"></a><span id="l7.404">       // If the user does not provide a nick, but is in a private conversation,</span>
<a href="#l7.405"></a><span id="l7.405">       // assume the user is trying to whois the person they are talking to.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -49,17 +49,17 @@ function DCCMessage(aMessage, aAccount) </span>
<a href="#l8.4"></a><span id="l8.4">   return message;</span>
<a href="#l8.5"></a><span id="l8.5"> }</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> // This is the DCC handler for CTCP, it will call each DCC handler.</span>
<a href="#l8.8"></a><span id="l8.8"> var ctcpDCC = {</span>
<a href="#l8.9"></a><span id="l8.9">   name: &quot;DCC&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">   // Slightly above default CTCP priority.</span>
<a href="#l8.11"></a><span id="l8.11">   priority: ircHandlers.HIGH_PRIORITY + 10,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   commands: {</span>
<a href="#l8.16"></a><span id="l8.16">     // Handle a DCC message by parsing the message and executing any handlers.</span>
<a href="#l8.17"></a><span id="l8.17">     &quot;DCC&quot;: function(aMessage) {</span>
<a href="#l8.18"></a><span id="l8.18">       // If there are no DCC handlers, then don't parse the DCC message.</span>
<a href="#l8.19"></a><span id="l8.19">       if (!ircHandlers.hasDCCHandlers)</span>
<a href="#l8.20"></a><span id="l8.20">         return false;</span>
<a href="#l8.21"></a><span id="l8.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -46,53 +46,65 @@ var ircHandlers = {</span>
<a href="#l9.4"></a><span id="l9.4">     }</span>
<a href="#l9.5"></a><span id="l9.5">     if (!(&quot;isEnabled&quot; in aHandler)) {</span>
<a href="#l9.6"></a><span id="l9.6">       Cu.reportError(new Error(&quot;IRC handlers must have a \&quot;isEnabled\&quot; &quot; +</span>
<a href="#l9.7"></a><span id="l9.7">                                &quot;property: &quot; + aHandler.name));</span>
<a href="#l9.8"></a><span id="l9.8">       return false;</span>
<a href="#l9.9"></a><span id="l9.9">     }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">     aArray.push(aHandler);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    aArray.sort(function(a, b) b.priority - a.priority);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    aArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l9.14"></a><span id="l9.14">     return true;</span>
<a href="#l9.15"></a><span id="l9.15">   },</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   _unregisterHandler: function(aArray, aHandler) {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    aArray = aArray.filter(function(h) h.name != aHandler.name);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    aArray = aArray.filter(h =&gt; h.name != aHandler.name);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  },</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  registerHandler: function(aHandler) {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    return this._registerHandler(this._ircHandlers, aHandler);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  },</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  unregisterHandler: function(aHandler) {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+    return this._unregisterHandler(this._ircHandlers, aHandler);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  },</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  registerISUPPORTHandler: function(aHandler) {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    return this._registerHandler(this._isupportHandlers, aHandler);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  },</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  unregisterISUPPORTHandler: function(aHandler) {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    return this._unregisterHandler(this._isupportHandlers, aHandler);</span>
<a href="#l9.34"></a><span id="l9.34">   },</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  registerHandler: function(aHandler)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    this._registerHandler(this._ircHandlers, aHandler),</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  unregisterHandler: function(aHandler)</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    this._unregisterHandler(this._ircHandlers, aHandler),</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  registerCAPHandler: function(aHandler) {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    return this._registerHandler(this._capHandlers, aHandler);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  },</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  unregisterCAPHandler: function(aHandler) {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    return this._unregisterHandler(this._capHandlers, aHandler);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  },</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  registerISUPPORTHandler: function(aHandler)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    this._registerHandler(this._isupportHandlers, aHandler),</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  unregisterISUPPORTHandler: function(aHandler)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-    this._unregisterHandler(this._isupportHandlers, aHandler),</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  registerCAPHandler: function(aHandler)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    this._registerHandler(this._capHandlers, aHandler),</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  unregisterCAPHandler: function(aHandler)</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    this._unregisterHandler(this._capHandlers, aHandler),</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  registerCTCPHandler: function(aHandler) {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    return this._registerHandler(this._ctcpHandlers, aHandler);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  },</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  unregisterCTCPHandler: function(aHandler) {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    return this._unregisterHandler(this._ctcpHandlers, aHandler);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  },</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  registerCTCPHandler: function(aHandler)</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    this._registerHandler(this._ctcpHandlers, aHandler),</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  unregisterCTCPHandler: function(aHandler)</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    this._unregisterHandler(this._ctcpHandlers, aHandler),</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  registerDCCHandler: function(aHandler) {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    return this._registerHandler(this._dccHandlers, aHandler);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  },</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  unregisterDCCHandler: function(aHandler) {</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    return this._unregisterHandler(this._dccHandlers, aHandler);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  },</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  registerDCCHandler: function(aHandler)</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    this._registerHandler(this._dccHandlers, aHandler),</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  unregisterDCCHandler: function(aHandler)</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    this._unregisterHandler(this._dccHandlers, aHandler),</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  registerServicesHandler: function(aHandler)</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    this._registerHandler(this._servicesHandlers, aHandler),</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  unregisterServicesHandler: function(aHandler)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-    this._unregisterHandler(this._servicesHandlers, aHandler),</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  registerServicesHandler: function(aHandler) {</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    return this._registerHandler(this._servicesHandlers, aHandler);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  },</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  unregisterServicesHandler: function(aHandler) {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    return this._unregisterHandler(this._servicesHandlers, aHandler);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  },</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">   // Handle a message based on a set of handlers.</span>
<a href="#l9.91"></a><span id="l9.91">   _handleMessage: function(aHandlers, aAccount, aMessage, aCommand) {</span>
<a href="#l9.92"></a><span id="l9.92">     // Loop over each handler and run the command until one handles the message.</span>
<a href="#l9.93"></a><span id="l9.93">     for each (let handler in aHandlers) {</span>
<a href="#l9.94"></a><span id="l9.94">       try {</span>
<a href="#l9.95"></a><span id="l9.95">         // Attempt to execute the command, by checking if the handler has the</span>
<a href="#l9.96"></a><span id="l9.96">         // command.</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineat">@@ -107,48 +119,54 @@ var ircHandlers = {</span>
<a href="#l9.98"></a><span id="l9.98">         aAccount.ERROR(&quot;Error running command &quot; + aCommand + &quot; with handler &quot; +</span>
<a href="#l9.99"></a><span id="l9.99">                        handler.name + &quot;:\n&quot; + JSON.stringify(aMessage), e);</span>
<a href="#l9.100"></a><span id="l9.100">       }</span>
<a href="#l9.101"></a><span id="l9.101">     }</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103">     return false;</span>
<a href="#l9.104"></a><span id="l9.104">   },</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  handleMessage: function(aAccount, aMessage)</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    this._handleMessage(this._ircHandlers, aAccount, aMessage,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-                        aMessage.command.toUpperCase()),</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  handleMessage: function(aAccount, aMessage) {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    return this._handleMessage(this._ircHandlers, aAccount, aMessage,</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+                               aMessage.command.toUpperCase());</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  },</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  handleISUPPORTMessage: function(aAccount, aMessage)</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    this._handleMessage(this._isupportHandlers, aAccount, aMessage,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-                        aMessage.isupport.parameter),</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  handleISUPPORTMessage: function(aAccount, aMessage) {</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    return this._handleMessage(this._isupportHandlers, aAccount, aMessage,</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+                               aMessage.isupport.parameter);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  },</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-  handleCAPMessage: function(aAccount, aMessage)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    this._handleMessage(this._capHandlers, aAccount, aMessage,</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-                        aMessage.cap.parameter),</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  handleCAPMessage: function(aAccount, aMessage) {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    return this._handleMessage(this._capHandlers, aAccount, aMessage,</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+                               aMessage.cap.parameter);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  },</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">   // aMessage is a CTCP Message, which inherits from an IRC Message.</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  handleCTCPMessage: function(aAccount, aMessage)</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-    this._handleMessage(this._ctcpHandlers, aAccount, aMessage,</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-                        aMessage.ctcp.command),</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+  handleCTCPMessage: function(aAccount, aMessage) {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+    return this._handleMessage(this._ctcpHandlers, aAccount, aMessage,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+                               aMessage.ctcp.command);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  },</span>
<a href="#l9.138"></a><span id="l9.138"> </span>
<a href="#l9.139"></a><span id="l9.139">   // aMessage is a DCC Message, which inherits from a CTCP Message.</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-  handleDCCMessage: function(aAccount, aMessage)</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-    this._handleMessage(this._dccHandlers, aAccount, aMessage,</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-                        aMessage.ctcp.dcc.type),</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  handleDCCMessage: function(aAccount, aMessage) {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+    return this._handleMessage(this._dccHandlers, aAccount, aMessage,</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+                               aMessage.ctcp.dcc.type);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  },</span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148">   // aMessage is a Services Message.</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-  handleServicesMessage: function(aAccount, aMessage)</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-    this._handleMessage(this._servicesHandlers, aAccount, aMessage,</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-                        aMessage.serviceName),</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+  handleServicesMessage: function(aAccount, aMessage) {</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    return this._handleMessage(this._servicesHandlers, aAccount, aMessage,</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+                               aMessage.serviceName);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  },</span>
<a href="#l9.156"></a><span id="l9.156"> </span>
<a href="#l9.157"></a><span id="l9.157">   // Checking if handlers exist.</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-  get hasHandlers() this._ircHandlers.length &gt; 0,</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-  get hasISUPPORTHandlers() this._isupportHandlers.length &gt; 0,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-  get hasCAPHandlers() this._capHandlers.length &gt; 0,</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  get hasCTCPHandlers() this._ctcpHandlers.length &gt; 0,</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  get hasDCCHandlers() this._dccHandlers.length &gt; 0,</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-  get hasServicesHandlers() this._servicesHandlers.length &gt; 0,</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  get hasHandlers() { return this._ircHandlers.length &gt; 0; },</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  get hasISUPPORTHandlers() { return this._isupportHandlers.length &gt; 0; },</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+  get hasCAPHandlers() { return this._capHandlers.length &gt; 0; },</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+  get hasCTCPHandlers() { return this._ctcpHandlers.length &gt; 0; },</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+  get hasDCCHandlers() { return this._dccHandlers.length &gt; 0; },</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  get hasServicesHandlers() { return this._servicesHandlers.length &gt; 0; },</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171">   // Some constant priorities.</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-  get LOW_PRIORITY() -100,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-  get DEFAULT_PRIORITY() 0,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-  get HIGH_PRIORITY() 100</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+  get LOW_PRIORITY() { return -100; },</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+  get DEFAULT_PRIORITY() { return 0; },</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+  get HIGH_PRIORITY() { return 100; }</span>
<a href="#l9.178"></a><span id="l9.178"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -45,30 +45,30 @@ function isupportMessage(aMessage, aToke</span>
<a href="#l10.4"></a><span id="l10.4">     return newMessage;</span>
<a href="#l10.5"></a><span id="l10.5">   });</span>
<a href="#l10.6"></a><span id="l10.6"> }</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> var ircISUPPORT = {</span>
<a href="#l10.9"></a><span id="l10.9">   name: &quot;ISUPPORT&quot;,</span>
<a href="#l10.10"></a><span id="l10.10">   // Slightly above default RFC 2812 priority.</span>
<a href="#l10.11"></a><span id="l10.11">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">   commands: {</span>
<a href="#l10.16"></a><span id="l10.16">     // RPL_ISUPPORT</span>
<a href="#l10.17"></a><span id="l10.17">     // [-]&lt;parameter&gt;[=&lt;value&gt;] :are supported by this server</span>
<a href="#l10.18"></a><span id="l10.18">     &quot;005&quot;: function(aMessage) {</span>
<a href="#l10.19"></a><span id="l10.19">       let messages = isupportMessage(aMessage);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-      messages = messages.filter(function(aMessage)</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-        !ircHandlers.handleISUPPORTMessage(this, aMessage), this);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+      messages = messages.filter(aMessage =&gt;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+        !ircHandlers.handleISUPPORTMessage(this, aMessage));</span>
<a href="#l10.25"></a><span id="l10.25">       if (messages.length) {</span>
<a href="#l10.26"></a><span id="l10.26">         // Display the list of unhandled ISUPPORT messages.</span>
<a href="#l10.27"></a><span id="l10.27">         let unhandledMessages =</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-          messages.map(function(aMsg) aMsg.isupport.parameter).join(&quot; &quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+          messages.map(aMsg =&gt; aMsg.isupport.parameter).join(&quot; &quot;);</span>
<a href="#l10.30"></a><span id="l10.30">         this.LOG(&quot;Unhandled ISUPPORT messages: &quot; + unhandledMessages +</span>
<a href="#l10.31"></a><span id="l10.31">                  &quot;\nRaw message: &quot; + aMessage.rawMessage);</span>
<a href="#l10.32"></a><span id="l10.32">       }</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">       return true;</span>
<a href="#l10.35"></a><span id="l10.35">     }</span>
<a href="#l10.36"></a><span id="l10.36">   }</span>
<a href="#l10.37"></a><span id="l10.37"> }</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineat">@@ -76,23 +76,24 @@ var ircISUPPORT = {</span>
<a href="#l10.39"></a><span id="l10.39"> function setSimpleNumber(aAccount, aField, aMessage, aDefaultValue) {</span>
<a href="#l10.40"></a><span id="l10.40">   let value =</span>
<a href="#l10.41"></a><span id="l10.41">     aMessage.isupport.value ? new Number(aMessage.isupport.value) : null;</span>
<a href="#l10.42"></a><span id="l10.42">   aAccount[aField] = (value &amp;&amp; !isNaN(value)) ? value : aDefaultValue;</span>
<a href="#l10.43"></a><span id="l10.43">   return true;</span>
<a href="#l10.44"></a><span id="l10.44"> }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46"> // Generates an expression to search for the ASCII range of a-b.</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-function generateNormalize(a, b)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  new RegExp(&quot;[\\x&quot; + a.toString(16) + &quot;-\\x&quot; + b.toString(16) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+function generateNormalize(a, b) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  return new RegExp(&quot;[\\x&quot; + a.toString(16) + &quot;-\\x&quot; + b.toString(16) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+}</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53"> var isupportBase = {</span>
<a href="#l10.54"></a><span id="l10.54">   name: &quot;ISUPPORT&quot;,</span>
<a href="#l10.55"></a><span id="l10.55">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">   commands: {</span>
<a href="#l10.60"></a><span id="l10.60">     &quot;CASEMAPPING&quot;: function(aMessage) {</span>
<a href="#l10.61"></a><span id="l10.61">       // CASEMAPPING=&lt;mapping&gt;</span>
<a href="#l10.62"></a><span id="l10.62">       // Allows the server to specify which method it uses to compare equality</span>
<a href="#l10.63"></a><span id="l10.63">       // of case-insensitive strings.</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">       // By default, use rfc1459 type case mapping.</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineat">@@ -126,39 +127,39 @@ var isupportBase = {</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">       let pairs = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l10.69"></a><span id="l10.69">       for each (let pair in pairs) {</span>
<a href="#l10.70"></a><span id="l10.70">         let [prefix, num] = pair.split(&quot;:&quot;);</span>
<a href="#l10.71"></a><span id="l10.71">         this.maxChannels[prefix] = num;</span>
<a href="#l10.72"></a><span id="l10.72">       }</span>
<a href="#l10.73"></a><span id="l10.73">       return true;</span>
<a href="#l10.74"></a><span id="l10.74">     },</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-    &quot;CHANMODES&quot;: function(aMessage) false,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    &quot;CHANMODES&quot;: aMessage =&gt; false,</span>
<a href="#l10.77"></a><span id="l10.77">     &quot;CHANNELLEN&quot;: function(aMessage) {</span>
<a href="#l10.78"></a><span id="l10.78">       // CHANNELLEN=&lt;number&gt;</span>
<a href="#l10.79"></a><span id="l10.79">       // Default is from RFC 1493.</span>
<a href="#l10.80"></a><span id="l10.80">       return setSimpleNumber(this, &quot;maxChannelLength&quot;, aMessage, 200);</span>
<a href="#l10.81"></a><span id="l10.81">     },</span>
<a href="#l10.82"></a><span id="l10.82">     &quot;CHANTYPES&quot;: function(aMessage) {</span>
<a href="#l10.83"></a><span id="l10.83">       // CHANTYPES=[&lt;channel prefix&gt;]*</span>
<a href="#l10.84"></a><span id="l10.84">       let value = aMessage.isupport.useDefault ? &quot;#&amp;&quot; : aMessage.isupport.value;</span>
<a href="#l10.85"></a><span id="l10.85">       this.channelPrefixes = value.split(&quot;&quot;);</span>
<a href="#l10.86"></a><span id="l10.86">       return true;</span>
<a href="#l10.87"></a><span id="l10.87">     },</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    &quot;EXCEPTS&quot;: function(aMessage) false,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    &quot;IDCHAN&quot;: function(aMessage) false,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    &quot;INVEX&quot;: function(aMessage) false,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    &quot;EXCEPTS&quot;: aMessage =&gt; false,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    &quot;IDCHAN&quot;: aMessage =&gt; false,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    &quot;INVEX&quot;: aMessage =&gt; false,</span>
<a href="#l10.94"></a><span id="l10.94">     &quot;KICKLEN&quot;: function(aMessage) {</span>
<a href="#l10.95"></a><span id="l10.95">       // KICKLEN=&lt;number&gt;</span>
<a href="#l10.96"></a><span id="l10.96">       // Default value is Infinity.</span>
<a href="#l10.97"></a><span id="l10.97">       return setSimpleNumber(this, &quot;maxKickLength&quot;, aMessage, Infinity);</span>
<a href="#l10.98"></a><span id="l10.98">     },</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    &quot;MAXLIST&quot;: function(aMessage) false,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    &quot;MODES&quot;: function(aMessage) false,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    &quot;NETWORK&quot;: function(aMessage) false,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    &quot;MAXLIST&quot;: aMessage =&gt; false,</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+    &quot;MODES&quot;: aMessage =&gt; false,</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    &quot;NETWORK&quot;: aMessage =&gt; false,</span>
<a href="#l10.105"></a><span id="l10.105">     &quot;NICKLEN&quot;: function(aMessage) {</span>
<a href="#l10.106"></a><span id="l10.106">       // NICKLEN=&lt;number&gt;</span>
<a href="#l10.107"></a><span id="l10.107">       // Default value is from RFC 1493.</span>
<a href="#l10.108"></a><span id="l10.108">       return setSimpleNumber(this, &quot;maxNicknameLength&quot;, aMessage, 9);</span>
<a href="#l10.109"></a><span id="l10.109">     },</span>
<a href="#l10.110"></a><span id="l10.110">     &quot;PREFIX&quot;: function(aMessage) {</span>
<a href="#l10.111"></a><span id="l10.111">       // PREFIX=[(&lt;mode character&gt;*)&lt;prefix&gt;*]</span>
<a href="#l10.112"></a><span id="l10.112">       let value =</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineat">@@ -183,22 +184,22 @@ var isupportBase = {</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">       for (let i = 0; i &lt; matches[2].length; i++)</span>
<a href="#l10.116"></a><span id="l10.116">         this.userPrefixToModeMap[matches[2][i]] = matches[1][i];</span>
<a href="#l10.117"></a><span id="l10.117">       return true;</span>
<a href="#l10.118"></a><span id="l10.118">     },</span>
<a href="#l10.119"></a><span id="l10.119">     // SAFELIST allows the client to request the server buffer LIST responses to</span>
<a href="#l10.120"></a><span id="l10.120">     // avoid flooding the client. This is not an issue for us, so just ignore</span>
<a href="#l10.121"></a><span id="l10.121">     // it.</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    &quot;SAFELIST&quot;: function(aMessage) true,</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    &quot;SAFELIST&quot;: aMessage =&gt; true,</span>
<a href="#l10.124"></a><span id="l10.124">     // SECURELIST tells us that the server won't send LIST data directly after</span>
<a href="#l10.125"></a><span id="l10.125">     // connection. Unfortunately, the exact time the client has to wait is</span>
<a href="#l10.126"></a><span id="l10.126">     // configurable, so we can't do anything with this information.</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    &quot;SECURELIST&quot;: function(aMessage) true,</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-    &quot;STATUSMSG&quot;: function(aMessage) false,</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    &quot;SECURELIST&quot;: aMessage =&gt; true,</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    &quot;STATUSMSG&quot;: aMessage =&gt; false,</span>
<a href="#l10.131"></a><span id="l10.131">     &quot;STD&quot;: function(aMessage) {</span>
<a href="#l10.132"></a><span id="l10.132">       // This was never updated as the RFC was never formalized.</span>
<a href="#l10.133"></a><span id="l10.133">       if (aMessage.isupport.value != &quot;rfcnnnn&quot;)</span>
<a href="#l10.134"></a><span id="l10.134">         this.WARN(&quot;Unknown ISUPPORT numeric form: &quot; + aMessage.isupport.value);</span>
<a href="#l10.135"></a><span id="l10.135">       return true;</span>
<a href="#l10.136"></a><span id="l10.136">     },</span>
<a href="#l10.137"></a><span id="l10.137">     &quot;TARGMAX&quot;: function(aMessage) {</span>
<a href="#l10.138"></a><span id="l10.138">       // TARGMAX=&lt;command&gt;:&lt;max targets&gt;[,&lt;command&gt;:&lt;max targets&gt;]*</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineat">@@ -222,16 +223,16 @@ var isupportBase = {</span>
<a href="#l10.140"></a><span id="l10.140">     },</span>
<a href="#l10.141"></a><span id="l10.141">     &quot;TOPICLEN&quot;: function(aMessage) {</span>
<a href="#l10.142"></a><span id="l10.142">       // TOPICLEN=&lt;number&gt;</span>
<a href="#l10.143"></a><span id="l10.143">       // Default value is Infinity.</span>
<a href="#l10.144"></a><span id="l10.144">       return setSimpleNumber(this, &quot;maxTopicLength&quot;, aMessage, Infinity);</span>
<a href="#l10.145"></a><span id="l10.145">     },</span>
<a href="#l10.146"></a><span id="l10.146"> </span>
<a href="#l10.147"></a><span id="l10.147">     // The following are considered &quot;obsolete&quot; by the RFC, but are still in use.</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-    &quot;CHARSET&quot;: function(aMessage) false,</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-    &quot;MAXBANS&quot;: function(aMessage) false,</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-    &quot;MAXCHANNELS&quot;: function(aMessage) false,</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    &quot;CHARSET&quot;: aMessage =&gt; false,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+    &quot;MAXBANS&quot;: aMessage =&gt; false,</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+    &quot;MAXCHANNELS&quot;: aMessage =&gt; false,</span>
<a href="#l10.154"></a><span id="l10.154">     &quot;MAXTARGETS&quot;: function(aMessage) {</span>
<a href="#l10.155"></a><span id="l10.155">       return setSimpleNumber(this, &quot;maxTargets&quot;, aMessage, 1);</span>
<a href="#l10.156"></a><span id="l10.156">     }</span>
<a href="#l10.157"></a><span id="l10.157">   }</span>
<a href="#l10.158"></a><span id="l10.158"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/protocols/irc/ircMultiPrefix.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/protocols/irc/ircMultiPrefix.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -18,31 +18,31 @@</span>
<a href="#l11.4"></a><span id="l11.4"> const EXPORTED_SYMBOLS = [&quot;isupportNAMESX&quot;, &quot;capMultiPrefix&quot;];</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> Components.utils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> var isupportNAMESX = {</span>
<a href="#l11.9"></a><span id="l11.9">   name: &quot;ISUPPORT NAMESX&quot;,</span>
<a href="#l11.10"></a><span id="l11.10">   // Slightly above default ISUPPORT priority.</span>
<a href="#l11.11"></a><span id="l11.11">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   commands: {</span>
<a href="#l11.16"></a><span id="l11.16">     &quot;NAMESX&quot;: function(aMessage) {</span>
<a href="#l11.17"></a><span id="l11.17">       this.sendMessage(&quot;PROTOCTL&quot;, &quot;NAMESX&quot;);</span>
<a href="#l11.18"></a><span id="l11.18">       return true;</span>
<a href="#l11.19"></a><span id="l11.19">     }</span>
<a href="#l11.20"></a><span id="l11.20">   }</span>
<a href="#l11.21"></a><span id="l11.21"> };</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> var capMultiPrefix = {</span>
<a href="#l11.24"></a><span id="l11.24">   name: &quot;CAP multi-prefix&quot;,</span>
<a href="#l11.25"></a><span id="l11.25">   // Slightly above default ISUPPORT priority.</span>
<a href="#l11.26"></a><span id="l11.26">   priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   commands: {</span>
<a href="#l11.31"></a><span id="l11.31">     &quot;multi-prefix&quot;: function(aMessage) {</span>
<a href="#l11.32"></a><span id="l11.32">       // Request to use multi-prefix if it is supported.</span>
<a href="#l11.33"></a><span id="l11.33">       if (aMessage.cap.subcommand == &quot;LS&quot;) {</span>
<a href="#l11.34"></a><span id="l11.34">         this.addCAP(&quot;multi-prefix&quot;);</span>
<a href="#l11.35"></a><span id="l11.35">         this.sendMessage(&quot;CAP&quot;, [&quot;REQ&quot;, &quot;multi-prefix&quot;]);</span>
<a href="#l11.36"></a><span id="l11.36">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/protocols/irc/ircNonStandard.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/protocols/irc/ircNonStandard.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -17,17 +17,17 @@ const EXPORTED_SYMBOLS = [&quot;ircNonStandar</span>
<a href="#l12.4"></a><span id="l12.4"> const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l12.7"></a><span id="l12.7"> Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> var ircNonStandard = {</span>
<a href="#l12.10"></a><span id="l12.10">   name: &quot;Non-Standard IRC Extensions&quot;,</span>
<a href="#l12.11"></a><span id="l12.11">   priority: ircHandlers.DEFAULT_PRIORITY + 1,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   commands: {</span>
<a href="#l12.16"></a><span id="l12.16">     &quot;NOTICE&quot;: function(aMessage) {</span>
<a href="#l12.17"></a><span id="l12.17">       // NOTICE &lt;msgtarget&gt; &lt;text&gt;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">       if (aMessage.params[1].startsWith(&quot;*** You cannot list within the first&quot;)) {</span>
<a href="#l12.20"></a><span id="l12.20">         // SECURELIST: &quot;You cannot list within the first N seconds of connecting.</span>
<a href="#l12.21"></a><span id="l12.21">         // Please try again later.&quot; This NOTICE will be followed by a 321/323</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -13,17 +13,17 @@ const EXPORTED_SYMBOLS = [&quot;ircSASL&quot;, &quot;ca</span>
<a href="#l13.4"></a><span id="l13.4"> const Cu = Components.utils;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l13.7"></a><span id="l13.7"> Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> var ircSASL = {</span>
<a href="#l13.10"></a><span id="l13.10">   name: &quot;SASL AUTHENTICATE&quot;,</span>
<a href="#l13.11"></a><span id="l13.11">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15">   commands: {</span>
<a href="#l13.16"></a><span id="l13.16">     &quot;AUTHENTICATE&quot;: function(aMessage) {</span>
<a href="#l13.17"></a><span id="l13.17">       // Expect an empty response, if something different is received abort.</span>
<a href="#l13.18"></a><span id="l13.18">       if (aMessage.params[0] != &quot;+&quot;) {</span>
<a href="#l13.19"></a><span id="l13.19">         this.sendMessage(&quot;AUTHENTICATE&quot;, &quot;*&quot;);</span>
<a href="#l13.20"></a><span id="l13.20">         this.WARN(&quot;Aborting SASL authentication, unexpected message &quot; +</span>
<a href="#l13.21"></a><span id="l13.21">                   &quot;received:\n&quot; + aMessage.rawMessage);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -121,17 +121,17 @@ var ircSASL = {</span>
<a href="#l13.23"></a><span id="l13.23">       return false;</span>
<a href="#l13.24"></a><span id="l13.24">     }</span>
<a href="#l13.25"></a><span id="l13.25">   }</span>
<a href="#l13.26"></a><span id="l13.26"> };</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> var capSASL = {</span>
<a href="#l13.29"></a><span id="l13.29">   name: &quot;SASL CAP&quot;,</span>
<a href="#l13.30"></a><span id="l13.30">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">   commands: {</span>
<a href="#l13.35"></a><span id="l13.35">     &quot;sasl&quot;: function(aMessage) {</span>
<a href="#l13.36"></a><span id="l13.36">       if (aMessage.cap.subcommand == &quot;LS&quot; &amp;&amp; this.imAccount.password) {</span>
<a href="#l13.37"></a><span id="l13.37">         // If it supports SASL, let the server know we're requiring SASL.</span>
<a href="#l13.38"></a><span id="l13.38">         this.sendMessage(&quot;CAP&quot;, [&quot;REQ&quot;, &quot;sasl&quot;]);</span>
<a href="#l13.39"></a><span id="l13.39">         this.addCAP(&quot;sasl&quot;);</span>
<a href="#l13.40"></a><span id="l13.40">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/protocols/irc/ircServices.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/protocols/irc/ircServices.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -46,17 +46,17 @@ function ServiceMessage(aAccount, aMessa</span>
<a href="#l14.4"></a><span id="l14.4">     aMessage.serviceName = nicknameToServiceName[nickname];</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">   return aMessage;</span>
<a href="#l14.7"></a><span id="l14.7"> }</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> var ircServices = {</span>
<a href="#l14.10"></a><span id="l14.10">   name: &quot;IRC Services&quot;,</span>
<a href="#l14.11"></a><span id="l14.11">   priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l14.14"></a><span id="l14.14">   sendIdentify: function(aAccount) {</span>
<a href="#l14.15"></a><span id="l14.15">     if (aAccount.imAccount.password &amp;&amp; aAccount.shouldAuthenticate &amp;&amp;</span>
<a href="#l14.16"></a><span id="l14.16">         !aAccount.isAuthenticated) {</span>
<a href="#l14.17"></a><span id="l14.17">       aAccount.sendMessage(&quot;IDENTIFY&quot;, aAccount.imAccount.password,</span>
<a href="#l14.18"></a><span id="l14.18">                            &quot;IDENTIFY &lt;password not logged&gt;&quot;);</span>
<a href="#l14.19"></a><span id="l14.19">     }</span>
<a href="#l14.20"></a><span id="l14.20">   },</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -116,17 +116,17 @@ var ircServices = {</span>
<a href="#l14.23"></a><span id="l14.23">       return false;</span>
<a href="#l14.24"></a><span id="l14.24">     }</span>
<a href="#l14.25"></a><span id="l14.25">   }</span>
<a href="#l14.26"></a><span id="l14.26"> };</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28"> var servicesBase = {</span>
<a href="#l14.29"></a><span id="l14.29">   name: &quot;IRC Services&quot;,</span>
<a href="#l14.30"></a><span id="l14.30">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">   commands: {</span>
<a href="#l14.35"></a><span id="l14.35">     &quot;ChanServ&quot;: function(aMessage) {</span>
<a href="#l14.36"></a><span id="l14.36">       // [&lt;channel name&gt;] &lt;message&gt;</span>
<a href="#l14.37"></a><span id="l14.37">       let channel = aMessage.params[1].split(&quot; &quot;, 1)[0];</span>
<a href="#l14.38"></a><span id="l14.38">       if (!channel || channel[0] != &quot;[&quot; || channel.slice(-1)[0] != &quot;]&quot;)</span>
<a href="#l14.39"></a><span id="l14.39">         return false;</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -209,18 +209,18 @@ var servicesBase = {</span>
<a href="#l14.42"></a><span id="l14.42">           text == &quot;This nickname is registered. Please choose a different nickname, or identify via \x02/msg NickServ identify &lt;password&gt;\x02.&quot;) { // Atheme.</span>
<a href="#l14.43"></a><span id="l14.43">         this.LOG(&quot;Authentication requested by NickServ.&quot;);</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">         // Wait one second before showing the message to the user (giving the</span>
<a href="#l14.46"></a><span id="l14.46">         // the server time to process the log-in).</span>
<a href="#l14.47"></a><span id="l14.47">         this.nickservMessageQueue = [aMessage];</span>
<a href="#l14.48"></a><span id="l14.48">         this.nickservAuthTimeout = setTimeout(function() {</span>
<a href="#l14.49"></a><span id="l14.49">           this.isHandlingQueuedMessages = true;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-          this.nickservMessageQueue.every(function(aMessage)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-            ircHandlers.handleMessage(this, aMessage), this);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+          this.nickservMessageQueue.every(aMessage =&gt;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+            ircHandlers.handleMessage(this, aMessage));</span>
<a href="#l14.54"></a><span id="l14.54">           delete this.isHandlingQueuedMessages;</span>
<a href="#l14.55"></a><span id="l14.55">           delete this.nickservMessageQueue;</span>
<a href="#l14.56"></a><span id="l14.56">         }.bind(this), 10000);</span>
<a href="#l14.57"></a><span id="l14.57">         return true;</span>
<a href="#l14.58"></a><span id="l14.58">       }</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60">       if (!this.isAuthenticated &amp;&amp;</span>
<a href="#l14.61"></a><span id="l14.61">           (text == &quot;You are already identified.&quot; || // Anope.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -4,23 +4,23 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> const EXPORTED_SYMBOLS = [&quot;_&quot;, &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l15.6"></a><span id="l15.6">                           &quot;conversationErrorMessage&quot;, &quot;kListRefreshInterval&quot;];</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> const {classes: Cc, interfaces: Ci} = Components;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> Components.utils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l15.14"></a><span id="l15.14">   l10nHelper(&quot;chrome://chat/locale/irc.properties&quot;)</span>
<a href="#l15.15"></a><span id="l15.15"> );</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l15.18"></a><span id="l15.18">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  return function(aTXT) cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  return aTXT =&gt; cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l15.21"></a><span id="l15.21"> });</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> // The timespan after which we consider LIST roomInfo to be stale.</span>
<a href="#l15.24"></a><span id="l15.24"> const kListRefreshInterval = 12 * 60 * 60 * 1000; // 12 hours.</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> /*</span>
<a href="#l15.27"></a><span id="l15.27">  * The supported formatting control characters, as described in</span>
<a href="#l15.28"></a><span id="l15.28">  * http://www.invlogic.com/irc/ctcp.html#3.11</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineat">@@ -66,22 +66,24 @@ function ctcpFormatToText(aString) {</span>
<a href="#l15.30"></a><span id="l15.30">     length = Math.max(1, length);</span>
<a href="#l15.31"></a><span id="l15.31">     // Skip to after the last match.</span>
<a href="#l15.32"></a><span id="l15.32">     input = input.substr(next.index + length);</span>
<a href="#l15.33"></a><span id="l15.33">   }</span>
<a href="#l15.34"></a><span id="l15.34">   // Append the unmatched bits before returning the output.</span>
<a href="#l15.35"></a><span id="l15.35">   return output + input;</span>
<a href="#l15.36"></a><span id="l15.36"> }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-function openStack(aStack)</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  aStack.map(function(aTag) &quot;&lt;&quot; + aTag + &quot;&gt;&quot;).join(&quot;&quot;)</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+function openStack(aStack) {</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  return aStack.map(aTag =&gt; &quot;&lt;&quot; + aTag + &quot;&gt;&quot;).join(&quot;&quot;);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+}</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44"> // Close the tags in the opposite order they were opened.</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-function closeStack(aStack)</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  aStack.reverse().map(function(aTag) &quot;&lt;/&quot; + aTag.split(&quot; &quot;, 1) + &quot;&gt;&quot;).join(&quot;&quot;)</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+function closeStack(aStack) {</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  return aStack.reverse().map(aTag =&gt; &quot;&lt;/&quot; + aTag.split(&quot; &quot;, 1) + &quot;&gt;&quot;).join(&quot;&quot;);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+}</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51"> /**</span>
<a href="#l15.52"></a><span id="l15.52">  * Convert a string from CTCP escaped formatting to HTML markup.</span>
<a href="#l15.53"></a><span id="l15.53">  * @param aString the string with CTCP formatting to parse</span>
<a href="#l15.54"></a><span id="l15.54">  * @return The HTML output string</span>
<a href="#l15.55"></a><span id="l15.55">  */</span>
<a href="#l15.56"></a><span id="l15.56"> function ctcpFormatToHTML(aString) {</span>
<a href="#l15.57"></a><span id="l15.57">   let next,</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineat">@@ -175,23 +177,23 @@ function mIRCColoring(aStack, aInput) {</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">   if ((matches = M_IRC_COLORS_EXP.exec(input))) {</span>
<a href="#l15.61"></a><span id="l15.61">     let format = [&quot;font&quot;];</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63">     // Only \003 was found with no formatting digits after it, close the</span>
<a href="#l15.64"></a><span id="l15.64">     // first open font tag.</span>
<a href="#l15.65"></a><span id="l15.65">     if (!matches[1]) {</span>
<a href="#l15.66"></a><span id="l15.66">       // Find the first font tag.</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-      let offset = stack.map(function(aTag) aTag.indexOf(&quot;font&quot;) == 0)</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+      let offset = stack.map(aTag =&gt; aTag.indexOf(&quot;font&quot;) == 0)</span>
<a href="#l15.69"></a><span id="l15.69">                         .indexOf(true);</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71">       // Close all tags from the first font tag on.</span>
<a href="#l15.72"></a><span id="l15.72">       output = closeStack(stack.slice(offset));</span>
<a href="#l15.73"></a><span id="l15.73">       // Remove the font tags from the stack.</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      stack = stack.filter(function(aTag) aTag.indexOf(&quot;font&quot;));</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+      stack = stack.filter(aTag =&gt; aTag.indexOf(&quot;font&quot;));</span>
<a href="#l15.76"></a><span id="l15.76">       // Reopen the other tags.</span>
<a href="#l15.77"></a><span id="l15.77">       output += openStack(stack.slice(offset));</span>
<a href="#l15.78"></a><span id="l15.78">     }</span>
<a href="#l15.79"></a><span id="l15.79">     else {</span>
<a href="#l15.80"></a><span id="l15.80">       // Otherwise we have a match and are setting new colors.</span>
<a href="#l15.81"></a><span id="l15.81">       // The foreground color.</span>
<a href="#l15.82"></a><span id="l15.82">       let color = getColor(matches[1]);</span>
<a href="#l15.83"></a><span id="l15.83">       if (color)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -89,17 +89,17 @@ function untrackBuddyWatch(aNick) {</span>
<a href="#l16.4"></a><span id="l16.4">   this.sendMessage(&quot;WATCH&quot;, &quot;-&quot; + aNick);</span>
<a href="#l16.5"></a><span id="l16.5">   Object.getPrototypeOf(this).untrackBuddy.call(this, aNick);</span>
<a href="#l16.6"></a><span id="l16.6"> }</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> var isupportWATCH = {</span>
<a href="#l16.9"></a><span id="l16.9">   name: &quot;WATCH&quot;,</span>
<a href="#l16.10"></a><span id="l16.10">   // Slightly above default ISUPPORT priority.</span>
<a href="#l16.11"></a><span id="l16.11">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15">   commands: {</span>
<a href="#l16.16"></a><span id="l16.16">     &quot;WATCH&quot;: function(aMessage) {</span>
<a href="#l16.17"></a><span id="l16.17">       if (!aMessage.isupport.useDefault)</span>
<a href="#l16.18"></a><span id="l16.18">         this.maxWatchLength = 128;</span>
<a href="#l16.19"></a><span id="l16.19">       else {</span>
<a href="#l16.20"></a><span id="l16.20">         let size = parseInt(aMessage.isupport.value, 10);</span>
<a href="#l16.21"></a><span id="l16.21">         if (isNaN(size))</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -135,17 +135,17 @@ var isupportWATCH = {</span>
<a href="#l16.23"></a><span id="l16.23">   }</span>
<a href="#l16.24"></a><span id="l16.24"> };</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> var ircWATCH = {</span>
<a href="#l16.27"></a><span id="l16.27">   name: &quot;WATCH&quot;,</span>
<a href="#l16.28"></a><span id="l16.28">   // Slightly above default IRC priority.</span>
<a href="#l16.29"></a><span id="l16.29">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l16.30"></a><span id="l16.30">   // Use WATCH if it is supported.</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  isEnabled: function() !!this.watchEnabled,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  isEnabled: function() { return !!this.watchEnabled; },</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   commands: {</span>
<a href="#l16.35"></a><span id="l16.35">     &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l16.36"></a><span id="l16.36">       // &quot;:There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers&quot;</span>
<a href="#l16.37"></a><span id="l16.37">       // Assume that this will always be sent after the 005 handler on</span>
<a href="#l16.38"></a><span id="l16.38">       // connection registration. If WATCH is enabled, then set the new function</span>
<a href="#l16.39"></a><span id="l16.39">       // to keep track of nicks and send the messages to watch the nicks.</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineat">@@ -262,17 +262,17 @@ var ircWATCH = {</span>
<a href="#l16.42"></a><span id="l16.42">     }</span>
<a href="#l16.43"></a><span id="l16.43">   }</span>
<a href="#l16.44"></a><span id="l16.44"> };</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46"> var isupportMONITOR = {</span>
<a href="#l16.47"></a><span id="l16.47">   name: &quot;MONITOR&quot;,</span>
<a href="#l16.48"></a><span id="l16.48">   // Slightly above default ISUPPORT priority.</span>
<a href="#l16.49"></a><span id="l16.49">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  isEnabled: function() true,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  isEnabled: () =&gt; true,</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53">   commands: {</span>
<a href="#l16.54"></a><span id="l16.54">     &quot;MONITOR&quot;: function(aMessage) {</span>
<a href="#l16.55"></a><span id="l16.55">       if (!aMessage.isupport.useDefault)</span>
<a href="#l16.56"></a><span id="l16.56">         this.maxMonitorLength = Infinity;</span>
<a href="#l16.57"></a><span id="l16.57">       else {</span>
<a href="#l16.58"></a><span id="l16.58">         let size = parseInt(aMessage.isupport.value, 10);</span>
<a href="#l16.59"></a><span id="l16.59">         if (isNaN(size))</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineat">@@ -338,17 +338,17 @@ function untrackBuddyMonitor(aNick) {</span>
<a href="#l16.61"></a><span id="l16.61"> }</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63"> var ircMONITOR = {</span>
<a href="#l16.64"></a><span id="l16.64">   name: &quot;MONITOR&quot;,</span>
<a href="#l16.65"></a><span id="l16.65">   // Slightly above default IRC priority.</span>
<a href="#l16.66"></a><span id="l16.66">   priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l16.67"></a><span id="l16.67">   // Use MONITOR only if MONITOR is enabled and WATCH is not enabled, as WATCH</span>
<a href="#l16.68"></a><span id="l16.68">   // supports more features.</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  isEnabled: function() this.monitorEnabled &amp;&amp; !this.watchEnabled,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  isEnabled: function() { return this.monitorEnabled &amp;&amp; !this.watchEnabled; },</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72">   commands: {</span>
<a href="#l16.73"></a><span id="l16.73">     &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l16.74"></a><span id="l16.74">       // &quot;:There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers&quot;</span>
<a href="#l16.75"></a><span id="l16.75">       // Assume that this will always be sent after the 005 handler on</span>
<a href="#l16.76"></a><span id="l16.76">       // connection registration. If MONITOR is enabled, then set the new</span>
<a href="#l16.77"></a><span id="l16.77">       // function to keep track of nicks and send the messages to watch the</span>
<a href="#l16.78"></a><span id="l16.78">       // nicks.</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineat">@@ -372,28 +372,28 @@ var ircMONITOR = {</span>
<a href="#l16.80"></a><span id="l16.80">       // handler to do nothing if we're using MONITOR.</span>
<a href="#l16.81"></a><span id="l16.81">       return true;</span>
<a href="#l16.82"></a><span id="l16.82">     },</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84">     &quot;730&quot;: function(aMessage) { // RPL_MONONLINE</span>
<a href="#l16.85"></a><span id="l16.85">       // :&lt;server&gt; 730 &lt;nick&gt; :nick!user@host[,nick!user@host]*</span>
<a href="#l16.86"></a><span id="l16.86">       // Mark each nick as online.</span>
<a href="#l16.87"></a><span id="l16.87">       return aMessage.params[1].split(&quot;,&quot;)</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-                               .map(function(aNick)</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+                               .map(aNick =&gt;</span>
<a href="#l16.90"></a><span id="l16.90">                                       setStatus(this, aNick.split(&quot;!&quot;, 1)[0],</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-                                                &quot;AVAILABLE&quot;),</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-                                    this).every(function(aResult) aResult);</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+                                                &quot;AVAILABLE&quot;))</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+                               .every(aResult =&gt; aResult);</span>
<a href="#l16.95"></a><span id="l16.95">     },</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97">     &quot;731&quot;: function(aMessage) { // RPL_MONOFFLINE</span>
<a href="#l16.98"></a><span id="l16.98">       // :&lt;server&gt; 731 &lt;nick&gt; :nick[,nick1]*</span>
<a href="#l16.99"></a><span id="l16.99">       return aMessage.params[1].split(&quot;,&quot;)</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                               .map(function(aNick)</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-                                      setStatus(this, aNick, &quot;OFFLINE&quot;),</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-                                    this).every(function(aResult) aResult);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+                               .map(aNick =&gt;</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+                                      setStatus(this, aNick, &quot;OFFLINE&quot;))</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+                               .every(aResult =&gt; aResult);</span>
<a href="#l16.106"></a><span id="l16.106">     },</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108">     &quot;732&quot;: function(aMessage) { // RPL_MONLIST</span>
<a href="#l16.109"></a><span id="l16.109">       // :&lt;server&gt; 732 &lt;nick&gt; :nick[,nick1]*</span>
<a href="#l16.110"></a><span id="l16.110">       return false;</span>
<a href="#l16.111"></a><span id="l16.111">     },</span>
<a href="#l16.112"></a><span id="l16.112"> </span>
<a href="#l16.113"></a><span id="l16.113">     &quot;733&quot;: function(aMessage) { // RPL_ENDOFMONLIST</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpDequote.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpDequote.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -41,17 +41,17 @@ const expectedOutputParam = [</span>
<a href="#l17.4"></a><span id="l17.4">   &quot;\x01test&quot;,</span>
<a href="#l17.5"></a><span id="l17.5">   &quot;te\x01st&quot;,</span>
<a href="#l17.6"></a><span id="l17.6">   &quot;test\x01&quot;,</span>
<a href="#l17.7"></a><span id="l17.7">   &quot;\x5C\x01test&quot;,</span>
<a href="#l17.8"></a><span id="l17.8">   &quot;\x5Catest&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> ];</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> function run_test() {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let output = input.map(function(aStr) ircCTCP.CTCPMessage({}, aStr));</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  let output = input.map(aStr =&gt; ircCTCP.CTCPMessage({}, aStr));</span>
<a href="#l17.14"></a><span id="l17.14">   // Ensure both arrays have the same length.</span>
<a href="#l17.15"></a><span id="l17.15">   do_check_eq(expectedOutputParam.length, output.length);</span>
<a href="#l17.16"></a><span id="l17.16">   // Ensure the values in the arrays are equal.</span>
<a href="#l17.17"></a><span id="l17.17">   for (let i = 0; i &lt; output.length; ++i) {</span>
<a href="#l17.18"></a><span id="l17.18">     do_check_eq(expectedOutputParam[i], output[i].ctcp.param);</span>
<a href="#l17.19"></a><span id="l17.19">     do_check_eq(expectedOutputCommand, output[i].ctcp.command);</span>
<a href="#l17.20"></a><span id="l17.20">   }</span>
<a href="#l17.21"></a><span id="l17.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -48,17 +48,17 @@ const expectedOutputParams = [</span>
<a href="#l18.4"></a><span id="l18.4"> let outputParams = [];</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> irc.ircAccount.prototype.sendMessage = function(aCommand, aParams) {</span>
<a href="#l18.7"></a><span id="l18.7">   do_check_eq(expectedOutputCommand, aCommand);</span>
<a href="#l18.8"></a><span id="l18.8">   outputParams.push(aParams[1]);</span>
<a href="#l18.9"></a><span id="l18.9"> }</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> function run_test() {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  let output = input.map(function(aStr)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  let output = input.map(aStr =&gt;</span>
<a href="#l18.14"></a><span id="l18.14">     irc.ircAccount.prototype.sendCTCPMessage(&quot;&quot;, false, &quot;ACTION&quot;, aStr));</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16">   // Ensure both arrays have the same length.</span>
<a href="#l18.17"></a><span id="l18.17">   do_check_eq(expectedOutputParams.length, outputParams.length);</span>
<a href="#l18.18"></a><span id="l18.18">   // Ensure the values in the arrays are equal.</span>
<a href="#l18.19"></a><span id="l18.19">   for (let i = 0; i &lt; outputParams.length; ++i)</span>
<a href="#l18.20"></a><span id="l18.20">     do_check_eq(&quot;\x01&quot; + expectedOutputParams[i] + &quot;\x01&quot;, outputParams[i]);</span>
<a href="#l18.21"></a><span id="l18.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -164,17 +164,17 @@ function isEqual(aObject1, aObject2) {</span>
<a href="#l19.4"></a><span id="l19.4">     if (aObject2 instanceof Map)</span>
<a href="#l19.5"></a><span id="l19.5">       field2 = aObject2.get(fieldName);</span>
<a href="#l19.6"></a><span id="l19.6">     else</span>
<a href="#l19.7"></a><span id="l19.7">       field2 = aObject2[fieldName];</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">     if (typeof field1 == &quot;object&quot;)</span>
<a href="#l19.10"></a><span id="l19.10">       result &amp;= isEqual(field1, field2);</span>
<a href="#l19.11"></a><span id="l19.11">     else if (Array.isArray(field1))</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-      result &amp;= field1.every(function(el, idx) el == field2[idx]);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+      result &amp;= field1.every((el, idx) =&gt; el == field2[idx]);</span>
<a href="#l19.14"></a><span id="l19.14">     else</span>
<a href="#l19.15"></a><span id="l19.15">       result &amp;= field1 == field2;</span>
<a href="#l19.16"></a><span id="l19.16">   }</span>
<a href="#l19.17"></a><span id="l19.17">   return result;</span>
<a href="#l19.18"></a><span id="l19.18"> }</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> // Unreal sends a couple of broken messages, see ircMessage in irc.js for a</span>
<a href="#l19.21"></a><span id="l19.21"> // description of what's wrong.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.6"></a><span id="l20.6"> let irc = {};</span>
<a href="#l20.7"></a><span id="l20.7"> Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> const fakeProto = {</span>
<a href="#l20.10"></a><span id="l20.10">   id: &quot;fake-proto&quot;,</span>
<a href="#l20.11"></a><span id="l20.11">   options: {alternateNicks: &quot;&quot;},</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  _getOptionDefault: function(aOption) this.options[aOption]</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  _getOptionDefault: function(aOption) { return this.options[aOption]; }</span>
<a href="#l20.14"></a><span id="l20.14"> }</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> function test_tryNewNick() {</span>
<a href="#l20.17"></a><span id="l20.17">   const testData = {</span>
<a href="#l20.18"></a><span id="l20.18">     &quot;clokep&quot;: &quot;clokep1&quot;,</span>
<a href="#l20.19"></a><span id="l20.19">     &quot;clokep1&quot;: &quot;clokep2&quot;,</span>
<a href="#l20.20"></a><span id="l20.20">     &quot;clokep10&quot;: &quot;clokep11&quot;,</span>
<a href="#l20.21"></a><span id="l20.21">     &quot;clokep0&quot;: &quot;clokep1&quot;,</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -27,21 +27,21 @@ function test_tryNewNick() {</span>
<a href="#l20.23"></a><span id="l20.23">     &quot;clo1kep0&quot;: &quot;clo1kep1&quot;,</span>
<a href="#l20.24"></a><span id="l20.24">     &quot;clo1kep01&quot;: &quot;clo1kep02&quot;,</span>
<a href="#l20.25"></a><span id="l20.25">     &quot;clo1kep09&quot;: &quot;clo1kep10&quot;</span>
<a href="#l20.26"></a><span id="l20.26">   };</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">   let account = new irc.ircAccount(fakeProto,</span>
<a href="#l20.29"></a><span id="l20.29">                                    {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l20.30"></a><span id="l20.30">   account.LOG = function(aStr) {};</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  account.normalize = function(aStr) aStr;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  account.normalize = aStr =&gt; aStr;</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34">   for (let currentNick in testData) {</span>
<a href="#l20.35"></a><span id="l20.35">     account._sentNickname = currentNick;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-    account.sendMessage = function(aCommand, aNewNick)</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l20.38"></a><span id="l20.38">       do_check_eq(aNewNick, testData[currentNick]);</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">     account.tryNewNick(currentNick);</span>
<a href="#l20.41"></a><span id="l20.41">   }</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43">   run_next_test();</span>
<a href="#l20.44"></a><span id="l20.44"> }</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46" class="difflineat">@@ -70,20 +70,20 @@ function test_maxLength() {</span>
<a href="#l20.47"></a><span id="l20.47">     [&quot;a99999999&quot;, &quot;a100000000&quot;],</span>
<a href="#l20.48"></a><span id="l20.48">     [&quot;a10000000&quot;, &quot;a00000000&quot;]</span>
<a href="#l20.49"></a><span id="l20.49">   ];</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51">   let account = new irc.ircAccount(fakeProto,</span>
<a href="#l20.52"></a><span id="l20.52">                                    {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l20.53"></a><span id="l20.53">   account.LOG = function(aStr) {};</span>
<a href="#l20.54"></a><span id="l20.54">   account._sentNickname = &quot;abcdefghi&quot;;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  account.normalize = function(aStr) aStr;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  account.normalize = aStr =&gt; aStr;</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58">   for (let currentNick of testData) {</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    account.sendMessage = function(aCommand, aNewNick)</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+    account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l20.61"></a><span id="l20.61">       do_check_eq(aNewNick, currentNick[1]);</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">     account.tryNewNick(currentNick[0]);</span>
<a href="#l20.64"></a><span id="l20.64">   }</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66">   run_next_test();</span>
<a href="#l20.67"></a><span id="l20.67"> }</span>
<a href="#l20.68"></a><span id="l20.68"> </span>
<a href="#l20.69"></a><span id="l20.69" class="difflineat">@@ -101,30 +101,30 @@ function test_altNicks() {</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">     // Test messy alternatives.</span>
<a href="#l20.72"></a><span id="l20.72">     &quot;clokep[&quot;: [&quot; clokep ,\n clokep111,,,\tclokep[, clokep_&quot;, &quot;clokep_&quot;]</span>
<a href="#l20.73"></a><span id="l20.73">   };</span>
<a href="#l20.74"></a><span id="l20.74"> </span>
<a href="#l20.75"></a><span id="l20.75">   let account = new irc.ircAccount(fakeProto,</span>
<a href="#l20.76"></a><span id="l20.76">                                    {name: &quot;clokep@instantbird.org&quot;});</span>
<a href="#l20.77"></a><span id="l20.77">   account.LOG = function(aStr) {};</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  account.normalize = function(aStr) aStr;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+  account.normalize = aStr =&gt; aStr;</span>
<a href="#l20.80"></a><span id="l20.80"> </span>
<a href="#l20.81"></a><span id="l20.81">   for (let currentNick in testData) {</span>
<a href="#l20.82"></a><span id="l20.82">     // Only one pref is touched in here, override the default to return</span>
<a href="#l20.83"></a><span id="l20.83">     // what this test needs.</span>
<a href="#l20.84"></a><span id="l20.84">     account.getString = function(aStr) {</span>
<a href="#l20.85"></a><span id="l20.85">       let data = testData[currentNick][0];</span>
<a href="#l20.86"></a><span id="l20.86">       if (Array.isArray(data))</span>
<a href="#l20.87"></a><span id="l20.87">         return data.join(&quot;,&quot;);</span>
<a href="#l20.88"></a><span id="l20.88">       return data;</span>
<a href="#l20.89"></a><span id="l20.89">     };</span>
<a href="#l20.90"></a><span id="l20.90">     account._sentNickname = currentNick;</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-    account.sendMessage = function(aCommand, aNewNick)</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+    account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l20.94"></a><span id="l20.94">       do_check_eq(aNewNick, testData[currentNick][1]);</span>
<a href="#l20.95"></a><span id="l20.95"> </span>
<a href="#l20.96"></a><span id="l20.96">     account.tryNewNick(currentNick);</span>
<a href="#l20.97"></a><span id="l20.97">   }</span>
<a href="#l20.98"></a><span id="l20.98"> </span>
<a href="#l20.99"></a><span id="l20.99">   run_next_test();</span>
<a href="#l20.100"></a><span id="l20.100"> }</span>
<a href="#l20.101"></a><span id="l20.101"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -25,17 +25,17 @@ Conversation.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4">       return;</span>
<a href="#l21.5"></a><span id="l21.5">     }</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">     this.writeMessage(&quot;You&quot;, aMsg, {outgoing: true});</span>
<a href="#l21.8"></a><span id="l21.8">     this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;,</span>
<a href="#l21.9"></a><span id="l21.9">                       {incoming: true, autoResponse: true});</span>
<a href="#l21.10"></a><span id="l21.10">   },</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  get name() &quot;/dev/null&quot;,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  get name() { return &quot;/dev/null&quot;; },</span>
<a href="#l21.14"></a><span id="l21.14"> };</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> function Account(aProtoInstance, aImAccount)</span>
<a href="#l21.17"></a><span id="l21.17"> {</span>
<a href="#l21.18"></a><span id="l21.18">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l21.19"></a><span id="l21.19"> }</span>
<a href="#l21.20"></a><span id="l21.20"> Account.prototype = {</span>
<a href="#l21.21"></a><span id="l21.21">   __proto__: GenericAccountPrototype,</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -55,41 +55,41 @@ Account.prototype = {</span>
<a href="#l21.23"></a><span id="l21.23">       this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {system: true});</span>
<a href="#l21.24"></a><span id="l21.24">     if (this._conv) {</span>
<a href="#l21.25"></a><span id="l21.25">       this._conv._setDisconnected();</span>
<a href="#l21.26"></a><span id="l21.26">       delete this._conv;</span>
<a href="#l21.27"></a><span id="l21.27">     }</span>
<a href="#l21.28"></a><span id="l21.28">     this.reportDisconnected();</span>
<a href="#l21.29"></a><span id="l21.29">   },</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  get canJoinChat() true,</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  get canJoinChat() { return true; },</span>
<a href="#l21.33"></a><span id="l21.33">   chatRoomFields: {</span>
<a href="#l21.34"></a><span id="l21.34">     channel: {label: &quot;_Channel Field&quot;, required: true},</span>
<a href="#l21.35"></a><span id="l21.35">     channelDefault: {label: &quot;_Field with default&quot;, default: &quot;Default Value&quot;},</span>
<a href="#l21.36"></a><span id="l21.36">     password: {label: &quot;_Password Field&quot;, default: &quot;&quot;, isPassword: true,</span>
<a href="#l21.37"></a><span id="l21.37">                required: false},</span>
<a href="#l21.38"></a><span id="l21.38">     sampleIntField: {label: &quot;_Int Field&quot;, default: 4, min: 0, max: 10,</span>
<a href="#l21.39"></a><span id="l21.39">                      required: true}</span>
<a href="#l21.40"></a><span id="l21.40">   }</span>
<a href="#l21.41"></a><span id="l21.41"> };</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43"> function jsTestProtocol() { }</span>
<a href="#l21.44"></a><span id="l21.44"> jsTestProtocol.prototype = {</span>
<a href="#l21.45"></a><span id="l21.45">   __proto__: GenericProtocolPrototype,</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  get name() &quot;JS Test&quot;,</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+  get name() { return &quot;JS Test&quot;; },</span>
<a href="#l21.48"></a><span id="l21.48">   options: {</span>
<a href="#l21.49"></a><span id="l21.49">     &quot;text&quot;: {label: &quot;Text option&quot;,    default: &quot;foo&quot;},</span>
<a href="#l21.50"></a><span id="l21.50">     &quot;bool&quot;: {label: &quot;Boolean option&quot;, default: true},</span>
<a href="#l21.51"></a><span id="l21.51">     &quot;int&quot; : {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l21.52"></a><span id="l21.52">     &quot;list&quot;: {label: &quot;Select option&quot;,  default: &quot;option2&quot;,</span>
<a href="#l21.53"></a><span id="l21.53">              listValues: {&quot;option1&quot;: &quot;First option&quot;,</span>
<a href="#l21.54"></a><span id="l21.54">                           &quot;option2&quot;: &quot;Default option&quot;,</span>
<a href="#l21.55"></a><span id="l21.55">                           &quot;option3&quot;: &quot;Other option&quot;}}</span>
<a href="#l21.56"></a><span id="l21.56">   },</span>
<a href="#l21.57"></a><span id="l21.57">   usernameSplits: [</span>
<a href="#l21.58"></a><span id="l21.58">     {label: &quot;Server&quot;, separator: &quot;@&quot;, defaultValue: &quot;default.server&quot;,</span>
<a href="#l21.59"></a><span id="l21.59">      reverse: true}</span>
<a href="#l21.60"></a><span id="l21.60">   ],</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-  getAccount: function(aImAccount) new Account(this, aImAccount),</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+  getAccount: function(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l21.63"></a><span id="l21.63">   classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l21.64"></a><span id="l21.64"> };</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([jsTestProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -4,26 +4,26 @@</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l22.8"></a><span id="l22.8"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l22.9"></a><span id="l22.9"> Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l22.10"></a><span id="l22.10"> Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l22.14"></a><span id="l22.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l22.15"></a><span id="l22.15"> );</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17"> function OdnoklassnikiAccount(aProtoInstance, aImAccount) {</span>
<a href="#l22.18"></a><span id="l22.18">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l22.19"></a><span id="l22.19"> }</span>
<a href="#l22.20"></a><span id="l22.20"> OdnoklassnikiAccount.prototype = {</span>
<a href="#l22.21"></a><span id="l22.21">   __proto__: XMPPAccountPrototype,</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-  get canJoinChat() false,</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+  get canJoinChat() { return false; },</span>
<a href="#l22.24"></a><span id="l22.24">   connect: function() {</span>
<a href="#l22.25"></a><span id="l22.25">     if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l22.26"></a><span id="l22.26">       let jid = this.name + &quot;@odnoklassniki.ru/&quot; + XMPPDefaultResource;</span>
<a href="#l22.27"></a><span id="l22.27">       this._jid = this._parseJID(jid);</span>
<a href="#l22.28"></a><span id="l22.28">     }</span>
<a href="#l22.29"></a><span id="l22.29">     else {</span>
<a href="#l22.30"></a><span id="l22.30">       this._jid = this._parseJID(this.name);</span>
<a href="#l22.31"></a><span id="l22.31">       if (this._jid.domain != &quot;odnoklassniki.ru&quot;) {</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineat">@@ -40,17 +40,17 @@ OdnoklassnikiAccount.prototype = {</span>
<a href="#l22.33"></a><span id="l22.33">                                        this.imAccount.password, this);</span>
<a href="#l22.34"></a><span id="l22.34">   }</span>
<a href="#l22.35"></a><span id="l22.35"> };</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37"> function OdnoklassnikiProtocol() {</span>
<a href="#l22.38"></a><span id="l22.38"> }</span>
<a href="#l22.39"></a><span id="l22.39"> OdnoklassnikiProtocol.prototype = {</span>
<a href="#l22.40"></a><span id="l22.40">   __proto__: GenericProtocolPrototype,</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  get normalizedName() &quot;odnoklassniki&quot;,</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-  get name() _(&quot;odnoklassniki.protocolName&quot;),</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-odnoklassniki/skin/&quot;,</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  get usernameEmptyText() _(&quot;odnoklassniki.usernameHint&quot;),</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-  getAccount: function(aImAccount) new OdnoklassnikiAccount(this, aImAccount),</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+  get normalizedName() { return &quot;odnoklassniki&quot;; },</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+  get name() { return _(&quot;odnoklassniki.protocolName&quot;); },</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-odnoklassniki/skin/&quot;; },</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+  get usernameEmptyText() { return _(&quot;odnoklassniki.usernameHint&quot;); },</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  getAccount: function(aImAccount) { return new OdnoklassnikiAccount(this, aImAccount); },</span>
<a href="#l22.51"></a><span id="l22.51">   classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;)</span>
<a href="#l22.52"></a><span id="l22.52"> };</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([OdnoklassnikiProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/protocols/skype/skype.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/protocols/skype/skype.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -27,17 +27,17 @@ const kMessagesHost = &quot;client-s.gateway.</span>
<a href="#l23.4"></a><span id="l23.4"> const kStatusMap = {</span>
<a href="#l23.5"></a><span id="l23.5">   &quot;Online&quot;: &quot;AVAILABLE&quot;,</span>
<a href="#l23.6"></a><span id="l23.6">   &quot;Offline&quot;: &quot;OFFLINE&quot;,</span>
<a href="#l23.7"></a><span id="l23.7">   &quot;Idle&quot;: &quot;IDLE&quot;,</span>
<a href="#l23.8"></a><span id="l23.8">   &quot;Away&quot;: &quot;AWAY&quot;,</span>
<a href="#l23.9"></a><span id="l23.9">   &quot;Hidden&quot;: &quot;INVISIBLE&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> };</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l23.14"></a><span id="l23.14">   l10nHelper(&quot;chrome://chat/locale/skype.properties&quot;)</span>
<a href="#l23.15"></a><span id="l23.15"> );</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> /*</span>
<a href="#l23.18"></a><span id="l23.18">  * Convert a URL to a user's name.</span>
<a href="#l23.19"></a><span id="l23.19">  *</span>
<a href="#l23.20"></a><span id="l23.20">  * E.g. https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep</span>
<a href="#l23.21"></a><span id="l23.21">  *      https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -362,17 +362,17 @@ SkypeAccount.prototype = {</span>
<a href="#l23.23"></a><span id="l23.23">     this.reportConnecting(_(&quot;connecting.authenticating&quot;));</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25">     // Parse the pie/etm and do the actual login.</span>
<a href="#l23.26"></a><span id="l23.26">     let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l23.27"></a><span id="l23.27"> </span>
<a href="#l23.28"></a><span id="l23.28">     let params = [[&quot;client_id&quot;, kClientId],</span>
<a href="#l23.29"></a><span id="l23.29">                   [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;]];</span>
<a href="#l23.30"></a><span id="l23.30">     loginUrl += &quot;?&quot; +</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-      params.map(function(p) p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+      params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34">     this.LOG(&quot;Received PIE response:\n&quot; + aResponse);</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36">     // Note that the response is really just an HTML page with some JavaScript</span>
<a href="#l23.37"></a><span id="l23.37">     // and forms that these values are being pulled from.</span>
<a href="#l23.38"></a><span id="l23.38">     let pie = extractString(aResponse, &quot;=\&quot;pie\&quot; value=\&quot;&quot;, &quot;\&quot;&quot;);</span>
<a href="#l23.39"></a><span id="l23.39">     if (!pie) {</span>
<a href="#l23.40"></a><span id="l23.40">       this.ERROR(&quot;pie value not found.&quot;)</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineat">@@ -788,29 +788,29 @@ SkypeAccount.prototype = {</span>
<a href="#l23.42"></a><span id="l23.42">     clearTimeout(this._poller);</span>
<a href="#l23.43"></a><span id="l23.43">     if (this._request)</span>
<a href="#l23.44"></a><span id="l23.44">       this._request.abort();</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">     this._request = null;</span>
<a href="#l23.47"></a><span id="l23.47">     this._poller = null;</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49">     // Mark all contacts on the account as having an unknown status.</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    this._buddies.forEach(function(aBuddy)</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+    this._buddies.forEach(aBuddy =&gt;</span>
<a href="#l23.52"></a><span id="l23.52">       aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;));</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54">     this.reportDisconnected();</span>
<a href="#l23.55"></a><span id="l23.55">   },</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">   // TODO?</span>
<a href="#l23.58"></a><span id="l23.58">   observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60">   remove: function() {</span>
<a href="#l23.61"></a><span id="l23.61">     this._conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l23.62"></a><span id="l23.62">     delete this._conversations;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-    this.buddies.forEach(function(aBuddy) aBuddy.remove());</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l23.65"></a><span id="l23.65">     delete this.buddies;</span>
<a href="#l23.66"></a><span id="l23.66">   },</span>
<a href="#l23.67"></a><span id="l23.67"> </span>
<a href="#l23.68"></a><span id="l23.68">   unInit: function() {</span>
<a href="#l23.69"></a><span id="l23.69">     delete this.imAccount;</span>
<a href="#l23.70"></a><span id="l23.70">     clearTimeout(this._poller);</span>
<a href="#l23.71"></a><span id="l23.71">   },</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73" class="difflineat">@@ -826,27 +826,27 @@ SkypeAccount.prototype = {</span>
<a href="#l23.74"></a><span id="l23.74">   loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l23.75"></a><span id="l23.75">     let buddy = new SkypeAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l23.76"></a><span id="l23.76">     this._buddies.set(buddy.userName, buddy);</span>
<a href="#l23.77"></a><span id="l23.77"> </span>
<a href="#l23.78"></a><span id="l23.78">     return buddy;</span>
<a href="#l23.79"></a><span id="l23.79">   },</span>
<a href="#l23.80"></a><span id="l23.80"> </span>
<a href="#l23.81"></a><span id="l23.81">   // TODO Add support for MUCs.</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-  get canJoinChat() false,</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+  get canJoinChat() { return false; },</span>
<a href="#l23.84"></a><span id="l23.84">   chatRoomFields: {},</span>
<a href="#l23.85"></a><span id="l23.85">   joinChat: function(aComponents) {}</span>
<a href="#l23.86"></a><span id="l23.86"> };</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88"> function SkypeProtocol() {}</span>
<a href="#l23.89"></a><span id="l23.89"> SkypeProtocol.prototype = {</span>
<a href="#l23.90"></a><span id="l23.90">   __proto__: GenericProtocolPrototype,</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-  get name() &quot;Skype&quot;,</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-skype/skin/&quot;,</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-  get baseId() &quot;prpl-skype&quot;,</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+  get name() { return &quot;Skype&quot;; },</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-skype/skin/&quot;; },</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+  get baseId() { return &quot;prpl-skype&quot;; },</span>
<a href="#l23.97"></a><span id="l23.97"> </span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-  get passwordOptional() false,</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+  get passwordOptional() { return false; },</span>
<a href="#l23.100"></a><span id="l23.100"> </span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-  getAccount: function(aImAccount) new SkypeAccount(this, aImAccount),</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+  getAccount: function(aImAccount) { return new SkypeAccount(this, aImAccount); },</span>
<a href="#l23.103"></a><span id="l23.103">   classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;)</span>
<a href="#l23.104"></a><span id="l23.104"> };</span>
<a href="#l23.105"></a><span id="l23.105"> </span>
<a href="#l23.106"></a><span id="l23.106"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([SkypeProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -8,20 +8,20 @@ Cu.import(&quot;resource://gre/modules/Http.j</span>
<a href="#l24.4"></a><span id="l24.4"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l24.5"></a><span id="l24.5"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l24.6"></a><span id="l24.6"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l24.7"></a><span id="l24.7"> Cu.import(&quot;resource:///modules/twitter-text.jsm&quot;);</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> const NS_PREFBRANCH_PREFCHANGE_TOPIC_ID = &quot;nsPref:changed&quot;;</span>
<a href="#l24.10"></a><span id="l24.10"> const kMaxMessageLength = 140;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l24.14"></a><span id="l24.14">   l10nHelper(&quot;chrome://chat/locale/twitter.properties&quot;)</span>
<a href="#l24.15"></a><span id="l24.15"> );</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_lang&quot;, function()</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_lang&quot;, () =&gt;</span>
<a href="#l24.18"></a><span id="l24.18">   l10nHelper(&quot;chrome://global/locale/languageNames.properties&quot;)</span>
<a href="#l24.19"></a><span id="l24.19"> );</span>
<a href="#l24.20"></a><span id="l24.20"> initLogModule(&quot;twitter&quot;, this);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22"> function ChatBuddy(aName) {</span>
<a href="#l24.23"></a><span id="l24.23">   this._name = aName;</span>
<a href="#l24.24"></a><span id="l24.24"> }</span>
<a href="#l24.25"></a><span id="l24.25"> ChatBuddy.prototype = GenericConvChatBuddyPrototype;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineat">@@ -102,17 +102,17 @@ Tweet.prototype = {</span>
<a href="#l24.27"></a><span id="l24.27"> function Action(aLabel, aAction, aTweet)</span>
<a href="#l24.28"></a><span id="l24.28"> {</span>
<a href="#l24.29"></a><span id="l24.29">   this.label = aLabel;</span>
<a href="#l24.30"></a><span id="l24.30">   this._action = aAction;</span>
<a href="#l24.31"></a><span id="l24.31">   this._tweet = aTweet;</span>
<a href="#l24.32"></a><span id="l24.32"> }</span>
<a href="#l24.33"></a><span id="l24.33"> Action.prototype = {</span>
<a href="#l24.34"></a><span id="l24.34">   __proto__: ClassInfo(&quot;prplIMessageAction&quot;, &quot;generic message action object&quot;),</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-  get run() this._action.bind(this._tweet)</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  get run() { return this._action.bind(this._tweet); }</span>
<a href="#l24.37"></a><span id="l24.37"> };</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39"> function Conversation(aAccount)</span>
<a href="#l24.40"></a><span id="l24.40"> {</span>
<a href="#l24.41"></a><span id="l24.41">   this._init(aAccount);</span>
<a href="#l24.42"></a><span id="l24.42">   this._ensureParticipantExists(aAccount.name);</span>
<a href="#l24.43"></a><span id="l24.43">   // We need the screen names for the IDs in _friends, but _userInfo is</span>
<a href="#l24.44"></a><span id="l24.44">   // indexed by name, so we build an ID -&gt; name map.</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineat">@@ -137,24 +137,24 @@ Conversation.prototype = {</span>
<a href="#l24.46"></a><span id="l24.46">   startReply: function(aTweet) {</span>
<a href="#l24.47"></a><span id="l24.47">     this.inReplyToStatusId = aTweet.id_str;</span>
<a href="#l24.48"></a><span id="l24.48">     let entities = aTweet.entities;</span>
<a href="#l24.49"></a><span id="l24.49"> </span>
<a href="#l24.50"></a><span id="l24.50">     // Twitter replies go to all the users mentioned in the tweet.</span>
<a href="#l24.51"></a><span id="l24.51">     let nicks = [aTweet.user.screen_name];</span>
<a href="#l24.52"></a><span id="l24.52">     if (&quot;user_mentions&quot; in entities &amp;&amp; Array.isArray(entities.user_mentions)) {</span>
<a href="#l24.53"></a><span id="l24.53">       nicks = nicks.concat(entities.user_mentions</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-                                   .map(function(um) um.screen_name));</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+                                   .map(um =&gt; um.screen_name));</span>
<a href="#l24.56"></a><span id="l24.56">     }</span>
<a href="#l24.57"></a><span id="l24.57">     // Ignore duplicates and the user's nick.</span>
<a href="#l24.58"></a><span id="l24.58">     let prompt =</span>
<a href="#l24.59"></a><span id="l24.59">       nicks.filter(function(aNick, aPos) {</span>
<a href="#l24.60"></a><span id="l24.60">              return nicks.indexOf(aNick) == aPos &amp;&amp; aNick != this._account.name;</span>
<a href="#l24.61"></a><span id="l24.61">            }, this)</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-           .map(function(aNick) &quot;@&quot; + aNick)</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+           .map(aNick =&gt; &quot;@&quot; + aNick)</span>
<a href="#l24.64"></a><span id="l24.64">            .join(&quot; &quot;) + &quot; &quot;;</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66">     this.notifyObservers(null, &quot;replying-to-prompt&quot;, prompt);</span>
<a href="#l24.67"></a><span id="l24.67">     this.notifyObservers(null, &quot;status-text-changed&quot;,</span>
<a href="#l24.68"></a><span id="l24.68">                          _(&quot;replyingToStatusText&quot;, aTweet.text));</span>
<a href="#l24.69"></a><span id="l24.69">   },</span>
<a href="#l24.70"></a><span id="l24.70">   reTweet: function(aTweet) {</span>
<a href="#l24.71"></a><span id="l24.71">     this._account.reTweet(aTweet, this.onSentCallback,</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineat">@@ -232,17 +232,17 @@ Conversation.prototype = {</span>
<a href="#l24.73"></a><span id="l24.73">       let offset = text.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l24.74"></a><span id="l24.74">       text = text.slice(0, offset) + retweet.text;</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76">       // Keep any entities that refer to the prefix (we can refer directly to</span>
<a href="#l24.77"></a><span id="l24.77">       // aTweet for these since they are not edited).</span>
<a href="#l24.78"></a><span id="l24.78">       if (&quot;entities&quot; in aTweet) {</span>
<a href="#l24.79"></a><span id="l24.79">         for (let type in aTweet.entities) {</span>
<a href="#l24.80"></a><span id="l24.80">           let filteredEntities =</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-            aTweet.entities[type].filter(function(e) e.indices[0] &lt; offset);</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+            aTweet.entities[type].filter(e =&gt; e.indices[0] &lt; offset);</span>
<a href="#l24.83"></a><span id="l24.83">           if (filteredEntities.length)</span>
<a href="#l24.84"></a><span id="l24.84">             entities[type] = filteredEntities;</span>
<a href="#l24.85"></a><span id="l24.85">         }</span>
<a href="#l24.86"></a><span id="l24.86">       }</span>
<a href="#l24.87"></a><span id="l24.87"> </span>
<a href="#l24.88"></a><span id="l24.88">       // Add the entities from the retweet (a copy of these must be made since</span>
<a href="#l24.89"></a><span id="l24.89">       // they will be edited and we do not wish to change aTweet).</span>
<a href="#l24.90"></a><span id="l24.90">       if (&quot;entities&quot; in retweet) {</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineat">@@ -250,17 +250,17 @@ Conversation.prototype = {</span>
<a href="#l24.92"></a><span id="l24.92">           if (!(type in entities))</span>
<a href="#l24.93"></a><span id="l24.93">             entities[type] = [];</span>
<a href="#l24.94"></a><span id="l24.94"> </span>
<a href="#l24.95"></a><span id="l24.95">           // Append the entities from the original status.</span>
<a href="#l24.96"></a><span id="l24.96">           entities[type] = entities[type].concat(</span>
<a href="#l24.97"></a><span id="l24.97">             retweet.entities[type].map(function(aEntity) {</span>
<a href="#l24.98"></a><span id="l24.98">               let entity = Object.create(aEntity);</span>
<a href="#l24.99"></a><span id="l24.99">               // Add the offset to the indices to account for the prefix.</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-              entity.indices = entity.indices.map(function(i) i + offset);</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+              entity.indices = entity.indices.map(i =&gt; i + offset);</span>
<a href="#l24.102"></a><span id="l24.102">               return entity;</span>
<a href="#l24.103"></a><span id="l24.103">             })</span>
<a href="#l24.104"></a><span id="l24.104">           );</span>
<a href="#l24.105"></a><span id="l24.105">         }</span>
<a href="#l24.106"></a><span id="l24.106">       }</span>
<a href="#l24.107"></a><span id="l24.107">     } else {</span>
<a href="#l24.108"></a><span id="l24.108">       // For non-retweets, we just want to use the entities that are given.</span>
<a href="#l24.109"></a><span id="l24.109">       if (&quot;entities&quot; in aTweet)</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineat">@@ -275,40 +275,40 @@ Conversation.prototype = {</span>
<a href="#l24.111"></a><span id="l24.111">        *  - str: the string that should be replaced inside the tweet,</span>
<a href="#l24.112"></a><span id="l24.112">        *  - href: the url (href attribute) of the created link tag,</span>
<a href="#l24.113"></a><span id="l24.113">        *  - [optional] text: the text to display for the link,</span>
<a href="#l24.114"></a><span id="l24.114">        *     The original string (str) will be used if this is not set.</span>
<a href="#l24.115"></a><span id="l24.115">        *  - [optional] title: the title attribute for the link.</span>
<a href="#l24.116"></a><span id="l24.116">        */</span>
<a href="#l24.117"></a><span id="l24.117">       let entArray = [];</span>
<a href="#l24.118"></a><span id="l24.118">       if (&quot;hashtags&quot; in entities &amp;&amp; Array.isArray(entities.hashtags)) {</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-        entArray = entArray.concat(entities.hashtags.map(function(h) ({</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+        entArray = entArray.concat(entities.hashtags.map(h =&gt; ({</span>
<a href="#l24.121"></a><span id="l24.121">           start: h.indices[0],</span>
<a href="#l24.122"></a><span id="l24.122">           end: h.indices[1],</span>
<a href="#l24.123"></a><span id="l24.123">           str: &quot;#&quot; + h.text,</span>
<a href="#l24.124"></a><span id="l24.124">           href: &quot;https://twitter.com/#!/search?q=%23&quot; + h.text})));</span>
<a href="#l24.125"></a><span id="l24.125">       }</span>
<a href="#l24.126"></a><span id="l24.126">       if (&quot;urls&quot; in entities &amp;&amp; Array.isArray(entities.urls)) {</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-        entArray = entArray.concat(entities.urls.map(function(u) ({</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+        entArray = entArray.concat(entities.urls.map(u =&gt; ({</span>
<a href="#l24.129"></a><span id="l24.129">           start: u.indices[0],</span>
<a href="#l24.130"></a><span id="l24.130">           end: u.indices[1],</span>
<a href="#l24.131"></a><span id="l24.131">           str: u.url,</span>
<a href="#l24.132"></a><span id="l24.132">           text: u.display_url || u.url,</span>
<a href="#l24.133"></a><span id="l24.133">           href: u.expanded_url || u.url})));</span>
<a href="#l24.134"></a><span id="l24.134">       }</span>
<a href="#l24.135"></a><span id="l24.135">       if (&quot;user_mentions&quot; in entities &amp;&amp;</span>
<a href="#l24.136"></a><span id="l24.136">           Array.isArray(entities.user_mentions)) {</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-        entArray = entArray.concat(entities.user_mentions.map(function(um) ({</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+        entArray = entArray.concat(entities.user_mentions.map(um =&gt; ({</span>
<a href="#l24.139"></a><span id="l24.139">           start: um.indices[0],</span>
<a href="#l24.140"></a><span id="l24.140">           end: um.indices[1],</span>
<a href="#l24.141"></a><span id="l24.141">           str: &quot;@&quot; + um.screen_name,</span>
<a href="#l24.142"></a><span id="l24.142">           title: um.name,</span>
<a href="#l24.143"></a><span id="l24.143">           href: &quot;https://twitter.com/&quot; + um.screen_name})));</span>
<a href="#l24.144"></a><span id="l24.144">       }</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-      entArray.sort(function(a, b) a.start - b.start);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+      entArray.sort((a, b) =&gt; a.start - b.start);</span>
<a href="#l24.147"></a><span id="l24.147">       let offset = 0;</span>
<a href="#l24.148"></a><span id="l24.148">       for each (let entity in entArray) {</span>
<a href="#l24.149"></a><span id="l24.149">         let str = text.substring(offset + entity.start, offset + entity.end);</span>
<a href="#l24.150"></a><span id="l24.150">         if (str[0] == &quot;\uFF20&quot;) //  - unicode character similar to @</span>
<a href="#l24.151"></a><span id="l24.151">           str = &quot;@&quot; + str.substring(1);</span>
<a href="#l24.152"></a><span id="l24.152">         if (str[0] == &quot;\uFF03&quot;) //  - unicode character similar to #</span>
<a href="#l24.153"></a><span id="l24.153">           str = &quot;#&quot; + str.substring(1);</span>
<a href="#l24.154"></a><span id="l24.154">         if (str.toLowerCase() != entity.str.toLowerCase())</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineat">@@ -346,22 +346,22 @@ Conversation.prototype = {</span>
<a href="#l24.156"></a><span id="l24.156">     if (this._participants.has(aNick))</span>
<a href="#l24.157"></a><span id="l24.157">       return;</span>
<a href="#l24.158"></a><span id="l24.158"> </span>
<a href="#l24.159"></a><span id="l24.159">     let chatBuddy = new ChatBuddy(aNick);</span>
<a href="#l24.160"></a><span id="l24.160">     this._participants.set(aNick, chatBuddy);</span>
<a href="#l24.161"></a><span id="l24.161">     this.notifyObservers(new nsSimpleEnumerator([chatBuddy]),</span>
<a href="#l24.162"></a><span id="l24.162">                          &quot;chat-buddy-add&quot;);</span>
<a href="#l24.163"></a><span id="l24.163">   },</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-  get name() this.nick + &quot; timeline&quot;,</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-  get title() _(&quot;timeline&quot;, this.nick),</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-  get nick() this._account.name,</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+  get name() { return this.nick + &quot; timeline&quot;; },</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+  get title() { return _(&quot;timeline&quot;, this.nick); },</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+  get nick() { return this._account.name; },</span>
<a href="#l24.170"></a><span id="l24.170">   set nick(aNick) {},</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-  get topicSettable() this.nick == this._account.name,</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-  get topic() this._topic, // can't add a setter without redefining the getter</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+  get topicSettable() { return this.nick == this._account.name; },</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+  get topic() { return this._topic; }, // can't add a setter without redefining the getter</span>
<a href="#l24.175"></a><span id="l24.175">   set topic(aTopic) {</span>
<a href="#l24.176"></a><span id="l24.176">     if (this.topicSettable)</span>
<a href="#l24.177"></a><span id="l24.177">       this._account.setUserDescription(aTopic);</span>
<a href="#l24.178"></a><span id="l24.178">   }</span>
<a href="#l24.179"></a><span id="l24.179"> };</span>
<a href="#l24.180"></a><span id="l24.180"> </span>
<a href="#l24.181"></a><span id="l24.181"> function Account(aProtocol, aImAccount)</span>
<a href="#l24.182"></a><span id="l24.182"> {</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineat">@@ -371,17 +371,17 @@ function Account(aProtocol, aImAccount)</span>
<a href="#l24.184"></a><span id="l24.184">   this._friends = new Set();</span>
<a href="#l24.185"></a><span id="l24.185"> }</span>
<a href="#l24.186"></a><span id="l24.186"> Account.prototype = {</span>
<a href="#l24.187"></a><span id="l24.187">   __proto__: GenericAccountPrototype,</span>
<a href="#l24.188"></a><span id="l24.188"> </span>
<a href="#l24.189"></a><span id="l24.189">   // The correct normalization for twitter would be just toLowerCase().</span>
<a href="#l24.190"></a><span id="l24.190">   // Unfortunately, for backwards compatibility we retain this normalization,</span>
<a href="#l24.191"></a><span id="l24.191">   // which can cause edge cases for usernames with underscores.</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineminus">-  normalize: function(aString) aString.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(),</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+  normalize: aString =&gt; aString.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(),</span>
<a href="#l24.194"></a><span id="l24.194"> </span>
<a href="#l24.195"></a><span id="l24.195">   consumerKey: Services.prefs.getCharPref(&quot;chat.twitter.consumerKey&quot;),</span>
<a href="#l24.196"></a><span id="l24.196">   consumerSecret: Services.prefs.getCharPref(&quot;chat.twitter.consumerSecret&quot;),</span>
<a href="#l24.197"></a><span id="l24.197">   completionURI: &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l24.198"></a><span id="l24.198">   baseURI: &quot;https://api.twitter.com/&quot;,</span>
<a href="#l24.199"></a><span id="l24.199">   _lastMsgId: &quot;&quot;,</span>
<a href="#l24.200"></a><span id="l24.200"> </span>
<a href="#l24.201"></a><span id="l24.201">   // Use this to keep track of the pending timeline requests. We attempt to fetch</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineat">@@ -466,49 +466,49 @@ Account.prototype = {</span>
<a href="#l24.203"></a><span id="l24.203"> </span>
<a href="#l24.204"></a><span id="l24.204">     let dataParams = [];</span>
<a href="#l24.205"></a><span id="l24.205">     let url = /^https?:/.test(aUrl) ? aUrl : this.baseURI + aUrl;</span>
<a href="#l24.206"></a><span id="l24.206">     let urlSpec = url;</span>
<a href="#l24.207"></a><span id="l24.207">     let queryIndex = url.indexOf(&quot;?&quot;);</span>
<a href="#l24.208"></a><span id="l24.208">     if (queryIndex != -1) {</span>
<a href="#l24.209"></a><span id="l24.209">       urlSpec = url.slice(0, queryIndex);</span>
<a href="#l24.210"></a><span id="l24.210">       dataParams = url.slice(queryIndex + 1).split(&quot;&amp;&quot;)</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-                      .map(function(p) p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+                      .map(p =&gt; p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l24.213"></a><span id="l24.213">     }</span>
<a href="#l24.214"></a><span id="l24.214">     let method = &quot;GET&quot;;</span>
<a href="#l24.215"></a><span id="l24.215">     if (aPOSTData) {</span>
<a href="#l24.216"></a><span id="l24.216">       method = &quot;POST&quot;;</span>
<a href="#l24.217"></a><span id="l24.217">       aPOSTData.forEach(function (p) {</span>
<a href="#l24.218"></a><span id="l24.218">         dataParams.push(p.map(percentEncode));</span>
<a href="#l24.219"></a><span id="l24.219">       });</span>
<a href="#l24.220"></a><span id="l24.220">     }</span>
<a href="#l24.221"></a><span id="l24.221"> </span>
<a href="#l24.222"></a><span id="l24.222">     let signatureKey = this.consumerSecret + &quot;&amp;&quot; + this.tokenSecret;</span>
<a href="#l24.223"></a><span id="l24.223">     let signatureBase =</span>
<a href="#l24.224"></a><span id="l24.224">       method + &quot;&amp;&quot; + encodeURIComponent(urlSpec) + &quot;&amp;&quot; +</span>
<a href="#l24.225"></a><span id="l24.225">       params.concat(dataParams)</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-            .sort(function(a,b) (a[0] &lt; b[0]) ? -1 : (a[0] &gt; b[0]) ? 1 : 0)</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-            .map(function(p) p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+            .sort((a, b) =&gt; (a[0] &lt; b[0]) ? -1 : (a[0] &gt; b[0]) ? 1 : 0)</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+            .map(p =&gt; p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l24.230"></a><span id="l24.230">             .join(&quot;%26&quot;);</span>
<a href="#l24.231"></a><span id="l24.231"> </span>
<a href="#l24.232"></a><span id="l24.232">     let keyFactory = Cc[&quot;@mozilla.org/security/keyobjectfactory;1&quot;]</span>
<a href="#l24.233"></a><span id="l24.233">                      .getService(Ci.nsIKeyObjectFactory);</span>
<a href="#l24.234"></a><span id="l24.234">     let hmac =</span>
<a href="#l24.235"></a><span id="l24.235">       Cc[&quot;@mozilla.org/security/hmac;1&quot;].createInstance(Ci.nsICryptoHMAC);</span>
<a href="#l24.236"></a><span id="l24.236">     hmac.init(hmac.SHA1,</span>
<a href="#l24.237"></a><span id="l24.237">               keyFactory.keyFromString(Ci.nsIKeyObject.HMAC, signatureKey));</span>
<a href="#l24.238"></a><span id="l24.238">     // No UTF-8 encoding, special chars are already escaped.</span>
<a href="#l24.239"></a><span id="l24.239">     let bytes = [b.charCodeAt() for each (b in signatureBase)];</span>
<a href="#l24.240"></a><span id="l24.240">     hmac.update(bytes, bytes.length);</span>
<a href="#l24.241"></a><span id="l24.241">     let signature = hmac.finish(true);</span>
<a href="#l24.242"></a><span id="l24.242"> </span>
<a href="#l24.243"></a><span id="l24.243">     params.push([&quot;oauth_signature&quot;, encodeURIComponent(signature)]);</span>
<a href="#l24.244"></a><span id="l24.244"> </span>
<a href="#l24.245"></a><span id="l24.245">     let authorization =</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-      &quot;OAuth &quot; + params.map(function (p) p[0] + &quot;=\&quot;&quot; + p[1] + &quot;\&quot;&quot;).join(&quot;, &quot;);</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineplus">+      &quot;OAuth &quot; + params.map(p =&gt; p[0] + &quot;=\&quot;&quot; + p[1] + &quot;\&quot;&quot;).join(&quot;, &quot;);</span>
<a href="#l24.248"></a><span id="l24.248"> </span>
<a href="#l24.249"></a><span id="l24.249">     let options = {</span>
<a href="#l24.250"></a><span id="l24.250">       headers: (aHeaders || []).concat([[&quot;Authorization&quot;, authorization]]),</span>
<a href="#l24.251"></a><span id="l24.251">       postData: aPOSTData,</span>
<a href="#l24.252"></a><span id="l24.252">       onLoad: aOnLoad ? aOnLoad.bind(aThis) : null,</span>
<a href="#l24.253"></a><span id="l24.253">       onError: aOnError ? aOnError.bind(aThis) : null,</span>
<a href="#l24.254"></a><span id="l24.254">       logger: {log: this.LOG.bind(this),</span>
<a href="#l24.255"></a><span id="l24.255">                debug: this.DEBUG.bind(this)}</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineat">@@ -595,17 +595,17 @@ Account.prototype = {</span>
<a href="#l24.257"></a><span id="l24.257">       getParams = &quot;?q=&quot; + trackQuery + lastMsgParam + &quot;&amp;count=100&quot;;</span>
<a href="#l24.258"></a><span id="l24.258">       let url = &quot;1.1/search/tweets.json&quot; + getParams;</span>
<a href="#l24.259"></a><span id="l24.259">       this._pendingRequests.push(</span>
<a href="#l24.260"></a><span id="l24.260">         this.signAndSend(url, null, null, this.onTimelineReceived,</span>
<a href="#l24.261"></a><span id="l24.261">                          this.onTimelineError, this, null));</span>
<a href="#l24.262"></a><span id="l24.262">     }</span>
<a href="#l24.263"></a><span id="l24.263">   },</span>
<a href="#l24.264"></a><span id="l24.264"> </span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-  get timeline() this._timeline || (this._timeline = new Conversation(this)),</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineplus">+  get timeline() { return this._timeline || (this._timeline = new Conversation(this)); },</span>
<a href="#l24.267"></a><span id="l24.267">   displayMessages: function(aMessages) {</span>
<a href="#l24.268"></a><span id="l24.268">     let lastMsgId = this._lastMsgId;</span>
<a href="#l24.269"></a><span id="l24.269">     for each (let tweet in aMessages) {</span>
<a href="#l24.270"></a><span id="l24.270">       if (!(&quot;user&quot; in tweet) || !(&quot;text&quot; in tweet) || !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l24.271"></a><span id="l24.271">           this._knownMessageIds.has(tweet.id_str))</span>
<a href="#l24.272"></a><span id="l24.272">         continue;</span>
<a href="#l24.273"></a><span id="l24.273">       let id = tweet.id_str;</span>
<a href="#l24.274"></a><span id="l24.274">       // Update the last known message.</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineat">@@ -633,17 +633,17 @@ Account.prototype = {</span>
<a href="#l24.276"></a><span id="l24.276"> </span>
<a href="#l24.277"></a><span id="l24.277">   onTimelineReceived: function(aData, aRequest) {</span>
<a href="#l24.278"></a><span id="l24.278">     this._timelineBuffer = this._timelineBuffer.concat(JSON.parse(aData));</span>
<a href="#l24.279"></a><span id="l24.279">     this._doneWithTimelineRequest(aRequest);</span>
<a href="#l24.280"></a><span id="l24.280">   },</span>
<a href="#l24.281"></a><span id="l24.281"> </span>
<a href="#l24.282"></a><span id="l24.282">   _doneWithTimelineRequest: function(aRequest) {</span>
<a href="#l24.283"></a><span id="l24.283">     this._pendingRequests =</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-      this._pendingRequests.filter(function (r) r !== aRequest);</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineplus">+      this._pendingRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l24.286"></a><span id="l24.286"> </span>
<a href="#l24.287"></a><span id="l24.287">     // If we are still waiting for more data, return early</span>
<a href="#l24.288"></a><span id="l24.288">     if (this._pendingRequests.length != 0)</span>
<a href="#l24.289"></a><span id="l24.289">       return;</span>
<a href="#l24.290"></a><span id="l24.290"> </span>
<a href="#l24.291"></a><span id="l24.291">     if (this._timelineAuthError &gt;= 2) {</span>
<a href="#l24.292"></a><span id="l24.292">       // 2 out of the 3 timeline requests are authenticated.</span>
<a href="#l24.293"></a><span id="l24.293">       // With at least 2 '401 - Unauthorized' errors, we are sure</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineat">@@ -678,17 +678,17 @@ Account.prototype = {</span>
<a href="#l24.295"></a><span id="l24.295">     // Reset in case we get disconnected</span>
<a href="#l24.296"></a><span id="l24.296">     delete this._timelineBuffer;</span>
<a href="#l24.297"></a><span id="l24.297">     delete this._pendingRequests;</span>
<a href="#l24.298"></a><span id="l24.298"> </span>
<a href="#l24.299"></a><span id="l24.299">     // Open the streams to get the live data.</span>
<a href="#l24.300"></a><span id="l24.300">     this.openStream();</span>
<a href="#l24.301"></a><span id="l24.301">   },</span>
<a href="#l24.302"></a><span id="l24.302"> </span>
<a href="#l24.303"></a><span id="l24.303" class="difflineminus">-  sortByDate: function(a, b)</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineplus">+  sortByDate: (a, b) =&gt;</span>
<a href="#l24.305"></a><span id="l24.305">     (new Date(a[&quot;created_at&quot;])) - (new Date(b[&quot;created_at&quot;])),</span>
<a href="#l24.306"></a><span id="l24.306"> </span>
<a href="#l24.307"></a><span id="l24.307">   _streamingRequest: null,</span>
<a href="#l24.308"></a><span id="l24.308">   _pendingData: &quot;&quot;,</span>
<a href="#l24.309"></a><span id="l24.309">   openStream: function() {</span>
<a href="#l24.310"></a><span id="l24.310">     let track = this.getString(&quot;track&quot;);</span>
<a href="#l24.311"></a><span id="l24.311">     this._streamingRequest =</span>
<a href="#l24.312"></a><span id="l24.312">       this.signAndSend(&quot;https://userstream.twitter.com/1.1/user.json&quot;, null,</span>
<a href="#l24.313"></a><span id="l24.313" class="difflineat">@@ -736,29 +736,29 @@ Account.prototype = {</span>
<a href="#l24.314"></a><span id="l24.314">         this.displayMessages([msg]);</span>
<a href="#l24.315"></a><span id="l24.315">       else if (&quot;friends&quot; in msg) {</span>
<a href="#l24.316"></a><span id="l24.316">         // Filter out the IDs that info has already been received from (e.g. a</span>
<a href="#l24.317"></a><span id="l24.317">         // tweet has been received as part of the timeline request).</span>
<a href="#l24.318"></a><span id="l24.318">         let userInfoIds = new Set();</span>
<a href="#l24.319"></a><span id="l24.319">         for each (let userInfo in this._userInfo)</span>
<a href="#l24.320"></a><span id="l24.320">           userInfoIds.add(userInfo.id_str);</span>
<a href="#l24.321"></a><span id="l24.321">         let ids = msg.friends.filter(</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-          function(aId) !userInfoIds.has(aId.toString()), this);</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineplus">+          aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l24.324"></a><span id="l24.324"> </span>
<a href="#l24.325"></a><span id="l24.325">         while (ids.length) {</span>
<a href="#l24.326"></a><span id="l24.326">           // Take the first 100 elements, turn them into a comma separated list.</span>
<a href="#l24.327"></a><span id="l24.327">           this.signAndSend(&quot;1.1/users/lookup.json&quot;, null,</span>
<a href="#l24.328"></a><span id="l24.328">                            [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l24.329"></a><span id="l24.329">                            this.onLookupReceived, null, this);</span>
<a href="#l24.330"></a><span id="l24.330">           // Remove the first 100 elements.</span>
<a href="#l24.331"></a><span id="l24.331">           ids = ids.slice(100);</span>
<a href="#l24.332"></a><span id="l24.332">         }</span>
<a href="#l24.333"></a><span id="l24.333"> </span>
<a href="#l24.334"></a><span id="l24.334">         // Overwrite the existing _friends list (if any).</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineminus">-        this._friends = new Set(msg.friends.map(function(aId) aId.toString()));</span>
<a href="#l24.336"></a><span id="l24.336" class="difflineplus">+        this._friends = new Set(msg.friends.map(aId =&gt; aId.toString()));</span>
<a href="#l24.337"></a><span id="l24.337">       }</span>
<a href="#l24.338"></a><span id="l24.338">       else if (&quot;event&quot; in msg) {</span>
<a href="#l24.339"></a><span id="l24.339">         let user, event;</span>
<a href="#l24.340"></a><span id="l24.340">         switch(msg.event) {</span>
<a href="#l24.341"></a><span id="l24.341">           case &quot;follow&quot;:</span>
<a href="#l24.342"></a><span id="l24.342">             if (msg.source.screen_name == this.name) {</span>
<a href="#l24.343"></a><span id="l24.343">               this._friends.add(msg.target.id_str);</span>
<a href="#l24.344"></a><span id="l24.344">               user = msg.target;</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineat">@@ -806,17 +806,17 @@ Account.prototype = {</span>
<a href="#l24.346"></a><span id="l24.346">   },</span>
<a href="#l24.347"></a><span id="l24.347">   requestAuthorization: function() {</span>
<a href="#l24.348"></a><span id="l24.348">     this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l24.349"></a><span id="l24.349">     let url = this.baseURI + &quot;oauth/authorize?&quot; +</span>
<a href="#l24.350"></a><span id="l24.350">       &quot;force_login=true&amp;&quot; + // ignore cookies</span>
<a href="#l24.351"></a><span id="l24.351">       &quot;screen_name=&quot; + this.name + &quot;&amp;&quot; + // prefill the user name input box</span>
<a href="#l24.352"></a><span id="l24.352">       &quot;oauth_token=&quot; + this.token;</span>
<a href="#l24.353"></a><span id="l24.353">     this._browserRequest = {</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineminus">-      get promptText() _(&quot;authPrompt&quot;),</span>
<a href="#l24.355"></a><span id="l24.355" class="difflineplus">+      get promptText() { return _(&quot;authPrompt&quot;); },</span>
<a href="#l24.356"></a><span id="l24.356">       account: this,</span>
<a href="#l24.357"></a><span id="l24.357">       url: url,</span>
<a href="#l24.358"></a><span id="l24.358">       _active: true,</span>
<a href="#l24.359"></a><span id="l24.359">       cancelled: function() {</span>
<a href="#l24.360"></a><span id="l24.360">         if (!this._active)</span>
<a href="#l24.361"></a><span id="l24.361">           return;</span>
<a href="#l24.362"></a><span id="l24.362"> </span>
<a href="#l24.363"></a><span id="l24.363">         this.account</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineat">@@ -920,17 +920,17 @@ Account.prototype = {</span>
<a href="#l24.365"></a><span id="l24.365"> </span>
<a href="#l24.366"></a><span id="l24.366">     if (aAuthResult.screen_name.toLowerCase() != this.name.toLowerCase()) {</span>
<a href="#l24.367"></a><span id="l24.367">       this.onError(_(&quot;connection.error.userMismatch&quot;));</span>
<a href="#l24.368"></a><span id="l24.368">       return false;</span>
<a href="#l24.369"></a><span id="l24.369">     }</span>
<a href="#l24.370"></a><span id="l24.370"> </span>
<a href="#l24.371"></a><span id="l24.371">     this.LOG(&quot;Fixing the case of the account name: &quot; +</span>
<a href="#l24.372"></a><span id="l24.372">              this.name + &quot; -&gt; &quot; + aAuthResult.screen_name);</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineminus">-    this.__defineGetter__(&quot;name&quot;, function() aAuthResult.screen_name);</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineplus">+    this.__defineGetter__(&quot;name&quot;, () =&gt; aAuthResult.screen_name);</span>
<a href="#l24.375"></a><span id="l24.375">     return true;</span>
<a href="#l24.376"></a><span id="l24.376">   },</span>
<a href="#l24.377"></a><span id="l24.377"> </span>
<a href="#l24.378"></a><span id="l24.378">   cleanUp: function() {</span>
<a href="#l24.379"></a><span id="l24.379">     this.finishAuthorizationRequest();</span>
<a href="#l24.380"></a><span id="l24.380">     if (this._pendingRequests.length != 0) {</span>
<a href="#l24.381"></a><span id="l24.381">       for each (let request in this._pendingRequests)</span>
<a href="#l24.382"></a><span id="l24.382">         request.abort();</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineat">@@ -1019,34 +1019,34 @@ Account.prototype = {</span>
<a href="#l24.384"></a><span id="l24.384">       this.signAndSend(&quot;1.1/users/show.json?screen_name=&quot; + aBuddyName, null,</span>
<a href="#l24.385"></a><span id="l24.385">                        null, this.onRequestedInfoReceived, null, this);</span>
<a href="#l24.386"></a><span id="l24.386">       return;</span>
<a href="#l24.387"></a><span id="l24.387">     }</span>
<a href="#l24.388"></a><span id="l24.388"> </span>
<a href="#l24.389"></a><span id="l24.389">     // List of the names of the info to actually show in the tooltip and</span>
<a href="#l24.390"></a><span id="l24.390">     // optionally a transform function to apply to the value.</span>
<a href="#l24.391"></a><span id="l24.391">     // See https://dev.twitter.com/docs/api/1/get/users/show for the options.</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineminus">-    let normalizeBool = function(isFollowing) _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineplus">+    let normalizeBool = isFollowing =&gt; _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l24.394"></a><span id="l24.394">     const kFields = {</span>
<a href="#l24.395"></a><span id="l24.395">       name: null,</span>
<a href="#l24.396"></a><span id="l24.396">       following: normalizeBool,</span>
<a href="#l24.397"></a><span id="l24.397">       description: null,</span>
<a href="#l24.398"></a><span id="l24.398">       url: null,</span>
<a href="#l24.399"></a><span id="l24.399">       location: null,</span>
<a href="#l24.400"></a><span id="l24.400">       lang: function(aLang) {</span>
<a href="#l24.401"></a><span id="l24.401">         try {</span>
<a href="#l24.402"></a><span id="l24.402">           return _lang(aLang);</span>
<a href="#l24.403"></a><span id="l24.403">         }</span>
<a href="#l24.404"></a><span id="l24.404">         catch(e) {</span>
<a href="#l24.405"></a><span id="l24.405">           return aLang;</span>
<a href="#l24.406"></a><span id="l24.406">         }</span>
<a href="#l24.407"></a><span id="l24.407">       },</span>
<a href="#l24.408"></a><span id="l24.408">       time_zone: null,</span>
<a href="#l24.409"></a><span id="l24.409">       protected: normalizeBool,</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineminus">-      created_at: function(aDate) (new Date(aDate)).toLocaleDateString(),</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineplus">+      created_at: aDate =&gt; (new Date(aDate)).toLocaleDateString(),</span>
<a href="#l24.412"></a><span id="l24.412">       statuses_count: null,</span>
<a href="#l24.413"></a><span id="l24.413">       friends_count: null,</span>
<a href="#l24.414"></a><span id="l24.414">       followers_count: null,</span>
<a href="#l24.415"></a><span id="l24.415">       listed_count: null</span>
<a href="#l24.416"></a><span id="l24.416">     };</span>
<a href="#l24.417"></a><span id="l24.417"> </span>
<a href="#l24.418"></a><span id="l24.418">     let tooltipInfo = [];</span>
<a href="#l24.419"></a><span id="l24.419">     for (let field in kFields) {</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineat">@@ -1073,63 +1073,63 @@ Account.prototype = {</span>
<a href="#l24.421"></a><span id="l24.421">     }</span>
<a href="#l24.422"></a><span id="l24.422">   },</span>
<a href="#l24.423"></a><span id="l24.423"> </span>
<a href="#l24.424"></a><span id="l24.424">   onConfigReceived: function(aData) {</span>
<a href="#l24.425"></a><span id="l24.425">     this.config = JSON.parse(aData);</span>
<a href="#l24.426"></a><span id="l24.426">   },</span>
<a href="#l24.427"></a><span id="l24.427"> </span>
<a href="#l24.428"></a><span id="l24.428">   // Allow us to reopen the timeline via the join chat menu.</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-  get canJoinChat() true,</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineplus">+  get canJoinChat() { return true; },</span>
<a href="#l24.431"></a><span id="l24.431">   joinChat: function(aComponents) {</span>
<a href="#l24.432"></a><span id="l24.432">     // The 'timeline' getter opens a timeline conversation if none exists.</span>
<a href="#l24.433"></a><span id="l24.433">     this.timeline;</span>
<a href="#l24.434"></a><span id="l24.434">   }</span>
<a href="#l24.435"></a><span id="l24.435"> };</span>
<a href="#l24.436"></a><span id="l24.436"> </span>
<a href="#l24.437"></a><span id="l24.437"> // Shortcut to get the JavaScript account object.</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineminus">-function getAccount(aConv) aConv.wrappedJSObject._account;</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineplus">+function getAccount(aConv) { return aConv.wrappedJSObject._account; }</span>
<a href="#l24.440"></a><span id="l24.440"> </span>
<a href="#l24.441"></a><span id="l24.441"> function TwitterProtocol() {</span>
<a href="#l24.442"></a><span id="l24.442">   this.registerCommands();</span>
<a href="#l24.443"></a><span id="l24.443"> }</span>
<a href="#l24.444"></a><span id="l24.444"> TwitterProtocol.prototype = {</span>
<a href="#l24.445"></a><span id="l24.445">   __proto__: GenericProtocolPrototype,</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineminus">-  get normalizedName() &quot;twitter&quot;,</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineminus">-  get name() _(&quot;twitter.protocolName&quot;),</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-twitter/skin/&quot;,</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineminus">-  get noPassword() true,</span>
<a href="#l24.450"></a><span id="l24.450" class="difflineplus">+  get normalizedName() { return &quot;twitter&quot;; },</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineplus">+  get name() { return _(&quot;twitter.protocolName&quot;); },</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-twitter/skin/&quot;; },</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineplus">+  get noPassword() { return true; },</span>
<a href="#l24.454"></a><span id="l24.454">   options: {</span>
<a href="#l24.455"></a><span id="l24.455" class="difflineminus">-    &quot;track&quot;: {get label() _(&quot;options.track&quot;), default: &quot;&quot;}</span>
<a href="#l24.456"></a><span id="l24.456" class="difflineplus">+    &quot;track&quot;: {get label() { return _(&quot;options.track&quot;); }, default: &quot;&quot;}</span>
<a href="#l24.457"></a><span id="l24.457">   },</span>
<a href="#l24.458"></a><span id="l24.458">   // Replace the command name in the help string so translators do not attempt</span>
<a href="#l24.459"></a><span id="l24.459">   // to translate it.</span>
<a href="#l24.460"></a><span id="l24.460">   commands: [</span>
<a href="#l24.461"></a><span id="l24.461">     {</span>
<a href="#l24.462"></a><span id="l24.462">       name: &quot;follow&quot;,</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineminus">-      get helpString() _(&quot;command.follow&quot;, &quot;follow&quot;),</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineplus">+      get helpString() { return _(&quot;command.follow&quot;, &quot;follow&quot;); },</span>
<a href="#l24.465"></a><span id="l24.465">       run: function(aMsg, aConv) {</span>
<a href="#l24.466"></a><span id="l24.466">         aMsg = aMsg.trim();</span>
<a href="#l24.467"></a><span id="l24.467">         if (!aMsg)</span>
<a href="#l24.468"></a><span id="l24.468">           return false;</span>
<a href="#l24.469"></a><span id="l24.469">         let account = getAccount(aConv);</span>
<a href="#l24.470"></a><span id="l24.470">         aMsg.split(&quot; &quot;).forEach(account.follow, account);</span>
<a href="#l24.471"></a><span id="l24.471">         return true;</span>
<a href="#l24.472"></a><span id="l24.472">       }</span>
<a href="#l24.473"></a><span id="l24.473">     },</span>
<a href="#l24.474"></a><span id="l24.474">     {</span>
<a href="#l24.475"></a><span id="l24.475">       name: &quot;unfollow&quot;,</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineminus">-      get helpString() _(&quot;command.unfollow&quot;, &quot;unfollow&quot;),</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineplus">+      get helpString() { return _(&quot;command.unfollow&quot;, &quot;unfollow&quot;); },</span>
<a href="#l24.478"></a><span id="l24.478">       run: function(aMsg, aConv) {</span>
<a href="#l24.479"></a><span id="l24.479">         aMsg = aMsg.trim();</span>
<a href="#l24.480"></a><span id="l24.480">         if (!aMsg)</span>
<a href="#l24.481"></a><span id="l24.481">           return false;</span>
<a href="#l24.482"></a><span id="l24.482">         let account = getAccount(aConv);</span>
<a href="#l24.483"></a><span id="l24.483">         aMsg.split(&quot; &quot;).forEach(account.stopFollowing, account);</span>
<a href="#l24.484"></a><span id="l24.484">         return true;</span>
<a href="#l24.485"></a><span id="l24.485">       }</span>
<a href="#l24.486"></a><span id="l24.486">     }</span>
<a href="#l24.487"></a><span id="l24.487">   ],</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineminus">-  getAccount: function(aImAccount) new Account(this, aImAccount),</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+  getAccount: function(aImAccount) { return new Account(this, aImAccount); },</span>
<a href="#l24.490"></a><span id="l24.490">   classID: Components.ID(&quot;{31082ff6-1de8-422b-ab60-ca0ac0b2af13}&quot;)</span>
<a href="#l24.491"></a><span id="l24.491"> };</span>
<a href="#l24.492"></a><span id="l24.492"> </span>
<a href="#l24.493"></a><span id="l24.493"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([TwitterProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -18,22 +18,24 @@ Cu.import(&quot;resource:///modules/xmpp-xml.</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> /* Handle PLAIN authorization mechanism */</span>
<a href="#l25.6"></a><span id="l25.6"> function PlainAuth(username, password, domain) {</span>
<a href="#l25.7"></a><span id="l25.7">   let data = &quot;\0&quot;+ username + &quot;\0&quot; + password;</span>
<a href="#l25.8"></a><span id="l25.8">   // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l25.9"></a><span id="l25.9">   this._base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l25.10"></a><span id="l25.10"> }</span>
<a href="#l25.11"></a><span id="l25.11"> PlainAuth.prototype = {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  next: function(aStanza) ({</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-    done: true,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-                      this._base64Data),</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-    log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)'</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-  })</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  next: function(aStanza) {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+    return {</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+      done: true,</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+      send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+                        this._base64Data),</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+      log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)'</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+    };</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+  }</span>
<a href="#l25.26"></a><span id="l25.26"> };</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29"> /* Handles DIGEST-MD5 authorization mechanism */</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31"> // md5 function adapted from netwerk/test/unit/test_authentication.js</span>
<a href="#l25.32"></a><span id="l25.32"> // If aUTF8 is true, aString will be treated as an UTF8 encoded string,</span>
<a href="#l25.33"></a><span id="l25.33"> // otherwise it can contain binary data.</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineat">@@ -51,17 +53,17 @@ function md5(aString, aUTF8) {</span>
<a href="#l25.35"></a><span id="l25.35">   else</span>
<a href="#l25.36"></a><span id="l25.36">     data = [aString.charCodeAt(i) for (i in aString)];</span>
<a href="#l25.37"></a><span id="l25.37"> </span>
<a href="#l25.38"></a><span id="l25.38">   ch.update(data, data.length);</span>
<a href="#l25.39"></a><span id="l25.39">   return ch.finish(false);</span>
<a href="#l25.40"></a><span id="l25.40"> }</span>
<a href="#l25.41"></a><span id="l25.41"> function md5hex(aString) {</span>
<a href="#l25.42"></a><span id="l25.42">   let hash = md5(aString);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-  function toHexString(charCode) (&quot;0&quot; + charCode.toString(16)).slice(-2)</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  function toHexString(charCode) { return (&quot;0&quot; + charCode.toString(16)).slice(-2); }</span>
<a href="#l25.45"></a><span id="l25.45">   return [toHexString(hash.charCodeAt(i)) for (i in hash)].join(&quot;&quot;);</span>
<a href="#l25.46"></a><span id="l25.46"> }</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> function digestMD5(aName, aRealm, aPassword, aNonce, aCnonce, aDigestUri) {</span>
<a href="#l25.49"></a><span id="l25.49">   let y = md5(aName + &quot;:&quot; + aRealm + &quot;:&quot; + aPassword, true);</span>
<a href="#l25.50"></a><span id="l25.50">   return md5hex(md5hex(y + &quot;:&quot; + aNonce + &quot;:&quot; + aCnonce) +</span>
<a href="#l25.51"></a><span id="l25.51">                 &quot;:&quot; + aNonce + &quot;:00000001:&quot; + aCnonce + &quot;:auth:&quot; +</span>
<a href="#l25.52"></a><span id="l25.52">                 md5hex(&quot;AUTHENTICATE:&quot; + aDigestUri));</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineat">@@ -111,17 +113,17 @@ DigestMD5Auth.prototype = {</span>
<a href="#l25.54"></a><span id="l25.54">     data.qop = &quot;auth&quot;,</span>
<a href="#l25.55"></a><span id="l25.55">     data[&quot;digest-uri&quot;] = &quot;xmpp/&quot; + this._domain + (data.host ? &quot;/&quot; + host : &quot;&quot;);</span>
<a href="#l25.56"></a><span id="l25.56">     data.response = digestMD5(this._username, data.realm, this._password,</span>
<a href="#l25.57"></a><span id="l25.57">                               data.nonce, data.cnonce, data[&quot;digest-uri&quot;]);</span>
<a href="#l25.58"></a><span id="l25.58">     data.charset = &quot;utf-8&quot;;</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60">     let response =</span>
<a href="#l25.61"></a><span id="l25.61">       [&quot;username&quot;, &quot;realm&quot;, &quot;nonce&quot;, &quot;cnonce&quot;, &quot;nc&quot;, &quot;qop&quot;, &quot;digest-uri&quot;,</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-       &quot;response&quot;, &quot;charset&quot;].map(function(key) key + &quot;=\&quot;&quot; + data[key] + &quot;\&quot;&quot;)</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+       &quot;response&quot;, &quot;charset&quot;].map(key =&gt; key + &quot;=\&quot;&quot; + data[key] + &quot;\&quot;&quot;)</span>
<a href="#l25.64"></a><span id="l25.64">                              .join(&quot;,&quot;);</span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66">     this.next = this._finish;</span>
<a href="#l25.67"></a><span id="l25.67"> </span>
<a href="#l25.68"></a><span id="l25.68">     return {</span>
<a href="#l25.69"></a><span id="l25.69">       done: false,</span>
<a href="#l25.70"></a><span id="l25.70">       send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl, null, btoa(response)),</span>
<a href="#l25.71"></a><span id="l25.71">       log: '&lt;response/&gt; (base64 encoded MD5 response containing password not logged)'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-commands.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3,30 +3,34 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> const EXPORTED_SYMBOLS = [&quot;commands&quot;];</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l26.14"></a><span id="l26.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l26.15"></a><span id="l26.15"> );</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17"> // Get conversation object.</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-function getConv(aConv) aConv.wrappedJSObject;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+function getConv(aConv) {</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+  return aConv.wrappedJSObject;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+}</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23"> // Get account object.</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-function getAccount(aConv) getConv(aConv)._account;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+function getAccount(aConv) {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+  return getConv(aConv)._account;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+}</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29"> var commands = [</span>
<a href="#l26.30"></a><span id="l26.30">   {</span>
<a href="#l26.31"></a><span id="l26.31">     name: &quot;join&quot;,</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-    get helpString() _(&quot;command.join3&quot;, &quot;join&quot;),</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+    get helpString() { return _(&quot;command.join3&quot;, &quot;join&quot;); },</span>
<a href="#l26.34"></a><span id="l26.34">     run: function(aMsg, aConv, aReturnedConv) {</span>
<a href="#l26.35"></a><span id="l26.35">       let account = getAccount(aConv);</span>
<a href="#l26.36"></a><span id="l26.36">       let params = aMsg.trim();</span>
<a href="#l26.37"></a><span id="l26.37">       let conv;</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39">       if (!params) {</span>
<a href="#l26.40"></a><span id="l26.40">         conv = getConv(aConv);</span>
<a href="#l26.41"></a><span id="l26.41">         if (!conv.isChat)</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineat">@@ -49,28 +53,28 @@ var commands = [</span>
<a href="#l26.43"></a><span id="l26.43"> </span>
<a href="#l26.44"></a><span id="l26.44">       if (aReturnedConv)</span>
<a href="#l26.45"></a><span id="l26.45">         aReturnedConv.value = conv;</span>
<a href="#l26.46"></a><span id="l26.46">       return true;</span>
<a href="#l26.47"></a><span id="l26.47">     }</span>
<a href="#l26.48"></a><span id="l26.48">   },</span>
<a href="#l26.49"></a><span id="l26.49">   {</span>
<a href="#l26.50"></a><span id="l26.50">     name: &quot;part&quot;,</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-    get helpString() _(&quot;command.part2&quot;, &quot;part&quot;),</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+    get helpString() { return _(&quot;command.part2&quot;, &quot;part&quot;); },</span>
<a href="#l26.53"></a><span id="l26.53">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l26.54"></a><span id="l26.54">     run: function(aMsg, aConv) {</span>
<a href="#l26.55"></a><span id="l26.55">       let conv = getConv(aConv);</span>
<a href="#l26.56"></a><span id="l26.56">       if (!conv.left)</span>
<a href="#l26.57"></a><span id="l26.57">         conv.part(aMsg);</span>
<a href="#l26.58"></a><span id="l26.58">       return true;</span>
<a href="#l26.59"></a><span id="l26.59">     }</span>
<a href="#l26.60"></a><span id="l26.60">   },</span>
<a href="#l26.61"></a><span id="l26.61">   {</span>
<a href="#l26.62"></a><span id="l26.62">     name: &quot;topic&quot;,</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-    get helpString() _(&quot;command.topic&quot;, &quot;topic&quot;),</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+    get helpString() { return _(&quot;command.topic&quot;, &quot;topic&quot;); },</span>
<a href="#l26.65"></a><span id="l26.65">     usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l26.66"></a><span id="l26.66">     run: function(aMsg, aConv) {</span>
<a href="#l26.67"></a><span id="l26.67">       let conv = getConv(aConv);</span>
<a href="#l26.68"></a><span id="l26.68">       if (!conv.left)</span>
<a href="#l26.69"></a><span id="l26.69">         conv.topic = aMsg;</span>
<a href="#l26.70"></a><span id="l26.70">       return true;</span>
<a href="#l26.71"></a><span id="l26.71">     }</span>
<a href="#l26.72"></a><span id="l26.72">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -6,25 +6,25 @@ const EXPORTED_SYMBOLS = [&quot;XMPPSession&quot;,</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l27.8"></a><span id="l27.8"> Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l27.9"></a><span id="l27.9"> Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l27.10"></a><span id="l27.10"> Cu.import(&quot;resource:///modules/xmpp-authmechs.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l27.14"></a><span id="l27.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l27.15"></a><span id="l27.15"> );</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17"> // Workaround because a lazy getter can't be exported.</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_defaultResource&quot;, function()</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_defaultResource&quot;, () =&gt;</span>
<a href="#l27.20"></a><span id="l27.20">   l10nHelper(&quot;chrome://branding/locale/brand.properties&quot;)(&quot;brandShortName&quot;)</span>
<a href="#l27.21"></a><span id="l27.21"> );</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-__defineGetter__(&quot;XMPPDefaultResource&quot;, function() _defaultResource);</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+__defineGetter__(&quot;XMPPDefaultResource&quot;, () =&gt; _defaultResource);</span>
<a href="#l27.24"></a><span id="l27.24"> </span>
<a href="#l27.25"></a><span id="l27.25"> function XMPPSession(aHost, aPort, aSecurity, aJID, aPassword, aAccount) {</span>
<a href="#l27.26"></a><span id="l27.26">   this._host = aHost;</span>
<a href="#l27.27"></a><span id="l27.27">   this._port = aPort;</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29">   this._connectionSecurity = aSecurity;</span>
<a href="#l27.30"></a><span id="l27.30">   if (this._connectionSecurity == &quot;old_ssl&quot;)</span>
<a href="#l27.31"></a><span id="l27.31">     this._security = [&quot;ssl&quot;];</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineat">@@ -83,20 +83,20 @@ XMPPSession.prototype = {</span>
<a href="#l27.33"></a><span id="l27.33">     // something in the last two minutes. This is because Openfire</span>
<a href="#l27.34"></a><span id="l27.34">     // servers will disconnect us if we don't send anything for a</span>
<a href="#l27.35"></a><span id="l27.35">     // couple of minutes.</span>
<a href="#l27.36"></a><span id="l27.36">     if (Math.min(this._lastSendTime, this._lastReceiveTime) &gt;</span>
<a href="#l27.37"></a><span id="l27.37">         now - this.kTimeBeforePing)</span>
<a href="#l27.38"></a><span id="l27.38">       this.resetPingTimer();</span>
<a href="#l27.39"></a><span id="l27.39">   },</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-  get DEBUG() this._account.DEBUG,</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  get LOG() this._account.LOG,</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-  get WARN() this._account.WARN,</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-  get ERROR() this._account.ERROR,</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+  get LOG() { return this._account.LOG; },</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+  get WARN() { return this._account.WARN; },</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+  get ERROR() { return this._account.ERROR; },</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50">   _security: null,</span>
<a href="#l27.51"></a><span id="l27.51">   _encrypted: false,</span>
<a href="#l27.52"></a><span id="l27.52"> </span>
<a href="#l27.53"></a><span id="l27.53">   /* Disconnect from the server */</span>
<a href="#l27.54"></a><span id="l27.54">   disconnect: function() {</span>
<a href="#l27.55"></a><span id="l27.55">     if (this.onXmppStanza == this.stanzaListeners.accountListening)</span>
<a href="#l27.56"></a><span id="l27.56">       this.send(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineat">@@ -251,17 +251,17 @@ XMPPSession.prototype = {</span>
<a href="#l27.58"></a><span id="l27.58">       let starttls = aStanza.getElement([&quot;starttls&quot;]);</span>
<a href="#l27.59"></a><span id="l27.59">       if (starttls &amp;&amp; this._security.indexOf(&quot;starttls&quot;) != -1) {</span>
<a href="#l27.60"></a><span id="l27.60">         this._account.reportConnecting(_(&quot;connection.initializingEncryption&quot;));</span>
<a href="#l27.61"></a><span id="l27.61">         this.sendStanza(Stanza.node(&quot;starttls&quot;, Stanza.NS.tls));</span>
<a href="#l27.62"></a><span id="l27.62">         this.onXmppStanza = this.stanzaListeners.startTLS;</span>
<a href="#l27.63"></a><span id="l27.63">         return;</span>
<a href="#l27.64"></a><span id="l27.64">       }</span>
<a href="#l27.65"></a><span id="l27.65">       if (starttls &amp;&amp;</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-          starttls.children.some(function (c) c.localName == &quot;required&quot;)) {</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+          starttls.children.some(c =&gt; c.localName == &quot;required&quot;)) {</span>
<a href="#l27.68"></a><span id="l27.68">         this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l27.69"></a><span id="l27.69">                      _(&quot;connection.error.startTLSRequired&quot;));</span>
<a href="#l27.70"></a><span id="l27.70">         return;</span>
<a href="#l27.71"></a><span id="l27.71">       }</span>
<a href="#l27.72"></a><span id="l27.72">       if (!starttls &amp;&amp; this._connectionSecurity == &quot;require_tls&quot;) {</span>
<a href="#l27.73"></a><span id="l27.73">         this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l27.74"></a><span id="l27.74">                      _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l27.75"></a><span id="l27.75">         return;</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineat">@@ -480,17 +480,17 @@ XMPPSession.prototype = {</span>
<a href="#l27.77"></a><span id="l27.77">         // SHA-1 hashing algorithm operates on byte arrays.</span>
<a href="#l27.78"></a><span id="l27.78">         let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l27.79"></a><span id="l27.79">                           .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l27.80"></a><span id="l27.80">         converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l27.81"></a><span id="l27.81">         let data = converter.convertToByteArray(hashBase);</span>
<a href="#l27.82"></a><span id="l27.82">         ch.update(data, data.length);</span>
<a href="#l27.83"></a><span id="l27.83">         let hash = ch.finish(false);</span>
<a href="#l27.84"></a><span id="l27.84">         let toHexString =</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-          function(charCode) (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+          charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l27.87"></a><span id="l27.87">         let digest = [toHexString(hash.charCodeAt(i)) for (i in hash)].join(&quot;&quot;);</span>
<a href="#l27.88"></a><span id="l27.88"> </span>
<a href="#l27.89"></a><span id="l27.89">         children.push(Stanza.node(&quot;digest&quot;, null, null, digest));</span>
<a href="#l27.90"></a><span id="l27.90">         logString =</span>
<a href="#l27.91"></a><span id="l27.91">           &quot;legacyAuth stanza containing SHA-1 hash of the password not logged&quot;;</span>
<a href="#l27.92"></a><span id="l27.92">       }</span>
<a href="#l27.93"></a><span id="l27.93">       else if (&quot;password&quot; in values) {</span>
<a href="#l27.94"></a><span id="l27.94">         if (!this._encrypted &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -88,17 +88,17 @@ var TOP_LEVEL_ELEMENTS = {</span>
<a href="#l28.4"></a><span id="l28.4">   &quot;error&quot;               : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> };</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> /* Stanza Builder */</span>
<a href="#l28.8"></a><span id="l28.8"> const Stanza = {</span>
<a href="#l28.9"></a><span id="l28.9">   NS: NS,</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">   /* Create a presence stanza */</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  presence: function(aAttr, aData) Stanza.node(&quot;presence&quot;, null, aAttr, aData),</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  presence: (aAttr, aData) =&gt; Stanza.node(&quot;presence&quot;, null, aAttr, aData),</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15">   /* Create a message stanza */</span>
<a href="#l28.16"></a><span id="l28.16">   message: function(aTo, aMsg, aState, aAttr = {}, aData = []) {</span>
<a href="#l28.17"></a><span id="l28.17">     aAttr.to = aTo;</span>
<a href="#l28.18"></a><span id="l28.18">     if (!(&quot;type&quot; in aAttr))</span>
<a href="#l28.19"></a><span id="l28.19">       aAttr.type = &quot;chat&quot;;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21">     if (aMsg)</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -141,33 +141,34 @@ const Stanza = {</span>
<a href="#l28.23"></a><span id="l28.23"> };</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25"> /* Text node</span>
<a href="#l28.26"></a><span id="l28.26">  * Contains a text */</span>
<a href="#l28.27"></a><span id="l28.27"> function TextNode(aText) {</span>
<a href="#l28.28"></a><span id="l28.28">   this.text = aText;</span>
<a href="#l28.29"></a><span id="l28.29"> }</span>
<a href="#l28.30"></a><span id="l28.30"> TextNode.prototype = {</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-  get type() &quot;text&quot;,</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+  get type() { return &quot;text&quot;; },</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34">   append: function(aText) {</span>
<a href="#l28.35"></a><span id="l28.35">     this.text += aText;</span>
<a href="#l28.36"></a><span id="l28.36">   },</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   /* For debug purposes, returns an indented (unencoded) string */</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-  convertToString: function(aIndent) aIndent + this.text + &quot;\n&quot;,</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+  convertToString: function(aIndent) { return aIndent + this.text + &quot;\n&quot;; },</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">   /* Returns the encoded XML */</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-  getXML: function()</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-    Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-      .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-      .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities),</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+  getXML: function() {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+    return Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+           .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+           .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities);</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  },</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53">   /* To read the unencoded data. */</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-  get innerText() this.text</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+  get innerText() { return this.text; }</span>
<a href="#l28.56"></a><span id="l28.56"> };</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58"> /* XML node */</span>
<a href="#l28.59"></a><span id="l28.59"> /* aUri is the namespace. */</span>
<a href="#l28.60"></a><span id="l28.60"> /* Example: &lt;f:a xmlns:f='g' d='1'&gt; is parsed to</span>
<a href="#l28.61"></a><span id="l28.61">    uri/namespace='g', localName='a', qName='f:a', attributes={d='1'} */</span>
<a href="#l28.62"></a><span id="l28.62"> function XMLNode(aParentNode, aUri, aLocalName, aQName, aAttr) {</span>
<a href="#l28.63"></a><span id="l28.63">   this._parentNode = aParentNode; // Used only for parsing</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineat">@@ -178,35 +179,36 @@ function XMLNode(aParentNode, aUri, aLoc</span>
<a href="#l28.65"></a><span id="l28.65">   this.children = [];</span>
<a href="#l28.66"></a><span id="l28.66"> </span>
<a href="#l28.67"></a><span id="l28.67">   if (aAttr) {</span>
<a href="#l28.68"></a><span id="l28.68">     for (let i = 0; i &lt; aAttr.length; ++i)</span>
<a href="#l28.69"></a><span id="l28.69">       this.attributes[aAttr.getQName(i)] = aAttr.getValue(i);</span>
<a href="#l28.70"></a><span id="l28.70">   }</span>
<a href="#l28.71"></a><span id="l28.71"> }</span>
<a href="#l28.72"></a><span id="l28.72"> XMLNode.prototype = {</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-  get type() &quot;node&quot;,</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+  get type() { return &quot;node&quot;; },</span>
<a href="#l28.75"></a><span id="l28.75"> </span>
<a href="#l28.76"></a><span id="l28.76">   /* Add a new child node */</span>
<a href="#l28.77"></a><span id="l28.77">   addChild: function(aNode) {</span>
<a href="#l28.78"></a><span id="l28.78">     this.children.push(aNode);</span>
<a href="#l28.79"></a><span id="l28.79">   },</span>
<a href="#l28.80"></a><span id="l28.80"> </span>
<a href="#l28.81"></a><span id="l28.81">   /* Add text node */</span>
<a href="#l28.82"></a><span id="l28.82">   addText: function(aText) {</span>
<a href="#l28.83"></a><span id="l28.83">     let lastIndex = this.children.length - 1;</span>
<a href="#l28.84"></a><span id="l28.84">     if (lastIndex &gt;= 0 &amp;&amp; this.children[lastIndex] instanceof TextNode)</span>
<a href="#l28.85"></a><span id="l28.85">       this.children[lastIndex].append(aText);</span>
<a href="#l28.86"></a><span id="l28.86">     else</span>
<a href="#l28.87"></a><span id="l28.87">       this.children.push(new TextNode(aText));</span>
<a href="#l28.88"></a><span id="l28.88">   },</span>
<a href="#l28.89"></a><span id="l28.89"> </span>
<a href="#l28.90"></a><span id="l28.90">   /* Get child elements by namespace */</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-  getChildrenByNS: function(aNS)</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-    this.children.filter(function(c) c.uri == aNS),</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+  getChildrenByNS: function(aNS) {</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+    return this.children.filter(c =&gt; c.uri == aNS);</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+  },</span>
<a href="#l28.96"></a><span id="l28.96"> </span>
<a href="#l28.97"></a><span id="l28.97">   /* Get the first element anywhere inside the node (including child nodes)</span>
<a href="#l28.98"></a><span id="l28.98">      that matches the query.</span>
<a href="#l28.99"></a><span id="l28.99">      A query consists of an array of localNames. */</span>
<a href="#l28.100"></a><span id="l28.100">   getElement: function(aQuery) {</span>
<a href="#l28.101"></a><span id="l28.101">     if (aQuery.length == 0)</span>
<a href="#l28.102"></a><span id="l28.102">       return this;</span>
<a href="#l28.103"></a><span id="l28.103"> </span>
<a href="#l28.104"></a><span id="l28.104" class="difflineat">@@ -235,18 +237,19 @@ XMLNode.prototype = {</span>
<a href="#l28.105"></a><span id="l28.105">       let n = child.getElements(nq);</span>
<a href="#l28.106"></a><span id="l28.106">       res = res.concat(n);</span>
<a href="#l28.107"></a><span id="l28.107">     }</span>
<a href="#l28.108"></a><span id="l28.108"> </span>
<a href="#l28.109"></a><span id="l28.109">     return res;</span>
<a href="#l28.110"></a><span id="l28.110">   },</span>
<a href="#l28.111"></a><span id="l28.111"> </span>
<a href="#l28.112"></a><span id="l28.112">   /* Get immediate children by the node name */</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-  getChildren: function(aName)</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-    this.children.filter((c) =&gt; (c.type != &quot;text&quot; &amp;&amp; c.localName == aName)),</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+  getChildren: function(aName) {</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+    return this.children.filter((c) =&gt; (c.type != &quot;text&quot; &amp;&amp; c.localName == aName));</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+  },</span>
<a href="#l28.118"></a><span id="l28.118"> </span>
<a href="#l28.119"></a><span id="l28.119">   /* Test if the node is a stanza */</span>
<a href="#l28.120"></a><span id="l28.120">   isXmppStanza: function() {</span>
<a href="#l28.121"></a><span id="l28.121">     if (!TOP_LEVEL_ELEMENTS.hasOwnProperty(this.qName))</span>
<a href="#l28.122"></a><span id="l28.122">       return false;</span>
<a href="#l28.123"></a><span id="l28.123">     let ns = TOP_LEVEL_ELEMENTS[this.qName];</span>
<a href="#l28.124"></a><span id="l28.124">     return ns == this.uri || (Array.isArray(ns) &amp;&amp; ns.indexOf(this.uri) != -1);</span>
<a href="#l28.125"></a><span id="l28.125">   },</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineat">@@ -263,21 +266,21 @@ XMLNode.prototype = {</span>
<a href="#l28.127"></a><span id="l28.127"> </span>
<a href="#l28.128"></a><span id="l28.128">   /* Returns the XML */</span>
<a href="#l28.129"></a><span id="l28.129">   getXML: function() {</span>
<a href="#l28.130"></a><span id="l28.130">     let s = &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l28.131"></a><span id="l28.131">     let innerXML = this.innerXML;</span>
<a href="#l28.132"></a><span id="l28.132">     return s + (innerXML ? &quot;&gt;&quot; + innerXML + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;&quot;;</span>
<a href="#l28.133"></a><span id="l28.133">   },</span>
<a href="#l28.134"></a><span id="l28.134"> </span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-  get innerXML() this.children.map(function(c) c.getXML()).join(&quot;&quot;),</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineminus">-  get innerText() this.children.map(function(c) c.innerText).join(&quot;&quot;),</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+  get innerXML() { return this.children.map(c =&gt; c.getXML()).join(&quot;&quot;); },</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+  get innerText() { return this.children.map(c =&gt; c.innerText).join(&quot;&quot;); },</span>
<a href="#l28.139"></a><span id="l28.139"> </span>
<a href="#l28.140"></a><span id="l28.140">   /* Private methods */</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineminus">-  _getXmlns: function() this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;,</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+  _getXmlns: function() { return this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;; },</span>
<a href="#l28.143"></a><span id="l28.143">   _getAttributeText: function() {</span>
<a href="#l28.144"></a><span id="l28.144">     let s = &quot;&quot;;</span>
<a href="#l28.145"></a><span id="l28.145">     for (let name in this.attributes)</span>
<a href="#l28.146"></a><span id="l28.146">       s += &quot; &quot; +name + &quot;=\&quot;&quot; + this.attributes[name] + &quot;\&quot;&quot;;</span>
<a href="#l28.147"></a><span id="l28.147">     return s;</span>
<a href="#l28.148"></a><span id="l28.148">   }</span>
<a href="#l28.149"></a><span id="l28.149"> };</span>
<a href="#l28.150"></a><span id="l28.150"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -4,57 +4,57 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> const Cu = Components.utils;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l29.8"></a><span id="l29.8"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l29.9"></a><span id="l29.9"> Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l29.10"></a><span id="l29.10"> Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l29.14"></a><span id="l29.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l29.15"></a><span id="l29.15"> );</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l29.18"></a><span id="l29.18">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l29.19"></a><span id="l29.19"> }</span>
<a href="#l29.20"></a><span id="l29.20"> XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22"> function XMPPProtocol() {</span>
<a href="#l29.23"></a><span id="l29.23">   Cu.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l29.24"></a><span id="l29.24">   this.registerCommands();</span>
<a href="#l29.25"></a><span id="l29.25"> }</span>
<a href="#l29.26"></a><span id="l29.26"> XMPPProtocol.prototype = {</span>
<a href="#l29.27"></a><span id="l29.27">   __proto__: GenericProtocolPrototype,</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-  get normalizedName() &quot;jabber&quot;,</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-  get name() &quot;XMPP&quot;,</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-jabber/skin/&quot;,</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  getAccount: function(aImAccount) new XMPPAccount(this, aImAccount),</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+  get normalizedName() { return &quot;jabber&quot;; },</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+  get name() { return &quot;XMPP&quot;; },</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-jabber/skin/&quot;; },</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+  getAccount: function(aImAccount) { return new XMPPAccount(this, aImAccount); },</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37">   usernameSplits: [</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-    {get label() _(&quot;options.domain&quot;), separator: &quot;@&quot;,</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+    {get label() { return _(&quot;options.domain&quot;); }, separator: &quot;@&quot;,</span>
<a href="#l29.40"></a><span id="l29.40">      defaultValue: &quot;jabber.org&quot;, reverse: true}</span>
<a href="#l29.41"></a><span id="l29.41">   ],</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43">   options: {</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-    resource: {get label() _(&quot;options.resource&quot;),</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-               get default() XMPPDefaultResource},</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-    priority: {get label() _(&quot;options.priority&quot;), default: 0},</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+    resource: {get label() { return _(&quot;options.resource&quot;); },</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+               get default() { return XMPPDefaultResource; }},</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+    priority: {get label() { return _(&quot;options.priority&quot;); }, default: 0},</span>
<a href="#l29.50"></a><span id="l29.50">     connection_security: {</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-      get label() _(&quot;options.connectionSecurity&quot;),</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+      get label() { return _(&quot;options.connectionSecurity&quot;); },</span>
<a href="#l29.53"></a><span id="l29.53">       listValues: {</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-        get require_tls() _(&quot;options.connectionSecurity.requireEncryption&quot;),</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-        get opportunistic_tls() _(&quot;options.connectionSecurity.opportunisticTLS&quot;),</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-        get allow_unencrypted_plain_auth() _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;),</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+        get require_tls() { return _(&quot;options.connectionSecurity.requireEncryption&quot;); },</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+        get opportunistic_tls() { return _(&quot;options.connectionSecurity.opportunisticTLS&quot;); },</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+        get allow_unencrypted_plain_auth() { return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;); },</span>
<a href="#l29.60"></a><span id="l29.60">         // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l29.61"></a><span id="l29.61">         // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l29.62"></a><span id="l29.62">       },</span>
<a href="#l29.63"></a><span id="l29.63">       default: &quot;require_tls&quot;</span>
<a href="#l29.64"></a><span id="l29.64">     },</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-    server: {get label() _(&quot;options.connectServer&quot;), default: &quot;&quot;},</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-    port: {get label() _(&quot;options.connectPort&quot;), default: 5222}</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+    server: {get label() { return _(&quot;options.connectServer&quot;); }, default: &quot;&quot;},</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+    port: {get label() { return _(&quot;options.connectPort&quot;); }, default: 5222}</span>
<a href="#l29.69"></a><span id="l29.69">   },</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-  get chatHasTopic() true,</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+  get chatHasTopic() { return true; },</span>
<a href="#l29.72"></a><span id="l29.72"> </span>
<a href="#l29.73"></a><span id="l29.73">   classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;)</span>
<a href="#l29.74"></a><span id="l29.74"> };</span>
<a href="#l29.75"></a><span id="l29.75"> </span>
<a href="#l29.76"></a><span id="l29.76"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -28,23 +28,23 @@ XPCOMUtils.defineLazyModuleGetter(this, </span>
<a href="#l30.4"></a><span id="l30.4">   &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l30.5"></a><span id="l30.5"> XPCOMUtils.defineLazyServiceGetter(this, &quot;imgTools&quot;,</span>
<a href="#l30.6"></a><span id="l30.6">                                    &quot;@mozilla.org/image/tools;1&quot;,</span>
<a href="#l30.7"></a><span id="l30.7">                                    &quot;imgITools&quot;);</span>
<a href="#l30.8"></a><span id="l30.8"> XPCOMUtils.defineLazyServiceGetter(this, &quot;UuidGenerator&quot;,</span>
<a href="#l30.9"></a><span id="l30.9">                                    &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l30.10"></a><span id="l30.10">                                    &quot;nsIUUIDGenerator&quot;);</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l30.14"></a><span id="l30.14">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l30.15"></a><span id="l30.15"> );</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l30.18"></a><span id="l30.18">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-  return function(aTxt) cs.scanTXT(aTxt, cs.kEntities);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  return aTxt =&gt; cs.scanTXT(aTxt, cs.kEntities);</span>
<a href="#l30.21"></a><span id="l30.21"> });</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23"> // Parses the status from a presence stanza into an object of statusType,</span>
<a href="#l30.24"></a><span id="l30.24"> // statusText and idleSince.</span>
<a href="#l30.25"></a><span id="l30.25"> function parseStatus(aStanza) {</span>
<a href="#l30.26"></a><span id="l30.26">   let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l30.27"></a><span id="l30.27">   let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l30.28"></a><span id="l30.28">   if (show) {</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineat">@@ -65,18 +65,18 @@ function parseStatus(aStanza) {</span>
<a href="#l30.30"></a><span id="l30.30">     let now = Math.floor(Date.now() / 1000);</span>
<a href="#l30.31"></a><span id="l30.31">     idleSince = now - parseInt(query.attributes[&quot;seconds&quot;], 10);</span>
<a href="#l30.32"></a><span id="l30.32">     statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l30.33"></a><span id="l30.33">   }</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35">   // Mark official Android clients as mobile.</span>
<a href="#l30.36"></a><span id="l30.36">   const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l30.37"></a><span id="l30.37">   if (aStanza.getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-             .some(function(s) s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-                               s.attributes[&quot;node&quot;] == kAndroidNodeURI))</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+             .some(s =&gt; s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+                        s.attributes[&quot;node&quot;] == kAndroidNodeURI))</span>
<a href="#l30.42"></a><span id="l30.42">     statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44">   let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l30.45"></a><span id="l30.45">   status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47">   return {statusType: statusType, statusText: status, idleSince: idleSince};</span>
<a href="#l30.48"></a><span id="l30.48"> };</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50" class="difflineat">@@ -104,17 +104,17 @@ MUCParticipant.prototype = {</span>
<a href="#l30.51"></a><span id="l30.51">   // The occupant jid of the participant which is of the form room@domain/nick.</span>
<a href="#l30.52"></a><span id="l30.52">   _jid: null,</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54">   // The real jid of the participant which is of the form local@domain/resource.</span>
<a href="#l30.55"></a><span id="l30.55">   accountJid: null,</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57">   statusType: null,</span>
<a href="#l30.58"></a><span id="l30.58">   statusText: null,</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-  get alias() this.name,</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+  get alias() { return this.name; },</span>
<a href="#l30.61"></a><span id="l30.61"> </span>
<a href="#l30.62"></a><span id="l30.62">   role: 2, // &quot;participant&quot; by default</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64">   // Called when a presence stanza is received for this participant.</span>
<a href="#l30.65"></a><span id="l30.65">   onPresenceStanza: function(aStanza) {</span>
<a href="#l30.66"></a><span id="l30.66">     let statusInfo = parseStatus(aStanza);</span>
<a href="#l30.67"></a><span id="l30.67">     this.statusType = statusInfo.statusType;</span>
<a href="#l30.68"></a><span id="l30.68">     this.statusText = statusInfo.statusText;</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineat">@@ -135,21 +135,21 @@ MUCParticipant.prototype = {</span>
<a href="#l30.70"></a><span id="l30.70">     this.role = Math.max(kRoles.indexOf(item.attributes[&quot;role&quot;]),</span>
<a href="#l30.71"></a><span id="l30.71">                          kRoles.indexOf(item.attributes[&quot;affiliation&quot;]));</span>
<a href="#l30.72"></a><span id="l30.72"> </span>
<a href="#l30.73"></a><span id="l30.73">     let accountJid = item.attributes[&quot;jid&quot;];</span>
<a href="#l30.74"></a><span id="l30.74">     if (accountJid)</span>
<a href="#l30.75"></a><span id="l30.75">       this.accountJid = accountJid;</span>
<a href="#l30.76"></a><span id="l30.76">   },</span>
<a href="#l30.77"></a><span id="l30.77"> </span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-  get noFlags() this.role &lt; kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-  get voiced() this.role == kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-  get halfOp() this.role == kRoles.indexOf(&quot;moderator&quot;),</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-  get op() this.role == kRoles.indexOf(&quot;admin&quot;),</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-  get founder() this.role == kRoles.indexOf(&quot;owner&quot;),</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+  get noFlags() { return this.role &lt; kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+  get voiced() { return this.role == kRoles.indexOf(&quot;member&quot;); },</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+  get halfOp() { return this.role == kRoles.indexOf(&quot;moderator&quot;); },</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+  get op() { return this.role == kRoles.indexOf(&quot;admin&quot;); },</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+  get founder() { return this.role == kRoles.indexOf(&quot;owner&quot;); },</span>
<a href="#l30.88"></a><span id="l30.88">   typing: false</span>
<a href="#l30.89"></a><span id="l30.89"> };</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91"> // MUC (Multi-User Chat)</span>
<a href="#l30.92"></a><span id="l30.92"> const XMPPMUCConversationPrototype = {</span>
<a href="#l30.93"></a><span id="l30.93">   __proto__: GenericConvChatPrototype,</span>
<a href="#l30.94"></a><span id="l30.94">   // By default users are not in a MUC.</span>
<a href="#l30.95"></a><span id="l30.95">   _left: true,</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineat">@@ -405,18 +405,19 @@ const XMPPMUCConversationPrototype = {</span>
<a href="#l30.97"></a><span id="l30.97">       // Checks if a message exists in conversation to avoid duplication.</span>
<a href="#l30.98"></a><span id="l30.98">       if (this._messageIds.has(id))</span>
<a href="#l30.99"></a><span id="l30.99">         return;</span>
<a href="#l30.100"></a><span id="l30.100">       this._messageIds.add(id);</span>
<a href="#l30.101"></a><span id="l30.101">     }</span>
<a href="#l30.102"></a><span id="l30.102">     this.writeMessage(from, aMsg, flags);</span>
<a href="#l30.103"></a><span id="l30.103">   },</span>
<a href="#l30.104"></a><span id="l30.104"> </span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-  getNormalizedChatBuddyName: function(aNick)</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-    this._account.normalizeFullJid(this.name + &quot;/&quot; + aNick),</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+  getNormalizedChatBuddyName: function(aNick) {</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+    return this._account.normalizeFullJid(this.name + &quot;/&quot; + aNick);</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+  },</span>
<a href="#l30.110"></a><span id="l30.110"> </span>
<a href="#l30.111"></a><span id="l30.111">   // Removes a participant from MUC conversation.</span>
<a href="#l30.112"></a><span id="l30.112">   removeParticipant: function(aNick) {</span>
<a href="#l30.113"></a><span id="l30.113">     if (!this._participants.has(aNick))</span>
<a href="#l30.114"></a><span id="l30.114">       return;</span>
<a href="#l30.115"></a><span id="l30.115"> </span>
<a href="#l30.116"></a><span id="l30.116">     this._participants.delete(aNick);</span>
<a href="#l30.117"></a><span id="l30.117">     let nickString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineat">@@ -472,20 +473,20 @@ const XMPPConversationPrototype = {</span>
<a href="#l30.119"></a><span id="l30.119">   _typingTimer: null,</span>
<a href="#l30.120"></a><span id="l30.120">   supportChatStateNotifications: true,</span>
<a href="#l30.121"></a><span id="l30.121">   _typingState: &quot;active&quot;,</span>
<a href="#l30.122"></a><span id="l30.122"> </span>
<a href="#l30.123"></a><span id="l30.123">   // Indicates that current conversation is with a MUC participant and the</span>
<a href="#l30.124"></a><span id="l30.124">   // recipient jid (stored in the userName) is of the form room@domain/nick.</span>
<a href="#l30.125"></a><span id="l30.125">   _isMucParticipant: false,</span>
<a href="#l30.126"></a><span id="l30.126"> </span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-  get buddy() this._account._buddies.get(this.name),</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-  get title() this.contactDisplayName,</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-  get contactDisplayName() this.buddy ? this.buddy.contactDisplayName : this.name,</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-  get userName() this.buddy ? this.buddy.userName : this.name,</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+  get buddy() { return this._account._buddies.get(this.name); },</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+  get title() { return this.contactDisplayName; },</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+  get contactDisplayName() { return this.buddy ? this.buddy.contactDisplayName : this.name; },</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+  get userName() { return this.buddy ? this.buddy.userName : this.name; },</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136">   // Returns jid (room@domain/nick) if it is with a MUC participant, and the</span>
<a href="#l30.137"></a><span id="l30.137">   // name of conversation otherwise.</span>
<a href="#l30.138"></a><span id="l30.138">   get normalizedName() {</span>
<a href="#l30.139"></a><span id="l30.139">     if (this._isMucParticipant)</span>
<a href="#l30.140"></a><span id="l30.140">       return this._account.normalizeFullJid(this.name);</span>
<a href="#l30.141"></a><span id="l30.141">     return this._account.normalize(this.name);</span>
<a href="#l30.142"></a><span id="l30.142">   },</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineat">@@ -502,19 +503,20 @@ const XMPPConversationPrototype = {</span>
<a href="#l30.144"></a><span id="l30.144">     // Returns nick of the recipient if conversation is with a participant of</span>
<a href="#l30.145"></a><span id="l30.145">     // a MUC we are in as jid of the recipient is of the form room@domain/nick.</span>
<a href="#l30.146"></a><span id="l30.146">     if (this._isMucParticipant)</span>
<a href="#l30.147"></a><span id="l30.147">       return jid.resource;</span>
<a href="#l30.148"></a><span id="l30.148"> </span>
<a href="#l30.149"></a><span id="l30.149">     return jid.node;</span>
<a href="#l30.150"></a><span id="l30.150">   },</span>
<a href="#l30.151"></a><span id="l30.151"> </span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-  get shouldSendTypingNotifications()</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-    this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-    Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;),</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+  get shouldSendTypingNotifications() {</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+    return this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+           Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;);</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+  },</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">   /* Called when the user is typing a message</span>
<a href="#l30.161"></a><span id="l30.161">    * aString - the currently typed message</span>
<a href="#l30.162"></a><span id="l30.162">    * Returns the number of characters that can still be typed */</span>
<a href="#l30.163"></a><span id="l30.163">   sendTyping: function(aString) {</span>
<a href="#l30.164"></a><span id="l30.164">     if (!this.shouldSendTypingNotifications)</span>
<a href="#l30.165"></a><span id="l30.165">       return Ci.prplIConversation.NO_TYPING_LIMIT;</span>
<a href="#l30.166"></a><span id="l30.166"> </span>
<a href="#l30.167"></a><span id="l30.167" class="difflineat">@@ -713,17 +715,17 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l30.168"></a><span id="l30.168">     this._vCardFormattedName = aNewFormattedName;</span>
<a href="#l30.169"></a><span id="l30.169">     if (old != this.displayName)</span>
<a href="#l30.170"></a><span id="l30.170">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l30.171"></a><span id="l30.171">   },</span>
<a href="#l30.172"></a><span id="l30.172"> </span>
<a href="#l30.173"></a><span id="l30.173">   // _serverAlias is set by jsProtoHelper to the value we cached in sqlite.</span>
<a href="#l30.174"></a><span id="l30.174">   // Use it only if we have neither of the other two values; usually because</span>
<a href="#l30.175"></a><span id="l30.175">   // we haven't connected to the server yet.</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-  get serverAlias() this._rosterAlias || this._vCardFormattedName || this._serverAlias,</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+  get serverAlias() { return this._rosterAlias || this._vCardFormattedName || this._serverAlias; },</span>
<a href="#l30.178"></a><span id="l30.178">   set serverAlias(aNewAlias) {</span>
<a href="#l30.179"></a><span id="l30.179">     if (!this._rosterItem) {</span>
<a href="#l30.180"></a><span id="l30.180">       this.ERROR(&quot;attempting to update the server alias of an account buddy &quot; +</span>
<a href="#l30.181"></a><span id="l30.181">                  &quot;for which we haven't received a roster item.&quot;);</span>
<a href="#l30.182"></a><span id="l30.182">       return;</span>
<a href="#l30.183"></a><span id="l30.183">     }</span>
<a href="#l30.184"></a><span id="l30.184"> </span>
<a href="#l30.185"></a><span id="l30.185">     let item = this._rosterItem;</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineat">@@ -737,19 +739,19 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l30.187"></a><span id="l30.187">     this._account.sendStanza(s);</span>
<a href="#l30.188"></a><span id="l30.188"> </span>
<a href="#l30.189"></a><span id="l30.189">     // If we are going to change the alias on the server, discard the cached</span>
<a href="#l30.190"></a><span id="l30.190">     // value that we got from our local sqlite storage at startup.</span>
<a href="#l30.191"></a><span id="l30.191">     delete this._serverAlias;</span>
<a href="#l30.192"></a><span id="l30.192">   },</span>
<a href="#l30.193"></a><span id="l30.193"> </span>
<a href="#l30.194"></a><span id="l30.194">   /* Display name of the buddy */</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-  get contactDisplayName() this.buddy.contact.displayName || this.displayName,</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+  get contactDisplayName() { return this.buddy.contact.displayName || this.displayName; },</span>
<a href="#l30.197"></a><span id="l30.197"> </span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-  get tag() this._tag,</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+  get tag() { return this._tag; },</span>
<a href="#l30.200"></a><span id="l30.200">   set tag(aNewTag) {</span>
<a href="#l30.201"></a><span id="l30.201">     let oldTag = this._tag;</span>
<a href="#l30.202"></a><span id="l30.202">     if (oldTag.name == aNewTag.name) {</span>
<a href="#l30.203"></a><span id="l30.203">       this.ERROR(&quot;attempting to set the tag to the same value&quot;);</span>
<a href="#l30.204"></a><span id="l30.204">       return;</span>
<a href="#l30.205"></a><span id="l30.205">     }</span>
<a href="#l30.206"></a><span id="l30.206"> </span>
<a href="#l30.207"></a><span id="l30.207">     this._tag = aNewTag;</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineat">@@ -759,21 +761,21 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l30.209"></a><span id="l30.209">       this.ERROR(&quot;attempting to change the tag of an account buddy without roster item&quot;);</span>
<a href="#l30.210"></a><span id="l30.210">       return;</span>
<a href="#l30.211"></a><span id="l30.211">     }</span>
<a href="#l30.212"></a><span id="l30.212"> </span>
<a href="#l30.213"></a><span id="l30.213">     let item = this._rosterItem;</span>
<a href="#l30.214"></a><span id="l30.214">     let oldXML = item.getXML();</span>
<a href="#l30.215"></a><span id="l30.215">     // Remove the old tag if it was listed in the roster item.</span>
<a href="#l30.216"></a><span id="l30.216">     item.children =</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-      item.children.filter(function (c) c.qName != &quot;group&quot; ||</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-                                        c.innerText != oldTag.name);</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+      item.children.filter(c =&gt; c.qName != &quot;group&quot; ||</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+                                c.innerText != oldTag.name);</span>
<a href="#l30.221"></a><span id="l30.221">     // Ensure the new tag is listed.</span>
<a href="#l30.222"></a><span id="l30.222">     let newTagName = aNewTag.name;</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-    if (!item.getChildren(&quot;group&quot;).some(function (g) g.innerText == newTagName))</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+    if (!item.getChildren(&quot;group&quot;).some(g =&gt; g.innerText == newTagName))</span>
<a href="#l30.225"></a><span id="l30.225">       item.addChild(Stanza.node(&quot;group&quot;, null, null, newTagName));</span>
<a href="#l30.226"></a><span id="l30.226">     // Avoid sending anything to the server if the roster item hasn't changed.</span>
<a href="#l30.227"></a><span id="l30.227">     // It's possible that the roster item hasn't changed if the roster</span>
<a href="#l30.228"></a><span id="l30.228">     // item had several groups and the user moved locally the contact</span>
<a href="#l30.229"></a><span id="l30.229">     // to another group where it already was on the server.</span>
<a href="#l30.230"></a><span id="l30.230">     if (item.getXML() == oldXML)</span>
<a href="#l30.231"></a><span id="l30.231">       return;</span>
<a href="#l30.232"></a><span id="l30.232"> </span>
<a href="#l30.233"></a><span id="l30.233" class="difflineat">@@ -821,17 +823,17 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l30.234"></a><span id="l30.234">     content += parseBase64(data);</span>
<a href="#l30.235"></a><span id="l30.235"> </span>
<a href="#l30.236"></a><span id="l30.236">     // Store a sha1 hash of the photo we have just received.</span>
<a href="#l30.237"></a><span id="l30.237">     let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l30.238"></a><span id="l30.238">     ch.init(ch.SHA1);</span>
<a href="#l30.239"></a><span id="l30.239">     let dataArray = [content.charCodeAt(i) for (i in content)];</span>
<a href="#l30.240"></a><span id="l30.240">     ch.update(dataArray, dataArray.length);</span>
<a href="#l30.241"></a><span id="l30.241">     let hash = ch.finish(false);</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-    function toHexString(charCode) (&quot;0&quot; + charCode.toString(16)).slice(-2)</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+    function toHexString(charCode) { return (&quot;0&quot; + charCode.toString(16)).slice(-2); }</span>
<a href="#l30.244"></a><span id="l30.244">     this._photoHash = [toHexString(hash.charCodeAt(i)) for (i in hash)].join(&quot;&quot;);</span>
<a href="#l30.245"></a><span id="l30.245"> </span>
<a href="#l30.246"></a><span id="l30.246">     let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l30.247"></a><span id="l30.247">                   .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l30.248"></a><span id="l30.248">     istream.setData(content, content.length);</span>
<a href="#l30.249"></a><span id="l30.249"> </span>
<a href="#l30.250"></a><span id="l30.250">     let fileName = this._photoHash + &quot;.&quot; + kExt[type];</span>
<a href="#l30.251"></a><span id="l30.251">     let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;icons&quot;,</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineat">@@ -933,21 +935,22 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l30.253"></a><span id="l30.253">     }</span>
<a href="#l30.254"></a><span id="l30.254">     else {</span>
<a href="#l30.255"></a><span id="l30.255">       preferred = this._resources[preferred];</span>
<a href="#l30.256"></a><span id="l30.256">       this.setStatus(preferred.statusType, preferred.statusText);</span>
<a href="#l30.257"></a><span id="l30.257">     }</span>
<a href="#l30.258"></a><span id="l30.258">   },</span>
<a href="#l30.259"></a><span id="l30.259"> </span>
<a href="#l30.260"></a><span id="l30.260">   /* Can send messages to buddies who appear offline */</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-  get canSendMessage() this.account.connected,</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+  get canSendMessage() { return this.account.connected; },</span>
<a href="#l30.263"></a><span id="l30.263"> </span>
<a href="#l30.264"></a><span id="l30.264">   /* Called when the user wants to chat with the buddy */</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineminus">-  createConversation: function()</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-    this._account.createConversation(this.normalizedName)</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+  createConversation: function() {</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+    return this._account.createConversation(this.normalizedName);</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+  }</span>
<a href="#l30.270"></a><span id="l30.270"> };</span>
<a href="#l30.271"></a><span id="l30.271"> function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName)</span>
<a href="#l30.272"></a><span id="l30.272"> {</span>
<a href="#l30.273"></a><span id="l30.273">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l30.274"></a><span id="l30.274"> }</span>
<a href="#l30.275"></a><span id="l30.275"> XMPPAccountBuddy.prototype = XMPPAccountBuddyPrototype;</span>
<a href="#l30.276"></a><span id="l30.276"> </span>
<a href="#l30.277"></a><span id="l30.277"> /* Helper class for account */</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineat">@@ -960,37 +963,37 @@ const XMPPAccountPrototype = {</span>
<a href="#l30.279"></a><span id="l30.279"> </span>
<a href="#l30.280"></a><span id="l30.280">   // Contains the domain of MUC service which is obtained using service</span>
<a href="#l30.281"></a><span id="l30.281">   // discovery.</span>
<a href="#l30.282"></a><span id="l30.282">   _mucService: null,</span>
<a href="#l30.283"></a><span id="l30.283"> </span>
<a href="#l30.284"></a><span id="l30.284">   /* Generate unique id for a stanza. Using id and unique sid is defined in</span>
<a href="#l30.285"></a><span id="l30.285">    * RFC 6120 (Section 8.2.3, 4.7.3).</span>
<a href="#l30.286"></a><span id="l30.286">    */</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-  generateId: function() UuidGenerator.generateUUID().toString().slice(1, -1),</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+  generateId: () =&gt; UuidGenerator.generateUUID().toString().slice(1, -1),</span>
<a href="#l30.289"></a><span id="l30.289"> </span>
<a href="#l30.290"></a><span id="l30.290">   _init: function(aProtoInstance, aImAccount) {</span>
<a href="#l30.291"></a><span id="l30.291">     GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l30.292"></a><span id="l30.292"> </span>
<a href="#l30.293"></a><span id="l30.293">     // Ongoing conversations.</span>
<a href="#l30.294"></a><span id="l30.294">     // The keys of this._conv are assumed to be normalized like account@domain</span>
<a href="#l30.295"></a><span id="l30.295">     // for normal conversations and like room@domain/nick for MUC participant</span>
<a href="#l30.296"></a><span id="l30.296">     // convs.</span>
<a href="#l30.297"></a><span id="l30.297">     this._conv = new NormalizedMap(this.normalizeFullJid.bind(this));</span>
<a href="#l30.298"></a><span id="l30.298"> </span>
<a href="#l30.299"></a><span id="l30.299">     this._buddies = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l30.300"></a><span id="l30.300">     this._mucs = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l30.301"></a><span id="l30.301">   },</span>
<a href="#l30.302"></a><span id="l30.302"> </span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-  get canJoinChat() true,</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+  get canJoinChat() { return true; },</span>
<a href="#l30.305"></a><span id="l30.305">   chatRoomFields: {</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-    room: {get label() _(&quot;chatRoomField.room&quot;), required: true},</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-    server: {get label() _(&quot;chatRoomField.server&quot;), required: true},</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-    nick: {get label() _(&quot;chatRoomField.nick&quot;), required: true},</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-    password: {get label() _(&quot;chatRoomField.password&quot;), isPassword: true}</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineplus">+    room: {get label() { return _(&quot;chatRoomField.room&quot;); }, required: true},</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineplus">+    server: {get label() { return _(&quot;chatRoomField.server&quot;); }, required: true},</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineplus">+    nick: {get label() { return _(&quot;chatRoomField.nick&quot;); }, required: true},</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineplus">+    password: {get label() { return _(&quot;chatRoomField.password&quot;); }, isPassword: true}</span>
<a href="#l30.314"></a><span id="l30.314">   },</span>
<a href="#l30.315"></a><span id="l30.315">   parseDefaultChatName: function(aDefaultChatName) {</span>
<a href="#l30.316"></a><span id="l30.316">     if (!aDefaultChatName)</span>
<a href="#l30.317"></a><span id="l30.317">       return {nick: this._jid.node};</span>
<a href="#l30.318"></a><span id="l30.318"> </span>
<a href="#l30.319"></a><span id="l30.319">     let params = aDefaultChatName.trim().split(/\s+/);</span>
<a href="#l30.320"></a><span id="l30.320">     let jid = this._parseJID(params[0]);</span>
<a href="#l30.321"></a><span id="l30.321"> </span>
<a href="#l30.322"></a><span id="l30.322" class="difflineat">@@ -1776,17 +1779,17 @@ const XMPPAccountPrototype = {</span>
<a href="#l30.323"></a><span id="l30.323">     let buddy;</span>
<a href="#l30.324"></a><span id="l30.324">     if (this._buddies.has(jid)) {</span>
<a href="#l30.325"></a><span id="l30.325">       buddy = this._buddies.get(jid);</span>
<a href="#l30.326"></a><span id="l30.326">       let groups = aItem.getChildren(&quot;group&quot;);</span>
<a href="#l30.327"></a><span id="l30.327">       if (groups.length) {</span>
<a href="#l30.328"></a><span id="l30.328">         // If the server specified at least one group, ensure the group we use</span>
<a href="#l30.329"></a><span id="l30.329">         // as the account buddy's tag is still a group on the server...</span>
<a href="#l30.330"></a><span id="l30.330">         let tagName = buddy.tag.name;</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-        if (!groups.some(function (g) g.innerText == tagName)) {</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+        if (!groups.some(g =&gt; g.innerText == tagName)) {</span>
<a href="#l30.333"></a><span id="l30.333">           // ... otherwise we need to move our account buddy to a new group.</span>
<a href="#l30.334"></a><span id="l30.334">           tagName = groups[0].innerText;</span>
<a href="#l30.335"></a><span id="l30.335">           if (tagName) { // Should always be true, but check just in case...</span>
<a href="#l30.336"></a><span id="l30.336">             let oldTag = buddy.tag;</span>
<a href="#l30.337"></a><span id="l30.337">             buddy._tag = Services.tags.createTag(tagName);</span>
<a href="#l30.338"></a><span id="l30.338">             Services.contacts.accountBuddyMoved(buddy, oldTag, buddy._tag);</span>
<a href="#l30.339"></a><span id="l30.339">           }</span>
<a href="#l30.340"></a><span id="l30.340">         }</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineat">@@ -2130,17 +2133,17 @@ const XMPPAccountPrototype = {</span>
<a href="#l30.342"></a><span id="l30.342">       }</span>
<a href="#l30.343"></a><span id="l30.343">     }</span>
<a href="#l30.344"></a><span id="l30.344">     else if (&quot;_forceUserDisplayNameUpdate&quot; in this) {</span>
<a href="#l30.345"></a><span id="l30.345">       // We remove a display name stored on the server without replacing</span>
<a href="#l30.346"></a><span id="l30.346">       // it with a new value only if this _sendVCard call is the result of</span>
<a href="#l30.347"></a><span id="l30.347">       // a user action. This is to avoid removing data from the server each</span>
<a href="#l30.348"></a><span id="l30.348">       // time the user connects from a new profile.</span>
<a href="#l30.349"></a><span id="l30.349">       this._userVCard.children =</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-        this._userVCard.children.filter(function (n) n.qName != &quot;FN&quot;);</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineplus">+        this._userVCard.children.filter(n =&gt; n.qName != &quot;FN&quot;);</span>
<a href="#l30.352"></a><span id="l30.352">     }</span>
<a href="#l30.353"></a><span id="l30.353">     delete this._forceUserDisplayNameUpdate;</span>
<a href="#l30.354"></a><span id="l30.354"> </span>
<a href="#l30.355"></a><span id="l30.355">     if (this._cachedUserIcon) {</span>
<a href="#l30.356"></a><span id="l30.356">       // If we have a local user icon, update or add it in the PHOTO field.</span>
<a href="#l30.357"></a><span id="l30.357">       let photoChildren = [</span>
<a href="#l30.358"></a><span id="l30.358">         Stanza.node(&quot;TYPE&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.type),</span>
<a href="#l30.359"></a><span id="l30.359">         Stanza.node(&quot;BINVAL&quot;, Stanza.NS.vcard, null, this._cachedUserIcon.binval)</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineat">@@ -2151,17 +2154,17 @@ const XMPPAccountPrototype = {</span>
<a href="#l30.361"></a><span id="l30.361">       else</span>
<a href="#l30.362"></a><span id="l30.362">         this._userVCard.addChild(Stanza.node(&quot;PHOTO&quot;, Stanza.NS.vcard, null,</span>
<a href="#l30.363"></a><span id="l30.363">                                              photoChildren));</span>
<a href="#l30.364"></a><span id="l30.364">     }</span>
<a href="#l30.365"></a><span id="l30.365">     else if (&quot;_forceUserIconUpdate&quot; in this) {</span>
<a href="#l30.366"></a><span id="l30.366">       // Like for the display name, we remove a photo without</span>
<a href="#l30.367"></a><span id="l30.367">       // replacing it only if the call is caused by a user action.</span>
<a href="#l30.368"></a><span id="l30.368">       this._userVCard.children =</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-        this._userVCard.children.filter(function (n) n.qName != &quot;PHOTO&quot;);</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+        this._userVCard.children.filter(n =&gt; n.qName != &quot;PHOTO&quot;);</span>
<a href="#l30.371"></a><span id="l30.371">     }</span>
<a href="#l30.372"></a><span id="l30.372">     delete this._forceUserIconUpdate;</span>
<a href="#l30.373"></a><span id="l30.373"> </span>
<a href="#l30.374"></a><span id="l30.374">     // Send the vCard only if it has really changed.</span>
<a href="#l30.375"></a><span id="l30.375">     // We handle the result response from the server (it does not require</span>
<a href="#l30.376"></a><span id="l30.376">     // any further action).</span>
<a href="#l30.377"></a><span id="l30.377">     if (this._userVCard.getXML() != existingVCard) {</span>
<a href="#l30.378"></a><span id="l30.378">       this.sendStanza(Stanza.iq(&quot;set&quot;, null, null, this._userVCard),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -22,17 +22,17 @@ function test_cleanUsername()</span>
<a href="#l31.4"></a><span id="l31.4"> </span>
<a href="#l31.5"></a><span id="l31.5">   // We must provide a mimimal fake implementation of a protocol object, to keep</span>
<a href="#l31.6"></a><span id="l31.6">   // the YahooAccount constructor happy.</span>
<a href="#l31.7"></a><span id="l31.7">   let fakeProtocol = {</span>
<a href="#l31.8"></a><span id="l31.8">     id: &quot;fake-proto&quot;,</span>
<a href="#l31.9"></a><span id="l31.9">     options: {</span>
<a href="#l31.10"></a><span id="l31.10">       local_charset: &quot;UTF-8&quot;</span>
<a href="#l31.11"></a><span id="l31.11">     },</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    _getOptionDefault: function(aOption) this.options[aOption]</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    _getOptionDefault: function(aOption) { return this.options[aOption]; }</span>
<a href="#l31.14"></a><span id="l31.14">   };</span>
<a href="#l31.15"></a><span id="l31.15">   let fakeImAccount = {};</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">   for each(let domain in domains) {</span>
<a href="#l31.18"></a><span id="l31.18">     fakeImAccount.name = userId + &quot;@&quot; + domain;</span>
<a href="#l31.19"></a><span id="l31.19">     let yahooAccount = new yahoo.YahooAccount(fakeProtocol, fakeImAccount);</span>
<a href="#l31.20"></a><span id="l31.20">     do_check_eq(userId, yahooAccount.cleanUsername);</span>
<a href="#l31.21"></a><span id="l31.21">   }</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -69,17 +69,17 @@ function test_fixFontSize()</span>
<a href="#l31.23"></a><span id="l31.23">      &quot;&lt;font face=\&quot;Arial\&quot; size=\&quot;3\&quot;&gt;Hello. &lt;font face=\&quot;Consolas\&quot; size=\&quot;7\&quot;&gt;World&quot;]</span>
<a href="#l31.24"></a><span id="l31.24">   ];</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26">   let fakeProtocol = {</span>
<a href="#l31.27"></a><span id="l31.27">     id: &quot;fake-proto&quot;,</span>
<a href="#l31.28"></a><span id="l31.28">     options: {</span>
<a href="#l31.29"></a><span id="l31.29">       local_charset: &quot;UTF-8&quot;</span>
<a href="#l31.30"></a><span id="l31.30">     },</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-    _getOptionDefault: function(aOption) this.options[aOption]</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+    _getOptionDefault: function(aOption) { return this.options[aOption]; }</span>
<a href="#l31.33"></a><span id="l31.33">   };</span>
<a href="#l31.34"></a><span id="l31.34">   let fakeImAccount = {name: &quot;test-user&quot;};</span>
<a href="#l31.35"></a><span id="l31.35">   // We create a fake conversation object so we can obtain the cleaned up</span>
<a href="#l31.36"></a><span id="l31.36">   // message from the conv.writeMessage() call.</span>
<a href="#l31.37"></a><span id="l31.37">   let messagePair;</span>
<a href="#l31.38"></a><span id="l31.38">   let fakeConversation = {</span>
<a href="#l31.39"></a><span id="l31.39">     writeMessage: function(aName, aMessage, aProperties) {</span>
<a href="#l31.40"></a><span id="l31.40">       do_check_eq(aMessage, messagePair[1]); // Compare to the good message.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo-session.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -9,17 +9,17 @@ const {classes: Cc, interfaces: Ci, util</span>
<a href="#l32.4"></a><span id="l32.4"> Cu.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l32.5"></a><span id="l32.5"> Cu.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l32.6"></a><span id="l32.6"> Cu.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l32.7"></a><span id="l32.7"> Cu.import(&quot;resource:///modules/ArrayBufferUtils.jsm&quot;);</span>
<a href="#l32.8"></a><span id="l32.8"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l32.9"></a><span id="l32.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l32.10"></a><span id="l32.10"> Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l32.14"></a><span id="l32.14">   l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l32.15"></a><span id="l32.15"> );</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17"> XPCOMUtils.defineLazyServiceGetter(this, &quot;imgTools&quot;,</span>
<a href="#l32.18"></a><span id="l32.18">                                    &quot;@mozilla.org/image/tools;1&quot;, &quot;imgITools&quot;);</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> const kProtocolVersion = 16;</span>
<a href="#l32.21"></a><span id="l32.21"> const kVendorId = 0;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -397,19 +397,19 @@ YahooSession.prototype = {</span>
<a href="#l32.23"></a><span id="l32.23">     if (!this.disconnected)</span>
<a href="#l32.24"></a><span id="l32.24">       this.disconnect();</span>
<a href="#l32.25"></a><span id="l32.25">     this._account.reportDisconnected();</span>
<a href="#l32.26"></a><span id="l32.26">   },</span>
<a href="#l32.27"></a><span id="l32.27"> </span>
<a href="#l32.28"></a><span id="l32.28">   // Private methods.</span>
<a href="#l32.29"></a><span id="l32.29"> </span>
<a href="#l32.30"></a><span id="l32.30">   // Socket Event Callbacks.</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  LOG: function(aString) this._account.LOG(aString),</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+  LOG: function(aString) { return this._account.LOG(aString); },</span>
<a href="#l32.33"></a><span id="l32.33"> </span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-  DEBUG: function(aString) this._account.DEBUG(aString),</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+  DEBUG: function(aString) { return this._account.DEBUG(aString); },</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37">   onConnection: function() {</span>
<a href="#l32.38"></a><span id="l32.38">     // We send an authentication request packet as soon as we connect to the</span>
<a href="#l32.39"></a><span id="l32.39">     // pager server.</span>
<a href="#l32.40"></a><span id="l32.40">     let packet = new YahooPacket(kPacketType.Auth, 0, 0);</span>
<a href="#l32.41"></a><span id="l32.41">     packet.addValue(1, this._account.cleanUsername);</span>
<a href="#l32.42"></a><span id="l32.42">     this.sendPacket(packet);</span>
<a href="#l32.43"></a><span id="l32.43">   },</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineat">@@ -922,17 +922,17 @@ const YahooPacketHandler = {</span>
<a href="#l32.45"></a><span id="l32.45">     let userName = aPacket.getValue(56);</span>
<a href="#l32.46"></a><span id="l32.46">     let roomName = aPacket.getValue(57);</span>
<a href="#l32.47"></a><span id="l32.47">     this.receiveConferenceLogoff(roomName, userName);</span>
<a href="#l32.48"></a><span id="l32.48">   },</span>
<a href="#l32.49"></a><span id="l32.49"> </span>
<a href="#l32.50"></a><span id="l32.50">   // Conference additional invitation. NOTE: Since this packet has the same</span>
<a href="#l32.51"></a><span id="l32.51">   // structure as the normal conference invite (packet 0x18), we simply</span>
<a href="#l32.52"></a><span id="l32.52">   // reuse that handler.</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-  0x1c: function(aPacket) YahooPacketHandler[0x18].call(this, aPacket),</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  0x1c: function(aPacket) { return YahooPacketHandler[0x18].call(this, aPacket); },</span>
<a href="#l32.55"></a><span id="l32.55"> </span>
<a href="#l32.56"></a><span id="l32.56">   // Conference message.</span>
<a href="#l32.57"></a><span id="l32.57">   0x1d: function(aPacket) {</span>
<a href="#l32.58"></a><span id="l32.58">     let from = aPacket.getValue(3);</span>
<a href="#l32.59"></a><span id="l32.59">     let room = aPacket.getValue(57);</span>
<a href="#l32.60"></a><span id="l32.60">     let message = aPacket.getValue(14);</span>
<a href="#l32.61"></a><span id="l32.61">     this.receiveConferenceMessage(from, room, message);</span>
<a href="#l32.62"></a><span id="l32.62">   },</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineat">@@ -993,17 +993,17 @@ const YahooPacketHandler = {</span>
<a href="#l32.64"></a><span id="l32.64">     if (buddy &amp;&amp; buddy.iconChecksum !== checksum) {</span>
<a href="#l32.65"></a><span id="l32.65">       buddy.buddyIconFilename = url;</span>
<a href="#l32.66"></a><span id="l32.66">       buddy.iconChecksum = checksum;</span>
<a href="#l32.67"></a><span id="l32.67">     }</span>
<a href="#l32.68"></a><span id="l32.68">   },</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70">   // Buddy icon request reply. This can be handled in the same way as a buddy</span>
<a href="#l32.71"></a><span id="l32.71">   // icon checksum packet, so we simply reuse the handler.</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-  0xbe: function (aPacket) YahooPacketHandler[0xbd].call(this, aPacket),</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+  0xbe: function (aPacket) { return YahooPacketHandler[0xbd].call(this, aPacket); },</span>
<a href="#l32.74"></a><span id="l32.74"> </span>
<a href="#l32.75"></a><span id="l32.75">   // Buddy status update.</span>
<a href="#l32.76"></a><span id="l32.76">   0xc6: function (aPacket) {</span>
<a href="#l32.77"></a><span id="l32.77">     let name = aPacket.getValue(7);</span>
<a href="#l32.78"></a><span id="l32.78">     // If the user is mobile, use the mobile status.</span>
<a href="#l32.79"></a><span id="l32.79">     let status = aPacket.hasKey(60) ? Ci.imIStatusInfo.STATUS_MOBILE :</span>
<a href="#l32.80"></a><span id="l32.80">                                       kBuddyStatuses[aPacket.getValue(10)];</span>
<a href="#l32.81"></a><span id="l32.81"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l33.8"></a><span id="l33.8"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l33.9"></a><span id="l33.9"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10"> Cu.import(&quot;resource:///modules/yahoo-session.jsm&quot;);</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l33.14"></a><span id="l33.14">   l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l33.15"></a><span id="l33.15"> );</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17"> // These timeouts are in milliseconds.</span>
<a href="#l33.18"></a><span id="l33.18"> const kKeepAliveTimeout = 60 * 1000; // One minute.</span>
<a href="#l33.19"></a><span id="l33.19"> const kPingTimeout = 3600 * 1000; // One hour.</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21"> function YahooConversation(aAccount, aName)</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -66,17 +66,17 @@ YahooConversation.prototype = {</span>
<a href="#l33.23"></a><span id="l33.23">   _cancelTypingTimer: function() {</span>
<a href="#l33.24"></a><span id="l33.24">     if (!this._typingTimer)</span>
<a href="#l33.25"></a><span id="l33.25">       return;</span>
<a href="#l33.26"></a><span id="l33.26">     clearTimeout(this._typingTimer);</span>
<a href="#l33.27"></a><span id="l33.27">     delete this._typingTimer</span>
<a href="#l33.28"></a><span id="l33.28">     this._typingTimer = null;</span>
<a href="#l33.29"></a><span id="l33.29">   },</span>
<a href="#l33.30"></a><span id="l33.30"> </span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  get name() this._buddyUserName</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+  get name() { return this._buddyUserName; }</span>
<a href="#l33.33"></a><span id="l33.33"> };</span>
<a href="#l33.34"></a><span id="l33.34"> </span>
<a href="#l33.35"></a><span id="l33.35"> function YahooConference(aAccount, aRoom, aOwner)</span>
<a href="#l33.36"></a><span id="l33.36"> {</span>
<a href="#l33.37"></a><span id="l33.37">   this._account = aAccount;</span>
<a href="#l33.38"></a><span id="l33.38">   this._roomName = aRoom;</span>
<a href="#l33.39"></a><span id="l33.39">   this._owner = aOwner;</span>
<a href="#l33.40"></a><span id="l33.40">   this._init(aAccount, aRoom, aAccount.cleanUsername);</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineat">@@ -133,44 +133,44 @@ YahooConference.prototype = {</span>
<a href="#l33.42"></a><span id="l33.42">     this.notifyObservers(new nsSimpleEnumerator([stringNickname]),</span>
<a href="#l33.43"></a><span id="l33.43">                          &quot;chat-buddy-remove&quot;);</span>
<a href="#l33.44"></a><span id="l33.44">     this._participants.delete(aName);</span>
<a href="#l33.45"></a><span id="l33.45">     this.writeMessage(this._roomName,</span>
<a href="#l33.46"></a><span id="l33.46">                       _(&quot;system.message.conferenceLogoff&quot;, aName),</span>
<a href="#l33.47"></a><span id="l33.47">                       {system: true});</span>
<a href="#l33.48"></a><span id="l33.48">   },</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-  getParticipantNames: function() [p.name for (p of this._participants.values())]</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+  getParticipantNames: function() { return [for (p of this._participants.values()) p.name]; }</span>
<a href="#l33.52"></a><span id="l33.52"> };</span>
<a href="#l33.53"></a><span id="l33.53"> </span>
<a href="#l33.54"></a><span id="l33.54"> function YahooConferenceBuddy(aName, aConference)</span>
<a href="#l33.55"></a><span id="l33.55"> {</span>
<a href="#l33.56"></a><span id="l33.56">   this._name = aName;</span>
<a href="#l33.57"></a><span id="l33.57">   this._conference = aConference;</span>
<a href="#l33.58"></a><span id="l33.58"> }</span>
<a href="#l33.59"></a><span id="l33.59"> YahooConferenceBuddy.prototype = {</span>
<a href="#l33.60"></a><span id="l33.60">   __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l33.61"></a><span id="l33.61">   _conference: null,</span>
<a href="#l33.62"></a><span id="l33.62"> </span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-  get founder() this._conference._owner == this._name</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+  get founder() { return this._conference._owner == this._name; }</span>
<a href="#l33.65"></a><span id="l33.65"> };</span>
<a href="#l33.66"></a><span id="l33.66"> </span>
<a href="#l33.67"></a><span id="l33.67"> function YahooAccountBuddy(aAccount, aBuddy, aTag, aUserName)</span>
<a href="#l33.68"></a><span id="l33.68"> {</span>
<a href="#l33.69"></a><span id="l33.69">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l33.70"></a><span id="l33.70"> }</span>
<a href="#l33.71"></a><span id="l33.71"> YahooAccountBuddy.prototype = {</span>
<a href="#l33.72"></a><span id="l33.72">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l33.73"></a><span id="l33.73">   iconChecksum: null,</span>
<a href="#l33.74"></a><span id="l33.74"> </span>
<a href="#l33.75"></a><span id="l33.75">   // This removes the buddy locally, and from the Yahoo! servers.</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-  remove: function() this._account.removeBuddy(this, true),</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  remove: function() { return this._account.removeBuddy(this, true); },</span>
<a href="#l33.78"></a><span id="l33.78">   // This removes the buddy locally, but keeps him on the servers.</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-  removeLocal: function() this._account.removeBuddy(this, false),</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-  createConversation: function() this._account.createConversation(this.userName)</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+  removeLocal: function() { return this._account.removeBuddy(this, false); },</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  createConversation: function() { return this._account.createConversation(this.userName); }</span>
<a href="#l33.83"></a><span id="l33.83"> }</span>
<a href="#l33.84"></a><span id="l33.84"> </span>
<a href="#l33.85"></a><span id="l33.85"> function YahooAccount(aProtoInstance, aImAccount)</span>
<a href="#l33.86"></a><span id="l33.86"> {</span>
<a href="#l33.87"></a><span id="l33.87">   this._init(aProtoInstance, aImAccount);</span>
<a href="#l33.88"></a><span id="l33.88">   this._buddies = new Map();</span>
<a href="#l33.89"></a><span id="l33.89">   this._conversations = new Map();</span>
<a href="#l33.90"></a><span id="l33.90">   this._conferences = new Map();</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineat">@@ -455,17 +455,17 @@ YahooAccount.prototype = {</span>
<a href="#l33.92"></a><span id="l33.92">     } catch (e) {</span>
<a href="#l33.93"></a><span id="l33.93">       decodedMsg = aMessage;</span>
<a href="#l33.94"></a><span id="l33.94">       this.WARN(&quot;Could not decode &quot; + this._converter.charset +</span>
<a href="#l33.95"></a><span id="l33.95">                 &quot; message into UTF-16. Message: &quot; + aMessage);</span>
<a href="#l33.96"></a><span id="l33.96">     }</span>
<a href="#l33.97"></a><span id="l33.97">     return decodedMsg;</span>
<a href="#l33.98"></a><span id="l33.98">   },</span>
<a href="#l33.99"></a><span id="l33.99"> </span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-  get canJoinChat() true,</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  get canJoinChat() { return true; },</span>
<a href="#l33.102"></a><span id="l33.102">   chatRoomFields: {},</span>
<a href="#l33.103"></a><span id="l33.103">   joinChat: function(aComponents) {</span>
<a href="#l33.104"></a><span id="l33.104">     // Use _roomsCreated to append a unique number to the room name.</span>
<a href="#l33.105"></a><span id="l33.105">     let roomName = this.cleanUsername + &quot;-&quot; + ++this._roomsCreated;</span>
<a href="#l33.106"></a><span id="l33.106">     let conf = new YahooConference(this, roomName, this.cleanUsername);</span>
<a href="#l33.107"></a><span id="l33.107">     this._conferences.set(roomName, conf);</span>
<a href="#l33.108"></a><span id="l33.108">     this._session.createConference(roomName);</span>
<a href="#l33.109"></a><span id="l33.109">   },</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineat">@@ -528,28 +528,28 @@ function YahooProtocol() {</span>
<a href="#l33.111"></a><span id="l33.111"> YahooProtocol.prototype = {</span>
<a href="#l33.112"></a><span id="l33.112">   __proto__: GenericProtocolPrototype,</span>
<a href="#l33.113"></a><span id="l33.113">   // Protocol specific connection parameters.</span>
<a href="#l33.114"></a><span id="l33.114">   pagerRequestUrl: &quot;http://scsa.msg.yahoo.com/capacity&quot;,</span>
<a href="#l33.115"></a><span id="l33.115">   loginTokenGetUrl: &quot;https://login.yahoo.com/config/pwtoken_get&quot;,</span>
<a href="#l33.116"></a><span id="l33.116">   loginTokenLoginUrl: &quot;https://login.yahoo.com/config/pwtoken_login&quot;,</span>
<a href="#l33.117"></a><span id="l33.117">   buildId: &quot;4194239&quot;,</span>
<a href="#l33.118"></a><span id="l33.118"> </span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-  get id() &quot;prpl-yahoo&quot;,</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-  get name() &quot;Yahoo&quot;,</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-yahoo/skin/&quot;,</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+  get id() { return &quot;prpl-yahoo&quot;; },</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+  get name() { return &quot;Yahoo&quot;; },</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://prpl-yahoo/skin/&quot;; },</span>
<a href="#l33.125"></a><span id="l33.125">   options: {</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-    port: {get label() _(&quot;options.pagerPort&quot;), default: 5050},</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-    local_charset: {get label() _(&quot;options.chatEncoding&quot;), default: &quot;UTF-8&quot;},</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-    ignore_invites: {get label() _(&quot;options.ignoreInvites&quot;), default: false}</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+    port: {get label() { return _(&quot;options.pagerPort&quot;); }, default: 5050},</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+    local_charset: {get label() { return _(&quot;options.chatEncoding&quot;); }, default: &quot;UTF-8&quot;},</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+    ignore_invites: {get label() { return _(&quot;options.ignoreInvites&quot;); }, default: false}</span>
<a href="#l33.132"></a><span id="l33.132">   },</span>
<a href="#l33.133"></a><span id="l33.133">   commands: [</span>
<a href="#l33.134"></a><span id="l33.134">     {</span>
<a href="#l33.135"></a><span id="l33.135">       name: &quot;invite&quot;,</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-      get helpString() _(&quot;command.help.invite2&quot;, &quot;invite&quot;),</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+      get helpString() { return _(&quot;command.help.invite2&quot;, &quot;invite&quot;); },</span>
<a href="#l33.138"></a><span id="l33.138">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l33.139"></a><span id="l33.139">       run: function(aMsg, aConv) {</span>
<a href="#l33.140"></a><span id="l33.140">         if (aMsg.trim().length == 0)</span>
<a href="#l33.141"></a><span id="l33.141">           return false;</span>
<a href="#l33.142"></a><span id="l33.142"> </span>
<a href="#l33.143"></a><span id="l33.143">         let splitPosition = aMsg.indexOf(&quot; &quot;); // Split at first space.</span>
<a href="#l33.144"></a><span id="l33.144">         let invitees;</span>
<a href="#l33.145"></a><span id="l33.145">         let message;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineat">@@ -572,21 +572,21 @@ YahooProtocol.prototype = {</span>
<a href="#l33.147"></a><span id="l33.147">                           {system: true, noLog: true});</span>
<a href="#l33.148"></a><span id="l33.148">         conf._account.LOG(&quot;Sending conference invite to &quot; + invitees);</span>
<a href="#l33.149"></a><span id="l33.149">         return true;</span>
<a href="#l33.150"></a><span id="l33.150">       },</span>
<a href="#l33.151"></a><span id="l33.151">     },</span>
<a href="#l33.152"></a><span id="l33.152"> </span>
<a href="#l33.153"></a><span id="l33.153">     {</span>
<a href="#l33.154"></a><span id="l33.154">       name: &quot;conference&quot;,</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-      get helpString() _(&quot;command.help.conference&quot;, &quot;conference&quot;),</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+      get helpString() { return _(&quot;command.help.conference&quot;, &quot;conference&quot;); },</span>
<a href="#l33.157"></a><span id="l33.157">       usageContext: Ci.imICommand.CMD_CONTEXT_CHAT,</span>
<a href="#l33.158"></a><span id="l33.158">       run: function(aMsg, aConv) {</span>
<a href="#l33.159"></a><span id="l33.159">         aConv.account.joinChat(null);</span>
<a href="#l33.160"></a><span id="l33.160">         return true;</span>
<a href="#l33.161"></a><span id="l33.161">       }</span>
<a href="#l33.162"></a><span id="l33.162">     }</span>
<a href="#l33.163"></a><span id="l33.163">   ],</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineminus">-  getAccount: function(aImAccount) new YahooAccount(this, aImAccount),</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+  getAccount: function(aImAccount) { return new YahooAccount(this, aImAccount); },</span>
<a href="#l33.166"></a><span id="l33.166">   classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;)</span>
<a href="#l33.167"></a><span id="l33.167"> };</span>
<a href="#l33.168"></a><span id="l33.168"> </span>
<a href="#l33.169"></a><span id="l33.169"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([YahooProtocol]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

