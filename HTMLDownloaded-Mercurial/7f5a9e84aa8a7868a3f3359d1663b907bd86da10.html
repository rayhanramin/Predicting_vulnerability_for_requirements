<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1974:7f5a9e84aa8a7868a3f3359d1663b907bd86da10</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7f5a9e84aa8a7868a3f3359d1663b907bd86da10" />
<meta property="og:url" content="/comm-central/rev/7f5a9e84aa8a7868a3f3359d1663b907bd86da10" />
<meta property="og:description" content="bug 425480 - non-ASCII characters should be decoded in the urlbar (like in FF3), r+sr=Neil, a=kairo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7f5a9e84aa8a7868a3f3359d1663b907bd86da10 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">shortlog</a> |
<a href="/comm-central/log/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">files</a> |
changeset |
<a href="/comm-central/raw-rev/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">raw</a>  | <a href="/comm-central/archive/7f5a9e84aa8a7868a3f3359d1663b907bd86da10.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=425480">bug 425480</a> - non-ASCII characters should be decoded in the urlbar (like in FF3), r+sr=Neil, a=kairo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#115;&#97;&#107;&#32;&#75;&#104;&#97;&#99;&#104;&#97;&#116;&#114;&#121;&#97;&#110;&#32;&#60;&#109;&#105;&#115;&#97;&#107;&#64;&#120;&#116;&#101;&#114;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 17 Feb 2009 19:53:06 +0100</td></tr>

<tr>
 <td>changeset 1974</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7f5a9e84aa8a7868a3f3359d1663b907bd86da10">7f5a9e84aa8a7868a3f3359d1663b907bd86da10</a></td>
</tr>



<tr>
<td>parent 1973</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f6dc1d644315d986b6538f977fcf0eb540ee23c4">f6dc1d644315d986b6538f977fcf0eb540ee23c4</a>
</td>
</tr>

<tr>
<td>child 1975</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/aa48f3555109a455340e762626fcf7a47580d9db">aa48f3555109a455340e762626fcf7a47580d9db</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7f5a9e84aa8a7868a3f3359d1663b907bd86da10">1600</a></td></tr>
<tr><td>push user</td><td>kairo@kairo.at</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Feb 2009 18:53:25 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7f5a9e84aa8a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&newProject=comm-central&newRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&newProject=comm-central&newRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&newProject=comm-central&newRevision=7f5a9e84aa8a7868a3f3359d1663b907bd86da10&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28kairo%29&revcount=50">kairo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=425480">425480</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=425480">bug 425480</a> - non-ASCII characters should be decoded in the urlbar (like in FF3), r+sr=Neil, a=kairo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">suite/browser/nsBrowserStatusHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">file</a> |
<a href="/comm-central/annotate/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">annotate</a> |
<a href="/comm-central/diff/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">diff</a> |
<a href="/comm-central/comparison/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">comparison</a> |
<a href="/comm-central/log/7f5a9e84aa8a7868a3f3359d1663b907bd86da10/suite/browser/nsBrowserStatusHandler.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1506,25 +1506,18 @@ function BrowserLoadURL(aTriggeringEvent</span>
<a href="#l1.4"></a><span id="l1.4">         if (!shiftPressed) {</span>
<a href="#l1.5"></a><span id="l1.5">           browser.userTypedValue = null;</span>
<a href="#l1.6"></a><span id="l1.6">           browser.selectedTab = t;</span>
<a href="#l1.7"></a><span id="l1.7">         }</span>
<a href="#l1.8"></a><span id="l1.8">       } else {</span>
<a href="#l1.9"></a><span id="l1.9">         // Open a new window with the URL</span>
<a href="#l1.10"></a><span id="l1.10">         var newWin = openDialog(getBrowserURL(), &quot;_blank&quot;, &quot;all,dialog=no&quot;, url,</span>
<a href="#l1.11"></a><span id="l1.11">             null, null, nsIWebNavigation.LOAD_FLAGS_ALLOW_THIRD_PARTY_FIXUP);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        // Reset url in the urlbar, copied from handleURLBarRevert()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        var oldURL = browser.currentURI.spec;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        if (oldURL != &quot;about:blank&quot; || content.opener) {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-          gURLBar.value = oldURL;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-          SetPageProxyState(&quot;valid&quot;, null);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        } else</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-          gURLBar.value = &quot;&quot;;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-        browser.userTypedValue = null;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        // Reset url in the urlbar</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        URLBarSetURI();</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">         // Focus old window if shift was pressed, as there's no</span>
<a href="#l1.25"></a><span id="l1.25">         // way to open a new window in the background</span>
<a href="#l1.26"></a><span id="l1.26">         // XXX this doesn't seem to work</span>
<a href="#l1.27"></a><span id="l1.27">         if (shiftPressed) {</span>
<a href="#l1.28"></a><span id="l1.28">           //newWin.blur();</span>
<a href="#l1.29"></a><span id="l1.29">           content.focus();</span>
<a href="#l1.30"></a><span id="l1.30">         }</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineat">@@ -1846,16 +1839,70 @@ function postURLToNativeWidget()</span>
<a href="#l1.32"></a><span id="l1.32"> function checkForDirectoryListing()</span>
<a href="#l1.33"></a><span id="l1.33"> {</span>
<a href="#l1.34"></a><span id="l1.34">   if ( &quot;HTTPIndex&quot; in content &amp;&amp;</span>
<a href="#l1.35"></a><span id="l1.35">        content.HTTPIndex instanceof Components.interfaces.nsIHTTPIndex ) {</span>
<a href="#l1.36"></a><span id="l1.36">     content.defaultCharacterset = getMarkupDocumentViewer().defaultCharacterSet;</span>
<a href="#l1.37"></a><span id="l1.37">   }</span>
<a href="#l1.38"></a><span id="l1.38"> }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+function URLBarSetURI(aURI, aValid) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  var uri = aURI || getWebNavigation().currentURI;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  // If the url has &quot;wyciwyg://&quot; as the protocol, strip it off.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  // Nobody wants to see it on the urlbar for dynamically generated pages.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  if (!gURIFixup)</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    gURIFixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                          .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  try {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    aURI = gURIFixup.createExposableURI(aURI);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    uri = aURI || getWebNavigation().currentURI;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  // Replace &quot;about:blank&quot; with an empty string</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  // only if there's no opener (bug 370555).</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  if (uri.spec == &quot;about:blank&quot;)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    value = content.opener ? &quot;about:blank&quot; : &quot;&quot;;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  else</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    value = losslessDecodeURI(uri);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  gURLBar.value = value;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  // In some cases, setting the urlBar value causes userTypedValue to</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  // become set because of oninput, so reset it to null.</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  getBrowser().userTypedValue = null;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  SetPageProxyState((value &amp;&amp; (!aURI || aValid)) ? &quot;valid&quot; : &quot;invalid&quot;, null);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+}</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+function losslessDecodeURI(aURI) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  var value = aURI.spec;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  // Try to decode as UTF-8 if there's no encoding sequence that we would break.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  if (!/%25(?:3B|2F|3F|3A|40|26|3D|2B|24|2C|23)/i.test(value))</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    try {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      value = decodeURI(value)</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+                // decodeURI decodes %25 to %, which creates unintended</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+                // encoding sequences. Re-encode it, unless it's part of</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+                // a sequence that survived decodeURI, i.e. one for:</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                // ';', '/', '?', ':', '@', '&amp;', '=', '+', '$', ',', '#'</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+                // (RFC 3987 section 3.2)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                .replace(/%(?!3B|2F|3F|3A|40|26|3D|2B|24|2C|23)/ig,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+                         encodeURIComponent);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    } catch (e) {}</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  // Encode invisible characters (soft hyphen, zero-width space, BOM,</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  // line and paragraph separator, word joiner, invisible times,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  // invisible separator, object replacement character) (bug 452979)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  // Encode bidirectional formatting characters.</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  // (RFC 3987 sections 3.2 and 4.1 paragraph 6)</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  // Re-encode whitespace so that it doesn't get eaten away</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  // by the location bar (bug 410726).</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+  return value.replace(/[\x09-\x0d\x1c-\x1f\u00ad\u200b\u200e\u200f\u2028-\u202e\u2060\u2062\u2063\ufeff\ufffc]/g,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+                        encodeURIComponent);</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+}</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+</span>
<a href="#l1.94"></a><span id="l1.94"> /**</span>
<a href="#l1.95"></a><span id="l1.95">  * Use Stylesheet functions.</span>
<a href="#l1.96"></a><span id="l1.96">  *     Written by Tim Hill (bug 6782)</span>
<a href="#l1.97"></a><span id="l1.97">  *     Frameset handling by Neil Rashbrook &lt;neil@parkwaycc.co.uk&gt;</span>
<a href="#l1.98"></a><span id="l1.98">  **/</span>
<a href="#l1.99"></a><span id="l1.99"> /**</span>
<a href="#l1.100"></a><span id="l1.100">  * Adds this frame's stylesheet sets to the View &gt; Use Style submenu</span>
<a href="#l1.101"></a><span id="l1.101">  *</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineat">@@ -2080,30 +2127,26 @@ function handleURLBarRevert()</span>
<a href="#l1.103"></a><span id="l1.103">   var url = getWebNavigation().currentURI.spec;</span>
<a href="#l1.104"></a><span id="l1.104">   var throbberElement = document.getElementById(&quot;navigator-throbber&quot;);</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">   var isScrolling = gURLBar.userAction == &quot;scrolling&quot;;</span>
<a href="#l1.107"></a><span id="l1.107">   </span>
<a href="#l1.108"></a><span id="l1.108">   // don't revert to last valid url unless page is NOT loading</span>
<a href="#l1.109"></a><span id="l1.109">   // and user is NOT key-scrolling through autocomplete list</span>
<a href="#l1.110"></a><span id="l1.110">   if (!throbberElement.hasAttribute(&quot;busy&quot;) &amp;&amp; !isScrolling) {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    if (url != &quot;about:blank&quot; || content.opener) {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-      gURLBar.value = url;</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    URLBarSetURI();</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    // If the value isn't empty, select it.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    if (gURLBar.value)</span>
<a href="#l1.117"></a><span id="l1.117">       gURLBar.select();</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-      SetPageProxyState(&quot;valid&quot;, null); // XXX Build a URI and pass it in here.</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    } else { //if about:blank, urlbar becomes &quot;&quot;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-      gURLBar.value = &quot;&quot;;</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-    }</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-    gBrowser.userTypedValue = null;</span>
<a href="#l1.124"></a><span id="l1.124">   }</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">   // tell widget to revert to last typed text only if the user</span>
<a href="#l1.127"></a><span id="l1.127">   // was scrolling when they hit escape</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  return isScrolling; </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  return isScrolling;</span>
<a href="#l1.130"></a><span id="l1.130"> }</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132"> function handleURLBarCommand(aUserAction, aTriggeringEvent)</span>
<a href="#l1.133"></a><span id="l1.133"> {</span>
<a href="#l1.134"></a><span id="l1.134">   try {</span>
<a href="#l1.135"></a><span id="l1.135">     addToUrlbarHistory(gURLBar.value);</span>
<a href="#l1.136"></a><span id="l1.136">   } catch (ex) {</span>
<a href="#l1.137"></a><span id="l1.137">     // Things may go wrong when adding url to session history,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -314,59 +314,32 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     // XXX temporary hack for bug 104532.</span>
<a href="#l2.6"></a><span id="l2.6">     // Depends heavily on setOverLink implementation</span>
<a href="#l2.7"></a><span id="l2.7">     if (!aRequest)</span>
<a href="#l2.8"></a><span id="l2.8">       this.status = this.jsStatus = this.jsDefaultStatus = &quot;&quot;;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">     this.setOverLink(&quot;&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    var locationURI = null;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    var location = &quot;&quot;;    </span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    if (aLocation) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      try {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-        if (!gURIFixup)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-          gURIFixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-                                .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-        // If the url has &quot;wyciwyg://&quot; as the protocol, strip it off.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-        // Nobody wants to see it on the urlbar for dynamically generated</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-        // pages.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-        locationURI = gURIFixup.createExposableURI(aLocation);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-        location = locationURI.spec;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-      }</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      catch(ex) {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-        location = aLocation.spec;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-      }</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    }</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    if (!getWebNavigation().canGoBack &amp;&amp; location == &quot;about:blank&quot; &amp;&amp; !content.opener)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-      location = &quot;&quot;;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-</span>
<a href="#l2.34"></a><span id="l2.34">     // Disable menu entries for images, enable otherwise</span>
<a href="#l2.35"></a><span id="l2.35">     if (content.document &amp;&amp; this.mimeTypeIsTextBased(content.document.contentType))</span>
<a href="#l2.36"></a><span id="l2.36">       this.isImage.removeAttribute('disabled');</span>
<a href="#l2.37"></a><span id="l2.37">     else</span>
<a href="#l2.38"></a><span id="l2.38">       this.isImage.setAttribute('disabled', 'true');</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">     // We should probably not do this if the value has changed since the user</span>
<a href="#l2.41"></a><span id="l2.41">     // searched</span>
<a href="#l2.42"></a><span id="l2.42">     // Update urlbar only if a new page was loaded on the primary content area</span>
<a href="#l2.43"></a><span id="l2.43">     // Do not update urlbar if there was a subframe navigation</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     var browser = getBrowser().selectedBrowser;</span>
<a href="#l2.46"></a><span id="l2.46">     if (aWebProgress.DOMWindow == content) {</span>
<a href="#l2.47"></a><span id="l2.47">       var userTypedValue = browser.userTypedValue;</span>
<a href="#l2.48"></a><span id="l2.48">       if (userTypedValue === null) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-        this.urlBar.value = location;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-        SetPageProxyState(&quot;valid&quot;, aLocation);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        // Setting the urlBar value in some cases causes userTypedValue to</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-        // become set because of oninput, so reset it to null</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-        browser.userTypedValue = null;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+        URLBarSetURI(aLocation, true);</span>
<a href="#l2.56"></a><span id="l2.56">       } else {</span>
<a href="#l2.57"></a><span id="l2.57">         this.urlBar.value = userTypedValue;</span>
<a href="#l2.58"></a><span id="l2.58">         SetPageProxyState(&quot;invalid&quot;, null);</span>
<a href="#l2.59"></a><span id="l2.59">       }</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">       this.feedsMenu.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l2.62"></a><span id="l2.62">       this.feedsButton.hidden = true;</span>
<a href="#l2.63"></a><span id="l2.63">       this.feeds = [];</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineat">@@ -420,22 +393,25 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l2.65"></a><span id="l2.65">     if (securityUI)</span>
<a href="#l2.66"></a><span id="l2.66">       this.securityButton.setAttribute(&quot;tooltiptext&quot;, securityUI.tooltipText);</span>
<a href="#l2.67"></a><span id="l2.67">     else</span>
<a href="#l2.68"></a><span id="l2.68">       this.securityButton.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l2.69"></a><span id="l2.69">   },</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">   startDocumentLoad : function(aRequest)</span>
<a href="#l2.72"></a><span id="l2.72">   {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-    const nsIChannel = Components.interfaces.nsIChannel;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    var urlStr = aRequest.QueryInterface(nsIChannel).URI.spec;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    var uri = aRequest.QueryInterface(Components.interfaces.nsIChannel).URI;</span>
<a href="#l2.76"></a><span id="l2.76">     var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l2.77"></a><span id="l2.77">                                     .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    if (gURLBar.value &amp;&amp; getWebNavigation().currentURI.spec == &quot;about:blank&quot;)</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+      URLBarSetURI(uri);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82">     try {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-      observerService.notifyObservers(content, &quot;StartDocumentLoad&quot;, urlStr);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+      observerService.notifyObservers(content, &quot;StartDocumentLoad&quot;, uri.spec);</span>
<a href="#l2.85"></a><span id="l2.85">     } catch (e) {</span>
<a href="#l2.86"></a><span id="l2.86">     }</span>
<a href="#l2.87"></a><span id="l2.87">   },</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">   endDocumentLoad : function(aRequest, aStatus)</span>
<a href="#l2.90"></a><span id="l2.90">   {</span>
<a href="#l2.91"></a><span id="l2.91">     const nsIChannel = Components.interfaces.nsIChannel;</span>
<a href="#l2.92"></a><span id="l2.92">     var urlStr = aRequest.QueryInterface(nsIChannel).originalURI.spec;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

