<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9620:43b791fd9ea48fc0befc2462f085b2915245606b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 43b791fd9ea48fc0befc2462f085b2915245606b" />
<meta property="og:url" content="/comm-central/rev/43b791fd9ea48fc0befc2462f085b2915245606b" />
<meta property="og:description" content="add backend compose/mime support for filelink attachments, r=squib, sr=standard8, bug 698925" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 43b791fd9ea48fc0befc2462f085b2915245606b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/43b791fd9ea48fc0befc2462f085b2915245606b">shortlog</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/43b791fd9ea48fc0befc2462f085b2915245606b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b">files</a> |
changeset |
<a href="/comm-central/raw-rev/43b791fd9ea48fc0befc2462f085b2915245606b">raw</a>  | <a href="/comm-central/archive/43b791fd9ea48fc0befc2462f085b2915245606b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
add backend compose/mime support for filelink attachments, r=squib, sr=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">bug 698925</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 12 Mar 2012 16:09:58 -0700</td></tr>

<tr>
 <td>changeset 9620</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/43b791fd9ea48fc0befc2462f085b2915245606b">43b791fd9ea48fc0befc2462f085b2915245606b</a></td>
</tr>



<tr>
<td>parent 9619</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e827c650565ca7c6261a7dd414b411561e5507d4">e827c650565ca7c6261a7dd414b411561e5507d4</a>
</td>
</tr>

<tr>
<td>child 9621</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2f812220bd39b96e6888ba300975dc344282b22f">2f812220bd39b96e6888ba300975dc344282b22f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=43b791fd9ea48fc0befc2462f085b2915245606b">7350</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 12 Mar 2012 23:09:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@43b791fd9ea4 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=43b791fd9ea48fc0befc2462f085b2915245606b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=43b791fd9ea48fc0befc2462f085b2915245606b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=43b791fd9ea48fc0befc2462f085b2915245606b&newProject=comm-central&newRevision=43b791fd9ea48fc0befc2462f085b2915245606b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=43b791fd9ea48fc0befc2462f085b2915245606b&newProject=comm-central&newRevision=43b791fd9ea48fc0befc2462f085b2915245606b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=43b791fd9ea48fc0befc2462f085b2915245606b&newProject=comm-central&newRevision=43b791fd9ea48fc0befc2462f085b2915245606b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28squib%29&revcount=50">squib</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28bug%29&revcount=50">bug</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">698925</a></td></tr>




</table></div>

<div class="page_body description">add backend compose/mime support for filelink attachments, r=squib, sr=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">bug 698925</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">mailnews/base/util/iteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/base/util/iteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">mailnews/compose/public/nsIMsgAttachment.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgAttachment.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">mailnews/compose/src/nsMsgAttachment.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachment.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">mailnews/mime/public/nsMailHeaders.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/public/nsMailHeaders.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/43b791fd9ea48fc0befc2462f085b2915245606b/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -75,16 +75,17 @@ function toArray(aObj, aUseKeys) {</span>
<a href="#l1.4"></a><span id="l1.4">   return null;</span>
<a href="#l1.5"></a><span id="l1.5"> }</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> /**</span>
<a href="#l1.8"></a><span id="l1.8"> * Given a JS array, JS iterator, or one of a variety of XPCOM collections or</span>
<a href="#l1.9"></a><span id="l1.9">  * iterators, return a JS iterator suitable for use in a for...in expression.</span>
<a href="#l1.10"></a><span id="l1.10">  *</span>
<a href="#l1.11"></a><span id="l1.11">  * Currently, we support the following types of xpcom iterators:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ *   nsIArray</span>
<a href="#l1.13"></a><span id="l1.13">  *   nsISupportsArray</span>
<a href="#l1.14"></a><span id="l1.14">  *   nsIEnumerator</span>
<a href="#l1.15"></a><span id="l1.15">  *   nsISimpleEnumerator</span>
<a href="#l1.16"></a><span id="l1.16">  *</span>
<a href="#l1.17"></a><span id="l1.17">  *   @param aEnum  the enumerator to convert</span>
<a href="#l1.18"></a><span id="l1.18">  *   @param aIface (optional) an interface to QI each object to prior to</span>
<a href="#l1.19"></a><span id="l1.19">  *                 returning</span>
<a href="#l1.20"></a><span id="l1.20">  *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -105,16 +106,26 @@ function fixIterator(aEnum, aIface) {</span>
<a href="#l1.22"></a><span id="l1.22">     if (!aIface)</span>
<a href="#l1.23"></a><span id="l1.23">       return aEnum;</span>
<a href="#l1.24"></a><span id="l1.24">     else</span>
<a href="#l1.25"></a><span id="l1.25">       return (o.QueryInterface(aIface) for (o in aEnum));</span>
<a href="#l1.26"></a><span id="l1.26">   }</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   let face = aIface || Ci.nsISupports;</span>
<a href="#l1.29"></a><span id="l1.29">   // Figure out which kind of iterator we have</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  if (aEnum instanceof Ci.nsIArray) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    let iter = function() {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      let count = aEnum.length;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      for (let i = 0; i &lt; count; i++)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+        yield aEnum.queryElementAt(i, face);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    }</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    return { __iterator__: iter };</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  }</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  // Try an nsISupportsArray</span>
<a href="#l1.40"></a><span id="l1.40">   if (aEnum instanceof Ci.nsISupportsArray) {</span>
<a href="#l1.41"></a><span id="l1.41">     let iter = function() {</span>
<a href="#l1.42"></a><span id="l1.42">       let count = aEnum.Count();</span>
<a href="#l1.43"></a><span id="l1.43">       for (let i = 0; i &lt; count; i++)</span>
<a href="#l1.44"></a><span id="l1.44">         yield aEnum.QueryElementAt(i, face);</span>
<a href="#l1.45"></a><span id="l1.45">     }</span>
<a href="#l1.46"></a><span id="l1.46">     return { __iterator__: iter };</span>
<a href="#l1.47"></a><span id="l1.47">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgAttachment.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgAttachment.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -32,57 +32,74 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.5"></a><span id="l2.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.6"></a><span id="l2.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.7"></a><span id="l2.7">  *</span>
<a href="#l2.8"></a><span id="l2.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(908a8090-cce4-11df-bd3b-0800200c9a66)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(d17d2d60-ec3a-46de-8bd1-24c77dd9b87b)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgAttachment : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * name attribute</span>
<a href="#l2.18"></a><span id="l2.18">    *</span>
<a href="#l2.19"></a><span id="l2.19">    * @Attachment real name, will be sent with the attachment's header.</span>
<a href="#l2.20"></a><span id="l2.20">    * @If no name has been provided, a name will be generated using the url.</span>
<a href="#l2.21"></a><span id="l2.21">    */</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">- 	attribute AString   name;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-	</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  attribute AString   name;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+</span>
<a href="#l2.26"></a><span id="l2.26">   /**</span>
<a href="#l2.27"></a><span id="l2.27">    * url attribute</span>
<a href="#l2.28"></a><span id="l2.28">    *</span>
<a href="#l2.29"></a><span id="l2.29">    * @specify where the attachment live (localy or remotely)</span>
<a href="#l2.30"></a><span id="l2.30">    */</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-	attribute AUTF8String  url;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  attribute AUTF8String  url;</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">   /**</span>
<a href="#l2.35"></a><span id="l2.35">    * urlCharset attribute</span>
<a href="#l2.36"></a><span id="l2.36">    *</span>
<a href="#l2.37"></a><span id="l2.37">    * @specify the Charset of url  (used to convert url to Unicode after </span>
<a href="#l2.38"></a><span id="l2.38">    *  unescaping)</span>
<a href="#l2.39"></a><span id="l2.39">    */</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-	attribute ACString    urlCharset;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  attribute ACString    urlCharset;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   /**</span>
<a href="#l2.45"></a><span id="l2.45">    * temporary attribute</span>
<a href="#l2.46"></a><span id="l2.46">    *</span>
<a href="#l2.47"></a><span id="l2.47">    * @If set to true, the file pointed by the url will be destroyed when this object is destroyed.</span>
<a href="#l2.48"></a><span id="l2.48">    * @This is only for local attachment.</span>
<a href="#l2.49"></a><span id="l2.49">    */</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-	attribute boolean   temporary;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  attribute boolean temporary;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  /**</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   * Are we storing this attachment via a cloud provider and linking to it?</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   */</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  attribute boolean sendViaCloud;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  /**</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   * Cloud provider account key for this attachment, if any.</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+   */</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  attribute ACString cloudProviderKey;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  /**</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+   * This allows the compose front end code to put whatever html annotation</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+   * it wants for the cloud part, e.g., with expiration time, etc.</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+   */</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  attribute AString htmlAnnotation;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   /**</span>
<a href="#l2.70"></a><span id="l2.70">    * contentLocation attribute</span>
<a href="#l2.71"></a><span id="l2.71">    *</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-   * @Specify the origin url of the attachment, used normaly when attaching a locally saved html document.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+   * @Specify the origin url of the attachment, used normally when attaching</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+   * a locally saved html document, but also used for cloud files.</span>
<a href="#l2.75"></a><span id="l2.75">    */</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  attribute string    contentLocation;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  attribute ACString contentLocation;</span>
<a href="#l2.78"></a><span id="l2.78">   </span>
<a href="#l2.79"></a><span id="l2.79">   /**</span>
<a href="#l2.80"></a><span id="l2.80">    * contentType attribute</span>
<a href="#l2.81"></a><span id="l2.81">    *</span>
<a href="#l2.82"></a><span id="l2.82">    * @Specify the content-type of the attachment, this does not include extra content-type parameters. If</span>
<a href="#l2.83"></a><span id="l2.83">    * @you need to specify extra information, use contentTypeParam, charset, macType or macCreator.</span>
<a href="#l2.84"></a><span id="l2.84">    * @If ommitted, it will be determined base on either the name, the url or the content of the file.</span>
<a href="#l2.85"></a><span id="l2.85">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -120,17 +120,17 @@ interface nsIMsgAttachmentData : nsISupp</span>
<a href="#l3.4"></a><span id="l3.4">   attribute ACString xMacCreator;</span>
<a href="#l3.5"></a><span id="l3.5"> };</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> /**</span>
<a href="#l3.8"></a><span id="l3.8">  * When we have downloaded a URL to a tmp file for attaching, this</span>
<a href="#l3.9"></a><span id="l3.9">  * represents everything we learned about it (and did to it) in the</span>
<a href="#l3.10"></a><span id="l3.10">  * process.</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(156bad99-c5a1-425d-8319-3e79c02571d4)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(c552345d-c74b-40b0-a673-79bb461e920b)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIMsgAttachedFile : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">   /// Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l3.17"></a><span id="l3.17">   attribute nsIURI origUrl;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   /// The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l3.20"></a><span id="l3.20">   attribute nsILocalFile tmpFile;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -141,16 +141,19 @@ interface nsIMsgAttachedFile : nsISuppor</span>
<a href="#l3.23"></a><span id="l3.23">    * The encoding of the tmp file. This will be set only if the original</span>
<a href="#l3.24"></a><span id="l3.24">    * document had an encoding already; we don't do base64 encoding and so forth</span>
<a href="#l3.25"></a><span id="l3.25">    * until it's time to assemble a full MIME message of all parts.</span>
<a href="#l3.26"></a><span id="l3.26">    */</span>
<a href="#l3.27"></a><span id="l3.27">   attribute ACString encoding;</span>
<a href="#l3.28"></a><span id="l3.28">   /// For Content-Description header.</span>
<a href="#l3.29"></a><span id="l3.29">   attribute ACString description;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  /// X-Mozilla-Cloud-Part, if any.</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  attribute ACString cloudPartInfo;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34">   attribute ACString xMacType;    // mac-specific info </span>
<a href="#l3.35"></a><span id="l3.35">   attribute ACString xMacCreator; // mac-specific info </span>
<a href="#l3.36"></a><span id="l3.36">   attribute ACString realName;      // The real name of the file. </span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   /**</span>
<a href="#l3.39"></a><span id="l3.39">    * Some statistics about the data that was written to the file, so that when</span>
<a href="#l3.40"></a><span id="l3.40">    * it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l3.41"></a><span id="l3.41">    * about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineat">@@ -198,16 +201,17 @@ public:</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">   nsCString m_description;  // If you put a string here, it will show up as the Content-Description header.  </span>
<a href="#l3.45"></a><span id="l3.45">                             // This can be any explanatory text; it's not a file name.             </span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">   nsCString m_disposition;  // The Content-Disposition header (if any). a</span>
<a href="#l3.48"></a><span id="l3.48">                             // nsMsgAttachmentData can very well have</span>
<a href="#l3.49"></a><span id="l3.49">                             // Content-Disposition: inline value, instead of</span>
<a href="#l3.50"></a><span id="l3.50">                             // &quot;attachment&quot;.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">   // Mac-specific data that should show up as optional parameters</span>
<a href="#l3.54"></a><span id="l3.54">   // to the content-type header.</span>
<a href="#l3.55"></a><span id="l3.55">   nsCString m_xMacType;</span>
<a href="#l3.56"></a><span id="l3.56">   nsCString m_xMacCreator;</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   PRInt32 m_size;                  // The size of the attachment. May be 0.</span>
<a href="#l3.59"></a><span id="l3.59">   bool    m_isExternalAttachment;  // Flag for determining if the attachment is external</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -230,17 +234,18 @@ public:</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62">   nsCString m_type;        // The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">   nsCString m_encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original </span>
<a href="#l3.65"></a><span id="l3.65">                             // document had an encoding already; we don't do base64 encoding and so forth until </span>
<a href="#l3.66"></a><span id="l3.66">                             // it's time to assemble a full MIME message of all parts.</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  nsCString m_description;    // For Content-Description header </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  nsCString m_description;    // For Content-Description header</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l3.72"></a><span id="l3.72">   nsCString m_xMacType;    // mac-specific info </span>
<a href="#l3.73"></a><span id="l3.73">   nsCString m_xMacCreator; // mac-specific info </span>
<a href="#l3.74"></a><span id="l3.74">   nsCString m_realName;      // The real name of the file. </span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">   // Some statistics about the data that was written to the file, so that when</span>
<a href="#l3.77"></a><span id="l3.77">   // it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l3.78"></a><span id="l3.78">   // about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l3.79"></a><span id="l3.79">   // (If it's encoded already, we ignore this information and ship it as-is.)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -39,22 +39,23 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> NS_IMPL_ISUPPORTS1(nsMsgAttachment, nsIMsgAttachment)</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> nsMsgAttachment::nsMsgAttachment()</span>
<a href="#l4.10"></a><span id="l4.10"> {</span>
<a href="#l4.11"></a><span id="l4.11">   mTemporary = false;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  mSendViaCloud = false;</span>
<a href="#l4.13"></a><span id="l4.13">   mSize = -1;</span>
<a href="#l4.14"></a><span id="l4.14"> }</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> nsMsgAttachment::~nsMsgAttachment()</span>
<a href="#l4.17"></a><span id="l4.17"> {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  if (mTemporary)</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  if (mTemporary &amp;&amp; !mSendViaCloud)</span>
<a href="#l4.20"></a><span id="l4.20">     (void)DeleteAttachment();</span>
<a href="#l4.21"></a><span id="l4.21"> }</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> /* attribute wstring name; */</span>
<a href="#l4.24"></a><span id="l4.24"> NS_IMETHODIMP nsMsgAttachment::GetName(nsAString &amp; aName)</span>
<a href="#l4.25"></a><span id="l4.25"> {</span>
<a href="#l4.26"></a><span id="l4.26">   aName = mName;</span>
<a href="#l4.27"></a><span id="l4.27">   return NS_OK;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineat">@@ -100,59 +101,96 @@ NS_IMETHODIMP nsMsgAttachment::GetTempor</span>
<a href="#l4.29"></a><span id="l4.29">   return NS_OK;</span>
<a href="#l4.30"></a><span id="l4.30"> }</span>
<a href="#l4.31"></a><span id="l4.31"> NS_IMETHODIMP nsMsgAttachment::SetTemporary(bool aTemporary)</span>
<a href="#l4.32"></a><span id="l4.32"> {</span>
<a href="#l4.33"></a><span id="l4.33">   mTemporary = aTemporary;</span>
<a href="#l4.34"></a><span id="l4.34">   return NS_OK;</span>
<a href="#l4.35"></a><span id="l4.35"> }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-/* attribute string contentLocation; */</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetContentLocation(char * *aContentLocation)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetSendViaCloud(bool *aSendViaCloud)</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+{</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSendViaCloud);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  *aSendViaCloud = mSendViaCloud;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetSendViaCloud(bool aSendViaCloud)</span>
<a href="#l4.47"></a><span id="l4.47"> {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aContentLocation);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  mSendViaCloud = aSendViaCloud;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+}</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetHtmlAnnotation(const nsAString &amp;aAnnotation)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+{</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  mHtmlAnnotation = aAnnotation;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+}</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  *aContentLocation = ToNewCString(mContentLocation);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  return (*aContentLocation ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetHtmlAnnotation(nsAString &amp;aAnnotation)</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+{</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  aAnnotation = mHtmlAnnotation;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+}</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+nsMsgAttachment::SetCloudProviderKey(const nsACString &amp;aCloudProviderKey)</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+{</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  mCloudProviderKey = aCloudProviderKey;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.72"></a><span id="l4.72"> }</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetContentLocation(const char * aContentLocation)</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+nsMsgAttachment::GetCloudProviderKey(nsACString &amp;aCloudProviderKey)</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+{</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  aCloudProviderKey = mCloudProviderKey;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+}</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetContentLocation(nsACString &amp;aContentLocation)</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+{</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  aContentLocation = mContentLocation;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+}</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetContentLocation(const nsACString &amp;aContentLocation)</span>
<a href="#l4.89"></a><span id="l4.89"> {</span>
<a href="#l4.90"></a><span id="l4.90">   mContentLocation = aContentLocation;</span>
<a href="#l4.91"></a><span id="l4.91">   return NS_OK;</span>
<a href="#l4.92"></a><span id="l4.92"> }</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-/* attribute string contentType; */</span>
<a href="#l4.95"></a><span id="l4.95"> NS_IMETHODIMP nsMsgAttachment::GetContentType(char * *aContentType)</span>
<a href="#l4.96"></a><span id="l4.96"> {</span>
<a href="#l4.97"></a><span id="l4.97">   NS_ENSURE_ARG_POINTER(aContentType);</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">   *aContentType = ToNewCString(mContentType);</span>
<a href="#l4.100"></a><span id="l4.100">   return (*aContentType ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+</span>
<a href="#l4.103"></a><span id="l4.103"> NS_IMETHODIMP nsMsgAttachment::SetContentType(const char * aContentType)</span>
<a href="#l4.104"></a><span id="l4.104"> {</span>
<a href="#l4.105"></a><span id="l4.105">   mContentType = aContentType;</span>
<a href="#l4.106"></a><span id="l4.106">   /* a full content type could also contains parameters but we need to</span>
<a href="#l4.107"></a><span id="l4.107">      keep only the content type alone. Therefore we need to cleanup it.</span>
<a href="#l4.108"></a><span id="l4.108">   */</span>
<a href="#l4.109"></a><span id="l4.109">   PRInt32 offset = mContentType.FindChar(';');</span>
<a href="#l4.110"></a><span id="l4.110">   if (offset &gt;= 0)</span>
<a href="#l4.111"></a><span id="l4.111">     mContentType.SetLength(offset);</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">   return NS_OK;</span>
<a href="#l4.114"></a><span id="l4.114"> }</span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-/* attribute string contentTypeParam; */</span>
<a href="#l4.117"></a><span id="l4.117"> NS_IMETHODIMP nsMsgAttachment::GetContentTypeParam(char * *aContentTypeParam)</span>
<a href="#l4.118"></a><span id="l4.118"> {</span>
<a href="#l4.119"></a><span id="l4.119">   NS_ENSURE_ARG_POINTER(aContentTypeParam);</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121">   *aContentTypeParam = ToNewCString(mContentTypeParam);</span>
<a href="#l4.122"></a><span id="l4.122">   return (*aContentTypeParam ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l4.123"></a><span id="l4.123"> }</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125"> NS_IMETHODIMP nsMsgAttachment::SetContentTypeParam(const char * aContentTypeParam)</span>
<a href="#l4.126"></a><span id="l4.126"> {</span>
<a href="#l4.127"></a><span id="l4.127">   if (aContentTypeParam)</span>
<a href="#l4.128"></a><span id="l4.128">     while (*aContentTypeParam == ';' || *aContentTypeParam == ' ')</span>
<a href="#l4.129"></a><span id="l4.129">       aContentTypeParam ++;</span>
<a href="#l4.130"></a><span id="l4.130">   mContentTypeParam = aContentTypeParam;</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -52,19 +52,22 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> private:</span>
<a href="#l5.6"></a><span id="l5.6">   nsresult DeleteAttachment();</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   nsString    mName;</span>
<a href="#l5.9"></a><span id="l5.9">   nsCString   mUrl;</span>
<a href="#l5.10"></a><span id="l5.10">   nsCString   mUrlCharset;</span>
<a href="#l5.11"></a><span id="l5.11">   bool        mTemporary;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  bool        mSendViaCloud;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  nsCString   mCloudProviderKey;</span>
<a href="#l5.14"></a><span id="l5.14">   nsCString   mContentLocation;</span>
<a href="#l5.15"></a><span id="l5.15">   nsCString   mContentType;</span>
<a href="#l5.16"></a><span id="l5.16">   nsCString   mContentTypeParam;</span>
<a href="#l5.17"></a><span id="l5.17">   nsCString   mCharset;</span>
<a href="#l5.18"></a><span id="l5.18">   nsCString   mMacType;</span>
<a href="#l5.19"></a><span id="l5.19">   nsCString   mMacCreator;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  nsString    mHtmlAnnotation;</span>
<a href="#l5.21"></a><span id="l5.21">   PRInt64     mSize;</span>
<a href="#l5.22"></a><span id="l5.22"> };</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> #endif /* _nsMsgAttachment_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -147,16 +147,17 @@ nsMsgAttachmentHandler::nsMsgAttachmentH</span>
<a href="#l6.4"></a><span id="l6.4">   m_bogus_attachment(false),</span>
<a href="#l6.5"></a><span id="l6.5">   m_done(false),</span>
<a href="#l6.6"></a><span id="l6.6">   m_already_encoded_p(false),</span>
<a href="#l6.7"></a><span id="l6.7">   m_decrypted_p(false),</span>
<a href="#l6.8"></a><span id="l6.8">   mDeleteFile(false),</span>
<a href="#l6.9"></a><span id="l6.9">   mMHTMLPart(false),</span>
<a href="#l6.10"></a><span id="l6.10">   mPartUserOmissionOverride(false),</span>
<a href="#l6.11"></a><span id="l6.11">   mMainBody(false),</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  mSendViaCloud(false),</span>
<a href="#l6.13"></a><span id="l6.13">   mNodeIndex(-1),</span>
<a href="#l6.14"></a><span id="l6.14">   // For analyzing the attachment file...</span>
<a href="#l6.15"></a><span id="l6.15">   m_size(0),</span>
<a href="#l6.16"></a><span id="l6.16">   m_unprintable_count(0),</span>
<a href="#l6.17"></a><span id="l6.17">   m_highbit_count(0),</span>
<a href="#l6.18"></a><span id="l6.18">   m_ctl_count(0),</span>
<a href="#l6.19"></a><span id="l6.19">   m_null_count(0),</span>
<a href="#l6.20"></a><span id="l6.20">   m_have_cr(0), </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -294,16 +295,21 @@ nsMsgAttachmentHandler::AnalyzeSnarfedFi</span>
<a href="#l6.22"></a><span id="l6.22"> int</span>
<a href="#l6.23"></a><span id="l6.23"> nsMsgAttachmentHandler::PickEncoding(const char *charset, nsIMsgSend *mime_delivery_state)</span>
<a href="#l6.24"></a><span id="l6.24"> {</span>
<a href="#l6.25"></a><span id="l6.25">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   bool needsB64 = false;</span>
<a href="#l6.28"></a><span id="l6.28">   bool forceB64 = false;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  if (mSendViaCloud)</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    m_encoding = ENCODING_7BIT;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    return 0;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  }</span>
<a href="#l6.35"></a><span id="l6.35">   if (m_already_encoded_p)</span>
<a href="#l6.36"></a><span id="l6.36">     goto DONE;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   AnalyzeSnarfedFile();</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   /* Allow users to override our percentage-wise guess on whether</span>
<a href="#l6.41"></a><span id="l6.41">   the file is text or binary */</span>
<a href="#l6.42"></a><span id="l6.42">   if (pPrefBranch)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -171,16 +171,21 @@ public:</span>
<a href="#l7.4"></a><span id="l7.4">                                            originally encrypted. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   bool                  mDeleteFile;      // If this is true, Delete the file...its </span>
<a href="#l7.7"></a><span id="l7.7">                                           // NOT the original file!</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   bool                  mMHTMLPart;           // This is true if its an MHTML part, otherwise, false</span>
<a href="#l7.10"></a><span id="l7.10">   bool                  mPartUserOmissionOverride;  // This is true if the user send send the email without this part</span>
<a href="#l7.11"></a><span id="l7.11">   bool                  mMainBody;            // True if this is a main body.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+   // true if this should be sent as a link to a file.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  bool                  mSendViaCloud;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  nsString              mHtmlAnnotation;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  nsCString             mCloudProviderKey;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  nsCString             mCloudUrl;</span>
<a href="#l7.17"></a><span id="l7.17">   PRInt32 mNodeIndex; //If this is an embedded image, this is the index of the</span>
<a href="#l7.18"></a><span id="l7.18">                       // corresponding domNode in the editor's</span>
<a href="#l7.19"></a><span id="l7.19">                       //GetEmbeddedObjects. Otherwise, it will be -1.</span>
<a href="#l7.20"></a><span id="l7.20">   //</span>
<a href="#l7.21"></a><span id="l7.21">   // Vars for analyzing file data...</span>
<a href="#l7.22"></a><span id="l7.22">   //</span>
<a href="#l7.23"></a><span id="l7.23">   PRUint32              m_size;         /* Some state used while filtering it */</span>
<a href="#l7.24"></a><span id="l7.24">   PRUint32              m_unprintable_count;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -542,16 +542,57 @@ nsMsgCompose::GetInsertingQuotedContent(</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> NS_IMETHODIMP</span>
<a href="#l8.6"></a><span id="l8.6"> nsMsgCompose::SetInsertingQuotedContent(bool aInsertingQuotedText)</span>
<a href="#l8.7"></a><span id="l8.7"> {</span>
<a href="#l8.8"></a><span id="l8.8">   mInsertingQuotedContent = aInsertingQuotedText;</span>
<a href="#l8.9"></a><span id="l8.9">   return NS_OK;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+void</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+nsMsgCompose::InsertDivWrappedTextAtSelection(const nsAString &amp;aText,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                                              const nsAString &amp;classStr)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+{</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  NS_ASSERTION(m_editor, &quot;InsertDivWrappedTextAtSelection called, but no editor exists\n&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  if (!m_editor)</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    return;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  nsCOMPtr&lt;nsIDOMElement&gt; divElem;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor(do_QueryInterface(m_editor));</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor(do_QueryInterface(m_editor));</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  nsresult rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;div&quot;),</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+                                                      getter_AddRefs(divElem));</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  nsCOMPtr&lt;nsIDOMNode&gt; divNode (do_QueryInterface(divElem));</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  divNode-&gt;SetTextContent(aText);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  textEditor-&gt;InsertLineBreak();</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  htmlEditor-&gt;InsertElementAtSelection(divElem, true);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  nsCOMPtr&lt;nsIDOMNode&gt; parent;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  PRInt32 offset;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  rv = GetNodeLocation(divNode, address_of(parent), &amp;offset);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    nsCOMPtr&lt;nsISelection&gt; selection;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    if (selection)</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+    {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+      textEditor-&gt;InsertLineBreak();</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    }</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  if (divElem)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    divElem-&gt;SetAttribute(NS_LITERAL_STRING(&quot;class&quot;), classStr);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+}</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53"> NS_IMETHODIMP</span>
<a href="#l8.54"></a><span id="l8.54"> nsMsgCompose::ConvertAndLoadComposeWindow(nsString&amp; aPrefix,</span>
<a href="#l8.55"></a><span id="l8.55">                                           nsString&amp; aBuf,</span>
<a href="#l8.56"></a><span id="l8.56">                                           nsString&amp; aSignature,</span>
<a href="#l8.57"></a><span id="l8.57">                                           bool aQuoted,</span>
<a href="#l8.58"></a><span id="l8.58">                                           bool aHTMLEditor)</span>
<a href="#l8.59"></a><span id="l8.59"> {</span>
<a href="#l8.60"></a><span id="l8.60">   NS_ASSERTION(m_editor, &quot;ConvertAndLoadComposeWindow but no editor\n&quot;);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineat">@@ -595,18 +636,42 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l8.62"></a><span id="l8.62">   bool sigOnTop = (reply_on_top == 1 &amp;&amp; !sig_bottom);</span>
<a href="#l8.63"></a><span id="l8.63">   if (aQuoted)</span>
<a href="#l8.64"></a><span id="l8.64">   {</span>
<a href="#l8.65"></a><span id="l8.65">     mInsertingQuotedContent = true;</span>
<a href="#l8.66"></a><span id="l8.66">     if (!aPrefix.IsEmpty())</span>
<a href="#l8.67"></a><span id="l8.67">     {</span>
<a href="#l8.68"></a><span id="l8.68">       if (!aHTMLEditor)</span>
<a href="#l8.69"></a><span id="l8.69">         aPrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-      textEditor-&gt;InsertText(aPrefix);</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-      m_editor-&gt;EndOfDocument();</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+      PRInt32 reply_on_top = 0;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+      m_identity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+      if (reply_on_top == 1)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        // add one newline if a signature comes before the quote, two otherwise</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+        bool includeSignature = true;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+        bool sig_bottom = true;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+        bool attachFile = false;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+        nsString prefSigText;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        m_identity-&gt;GetSigOnReply(&amp;includeSignature);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+        m_identity-&gt;GetSigBottom(&amp;sig_bottom);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        m_identity-&gt;GetHtmlSigText(prefSigText);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+        nsresult rv = m_identity-&gt;GetAttachSignature(&amp;attachFile);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        if (includeSignature &amp;&amp; !sig_bottom &amp;&amp;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+            ((NS_SUCCEEDED(rv) &amp;&amp; attachFile) || !prefSigText.IsEmpty()))</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+          textEditor-&gt;InsertLineBreak();</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+        else {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+          textEditor-&gt;InsertLineBreak();</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+          textEditor-&gt;InsertLineBreak();</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+        }</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      }</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+      InsertDivWrappedTextAtSelection(aPrefix,</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+                                      NS_LITERAL_STRING(&quot;moz-cite-prefix&quot;));</span>
<a href="#l8.98"></a><span id="l8.98">     }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100">     if (!aBuf.IsEmpty() &amp;&amp; mailEditor)</span>
<a href="#l8.101"></a><span id="l8.101">     {</span>
<a href="#l8.102"></a><span id="l8.102">       // This leaves the caret at the right place to insert a bottom signature.</span>
<a href="#l8.103"></a><span id="l8.103">       if (aHTMLEditor &amp;&amp; !mCiteReference.IsEmpty())</span>
<a href="#l8.104"></a><span id="l8.104">         mailEditor-&gt;InsertAsCitedQuotation(aBuf,</span>
<a href="#l8.105"></a><span id="l8.105">                                            mCiteReference,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineat">@@ -625,18 +690,19 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l8.107"></a><span id="l8.107">     if (!aSignature.IsEmpty())</span>
<a href="#l8.108"></a><span id="l8.108">     {</span>
<a href="#l8.109"></a><span id="l8.109">       //we cannot add it on top earlier, because TagEmbeddedObjects will mark all images in the signature as &quot;moz-do-not-send&quot;</span>
<a href="#l8.110"></a><span id="l8.110">       if( sigOnTop )</span>
<a href="#l8.111"></a><span id="l8.111">         m_editor-&gt;BeginningOfDocument();</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113">       if (aHTMLEditor &amp;&amp; htmlEditor)</span>
<a href="#l8.114"></a><span id="l8.114">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-      else if (textEditor)</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-        textEditor-&gt;InsertText(aSignature);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      else if (htmlEditor)</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121">       if( sigOnTop )</span>
<a href="#l8.122"></a><span id="l8.122">         m_editor-&gt;EndOfDocument();</span>
<a href="#l8.123"></a><span id="l8.123">     }</span>
<a href="#l8.124"></a><span id="l8.124">   }</span>
<a href="#l8.125"></a><span id="l8.125">   else</span>
<a href="#l8.126"></a><span id="l8.126">   {</span>
<a href="#l8.127"></a><span id="l8.127">     if (aHTMLEditor &amp;&amp; htmlEditor)</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineat">@@ -659,35 +725,37 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l8.129"></a><span id="l8.129">           m_editor-&gt;EndOfDocument();</span>
<a href="#l8.130"></a><span id="l8.130">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l8.131"></a><span id="l8.131">         if (sigOnTop)</span>
<a href="#l8.132"></a><span id="l8.132">           m_editor-&gt;EndOfDocument();</span>
<a href="#l8.133"></a><span id="l8.133">       }</span>
<a href="#l8.134"></a><span id="l8.134">       else</span>
<a href="#l8.135"></a><span id="l8.135">         m_editor-&gt;EndOfDocument();</span>
<a href="#l8.136"></a><span id="l8.136">     }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-    else if (textEditor)</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    else if (htmlEditor)</span>
<a href="#l8.139"></a><span id="l8.139">     {</span>
<a href="#l8.140"></a><span id="l8.140">       if (sigOnTop &amp;&amp; !aSignature.IsEmpty())</span>
<a href="#l8.141"></a><span id="l8.141">       {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-        textEditor-&gt;InsertText(aSignature);</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l8.145"></a><span id="l8.145">         m_editor-&gt;EndOfDocument();</span>
<a href="#l8.146"></a><span id="l8.146">       }</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148">       if (!aBuf.IsEmpty())</span>
<a href="#l8.149"></a><span id="l8.149">       {</span>
<a href="#l8.150"></a><span id="l8.150">         if (mailEditor)</span>
<a href="#l8.151"></a><span id="l8.151">           mailEditor-&gt;InsertTextWithQuotations(aBuf);</span>
<a href="#l8.152"></a><span id="l8.152">         else</span>
<a href="#l8.153"></a><span id="l8.153">           textEditor-&gt;InsertText(aBuf);</span>
<a href="#l8.154"></a><span id="l8.154">         m_editor-&gt;EndOfDocument();</span>
<a href="#l8.155"></a><span id="l8.155">       }</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157">       if (!sigOnTop &amp;&amp; !aSignature.IsEmpty())</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-        textEditor-&gt;InsertText(aSignature);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l8.161"></a><span id="l8.161">     }</span>
<a href="#l8.162"></a><span id="l8.162">   }</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">   if (aBuf.IsEmpty())</span>
<a href="#l8.165"></a><span id="l8.165">     m_editor-&gt;BeginningOfDocument();</span>
<a href="#l8.166"></a><span id="l8.166">   else</span>
<a href="#l8.167"></a><span id="l8.167">   {</span>
<a href="#l8.168"></a><span id="l8.168">     switch (reply_on_top)</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineat">@@ -2260,38 +2328,16 @@ QuotingOutputStreamListener::QuotingOutp</span>
<a href="#l8.170"></a><span id="l8.170">           mCiteReference.AssignLiteral(&quot;mid:&quot;);</span>
<a href="#l8.171"></a><span id="l8.171">           MsgEscapeURL(myGetter,</span>
<a href="#l8.172"></a><span id="l8.172">                        nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l8.173"></a><span id="l8.173">                        buf);</span>
<a href="#l8.174"></a><span id="l8.174">           mCiteReference.Append(NS_ConvertASCIItoUTF16(buf));</span>
<a href="#l8.175"></a><span id="l8.175">         }</span>
<a href="#l8.176"></a><span id="l8.176">       }</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-      PRInt32 reply_on_top = 0;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-      mIdentity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-      if (reply_on_top == 1)</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-      {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-        // add one newline if a signature comes before the quote, two otherwise</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-        bool includeSignature = true;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-        bool sig_bottom = true;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-        bool attachFile = false;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-        nsString prefSigText;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-        mIdentity-&gt;GetSigOnReply(&amp;includeSignature);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-        mIdentity-&gt;GetSigBottom(&amp;sig_bottom);</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-        mIdentity-&gt;GetHtmlSigText(prefSigText);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-        rv = mIdentity-&gt;GetAttachSignature(&amp;attachFile);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-        if (includeSignature &amp;&amp; !sig_bottom &amp;&amp;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-            ((NS_SUCCEEDED(rv) &amp;&amp; attachFile) || !prefSigText.IsEmpty()))</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-          mCitePrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-        else</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-          mCitePrefix.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-      }</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-</span>
<a href="#l8.200"></a><span id="l8.200">       bool header, headerDate;</span>
<a href="#l8.201"></a><span id="l8.201">       PRInt32 replyHeaderType;</span>
<a href="#l8.202"></a><span id="l8.202">       nsAutoString replyHeaderLocale;</span>
<a href="#l8.203"></a><span id="l8.203">       nsString replyHeaderAuthorwrote;</span>
<a href="#l8.204"></a><span id="l8.204">       nsString replyHeaderOndate;</span>
<a href="#l8.205"></a><span id="l8.205">       nsAutoString replyHeaderSeparator;</span>
<a href="#l8.206"></a><span id="l8.206">       nsAutoString replyHeaderColon;</span>
<a href="#l8.207"></a><span id="l8.207"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -47,16 +47,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIMsgQuote.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIBaseWindow.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIUnicodeDecoder.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsIDOMNode.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> // Forward declares</span>
<a href="#l9.15"></a><span id="l9.15"> class QuotingOutputStreamListener;</span>
<a href="#l9.16"></a><span id="l9.16"> class nsMsgComposeSendListener;</span>
<a href="#l9.17"></a><span id="l9.17"> class nsIEditorMailSupport;</span>
<a href="#l9.18"></a><span id="l9.18"> class nsIRDFService;</span>
<a href="#l9.19"></a><span id="l9.19"> class nsIArray;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -98,16 +99,18 @@ private:</span>
<a href="#l9.22"></a><span id="l9.22">   nsresult                      LoadDataFromFile(nsILocalFile *file,</span>
<a href="#l9.23"></a><span id="l9.23">                                                  nsString &amp;sigData,</span>
<a href="#l9.24"></a><span id="l9.24">                                                  bool aAllowUTF8 = true,</span>
<a href="#l9.25"></a><span id="l9.25">                                                  bool aAllowUTF16 = true);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   bool                          CheckIncludeSignaturePrefs(nsIMsgIdentity *identity);</span>
<a href="#l9.28"></a><span id="l9.28">   //m_folderName to store the value of the saved drafts folder.</span>
<a href="#l9.29"></a><span id="l9.29">   nsCString                     m_folderName;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  void InsertDivWrappedTextAtSelection(const nsAString &amp;aText,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+                                       const nsAString &amp;classStr);</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">  private:</span>
<a href="#l9.34"></a><span id="l9.34">   nsresult _SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity, const char *accountKey, bool entityConversionDone);</span>
<a href="#l9.35"></a><span id="l9.35">   nsresult CreateMessage(const char * originalMsgURI, MSG_ComposeType type, nsIMsgCompFields* compFields);</span>
<a href="#l9.36"></a><span id="l9.36">   void CleanUpRecipients(nsString&amp; recipients);</span>
<a href="#l9.37"></a><span id="l9.37">   nsresult GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l9.38"></a><span id="l9.38">                             nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray);</span>
<a href="#l9.39"></a><span id="l9.39">   nsresult BuildMailListArray(nsIAbDirectory* parentDir,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1115,16 +1115,19 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l10.4"></a><span id="l10.4">     m_partNumbers[ma-&gt;mNodeIndex] = part-&gt;m_partNum;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   if (NS_FAILED(status))</span>
<a href="#l10.7"></a><span id="l10.7">     return 0;</span>
<a href="#l10.8"></a><span id="l10.8">   status = part-&gt;SetType(ma-&gt;m_type.get());</span>
<a href="#l10.9"></a><span id="l10.9">   if (NS_FAILED(status))</span>
<a href="#l10.10"></a><span id="l10.10">     return 0;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  if (ma-&gt;mSendViaCloud)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    ma-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+</span>
<a href="#l10.15"></a><span id="l10.15">   nsCString turl;</span>
<a href="#l10.16"></a><span id="l10.16">   if (!ma-&gt;mURL)</span>
<a href="#l10.17"></a><span id="l10.17">   {</span>
<a href="#l10.18"></a><span id="l10.18">     if (!ma-&gt;m_uri.IsEmpty())</span>
<a href="#l10.19"></a><span id="l10.19">       turl = ma-&gt;m_uri;</span>
<a href="#l10.20"></a><span id="l10.20">   }</span>
<a href="#l10.21"></a><span id="l10.21">   else</span>
<a href="#l10.22"></a><span id="l10.22">     ma-&gt;mURL-&gt;GetSpec(turl);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -1148,16 +1151,39 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l10.24"></a><span id="l10.24">                                                           // for attachments</span>
<a href="#l10.25"></a><span id="l10.25">                                            ma-&gt;m_contentId.get(),</span>
<a href="#l10.26"></a><span id="l10.26">                                            false);</span>
<a href="#l10.27"></a><span id="l10.27">   if (!hdrs)</span>
<a href="#l10.28"></a><span id="l10.28">     return 0;</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30">   status = part-&gt;SetOtherHeaders(hdrs);</span>
<a href="#l10.31"></a><span id="l10.31">   PR_FREEIF(hdrs);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  if (ma-&gt;mSendViaCloud)</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+  {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    // here is where we'd insert the annotated html</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+    part-&gt;SetBuffer(ma-&gt;mCloudUrl.get());</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+    if (m_deliver_mode == nsMsgSaveAsDraft)</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+      nsCString urlSpec;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+      ma-&gt;mURL-&gt;GetSpec(urlSpec);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+      // Need to add some headers so that libmime can restore the cloud info</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+      // when loading a draft message.</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+      nsCString draftInfo(HEADER_X_MOZILLA_CLOUD_PART&quot;: cloudFile; url=&quot;);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+      draftInfo.Append(ma-&gt;mCloudUrl.get());</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+      draftInfo.Append(&quot;; provider=&quot;);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+      draftInfo.Append(ma-&gt;mCloudProviderKey.get());</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+      draftInfo.Append(&quot;; file=&quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      draftInfo.Append(urlSpec.get());</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+      draftInfo.Append(&quot;; name=&quot;);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+      draftInfo.Append(ma-&gt;m_realName.get());</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+      draftInfo.Append(CRLF);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+      part-&gt;AppendOtherHeaders(draftInfo.get());</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    }</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    part-&gt;SetType(&quot;text/html&quot;);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  }</span>
<a href="#l10.55"></a><span id="l10.55">   if (NS_FAILED(status))</span>
<a href="#l10.56"></a><span id="l10.56">     return 0;</span>
<a href="#l10.57"></a><span id="l10.57">   status = part-&gt;SetFile(ma-&gt;mTmpFile);</span>
<a href="#l10.58"></a><span id="l10.58">   if (NS_FAILED(status))</span>
<a href="#l10.59"></a><span id="l10.59">     return 0;</span>
<a href="#l10.60"></a><span id="l10.60">   if (ma-&gt;m_encoder_data)</span>
<a href="#l10.61"></a><span id="l10.61">   {</span>
<a href="#l10.62"></a><span id="l10.62">     status = part-&gt;SetEncoderData(ma-&gt;m_encoder_data);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineat">@@ -2061,24 +2087,24 @@ nsMsgComposeAndSend::CountCompFieldAttac</span>
<a href="#l10.64"></a><span id="l10.64">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l10.65"></a><span id="l10.65">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l10.68"></a><span id="l10.68">     if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l10.69"></a><span id="l10.69">     {</span>
<a href="#l10.70"></a><span id="l10.70">       attachment-&gt;GetUrl(url);</span>
<a href="#l10.71"></a><span id="l10.71">       if (!url.IsEmpty())</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-      // Check to see if this is a file URL, if so, don't retrieve</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-      // like a remote URL...</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+        // Check to see if this is a file URL, if so, don't retrieve</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+        // like a remote URL...</span>
<a href="#l10.78"></a><span id="l10.78">         if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l10.79"></a><span id="l10.79">           mCompFieldLocalAttachments++;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-      else    // This is a remote URL...</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-        mCompFieldRemoteAttachments++;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    }</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+        else    // This is a remote URL...</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+          mCompFieldRemoteAttachments++;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+      }</span>
<a href="#l10.86"></a><span id="l10.86">     }</span>
<a href="#l10.87"></a><span id="l10.87">   }</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89">   return NS_OK;</span>
<a href="#l10.90"></a><span id="l10.90"> }</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92"> //</span>
<a href="#l10.93"></a><span id="l10.93"> // Since we are at the head of the list, we start from ZERO.</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineat">@@ -2105,19 +2131,35 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l10.95"></a><span id="l10.95">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l10.96"></a><span id="l10.96">   while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l10.97"></a><span id="l10.97">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l10.98"></a><span id="l10.98">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.99"></a><span id="l10.99"> </span>
<a href="#l10.100"></a><span id="l10.100">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l10.101"></a><span id="l10.101">     if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l10.102"></a><span id="l10.102">     {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+      bool sendViaCloud = false;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+      attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      m_attachments[newLoc].mSendViaCloud = sendViaCloud;</span>
<a href="#l10.106"></a><span id="l10.106">       attachment-&gt;GetUrl(url);</span>
<a href="#l10.107"></a><span id="l10.107">       if (!url.IsEmpty())</span>
<a href="#l10.108"></a><span id="l10.108">       {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+        bool sendViaCloud;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+        attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+        if (sendViaCloud)</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+        {</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+          nsCString cloudProviderKey;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+          // We'd like to output a part for the attachment, just an html part</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+          // with information about how to download the attachment.</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+          // m_attachments[newLoc].m_done = true;</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+          attachment-&gt;GetHtmlAnnotation(m_attachments[newLoc].mHtmlAnnotation);</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+          m_attachments[newLoc].m_type = &quot;text/html&quot;;</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+          attachment-&gt;GetCloudProviderKey(m_attachments[newLoc].mCloudProviderKey);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+          attachment-&gt;GetContentLocation(m_attachments[newLoc].mCloudUrl);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+        }</span>
<a href="#l10.122"></a><span id="l10.122">         // Just look for local file:// attachments and do the right thing.</span>
<a href="#l10.123"></a><span id="l10.123">         if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l10.124"></a><span id="l10.124">         {</span>
<a href="#l10.125"></a><span id="l10.125">           //</span>
<a href="#l10.126"></a><span id="l10.126">           // Now we have to setup the m_attachments entry for the file://</span>
<a href="#l10.127"></a><span id="l10.127">           // URL that is passed in...</span>
<a href="#l10.128"></a><span id="l10.128">           //</span>
<a href="#l10.129"></a><span id="l10.129">           m_attachments[newLoc].mDeleteFile = false;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineat">@@ -2155,16 +2197,19 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132">   #ifdef MAC_OSX</span>
<a href="#l10.133"></a><span id="l10.133">           //Mac always need to snarf the file to figure out how to send it, maybe we need to use apple double...</span>
<a href="#l10.134"></a><span id="l10.134">           //  unless caller has already set the content type, in which case, trust them.</span>
<a href="#l10.135"></a><span id="l10.135">           bool mustSnarfAttachment = true;</span>
<a href="#l10.136"></a><span id="l10.136">   #else</span>
<a href="#l10.137"></a><span id="l10.137">           bool mustSnarfAttachment = false;</span>
<a href="#l10.138"></a><span id="l10.138">   #endif</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+          if (sendViaCloud)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+            mustSnarfAttachment = false;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142">           attachment-&gt;GetContentType(getter_Copies(m_attachments[newLoc].m_type));</span>
<a href="#l10.143"></a><span id="l10.143">           if (m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l10.144"></a><span id="l10.144">           {</span>
<a href="#l10.145"></a><span id="l10.145">             nsresult  rv = NS_OK;</span>
<a href="#l10.146"></a><span id="l10.146">             nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.147"></a><span id="l10.147">             if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l10.148"></a><span id="l10.148">             {</span>
<a href="#l10.149"></a><span id="l10.149">               nsCOMPtr&lt;nsIURL&gt; fileUrl(do_CreateInstance(NS_STANDARDURL_CONTRACTID));</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineat">@@ -2273,17 +2318,17 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l10.151"></a><span id="l10.151">   bool moreAttachments;</span>
<a href="#l10.152"></a><span id="l10.152">   nsCString url;</span>
<a href="#l10.153"></a><span id="l10.153">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l10.154"></a><span id="l10.154">   while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l10.155"></a><span id="l10.155">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l10.156"></a><span id="l10.156">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.157"></a><span id="l10.157"> </span>
<a href="#l10.158"></a><span id="l10.158">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+     if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l10.161"></a><span id="l10.161">     {</span>
<a href="#l10.162"></a><span id="l10.162">       attachment-&gt;GetUrl(url);</span>
<a href="#l10.163"></a><span id="l10.163">       if (!url.IsEmpty())</span>
<a href="#l10.164"></a><span id="l10.164">       {</span>
<a href="#l10.165"></a><span id="l10.165">         // Just look for files that are NOT local file attachments and do</span>
<a href="#l10.166"></a><span id="l10.166">         // the right thing.</span>
<a href="#l10.167"></a><span id="l10.167">         if (! nsMsgIsLocalFile(url.get()))</span>
<a href="#l10.168"></a><span id="l10.168">         {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineat">@@ -2314,17 +2359,17 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l10.170"></a><span id="l10.170">             else</span>
<a href="#l10.171"></a><span id="l10.171">               (*aMailboxCount)++;</span>
<a href="#l10.172"></a><span id="l10.172"> </span>
<a href="#l10.173"></a><span id="l10.173">             m_attachments[newLoc].m_uri = url;</span>
<a href="#l10.174"></a><span id="l10.174">             m_attachments[newLoc].mURL = nsnull;</span>
<a href="#l10.175"></a><span id="l10.175">           }</span>
<a href="#l10.176"></a><span id="l10.176">           else</span>
<a href="#l10.177"></a><span id="l10.177">             do_add_attachment = (nsnull != m_attachments[newLoc].mURL);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+          m_attachments[newLoc].mSendViaCloud = false;</span>
<a href="#l10.180"></a><span id="l10.180">           if (do_add_attachment)</span>
<a href="#l10.181"></a><span id="l10.181">           {</span>
<a href="#l10.182"></a><span id="l10.182">             nsAutoString proposedName;</span>
<a href="#l10.183"></a><span id="l10.183">             attachment-&gt;GetName(proposedName);</span>
<a href="#l10.184"></a><span id="l10.184">             msg_pick_real_name(&amp;m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l10.185"></a><span id="l10.185">             ++newLoc;</span>
<a href="#l10.186"></a><span id="l10.186">           }</span>
<a href="#l10.187"></a><span id="l10.187">         }</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineat">@@ -2548,17 +2593,17 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l10.189"></a><span id="l10.189"> </span>
<a href="#l10.190"></a><span id="l10.190">     m_attachment_pending_count = m_attachment_count;</span>
<a href="#l10.191"></a><span id="l10.191"> </span>
<a href="#l10.192"></a><span id="l10.192">     // Start the URL attachments loading (eventually, an exit routine will</span>
<a href="#l10.193"></a><span id="l10.193">     // call the done_callback).</span>
<a href="#l10.194"></a><span id="l10.194"> </span>
<a href="#l10.195"></a><span id="l10.195">     for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l10.196"></a><span id="l10.196">     {</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-      if (m_attachments[i].m_done)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      if (m_attachments[i].m_done || m_attachments[i].mSendViaCloud)</span>
<a href="#l10.199"></a><span id="l10.199">       {</span>
<a href="#l10.200"></a><span id="l10.200">         m_attachment_pending_count--;</span>
<a href="#l10.201"></a><span id="l10.201">         continue;</span>
<a href="#l10.202"></a><span id="l10.202">       }</span>
<a href="#l10.203"></a><span id="l10.203"> </span>
<a href="#l10.204"></a><span id="l10.204">       //</span>
<a href="#l10.205"></a><span id="l10.205">       //  IF we get here and the URL is NULL, just dec the pending count and move on!!!</span>
<a href="#l10.206"></a><span id="l10.206">       //</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineat">@@ -5191,16 +5236,28 @@ NS_IMETHODIMP nsMsgAttachedFile::GetDesc</span>
<a href="#l10.208"></a><span id="l10.208"> }</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210"> NS_IMETHODIMP nsMsgAttachedFile::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l10.211"></a><span id="l10.211"> {</span>
<a href="#l10.212"></a><span id="l10.212">   m_description = aDescription;</span>
<a href="#l10.213"></a><span id="l10.213">   return NS_OK;</span>
<a href="#l10.214"></a><span id="l10.214"> }</span>
<a href="#l10.215"></a><span id="l10.215"> </span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetCloudPartInfo(nsACString &amp;aCloudPartInfo)</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+{</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+  aCloudPartInfo = m_cloudPartInfo;</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+}</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetCloudPartInfo(const nsACString &amp;aCloudPartInfo)</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+{</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+  m_cloudPartInfo = aCloudPartInfo;</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+}</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+</span>
<a href="#l10.228"></a><span id="l10.228"> NS_IMETHODIMP nsMsgAttachedFile::GetXMacType(nsACString &amp; aXMacType)</span>
<a href="#l10.229"></a><span id="l10.229"> {</span>
<a href="#l10.230"></a><span id="l10.230">   aXMacType = m_xMacType;</span>
<a href="#l10.231"></a><span id="l10.231">   return NS_OK;</span>
<a href="#l10.232"></a><span id="l10.232"> }</span>
<a href="#l10.233"></a><span id="l10.233"> </span>
<a href="#l10.234"></a><span id="l10.234"> NS_IMETHODIMP nsMsgAttachedFile::SetXMacType(const nsACString &amp; aXMacType)</span>
<a href="#l10.235"></a><span id="l10.235"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -109,12 +109,13 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #define HEADER_PARM_BOUNDARY                &quot;BOUNDARY&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #define HEADER_PARM_FILENAME                &quot;FILENAME&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #define HEADER_PARM_NAME                    &quot;NAME&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #define HEADER_PARM_TYPE                    &quot;TYPE&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> #define HEADER_X_MOZILLA_PART_URL           &quot;X-Mozilla-PartURL&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #define HEADER_X_MOZILLA_PART_SIZE          &quot;X-Mozilla-PartSize&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #define HEADER_X_MOZILLA_PART_DOWNLOADED    &quot;X-Mozilla-PartDownloaded&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#define HEADER_X_MOZILLA_CLOUD_PART          &quot;X-Mozilla-Cloud-Part&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #define HEADER_X_MOZILLA_IDENTITY_KEY       &quot;X-Identity-Key&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #define HEADER_X_MOZILLA_ACCOUNT_KEY       &quot;X-Account-Key&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #define HEADER_X_MOZILLA_KEYWORDS          &quot;X-Mozilla-Keys&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #endif /* nsMailHeaders_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -223,16 +223,30 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l12.4"></a><span id="l12.4">             CopyASCIItoUTF16(curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l12.5"></a><span id="l12.5">           attachment-&gt;SetName(nameStr);</span>
<a href="#l12.6"></a><span id="l12.6">           attachment-&gt;SetUrl(spec);</span>
<a href="#l12.7"></a><span id="l12.7">           attachment-&gt;SetTemporary(true);</span>
<a href="#l12.8"></a><span id="l12.8">           attachment-&gt;SetContentType(curAttachment-&gt;m_realType.get());</span>
<a href="#l12.9"></a><span id="l12.9">           attachment-&gt;SetMacType(curAttachment-&gt;m_xMacType.get());</span>
<a href="#l12.10"></a><span id="l12.10">           attachment-&gt;SetMacCreator(curAttachment-&gt;m_xMacCreator.get());</span>
<a href="#l12.11"></a><span id="l12.11">           attachment-&gt;SetSize(curAttachment-&gt;m_size);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+          if (!curAttachment-&gt;m_cloudPartInfo.IsEmpty())</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+          {</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+            nsCString provider;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+            nsCString cloudUrl;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+            attachment-&gt;SetSendViaCloud(true);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+            provider.Adopt(</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+              MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+                                        &quot;provider&quot;, nsnull, nsnull));</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+            cloudUrl.Adopt(</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+              MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+                                        &quot;url&quot;, nsnull, nsnull));</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+            attachment-&gt;SetCloudProviderKey(provider);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+            attachment-&gt;SetContentLocation(cloudUrl);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+          }</span>
<a href="#l12.26"></a><span id="l12.26">           compFields-&gt;AddAttachment(attachment);</span>
<a href="#l12.27"></a><span id="l12.27">         }</span>
<a href="#l12.28"></a><span id="l12.28">       }</span>
<a href="#l12.29"></a><span id="l12.29">       curAttachment++;</span>
<a href="#l12.30"></a><span id="l12.30">     }</span>
<a href="#l12.31"></a><span id="l12.31">   }</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33">   MSG_ComposeFormat format = composeFormat; // Format to actually use.</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineat">@@ -558,16 +572,17 @@ mime_draft_process_attachments(mime_draf</span>
<a href="#l12.35"></a><span id="l12.35">         }</span>
<a href="#l12.36"></a><span id="l12.36">       }</span>
<a href="#l12.37"></a><span id="l12.37">     }</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39">     tmp-&gt;m_desiredType = tmpFile-&gt;m_type;</span>
<a href="#l12.40"></a><span id="l12.40">     tmp-&gt;m_realType = tmpFile-&gt;m_type;</span>
<a href="#l12.41"></a><span id="l12.41">     tmp-&gt;m_realEncoding = tmpFile-&gt;m_encoding;</span>
<a href="#l12.42"></a><span id="l12.42">     tmp-&gt;m_description = tmpFile-&gt;m_description;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    tmp-&gt;m_cloudPartInfo = tmpFile-&gt;m_cloudPartInfo;</span>
<a href="#l12.44"></a><span id="l12.44">     tmp-&gt;m_xMacType = tmpFile-&gt;m_xMacType;</span>
<a href="#l12.45"></a><span id="l12.45">     tmp-&gt;m_xMacCreator = tmpFile-&gt;m_xMacCreator;</span>
<a href="#l12.46"></a><span id="l12.46">     tmp-&gt;m_size = tmpFile-&gt;m_size;</span>
<a href="#l12.47"></a><span id="l12.47">   }</span>
<a href="#l12.48"></a><span id="l12.48">   return attachData;</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50"> FAIL:</span>
<a href="#l12.51"></a><span id="l12.51">   delete [] attachData;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineat">@@ -1806,27 +1821,46 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l12.53"></a><span id="l12.53">     newAttachment-&gt;m_xMacType.Adopt(</span>
<a href="#l12.54"></a><span id="l12.54">       MimeHeaders_get_parameter(parm_value, &quot;x-mac-type&quot;, NULL, NULL));</span>
<a href="#l12.55"></a><span id="l12.55">     newAttachment-&gt;m_xMacCreator.Adopt(</span>
<a href="#l12.56"></a><span id="l12.56">       MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL));</span>
<a href="#l12.57"></a><span id="l12.57">     PR_FREEIF(parm_value);</span>
<a href="#l12.58"></a><span id="l12.58">     PR_FREEIF(boundary);</span>
<a href="#l12.59"></a><span id="l12.59">     PR_FREEIF(tmp_value);</span>
<a href="#l12.60"></a><span id="l12.60">   }</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+</span>
<a href="#l12.62"></a><span id="l12.62">   newAttachment-&gt;m_size = 0;</span>
<a href="#l12.63"></a><span id="l12.63">   newAttachment-&gt;m_encoding.Adopt(MimeHeaders_get (headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-                                                   false, false ));</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+                                                   false, false));</span>
<a href="#l12.66"></a><span id="l12.66">   newAttachment-&gt;m_description.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l12.67"></a><span id="l12.67">                                                      false, false ));</span>
<a href="#l12.68"></a><span id="l12.68">   //</span>
<a href="#l12.69"></a><span id="l12.69">   // If we came up empty for description or the orig URL, we should do something about it.</span>
<a href="#l12.70"></a><span id="l12.70">   //</span>
<a href="#l12.71"></a><span id="l12.71">   if (newAttachment-&gt;m_description.IsEmpty() &amp;&amp; workURLSpec)</span>
<a href="#l12.72"></a><span id="l12.72">     newAttachment-&gt;m_description = workURLSpec;</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  newAttachment-&gt;m_cloudPartInfo.Adopt(MimeHeaders_get(headers,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+                                       HEADER_X_MOZILLA_CLOUD_PART,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+                                       false, false));</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  // There's no file in the message if it's a cloud part.</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  if (!newAttachment-&gt;m_cloudPartInfo.IsEmpty())</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    nsCAutoString fileURL;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    fileURL.Adopt(</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+      MimeHeaders_get_parameter(newAttachment-&gt;m_cloudPartInfo.get(), &quot;file&quot;,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+                                nsnull, nsnull));</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+    if (!fileURL.IsEmpty())</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+      nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl), fileURL.get(),</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+                   nsnull);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    mdd-&gt;tmpFile = nsnull;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+    return 0;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  }</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+</span>
<a href="#l12.92"></a><span id="l12.92">   nsCOMPtr &lt;nsIFile&gt; tmpFile = nsnull;</span>
<a href="#l12.93"></a><span id="l12.93">   {</span>
<a href="#l12.94"></a><span id="l12.94">     // Let's build a temp file with an extension based on the content-type: nsmail.&lt;extension&gt;</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">     nsCAutoString  newAttachName (&quot;nsmail&quot;);</span>
<a href="#l12.97"></a><span id="l12.97">     bool extensionAdded = false;</span>
<a href="#l12.98"></a><span id="l12.98">     // the content type may contain a charset. i.e. text/html; ISO-2022-JP...we want to strip off the charset</span>
<a href="#l12.99"></a><span id="l12.99">     // before we ask the mime service for a mime info for this content type.</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineat">@@ -1955,27 +1989,33 @@ mime_decompose_file_output_fn (const cha</span>
<a href="#l12.101"></a><span id="l12.101">   return NS_OK;</span>
<a href="#l12.102"></a><span id="l12.102"> }</span>
<a href="#l12.103"></a><span id="l12.103"> </span>
<a href="#l12.104"></a><span id="l12.104"> nsresult</span>
<a href="#l12.105"></a><span id="l12.105"> mime_decompose_file_close_fn ( void *stream_closure )</span>
<a href="#l12.106"></a><span id="l12.106"> {</span>
<a href="#l12.107"></a><span id="l12.107">   mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l12.108"></a><span id="l12.108"> </span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-  if ( !mdd || !mdd-&gt;tmpFileStream )</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  if (!mdd)</span>
<a href="#l12.111"></a><span id="l12.111">     return -1;</span>
<a href="#l12.112"></a><span id="l12.112"> </span>
<a href="#l12.113"></a><span id="l12.113">   if ( --mdd-&gt;options-&gt;decompose_init_count &gt; 0 )</span>
<a href="#l12.114"></a><span id="l12.114">       return 0;</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116">   if (mdd-&gt;decoder_data) {</span>
<a href="#l12.117"></a><span id="l12.117">     MimeDecoderDestroy(mdd-&gt;decoder_data, false);</span>
<a href="#l12.118"></a><span id="l12.118">     mdd-&gt;decoder_data = 0;</span>
<a href="#l12.119"></a><span id="l12.119">   }</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  if (!mdd-&gt;tmpFileStream) {</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    // it's ok to have a null tmpFileStream if there's no tmpFile.</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    // This happens for cloud file attachments.</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+    NS_ASSERTION(!mdd-&gt;tmpFile, &quot;shouldn't have a tmp file bu no stream&quot;);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    return 0;</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+  }</span>
<a href="#l12.127"></a><span id="l12.127">   mdd-&gt;tmpFileStream-&gt;Close();</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129">   mdd-&gt;tmpFileStream = nsnull;</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">   mdd-&gt;tmpFile = nsnull;</span>
<a href="#l12.132"></a><span id="l12.132"> </span>
<a href="#l12.133"></a><span id="l12.133">   return 0;</span>
<a href="#l12.134"></a><span id="l12.134"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

