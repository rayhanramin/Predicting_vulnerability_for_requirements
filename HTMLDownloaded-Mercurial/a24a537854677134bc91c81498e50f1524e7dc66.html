<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17201:a24a537854677134bc91c81498e50f1524e7dc66</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a24a537854677134bc91c81498e50f1524e7dc66" />
<meta property="og:url" content="/comm-central/rev/a24a537854677134bc91c81498e50f1524e7dc66" />
<meta property="og:description" content="Fix bug 493389 - Provider for Google Calendar cannot sync tasks (code review in bug 1079189). a=starred" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a24a537854677134bc91c81498e50f1524e7dc66 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a24a537854677134bc91c81498e50f1524e7dc66">shortlog</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a24a537854677134bc91c81498e50f1524e7dc66">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66">files</a> |
changeset |
<a href="/comm-central/raw-rev/a24a537854677134bc91c81498e50f1524e7dc66">raw</a>  | <a href="/comm-central/archive/a24a537854677134bc91c81498e50f1524e7dc66.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493389">bug 493389</a> - Provider for Google Calendar cannot sync tasks (code review in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1079189">bug 1079189</a>). a=starred
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 11 Dec 2014 09:39:22 +0100</td></tr>

<tr>
 <td>changeset 17201</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a24a537854677134bc91c81498e50f1524e7dc66">a24a537854677134bc91c81498e50f1524e7dc66</a></td>
</tr>



<tr>
<td>parent 17200</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e3eb4f336d05daed246976c2afc6fdd9ac66027">2e3eb4f336d05daed246976c2afc6fdd9ac66027</a>
</td>
</tr>

<tr>
<td>child 17202</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fcdb05d290209a122b4f0dc76ec80365f4cc40d0">fcdb05d290209a122b4f0dc76ec80365f4cc40d0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a24a537854677134bc91c81498e50f1524e7dc66">10636</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 11 Dec 2014 08:39:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a24a53785467 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a24a537854677134bc91c81498e50f1524e7dc66">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a24a537854677134bc91c81498e50f1524e7dc66&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a24a537854677134bc91c81498e50f1524e7dc66&newProject=comm-central&newRevision=a24a537854677134bc91c81498e50f1524e7dc66&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a24a537854677134bc91c81498e50f1524e7dc66&newProject=comm-central&newRevision=a24a537854677134bc91c81498e50f1524e7dc66&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a24a537854677134bc91c81498e50f1524e7dc66&newProject=comm-central&newRevision=a24a537854677134bc91c81498e50f1524e7dc66&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28starred%29&revcount=50">starred</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493389">493389</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1079189">1079189</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493389">bug 493389</a> - Provider for Google Calendar cannot sync tasks (code review in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1079189">bug 1079189</a>). a=starred</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">calendar/providers/gdata/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/Makefile.in">calendar/providers/gdata/components/Makefile.in</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/Makefile.in">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/Makefile.in">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">calendar/providers/gdata/components/calGoogleCalendar.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendar.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.js">calendar/providers/gdata/components/calGoogleCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.manifest">calendar/providers/gdata/components/calGoogleCalendarModule.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.manifest">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.manifest">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleCalendarModule.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/moz.build">calendar/providers/gdata/components/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/moz.build">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/moz.build">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/components/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">calendar/providers/gdata/content/browserRequest.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">calendar/providers/gdata/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">calendar/providers/gdata/content/browserRequest.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/browserRequest.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/calendarCreation.xul">calendar/providers/gdata/content/calendarCreation.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/calendarCreation.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/calendarCreation.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/calendarCreation.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">calendar/providers/gdata/content/gdata-bindings.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-bindings.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">calendar/providers/gdata/content/gdata-calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">calendar/providers/gdata/content/gdata-calendar-creation.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-creation.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">calendar/providers/gdata/content/gdata-calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">calendar/providers/gdata/content/gdata-calendar-event-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">calendar/providers/gdata/content/gdata-calendar-properties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">calendar/providers/gdata/content/gdata-calendar-properties.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-calendar-properties.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">calendar/providers/gdata/content/gdata-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">calendar/providers/gdata/content/gdata-event-dialog-reminder.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">calendar/providers/gdata/content/gdata-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">calendar/providers/gdata/content/gdata-migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/content/gdata-migration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">calendar/providers/gdata/defaults/preferences.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/defaults/preferences.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">calendar/providers/gdata/install.rdf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/install.rdf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">calendar/providers/gdata/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">calendar/providers/gdata/makeversion.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/makeversion.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">calendar/providers/gdata/modules/OAuth2.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/OAuth2.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">calendar/providers/gdata/modules/gdataLogging.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataLogging.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">calendar/providers/gdata/modules/shim/Calendar.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Calendar.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">calendar/providers/gdata/modules/shim/Http.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Http.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">calendar/providers/gdata/modules/shim/Loader.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Loader.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">calendar/providers/gdata/modules/shim/Preferences.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Preferences.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">calendar/providers/gdata/modules/shim/Promise.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Promise.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">calendar/providers/gdata/modules/shim/Task.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Task.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">calendar/providers/gdata/modules/shim/Timer.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/shim/Timer.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">calendar/providers/gdata/modules/timezoneMap.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/modules/timezoneMap.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">calendar/providers/gdata/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleCalendar.idl">calendar/providers/gdata/public/calIGoogleCalendar.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleCalendar.idl">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleCalendar.idl">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleCalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleRequest.idl">calendar/providers/gdata/public/calIGoogleRequest.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleRequest.idl">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleRequest.idl">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleRequest.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleSession.idl">calendar/providers/gdata/public/calIGoogleSession.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleSession.idl">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleSession.idl">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/calIGoogleSession.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/moz.build">calendar/providers/gdata/public/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/moz.build">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/moz.build">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/providers/gdata/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">calendar/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/calendar/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">mail/testsuite-targets.mk</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">file</a> |
<a href="/comm-central/annotate/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">annotate</a> |
<a href="/comm-central/diff/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">diff</a> |
<a href="/comm-central/comparison/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">comparison</a> |
<a href="/comm-central/log/a24a537854677134bc91c81498e50f1524e7dc66/mail/testsuite-targets.mk">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -18,8 +18,12 @@ extensions.{a62ef8ec-5fdc-40c2-873c-223b</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> # Events with only free/busy access don't have a title. Use this instead:</span>
<a href="#l1.6"></a><span id="l1.6"> busyTitle=Busy (%1$S)</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> quotaExceeded=The quota for %1$S has been exceeded, please try again later.</span>
<a href="#l1.9"></a><span id="l1.9"> providerOutdated=This version of the provider has expired, please update to the latest version.</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> reminderOutOfRange=Google Calendar only allows reminders up to 4 weeks before the event starts.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+syncProgressEvent=Synchronizing %1$S event %2$S of %3$S</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+syncProgressTask=Synchronizing %1$S task %2$S of %3$S</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+syncStatus=Synchronizing Calendar %1$S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/gdata/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/gdata/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9,26 +9,42 @@ VPATH = @srcdir@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> USE_EXTENSION_MANIFEST = 1</span>
<a href="#l2.8"></a><span id="l2.8"> DIST_FILES = install.rdf</span>
<a href="#l2.9"></a><span id="l2.9"> XPI_PKGNAME = gdata-provider-$(GDATA_VERSION).$(AB_CD).$(MOZ_PKG_PLATFORM)</span>
<a href="#l2.10"></a><span id="l2.10"> XPI_VERSION = $(GDATA_VERSION)</span>
<a href="#l2.11"></a><span id="l2.11"> XPI_NO_UNIVERSAL = 1</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+XPI_EM_ID = {a62ef8ec-5fdc-40c2-873c-223b8a6925cc}</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ifndef DISABLE_LIGHTNING_INSTALL</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+XPI_INSTALL_EXTENSION = $(XPI_EM_ID)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+endif</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> THUNDERBIRD_VERSION := $(shell cat $(topsrcdir)/mail/config/version.txt)</span>
<a href="#l2.18"></a><span id="l2.18"> SEAMONKEY_VERSION := $(shell cat $(topsrcdir)/suite/config/version.txt)</span>
<a href="#l2.19"></a><span id="l2.19"> CALENDAR_VERSION := $(shell $(PYTHON) $(topsrcdir)/calendar/lightning/build/makeversion.py $(word 1,$(MOZ_PKG_VERSION) $(THUNDERBIRD_VERSION)))</span>
<a href="#l2.20"></a><span id="l2.20"> GDATA_VERSION = $(shell $(PYTHON) $(srcdir)/makeversion.py $(CALENDAR_VERSION))</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> DEFINES += -DAB_CD=$(AB_CD) \</span>
<a href="#l2.23"></a><span id="l2.23">            -DCALENDAR_VERSION=$(CALENDAR_VERSION) \</span>
<a href="#l2.24"></a><span id="l2.24">            -DSEAMONKEY_VERSION=$(SEAMONKEY_VERSION) \</span>
<a href="#l2.25"></a><span id="l2.25">            -DTHUNDERBIRD_VERSION=$(THUNDERBIRD_VERSION) \</span>
<a href="#l2.26"></a><span id="l2.26">            -DCOMM_BUILD=$(COMM_BUILD) \</span>
<a href="#l2.27"></a><span id="l2.27">            -DGDATA_VERSION=$(GDATA_VERSION) \</span>
<a href="#l2.28"></a><span id="l2.28">            $(NULL)</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> PREF_JS_EXPORTS = $(srcdir)/defaults/preferences.js</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ifeq (cocoa,$(MOZ_WIDGET_TOOLKIT))</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+# If the macbundle dist dir was already created, sync the gdata provider here to avoid</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+# the need to make -C objdir/mail/app each time</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+tools repackage::</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+	[ -d $(DIST)/$(MOZ_MACBUNDLE_NAME) ] &amp;&amp; rsync -a $(FINAL_TARGET)/ $(DIST)/$(MOZ_MACBUNDLE_NAME)/Contents/Resources/extensions/$(XPI_EM_ID) || true</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+endif</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+# stage the extension for use in packaged tests</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+stage-package:</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+	$(NSINSTALL) -D $(PKG_STAGE)/extensions/$(XPI_EM_ID)</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+	(cd $(FINAL_TARGET) &amp;&amp; tar $(TAR_CREATE_FLAGS) - *) | (cd $(PKG_STAGE)/extensions/$(XPI_EM_ID) &amp;&amp; tar -xf -)</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l2.45"></a><span id="l2.45"> include $(topsrcdir)/calendar/lightning/lightning-packager.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/calendar/providers/gdata/components/Makefile.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,24 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-DEPTH = @DEPTH@</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-topsrcdir = @top_srcdir@</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-srcdir = @srcdir@</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-VPATH = @srcdir@</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-include $(DEPTH)/config/autoconf.mk</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-EXTRA_SCRIPTS = \</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    calGoogleCalendar.js \</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    calGoogleRequest.js \</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    calGoogleSession.js \</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    calGoogleUtils.js \</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    $(NULL)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-# Use NSINSTALL to make the directory, as there's no mtime to preserve.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-	if test ! -d $(FINAL_TARGET)/js; then $(NSINSTALL) -D $(FINAL_TARGET)/js; fi</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-	$(INSTALL) $^ $(FINAL_TARGET)/js</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,262 +1,304 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Calendar.jsm&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+CuImport(&quot;resource://gre/modules/Promise.jsm&quot;, this);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+CuImport(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+CuImport(&quot;resource://gre/modules/Task.jsm&quot;, this);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+CuImport(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;, this);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;, this);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+CuImport(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;, this);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+CuImport(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;, this);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+CuImport(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;, this);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+CuImport(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;, this);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+const MIN_REFRESH_INTERVAL = 30;</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> /**</span>
<a href="#l4.36"></a><span id="l4.36">  * calGoogleCalendar</span>
<a href="#l4.37"></a><span id="l4.37">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l4.38"></a><span id="l4.38">  * Provider.</span>
<a href="#l4.39"></a><span id="l4.39">  *</span>
<a href="#l4.40"></a><span id="l4.40">  * @class</span>
<a href="#l4.41"></a><span id="l4.41">  * @constructor</span>
<a href="#l4.42"></a><span id="l4.42">  */</span>
<a href="#l4.43"></a><span id="l4.43"> function calGoogleCalendar() {</span>
<a href="#l4.44"></a><span id="l4.44">     this.initProviderBase();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    this.mThrottle = Object.create(null);</span>
<a href="#l4.46"></a><span id="l4.46"> }</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48"> const calGoogleCalendarClassID = Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;);</span>
<a href="#l4.49"></a><span id="l4.49"> const calGoogleCalendarInterfaces = [</span>
<a href="#l4.50"></a><span id="l4.50">     Components.interfaces.calICalendar,</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    Components.interfaces.calIGoogleCalendar,</span>
<a href="#l4.52"></a><span id="l4.52">     Components.interfaces.calISchedulingSupport,</span>
<a href="#l4.53"></a><span id="l4.53">     Components.interfaces.calIChangeLog</span>
<a href="#l4.54"></a><span id="l4.54"> ];</span>
<a href="#l4.55"></a><span id="l4.55"> calGoogleCalendar.prototype = {</span>
<a href="#l4.56"></a><span id="l4.56">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58">     classID: calGoogleCalendarClassID,</span>
<a href="#l4.59"></a><span id="l4.59">     QueryInterface: XPCOMUtils.generateQI(calGoogleCalendarInterfaces),</span>
<a href="#l4.60"></a><span id="l4.60">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-        classID: calGoogleCalendarClassID,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l4.63"></a><span id="l4.63">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-        classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+        classID: calGoogleCalendarClassID,</span>
<a href="#l4.66"></a><span id="l4.66">         interfaces: calGoogleCalendarInterfaces</span>
<a href="#l4.67"></a><span id="l4.67">     }),</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    /* Member Variables */</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    mSession: null,</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    mFullUri: null,</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    mCalendarName: null,</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    /*</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-     * Google Calendar Provider attributes</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-     */</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    /**</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-     * readonly attribute googleCalendarName</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-     * Google's Calendar name. This represents the &lt;calendar name&gt; in</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-     * http[s]://www.google.com/calendar/feeds/&lt;calendar name&gt;/private/full</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-     */</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    get googleCalendarName() {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-        return this.mCalendarName;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-    },</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-    get isDefaultCalendar() {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-        return !/@group\.calendar\.google\.com$/.test(this.mCalendarName);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    },</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-    /**</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-     * attribute session</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-     * An calGoogleSession Object that handles the session requests.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-     */</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    get session() {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-        return this.mSession;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-    },</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    set session(v) {</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-        return this.mSession = v;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    },</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    /* Used to reset the local cache between releases */</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    CACHE_DB_VERSION: 2,</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    get title() {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    },</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    set title(v) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    },</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-    get access() {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    },</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-    set access(v) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    },</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-    get selected() {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-    },</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-    set selected(v) {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-    get hidden() {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-    },</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-    set hidden(v) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    },</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-    get color() {</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-    },</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    set color(v) {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    /* Member Variables */</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    mCalendarName: null,</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    mThrottle: null,</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    mThrottleLimits: {</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+      &quot;calendarList&quot;: 3600 * 1000,</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+      &quot;events&quot;: 30 * 1000,</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      &quot;tasks&quot;: 30 * 1000</span>
<a href="#l4.144"></a><span id="l4.144">     },</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-    get timezone() {</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-    },</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-    set timezone(v) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-    },</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-    /**</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-     * findSession</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-     * Populates the Session Object based on the preferences or the result of a</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-     * login prompt.</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-     *</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-     * @param aIgnoreExistingSession If set, find the session regardless of</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-     *                               whether the session has been previously set</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-     *                               or not</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-     */</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-    findSession: function cGC_findSession(aIgnoreExistingSession) {</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-        if (this.mSession &amp;&amp; !aIgnoreExistingSession) {</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-            return true;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-        }</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-        // We need to find out which Google account fits to this calendar.</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-        let sessionMgr = getGoogleSessionManager();</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-        let googleUser = getCalendarPref(this, &quot;googleUser&quot;);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-        if (googleUser) {</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-            this.mSession = sessionMgr.getSessionByUsername(googleUser, true);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-        } else {</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-            // We have no user, therefore we need to ask the user. Show a</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-            // user/password prompt and set the session based on those</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-            // values.</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-            let username = { value: null };</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-            if (this.isDefaultCalendar) {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-                // Only pre-fill the username if this is the default calendar,</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-                // otherwise users might think the cryptic hash is the username</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-                // they have to use.</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-                username.value = this.mCalendarName;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-            }</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-            let password = { value: null };</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-            let persist = { value: false };</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-            if (getCalendarCredentials(this.mCalendarName,</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-                                       username,</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-                                       password,</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-                                       persist)) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-                this.mSession = sessionMgr.getSessionByUsername(username.value,</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-                                                                true);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-                this.mSession.password = password.value;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-                this.mSession.persist = persist.value;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-                setCalendarPref(this,</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-                                &quot;googleUser&quot;,</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-                                &quot;CHAR&quot;,</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-                                this.mSession.userName);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-            } else {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-                // The password dialog was canceled, disable the calendar.</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-                this.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-                return false;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-            }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-        }</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-        return true;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-    },</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    /* Public Members */</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    session: null,</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210">     /**</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-     * ensureSession</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-     * Make sure a session is available. If not, throw an exception</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+     * Make sure a session is available.</span>
<a href="#l4.214"></a><span id="l4.214">      */</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-    ensureSession: function cGC_ensureSession() {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-        if (!this.mSession ||</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-            !this.mSession.password ||</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-            this.mSession.password == &quot;&quot;) {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-            if (!this.findSession) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-                throw new Components.Exception(&quot;Session was canceled&quot;,</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-                                               Components.results.NS_ERROR_FAILURE);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    ensureSession: function() {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+        if (!this.session) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+            // Now actually set up the session</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+            let sessionMgr = getGoogleSessionManager();</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+            this.session = sessionMgr.getSessionByCalendar(this, true);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+            // Aside from setting up the session, bump the refresh interval to</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+            // a higher value if its below the minimal refresh interval to</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+            // avoid exceeding quota.</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+            let interval = this.getProperty(&quot;refreshInterval&quot;);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+            if (interval &lt; MIN_REFRESH_INTERVAL &amp;&amp; interval != 0) {</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Sorry, auto-refresh intervals under &quot; + MIN_REFRESH_INTERVAL + &quot; minutes would cause the quota to be reached too fast.&quot;);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+                this.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l4.235"></a><span id="l4.235">             }</span>
<a href="#l4.236"></a><span id="l4.236">         }</span>
<a href="#l4.237"></a><span id="l4.237">     },</span>
<a href="#l4.238"></a><span id="l4.238"> </span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    ensureWritable: function() {</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+        // Check if calendar is readonly</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+        if (this.readOnly) {</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+            const cIE = Components.interfaces.calIErrors;</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+            throw new Components.Exception(&quot;&quot;, cIE.CAL_IS_READONLY);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+        }</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    },</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    get isDefaultCalendar() !this.mCalendarName.endsWith(&quot;@group.calendar.google.com&quot;),</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+</span>
<a href="#l4.249"></a><span id="l4.249">     /*</span>
<a href="#l4.250"></a><span id="l4.250">      * implement calICalendar</span>
<a href="#l4.251"></a><span id="l4.251">      */</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-    get type() {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-        return &quot;gdata&quot;;</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    get type() &quot;gdata&quot;,</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    get providerID() &quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;,</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+    get canRefresh() true,</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    get id() this.mID,</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+    set id(val) {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+        let setter = this.__proto__.__proto__.__lookupSetter__(&quot;id&quot;);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+        val = setter.call(this, val);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+        if (this.id &amp;&amp; this.uri) {</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+            this.ensureSession();</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+        }</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+        return val;</span>
<a href="#l4.267"></a><span id="l4.267">     },</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-    get providerID() {</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-        return &quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;;</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-    },</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+    get uri() this.mUri,</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    set uri(aUri) {</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+        const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+        this.mUri = aUri;</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+        if (aUri &amp;&amp; aUri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+            // new format:  googleapi://session-id/?calendar=calhash@group.calendar.google.com&amp;tasks=taskhash</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+            let [fullUser, path] = aUri.path.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+            let parameters = new Map(path.substr(1).split(&quot;&amp;&quot;).filter(Boolean)</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+                             .map(function(x) x.split(&quot;=&quot;, 2).map(decodeURIComponent)));</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+            if (parameters.size == 0) {</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+                this.mCalendarName = fullUser;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+                this.mTasklistName = this.isDefaultCalendar ? &quot;@default&quot; : null;</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+            } else {</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+                this.mCalendarName = parameters.get(&quot;calendar&quot;);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+                this.mTasklistName = parameters.get(&quot;tasks&quot;);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+            }</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+            // Users that installed 1.0 had an issue where secondary calendars</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+            // were migrated to their own session. This code fixes that and</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+            // should be removed once 1.0.1 has been out for a while.</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+            let googleUser = Preferences.get(&quot;calendar.google.calPrefs.&quot; + fullUser + &quot;.googleUser&quot;);</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+            if (googleUser &amp;&amp; googleUser != fullUser) {</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+                let newUri = &quot;googleapi://&quot; + googleUser + &quot;/&quot; + path;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Migrating url format from &quot; + aUri.spec + &quot; to &quot; + newUri);</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+                this.setProperty(&quot;uri&quot;, newUri);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+                this.mUri = Services.io.newURI(newUri, null, null);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+            }</span>
<a href="#l4.300"></a><span id="l4.300"> </span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-    get uri() {</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+            // Unit tests will use a local uri, if the magic parameter is passed.</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+            let port = parameters.get(&quot;testport&quot;);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+            if (port) {</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Redirecting request to test port &quot; + port);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+                API_BASE.EVENTS = &quot;http://localhost:&quot; + port + &quot;/calendar/v3/&quot;;</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+                API_BASE.TASKS = &quot;http://localhost:&quot; + port + &quot;/tasks/v1/&quot;;</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+            }</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+        } else if (aUri &amp;&amp; protocols.some(function(scheme) { return aUri.schemeIs(scheme); })) {</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+            // Parse google url, catch private cookies, public calendars,</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+            // basic and full types, bogus ics file extensions, invalid hostnames</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+            let re = new RegExp(&quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+                                &quot;([^/]+)/(public|private|free-busy)-?([^/]+)?/&quot; +</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+                                &quot;(full|basic)(.ics)?$&quot;);</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+            let matches = aUri.path.match(re);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+            if (matches) {</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+                this.mCalendarName = decodeURIComponent(matches[2]);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+                let googleUser = Preferences.get(&quot;calendar.google.calPrefs.&quot; + this.mCalendarName + &quot;.googleUser&quot;);</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+                let newUri = &quot;googleapi://&quot; + (googleUser || this.mCalendarName) + &quot;/?calendar=&quot; + matches[2];</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+                // Use the default task list, but only if this is the primary account.</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+                if (googleUser &amp;&amp; googleUser == this.mCalendarName) {</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+                    this.mTasklistName = &quot;@default&quot;;</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+                    newUri += &quot;&amp;tasks=%40default&quot;;</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+                }</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Migrating url format from &quot; + aUri.spec +</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+                        &quot; to &quot; + newUri);</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+                this.setProperty(&quot;uri&quot;, newUri);</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+                this.mUri = Services.io.newURI(newUri, null, null);</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+            }</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+        }</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+        if (this.id &amp;&amp; this.uri) {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+            this.ensureSession();</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+        }</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+</span>
<a href="#l4.340"></a><span id="l4.340">         return this.mUri;</span>
<a href="#l4.341"></a><span id="l4.341">     },</span>
<a href="#l4.342"></a><span id="l4.342"> </span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-    get fullUri() {</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-        return this.mFullUri;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    createEventsURI: function (/* ...extraParts */) {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+        let extraParts = Array.slice(arguments);</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+        let eventsURI = null;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+        if (this.mCalendarName) {</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+            let encodedName = encodeURIComponent(this.mCalendarName);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+            let parts = [&quot;calendars&quot;, encodedName].concat(Array.filter(extraParts, Boolean));</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+            eventsURI = API_BASE.EVENTS + parts.join(&quot;/&quot;);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+        }</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+        return eventsURI;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    },</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+    createUsersURI: function(/* ...extraParts */) {</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+        let extraParts = Array.slice(arguments);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+        let parts = [&quot;users&quot;, &quot;me&quot;].concat(extraParts).map(encodeURIComponent);</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+        return API_BASE.EVENTS + parts.join(&quot;/&quot;);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+    },</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+    createTasksURI: function(/* ...extraParts */) {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+        let extraParts = Array.slice(arguments);</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+        let tasksURI = null;</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+        if (this.mTasklistName) {</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+            let encodedName = encodeURIComponent(this.mTasklistName);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+            let parts = [&quot;lists&quot;, encodedName].concat(Array.filter(extraParts, Boolean));</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+            tasksURI = API_BASE.TASKS + parts.join(&quot;/&quot;);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+        }</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+        return tasksURI;</span>
<a href="#l4.371"></a><span id="l4.371">     },</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-    set uri(aUri) {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-        // Parse google url, catch private cookies, public calendars,</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-        // basic and full types, bogus ics file extensions, invalid hostnames</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-        let re = new RegExp(&quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-                            &quot;([^/]+)/(public|private)-?([^/]+)?/&quot; +</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-                            &quot;(full|basic)(.ics)?$&quot;);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+    STALE_TIME: 7 * 86400,</span>
<a href="#l4.380"></a><span id="l4.380"> </span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-        let matches = aUri.path.match(re);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+    getUpdatedMin: function getUpdatedMin(aWhich) {</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+        let updatedMin = null;</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+        let lastUpdated = this.getProperty(&quot;lastUpdated.&quot; + aWhich);</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+        if (lastUpdated) {</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+            updatedMin = cal.createDateTime(lastUpdated);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+            let lastWeek = cal.now();</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+            lastWeek.second -= this.STALE_TIME;</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+            if (updatedMin.compare(lastWeek) &lt;= 0) {</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Last updated time for &quot; + aWhich +</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+                        &quot; is very old, doing full sync&quot;);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+                this.resetLog();</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+                updatedMin = null;</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+            }</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+        }</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+        return updatedMin ? getCorrectedDate(updatedMin) : null;</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+    },</span>
<a href="#l4.398"></a><span id="l4.398"> </span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-        if (!matches) {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-            throw new Components.Exception(aUri, Components.results.NS_ERROR_MALFORMED_URI);</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+    checkThrottle: function(type) {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+        let shouldRequest = true;</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+        let now = new Date().getTime();</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+        if (type in this.mThrottle) {</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+            let then = this.mThrottle[type];</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+            if (now - then &lt; this.mThrottleLimits[type]) {</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+                shouldRequest = false;</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+            }</span>
<a href="#l4.411"></a><span id="l4.411">         }</span>
<a href="#l4.412"></a><span id="l4.412"> </span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-        // Set internal Calendar Name</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-        this.mCalendarName = decodeURIComponent(matches[2]);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-        // Set normalized url. We need private visibility and full projection</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-        this.mFullUri = aUri.clone();</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-        this.mFullUri.path = &quot;/calendar/feeds/&quot; + matches[2] + &quot;/private/full&quot;;</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+        if (shouldRequest) {</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+            this.mThrottle[type] = now;</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+        } else {</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Skipping &quot; + type + &quot; request to reduce requests&quot;);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+        }</span>
<a href="#l4.424"></a><span id="l4.424"> </span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-        // Remember the uri as it was passed, in case the calendar manager</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-        // relies on it.</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-        this.mUri = aUri;</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-        this.findSession(true);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-        return this.mUri;</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+        return shouldRequest;</span>
<a href="#l4.432"></a><span id="l4.432">     },</span>
<a href="#l4.433"></a><span id="l4.433"> </span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-    getProperty: function cGC_getProperty(aName) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l4.436"></a><span id="l4.436">         switch (aName) {</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+            case &quot;googleCalendarName&quot;:</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+                return this.mCalendarName;</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+            case &quot;isDefaultCalendar&quot;:</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+                return this.isDefaultCalendar;</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+</span>
<a href="#l4.442"></a><span id="l4.442">             // Capabilities</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+            case &quot;cache.enabled&quot;:</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+            case &quot;cache.always&quot;:</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+                return true;</span>
<a href="#l4.446"></a><span id="l4.446">             case &quot;capabilities.timezones.floating.supported&quot;:</span>
<a href="#l4.447"></a><span id="l4.447">             case &quot;capabilities.attachments.supported&quot;:</span>
<a href="#l4.448"></a><span id="l4.448">             case &quot;capabilities.priority.supported&quot;:</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-            case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l4.450"></a><span id="l4.450">             case &quot;capabilities.alarms.oninvitations.supported&quot;:</span>
<a href="#l4.451"></a><span id="l4.451">                 return false;</span>
<a href="#l4.452"></a><span id="l4.452">             case &quot;capabilities.privacy.values&quot;:</span>
<a href="#l4.453"></a><span id="l4.453">                 return [&quot;DEFAULT&quot;, &quot;PUBLIC&quot;, &quot;PRIVATE&quot;];</span>
<a href="#l4.454"></a><span id="l4.454">             case &quot;capabilities.alarms.maxCount&quot;:</span>
<a href="#l4.455"></a><span id="l4.455">                 return 5;</span>
<a href="#l4.456"></a><span id="l4.456">             case &quot;capabilities.alarms.actionValues&quot;:</span>
<a href="#l4.457"></a><span id="l4.457">                 return [&quot;DISPLAY&quot;, &quot;EMAIL&quot;, &quot;SMS&quot;];</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+            case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+                return !!this.mTasklistName;</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+            case &quot;capabilities.events.supported&quot;:</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+                return !!this.mCalendarName;</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+            case &quot;readOnly&quot;:</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+                // If this calendar displays events, make it readonly if we are</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+                // not the owner or have write access.</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+                let accessRole = this.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+                let isReader = (accessRole == &quot;freeBusyReader&quot; || accessRole == &quot;reader&quot;);</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+                if (this.mCalendarName &amp;&amp; isReader) {</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+                    return true;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+                }</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+                // Otherwise fall through</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+                break;</span>
<a href="#l4.472"></a><span id="l4.472">             case &quot;organizerId&quot;:</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-                return &quot;mailto:&quot; + this.googleCalendarName;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-            case &quot;organizerCN&quot;:</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-                if (this.mSession) {</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-                    return this.session.fullName;</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-                }</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-                break;</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+                return &quot;mailto:&quot; + this.mCalendarName;</span>
<a href="#l4.480"></a><span id="l4.480">             case &quot;itip.transport&quot;:</span>
<a href="#l4.481"></a><span id="l4.481">                 if (!this.isDefaultCalendar ||</span>
<a href="#l4.482"></a><span id="l4.482">                     !Preferences.get(&quot;calendar.google.enableEmailInvitations&quot;, false)) {</span>
<a href="#l4.483"></a><span id="l4.483">                     // If we explicitly return null here, then these calendars</span>
<a href="#l4.484"></a><span id="l4.484">                     // will not be included in the list of calendars to accept</span>
<a href="#l4.485"></a><span id="l4.485">                     // invitations to and imip will effectively be disabled.</span>
<a href="#l4.486"></a><span id="l4.486">                     return null;</span>
<a href="#l4.487"></a><span id="l4.487">                 }</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineat">@@ -271,859 +313,459 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.489"></a><span id="l4.489">                     return true;</span>
<a href="#l4.490"></a><span id="l4.490">                 }</span>
<a href="#l4.491"></a><span id="l4.491">                 break;</span>
<a href="#l4.492"></a><span id="l4.492">         }</span>
<a href="#l4.493"></a><span id="l4.493"> </span>
<a href="#l4.494"></a><span id="l4.494">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l4.495"></a><span id="l4.495">     },</span>
<a href="#l4.496"></a><span id="l4.496"> </span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    get canRefresh() {</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-        return true;</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+        switch (aName) {</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+            case &quot;refreshInterval&quot;:</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+                if (aValue &lt; MIN_REFRESH_INTERVAL &amp;&amp; aValue != 0) {</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Sorry, auto-refresh intervals under &quot; +</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+                            MIN_REFRESH_INTERVAL + &quot; minutes would cause the quota &quot; +</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+                            &quot;to be reached too fast.&quot;);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+                    this.superCalendar.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+                    return;</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+                }</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+                break;</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+        }</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+        return this.__proto__.__proto__.setProperty.apply(this, arguments);</span>
<a href="#l4.513"></a><span id="l4.513">     },</span>
<a href="#l4.514"></a><span id="l4.514"> </span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-    adoptItem: function cGC_adoptItem(aItem, aListener) {</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aItem.title);</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+    addItemOrUseCache: calendarShim.addItemOrUseCache,</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+    adoptItemOrUseCache: calendarShim.adoptItemOrUseCache,</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+    modifyItemOrUseCache: calendarShim.modifyItemOrUseCache,</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+    deleteItemOrUseCache: calendarShim.deleteItemOrUseCache,</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+    notifyPureOperationComplete: calendarShim.notifyPureOperationComplete,</span>
<a href="#l4.522"></a><span id="l4.522"> </span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-        try {</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-            // Check if calendar is readonly</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-            if (this.readOnly) {</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-                throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-                                               Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+    addItem: function(aItem, aListener) this.adoptItem(aItem.clone(), aListener),</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+    adoptItem: function(aItem, aListener) {</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+        function stackContains(part, max) {</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+            if (max === undefined) max = 8;</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+            let stack = Components.stack.caller;</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+            while (stack &amp;&amp; --max) {</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+                if (stack.filename &amp;&amp; stack.filename.endsWith(part)) {</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+                    return true;</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+                }</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+                stack = stack.caller;</span>
<a href="#l4.538"></a><span id="l4.538">             }</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+            return false;</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+        }</span>
<a href="#l4.541"></a><span id="l4.541"> </span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-            // Make sure the item is an event</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-            aItem = aItem.QueryInterface(Components.interfaces.calIEvent);</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+        // Now this sucks...both invitations and the offline cache send over</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+        // items with the id set, but we have no way to figure out which is</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+        // happening just by inspecting the item. Adding offline items should</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+        // not be an import, but invitations should.</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+        let isImport = aItem.id &amp;&amp; (aItem.id == &quot;xpcshell-import&quot; || stackContains(&quot;calItipUtils.jsm&quot;));</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        let request = new calGoogleRequest();</span>
<a href="#l4.550"></a><span id="l4.550"> </span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-            // Check if we have a session. If not, then the user has canceled</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-            // the login prompt.</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+        Task.spawn(function() {</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+            let itemData = ItemToJSON(aItem, this.offlineStorage, isImport);</span>
<a href="#l4.556"></a><span id="l4.556"> </span>
<a href="#l4.557"></a><span id="l4.557">             // Add the calendar to the item, for later use.</span>
<a href="#l4.558"></a><span id="l4.558">             aItem.calendar = this.superCalendar;</span>
<a href="#l4.559"></a><span id="l4.559"> </span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-            let request = new calGoogleRequest(this);</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-            let xmlEntry = ItemToXMLEntry(aItem, this,</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-                                          this.session.userName,</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-                                          this.session.fullName);</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-</span>
<a href="#l4.565"></a><span id="l4.565">             request.type = request.ADD;</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-            request.uri = this.fullUri.spec;</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-            request.operationListener = aListener;</span>
<a href="#l4.569"></a><span id="l4.569">             request.calendar = this;</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-            request.newItem = aItem;</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-            request.responseListener = { onResult: this.addItem_response.bind(this) };</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-            request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+            if (cal.isEvent(aItem)) {</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+                if (isImport) {</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Adding invitation event &quot; + aItem.title);</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+                    request.uri = this.createEventsURI(&quot;events&quot;, &quot;import&quot;);</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+                } else {</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Adding regular event &quot; + aItem.title);</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+                    request.uri = this.createEventsURI(&quot;events&quot;);</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+                }</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-            this.session.asyncItemRequest(request);</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-            return request;</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] adoptItem failed before request &quot; + aItem.title + &quot;\n:&quot; + e);</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-            if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-                // The calendar is readonly, make sure this is set and</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-                // notify the user. This can come from above or from</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-                // mSession.addItem which checks for the editURI</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-                this.readOnly = true;</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-            }</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-            this.notifyOperationComplete(aListener,</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-                                         e.result,</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-                                         null,</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-                                         e.message);</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-        }</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-        return null;</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-    },</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-    addItem: function cGC_addItem(aItem, aListener) {</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-        // Google assigns an ID to every event added. Any id set here or in</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-        // adoptItem will be overridden.</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineminus">-        return this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-    },</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-    modifyItem: function cGC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOldItem.title);</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-        try {</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-            if (this.readOnly) {</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-                throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-                                               Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+                if (Preferences.get(&quot;calendar.google.sendEventNotifications&quot;, false)) {</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+                    request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+                }</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+            } else if (cal.isToDo(aItem)) {</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Adding task &quot; + aItem.title);</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+                request.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+                // Tasks sent with an id will cause a bad request</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+                delete itemData.id;</span>
<a href="#l4.623"></a><span id="l4.623">             }</span>
<a href="#l4.624"></a><span id="l4.624"> </span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-            // Check if we have a session. If not, then the user has canceled</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-            // the login prompt.</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineminus">-</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineminus">-            // Check if enough fields have changed to warrant sending the event</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineminus">-            // to google. This saves network traffic. Also check if the item isn't</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineminus">-            // the same to work around a bug in the cache layer.</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-            if (aOldItem != aNewItem &amp;&amp; relevantFieldsMatch(aOldItem, aNewItem)) {</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Not requesting item modification for &quot; + aOldItem.id +</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineminus">-                        &quot;(&quot; + aOldItem.title + &quot;), relevant fields match&quot;);</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineminus">-</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineminus">-                this.notifyOperationComplete(aListener,</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineminus">-                                             Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-                                             aNewItem.id,</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-                                             aNewItem);</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-                this.mObservers.notify(&quot;onModifyItem&quot;, [aNewItem, aOldItem]);</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-                return null;</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-            }</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineminus">-</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-            // Set up the request</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-            let request = new calGoogleRequest(this.session);</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineminus">-            // We need to clone the new item, its possible that ItemToXMLEntry</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-            // will modify the item. For example, if the item is organized by</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-            // someone else, we cannot save alarms on it and they should</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-            // therefore not be added in the returned item.</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-            let newItem = aNewItem.clone();</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineminus">-            let xmlEntry = ItemToXMLEntry(newItem, this,</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineminus">-                                          this.session.userName,</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-                                          this.session.fullName);</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-            if (aOldItem.parentItem != aOldItem &amp;&amp;</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineminus">-                !aOldItem.parentItem.recurrenceInfo.getExceptionFor(aOldItem.startDate)) {</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-                // In this case we are modifying an occurence, not deleting it</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-                request.type = request.ADD;</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-                request.uri = this.fullUri.spec;</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-            } else {</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-                // We are  making a negative exception or modifying a parent item</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-                request.type = request.MODIFY;</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-                request.uri = getItemEditURI(aOldItem);</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-            }</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-            request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-            request.responseListener = { onResult: this.modifyItem_response.bind(this) };</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-            request.operationListener = aListener;</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-            request.newItem = newItem;</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-            request.oldItem = aOldItem;</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-            request.calendar = this;</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-            request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineminus">-</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-            this.session.asyncItemRequest(request);</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineminus">-            return request;</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] modifyItem failed before request &quot; +</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-                    aNewItem.title + &quot;(&quot; + aNewItem.id + &quot;):\n&quot; + e);</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-            if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineminus">-                // The calendar is readonly, make sure this is set and</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineminus">-                // notify the user. This can come from above or from</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineminus">-                // mSession.modifyItem which checks for the editURI</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineminus">-                this.readOnly = true;</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineminus">-            }</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-            this.notifyOperationComplete(aListener,</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-                                         e.result,</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineminus">-                                         null,</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineminus">-                                         e.message);</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineminus">-        }</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineminus">-        return null;</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-    },</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-    deleteItem: function cGC_deleteItem(aItem, aListener) {</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineminus">-</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-        try {</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-            if (this.readOnly) {</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-                throw new Components.Exception(&quot;&quot;,</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-                                               Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+            if (!request.uri) {</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+                throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l4.710"></a><span id="l4.710">             }</span>
<a href="#l4.711"></a><span id="l4.711"> </span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-            // Check if we have a session. If not, then the user has canceled</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-            // the login prompt.</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-            // We need the item in the response, since google dosen't return any</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-            // item XML data on delete, and we need to call the observers.</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-            let request = new calGoogleRequest(this);</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineminus">-            request.type = request.DELETE;</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineminus">-            request.uri = getItemEditURI(aItem);</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineminus">-            request.operationListener = aListener;</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineminus">-            request.oldItem = aItem;</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineminus">-            request.calendar = this;</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineminus">-            request.responseListener = { onResult: this.deleteItem_response.bind(this) };</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineminus">-</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineminus">-            this.session.asyncItemRequest(request);</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-            return request;</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] deleteItem failed before request for &quot; +</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-                    aItem.title + &quot;(&quot; + aItem.id + &quot;):\n&quot; + e);</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineminus">-</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineminus">-            if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineminus">-                // The calendar is readonly, make sure this is set and</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineminus">-                // notify the user. This can come from above or from</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineminus">-                // mSession.deleteItem which checks for the editURI</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineminus">-                this.readOnly = true;</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineminus">-            }</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+            request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+                                  JSON.stringify(itemData));</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+            let data = yield this.session.asyncItemRequest(request);</span>
<a href="#l4.742"></a><span id="l4.742"> </span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-            this.notifyOperationComplete(aListener,</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-                                         e.result,</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineminus">-                                         null,</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineminus">-                                         e.message);</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineminus">-        }</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineminus">-        return null;</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineminus">-    },</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineminus">-    getItem: function cGC_getItem(aId, aListener) {</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineminus">-        // This function needs a test case using mechanisms in bug 365212</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Getting item with id &quot; + aId);</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineminus">-        try {</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineminus">-</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineminus">-            // Check if we have a session. If not, then the user has canceled</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-            // the login prompt.</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+            // All we need to do now is parse the item and complete the</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+            // operation. The cache layer will take care of adding the item</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+            // to the storage.</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+            let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+            let metaData = Object.create(null);</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+            let item = JSONToItem(data, this, defaultTimezone,</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+                                  this.defaultReminders || [],</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+                                  null, metaData);</span>
<a href="#l4.768"></a><span id="l4.768"> </span>
<a href="#l4.769"></a><span id="l4.769" class="difflineminus">-            // Set up the request</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineminus">-</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineminus">-            let request = new calGoogleRequest(this);</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineminus">-</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineminus">-            request.itemId = aId;</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineminus">-            request.type = request.GET;</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineminus">-            request.uri = this.fullUri.spec;</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-            request.operationListener = aListener;</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineminus">-            request.responseListener = { onResult: this.getItem_response.bind(this) };</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineminus">-            request.calendar = this;</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineminus">-            // Request Parameters</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-            request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-            request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-            request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineminus">-</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineminus">-            this.session.asyncItemRequest(request);</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineminus">-            return request;</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] getItem failed before request &quot; + aId + &quot;):\n&quot; + e);</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+            // Make sure to update the etag and id</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+            saveItemMetadata(this.offlineStorage, item.hashId, metaData);</span>
<a href="#l4.791"></a><span id="l4.791"> </span>
<a href="#l4.792"></a><span id="l4.792" class="difflineminus">-            this.notifyOperationComplete(aListener,</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineminus">-                                         e.result,</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-                                         null,</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-                                         e.message);</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-        }</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-        return null;</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineminus">-    },</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineminus">-</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineminus">-    getItems: function cGC_getItems(aItemFilter,</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineminus">-                                    aCount,</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-                                    aRangeStart,</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-                                    aRangeEnd,</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-                                    aListener) {</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineminus">-        try {</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineminus">-            // Check if we have a session. If not, then the user has canceled</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineminus">-            // the login prompt.</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineminus">-</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineminus">-            // item base type</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-            let wantEvents = ((aItemFilter &amp;</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-                               Components.interfaces.calICalendar.ITEM_FILTER_TYPE_EVENT) != 0);</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-            let wantInvitations = ((aItemFilter &amp;</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineminus">-                 Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineminus">-</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineminus">-            if (!wantEvents) {</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-                // Events are not wanted, nothing to do. The</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-                // notifyOperationComplete in the catch block below will catch</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-                // this.</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-                throw new Components.Exception(&quot;&quot;, Components.results.NS_OK);</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-            }</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-            // Requesting only a DATE returns items based on UTC. Therefore, we make</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineminus">-            // sure both start and end dates include a time and timezone. This may</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-            // not quite be what was requested, but I'd say its a shortcoming of</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-            // rfc3339.</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-            if (aRangeStart) {</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-                aRangeStart = aRangeStart.clone();</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineminus">-                aRangeStart.isDate = false;</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+            if (aItem.id &amp;&amp; item.id != aItem.id) {</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+                // Looks like the id changed, probably because its an offline</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+                // item. This really sucks for us now, because the cache will</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+                // reset the wrong item. As a hack, delete the item with its</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+                // original id and complete the adoptItem call with the new</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+                // item. This will add the new item to the calendar.</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+                let pcal = promisifyCalendar(this.offlineStorage);</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+                yield pcal.deleteItem(aItem);</span>
<a href="#l4.839"></a><span id="l4.839">             }</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-            if (aRangeEnd) {</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineminus">-                aRangeEnd = aRangeEnd.clone();</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineminus">-                aRangeEnd.isDate = false;</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineminus">-            }</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineminus">-</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineminus">-            let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineminus">-            let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-            let request = new calGoogleRequest(this);</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineminus">-</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineminus">-            request.type = request.GET;</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineminus">-            request.uri = this.fullUri.spec;</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineminus">-            request.operationListener = aListener;</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineminus">-            request.calendar = this;</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineminus">-            request.itemRangeStart = aRangeStart;</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineminus">-            request.itemRangeEnd = aRangeEnd;</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineminus">-            request.itemFilter = aItemFilter;</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineminus">-</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-            // Request Parameters</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineminus">-            request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineminus">-            request.addQueryParameter(&quot;max-results&quot;,</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineminus">-                                      aCount ? aCount : kMANY_EVENTS);</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineminus">-            request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-            request.addQueryParameter(&quot;start-min&quot;, rfcRangeStart);</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineminus">-            request.addQueryParameter(&quot;start-max&quot;, rfcRangeEnd);</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineminus">-            request.responseListener = { onResult: this.getItems_response.bind(this) };</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineminus">-            this.session.asyncItemRequest(request);</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineminus">-            return request;</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineminus">-            this.notifyOperationComplete(aListener,</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineminus">-                                         e.result,</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineminus">-                                         null,</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-                                         e.message);</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineminus">-        }</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineminus">-        return null;</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineminus">-    },</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineminus">-</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineminus">-    refresh: function cGC_refresh() {</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineminus">-        this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+            throw new Task.Result(item);</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+        }.bind(this)).then(function(item) {</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Adding &quot; + item.title + &quot; succeeded&quot;);</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+            this.observers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+                                         cIOL.ADD, item.id, item);</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+            cal.ERROR(&quot;[calGoogleCalendar] Adding Item &quot; + aItem.title +</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+                      &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+            this.notifyPureOperationComplete(aListener, code, cIOL.ADD, aItem.id, e.message);</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+        }.bind(this));</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+        return request;</span>
<a href="#l4.893"></a><span id="l4.893">     },</span>
<a href="#l4.894"></a><span id="l4.894"> </span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-    /*</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineminus">-     * Google Calendar Provider Response Listener functions</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineminus">-     */</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+    modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aNewItem.title + &quot; (&quot; +</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+                (aNewItem.recurrenceId ? aNewItem.recurrenceId.icalString :</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+                &quot;master item&quot;) + &quot;)&quot;);</span>
<a href="#l4.902"></a><span id="l4.902"> </span>
<a href="#l4.903"></a><span id="l4.903" class="difflineminus">-    /**</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineminus">-     * addItem_response</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineminus">-     * Response function, called by the session object when an item was added</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineminus">-     *</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineminus">-     * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineminus">-     * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineminus">-     *                     an XML representation of the added item.</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-     */</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineminus">-    addItem_response: function cGC_addItem_response(aOperation, aData) {</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineminus">-        // First, have the general response retrieve the item</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineminus">-        let item, e;</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineminus">-        try {</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineminus">-            item = DataToItem(aOperation, aData, this, null);</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineminus">-            if (!resolveConflicts(aOperation, item)) {</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineminus">-                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineminus">-                // request will be sent. bail out here, this method will be</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineminus">-                // called again</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineminus">-                return;</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+        // Set up the request</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+        let request = new calGoogleRequest();</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+        Task.spawn(function() {</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+            request.type = request.MODIFY;</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+            request.calendar = this;</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+            if (cal.isEvent(aNewItem)) {</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+                request.uri = this.createEventsURI(&quot;events&quot;, getGoogleId(aNewItem, this.offlineStorage));</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+            } else if (cal.isToDo(aNewItem)) {</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+                request.uri = this.createTasksURI(&quot;tasks&quot;, aNewItem.id);</span>
<a href="#l4.930"></a><span id="l4.930">             }</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineminus">-        } catch (exp) {</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineminus">-            item = null;</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineminus">-            e = exp;</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineminus">-        }</span>
<a href="#l4.935"></a><span id="l4.935"> </span>
<a href="#l4.936"></a><span id="l4.936" class="difflineminus">-        let resultCode;</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineminus">-        if (item) {</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + item.title + &quot; successful&quot;);</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineminus">-            this.mObservers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineminus">-            resultCode = Components.results.NS_OK;</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineminus">-        } else {</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineminus">-            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineminus">-        }</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+            if (!request.uri) {</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+                throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+            }</span>
<a href="#l4.949"></a><span id="l4.949"> </span>
<a href="#l4.950"></a><span id="l4.950" class="difflineminus">-        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineminus">-                                     resultCode,</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineminus">-                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineminus">-                                     (item ? item.id : null),</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineminus">-                                     (item ? item : e.message));</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineminus">-    },</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+            request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+                                  JSON.stringify(ItemToJSON(aNewItem, this.offlineStorage)));</span>
<a href="#l4.958"></a><span id="l4.958"> </span>
<a href="#l4.959"></a><span id="l4.959" class="difflineminus">-    /**</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineminus">-     * modifyItem_response</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineminus">-     * Response function, called by the session object when an item was modified</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineminus">-     *</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineminus">-     * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineminus">-     * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineminus">-     *                     an XML representation of the added item.</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">-     */</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineminus">-    modifyItem_response: function cGC_modifyItem_response_onResult(aOperation,</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineminus">-                                                                   aData) {</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineminus">-        let self = this;</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineminus">-        function notifyObserver(item, oldItem) {</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineminus">-            if (item &amp;&amp; item.parentItem != item) {</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineminus">-                item.parentItem.recurrenceInfo.modifyException(item, false);</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-                item = item.parentItem;</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineminus">-                oldItem = oldItem.parentItem;</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+            // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+            let refItem = aOldItem || aNewItem;</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+            let meta = getItemMetadata(this.offlineStorage, refItem) ||</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+                       getItemMetadata(this.offlineStorage, refItem.parentItem);</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+            if (meta &amp;&amp; meta.etag) {</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+                request.addRequestHeader(&quot;If-Match&quot;, meta.etag);</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+            } else {</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+                cal.ERROR(&quot;[calGoogleCalendar] Missing ETag for &quot; + refItem.hashId);</span>
<a href="#l4.983"></a><span id="l4.983">             }</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineminus">-            // Notify Observers</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineminus">-            if (item) {</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineminus">-                self.mObservers.notify(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineminus">-            }</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineminus">-        }</span>
<a href="#l4.989"></a><span id="l4.989"> </span>
<a href="#l4.990"></a><span id="l4.990" class="difflineminus">-        // First, convert the data to an item and make sure no conflicts occurred.</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineminus">-        let newItem, e;</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineminus">-        try {</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineminus">-            newItem = DataToItem(aOperation, aData, this, aOperation.newItem);</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineminus">-            if (!resolveConflicts(aOperation, newItem)) {</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineminus">-                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineminus">-                // request will be sent. bail out here, this method will be</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineminus">-                // called again</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineminus">-                return;</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+            let data;</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+            try {</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+                data = yield this.session.asyncItemRequest(request);</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineplus">+            } catch (e if e.result == calGoogleRequest.CONFLICT_MODIFY ||</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+                          e.result == calGoogleRequest.CONFLICT_DELETED) {</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineplus">+                data = yield checkResolveConflict(request, this, aNewItem);</span>
<a href="#l4.1005"></a><span id="l4.1005">             }</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineminus">-        } catch (exp) {</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineminus">-            newItem = null;</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineminus">-            e = exp;</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineminus">-        }</span>
<a href="#l4.1010"></a><span id="l4.1010"> </span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineminus">-        let resultCode;</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-        if (newItem) {</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + newItem.id + &quot; successful&quot;);</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineminus">-            resultCode = Components.results.NS_OK;</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineminus">-        } else {</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineminus">-            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineminus">-        }</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineminus">-        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineminus">-                                     resultCode,</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineminus">-                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineminus">-                                     (newItem ? newItem.id : null),</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineminus">-                                     (newItem ? newItem : e.message));</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineminus">-    },</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+            // All we need to do now is parse the item and complete the</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+            // operation. The cache layer will take care of adding the item</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+            // to the storage cache.</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+            let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+            let metaData = Object.create(null);</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+            let item = JSONToItem(data, this, defaultTimezone,</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineplus">+                                  this.defaultReminders || [],</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineplus">+                                  aNewItem.clone(), metaData);</span>
<a href="#l4.1034"></a><span id="l4.1034"> </span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineminus">-    /**</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineminus">-     * deleteItem_response</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineminus">-     * Response function, called by the session object when an Item was deleted</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineminus">-     *</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineminus">-     * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineminus">-     * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineminus">-     *                     an XML representation of the added item.</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineminus">-     */</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineminus">-    deleteItem_response: function cGC_deleteItem_response_onResult(aOperation,</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineminus">-                                                                   aData) {</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineminus">-        let item, e;</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineminus">-        try {</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineminus">-            item = DataToItem(aOperation, aData, this, aOperation.oldItem);</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineminus">-            if (!resolveConflicts(aOperation, item)) {</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineminus">-                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineminus">-                // request will be sent. bail out here, this method will be</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineminus">-                // called again</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineminus">-                return;</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineminus">-            }</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineminus">-        } catch (exp) {</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineminus">-            item = null;</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineminus">-            e = exp;</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineminus">-        }</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+            // Make sure to update the etag. Do so before switching to the</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineplus">+            // parent item, as google saves its own etags for changed</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineplus">+            // instances.</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineplus">+            migrateItemMetadata(this.offlineStorage, aOldItem, item, metaData);</span>
<a href="#l4.1062"></a><span id="l4.1062"> </span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineminus">-        let resultCode;</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineminus">-        if (item) {</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineminus">-            this.mObservers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineminus">-            resultCode = Components.results.NS_OK;</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineminus">-        } else {</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineminus">-            resultCode = isCacheException(e) ? Components.results.NS_ERROR_NOT_AVAILABLE : e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineminus">-        }</span>
<a href="#l4.1072"></a><span id="l4.1072" class="difflineminus">-        this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineminus">-                                     resultCode,</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineminus">-                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l4.1075"></a><span id="l4.1075" class="difflineminus">-                                     (item ? item.id : null),</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineminus">-                                     (item ? item : e.message));</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineminus">-    },</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineminus">-</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineminus">-    /**</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineminus">-     * getItem_response</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineminus">-     * Response function, called by the session object when a single Item was</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineminus">-     * downloaded.</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineminus">-     *</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineminus">-     * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineminus">-     * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineminus">-     *                     an XML representation of the added item.</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineminus">-     */</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineminus">-    getItem_response: function cGC_getItem_response_onResult(aOperation,</span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineminus">-                                                             aData) {</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineminus">-        // XXX Due to google issue 399, we need to parse a full feed here.</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineminus">-        try {</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineminus">-            if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineminus">-                throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineplus">+            if (item.recurrenceId) {</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineplus">+                // If we only modified an exception item, then we need to</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineplus">+                // set the parent item and modify the exception.</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineplus">+                let modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineplus">+                if (item.status == &quot;CANCELLED&quot;) {</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineplus">+                    // Canceled means the occurrence is an EXDATE.</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+                    modifiedItem.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+                } else {</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+                    // Not canceled means the occurrence was modified.</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineplus">+                    modifiedItem.recurrenceInfo.modifyException(item, true);</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineplus">+                }</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineplus">+                item = modifiedItem;</span>
<a href="#l4.1106"></a><span id="l4.1106">             }</span>
<a href="#l4.1107"></a><span id="l4.1107"> </span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineminus">-            // A feed was passed back, parse it.</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineminus">-            let xml = cal.xml.parseString(aData);</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineminus">-            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l4.1111"></a><span id="l4.1111" class="difflineminus">-            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineminus">-</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineminus">-            // We might be able to get the full name through this feed's author</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineminus">-            // tags. We need to make sure we have a session for that.</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineminus">-</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineminus">-            // Get the item entry by id.</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineminus">-            let itemXPath = 'atom:feed/atom:entry[substring-before(atom:id/text(), &quot;' + aOperation.itemId + '&quot;)!=&quot;&quot; or gCal:uid/@value=&quot;' + aOperation.itemId + '&quot;]';</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineminus">-            let itemEntry = gdataXPathFirst(xml, itemXPath);</span>
<a href="#l4.1120"></a><span id="l4.1120" class="difflineminus">-            if (!itemEntry) {</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineminus">-                // Item wasn't found. Skip onGetResult and just complete. Not</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineminus">-                // finding an item isn't a user-important error, it may be a</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineminus">-                // wanted case. (i.e itip)</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Item &quot; + aOperation.itemId + &quot; not found in calendar &quot; + this.name);</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineminus">-                throw new Components.Exception(&quot;Item not found&quot;, Components.results.NS_OK);</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineminus">-            }</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineminus">-            let item = XMLEntryToItem(itemEntry, timezone, this);</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineminus">-            item.calendar = this.superCalendar;</span>
<a href="#l4.1129"></a><span id="l4.1129" class="difflineminus">-</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineminus">-            if (item.recurrenceInfo) {</span>
<a href="#l4.1131"></a><span id="l4.1131" class="difflineminus">-                // If this item is recurring, get all exceptions for this item.</span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineminus">-                for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + aOperation.itemId + '&quot;]')) {</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineminus">-                    let excItem = XMLEntryToItem(entry, timezone, this);</span>
<a href="#l4.1134"></a><span id="l4.1134" class="difflineplus">+            throw new Task.Result(item);</span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineplus">+        }.bind(this)).then(function (item) {</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Modifying &quot; + aNewItem.title + &quot; succeeded&quot;);</span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineplus">+            this.observers.notify(&quot;onModifyItem&quot;, [item, aOldItem]);</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineplus">+            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineplus">+                                         cIOL.MODIFY, item.id, item);</span>
<a href="#l4.1140"></a><span id="l4.1140"> </span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineminus">-                    // Google uses the status field to reflect negative</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineminus">-                    // exceptions.</span>
<a href="#l4.1143"></a><span id="l4.1143" class="difflineminus">-                    if (excItem.status == &quot;CANCELED&quot;) {</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineminus">-                        item.recurrenceInfo.removeOccurrenceAt(excItem.recurrenceId);</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineminus">-                    } else {</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineminus">-                        excItem.calendar = this;</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineminus">-                        item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l4.1148"></a><span id="l4.1148" class="difflineminus">-                    }</span>
<a href="#l4.1149"></a><span id="l4.1149" class="difflineminus">-                }</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineplus">+            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineplus">+            if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineplus">+                cal.ERROR(&quot;[calGoogleCalendar] Modifying item &quot; + aNewItem.title +</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineplus">+                          &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l4.1155"></a><span id="l4.1155">             }</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineminus">-            // We are done, notify the listener of our result and that we are</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineminus">-            // done.</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Item &quot; + aOperation.itemId + &quot; was found in calendar &quot; + this.name);</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineminus">-            aOperation.operationListener.onGetResult(this.superCalendar,</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineminus">-                                                     Components.results.NS_OK,</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineminus">-                                                     Components.interfaces.calIEvent,</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineminus">-                                                     null,</span>
<a href="#l4.1163"></a><span id="l4.1163" class="difflineminus">-                                                     1,</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineminus">-                                                     [item]);</span>
<a href="#l4.1165"></a><span id="l4.1165" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.1166"></a><span id="l4.1166" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l4.1167"></a><span id="l4.1167" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.1168"></a><span id="l4.1168" class="difflineminus">-                                         item.id,</span>
<a href="#l4.1169"></a><span id="l4.1169" class="difflineminus">-                                         null);</span>
<a href="#l4.1170"></a><span id="l4.1170" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.1171"></a><span id="l4.1171" class="difflineminus">-            if (!Components.isSuccessCode(e.result)) {</span>
<a href="#l4.1172"></a><span id="l4.1172" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Error getting item &quot; + aOperation.itemId + &quot;:\n&quot; + e);</span>
<a href="#l4.1173"></a><span id="l4.1173" class="difflineminus">-                Components.utils.reportError(e);</span>
<a href="#l4.1174"></a><span id="l4.1174" class="difflineminus">-            }</span>
<a href="#l4.1175"></a><span id="l4.1175" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l4.1176"></a><span id="l4.1176" class="difflineminus">-                                         e.result,</span>
<a href="#l4.1177"></a><span id="l4.1177" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.1178"></a><span id="l4.1178" class="difflineminus">-                                         null,</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineminus">-                                         e.message);</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineminus">-        }</span>
<a href="#l4.1181"></a><span id="l4.1181" class="difflineplus">+            this.notifyPureOperationComplete(aListener, code, cIOL.MODIFY, aNewItem.id, e.message);</span>
<a href="#l4.1182"></a><span id="l4.1182" class="difflineplus">+        }.bind(this));</span>
<a href="#l4.1183"></a><span id="l4.1183" class="difflineplus">+        return request;</span>
<a href="#l4.1184"></a><span id="l4.1184">     },</span>
<a href="#l4.1185"></a><span id="l4.1185"> </span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineminus">-    /**</span>
<a href="#l4.1187"></a><span id="l4.1187" class="difflineminus">-     * getItems_response</span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineminus">-     * Response function, called by the session object when an Item feed was</span>
<a href="#l4.1189"></a><span id="l4.1189" class="difflineminus">-     * downloaded.</span>
<a href="#l4.1190"></a><span id="l4.1190" class="difflineminus">-     *</span>
<a href="#l4.1191"></a><span id="l4.1191" class="difflineminus">-     * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineminus">-     * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l4.1193"></a><span id="l4.1193" class="difflineminus">-     *                     an XML representation of the added item.</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineminus">-     */</span>
<a href="#l4.1195"></a><span id="l4.1195" class="difflineminus">-    getItems_response: function cGC_getItems_response(aOperation, aData) {</span>
<a href="#l4.1196"></a><span id="l4.1196" class="difflineminus">-        // To simplify code, provide a one-stop function to call, independant of</span>
<a href="#l4.1197"></a><span id="l4.1197" class="difflineminus">-        // if and what type of listener was passed.</span>
<a href="#l4.1198"></a><span id="l4.1198" class="difflineminus">-        let listener = aOperation.operationListener ||</span>
<a href="#l4.1199"></a><span id="l4.1199" class="difflineminus">-            { onGetResult: function() {}, onOperationComplete: function() {} };</span>
<a href="#l4.1200"></a><span id="l4.1200" class="difflineplus">+    deleteItem: function(aItem, aListener) {</span>
<a href="#l4.1201"></a><span id="l4.1201" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l4.1202"></a><span id="l4.1202"> </span>
<a href="#l4.1203"></a><span id="l4.1203" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Received response for &quot; + aOperation.uri);</span>
<a href="#l4.1204"></a><span id="l4.1204" class="difflineminus">-        try {</span>
<a href="#l4.1205"></a><span id="l4.1205" class="difflineminus">-            // Check if the call succeeded</span>
<a href="#l4.1206"></a><span id="l4.1206" class="difflineminus">-            if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l4.1207"></a><span id="l4.1207" class="difflineminus">-                throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l4.1208"></a><span id="l4.1208" class="difflineplus">+        let request = new calGoogleRequest();</span>
<a href="#l4.1209"></a><span id="l4.1209" class="difflineplus">+        Task.spawn(function() {</span>
<a href="#l4.1210"></a><span id="l4.1210" class="difflineplus">+            request.type = request.DELETE;</span>
<a href="#l4.1211"></a><span id="l4.1211" class="difflineplus">+            request.calendar = this;</span>
<a href="#l4.1212"></a><span id="l4.1212" class="difflineplus">+            if (cal.isEvent(aItem)) {</span>
<a href="#l4.1213"></a><span id="l4.1213" class="difflineplus">+                request.uri = this.createEventsURI(&quot;events&quot;, getGoogleId(aItem, this.offlineStorage));</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineplus">+                if (Preferences.get(&quot;calendar.google.sendEventNotifications&quot;, false)) {</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineplus">+                    request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l4.1216"></a><span id="l4.1216" class="difflineplus">+                }</span>
<a href="#l4.1217"></a><span id="l4.1217" class="difflineplus">+            } else if (cal.isToDo(aItem)) {</span>
<a href="#l4.1218"></a><span id="l4.1218" class="difflineplus">+                request.uri = this.createTasksURI(&quot;tasks&quot;, aItem.id);</span>
<a href="#l4.1219"></a><span id="l4.1219" class="difflineplus">+            }</span>
<a href="#l4.1220"></a><span id="l4.1220" class="difflineplus">+</span>
<a href="#l4.1221"></a><span id="l4.1221" class="difflineplus">+            if (!request.uri) {</span>
<a href="#l4.1222"></a><span id="l4.1222" class="difflineplus">+                throw Components.Exception(&quot;Item type not supported&quot;,</span>
<a href="#l4.1223"></a><span id="l4.1223" class="difflineplus">+                                           Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l4.1224"></a><span id="l4.1224">             }</span>
<a href="#l4.1225"></a><span id="l4.1225"> </span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineminus">-            // A feed was passed back, parse it.</span>
<a href="#l4.1227"></a><span id="l4.1227" class="difflineminus">-            let xml = cal.xml.parseString(aData);</span>
<a href="#l4.1228"></a><span id="l4.1228" class="difflineminus">-            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l4.1229"></a><span id="l4.1229" class="difflineminus">-            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l4.1230"></a><span id="l4.1230" class="difflineplus">+            // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l4.1231"></a><span id="l4.1231" class="difflineplus">+            let meta = getItemMetadata(this.offlineStorage, aItem) ||</span>
<a href="#l4.1232"></a><span id="l4.1232" class="difflineplus">+                       getItemMetadata(this.offlineStorage, aItem.parentItem);</span>
<a href="#l4.1233"></a><span id="l4.1233" class="difflineplus">+            if (meta &amp;&amp; meta.etag) {</span>
<a href="#l4.1234"></a><span id="l4.1234" class="difflineplus">+                request.addRequestHeader(&quot;If-Match&quot;, meta.etag);</span>
<a href="#l4.1235"></a><span id="l4.1235" class="difflineplus">+            } else {</span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineplus">+                cal.ERROR(&quot;[calGoogleCalendar] Missing ETag for &quot; + aItem.hashId);</span>
<a href="#l4.1237"></a><span id="l4.1237" class="difflineplus">+            }</span>
<a href="#l4.1238"></a><span id="l4.1238"> </span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineminus">-            // We might be able to get the full name through this feed's author</span>
<a href="#l4.1240"></a><span id="l4.1240" class="difflineminus">-            // tags. We need to make sure we have a session for that.</span>
<a href="#l4.1241"></a><span id="l4.1241" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.1242"></a><span id="l4.1242" class="difflineminus">-</span>
<a href="#l4.1243"></a><span id="l4.1243" class="difflineminus">-            if (gdataXPathFirst(xml, 'atom:feed/atom:author/atom:email/text()') == this.mSession.userName) {</span>
<a href="#l4.1244"></a><span id="l4.1244" class="difflineminus">-                // If the current entry contains the user's email, then we can</span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineminus">-                // extract the user's full name also.</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineminus">-                this.mSession.fullName = gdataXPathFirst(xml, 'atom:feed/atom:author/atom:name/text()');</span>
<a href="#l4.1247"></a><span id="l4.1247" class="difflineplus">+            try {</span>
<a href="#l4.1248"></a><span id="l4.1248" class="difflineplus">+                yield this.session.asyncItemRequest(request);</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineplus">+            } catch (e if e.result == calGoogleRequest.CONFLICT_MODIFY ||</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineplus">+                          e.result == calGoogleRequest.CONFLICT_DELETED) {</span>
<a href="#l4.1251"></a><span id="l4.1251" class="difflineplus">+                yield checkResolveConflict(request, this, aItem);</span>
<a href="#l4.1252"></a><span id="l4.1252">             }</span>
<a href="#l4.1253"></a><span id="l4.1253"> </span>
<a href="#l4.1254"></a><span id="l4.1254" class="difflineminus">-            let wantInvitations = ((aOperation.itemFilter &amp;</span>
<a href="#l4.1255"></a><span id="l4.1255" class="difflineminus">-                 Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) != 0);</span>
<a href="#l4.1256"></a><span id="l4.1256" class="difflineminus">-</span>
<a href="#l4.1257"></a><span id="l4.1257" class="difflineminus">-            // Parse all &lt;entry&gt; tags</span>
<a href="#l4.1258"></a><span id="l4.1258" class="difflineminus">-            for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineminus">-                if (gdataXPathFirst(entry, 'gd:originalEvent')) {</span>
<a href="#l4.1260"></a><span id="l4.1260" class="difflineminus">-                    // This is an exception. If we are doing an uncached</span>
<a href="#l4.1261"></a><span id="l4.1261" class="difflineminus">-                    // operation, then skip it for now since it will be parsed</span>
<a href="#l4.1262"></a><span id="l4.1262" class="difflineminus">-                    // later.</span>
<a href="#l4.1263"></a><span id="l4.1263" class="difflineminus">-                    continue;</span>
<a href="#l4.1264"></a><span id="l4.1264" class="difflineminus">-                }</span>
<a href="#l4.1265"></a><span id="l4.1265" class="difflineminus">-</span>
<a href="#l4.1266"></a><span id="l4.1266" class="difflineminus">-                let item = XMLEntryToItem(entry, timezone, this);</span>
<a href="#l4.1267"></a><span id="l4.1267" class="difflineminus">-                item.calendar = this.superCalendar;</span>
<a href="#l4.1268"></a><span id="l4.1268" class="difflineminus">-</span>
<a href="#l4.1269"></a><span id="l4.1269" class="difflineminus">-                if (wantInvitations) {</span>
<a href="#l4.1270"></a><span id="l4.1270" class="difflineminus">-                    // If invitations are wanted and this is not an invitation,</span>
<a href="#l4.1271"></a><span id="l4.1271" class="difflineminus">-                    // or if the user is not an attendee, or has already accepted</span>
<a href="#l4.1272"></a><span id="l4.1272" class="difflineminus">-                    // then this is not an invitation.</span>
<a href="#l4.1273"></a><span id="l4.1273" class="difflineminus">-                    let att = item.getAttendeeById(&quot;mailto:&quot; + this.session.userName);</span>
<a href="#l4.1274"></a><span id="l4.1274" class="difflineminus">-                    if (!this.isInvitation(item) ||</span>
<a href="#l4.1275"></a><span id="l4.1275" class="difflineminus">-                        !att ||</span>
<a href="#l4.1276"></a><span id="l4.1276" class="difflineminus">-                        att.participationStatus != &quot;NEEDS-ACTION&quot;) {</span>
<a href="#l4.1277"></a><span id="l4.1277" class="difflineminus">-                        continue;</span>
<a href="#l4.1278"></a><span id="l4.1278" class="difflineminus">-                    }</span>
<a href="#l4.1279"></a><span id="l4.1279" class="difflineminus">-                }</span>
<a href="#l4.1280"></a><span id="l4.1280" class="difflineminus">-</span>
<a href="#l4.1281"></a><span id="l4.1281" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + cal.xml.serializeDOM(entry) + &quot;\n&quot;);</span>
<a href="#l4.1282"></a><span id="l4.1282" class="difflineminus">-</span>
<a href="#l4.1283"></a><span id="l4.1283" class="difflineminus">-                if (item.recurrenceInfo) {</span>
<a href="#l4.1284"></a><span id="l4.1284" class="difflineminus">-                    // If we are doing an uncached operation, then we need to</span>
<a href="#l4.1285"></a><span id="l4.1285" class="difflineminus">-                    // gather all exceptions and put them into the item.</span>
<a href="#l4.1286"></a><span id="l4.1286" class="difflineminus">-                    // Otherwise, our listener will take care of mapping the</span>
<a href="#l4.1287"></a><span id="l4.1287" class="difflineminus">-                    // exception to the base item.</span>
<a href="#l4.1288"></a><span id="l4.1288" class="difflineminus">-                    for each (let oid in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + item.id + '&quot;]')) {</span>
<a href="#l4.1289"></a><span id="l4.1289" class="difflineminus">-                        // Get specific fields so we can speed up the parsing process</span>
<a href="#l4.1290"></a><span id="l4.1290" class="difflineminus">-                        let status = gdataXPathFirst(oid, 'gd:eventStatus/@value').substring(39);</span>
<a href="#l4.1291"></a><span id="l4.1291" class="difflineplus">+            deleteItemMetadata(this.offlineStorage, aItem);</span>
<a href="#l4.1292"></a><span id="l4.1292"> </span>
<a href="#l4.1293"></a><span id="l4.1293" class="difflineminus">-                        if (status == &quot;canceled&quot;) {</span>
<a href="#l4.1294"></a><span id="l4.1294" class="difflineminus">-                            let rId = gdataXPathFirst(oid, 'gd:when/@startTime');</span>
<a href="#l4.1295"></a><span id="l4.1295" class="difflineminus">-                            let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l4.1296"></a><span id="l4.1296" class="difflineminus">-                            cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l4.1297"></a><span id="l4.1297" class="difflineminus">-                            item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l4.1298"></a><span id="l4.1298" class="difflineminus">-                        } else {</span>
<a href="#l4.1299"></a><span id="l4.1299" class="difflineminus">-                            // Parse the exception and modify the current item</span>
<a href="#l4.1300"></a><span id="l4.1300" class="difflineminus">-                            let excItem = XMLEntryToItem(oid, timezone, this);</span>
<a href="#l4.1301"></a><span id="l4.1301" class="difflineminus">-</span>
<a href="#l4.1302"></a><span id="l4.1302" class="difflineminus">-                            if (excItem) {</span>
<a href="#l4.1303"></a><span id="l4.1303" class="difflineminus">-                                // Google uses the status field to reflect negative</span>
<a href="#l4.1304"></a><span id="l4.1304" class="difflineminus">-                                // exceptions.</span>
<a href="#l4.1305"></a><span id="l4.1305" class="difflineminus">-                                excItem.calendar = this;</span>
<a href="#l4.1306"></a><span id="l4.1306" class="difflineminus">-                                item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l4.1307"></a><span id="l4.1307" class="difflineminus">-                            }</span>
<a href="#l4.1308"></a><span id="l4.1308" class="difflineminus">-                        }</span>
<a href="#l4.1309"></a><span id="l4.1309" class="difflineminus">-                    }</span>
<a href="#l4.1310"></a><span id="l4.1310" class="difflineminus">-                }</span>
<a href="#l4.1311"></a><span id="l4.1311" class="difflineminus">-</span>
<a href="#l4.1312"></a><span id="l4.1312" class="difflineminus">-                item.makeImmutable();</span>
<a href="#l4.1313"></a><span id="l4.1313" class="difflineminus">-                LOGitem(item);</span>
<a href="#l4.1314"></a><span id="l4.1314" class="difflineplus">+            throw new Task.Result(aItem);</span>
<a href="#l4.1315"></a><span id="l4.1315" class="difflineplus">+        }.bind(this)).then(function (item) {</span>
<a href="#l4.1316"></a><span id="l4.1316" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Deleting &quot; + aItem.title + &quot; succeeded&quot;);</span>
<a href="#l4.1317"></a><span id="l4.1317" class="difflineplus">+            this.observers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l4.1318"></a><span id="l4.1318" class="difflineplus">+            this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l4.1319"></a><span id="l4.1319" class="difflineplus">+                                         cIOL.DELETE, item.id, item);</span>
<a href="#l4.1320"></a><span id="l4.1320" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l4.1321"></a><span id="l4.1321" class="difflineplus">+            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.1322"></a><span id="l4.1322" class="difflineplus">+            if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l4.1323"></a><span id="l4.1323" class="difflineplus">+                cal.ERROR(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title +</span>
<a href="#l4.1324"></a><span id="l4.1324" class="difflineplus">+                          &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l4.1325"></a><span id="l4.1325" class="difflineplus">+            }</span>
<a href="#l4.1326"></a><span id="l4.1326" class="difflineplus">+            this.notifyPureOperationComplete(aListener, code, cIOL.DELETE, aItem.id, e.message);</span>
<a href="#l4.1327"></a><span id="l4.1327" class="difflineplus">+        }.bind(this));</span>
<a href="#l4.1328"></a><span id="l4.1328" class="difflineplus">+        return request;</span>
<a href="#l4.1329"></a><span id="l4.1329" class="difflineplus">+    },</span>
<a href="#l4.1330"></a><span id="l4.1330"> </span>
<a href="#l4.1331"></a><span id="l4.1331" class="difflineminus">-                // This is an uncached call, expand the item and tell our</span>
<a href="#l4.1332"></a><span id="l4.1332" class="difflineminus">-                // get listener about the item.</span>
<a href="#l4.1333"></a><span id="l4.1333" class="difflineminus">-                let expandedItems = expandItems(item, aOperation);</span>
<a href="#l4.1334"></a><span id="l4.1334" class="difflineminus">-                listener.onGetResult(this.superCalendar,</span>
<a href="#l4.1335"></a><span id="l4.1335" class="difflineminus">-                                     Components.results.NS_OK,</span>
<a href="#l4.1336"></a><span id="l4.1336" class="difflineminus">-                                     Components.interfaces.calIEvent,</span>
<a href="#l4.1337"></a><span id="l4.1337" class="difflineminus">-                                     null,</span>
<a href="#l4.1338"></a><span id="l4.1338" class="difflineminus">-                                     expandedItems.length,</span>
<a href="#l4.1339"></a><span id="l4.1339" class="difflineminus">-                                     expandedItems);</span>
<a href="#l4.1340"></a><span id="l4.1340" class="difflineminus">-            }</span>
<a href="#l4.1341"></a><span id="l4.1341" class="difflineminus">-            // Operation Completed successfully.</span>
<a href="#l4.1342"></a><span id="l4.1342" class="difflineminus">-            this.notifyOperationComplete(listener,</span>
<a href="#l4.1343"></a><span id="l4.1343" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l4.1344"></a><span id="l4.1344" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.1345"></a><span id="l4.1345" class="difflineminus">-                                         null,</span>
<a href="#l4.1346"></a><span id="l4.1346" class="difflineminus">-                                         null);</span>
<a href="#l4.1347"></a><span id="l4.1347" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.1348"></a><span id="l4.1348" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Error getting items:\n&quot; + e);</span>
<a href="#l4.1349"></a><span id="l4.1349" class="difflineminus">-            this.notifyOperationComplete(listener,</span>
<a href="#l4.1350"></a><span id="l4.1350" class="difflineminus">-                                         e.result,</span>
<a href="#l4.1351"></a><span id="l4.1351" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.1352"></a><span id="l4.1352" class="difflineminus">-                                         null,</span>
<a href="#l4.1353"></a><span id="l4.1353" class="difflineminus">-                                         e.message);</span>
<a href="#l4.1354"></a><span id="l4.1354" class="difflineminus">-        }</span>
<a href="#l4.1355"></a><span id="l4.1355" class="difflineplus">+    getItem: function(aId, aListener) {</span>
<a href="#l4.1356"></a><span id="l4.1356" class="difflineplus">+        this.mOfflineStorage.getItem.apply(this.mOfflineStorage, arguments);</span>
<a href="#l4.1357"></a><span id="l4.1357" class="difflineplus">+    },</span>
<a href="#l4.1358"></a><span id="l4.1358" class="difflineplus">+</span>
<a href="#l4.1359"></a><span id="l4.1359" class="difflineplus">+    getItems: function(aFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l4.1360"></a><span id="l4.1360" class="difflineplus">+        this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l4.1361"></a><span id="l4.1361" class="difflineplus">+    },</span>
<a href="#l4.1362"></a><span id="l4.1362" class="difflineplus">+</span>
<a href="#l4.1363"></a><span id="l4.1363" class="difflineplus">+    refresh: function() {</span>
<a href="#l4.1364"></a><span id="l4.1364" class="difflineplus">+        this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l4.1365"></a><span id="l4.1365">     },</span>
<a href="#l4.1366"></a><span id="l4.1366"> </span>
<a href="#l4.1367"></a><span id="l4.1367">     /**</span>
<a href="#l4.1368"></a><span id="l4.1368">      * Implement calIChangeLog</span>
<a href="#l4.1369"></a><span id="l4.1369">      */</span>
<a href="#l4.1370"></a><span id="l4.1370" class="difflineminus">-    get offlineStorage() {</span>
<a href="#l4.1371"></a><span id="l4.1371" class="difflineminus">-        return this.mOfflineStorage;</span>
<a href="#l4.1372"></a><span id="l4.1372" class="difflineminus">-    },</span>
<a href="#l4.1373"></a><span id="l4.1373" class="difflineminus">-</span>
<a href="#l4.1374"></a><span id="l4.1374" class="difflineplus">+    get offlineStorage() this.mOfflineStorage,</span>
<a href="#l4.1375"></a><span id="l4.1375">     set offlineStorage(val) {</span>
<a href="#l4.1376"></a><span id="l4.1376" class="difflineminus">-        return (this.mOfflineStorage = val);</span>
<a href="#l4.1377"></a><span id="l4.1377" class="difflineminus">-    },</span>
<a href="#l4.1378"></a><span id="l4.1378" class="difflineplus">+        this.mOfflineStorage = val;</span>
<a href="#l4.1379"></a><span id="l4.1379" class="difflineplus">+        let cacheVersion = this.getProperty(&quot;cache.version&quot;);</span>
<a href="#l4.1380"></a><span id="l4.1380" class="difflineplus">+        let resetPromise;</span>
<a href="#l4.1381"></a><span id="l4.1381" class="difflineplus">+        if (cacheVersion &amp;&amp; cacheVersion != this.CACHE_DB_VERSION) {</span>
<a href="#l4.1382"></a><span id="l4.1382" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Migrating cache from &quot; +</span>
<a href="#l4.1383"></a><span id="l4.1383" class="difflineplus">+                    cacheVersion + &quot; to &quot; + this.CACHE_DB_VERSION);</span>
<a href="#l4.1384"></a><span id="l4.1384" class="difflineplus">+            this.resetSync()</span>
<a href="#l4.1385"></a><span id="l4.1385" class="difflineplus">+            resetPromise = this.resetSync();</span>
<a href="#l4.1386"></a><span id="l4.1386" class="difflineplus">+        } else if (!cacheVersion) {</span>
<a href="#l4.1387"></a><span id="l4.1387" class="difflineplus">+            resetPromise = Promise.resolve();</span>
<a href="#l4.1388"></a><span id="l4.1388" class="difflineplus">+        }</span>
<a href="#l4.1389"></a><span id="l4.1389"> </span>
<a href="#l4.1390"></a><span id="l4.1390" class="difflineminus">-    resetLog: function cGC_resetLog() {</span>
<a href="#l4.1391"></a><span id="l4.1391" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l4.1392"></a><span id="l4.1392" class="difflineminus">-        this.deleteProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l4.1393"></a><span id="l4.1393" class="difflineplus">+        if (resetPromise) {</span>
<a href="#l4.1394"></a><span id="l4.1394" class="difflineplus">+            resetPromise.then(function() {</span>
<a href="#l4.1395"></a><span id="l4.1395" class="difflineplus">+                this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l4.1396"></a><span id="l4.1396" class="difflineplus">+            }.bind(this));</span>
<a href="#l4.1397"></a><span id="l4.1397" class="difflineplus">+        }</span>
<a href="#l4.1398"></a><span id="l4.1398" class="difflineplus">+</span>
<a href="#l4.1399"></a><span id="l4.1399" class="difflineplus">+        return val;</span>
<a href="#l4.1400"></a><span id="l4.1400">     },</span>
<a href="#l4.1401"></a><span id="l4.1401"> </span>
<a href="#l4.1402"></a><span id="l4.1402" class="difflineminus">-    replayChangesOn: function cGC_replayChangesOn(aListener) {</span>
<a href="#l4.1403"></a><span id="l4.1403" class="difflineminus">-        let lastUpdate = this.getProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l4.1404"></a><span id="l4.1404" class="difflineminus">-        let lastUpdateDateTime;</span>
<a href="#l4.1405"></a><span id="l4.1405" class="difflineminus">-        if (lastUpdate) {</span>
<a href="#l4.1406"></a><span id="l4.1406" class="difflineminus">-            // Set up the last sync stamp</span>
<a href="#l4.1407"></a><span id="l4.1407" class="difflineminus">-            lastUpdateDateTime = createDateTime();</span>
<a href="#l4.1408"></a><span id="l4.1408" class="difflineminus">-            lastUpdateDateTime.icalString = lastUpdate;</span>
<a href="#l4.1409"></a><span id="l4.1409" class="difflineminus">-</span>
<a href="#l4.1410"></a><span id="l4.1410" class="difflineminus">-            // Set up last week</span>
<a href="#l4.1411"></a><span id="l4.1411" class="difflineminus">-            let lastWeek = getCorrectedDate(now().getInTimezone(UTC()));</span>
<a href="#l4.1412"></a><span id="l4.1412" class="difflineminus">-            lastWeek.day -= 7;</span>
<a href="#l4.1413"></a><span id="l4.1413" class="difflineminus">-            if (lastWeek.compare(lastUpdateDateTime) &gt;= 0) {</span>
<a href="#l4.1414"></a><span id="l4.1414" class="difflineminus">-                // The last sync was longer than a week ago. Google requires a full</span>
<a href="#l4.1415"></a><span id="l4.1415" class="difflineminus">-                // sync in that case. This call also takes care of calling</span>
<a href="#l4.1416"></a><span id="l4.1416" class="difflineminus">-                // resetLog().</span>
<a href="#l4.1417"></a><span id="l4.1417" class="difflineminus">-                this.superCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l4.1418"></a><span id="l4.1418" class="difflineminus">-                lastUpdateDateTime = null;</span>
<a href="#l4.1419"></a><span id="l4.1419" class="difflineminus">-            }</span>
<a href="#l4.1420"></a><span id="l4.1420" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] The calendar &quot; + this.name + &quot; was last modified: &quot; + lastUpdateDateTime);</span>
<a href="#l4.1421"></a><span id="l4.1421" class="difflineminus">-        }</span>
<a href="#l4.1422"></a><span id="l4.1422" class="difflineminus">-</span>
<a href="#l4.1423"></a><span id="l4.1423" class="difflineminus">-        let request = new calGoogleRequest(this.mSession);</span>
<a href="#l4.1424"></a><span id="l4.1424" class="difflineplus">+    resetLog: function() {</span>
<a href="#l4.1425"></a><span id="l4.1425" class="difflineplus">+        this.resetSync().then(function() {</span>
<a href="#l4.1426"></a><span id="l4.1426" class="difflineplus">+            this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l4.1427"></a><span id="l4.1427" class="difflineplus">+        }.bind(this));</span>
<a href="#l4.1428"></a><span id="l4.1428" class="difflineplus">+    },</span>
<a href="#l4.1429"></a><span id="l4.1429"> </span>
<a href="#l4.1430"></a><span id="l4.1430" class="difflineminus">-        request.type = request.GET;</span>
<a href="#l4.1431"></a><span id="l4.1431" class="difflineminus">-        request.uri = this.fullUri.spec</span>
<a href="#l4.1432"></a><span id="l4.1432" class="difflineminus">-        request.destinationCal = this.mOfflineStorage;</span>
<a href="#l4.1433"></a><span id="l4.1433" class="difflineminus">-</span>
<a href="#l4.1434"></a><span id="l4.1434" class="difflineminus">-        let calendar = this;</span>
<a href="#l4.1435"></a><span id="l4.1435" class="difflineminus">-        request.responseListener = { onResult: this.syncItems_response.bind(this, (lastUpdateDateTime == null)) }</span>
<a href="#l4.1436"></a><span id="l4.1436" class="difflineminus">-        request.operationListener = aListener;</span>
<a href="#l4.1437"></a><span id="l4.1437" class="difflineminus">-        request.calendar = this;</span>
<a href="#l4.1438"></a><span id="l4.1438" class="difflineminus">-</span>
<a href="#l4.1439"></a><span id="l4.1439" class="difflineminus">-        // Request Parameters</span>
<a href="#l4.1440"></a><span id="l4.1440" class="difflineminus">-        request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l4.1441"></a><span id="l4.1441" class="difflineminus">-        request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l4.1442"></a><span id="l4.1442" class="difflineminus">-        request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l4.1443"></a><span id="l4.1443" class="difflineminus">-</span>
<a href="#l4.1444"></a><span id="l4.1444" class="difflineminus">-        if (lastUpdateDateTime) {</span>
<a href="#l4.1445"></a><span id="l4.1445" class="difflineminus">-            // Partial sync requires sending updated-min</span>
<a href="#l4.1446"></a><span id="l4.1446" class="difflineminus">-            request.addQueryParameter(&quot;updated-min&quot;, cal.toRFC3339(lastUpdateDateTime));</span>
<a href="#l4.1447"></a><span id="l4.1447" class="difflineminus">-        }</span>
<a href="#l4.1448"></a><span id="l4.1448" class="difflineminus">-</span>
<a href="#l4.1449"></a><span id="l4.1449" class="difflineminus">-        // Request the item. The response function is ready to take care of both</span>
<a href="#l4.1450"></a><span id="l4.1450" class="difflineminus">-        // uncached getItem requests and this type of synchronization request.</span>
<a href="#l4.1451"></a><span id="l4.1451" class="difflineminus">-        this.mSession.asyncItemRequest(request);</span>
<a href="#l4.1452"></a><span id="l4.1452" class="difflineplus">+    resetSync: function() {</span>
<a href="#l4.1453"></a><span id="l4.1453" class="difflineplus">+        let deferred = Promise.defer();</span>
<a href="#l4.1454"></a><span id="l4.1454" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l4.1455"></a><span id="l4.1455" class="difflineplus">+        this.setProperty(&quot;syncToken.events&quot;, &quot;&quot;);</span>
<a href="#l4.1456"></a><span id="l4.1456" class="difflineplus">+        this.setProperty(&quot;lastUpdated.tasks&quot;, &quot;&quot;);</span>
<a href="#l4.1457"></a><span id="l4.1457" class="difflineplus">+        this.mThrottle = Object.create(null);</span>
<a href="#l4.1458"></a><span id="l4.1458" class="difflineplus">+        this.mOfflineStorage.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l4.1459"></a><span id="l4.1459" class="difflineplus">+                            .deleteCalendar(this.mOfflineStorage, {</span>
<a href="#l4.1460"></a><span id="l4.1460" class="difflineplus">+            onDeleteCalendar: function(aCalendar, aStatus, aDetal) {</span>
<a href="#l4.1461"></a><span id="l4.1461" class="difflineplus">+                if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l4.1462"></a><span id="l4.1462" class="difflineplus">+                    deferred.resolve();</span>
<a href="#l4.1463"></a><span id="l4.1463" class="difflineplus">+                } else {</span>
<a href="#l4.1464"></a><span id="l4.1464" class="difflineplus">+                    deferred.reject(aDetail);</span>
<a href="#l4.1465"></a><span id="l4.1465" class="difflineplus">+                }</span>
<a href="#l4.1466"></a><span id="l4.1466" class="difflineplus">+            }</span>
<a href="#l4.1467"></a><span id="l4.1467" class="difflineplus">+       });</span>
<a href="#l4.1468"></a><span id="l4.1468" class="difflineplus">+       return deferred.promise;</span>
<a href="#l4.1469"></a><span id="l4.1469">     },</span>
<a href="#l4.1470"></a><span id="l4.1470"> </span>
<a href="#l4.1471"></a><span id="l4.1471" class="difflineminus">-    /**</span>
<a href="#l4.1472"></a><span id="l4.1472" class="difflineminus">-     * syncItems_response</span>
<a href="#l4.1473"></a><span id="l4.1473" class="difflineminus">-     * Response function, called by the session object when an Item feed was</span>
<a href="#l4.1474"></a><span id="l4.1474" class="difflineminus">-     * downloaded.</span>
<a href="#l4.1475"></a><span id="l4.1475" class="difflineminus">-     *</span>
<a href="#l4.1476"></a><span id="l4.1476" class="difflineminus">-     * @param aIsFullSync   If set, this is a full sync rather than an update.</span>
<a href="#l4.1477"></a><span id="l4.1477" class="difflineminus">-     * @param aOperation    The calIGoogleRequest processing the request</span>
<a href="#l4.1478"></a><span id="l4.1478" class="difflineminus">-     * @param aData         In case of an error, this is the error string, otherwise</span>
<a href="#l4.1479"></a><span id="l4.1479" class="difflineminus">-     *                        an XML representation of the added item.</span>
<a href="#l4.1480"></a><span id="l4.1480" class="difflineminus">-     */</span>
<a href="#l4.1481"></a><span id="l4.1481" class="difflineminus">-    syncItems_response: function cGC_syncItems_response(aIsFullSync, aOperation, aData) {</span>
<a href="#l4.1482"></a><span id="l4.1482" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Received response for &quot; + aOperation.uri + (aIsFullSync ? &quot; (full sync)&quot; : &quot;&quot;));</span>
<a href="#l4.1483"></a><span id="l4.1483" class="difflineminus">-        try {</span>
<a href="#l4.1484"></a><span id="l4.1484" class="difflineminus">-            // Check if the call succeeded</span>
<a href="#l4.1485"></a><span id="l4.1485" class="difflineminus">-            if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l4.1486"></a><span id="l4.1486" class="difflineminus">-                throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l4.1487"></a><span id="l4.1487" class="difflineminus">-            }</span>
<a href="#l4.1488"></a><span id="l4.1488" class="difflineplus">+    replayChangesOn: function(aListener) {</span>
<a href="#l4.1489"></a><span id="l4.1489" class="difflineplus">+        // Figure out if the user is idle, no need to synchronize if so.</span>
<a href="#l4.1490"></a><span id="l4.1490" class="difflineplus">+        let idleTime = Components.classes[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l4.1491"></a><span id="l4.1491" class="difflineplus">+                                 .getService(Components.interfaces.nsIIdleService)</span>
<a href="#l4.1492"></a><span id="l4.1492" class="difflineplus">+                                 .idleTime;</span>
<a href="#l4.1493"></a><span id="l4.1493" class="difflineplus">+        let maxIdleTime = Preferences.get(&quot;calendar.google.idleTime&quot;, 300) * 1000;</span>
<a href="#l4.1494"></a><span id="l4.1494"> </span>
<a href="#l4.1495"></a><span id="l4.1495" class="difflineminus">-            // A feed was passed back, parse it.</span>
<a href="#l4.1496"></a><span id="l4.1496" class="difflineminus">-            let xml = cal.xml.parseString(aData);</span>
<a href="#l4.1497"></a><span id="l4.1497" class="difflineminus">-            let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l4.1498"></a><span id="l4.1498" class="difflineminus">-            let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l4.1499"></a><span id="l4.1499" class="difflineminus">-</span>
<a href="#l4.1500"></a><span id="l4.1500" class="difflineminus">-            // We might be able to get the full name through this feed's author</span>
<a href="#l4.1501"></a><span id="l4.1501" class="difflineminus">-            // tags. We need to make sure we have a session for that.</span>
<a href="#l4.1502"></a><span id="l4.1502" class="difflineminus">-            this.ensureSession();</span>
<a href="#l4.1503"></a><span id="l4.1503" class="difflineplus">+        if (maxIdleTime != 0 &amp;&amp; idleTime &gt; maxIdleTime) {</span>
<a href="#l4.1504"></a><span id="l4.1504" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Skipping refresh since user is idle&quot;);</span>
<a href="#l4.1505"></a><span id="l4.1505" class="difflineplus">+            aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l4.1506"></a><span id="l4.1506" class="difflineplus">+            return Promise.resolve();</span>
<a href="#l4.1507"></a><span id="l4.1507" class="difflineplus">+        }</span>
<a href="#l4.1508"></a><span id="l4.1508"> </span>
<a href="#l4.1509"></a><span id="l4.1509" class="difflineminus">-            if (gdataXPathFirst(xml, 'atom:feed/atom:author/atom:email/text()') == this.mSession.userName) {</span>
<a href="#l4.1510"></a><span id="l4.1510" class="difflineminus">-                // If the current entry contains the user's email, then we can</span>
<a href="#l4.1511"></a><span id="l4.1511" class="difflineminus">-                // extract the user's full name also.</span>
<a href="#l4.1512"></a><span id="l4.1512" class="difflineminus">-                this.mSession.fullName = gdataXPathFirst(xml, 'atom:feed/atom:author/atom:name/text()');</span>
<a href="#l4.1513"></a><span id="l4.1513" class="difflineminus">-            }</span>
<a href="#l4.1514"></a><span id="l4.1514" class="difflineminus">-</span>
<a href="#l4.1515"></a><span id="l4.1515" class="difflineminus">-            // This is the calendar we should sync changes into.</span>
<a href="#l4.1516"></a><span id="l4.1516" class="difflineminus">-            let destinationCal = aOperation.destinationCal;</span>
<a href="#l4.1517"></a><span id="l4.1517" class="difflineplus">+        // Now that we've determined we are not idle we can continue with the sync.</span>
<a href="#l4.1518"></a><span id="l4.1518" class="difflineplus">+        let maxResults = Preferences.get(&quot;calendar.google.maxResultsPerRequest&quot;, null);</span>
<a href="#l4.1519"></a><span id="l4.1519"> </span>
<a href="#l4.1520"></a><span id="l4.1520" class="difflineminus">-            for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l4.1521"></a><span id="l4.1521" class="difflineminus">-                let recurrenceId = getRecurrenceIdFromEntry(entry, timezone);</span>
<a href="#l4.1522"></a><span id="l4.1522" class="difflineminus">-                if (aIsFullSync &amp;&amp; recurrenceId) {</span>
<a href="#l4.1523"></a><span id="l4.1523" class="difflineminus">-                    // On a full sync, we parse exceptions different.</span>
<a href="#l4.1524"></a><span id="l4.1524" class="difflineminus">-                    continue;</span>
<a href="#l4.1525"></a><span id="l4.1525" class="difflineminus">-                }</span>
<a href="#l4.1526"></a><span id="l4.1526" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l4.1527"></a><span id="l4.1527" class="difflineminus">-</span>
<a href="#l4.1528"></a><span id="l4.1528" class="difflineminus">-                let referenceItemObj = {}</span>
<a href="#l4.1529"></a><span id="l4.1529" class="difflineminus">-                destinationCal.getItem(getIdFromEntry(entry),</span>
<a href="#l4.1530"></a><span id="l4.1530" class="difflineminus">-                                       new syncSetter(referenceItemObj));</span>
<a href="#l4.1531"></a><span id="l4.1531" class="difflineminus">-                let referenceItem = referenceItemObj.value &amp;&amp;</span>
<a href="#l4.1532"></a><span id="l4.1532" class="difflineminus">-                                    referenceItemObj.value.clone();</span>
<a href="#l4.1533"></a><span id="l4.1533" class="difflineminus">-</span>
<a href="#l4.1534"></a><span id="l4.1534" class="difflineminus">-                // Parse the item. If we got a reference item from the storage</span>
<a href="#l4.1535"></a><span id="l4.1535" class="difflineminus">-                // calendar, put that in to make sure we get all exceptions and</span>
<a href="#l4.1536"></a><span id="l4.1536" class="difflineminus">-                // such.</span>
<a href="#l4.1537"></a><span id="l4.1537" class="difflineminus">-                let item = XMLEntryToItem(entry,</span>
<a href="#l4.1538"></a><span id="l4.1538" class="difflineminus">-                                          timezone,</span>
<a href="#l4.1539"></a><span id="l4.1539" class="difflineminus">-                                          this,</span>
<a href="#l4.1540"></a><span id="l4.1540" class="difflineminus">-                                          (recurrenceId &amp;&amp; referenceItem ? null : referenceItem));</span>
<a href="#l4.1541"></a><span id="l4.1541" class="difflineminus">-                item.calendar = this.superCalendar;</span>
<a href="#l4.1542"></a><span id="l4.1542" class="difflineplus">+        // We are going to be making potentially lots of changes to the offline</span>
<a href="#l4.1543"></a><span id="l4.1543" class="difflineplus">+        // storage, start a batch operation.</span>
<a href="#l4.1544"></a><span id="l4.1544" class="difflineplus">+        this.mOfflineStorage.startBatch();</span>
<a href="#l4.1545"></a><span id="l4.1545"> </span>
<a href="#l4.1546"></a><span id="l4.1546" class="difflineminus">-                if (aIsFullSync &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l4.1547"></a><span id="l4.1547" class="difflineminus">-                    // On a full synchronization, we can go ahead and pre-parse</span>
<a href="#l4.1548"></a><span id="l4.1548" class="difflineminus">-                    // all exceptions and then add the item at once. This way we</span>
<a href="#l4.1549"></a><span id="l4.1549" class="difflineminus">-                    // make sure</span>
<a href="#l4.1550"></a><span id="l4.1550" class="difflineminus">-                    for each (let oid in gdataXPath(xml, 'atom:feed/atom:entry[gd:originalEvent/@id=&quot;' + item.id + '&quot;]')) {</span>
<a href="#l4.1551"></a><span id="l4.1551" class="difflineminus">-                        // Get specific fields so we can speed up the parsing process</span>
<a href="#l4.1552"></a><span id="l4.1552" class="difflineminus">-                        let status = gdataXPathFirst(oid, 'gd:eventStatus/@value').substring(39);</span>
<a href="#l4.1553"></a><span id="l4.1553" class="difflineminus">-</span>
<a href="#l4.1554"></a><span id="l4.1554" class="difflineminus">-                        if (status == &quot;canceled&quot;) {</span>
<a href="#l4.1555"></a><span id="l4.1555" class="difflineminus">-                            let rId = gdataXPathFirst(oid, 'gd:when/@startTime');</span>
<a href="#l4.1556"></a><span id="l4.1556" class="difflineminus">-                            let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l4.1557"></a><span id="l4.1557" class="difflineminus">-                            item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l4.1558"></a><span id="l4.1558" class="difflineminus">-                            cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l4.1559"></a><span id="l4.1559" class="difflineminus">-                        } else {</span>
<a href="#l4.1560"></a><span id="l4.1560" class="difflineminus">-                            // Parse the exception and modify the current item</span>
<a href="#l4.1561"></a><span id="l4.1561" class="difflineminus">-                            let excItem = XMLEntryToItem(oid, timezone, this);</span>
<a href="#l4.1562"></a><span id="l4.1562" class="difflineminus">-</span>
<a href="#l4.1563"></a><span id="l4.1563" class="difflineminus">-                            if (excItem) {</span>
<a href="#l4.1564"></a><span id="l4.1564" class="difflineminus">-                                // Google uses the status field to reflect negative</span>
<a href="#l4.1565"></a><span id="l4.1565" class="difflineminus">-                                // exceptions.</span>
<a href="#l4.1566"></a><span id="l4.1566" class="difflineminus">-                                excItem.calendar = this;</span>
<a href="#l4.1567"></a><span id="l4.1567" class="difflineminus">-                                item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l4.1568"></a><span id="l4.1568" class="difflineminus">-                            }</span>
<a href="#l4.1569"></a><span id="l4.1569" class="difflineminus">-                        }</span>
<a href="#l4.1570"></a><span id="l4.1570" class="difflineminus">-                    }</span>
<a href="#l4.1571"></a><span id="l4.1571" class="difflineplus">+        // Update the calendar settings</span>
<a href="#l4.1572"></a><span id="l4.1572" class="difflineplus">+        let calendarPromise = Promise.resolve();</span>
<a href="#l4.1573"></a><span id="l4.1573" class="difflineplus">+        if (this.mCalendarName &amp;&amp; this.checkThrottle(&quot;calendarList&quot;)) {</span>
<a href="#l4.1574"></a><span id="l4.1574" class="difflineplus">+            let calendarRequest = new calGoogleRequest();</span>
<a href="#l4.1575"></a><span id="l4.1575" class="difflineplus">+            calendarRequest.calendar = this;</span>
<a href="#l4.1576"></a><span id="l4.1576" class="difflineplus">+            calendarRequest.type = calendarRequest.GET;</span>
<a href="#l4.1577"></a><span id="l4.1577" class="difflineplus">+            calendarRequest.uri = this.createUsersURI(&quot;calendarList&quot;, this.mCalendarName)</span>
<a href="#l4.1578"></a><span id="l4.1578" class="difflineplus">+            calendarPromise = this.session.asyncItemRequest(calendarRequest).then(function(aData) {</span>
<a href="#l4.1579"></a><span id="l4.1579" class="difflineplus">+                if (aData.defaultReminders) {</span>
<a href="#l4.1580"></a><span id="l4.1580" class="difflineplus">+                    this.defaultReminders = aData.defaultReminders.map(function(x) JSONToAlarm(x, true));</span>
<a href="#l4.1581"></a><span id="l4.1581" class="difflineplus">+                } else {</span>
<a href="#l4.1582"></a><span id="l4.1582" class="difflineplus">+                    this.defaultReminders = [];</span>
<a href="#l4.1583"></a><span id="l4.1583">                 }</span>
<a href="#l4.1584"></a><span id="l4.1584"> </span>
<a href="#l4.1585"></a><span id="l4.1585" class="difflineminus">-                LOGitem(item);</span>
<a href="#l4.1586"></a><span id="l4.1586" class="difflineplus">+                for each (let k in [&quot;accessRole&quot;, &quot;backgroundColor&quot;, &quot;description&quot;,</span>
<a href="#l4.1587"></a><span id="l4.1587" class="difflineplus">+                                    &quot;foregroundColor&quot;, &quot;location&quot;, &quot;primary&quot;,</span>
<a href="#l4.1588"></a><span id="l4.1588" class="difflineplus">+                                    &quot;summary&quot;, &quot;summaryOverride&quot;, &quot;timeZone&quot;]) {</span>
<a href="#l4.1589"></a><span id="l4.1589" class="difflineplus">+                    this.setProperty(&quot;settings.&quot; + k, aData[k]);</span>
<a href="#l4.1590"></a><span id="l4.1590" class="difflineplus">+                }</span>
<a href="#l4.1591"></a><span id="l4.1591" class="difflineplus">+                this.setProperty(&quot;settings.defaultReminders&quot;, JSON.stringify(aData.defaultReminders));</span>
<a href="#l4.1592"></a><span id="l4.1592" class="difflineplus">+            }.bind(this));</span>
<a href="#l4.1593"></a><span id="l4.1593" class="difflineplus">+        }</span>
<a href="#l4.1594"></a><span id="l4.1594" class="difflineplus">+</span>
<a href="#l4.1595"></a><span id="l4.1595" class="difflineplus">+        // Set up a request for the events</span>
<a href="#l4.1596"></a><span id="l4.1596" class="difflineplus">+        let eventsRequest = new calGoogleRequest();</span>
<a href="#l4.1597"></a><span id="l4.1597" class="difflineplus">+        let eventsPromise = Promise.resolve();</span>
<a href="#l4.1598"></a><span id="l4.1598" class="difflineplus">+        eventsRequest.calendar = this;</span>
<a href="#l4.1599"></a><span id="l4.1599" class="difflineplus">+        eventsRequest.type = eventsRequest.GET;</span>
<a href="#l4.1600"></a><span id="l4.1600" class="difflineplus">+        eventsRequest.uri = this.createEventsURI(&quot;events&quot;);</span>
<a href="#l4.1601"></a><span id="l4.1601" class="difflineplus">+        eventsRequest.addQueryParameter(&quot;timeZone&quot;, cal.calendarDefaultTimezone().tzid);</span>
<a href="#l4.1602"></a><span id="l4.1602" class="difflineplus">+        eventsRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l4.1603"></a><span id="l4.1603" class="difflineplus">+        let syncToken = this.getProperty(&quot;syncToken.events&quot;);</span>
<a href="#l4.1604"></a><span id="l4.1604" class="difflineplus">+        if (syncToken) {</span>
<a href="#l4.1605"></a><span id="l4.1605" class="difflineplus">+            eventsRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l4.1606"></a><span id="l4.1606" class="difflineplus">+            eventsRequest.addQueryParameter(&quot;syncToken&quot;, syncToken);</span>
<a href="#l4.1607"></a><span id="l4.1607" class="difflineplus">+        }</span>
<a href="#l4.1608"></a><span id="l4.1608" class="difflineplus">+        if (eventsRequest.uri &amp;&amp; this.checkThrottle(&quot;events&quot;)) {</span>
<a href="#l4.1609"></a><span id="l4.1609" class="difflineplus">+            let saver = new ItemSaver(this);</span>
<a href="#l4.1610"></a><span id="l4.1610" class="difflineplus">+            eventsPromise = this.session.asyncPaginatedRequest(eventsRequest, null, function(aData) {</span>
<a href="#l4.1611"></a><span id="l4.1611" class="difflineplus">+                // On each request...</span>
<a href="#l4.1612"></a><span id="l4.1612" class="difflineplus">+                saver.parseItemStream(aData);</span>
<a href="#l4.1613"></a><span id="l4.1613" class="difflineplus">+            }.bind(this), function(aData) {</span>
<a href="#l4.1614"></a><span id="l4.1614" class="difflineplus">+                // On last request...</span>
<a href="#l4.1615"></a><span id="l4.1615" class="difflineplus">+                saver.processRemainingExceptions();</span>
<a href="#l4.1616"></a><span id="l4.1616" class="difflineplus">+</span>
<a href="#l4.1617"></a><span id="l4.1617" class="difflineplus">+                if (aData.nextSyncToken) {</span>
<a href="#l4.1618"></a><span id="l4.1618" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] New sync token for &quot; +</span>
<a href="#l4.1619"></a><span id="l4.1619" class="difflineplus">+                            this.name + &quot;(events) is now: &quot; + aData.nextSyncToken);</span>
<a href="#l4.1620"></a><span id="l4.1620" class="difflineplus">+                    this.setProperty(&quot;syncToken.events&quot;, aData.nextSyncToken);</span>
<a href="#l4.1621"></a><span id="l4.1621" class="difflineplus">+                }</span>
<a href="#l4.1622"></a><span id="l4.1622" class="difflineplus">+            }.bind(this));</span>
<a href="#l4.1623"></a><span id="l4.1623" class="difflineplus">+        }</span>
<a href="#l4.1624"></a><span id="l4.1624"> </span>
<a href="#l4.1625"></a><span id="l4.1625" class="difflineminus">-                if (!aIsFullSync &amp;&amp; item.recurrenceId &amp;&amp; referenceItem) {</span>
<a href="#l4.1626"></a><span id="l4.1626" class="difflineminus">-                    // This is a single occurrence that has been updated.</span>
<a href="#l4.1627"></a><span id="l4.1627" class="difflineminus">-                    if (item.status == &quot;CANCELED&quot;) {</span>
<a href="#l4.1628"></a><span id="l4.1628" class="difflineminus">-                        // Canceled means the occurrence is an EXDATE.</span>
<a href="#l4.1629"></a><span id="l4.1629" class="difflineminus">-                        referenceItem.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l4.1630"></a><span id="l4.1630" class="difflineminus">-                    } else {</span>
<a href="#l4.1631"></a><span id="l4.1631" class="difflineminus">-                        // Not canceled means the occurrence was modified.</span>
<a href="#l4.1632"></a><span id="l4.1632" class="difflineminus">-                        item.parentItem = referenceItem;</span>
<a href="#l4.1633"></a><span id="l4.1633" class="difflineminus">-                        referenceItem.recurrenceInfo.modifyException(item, true);</span>
<a href="#l4.1634"></a><span id="l4.1634" class="difflineminus">-                    }</span>
<a href="#l4.1635"></a><span id="l4.1635" class="difflineminus">-                    destinationCal.modifyItem(referenceItem, null, null);</span>
<a href="#l4.1636"></a><span id="l4.1636" class="difflineminus">-                } else if (!item.recurrenceId) {</span>
<a href="#l4.1637"></a><span id="l4.1637" class="difflineminus">-                    // This is a normal item. If it was canceled, then it should</span>
<a href="#l4.1638"></a><span id="l4.1638" class="difflineminus">-                    // be deleted, otherwise it should be either added or</span>
<a href="#l4.1639"></a><span id="l4.1639" class="difflineminus">-                    // modified. The relaxed mode of the destination calendar</span>
<a href="#l4.1640"></a><span id="l4.1640" class="difflineminus">-                    // takes care of the latter two cases.</span>
<a href="#l4.1641"></a><span id="l4.1641" class="difflineminus">-                    if (item.status == &quot;CANCELED&quot;) {</span>
<a href="#l4.1642"></a><span id="l4.1642" class="difflineminus">-                        destinationCal.deleteItem(item, null);</span>
<a href="#l4.1643"></a><span id="l4.1643" class="difflineminus">-                    } else {</span>
<a href="#l4.1644"></a><span id="l4.1644" class="difflineminus">-                        destinationCal.modifyItem(item, null, null);</span>
<a href="#l4.1645"></a><span id="l4.1645" class="difflineminus">-                    }</span>
<a href="#l4.1646"></a><span id="l4.1646" class="difflineminus">-                } else {</span>
<a href="#l4.1647"></a><span id="l4.1647" class="difflineminus">-                    // We could not find the parent item for the occurrence in</span>
<a href="#l4.1648"></a><span id="l4.1648" class="difflineminus">-                    // the feed.</span>
<a href="#l4.1649"></a><span id="l4.1649" class="difflineminus">-                    WARN(&quot;occurrence without parent for item &quot;  + item.id);</span>
<a href="#l4.1650"></a><span id="l4.1650" class="difflineminus">-                }</span>
<a href="#l4.1651"></a><span id="l4.1651" class="difflineplus">+        // Set up a request for tasks</span>
<a href="#l4.1652"></a><span id="l4.1652" class="difflineplus">+        let tasksRequest = new calGoogleRequest();</span>
<a href="#l4.1653"></a><span id="l4.1653" class="difflineplus">+        let tasksPromise = Promise.resolve();</span>
<a href="#l4.1654"></a><span id="l4.1654" class="difflineplus">+        tasksRequest.calendar = this;</span>
<a href="#l4.1655"></a><span id="l4.1655" class="difflineplus">+        tasksRequest.type = tasksRequest.GET;</span>
<a href="#l4.1656"></a><span id="l4.1656" class="difflineplus">+        tasksRequest.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l4.1657"></a><span id="l4.1657" class="difflineplus">+        tasksRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l4.1658"></a><span id="l4.1658" class="difflineplus">+        let lastUpdated = this.getUpdatedMin(&quot;tasks&quot;);</span>
<a href="#l4.1659"></a><span id="l4.1659" class="difflineplus">+        if (lastUpdated) {</span>
<a href="#l4.1660"></a><span id="l4.1660" class="difflineplus">+            tasksRequest.addQueryParameter(&quot;updatedMin&quot;, cal.toRFC3339(lastUpdated));</span>
<a href="#l4.1661"></a><span id="l4.1661" class="difflineplus">+            tasksRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l4.1662"></a><span id="l4.1662" class="difflineplus">+        }</span>
<a href="#l4.1663"></a><span id="l4.1663" class="difflineplus">+        if (tasksRequest.uri &amp;&amp; this.checkThrottle(&quot;tasks&quot;)) {</span>
<a href="#l4.1664"></a><span id="l4.1664" class="difflineplus">+            let saver = new ItemSaver(this);</span>
<a href="#l4.1665"></a><span id="l4.1665" class="difflineplus">+            tasksPromise = this.session.asyncPaginatedRequest(tasksRequest, function(aData) {</span>
<a href="#l4.1666"></a><span id="l4.1666" class="difflineplus">+                // On the first request...</span>
<a href="#l4.1667"></a><span id="l4.1667" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name +</span>
<a href="#l4.1668"></a><span id="l4.1668" class="difflineplus">+                        &quot;(tasks) is now: &quot; + tasksRequest.requestDate.toString());</span>
<a href="#l4.1669"></a><span id="l4.1669" class="difflineplus">+                let lastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l4.1670"></a><span id="l4.1670" class="difflineplus">+                this.setProperty(&quot;lastUpdated.tasks&quot;, lastUpdated);</span>
<a href="#l4.1671"></a><span id="l4.1671" class="difflineplus">+            }.bind(this), function(aData) {</span>
<a href="#l4.1672"></a><span id="l4.1672" class="difflineplus">+                // On each request...</span>
<a href="#l4.1673"></a><span id="l4.1673" class="difflineplus">+                saver.parseItemStream(aData);</span>
<a href="#l4.1674"></a><span id="l4.1674" class="difflineplus">+            }.bind(this));</span>
<a href="#l4.1675"></a><span id="l4.1675" class="difflineplus">+        }</span>
<a href="#l4.1676"></a><span id="l4.1676" class="difflineplus">+</span>
<a href="#l4.1677"></a><span id="l4.1677" class="difflineplus">+        return PromiseAll([calendarPromise, eventsPromise, tasksPromise]).then(function() {</span>
<a href="#l4.1678"></a><span id="l4.1678" class="difflineplus">+            this.mOfflineStorage.endBatch();</span>
<a href="#l4.1679"></a><span id="l4.1679" class="difflineplus">+            aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l4.1680"></a><span id="l4.1680" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l4.1681"></a><span id="l4.1681" class="difflineplus">+            this.mOfflineStorage.endBatch();</span>
<a href="#l4.1682"></a><span id="l4.1682" class="difflineplus">+            let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.1683"></a><span id="l4.1683" class="difflineplus">+            if (code == calGoogleRequest.RESOURCE_GONE) {</span>
<a href="#l4.1684"></a><span id="l4.1684" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Server did not accept &quot; +</span>
<a href="#l4.1685"></a><span id="l4.1685" class="difflineplus">+                        &quot;incremental update, resetting calendar and &quot; +</span>
<a href="#l4.1686"></a><span id="l4.1686" class="difflineplus">+                        &quot;starting over.&quot;);</span>
<a href="#l4.1687"></a><span id="l4.1687" class="difflineplus">+                this.resetSync().then(function() {</span>
<a href="#l4.1688"></a><span id="l4.1688" class="difflineplus">+                    this.replayChangesOn(aListener);</span>
<a href="#l4.1689"></a><span id="l4.1689" class="difflineplus">+                }.bind(this));</span>
<a href="#l4.1690"></a><span id="l4.1690" class="difflineplus">+            } else {</span>
<a href="#l4.1691"></a><span id="l4.1691" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Error syncing:\n&quot; + code + &quot;:&quot; +</span>
<a href="#l4.1692"></a><span id="l4.1692" class="difflineplus">+                        stringException(e));</span>
<a href="#l4.1693"></a><span id="l4.1693" class="difflineplus">+                aListener.onResult({ status: code }, e.message);</span>
<a href="#l4.1694"></a><span id="l4.1694">             }</span>
<a href="#l4.1695"></a><span id="l4.1695" class="difflineminus">-</span>
<a href="#l4.1696"></a><span id="l4.1696" class="difflineminus">-            // Set the last updated timestamp to now.</span>
<a href="#l4.1697"></a><span id="l4.1697" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name + &quot; is now: &quot; +</span>
<a href="#l4.1698"></a><span id="l4.1698" class="difflineminus">-                    aOperation.requestDate.toString());</span>
<a href="#l4.1699"></a><span id="l4.1699" class="difflineminus">-            this.setProperty(&quot;google.lastUpdated&quot;,</span>
<a href="#l4.1700"></a><span id="l4.1700" class="difflineminus">-                             aOperation.requestDate.icalString);</span>
<a href="#l4.1701"></a><span id="l4.1701" class="difflineminus">-</span>
<a href="#l4.1702"></a><span id="l4.1702" class="difflineminus">-            // Tell our listener we are done.</span>
<a href="#l4.1703"></a><span id="l4.1703" class="difflineminus">-            aOperation.operationListener.onResult(aOperation, null);</span>
<a href="#l4.1704"></a><span id="l4.1704" class="difflineminus">-        } catch (e) {</span>
<a href="#l4.1705"></a><span id="l4.1705" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Error syncing items:\n&quot; + e);</span>
<a href="#l4.1706"></a><span id="l4.1706" class="difflineminus">-            aOperation.operationListener.onResult({ status: e.result }, e.message);</span>
<a href="#l4.1707"></a><span id="l4.1707" class="difflineminus">-        }</span>
<a href="#l4.1708"></a><span id="l4.1708" class="difflineplus">+        }.bind(this));</span>
<a href="#l4.1709"></a><span id="l4.1709">     },</span>
<a href="#l4.1710"></a><span id="l4.1710"> </span>
<a href="#l4.1711"></a><span id="l4.1711">     /**</span>
<a href="#l4.1712"></a><span id="l4.1712">      * Implement calISchedulingSupport. Most is taken care of by the base</span>
<a href="#l4.1713"></a><span id="l4.1713">      * provider, but we want to advertise that we will always take care of</span>
<a href="#l4.1714"></a><span id="l4.1714">      * notifications.</span>
<a href="#l4.1715"></a><span id="l4.1715">      */</span>
<a href="#l4.1716"></a><span id="l4.1716" class="difflineminus">-    canNotify: function cGC_canNotify(aMethod, aItem) {</span>
<a href="#l4.1717"></a><span id="l4.1717" class="difflineminus">-        return true;</span>
<a href="#l4.1718"></a><span id="l4.1718" class="difflineminus">-    }</span>
<a href="#l4.1719"></a><span id="l4.1719" class="difflineplus">+    canNotify: function(aMethod, aItem) true</span>
<a href="#l4.1720"></a><span id="l4.1720"> };</span>
<a href="#l4.1721"></a><span id="l4.1721" class="difflineplus">+</span>
<a href="#l4.1722"></a><span id="l4.1722" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([calGoogleCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">rename from calendar/providers/gdata/components/calGoogleCalendarModule.manifest</span>
<a href="#l5.2"></a><span id="l5.2">rename to calendar/providers/gdata/components/calGoogleCalendar.manifest</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendarModule.manifest</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.manifest</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineat">@@ -1,11 +1,2 @@</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-component {d1a6e988-4b4d-45a5-ba46-43e501ea96e3} calGoogleCalendarModule.js</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+component {d1a6e988-4b4d-45a5-ba46-43e501ea96e3} calGoogleCalendar.js</span>
<a href="#l5.8"></a><span id="l5.8"> contract @mozilla.org/calendar/calendar;1?type=gdata {d1a6e988-4b4d-45a5-ba46-43e501ea96e3}</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-component {652f6233-e03f-438a-bd3b-39877f68c0f4} calGoogleCalendarModule.js</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-contract @mozilla.org/calendar/providers/gdata/session;1 {652f6233-e03f-438a-bd3b-39877f68c0f4}</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-component {6a7ba1f0-f271-49b0-8e93-5ca33651b4af} calGoogleCalendarModule.js</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-contract @mozilla.org/calendar/providers/gdata/session-manager;1 {6a7ba1f0-f271-49b0-8e93-5ca33651b4af}</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-component {53a3438a-21bc-4a0f-b813-77a8b4f19282} calGoogleCalendarModule.js</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-contract @mozilla.org/calendar/providers/gdata/request;1 {53a3438a-21bc-4a0f-b813-77a8b4f19282}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,49 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-// These constants are used internally to signal errors, to avoid the need for</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-// our own error range in calIErrors</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-const kGOOGLE_LOGIN_FAILED = 1;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-const kGOOGLE_CONFLICT_DELETED = 2;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-const kGOOGLE_CONFLICT_MODIFY = 3</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-/** Module Registration */</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-const calendarScriptLoadOrder = [</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-];</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-const gdataScriptLoadOrder = [</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    &quot;calGoogleCalendar.js&quot;,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    &quot;calGoogleSession.js&quot;,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    &quot;calGoogleRequest.js&quot;,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    &quot;calGoogleUtils.js&quot;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-];</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-function NSGetFactory(cid) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    if (!this.scriptsLoaded) {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-        // First load the calendar scripts</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-        cal.loadScripts(calendarScriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-        // Now load gdata extension scripts. __LOCATION__ is the current</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-        // filename, so  __LOCATION__.parent == . We expect to find the</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-        // subscripts in ./../js</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-        let thisDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-        thisDir.append(&quot;js&quot;);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-        cal.loadScripts(gdataScriptLoadOrder, Components.utils.getGlobalForObject(this), thisDir);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-        this.scriptsLoaded = true;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    }</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    let components = [</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-        calGoogleCalendar,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-        calGoogleSession,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-        calGoogleSessionManager,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-        calGoogleRequest</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    ];</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    return (XPCOMUtils.generateNSGetFactory(components))(cid);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/calendar/providers/gdata/components/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,10 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-    'calGoogleCalendarModule.js',</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    'calGoogleCalendarModule.manifest',</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-]</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/calendar/providers/gdata/content/browserRequest.css</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+#security-button {</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+  width: 20px;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+  margin-top: -1px;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  margin-right: 5px;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  background-repeat: no-repeat;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+}</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+#security-button[level=&quot;high&quot;],</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+#security-button[level=&quot;low&quot;] {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/secure.png&quot;);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+}</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+#security-button[level=&quot;broken&quot;] {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/insecure.png&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+}</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+#security-button[loading=&quot;true&quot;] {</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/loading.png&quot;);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  background-position: 4px 3px;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+}</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+@media (min-resolution: 2ddpx) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  #security-button[loading=&quot;true&quot;] {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    background-image: url(&quot;chrome://messenger/skin/icons/loading@2x.png&quot;);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+}</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+/*</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+#header {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  overflow: hidden;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  padding: 5px;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  border-bottom: 1px solid black;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  font-weight: bold;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  font-size: 1.2em;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+}</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+*/</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+#header {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    border-bottom: 1px solid rgb(105, 105, 105);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    overflow: hidden;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+}</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+#addressbox {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    font-weight: bold;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    font-size: normal;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    -moz-appearance: textfield;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    overflow: hidden;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    margin: 5px 5px;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    font-weight: normal;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+}</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+#headerMessage {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  margin-top: 3px;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  margin-bottom: 3px;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,113 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+const wpl = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+var reporterListener = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  _isBusy: false,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  get securityButton() {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    delete this.securityButton;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    return this.securityButton = document.getElementById(&quot;security-button&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  },</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  QueryInterface: function(aIID) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    if (aIID.equals(Components.interfaces.nsIWebProgressListener)   ||</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+        aIID.equals(Components.interfaces.nsISupportsWeakReference) ||</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+        aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+      return this;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  },</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  onStateChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+                     /*in nsIRequest*/ aRequest,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+                     /*in unsigned long*/ aStateFlags,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+                     /*in nsresult*/ aStatus) {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  },</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  onProgressChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+                        /*in long*/ aCurSelfProgress,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+                        /*in long */aMaxSelfProgress,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+                        /*in long */aCurTotalProgress,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+                        /*in long */aMaxTotalProgress) {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  },</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  onLocationChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                        /*in nsIURI*/ aLocation) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+    document.getElementById(&quot;headerMessage&quot;).textContent = aLocation.spec;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  },</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  onStatusChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+                      /*in nsIRequest*/ aRequest,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+                      /*in nsresult*/ aStatus,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+                      /*in wstring*/ aMessage) {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  },</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  onSecurityChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+                        /*in unsigned long*/ aState) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+                              wpl.STATE_IS_BROKEN |</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+                              wpl.STATE_IS_INSECURE |</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+                              wpl.STATE_SECURE_HIGH |</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+                              wpl.STATE_SECURE_MED |</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+                              wpl.STATE_SECURE_LOW;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    var level;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    switch (aState &amp; wpl_security_bits) {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_HIGH:</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+        level = &quot;high&quot;;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+        break;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_MED:</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_LOW:</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+        level = &quot;low&quot;;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+        break;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+      case wpl.STATE_IS_BROKEN:</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+        level = &quot;broken&quot;;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+        break;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+    }</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+    if (level) {</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+      this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+      this.securityButton.hidden = false;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    } else {</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+      this.securityButton.hidden = true;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+      this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+    }</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+    this.securityButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+                                     browser.securityUI.tooltipText);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  }</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+}</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+function cancelRequest()</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+{</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  reportUserClosed();</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  window.close();</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+}</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+function reportUserClosed()</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+{</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  request.cancelled();</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+}</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+function loadRequestedUrl()</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+{</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  let account = request.account;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  if (request.iconURI != &quot;&quot;)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+    document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+  var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  browser.addProgressListener(reporterListener,</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+                              Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+  var url = request.url;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  if (url != &quot;&quot;) {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    document.getElementById(&quot;headerMessage&quot;).textContent = url;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  }</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  request.loaded(window, browser.webProgress);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/calendar/providers/gdata/content/browserRequest.xul</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,34 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+&lt;!--# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+    # License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+    # You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ --&gt;</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://gdata-provider/skin/browserRequest.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+&lt;!DOCTYPE window&gt;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+&lt;window id=&quot;browserRequest&quot;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+        buttons=&quot;,&quot;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+        onload=&quot;loadRequestedUrl()&quot;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+        onclose=&quot;reportUserClosed()&quot;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+        title=&quot;&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+        width=&quot;800&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+        height=&quot;500&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+        orient=&quot;vertical&quot;&gt;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/browserRequest.js&quot;/&gt;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  &lt;keyset id=&quot;mainKeyset&quot;&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    &lt;key id=&quot;key_close&quot; key=&quot;w&quot; modifiers=&quot;accel&quot; oncommand=&quot;cancelRequest()&quot;/&gt;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    &lt;key id=&quot;key_close2&quot;  keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;cancelRequest()&quot;/&gt;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  &lt;/keyset&gt;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  &lt;hbox id=&quot;header&quot;&gt;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  &lt;hbox id=&quot;addressbox&quot; flex=&quot;1&quot; disabled=&quot;true&quot;&gt;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    &lt;image id=&quot;security-button&quot; src=&quot;chrome://messenger/skin/icons/mailicon32.png&quot;/&gt;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    &lt;description id=&quot;headerMessage&quot;/&gt;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  &lt;browser type=&quot;content&quot; disablehistory=&quot;true&quot; src=&quot;about:blank&quot; id=&quot;requestFrame&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-bindings.css</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,22 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+calendar-list-tree[type=&quot;gdata&quot;] {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+  -moz-binding: url(chrome://gdata-provider/content/gdata-list-tree.xml#gdata-list-tree);</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+}</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+calendar-list-tree &gt; tree &gt; treechildren::-moz-tree-image(checkbox-treecol, disabled) {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    list-style-image: none !important;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+}</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+calendar-list-tree &gt; tree &gt; treechildren::-moz-tree-cell(color-treecol, disabled) {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+    background-color: transparent !important;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+}</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+calendar-list-tree &gt; tree &gt; treechildren::-moz-tree-image(status-treecol, readonly) {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+    list-style-image: none;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+}</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+calendar-list-tree &gt; tree &gt; treechildren::-moz-tree-cell-text(readonly) {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    opacity: 0.4;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,246 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Calendar.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+CuImport(&quot;resource://gre/modules/Promise.jsm&quot;, this);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+(function() {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    function pageorder(anchor /*, ...pages */) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+        let pages = Array.slice(arguments, 1);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+        let wizard = document.documentElement;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+        let page = wizard.getPageById(anchor);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+        for each (let id in pages) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+            page.next = id;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+            page = wizard.getPageById(id);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+        }</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    }</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    function trycatch(func) {</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+        return function() {</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+            try {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+                return func.apply(this, arguments);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+            } catch (e) {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+                Components.utils.reportError(e);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+                throw e;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+            }</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+        };</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    }</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    let previousUriValue = null;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    function selectProvider(type) {</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+        let isGdata = (type == &quot;gdata&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+        let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+        let wizard = document.documentElement;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+        curi.parentNode.style.visibility = (isGdata ? &quot;hidden&quot; : &quot;visible&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+        document.getElementById(&quot;cache&quot;).parentNode.style.visibility = (isGdata ? &quot;hidden&quot; : &quot;visible&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+        // Move the next step descrition to the right place</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+        let locationRows = document.querySelector(&quot;#calendar-wizard &gt; [pageid='locationPage'] &gt; grid &gt; rows&quot;);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+        let nextStepDescr = document.getElementById(&quot;gdata-nextstep-description&quot;);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+        locationRows.appendChild(nextStepDescr);</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+        if (isGdata) {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+            pageorder(&quot;locationPage&quot;, &quot;gdata-session&quot;, &quot;gdata-calendars&quot;, &quot;finishPage&quot;);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+            previousUriValue = curi.value;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+            curi.value = &quot;googleapi://unknown&quot;;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+            nextStepDescr.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+        } else {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+            nextStepDescr.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+            pageorder(&quot;locationPage&quot;, &quot;customizePage&quot;, &quot;finishPage&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+            if (previousUriValue !== null) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+                curi.value = previousUriValue;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+                previousUriValue = null;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+            }</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+        }</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+        checkRequired();</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    }</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    this.gdataSelectProvider = selectProvider;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    if (typeof tmpCalendarCreation == &quot;undefined&quot;) {</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+        monkeyPatch(window, &quot;onSelectProvider&quot;, function(protofunc, type) {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+            selectProvider(type);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+            return protofunc(type);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+        });</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    } else {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+        // The exchange provider overwrites the select handler, which causes</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+        // our provider to fail. The exchange provider overwrites the select</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        // handler, which causes our provider to fail. Given the exchange</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+        // provider is currently not maintained and we want them to work</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        // together, here is a workaround.</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+        monkeyPatch(tmpCalendarCreation, &quot;doRadioExchangeCalendar&quot;, function(protofunc, target) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+            // We need to run our function first, otherwise resetting the</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+            // pageorder will overwrite what the exchange provider does.</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+            selectProvider(target.value);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+            let rv = protofunc(target);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+            // But then again, when switching to the gdata provider, the</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+            // exchange provider overwrites the uri we set.</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+            if (target.value == &quot;gdata&quot;) {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+                let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+                curi.value = &quot;googleapi://unknown&quot;;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+                checkRequired();</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+            }</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+            return rv;</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+        });</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    }</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+    monkeyPatch(window, &quot;prepareCreateCalendar&quot;, function(protofunc) {</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+        let type = document.getElementById('calendar-format').selectedItem.value;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+        return (type == &quot;gdata&quot; ? true : protofunc());</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+    });</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+    monkeyPatch(window, &quot;checkRequired&quot;, function(protofunc) {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+        let wizard = document.documentElement;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+        let currentPageId = wizard.currentPage &amp;&amp; wizard.currentPage.pageid;</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+        if (currentPageId == &quot;gdata-session&quot;) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+            let sessionGroup = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+            let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+            let sessionNameIsValid = document.getAnonymousElementByAttribute(sessionName, &quot;anonid&quot;, &quot;input&quot;).validity.valid;</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+            // TODO for some reason the validity doesn't work on windows. Here is a hack:</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+            sessionNameIsValid = !!sessionName.value.match(/^[^\/]+@[^\/]+\.[^\/]+$/);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+            wizard.canAdvance = sessionGroup.value || (sessionName.value &amp;&amp; sessionNameIsValid);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+        } else if (currentPageId == &quot;gdata-calendars&quot;) {</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+            let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+            let calendars = calendarList.selectedCalendars.filter(function(x) !x.getProperty(&quot;disabled&quot;) &amp;&amp; !x.readOnly);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+            wizard.canAdvance = !!calendars.length;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+        } else {</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+            protofunc();</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+        }</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+    });</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    this.gdataSessionShow = trycatch(function() {</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+        let sessionMgr = getGoogleSessionManager();</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+        let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+        let newSessionItem = document.getElementById(&quot;session-new&quot;);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+        let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+        let sessions = new Set([ sessionMgr.getSessionByCalendar(calendar, true)</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+                                 for each (calendar in calendars) ]);</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+        while (sessionContainer.firstChild.id != &quot;session-new&quot;) {</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+            sessionContainer.removeChild(sessionContainer.firstChild);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+        }</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+        // forEach is needed for backwards compatibility.</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+        sessions.forEach(function(session) {</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+            if (!session) {</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+                return;</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+            }</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+            let radio = document.createElement(&quot;radio&quot;);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+            radio.setAttribute(&quot;value&quot;, session.id);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+            radio.setAttribute(&quot;label&quot;, session.id);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+            sessionContainer.insertBefore(radio, newSessionItem);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+            radio.gdataSession = session;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+        });</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+        sessionContainer.value = sessionContainer.firstChild.value;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+        if (sessionContainer.value == &quot;&quot;) {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+            let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+            sessionName.focus();</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+        }</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+    });</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    this.gdataCalendarsShow = trycatch(function() {</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+        let sessionMgr = getGoogleSessionManager();</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+        let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+        let calendarListWidget = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+        calendarListWidget.clear();</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+        let session = sessionContainer.selectedItem.gdataSession;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+        if (!session) {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+            let newSessionItem = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+            session = sessionMgr.getSessionById(newSessionItem.value, true);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+        }</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+        PromiseAll([session.getTasksList(), session.getCalendarList()])</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+               .then(function([tasksLists, calendarList]) {</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+            let existing = new Set();</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+            let sessionPrefix = &quot;googleapi://&quot; + session.id;</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+            for each (let calendar in calMgr.getCalendars({})) {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+                let spec = calendar.uri.spec;</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+                if (calendar.type == &quot;gdata&quot; &amp;&amp; spec.substr(0, sessionPrefix.length) == sessionPrefix) {</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+                    let match;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+                    if ((match = spec.match(/calendar=([^&amp;]*)/))) {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+                        existing.add(decodeURIComponent(match[0]));</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+                    }</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+                    if ((match = spec.match(/tasks=([^&amp;]*)/))) {</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+                        existing.add(decodeURIComponent(match[0]));</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+                    }</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+                }</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+            }</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+            let taskcals = tasksLists.map(function(tasklist) {</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+                let uri = &quot;googleapi://&quot; + session.id + &quot;/?tasks=&quot; + encodeURIComponent(tasklist.id);</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+                let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+                calendar.id = cal.getUUID();</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+                calendar.setProperty(&quot;color&quot;, cal.hashColor(tasklist.title));</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+                calendar.name = tasklist.title;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+                if (existing.has(&quot;tasks=&quot; + tasklist.id)) {</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+                    calendar.readOnly = true;</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+                }</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+                return calendar;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+            });</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+            let calcals = calendarList.map(function(calendarEntry) {</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+                let uri = &quot;googleapi://&quot; + session.id + &quot;/?calendar=&quot; + encodeURIComponent(calendarEntry.id);</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+                let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+                calendar.name = calendarEntry.summary;</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+                calendar.id = cal.getUUID();</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                calendar.setProperty(&quot;color&quot;, calendarEntry.backgroundColor);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+                if (existing.has(&quot;calendar=&quot; + calendarEntry.id)) {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+                    calendar.readOnly = true;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                }</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+                return calendar;</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+            });</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+            let calendars = [calendarListWidget.mockCalendarHeader]</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                            .concat(calcals)</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+                            .concat([calendarListWidget.mockTaskHeader])</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+                            .concat(taskcals);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+            calendarListWidget.calendars = calendars;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+            Components.utils.reportError(e);</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+        }.bind(this));</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    });</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    this.gdataCalendarsAdvance = trycatch(function() {</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+        let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+        let calendars = calendarList.selectedCalendars.filter(function(x) !x.getProperty(&quot;disabled&quot;) &amp;&amp; !x.readOnly);</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+        if (Services.vc.compare(Services.appinfo.platformVersion, &quot;9.0&quot;) &lt; 0) {</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+            // This version didn't allow creating calendars with an id set, we</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+            // will have to hack it in.</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+            calendars.forEach(gdataRegisterCalendar);</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+        } else {</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+            calendars.forEach(calMgr.registerCalendar, calMgr);</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+        }</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+        return true;</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+    });</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    this.gdataFocusNewSession = trycatch(function() {</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+        let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+        sessionContainer.value = &quot;&quot;;</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+    });</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+    document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+        // Older versions of Lightning don't set the onselect attribute at all.</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+        let calendarFormat = document.getElementById(&quot;calendar-format&quot;);</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+        if (!calendarFormat.hasAttribute(&quot;onselect&quot;)) {</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+            calendarFormat.setAttribute(&quot;onselect&quot;, &quot;gdataSelectProvider(this.value)&quot;);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+        }</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+        if (!(&quot;updateStyleSheetForViews&quot; in window)) {</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+            window.updateStyleSheetForViews = function() {};</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+        }</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+    });</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+}).call(window);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">rename from calendar/providers/gdata/content/calendarCreation.xul</span>
<a href="#l13.2"></a><span id="l13.2">rename to calendar/providers/gdata/content/gdata-calendar-creation.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineminus">--- a/calendar/providers/gdata/content/calendarCreation.xul</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-creation.xul</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineat">@@ -1,12 +1,52 @@</span>
<a href="#l13.6"></a><span id="l13.6"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l13.7"></a><span id="l13.7"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.8"></a><span id="l13.8">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.9"></a><span id="l13.9">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-&lt;overlay id=&quot;calendarCreation&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+&lt;!DOCTYPE overlay [</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  &lt;!ENTITY % gdata SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt; %gdata;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+  &lt;!ENTITY % calendarCreation SYSTEM &quot;chrome://calendar/locale/calendarCreation.dtd&quot; &gt; %calendarCreation;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+]&gt;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://calendar/skin/calendar-management.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://calendar/content/widgets/calendar-widget-bindings.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://gdata-provider/skin/gdata-bindings.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+&lt;overlay id=&quot;gdataCalendarCreation&quot;</span>
<a href="#l13.23"></a><span id="l13.23">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-    &lt;radiogroup id=&quot;calendar-format&quot;&gt;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-        &lt;radio value=&quot;gdata&quot; label=&quot;&amp;gdata-provider.label;&quot;/&gt;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-    &lt;/radiogroup&gt;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/gdata-calendar-creation.js&quot;/&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  &lt;radiogroup id=&quot;calendar-format&quot;&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+    &lt;radio value=&quot;gdata&quot; label=&quot;&amp;gdata-provider.label;&quot;/&gt;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  &lt;/radiogroup&gt;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  &lt;wizard id=&quot;calendar-wizard&quot;&gt;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+    &lt;description id=&quot;gdata-nextstep-description&quot; hidden=&quot;true&quot;&gt;&amp;gdata.wizard.nextstep.description;&lt;/description&gt;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    &lt;wizardpage id=&quot;gdata-session&quot;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+                pageid=&quot;gdata-session&quot;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                onpageshow=&quot;gdataSessionShow(); checkRequired()&quot;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+                description=&quot;&amp;wizard.description;&quot;&gt;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+       &lt;description&gt;&amp;gdata.wizard.session.description;&lt;/description&gt;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+       &lt;radiogroup id=&quot;gdata-session-group&quot; onselect=&quot;checkRequired()&quot;&gt;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+         &lt;hbox id=&quot;session-new&quot;&gt;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+           &lt;radio value=&quot;&quot;/&gt;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+           &lt;textbox id=&quot;gdata-session-name&quot;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                    type=&quot;email&quot;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                    onfocus=&quot;gdataFocusNewSession()&quot;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+                    oninput=&quot;gdataFocusNewSession(); checkRequired();&quot;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+                    flex=&quot;1&quot;/&gt;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+         &lt;/hbox&gt;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+       &lt;/radiogroup&gt;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    &lt;/wizardpage&gt;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    &lt;wizardpage id=&quot;gdata-calendars&quot;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+                pageid=&quot;gdata-calendars&quot;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+                onpageshow=&quot;gdataCalendarsShow(); checkRequired()&quot;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+                onpageadvanced=&quot;return gdataCalendarsAdvance()&quot;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+                description=&quot;&amp;wizard.description;&quot;&gt;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      &lt;description&gt;&amp;gdata.wizard.calendars.description;&lt;/description&gt;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+      &lt;calendar-list-tree type=&quot;gdata&quot; id=&quot;calendar-list&quot; flex=&quot;1&quot;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+                          onselect=&quot;checkRequired();&quot; hideheader=&quot;true&quot;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+                          onclick=&quot;checkRequired()&quot;/&gt;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    &lt;/wizardpage&gt;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  &lt;/wizard&gt;</span>
<a href="#l13.62"></a><span id="l13.62"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,206 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+(function() {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    // Older versions of Lightning don't have this variable.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    if (!(&quot;gOldEndTimezone&quot; in window)) {</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+        window.gOldEndTimezone = null;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    }</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+    monkeyPatch(window, &quot;updateCalendar&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+        let calendar = getCurrentCalendar();</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+        let isGoogleCalendar = (calendar.type == &quot;gdata&quot;);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+        let isTask = cal.isToDo(window.calendarItem);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+        let isEvent = cal.isEvent(window.calendarItem);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+        let isGoogleTask = isGoogleCalendar &amp;&amp; isTask;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+        let isGoogleEvent = isGoogleCalendar &amp;&amp; isEvent;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+        let hideForTaskIds = [</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+            &quot;event-grid-location-row&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+            &quot;event-grid-startdate-row&quot;,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+            &quot;timezone-endtime&quot;,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+            &quot;link-image-bottom&quot;,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+            &quot;event-grid-attendee-row&quot;,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+            &quot;event-grid-attendee-row-2&quot;,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+            &quot;todo-status-none-menuitem&quot;,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+            &quot;todo-status-inprogress-menuitem&quot;,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+            &quot;todo-status-canceled-menuitem&quot;,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+            &quot;percent-complete-textbox&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+            &quot;percent-complete-label&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+            &quot;event-grid-recurrence-row&quot;,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+            &quot;event-grid-recurrence-separator&quot;,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+            &quot;event-grid-alarm-row&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+            &quot;event-grid-alarm-separator&quot;,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+            &quot;status-privacy&quot;,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+            &quot;status-priority&quot;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+        ];</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+        let disableForTaskIds = [</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+            &quot;options-attachments-menu&quot;,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+            &quot;options-attendess-menuitem&quot;,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+            &quot;options-privacy-menu&quot;,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+            &quot;options-priority-menu&quot;,</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+            &quot;options-freebusy-menu&quot;,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+            &quot;button-attendees&quot;,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+            &quot;button-privacy&quot;,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+            &quot;button-url&quot;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        ];</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        for each (let id in hideForTaskIds) {</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+            let node = document.getElementById(id);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+            if (node) {</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+                node.hidden = isGoogleTask;</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+            }</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+        }</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+        for each (let id in disableForTaskIds) {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+            let node = document.getElementById(id);</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+            if (node) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+                node.disabled = isGoogleTask;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+            }</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+        }</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+        let duedate = document.getElementById(&quot;todo-duedate&quot;);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+        let duetime = document.getAnonymousElementByAttribute(duedate, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+        duetime.style.display = isGoogleTask ? &quot;none&quot; : &quot;&quot;;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+        if (gEndTime) {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+            if (isGoogleTask) {</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+                let floating = cal.floating();</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+                if (gEndTimezone != floating) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+                  gOldEndTimezone = gEndTimezone;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+                }</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+                gEndTimezone = cal.floating();</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+                gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+                gEndTime.isDate = true;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+            } else {</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+                if (gOldEndTimezone) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+                    gEndTimezone = gOldEndTimezone;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+                }</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+                gEndTime.isDate = false;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+                gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+            }</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+            updateDateTime();</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+        }</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+        let elements = document.getElementsByAttribute(&quot;provider&quot;, &quot;gdata&quot;);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+        for each (let elem in Array.slice(elements)) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+            elem.style.display = isGoogleCalendar ? &quot;&quot; : &quot;none&quot;;</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+        }</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+        let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+        let hasDefaultReminders = isGoogleEvent &amp;&amp; calendar.getProperty(&quot;settings.defaultReminders&quot;);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+        if (isGoogleCalendar &amp;&amp; !hasDefaultReminders &amp;&amp; reminderList.value == &quot;default&quot;) {</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+            reminderList.value = &quot;none&quot;;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+        }</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+        document.getElementById(&quot;gdata-reminder-default-menuitem&quot;).style.display = hasDefaultReminders ? &quot;&quot; : &quot;none&quot;;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+        // Older versions of Lightning don't update the category menulist.</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+        if (!document.getElementById(&quot;item-categories-panel&quot;)) {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+            let categoriesLabel = document.getElementById(&quot;event-grid-category-color-row&quot;).firstChild;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+            let calendarLabel = document.getElementById(&quot;item-categories&quot;).nextSibling;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+            if (!categoriesLabel.origLabel) categoriesLabel.origLabel = categoriesLabel.value;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+            setBooleanAttribute(&quot;item-categories&quot;, &quot;hidden&quot;, isGoogleTask);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+            setBooleanAttribute(calendarLabel, &quot;hidden&quot;, isGoogleTask);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+            if (isGoogleTask) {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+                categoriesLabel.value = calendarLabel.value;</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+            } else {</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+                categoriesLabel.value = categoriesLabel.origLabel;</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+            }</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+        }</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+        return rv;</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    });</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    monkeyPatch(window, &quot;updateCategoryMenulist&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        let args = Array.slice(arguments, 1);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        let rv;</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+        let calendar = getCurrentCalendar();</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+        if (calendar.type == &quot;gdata&quot; &amp;&amp; cal.isToDo(window.calendarItem)) {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+            let unwrappedCal = calendar.getProperty(&quot;cache.uncachedCalendar&quot;).wrappedJSObject;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+            unwrappedCal.mProperties['capabilities.categories.maxCount'] = 0;</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+            rv = protofunc.apply(this, args);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+            delete unwrappedCal.mProperties['capabilities.categories.maxCount'];</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+        } else {</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+            rv = protofunc.apply(this, args);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+        }</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+        return rv;</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    });</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+    monkeyPatch(window, &quot;updateReminderDetails&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+        let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+        if (reminderList.value == &quot;default&quot;) {</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+            removeChildren(&quot;reminder-icon-box&quot;);</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+        }</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+        return rv;</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+    });</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+    monkeyPatch(window, &quot;saveReminder&quot;, function(protofunc, item /*, ...args */) {</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+        let calendar = getCurrentCalendar();</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+        let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+        if (calendar.type == &quot;gdata&quot; &amp;&amp; reminderList.value == &quot;default&quot;) {</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+            item.clearAlarms();</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+            let unwrappedCal = item.calendar.getProperty(&quot;cache.uncachedCalendar&quot;).wrappedJSObject;</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+            unwrappedCal.defaultReminders.forEach(item.addAlarm, item);</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+            return null;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+        } else {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+            return protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+        }</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+    })</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+    monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc, reminders /*, ...args */) {</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+        let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+        // Set up the default reminders item</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+        let defaultItem = document.getElementById(&quot;gdata-reminder-default-menuitem&quot;);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+        let calendar = getCurrentCalendar().getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+        let unwrappedCal = calendar &amp;&amp; calendar.wrappedJSObject;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+        let defaultReminders = unwrappedCal.defaultReminders ? unwrappedCal.defaultReminders.concat([]) : [];</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+        defaultItem.reminders = defaultReminders;</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+        let rv = null;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+        let usesDefault = reminders.length &amp;&amp; reminders.every(function(x) x.hasProperty(&quot;X-DEFAULT-ALARM&quot;));</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+        if (calendar.type == &quot;gdata&quot; &amp;&amp; (window.mode == &quot;new&quot; || usesDefault)) {</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+            // If all reminders are default reminders, then select the menuitem.</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+            reminderList.value = &quot;default&quot;;</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+            // remember the selected index</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+            gLastAlarmSelection = reminderList.selectedIndex;</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+        } else {</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+            rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+        }</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+        return rv;</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+    });</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+    monkeyPatch(window, &quot;editReminder&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+        // Now that the custom reminders were changed, we need to remove the</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+        // default alarm status, otherwise the wrong alarm will be set.</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+        let customItem = document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+        if (customItem.reminders) {</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+            for each (let reminder in customItem.reminders) {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+                reminder.deleteProperty(&quot;X-DEFAULT-ALARM&quot;);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+            }</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+        }</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+        return rv;</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    });</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-event-dialog.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> &lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> &lt;overlay id=&quot;gdata-calendar-event-dialog&quot;</span>
<a href="#l15.11"></a><span id="l15.11">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/gdata-calendar-event-dialog.js&quot;/&gt;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14">   &lt;!-- Privacy items --&gt;</span>
<a href="#l15.15"></a><span id="l15.15">   &lt;menupopup id=&quot;options-privacy-menupopup&quot;&gt;</span>
<a href="#l15.16"></a><span id="l15.16">     &lt;menuitem id=&quot;gdata-options-privacy-default-menuitem&quot;</span>
<a href="#l15.17"></a><span id="l15.17">               insertbefore=&quot;options-privacy-public-menuitem,options-privacy-private-menuitem&quot;</span>
<a href="#l15.18"></a><span id="l15.18">               label=&quot;&amp;gdata.privacy.default.label;&quot;</span>
<a href="#l15.19"></a><span id="l15.19">               accesskey=&quot;&amp;gdata.privacy.default.accesskey;&quot;</span>
<a href="#l15.20"></a><span id="l15.20">               type=&quot;radio&quot;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -32,9 +33,17 @@</span>
<a href="#l15.22"></a><span id="l15.22">   &lt;/menupopup&gt;</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24">   &lt;statusbarpanel id=&quot;status-privacy&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25">     &lt;hbox id=&quot;gdata-status-privacy-default-box&quot;</span>
<a href="#l15.26"></a><span id="l15.26">           insertbefore=&quot;status-privacy-public-box,status-privacy-private-box&quot;</span>
<a href="#l15.27"></a><span id="l15.27">           privacy=&quot;DEFAULT&quot;</span>
<a href="#l15.28"></a><span id="l15.28">           provider=&quot;gdata&quot;/&gt;</span>
<a href="#l15.29"></a><span id="l15.29">   &lt;/statusbarpanel&gt;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  &lt;menupopup id=&quot;item-alarm-menupopup&quot;&gt;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    &lt;menuitem id=&quot;gdata-reminder-default-menuitem&quot;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+              insertbefore=&quot;reminder-none-separator&quot;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+              label=&quot;&amp;gdata.reminder.default;&quot;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+              provider=&quot;gdata&quot;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+              value=&quot;default&quot;/&gt;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  &lt;/menupopup&gt;</span>
<a href="#l15.38"></a><span id="l15.38"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-properties.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,33 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+(function() {</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+    Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+    monkeyPatch(window, &quot;onLoad&quot;, function(protofunc) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        if (gCalendar.type == &quot;gdata&quot;) {</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+            let accessRole = gCalendar.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+            let isReader = (accessRole == &quot;freeBusyReader&quot; || accessRole == &quot;reader&quot;);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+            let isEventsCalendar = gCalendar.getProperty(&quot;capabilities.events.supported&quot;);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+            let isDisabled = gCalendar.getProperty(&quot;disabled&quot;);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+            // Disable setting read-only if the calendar is readonly anyway</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+            document.getElementById(&quot;read-only&quot;).disabled = isDisabled || (isEventsCalendar &amp;&amp; isReader);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+            // Don't allow setting refresh interval to 30 minutes or less</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+            let refInterval = document.getElementById(&quot;calendar-refreshInterval-menupopup&quot;);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+            Array.slice(refInterval.childNodes).filter(function(n) {</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+                let nv = parseInt(n.getAttribute(&quot;value&quot;), 10);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+                return nv &lt; 30 &amp;&amp; nv != 0;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+            }).forEach(function(n) refInterval.removeChild(n));</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+            // Old Lightning doesn't hide the cache label</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+            let oldCacheLabel = document.getElementById(&quot;cache&quot;);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+            if (oldCacheLabel) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+                oldCacheLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+            }</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+        }</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+        return rv;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    });</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-properties.xul</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+&lt;overlay id=&quot;gdata-calendar-event-dialog&quot;</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/gdata-calendar-properties.js&quot;/&gt;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,72 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+(function() {</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+    const FOUR_WEEKS_BEFORE = -2419200;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+    Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    // NOTE: This function exits early if its not a gdata calendar</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+    let item = window.arguments[0].item;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    let calendar = window.arguments[0].calendar;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+    if (calendar.type != &quot;gdata&quot;) {</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+        return;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+    }</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+    let label = getProviderString(&quot;reminderOutOfRange&quot;);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+    let notification = createXULElement(&quot;notification&quot;);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    notification.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+    notification.setAttribute(&quot;type&quot;, &quot;critical&quot;);</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+    notification.setAttribute(&quot;hideclose&quot;, &quot;true&quot;);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+    function checkReminderRange(reminder) {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+        let offset = cal.alarms.calculateAlarmOffset(item, reminder);</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+        let seconds = offset.inSeconds;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+        return (seconds &lt; 1 &amp;&amp; seconds &gt;= FOUR_WEEKS_BEFORE);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+    }</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+    function checkAllReminders() {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+        let listbox = document.getElementById(&quot;reminder-listbox&quot;);</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+        let notificationbox = document.getElementById(&quot;reminder-notifications&quot;);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+        let validated = true;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+        for each (let node in Array.slice(listbox.childNodes)) {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+            validated = validated &amp;&amp; checkReminderRange(node.reminder);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+            if (!validated) {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+                break;</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+            }</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+        }</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+        let acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+        acceptButton.disabled = !validated;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+        if (validated) {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+            try {</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+                notificationbox.removeNotification(notification);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+            } catch (e) {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+                // Ok to swallow if it hasn't been added yet.</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+            }</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+        } else {</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+            notificationbox.appendChild(notification);</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+        }</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    }</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+    monkeyPatch(window, &quot;updateReminder&quot;, function(protofunc, event) {</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+        if (event.explicitOriginalTarget.localName == &quot;listitem&quot; ||</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+            event.explicitOriginalTarget.id == &quot;reminder-remove-button&quot; ||</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+            !document.commandDispatcher.focusedElement) {</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+            // Same hack from the original dialog</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+            return;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+        }</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+        checkAllReminders();</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+        return rv;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    });</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+    monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+        let rv = protofunc.apply(this, Array.slice(arguments, 1));</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+        checkAllReminders();</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+        return rv;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    });</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://gdata-provider/skin/gdata-event-dialog-reminder.css&quot;?&gt;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> &lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> &lt;overlay id=&quot;gdata-event-dialog-reminder-overlay&quot;</span>
<a href="#l19.11"></a><span id="l19.11">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/gdata-event-dialog-reminder.js&quot;/&gt;</span>
<a href="#l19.13"></a><span id="l19.13">   &lt;menupopup id=&quot;reminder-actions-menupopup&quot;&gt;</span>
<a href="#l19.14"></a><span id="l19.14">     &lt;menuitem id=&quot;reminder-action-SMS&quot;</span>
<a href="#l19.15"></a><span id="l19.15">               class=&quot;reminder-icon menuitem-iconic&quot;</span>
<a href="#l19.16"></a><span id="l19.16">               value=&quot;SMS&quot;</span>
<a href="#l19.17"></a><span id="l19.17">               insertafter=&quot;reminder-action-EMAIL reminder-action-DISPLAY&quot;</span>
<a href="#l19.18"></a><span id="l19.18">               provider=&quot;gdata&quot;</span>
<a href="#l19.19"></a><span id="l19.19">               label=&quot;&amp;gdata.reminder.action.sms.label;&quot;/&gt;</span>
<a href="#l19.20"></a><span id="l19.20">   &lt;/menupopup&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-list-tree.xml</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,233 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+&lt;!DOCTYPE overlay SYSTEM &quot;chrome://calendar/locale/calendar.dtd&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+&lt;bindings id=&quot;gdata-list-tree-bindings&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+          xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+  &lt;binding id=&quot;gdata-list-tree&quot; extends=&quot;chrome://calendar/content/widgets/calendar-list-tree.xml#calendar-list-tree&quot;&gt;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+    &lt;content&gt;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+      &lt;xul:tree anonid=&quot;tree&quot;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+                xbl:inherits=&quot;hidecolumnpicker&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+                hidecolumnpicker=&quot;true&quot;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+                seltype=&quot;single&quot;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+                flex=&quot;1&quot;&gt;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+        &lt;xul:treecols anonid=&quot;treecols&quot;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+                      xbl:inherits=&quot;hideheader&quot;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+                      hideheader=&quot;true&quot;&gt;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+          &lt;xul:treecol anonid=&quot;checkbox-treecol&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+                       xbl:inherits=&quot;cycler,hideheader&quot;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+                       cycler=&quot;true&quot;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+                       hideheader=&quot;true&quot;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+                       width=&quot;17&quot;/&gt;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+          &lt;xul:treecol anonid=&quot;color-treecol&quot;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+                       xbl:inherits=&quot;cycler,hideheader&quot;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+                       hideheader=&quot;true&quot;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+                       width=&quot;16&quot;/&gt;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+          &lt;xul:treecol anonid=&quot;calendarname-treecol&quot;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+                       xbl:inherits=&quot;cycler,hideheader&quot;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+                       primary=&quot;true&quot;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+                       hideheader=&quot;true&quot;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+                       label=&quot;&amp;calendar.unifinder.tree.calendarname.label;&quot;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+                       flex=&quot;1&quot;/&gt;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+          &lt;xul:treecol anonid=&quot;status-treecol&quot;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+                       xbl:inherits=&quot;cycler,hideheader&quot;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+                       hideheader=&quot;true&quot;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+                       width=&quot;18&quot;/&gt;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+          &lt;children includes=&quot;treecol&quot;/&gt;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+          &lt;xul:treecol anonid=&quot;scrollbar-spacer&quot;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+                       xbl:inherits=&quot;cycler,hideheader&quot;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+                       fixed=&quot;true&quot;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+                       hideheader=&quot;true&quot;&gt;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+            &lt;!-- This is a very elegant workaround to make sure the last column</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+                 is not covered by the scrollbar in case of an overflow. This</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+                 treecol needs to be here last --&gt;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+            &lt;xul:slider anonid=&quot;scrollbar-slider&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+          &lt;/xul:treecol&gt;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+        &lt;/xul:treecols&gt;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+        &lt;xul:treechildren anonid=&quot;treechildren&quot;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+                          xbl:inherits=&quot;tooltip=childtooltip,context=childcontext&quot;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+                          tooltip=&quot;_child&quot;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+                          context=&quot;_child&quot;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+                          ondragstart=&quot;onDragStart(event);&quot;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+                          onoverflow=&quot;displayScrollbarSpacer(true)&quot;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+                          onunderflow=&quot;displayScrollbarSpacer(false)&quot;&gt;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+          &lt;children includes=&quot;tooltip|menupopup&quot;/&gt;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+        &lt;/xul:treechildren&gt;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+      &lt;/xul:tree&gt;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+    &lt;implementation&gt;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        this.tree.view = this;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      &lt;property name=&quot;mockCalendarHeader&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+          let calmgr = cal.getCalendarManager();</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+          let uri = &quot;dummy://calendar&quot;;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+          let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+          mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+          mem.name = &quot;Calendars&quot;;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+          mem.id = cal.getUUID();</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+          return mem;</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+      &lt;property name=&quot;mockTaskHeader&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+          let calmgr = cal.getCalendarManager();</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+          let uri = &quot;dummy://tasks&quot;;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+          let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+          mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+          mem.name = &quot;Task Lists&quot;;</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+          mem.id = cal.getUUID();</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+          return mem;</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+      &lt;field name=&quot;mCalendarHeaderIndex&quot;&gt;0&lt;/field&gt;</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+      &lt;field name=&quot;mTasksHeaderIndex&quot;&gt;0&lt;/field&gt;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+      &lt;field name=&quot;QueryInterface&quot;&gt;XPCOMUtils.generateQI([Components.interfaces.nsITreeView])&lt;/field&gt;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+      &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+          return this.mCalendarList;</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+            for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+                let calendar = val[i];</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+                let spec = calendar.uri.spec;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+                if (calendar.type == &quot;memory&quot;) {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+                    if (spec == &quot;dummy://calendar&quot;) {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+                        this.mCalendarHeaderIndex = i;</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+                    } else if (spec == &quot;dummy://tasks&quot;) {</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+                        this.mTasksHeaderIndex = i;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+                    }</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+                }</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+                this.addCalendar(calendar);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+            }</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+      &lt;method name=&quot;removeCalendar&quot;&gt;</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+        &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+          let index = this.findIndexById(aCalendar.id);</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+          if (index &lt; this.mCalendarHeaderIndex) {</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+            this.mCalendarHeaderIndex--;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+          }</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+          if (index &lt; this.mTasksHeaderIndex) {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+            this.mTasksHeaderIndex--;</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+          }</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+          return this.__proto__.__proto__.removeCalendar.call(this, aCalendar);</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+      &lt;method name=&quot;clear&quot;&gt;</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+          let calendars = this.mCalendarList.concat([]);</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+          calendars.forEach(this.removeCalendar, this);</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+      &lt;method name=&quot;getRowProperties&quot;&gt;</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+        &lt;parameter name=&quot;aProps&quot;/&gt;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+          let props = this.__proto__.__proto__.getRowProperties.call(this, aRow, aProps);</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+          let calendar = this.getCalendar(aRow);</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+          if (calendar.readOnly) {</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+              if (aProps) {</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+                  // Compatibility with old tree props code</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+                  aProps.AppendElement(cal.getAtomFromService(&quot;checked&quot;));</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+              } else {</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+                  props += &quot; checked&quot;;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+              }</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+          }</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+          return props;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+      &lt;method name=&quot;isContainerEmpty&quot;&gt;</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+         return ((aRow == this.mCalendarHeaderIndex &amp;&amp;</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+                  aRow + 1 == this.mTasksHeaderIndex) ||</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+                 (aRow == this.mTasksHeaderIndex &amp;&amp;</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+                  aRow == this.mCalendarList.lengh));</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+      &lt;method name=&quot;isContainer&quot;&gt;</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+          let calendar = this.getCalendar(aRow);</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+          return (calendar.type == &quot;memory&quot; &amp;&amp; calendar.uri.schemeIs(&quot;dummy&quot;));</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+      &lt;method name=&quot;isContainerOpen&quot;&gt;</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+          return true;</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+      &lt;method name=&quot;getParentIndex&quot;&gt;</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+          let calendar = this.getCalendar(aRow);</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+          if (calendar.uri.path.contains(&quot;?calendar&quot;)) {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+              return this.mCalendarHeaderIndex;</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+          } else if (calendar.uri.path.contains(&quot;?tasks&quot;)) {</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+              return this.mTasksHeaderIndex;</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+          } else {</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+              return -1;</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+          }</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+      &lt;method name=&quot;hasNextSibling&quot;&gt;</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+        &lt;parameter name=&quot;aAfterIndex&quot;/&gt;</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+          if (aRow == this.mCalendarHeaderIndex) {</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+              return aAfterIndex &lt; this.mTasksHeaderIndex;</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+          } else if (aRow == this.mTasksHeaderIndex) {</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+              return false;</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+          } else {</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+              return aAfterIndex != this.mCalendarHeaderIndex - 1 &amp;&amp;</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+                     aAfterIndex != this.mTasksHeaderIndex - 1;</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+          }</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+      &lt;method name=&quot;cycleCell&quot;&gt;</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+        &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+          let calendar = this.getCalendar(aRow);</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+          let composite = this.compositeCalendar;</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+          if (composite.getCalendarById(calendar.id)) {</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+              composite.removeCalendar(calendar);</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+          } else {</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+              composite.addCalendar(calendar);</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+          }</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+          this.treebox.invalidateRow(aRow);</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+      &lt;method name=&quot;getLevel&quot;&gt;</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+        &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+          return this.isContainer(aRow) ? 0 : 1;</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> /**</span>
<a href="#l21.16"></a><span id="l21.16">  * Migrate the calendar selected in the wizard from ics to gdata.</span>
<a href="#l21.17"></a><span id="l21.17">  */</span>
<a href="#l21.18"></a><span id="l21.18"> function migrateSelectedCalendars() {</span>
<a href="#l21.19"></a><span id="l21.19">     let listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l21.20"></a><span id="l21.20">     let calmgr = cal.getCalendarManager();</span>
<a href="#l21.21"></a><span id="l21.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/providers/gdata/defaults/preferences.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/providers/gdata/defaults/preferences.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -7,16 +7,18 @@ pref(&quot;extensions.{a62ef8ec-5fdc-40c2-873</span>
<a href="#l22.4"></a><span id="l22.4">      &quot;chrome://gdata-provider/locale/gdata.properties&quot;);</span>
<a href="#l22.5"></a><span id="l22.5"> pref(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;,</span>
<a href="#l22.6"></a><span id="l22.6">      &quot;chrome://gdata-provider/locale/gdata.properties&quot;);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> /* other default prefs */</span>
<a href="#l22.9"></a><span id="l22.9"> pref(&quot;calendar.google.useHTTPMethodOverride&quot;, true);</span>
<a href="#l22.10"></a><span id="l22.10"> pref(&quot;calendar.google.alarmClosest&quot;, true);</span>
<a href="#l22.11"></a><span id="l22.11"> pref(&quot;calendar.google.migrate&quot;, true);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+pref(&quot;calendar.google.maxResultsPerRequest&quot;, 1000);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+pref(&quot;calendar.google.idleTime&quot;, 300);</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15"> /**</span>
<a href="#l22.16"></a><span id="l22.16">  * Invitations and notifications.</span>
<a href="#l22.17"></a><span id="l22.17">  * Note that if enableEmailInvitations is enabled it is a good idea to disable</span>
<a href="#l22.18"></a><span id="l22.18">  * attendees or at least sending event notifications.</span>
<a href="#l22.19"></a><span id="l22.19">  */</span>
<a href="#l22.20"></a><span id="l22.20"> pref(&quot;calendar.google.sendEventNotifications&quot;, true);</span>
<a href="#l22.21"></a><span id="l22.21"> pref(&quot;calendar.google.enableAttendees&quot;, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/providers/gdata/install.rdf</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/providers/gdata/install.rdf</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -10,28 +10,37 @@</span>
<a href="#l23.4"></a><span id="l23.4">   &lt;Description about=&quot;urn:mozilla:install-manifest&quot;&gt;</span>
<a href="#l23.5"></a><span id="l23.5">     &lt;em:id&gt;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&lt;/em:id&gt;</span>
<a href="#l23.6"></a><span id="l23.6">     &lt;em:version&gt;@GDATA_VERSION@&lt;/em:version&gt;</span>
<a href="#l23.7"></a><span id="l23.7">     &lt;em:type&gt;2&lt;/em:type&gt;</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">     &lt;!-- Target Application this extension can install into,</span>
<a href="#l23.10"></a><span id="l23.10">          with minimum and maximum supported versions. --&gt;</span>
<a href="#l23.11"></a><span id="l23.11">     &lt;em:targetApplication&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+      &lt;!-- Postbox --&gt;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+      &lt;Description&gt;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+        &lt;em:id&gt;postbox@postbox-inc.com&lt;/em:id&gt;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+        &lt;em:minVersion&gt;3.0.0b1&lt;/em:minVersion&gt;</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+        &lt;em:maxVersion&gt;3.0.*&lt;/em:maxVersion&gt;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+      &lt;/Description&gt;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+    &lt;/em:targetApplication&gt;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+    &lt;em:targetApplication&gt;</span>
<a href="#l23.21"></a><span id="l23.21">       &lt;Description&gt;</span>
<a href="#l23.22"></a><span id="l23.22">         &lt;!-- Thunderbird --&gt;</span>
<a href="#l23.23"></a><span id="l23.23">         &lt;em:id&gt;{3550f703-e582-4d05-9a08-453d09bdfdc6}&lt;/em:id&gt;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-        &lt;em:minVersion&gt;17.0a1&lt;/em:minVersion&gt;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+        &lt;em:minVersion&gt;24.0&lt;/em:minVersion&gt;</span>
<a href="#l23.26"></a><span id="l23.26">         &lt;em:maxVersion&gt;@THUNDERBIRD_VERSION@&lt;/em:maxVersion&gt;</span>
<a href="#l23.27"></a><span id="l23.27">       &lt;/Description&gt;</span>
<a href="#l23.28"></a><span id="l23.28">     &lt;/em:targetApplication&gt;</span>
<a href="#l23.29"></a><span id="l23.29">     &lt;em:targetApplication&gt;</span>
<a href="#l23.30"></a><span id="l23.30">       &lt;Description&gt;</span>
<a href="#l23.31"></a><span id="l23.31">         &lt;!-- SeaMonkey --&gt;</span>
<a href="#l23.32"></a><span id="l23.32">         &lt;em:id&gt;{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}&lt;/em:id&gt;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-        &lt;em:minVersion&gt;2.14a1&lt;/em:minVersion&gt;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+        &lt;em:minVersion&gt;2.21&lt;/em:minVersion&gt;</span>
<a href="#l23.35"></a><span id="l23.35">         &lt;em:maxVersion&gt;@SEAMONKEY_VERSION@&lt;/em:maxVersion&gt;</span>
<a href="#l23.36"></a><span id="l23.36">       &lt;/Description&gt;</span>
<a href="#l23.37"></a><span id="l23.37">     &lt;/em:targetApplication&gt;</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39">     &lt;em:name&gt;Provider for Google Calendar&lt;/em:name&gt;</span>
<a href="#l23.40"></a><span id="l23.40">     &lt;em:description&gt;Allows bidirectional access to Google Calendar&lt;/em:description&gt;</span>
<a href="#l23.41"></a><span id="l23.41">     &lt;em:creator&gt;Philipp Kewisch&lt;/em:creator&gt;</span>
<a href="#l23.42"></a><span id="l23.42">     &lt;em:contributor&gt;Mark James (http://www.famfamfam.com/lab/icons/silk/)&lt;/em:contributor&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/providers/gdata/jar.mn</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/providers/gdata/jar.mn</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,24 +1,37 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #filter substitution</span>
<a href="#l24.5"></a><span id="l24.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.6"></a><span id="l24.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.7"></a><span id="l24.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> gdata-provider.jar:</span>
<a href="#l24.11"></a><span id="l24.11"> % content gdata-provider %content/</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-% overlay chrome://calendar/content/calendarCreation.xul chrome://gdata-provider/content/calendarCreation.xul</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+% resource gdata-provider .</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+% overlay chrome://calendar/content/calendarCreation.xul chrome://gdata-provider/content/gdata-calendar-creation.xul</span>
<a href="#l24.15"></a><span id="l24.15"> % overlay chrome://messenger/content/messenger.xul chrome://gdata-provider/content/gdata-migration-overlay.xul  application={3550f703-e582-4d05-9a08-453d09bdfdc6}</span>
<a href="#l24.16"></a><span id="l24.16"> % overlay chrome://calendar/content/calendar-event-dialog.xul chrome://gdata-provider/content/gdata-calendar-event-dialog.xul</span>
<a href="#l24.17"></a><span id="l24.17"> % overlay chrome://calendar/content/calendar-event-dialog-reminder.xul chrome://gdata-provider/content/gdata-event-dialog-reminder.xul</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+% overlay chrome://calendar/content/calendar-properties-dialog.xul chrome://gdata-provider/content/gdata-calendar-properties.xul</span>
<a href="#l24.19"></a><span id="l24.19"> % style chrome://calendar/content/calendar-event-dialog.xul chrome://gdata-provider/skin/gdata-event-dialog-reminder.css</span>
<a href="#l24.20"></a><span id="l24.20"> % style chrome://messenger/content/messenger.xul chrome://gdata-provider/skin/gdata-event-dialog-reminder.css   application={3550f703-e582-4d05-9a08-453d09bdfdc6}</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-    content/calendarCreation.xul                 (content/calendarCreation.xul)</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+% style chrome://messenger/content/messenger.xul chrome://gdata-provider/skin/gdata-event-dialog-reminder.css   application=postbox@postbox-inc.com</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+    content/browserRequest.xul                   (content/browserRequest.xul)</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+    content/browserRequest.js                    (content/browserRequest.js)</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+    content/gdata-calendar-creation.xul          (content/gdata-calendar-creation.xul)</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+    content/gdata-calendar-creation.js           (content/gdata-calendar-creation.js)</span>
<a href="#l24.27"></a><span id="l24.27">     content/gdata-calendar-event-dialog.xul      (content/gdata-calendar-event-dialog.xul)</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+    content/gdata-calendar-event-dialog.js       (content/gdata-calendar-event-dialog.js)</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+    content/gdata-calendar-properties.xul        (content/gdata-calendar-properties.xul)</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+    content/gdata-calendar-properties.js         (content/gdata-calendar-properties.js)</span>
<a href="#l24.31"></a><span id="l24.31">     content/gdata-event-dialog-reminder.xul      (content/gdata-event-dialog-reminder.xul)</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+    content/gdata-event-dialog-reminder.js       (content/gdata-event-dialog-reminder.js)</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+    content/gdata-list-tree.xml                  (content/gdata-list-tree.xml)</span>
<a href="#l24.34"></a><span id="l24.34">     content/gdata-migration.js                   (content/gdata-migration.js)</span>
<a href="#l24.35"></a><span id="l24.35">     content/gdata-migration-overlay.xul          (content/gdata-migration-overlay.xul)</span>
<a href="#l24.36"></a><span id="l24.36">     content/gdata-migration-wizard.xul           (content/gdata-migration-wizard.xul)</span>
<a href="#l24.37"></a><span id="l24.37">     content/gcal.png                             (content/gcal.png)</span>
<a href="#l24.38"></a><span id="l24.38"> % skin gdata-provider classic/1.0 %skin/</span>
<a href="#l24.39"></a><span id="l24.39">     skin/reminder-action-sms.png                 (content/reminder-action-sms.png)</span>
<a href="#l24.40"></a><span id="l24.40">     skin/gdata-event-dialog-reminder.css         (content/gdata-event-dialog-reminder.css)</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+    skin/gdata-bindings.css                      (content/gdata-bindings.css)</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+    skin/browserRequest.css                      (content/browserRequest.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/providers/gdata/makeversion.py</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/providers/gdata/makeversion.py</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,12 +1,25 @@</span>
<a href="#l25.4"></a><span id="l25.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> import sys</span>
<a href="#l25.9"></a><span id="l25.9"> import re</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> # Converts a Lightning version to a matching gdata version:</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#  Lightning 1.2 -&gt; gdata-provider 0.11</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-#  Lightning 1.3a1 -&gt; gdata-provider 0.12pre</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-v = re.search(r&quot;(\d+\.\d+)([a-z]\d+)?&quot;, sys.argv[1])</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-print &quot;{0:.2f}&quot;.format((float(v.group(1)) - 0.1)/10) + (v.lastindex == 2 and &quot;pre&quot; or &quot;&quot;)</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+#  Lightning 3.1 -&gt; gdata-provider 1.0</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+#  Lightning 3.2b2 -&gt; gdata-provider 1.1b2</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+#  Lightning 3.3a1 -&gt; gdata-provider 1.2a1</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+def makeversion(x):</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+    v = re.search(r&quot;(\d+\.\d+)([a-z]\d+)?&quot;, x)</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+    parts = v.group(1).split('.')</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+    major = int(parts[0]) - 2</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+    minor = int(parts[1]) - 1</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+    if minor &lt; 0:</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+        minor = 10 + minor</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+        major = major - 1</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+    parts[0] = str(major)</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+    parts[1] = str(minor)</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+    return '.'.join(parts) + (v.group(2) or &quot;&quot;)</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+if __name__ == '__main__':</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+    print(makeversion(sys.argv[1]))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,273 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+/**</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+ * Provides OAuth 2.0 authentication</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+ */</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;];</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+Cu.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+Cu.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+let httpRequest = (function() {</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+  let scope = {};</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+  try {</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+    // Thunderbird 25+</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+    Cu.import(&quot;resource://gre/modules/Http.jsm&quot;, scope);</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+  } catch (e) {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+    try {</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+      // Thunderbird 24</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+      Cu.import(&quot;resource:///modules/http.jsm&quot;, scope);</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+    } catch (e) {</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+      // Thunderbird 7</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+      Cu.import(&quot;resource://gdata-provider/modules/shim/Http.jsm&quot;, scope);</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+    }</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  }</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  if (&quot;httpRequest&quot; in scope) {</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+    // Thunderbird 25+ and Thunderbird 7</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+    return scope.httpRequest;</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+  } else {</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+    // Thunderbird 24</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+    return function(uri, options) {</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+        return scope.doXHRequest(uri, null, options.postData, options.onLoad,</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+                                 options.onError, undefined);</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+    };</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+  }</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+})();</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+function parseURLData(aData) {</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+  let result = {};</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+  aData.split(/[?#]/, 2)[1].split(&quot;&amp;&quot;).forEach(function (aParam) {</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+    let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+    result[key] = value;</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+  });</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+  return result;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+}</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+function OAuth2(aBaseURI, aScope, aAppKey, aAppSecret) {</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+    this.authURI = aBaseURI + &quot;oauth2/auth&quot;;</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+    this.tokenURI = aBaseURI + &quot;oauth2/token&quot;;</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+    this.consumerKey = aAppKey;</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+    this.consumerSecret = aAppSecret;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+    this.scope = aScope;</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+    this.extraAuthParams = [];</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+    this.log = Log4Moz.getConfiguredLogger(&quot;TBOAuth&quot;);</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+}</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+OAuth2.CODE_AUTHORIZATION = &quot;authorization_code&quot;;</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+OAuth2.CODE_REFRESH = &quot;refresh_token&quot;;</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+OAuth2.prototype = {</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+    responseType: &quot;code&quot;,</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+    consumerKey: null,</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+    consumerSecret: null,</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+    completionURI: &quot;http://localhost&quot;,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+    requestWindowURI: &quot;chrome://messenger/content/browserRequest.xul&quot;,</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+    requestWindowFeatures: &quot;chrome,private,centerscreen,width=980,height=600&quot;,</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+    requestWindowTitle: &quot;&quot;,</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+    scope: null,</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+    accessToken: null,</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+    refreshToken: null,</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+    tokenExpires: 0,</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+    connecting: false,</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+    connect: function connect(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+        if (this.connecting) {</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+            return;</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+        }</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineplus">+        this.connectSuccessCallback = aSuccess;</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+        this.connectFailureCallback = aFailure;</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+        if (!aRefresh &amp;&amp; this.accessToken) {</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+            aSuccess();</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+        } else if (this.refreshToken) {</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineplus">+            this.connecting = true;</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineplus">+            this.requestAccessToken(this.refreshToken, OAuth2.CODE_REFRESH);</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+        } else {</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+            if (!aWithUI) {</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+                aFailure('{ &quot;error&quot;: &quot;auth_noui&quot; }');</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+                return;</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+            }</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineplus">+            this.connecting = true;</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+            this.requestAuthorization();</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+        }</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+    },</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+    requestAuthorization: function requestAuthorization() {</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+        let params = [</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+            [&quot;response_type&quot;, this.responseType],</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+            [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+            [&quot;redirect_uri&quot;, this.completionURI],</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+        ];</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+        // The scope can be optional.</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+        if (this.scope) {</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+            params.push([&quot;scope&quot;, this.scope]);</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+        }</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+        // Add extra parameters, if they exist</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+        Array.prototype.push.apply(params, this.extraAuthParams);</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+        // Now map the parameters to a string</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+        params = params.map(function([k,v]) k + &quot;=&quot; + encodeURIComponent(v)).join(&quot;&amp;&quot;);</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineplus">+</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineplus">+        this._browserRequest = {</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+            account: this,</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+            url: this.authURI + &quot;?&quot; + params,</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+            _active: true,</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+            iconURI: &quot;&quot;,</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+            cancelled: function() {</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+                if (!this._active) {</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineplus">+                    return;</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineplus">+                }</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineplus">+</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+                this.account.finishAuthorizationRequest();</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+                this.account.onAuthorizationFailed(Components.results.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineplus">+            },</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineplus">+            loaded: function (aWindow, aWebProgress) {</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineplus">+                if (!this._active) {</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+                    return;</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineplus">+                }</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineplus">+</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineplus">+                this._listener = {</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineplus">+                    window: aWindow,</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineplus">+                    webProgress: aWebProgress,</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+                    _parent: this.account,</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+                    QueryInterface: XPCOMUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+                                                           Ci.nsISupportsWeakReference]),</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineplus">+</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineplus">+                    _cleanUp: function() {</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+                      this.webProgress.removeProgressListener(this);</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineplus">+                      this.window.close();</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineplus">+                      delete this.window;</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+                    },</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineplus">+</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+                    _checkForRedirect: function(aURL) {</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+                      if (aURL.indexOf(this._parent.completionURI) != 0)</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineplus">+                        return;</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineplus">+</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineplus">+                      this._parent.finishAuthorizationRequest();</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+                      this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+                    },</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+                    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+                      const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+                      if (aStateFlags &amp; (wpl.STATE_STOP)) {</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+                        try {</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineplus">+                            let httpchannel = aRequest.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineplus">+</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineplus">+                            let responseCategory = Math.floor(httpchannel.responseStatus / 100);</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineplus">+</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+                            if (responseCategory != 2 &amp;&amp; responseCategory != 3) {</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineplus">+                                this._parent.finishAuthorizationRequest();</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+                                this._parent.onAuthorizationFailed(null, '{ &quot;error&quot;: &quot;http_' + httpchannel.responseStatus + '&quot; }');</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+                            }</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineplus">+                        } catch (e if e.result == Components.results.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineplus">+                            // Catch the case where its not a http channel</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+                        }</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+                      }</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineplus">+</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineplus">+                      if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK))</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+                        this._checkForRedirect(aRequest.name);</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineplus">+                    },</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineplus">+                    onLocationChange: function(aWebProgress, aRequest, aLocation) {</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineplus">+                      this._checkForRedirect(aLocation.spec);</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineplus">+                    },</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineplus">+                    onProgressChange: function() {},</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineplus">+                    onStatusChange: function() {},</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+                    onSecurityChange: function() {},</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineplus">+                };</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineplus">+                aWebProgress.addProgressListener(this._listener,</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineplus">+                                                 Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+                aWindow.document.title = this.account.requestWindowTitle;</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+            }</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineplus">+        };</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineplus">+</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineplus">+        this.wrappedJSObject = this._browserRequest;</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineplus">+        Services.ww.openWindow(null, this.requestWindowURI, null, this.requestWindowFeatures, this);</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineplus">+    },</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineplus">+    finishAuthorizationRequest: function() {</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+        if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineplus">+            return;</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineplus">+        }</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineplus">+</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineplus">+        this._browserRequest._active = false;</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineplus">+        if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineplus">+            this._browserRequest._listener._cleanUp();</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineplus">+        }</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineplus">+        delete this._browserRequest;</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineplus">+    },</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineplus">+</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineplus">+    onAuthorizationReceived: function(aData) {</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineplus">+        this.log.info(&quot;authorization received&quot; + aData);</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineplus">+        let results = parseURLData(aData);</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineplus">+        if (this.responseType == &quot;code&quot;) {</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineplus">+            this.requestAccessToken(results.code, OAuth2.CODE_AUTHORIZATION);</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+        } else if (this.responseType == &quot;token&quot;) {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+            this.onAccessTokenReceived(JSON.stringify(results));</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineplus">+        }</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineplus">+    },</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineplus">+</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineplus">+    onAuthorizationFailed: function(aError, aData) {</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineplus">+        this.connecting = false;</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineplus">+        this.connectFailureCallback(aData);</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineplus">+    },</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineplus">+</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+    requestAccessToken: function requestAccessToken(aCode, aType) {</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineplus">+        let params = [</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineplus">+            [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineplus">+            [&quot;client_secret&quot;, this.consumerSecret],</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+            [&quot;grant_type&quot;, aType],</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineplus">+        ];</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineplus">+</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+        if (aType == OAuth2.CODE_AUTHORIZATION) {</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineplus">+            params.push([&quot;code&quot;, aCode]);</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineplus">+            params.push([&quot;redirect_uri&quot;, this.completionURI]);</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineplus">+        } else if (aType == OAuth2.CODE_REFRESH) {</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineplus">+            params.push([&quot;refresh_token&quot;, aCode]);</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineplus">+        }</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineplus">+</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+        let options = {</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineplus">+          postData: params,</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineplus">+          onLoad: this.onAccessTokenReceived.bind(this),</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineplus">+          onError: this.onAccessTokenFailed.bind(this)</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineplus">+        }</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineplus">+        httpRequest(this.tokenURI, options);</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+    },</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+    onAccessTokenFailed: function onAccessTokenFailed(aError, aData) {</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineplus">+        if (aError != &quot;offline&quot;) {</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineplus">+            this.refreshToken = null;</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineplus">+        }</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+        this.connecting = false;</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineplus">+        this.connectFailureCallback(aData);</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+    },</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineplus">+</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineplus">+    onAccessTokenReceived: function onRequestTokenReceived(aData) {</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+        let result = JSON.parse(aData);</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineplus">+</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineplus">+        this.accessToken = result.access_token;</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineplus">+        if (&quot;refresh_token&quot; in result) {</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineplus">+            this.refreshToken = result.refresh_token;</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineplus">+        }</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineplus">+        if (&quot;expires_in&quot; in result) {</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineplus">+            this.tokenExpires = (new Date()).getTime() + (result.expires_in * 1000);</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineplus">+        } else {</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineplus">+            this.tokenExpires = Number.MAX_VALUE;</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineplus">+        }</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineplus">+        this.tokenType = result.token_type;</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineplus">+</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineplus">+        this.connecting = false;</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineplus">+        this.connectSuccessCallback();</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineplus">+    }</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,130 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;LOGitem&quot;, &quot;LOGverbose&quot;, &quot;LOGinterval&quot;, &quot;stringException&quot;];</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+function LOGverbose(aStr) {</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+    if (Preferences.get(&quot;calendar.debug.log.verbose&quot;, false)) {</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+        cal.LOG(aStr);</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+    }</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+}</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+function stringException(e) {</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+    if (&quot;fileName&quot; in e &amp;&amp; &quot;lineNumber&quot; in e) {</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+        return &quot; (&quot; + e.fileName + &quot;:&quot; + e.lineNumber + &quot;):&quot; + e;</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+    } else {</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+        return e.toString();</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+    }</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+}</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+/**</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+ * LOGitem</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+ * Custom logging functions</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+ */</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+function LOGitem(item) {</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+    if (!item) {</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+        return;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+    }</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+    let attendees = item.getAttendees({});</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+    let attendeeString = &quot;&quot;;</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+    for each (let a in attendees) {</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+        attendeeString += &quot;\n&quot; + LOGattendee(a);</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+    }</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    let rstr = &quot;\n&quot;;</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+    if (item.recurrenceInfo) {</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+        let ritems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+        for each (let ritem in ritems) {</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+            rstr += &quot;\t\t&quot; + ritem.icalProperty.icalString;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+        }</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+        rstr += &quot;\tExceptions:\n&quot;;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+        let exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+        for each (let exc in exids) {</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+            rstr += &quot;\t\t&quot; + exc + &quot;\n&quot;;</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+        }</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+    }</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+    let astr = &quot;\n&quot;;</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+    let alarms = item.getAlarms({});</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+    for each (let alarm in alarms) {</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+        astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+    }</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+    LOGverbose(&quot;[calGoogleCalendar] Logging calIEvent:&quot; +</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+        &quot;\n\tid:&quot; + item.id +</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+        &quot;\n\tcreated:&quot; + item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+        &quot;\n\tupdated:&quot; + item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+        &quot;\n\ttitle:&quot; + item.title +</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+        &quot;\n\tdescription:&quot; + item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+        &quot;\n\ttransparency:&quot; + item.getProperty(&quot;TRANSP&quot;) +</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+        &quot;\n\tstatus:&quot; + item.status +</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+        &quot;\n\tstartTime:&quot; + (item.startDate &amp;&amp; item.startDate.toString()) +</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+        &quot;\n\tendTime:&quot; + (item.endDate &amp;&amp; item.endDate.toString()) +</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+        &quot;\n\tlocation:&quot; + item.getProperty(&quot;LOCATION&quot;) +</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+        &quot;\n\tprivacy:&quot; + item.privacy +</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+        &quot;\n\tsequence:&quot; + item.getProperty(&quot;SEQUENCE&quot;) +</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+        &quot;\n\talarmLastAck:&quot; + item.alarmLastAck +</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+        &quot;\n\tsnoozeTime:&quot; + item.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;) +</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+        &quot;\n\tisOccurrence: &quot; + (item.recurrenceId != null) +</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+        &quot;\n\tOrganizer: &quot; + LOGattendee(item.organizer) +</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+        &quot;\n\tAttendees: &quot; + attendeeString +</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+        &quot;\n\trecurrence: &quot; + (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;) +</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+        &quot;\n\talarms: &quot; + (astr.length &gt; 1 ? &quot;yes: &quot; + astr : &quot;no&quot;));</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+}</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+function LOGattendee(aAttendee, asString) {</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+    return aAttendee &amp;&amp;</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+        (&quot;\n\t\tID: &quot; + aAttendee.id +</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+         &quot;\n\t\t\tName: &quot; + aAttendee.commonName +</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+         &quot;\n\t\t\tRsvp: &quot; + aAttendee.rsvp +</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+         &quot;\n\t\t\tIs Organizer: &quot; + (aAttendee.isOrganizer ? &quot;yes&quot; : &quot;no&quot;) +</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+         &quot;\n\t\t\tRole: &quot; + aAttendee.role +</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+         &quot;\n\t\t\tStatus: &quot; + aAttendee.participationStatus);</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+}</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+function LOGalarm(aAlarm) {</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+    if (!aAlarm) {</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+    }</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineplus">+    let enumerator = aAlarm.propertyEnumerator;</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+    let xpropstr = &quot;&quot;;</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+    while (enumerator &amp;&amp; enumerator.hasMoreElements()) {</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+        let el = enumerator.getNext();</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+        xpropstr += &quot;\n\t\t\t&quot; + el.key + &quot;:&quot; + el.value;</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+    }</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+    return (&quot;\n\t\tAction: &quot; + aAlarm.action +</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+            &quot;\n\t\tOffset: &quot; + (aAlarm.offset &amp;&amp; aAlarm.offset.toString()) +</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+            &quot;\n\t\talarmDate: &quot; + (aAlarm.alarmDate &amp;&amp; aAlarm.alarmDate.toString()) +</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+            &quot;\n\t\trelated: &quot; + aAlarm.related +</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+            &quot;\n\t\trepeat: &quot; + aAlarm.repeat +</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+            &quot;\n\t\trepeatOffset: &quot; + (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+            &quot;\n\t\trepeatDate: &quot; + (aAlarm.repeatDate &amp;&amp; aAlarm.repeatDate.toString()) +</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+            &quot;\n\t\tdescription: &quot; + aAlarm.description +</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+            &quot;\n\t\tsummary: &quot; + aAlarm.summary +</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+            &quot;\n\t\tproperties: &quot; + (xpropstr.length &gt; 0 ? &quot;yes:&quot; + xpropstr : &quot;no&quot;));</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+}</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+function LOGinterval(aInterval) {</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+    const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+    if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+        type = &quot;FREE&quot;;</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+    } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+        type = &quot;BUSY&quot;;</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+    } else {</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+        type = aInterval.freeBusyType + &quot;(UNKNOWN)&quot;;</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+    }</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+    cal.LOG(&quot;[calGoogleCalendar] Interval from &quot; +</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+            aInterval.interval.start + &quot; to &quot; + aInterval.interval.end +</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+            &quot; is &quot; + type);</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">rename from calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l28.2"></a><span id="l28.2">rename to calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineat">@@ -1,82 +1,104 @@</span>
<a href="#l28.6"></a><span id="l28.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.7"></a><span id="l28.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.8"></a><span id="l28.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+CuImport(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;, this);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+CuImport(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+CuImport(&quot;resource://gre/modules/Promise.jsm&quot;, this);</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+const cIE = Components.interfaces.calIErrors;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+var API_BASE = {</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+    EVENTS: &quot;https://www.googleapis.com/calendar/v3/&quot;,</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+    TASKS: &quot;https://www.googleapis.com/tasks/v1/&quot;</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+};</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;calGoogleRequest&quot;, &quot;getCorrectedDate&quot;, &quot;API_BASE&quot;];</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+/**</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+ * Gets the date and time that Google's http server last sent us. Note the</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+ * passed argument is modified. This might not be the exact server time (i.e it</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+ * may be off by network latency), but it does give a good guess when syncing.</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+ *</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+ * @param aDate     The date to modify.</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+ */</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+function getCorrectedDate(aDate) {</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+    if (getCorrectedDate.mClockSkew) {</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+        aDate.second += getCorrectedDate.mClockSkew;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+    }</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    return aDate;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+}</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47"> /**</span>
<a href="#l28.48"></a><span id="l28.48">  * calGoogleRequest</span>
<a href="#l28.49"></a><span id="l28.49">  * This class represents a HTTP request sent to Google</span>
<a href="#l28.50"></a><span id="l28.50">  *</span>
<a href="#l28.51"></a><span id="l28.51">  * @constructor</span>
<a href="#l28.52"></a><span id="l28.52">  * @class</span>
<a href="#l28.53"></a><span id="l28.53">  */</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-function calGoogleRequest(aSession) {</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-    this.mQueryParameters = new Array();</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-    this.mSession = aSession;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+function calGoogleRequest() {</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+    this.mQueryParameters = new Map();</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+    this.mRequestHeaders = new Map();</span>
<a href="#l28.60"></a><span id="l28.60">     this.wrappedJSObject = this;</span>
<a href="#l28.61"></a><span id="l28.61"> }</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-const calGoogleRequestClassID = Components.ID(&quot;{53a3438a-21bc-4a0f-b813-77a8b4f19282}&quot;);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-const calGoogleRequestInterfaces = [</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-    Components.interfaces.calIGoogleRequest,</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-    Components.interfaces.calIOperation,</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-    Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-    Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    Components.interfaces.nsIChannelEventSink</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-];</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+calGoogleRequest.LOGIN = 0;</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+calGoogleRequest.ADD = 1;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+calGoogleRequest.MODIFY = 2;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+calGoogleRequest.DELETE = 3;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+calGoogleRequest.GET = 4;</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+const GDATA_ERROR_BASE = Components.interfaces.calIErrors.ERROR_BASE + 0x400;</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+calGoogleRequest.LOGIN_FAILED = GDATA_ERROR_BASE + 1;</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+calGoogleRequest.CONFLICT_DELETED = GDATA_ERROR_BASE + 2;</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+calGoogleRequest.CONFLICT_MODIFY = GDATA_ERROR_BASE + 3;</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+calGoogleRequest.NOT_MODIFIED = GDATA_ERROR_BASE + 4;</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+calGoogleRequest.QUOTA_FAILURE = GDATA_ERROR_BASE + 5;</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+calGoogleRequest.TOKEN_FAILURE = GDATA_ERROR_BASE + 6;</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+calGoogleRequest.RESOURCE_GONE = GDATA_ERROR_BASE + 7;</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+</span>
<a href="#l28.85"></a><span id="l28.85"> calGoogleRequest.prototype = {</span>
<a href="#l28.86"></a><span id="l28.86"> </span>
<a href="#l28.87"></a><span id="l28.87">     /* Members */</span>
<a href="#l28.88"></a><span id="l28.88">     mUploadContent: null,</span>
<a href="#l28.89"></a><span id="l28.89">     mUploadData: null,</span>
<a href="#l28.90"></a><span id="l28.90">     mSession: null,</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-    mExtraData: null,</span>
<a href="#l28.92"></a><span id="l28.92">     mQueryParameters: null,</span>
<a href="#l28.93"></a><span id="l28.93">     mType: null,</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-    mCalendar: null,</span>
<a href="#l28.95"></a><span id="l28.95">     mLoader: null,</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+    mDeferred: null,</span>
<a href="#l28.97"></a><span id="l28.97">     mStatus: Components.results.NS_OK,</span>
<a href="#l28.98"></a><span id="l28.98"> </span>
<a href="#l28.99"></a><span id="l28.99">     /* Constants */</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-    LOGIN: 0,</span>
<a href="#l28.101"></a><span id="l28.101">     ADD: 1,</span>
<a href="#l28.102"></a><span id="l28.102">     MODIFY: 2,</span>
<a href="#l28.103"></a><span id="l28.103">     DELETE: 3,</span>
<a href="#l28.104"></a><span id="l28.104">     GET: 4,</span>
<a href="#l28.105"></a><span id="l28.105"> </span>
<a href="#l28.106"></a><span id="l28.106">     /* Simple Attributes */</span>
<a href="#l28.107"></a><span id="l28.107">     method: &quot;GET&quot;,</span>
<a href="#l28.108"></a><span id="l28.108">     id: null,</span>
<a href="#l28.109"></a><span id="l28.109">     uri: null,</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineminus">-    responseListener: null,</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineminus">-    operationListener: null,</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+    calendar: null,</span>
<a href="#l28.113"></a><span id="l28.113">     reauthenticate: true,</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+    requestDate: null,</span>
<a href="#l28.115"></a><span id="l28.115"> </span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-    itemRangeStart: null,</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-    itemRangeEnd: null,</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-    itemFilter: null,</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineminus">-    itemId: null,</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-    calendar: null,</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineminus">-    newItem: null,</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-    oldItem: null,</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-    destinationCal: null,</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineminus">-    classID: calGoogleRequestClassID,</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI(calGoogleRequestInterfaces),</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineminus">-        classID: calGoogleRequestClassID,</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/request;1&quot;,</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineminus">-        classDescription: &quot;Google Calendar Request&quot;,</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-        interfaces: calGoogleRequestInterfaces</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-    }),</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+        Components.interfaces.calIOperation,</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+        Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+        Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+        Components.interfaces.nsIChannelEventSink</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+    ]),</span>
<a href="#l28.139"></a><span id="l28.139"> </span>
<a href="#l28.140"></a><span id="l28.140">     /**</span>
<a href="#l28.141"></a><span id="l28.141">      * Implement calIOperation</span>
<a href="#l28.142"></a><span id="l28.142">      */</span>
<a href="#l28.143"></a><span id="l28.143">     get isPending() {</span>
<a href="#l28.144"></a><span id="l28.144">         return (this.mLoader &amp;&amp; this.mLoader.request != null);</span>
<a href="#l28.145"></a><span id="l28.145">     },</span>
<a href="#l28.146"></a><span id="l28.146"> </span>
<a href="#l28.147"></a><span id="l28.147" class="difflineat">@@ -85,182 +107,176 @@ calGoogleRequest.prototype = {</span>
<a href="#l28.148"></a><span id="l28.148">             return this.mLoader.request.status;</span>
<a href="#l28.149"></a><span id="l28.149">         } else {</span>
<a href="#l28.150"></a><span id="l28.150">             return this.mStatus;</span>
<a href="#l28.151"></a><span id="l28.151">         }</span>
<a href="#l28.152"></a><span id="l28.152">     },</span>
<a href="#l28.153"></a><span id="l28.153"> </span>
<a href="#l28.154"></a><span id="l28.154">     cancel: function cGR_cancel(aStatus) {</span>
<a href="#l28.155"></a><span id="l28.155">         if (this.isPending) {</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-            this.mLoader.request.cancel(aStatus);</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineplus">+            if (this.mLoader) {</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+                this.mLoader.request.cancel(aStatus);</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineplus">+            }</span>
<a href="#l28.160"></a><span id="l28.160">             this.mStatus = aStatus;</span>
<a href="#l28.161"></a><span id="l28.161">         }</span>
<a href="#l28.162"></a><span id="l28.162">     },</span>
<a href="#l28.163"></a><span id="l28.163"> </span>
<a href="#l28.164"></a><span id="l28.164">     /**</span>
<a href="#l28.165"></a><span id="l28.165">      * attribute type</span>
<a href="#l28.166"></a><span id="l28.166">      * The type of this reqest. Must be one of</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineminus">-     * LOGIN, GET, ADD, MODIFY, DELETE</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-     * This also sets the Request Method and for the LOGIN request also the uri</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+     * GET, ADD, MODIFY, DELETE</span>
<a href="#l28.170"></a><span id="l28.170">      */</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineminus">-    get type() { return this.mType; },</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineplus">+    get type() this.mType,</span>
<a href="#l28.173"></a><span id="l28.173"> </span>
<a href="#l28.174"></a><span id="l28.174">     set type(v) {</span>
<a href="#l28.175"></a><span id="l28.175">         switch (v) {</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-            case this.LOGIN:</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-                this.method = &quot;POST&quot;;</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineminus">-                this.uri = &quot;https://www.google.com/accounts/ClientLogin&quot;;</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineminus">-                break;</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-            case this.GET:</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-                this.method = &quot;GET&quot;;</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-                break;</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-            case this.ADD:</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineminus">-                this.method = &quot;POST&quot;;</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineminus">-                break;</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-            case this.MODIFY:</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-                this.method = &quot;PUT&quot;;</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineminus">-                break;</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineminus">-            case this.DELETE:</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-                this.method = &quot;DELETE&quot;;</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineminus">-                break;</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineplus">+            case this.GET: this.method = &quot;GET&quot;; break;</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineplus">+            case this.ADD: this.method = &quot;POST&quot;; break;</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineplus">+            case this.MODIFY: this.method = &quot;PUT&quot;; break;</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+            case this.DELETE: this.method = &quot;DELETE&quot;; break;</span>
<a href="#l28.196"></a><span id="l28.196">             default:</span>
<a href="#l28.197"></a><span id="l28.197">                 throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l28.198"></a><span id="l28.198">                 break;</span>
<a href="#l28.199"></a><span id="l28.199">         }</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-        this.mType = v;</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineminus">-        return v;</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+        return (this.mType = v);</span>
<a href="#l28.203"></a><span id="l28.203">     },</span>
<a href="#l28.204"></a><span id="l28.204"> </span>
<a href="#l28.205"></a><span id="l28.205">     /**</span>
<a href="#l28.206"></a><span id="l28.206">      * setUploadData</span>
<a href="#l28.207"></a><span id="l28.207">      * The HTTP body data for a POST or PUT request.</span>
<a href="#l28.208"></a><span id="l28.208">      *</span>
<a href="#l28.209"></a><span id="l28.209" class="difflineminus">-     * @param aContentType The Content type of the Data</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-     * @param aData        The Data to upload</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineplus">+     * @param aContentType The Content type of the Data.</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineplus">+     * @param aData        The Data to upload.</span>
<a href="#l28.213"></a><span id="l28.213">      */</span>
<a href="#l28.214"></a><span id="l28.214">     setUploadData: function cGR_setUploadData(aContentType, aData) {</span>
<a href="#l28.215"></a><span id="l28.215">         this.mUploadContent = aContentType;</span>
<a href="#l28.216"></a><span id="l28.216">         this.mUploadData = aData;</span>
<a href="#l28.217"></a><span id="l28.217">     },</span>
<a href="#l28.218"></a><span id="l28.218"> </span>
<a href="#l28.219"></a><span id="l28.219" class="difflineminus">-    /**</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineminus">-     * addQueryParameter</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineminus">-     * Adds a query parameter to this request. This will be used in conjunction</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineminus">-     * with the uri.</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-     *</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-     * @param aKey      The key of the request parameter.</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-     * @param aValue    The value of the request parameter. This parameter will</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineminus">-     *                  be escaped.</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineminus">-     */</span>
<a href="#l28.228"></a><span id="l28.228">     addQueryParameter: function cGR_addQueryParameter(aKey, aValue) {</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineminus">-        if (aValue == null || aValue == &quot;&quot;) {</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineminus">-            // Silently ignore empty values.</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-            return;</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineplus">+        if (aValue) {</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineplus">+            this.mQueryParameters.set(aKey, aValue);</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineplus">+        } else {</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineplus">+            this.mQueryParameters.delete(aKey);</span>
<a href="#l28.236"></a><span id="l28.236">         }</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-        this.mQueryParameters.push(aKey + &quot;=&quot; + encodeURIComponent(aValue));</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineplus">+    },</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineplus">+    addRequestHeader: function cGR_addRequestHeader(aKey, aValue) {</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineplus">+        if (aValue) {</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineplus">+            this.mRequestHeaders.set(aKey, aValue);</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineplus">+        } else {</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineplus">+            this.mRequestHeaders.delete(aKey);</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineplus">+        }</span>
<a href="#l28.246"></a><span id="l28.246">     },</span>
<a href="#l28.247"></a><span id="l28.247"> </span>
<a href="#l28.248"></a><span id="l28.248">     /**</span>
<a href="#l28.249"></a><span id="l28.249">      * commit</span>
<a href="#l28.250"></a><span id="l28.250">      * Starts the request process. This can be called multiple times if the</span>
<a href="#l28.251"></a><span id="l28.251">      * request should be repeated</span>
<a href="#l28.252"></a><span id="l28.252">      *</span>
<a href="#l28.253"></a><span id="l28.253">      * @param aSession  The session object this request should be made with.</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-     *                  This parameter is optional</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+     *                  This parameter is optional.</span>
<a href="#l28.256"></a><span id="l28.256">      */</span>
<a href="#l28.257"></a><span id="l28.257">     commit: function cGR_commit(aSession) {</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineplus">+        if (!this.mDeferred) {</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+            this.mDeferred = Promise.defer();</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineplus">+        }</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineplus">+        let promise = this.mDeferred.promise;</span>
<a href="#l28.262"></a><span id="l28.262"> </span>
<a href="#l28.263"></a><span id="l28.263">         try {</span>
<a href="#l28.264"></a><span id="l28.264">             // Set the session to request with</span>
<a href="#l28.265"></a><span id="l28.265">             if (aSession) {</span>
<a href="#l28.266"></a><span id="l28.266">                 this.mSession = aSession;</span>
<a href="#l28.267"></a><span id="l28.267">             }</span>
<a href="#l28.268"></a><span id="l28.268"> </span>
<a href="#l28.269"></a><span id="l28.269" class="difflineplus">+            // create the channel</span>
<a href="#l28.270"></a><span id="l28.270">             let uristring = this.uri;</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-            if (this.mQueryParameters.length &gt; 0) {</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineminus">-                uristring += &quot;?&quot; + this.mQueryParameters.join(&quot;&amp;&quot;);</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineplus">+            if (this.mQueryParameters.size &gt; 0) {</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineplus">+                let params = [];</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineplus">+</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+                // Using forEach is needed for backwards compatibility</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+                this.mQueryParameters.forEach(function(v, k) {</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineplus">+                    params.push(k + &quot;=&quot; + encodeURIComponent(v));</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineplus">+                });</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+                uristring += &quot;?&quot; + params.join(&quot;&amp;&quot;);</span>
<a href="#l28.281"></a><span id="l28.281">             }</span>
<a href="#l28.282"></a><span id="l28.282">             let uri = Services.io.newURI(uristring, null, null);</span>
<a href="#l28.283"></a><span id="l28.283">             let channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+            cal.LOG(&quot;[calGoogleRequest] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineplus">+                    channel.URI.spec);</span>
<a href="#l28.286"></a><span id="l28.286"> </span>
<a href="#l28.287"></a><span id="l28.287">             this.prepareChannel(channel);</span>
<a href="#l28.288"></a><span id="l28.288"> </span>
<a href="#l28.289"></a><span id="l28.289">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l28.290"></a><span id="l28.290">             channel.redirectionLimit = 3;</span>
<a href="#l28.291"></a><span id="l28.291"> </span>
<a href="#l28.292"></a><span id="l28.292">             this.mLoader = cal.createStreamLoader();</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineminus">-</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineminus">-                    channel.URI.spec);</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineminus">-</span>
<a href="#l28.297"></a><span id="l28.297">             channel.notificationCallbacks = this;</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineminus">-</span>
<a href="#l28.299"></a><span id="l28.299">             cal.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l28.300"></a><span id="l28.300">         } catch (e) {</span>
<a href="#l28.301"></a><span id="l28.301">             // Let the response function handle the error that happens here</span>
<a href="#l28.302"></a><span id="l28.302">             this.fail(e.result, e.message);</span>
<a href="#l28.303"></a><span id="l28.303">         }</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineplus">+        return promise;</span>
<a href="#l28.305"></a><span id="l28.305">     },</span>
<a href="#l28.306"></a><span id="l28.306"> </span>
<a href="#l28.307"></a><span id="l28.307">     /**</span>
<a href="#l28.308"></a><span id="l28.308">      * fail</span>
<a href="#l28.309"></a><span id="l28.309">      * Call this request's listener with the given code and Message</span>
<a href="#l28.310"></a><span id="l28.310">      *</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineminus">-     * @param aCode     The Error code to fail with</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineplus">+     * @param aCode     The Error code to fail with.</span>
<a href="#l28.313"></a><span id="l28.313">      * @param aMessage  The Error message. If this is null, an error Message</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineminus">-     *                  from calIGoogleErrors will be used.</span>
<a href="#l28.315"></a><span id="l28.315" class="difflineplus">+     *                  from calGoogleRequest will be used.</span>
<a href="#l28.316"></a><span id="l28.316">      */</span>
<a href="#l28.317"></a><span id="l28.317">     fail: function cGR_fail(aCode, aMessage) {</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineplus">+        let ex = new Components.Exception(aMessage, aCode);</span>
<a href="#l28.319"></a><span id="l28.319">         this.mLoader = null;</span>
<a href="#l28.320"></a><span id="l28.320">         this.mStatus = aCode;</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineminus">-        this.responseListener.onResult(this, aMessage);</span>
<a href="#l28.322"></a><span id="l28.322" class="difflineplus">+        this.mDeferred.reject(ex);</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineplus">+        this.mDeferred = null;</span>
<a href="#l28.324"></a><span id="l28.324">     },</span>
<a href="#l28.325"></a><span id="l28.325"> </span>
<a href="#l28.326"></a><span id="l28.326">     /**</span>
<a href="#l28.327"></a><span id="l28.327">      * succeed</span>
<a href="#l28.328"></a><span id="l28.328">      * Call this request's listener with a Success Code and the given Result.</span>
<a href="#l28.329"></a><span id="l28.329">      *</span>
<a href="#l28.330"></a><span id="l28.330">      * @param aResult   The result Text of this request.</span>
<a href="#l28.331"></a><span id="l28.331">      */</span>
<a href="#l28.332"></a><span id="l28.332">     succeed: function cGR_succeed(aResult) {</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineminus">-        // Succeeding is nothing more than failing with the result code set to</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineminus">-        // NS_OK.</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineminus">-        this.fail(Components.results.NS_OK, aResult);</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineplus">+        this.mLoader = null;</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineplus">+        this.mStatus = Components.results.NS_OK;</span>
<a href="#l28.338"></a><span id="l28.338" class="difflineplus">+        this.mDeferred.resolve(aResult);</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineplus">+        this.mDeferred = null;</span>
<a href="#l28.340"></a><span id="l28.340">     },</span>
<a href="#l28.341"></a><span id="l28.341"> </span>
<a href="#l28.342"></a><span id="l28.342">     /**</span>
<a href="#l28.343"></a><span id="l28.343">      * prepareChannel</span>
<a href="#l28.344"></a><span id="l28.344">      * Prepares the passed channel to match this objects properties</span>
<a href="#l28.345"></a><span id="l28.345">      *</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineminus">-     * @param aChannel    The Channel to be prepared</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineplus">+     * @param aChannel    The Channel to be prepared.</span>
<a href="#l28.348"></a><span id="l28.348">      */</span>
<a href="#l28.349"></a><span id="l28.349">     prepareChannel: function cGR_prepareChannel(aChannel) {</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineminus">-</span>
<a href="#l28.351"></a><span id="l28.351">         // No caching</span>
<a href="#l28.352"></a><span id="l28.352">         aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l28.353"></a><span id="l28.353"> </span>
<a href="#l28.354"></a><span id="l28.354">         // Set upload Data</span>
<a href="#l28.355"></a><span id="l28.355">         if (this.mUploadData) {</span>
<a href="#l28.356"></a><span id="l28.356">             let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l28.357"></a><span id="l28.357">                             createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l28.358"></a><span id="l28.358">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l28.359"></a><span id="l28.359"> </span>
<a href="#l28.360"></a><span id="l28.360">             let stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l28.361"></a><span id="l28.361">             aChannel = aChannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l28.362"></a><span id="l28.362">             aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l28.363"></a><span id="l28.363"> </span>
<a href="#l28.364"></a><span id="l28.364" class="difflineminus">-            if (this.mType == this.LOGIN) {</span>
<a href="#l28.365"></a><span id="l28.365" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Setting upload data for login request (hidden)&quot;);</span>
<a href="#l28.366"></a><span id="l28.366" class="difflineminus">-            } else {</span>
<a href="#l28.367"></a><span id="l28.367" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineminus">-                        this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineminus">-            }</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineplus">+                    this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l28.372"></a><span id="l28.372">         }</span>
<a href="#l28.373"></a><span id="l28.373"> </span>
<a href="#l28.374"></a><span id="l28.374" class="difflineminus">-        aChannel  = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l28.375"></a><span id="l28.375" class="difflineplus">+        aChannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l28.376"></a><span id="l28.376"> </span>
<a href="#l28.377"></a><span id="l28.377">         // Depending on the preference, we will use X-HTTP-Method-Override to</span>
<a href="#l28.378"></a><span id="l28.378">         // get around some proxies. This will default to true.</span>
<a href="#l28.379"></a><span id="l28.379">         if (Preferences.get(&quot;calendar.google.useHTTPMethodOverride&quot;, true) &amp;&amp;</span>
<a href="#l28.380"></a><span id="l28.380">             (this.method == &quot;PUT&quot; || this.method == &quot;DELETE&quot;)) {</span>
<a href="#l28.381"></a><span id="l28.381"> </span>
<a href="#l28.382"></a><span id="l28.382">             aChannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l28.383"></a><span id="l28.383">             aChannel.setRequestHeader(&quot;X-HTTP-Method-Override&quot;,</span>
<a href="#l28.384"></a><span id="l28.384" class="difflineat">@@ -273,22 +289,34 @@ calGoogleRequest.prototype = {</span>
<a href="#l28.385"></a><span id="l28.385">                                           &quot;application/atom+xml; charset=UTF-8&quot;,</span>
<a href="#l28.386"></a><span id="l28.386">                                           false);</span>
<a href="#l28.387"></a><span id="l28.387">                 aChannel.setRequestHeader(&quot;Content-Length&quot;, 0, false);</span>
<a href="#l28.388"></a><span id="l28.388">             }</span>
<a href="#l28.389"></a><span id="l28.389">         } else {</span>
<a href="#l28.390"></a><span id="l28.390">             aChannel.requestMethod = this.method;</span>
<a href="#l28.391"></a><span id="l28.391">         }</span>
<a href="#l28.392"></a><span id="l28.392"> </span>
<a href="#l28.393"></a><span id="l28.393" class="difflineplus">+        if (this.mRequestHeaders.size) {</span>
<a href="#l28.394"></a><span id="l28.394" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Sending request headers: &quot; + this.mRequestHeaders.toSource());</span>
<a href="#l28.395"></a><span id="l28.395" class="difflineplus">+        }</span>
<a href="#l28.396"></a><span id="l28.396" class="difflineplus">+</span>
<a href="#l28.397"></a><span id="l28.397" class="difflineplus">+        // Using forEach is needed for backwards compatibility</span>
<a href="#l28.398"></a><span id="l28.398" class="difflineplus">+        this.mRequestHeaders.forEach(function(v, k) {</span>
<a href="#l28.399"></a><span id="l28.399" class="difflineplus">+            aChannel.setRequestHeader(k, v, false);</span>
<a href="#l28.400"></a><span id="l28.400" class="difflineplus">+        });</span>
<a href="#l28.401"></a><span id="l28.401" class="difflineplus">+</span>
<a href="#l28.402"></a><span id="l28.402">         // Add Authorization</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-        if (this.mSession.authToken) {</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineplus">+        let token = this.mSession.accessToken;</span>
<a href="#l28.405"></a><span id="l28.405" class="difflineplus">+        if (token) {</span>
<a href="#l28.406"></a><span id="l28.406">             aChannel.setRequestHeader(&quot;Authorization&quot;,</span>
<a href="#l28.407"></a><span id="l28.407" class="difflineminus">-                                      &quot;GoogleLogin auth=&quot;</span>
<a href="#l28.408"></a><span id="l28.408" class="difflineminus">-                                      +  this.mSession.authToken,</span>
<a href="#l28.409"></a><span id="l28.409" class="difflineplus">+                                      &quot;Bearer &quot; + token,</span>
<a href="#l28.410"></a><span id="l28.410">                                       false);</span>
<a href="#l28.411"></a><span id="l28.411" class="difflineplus">+        } else {</span>
<a href="#l28.412"></a><span id="l28.412" class="difflineplus">+            cal.WARN(&quot;[calGoogleCalendar] Missing access token for &quot; +</span>
<a href="#l28.413"></a><span id="l28.413" class="difflineplus">+                     aChannel.URI.spec);</span>
<a href="#l28.414"></a><span id="l28.414">         }</span>
<a href="#l28.415"></a><span id="l28.415">     },</span>
<a href="#l28.416"></a><span id="l28.416"> </span>
<a href="#l28.417"></a><span id="l28.417">     /**</span>
<a href="#l28.418"></a><span id="l28.418">      * @see nsIInterfaceRequestor</span>
<a href="#l28.419"></a><span id="l28.419">      * @see calProviderUtils.jsm</span>
<a href="#l28.420"></a><span id="l28.420">      */</span>
<a href="#l28.421"></a><span id="l28.421">     getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l28.422"></a><span id="l28.422" class="difflineat">@@ -323,98 +351,163 @@ calGoogleRequest.prototype = {</span>
<a href="#l28.423"></a><span id="l28.423">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l28.424"></a><span id="l28.424">         let result = cal.convertByteArray(aResult, aResultLength, httpChannel.contentCharset);</span>
<a href="#l28.425"></a><span id="l28.425">         if (result === null) {</span>
<a href="#l28.426"></a><span id="l28.426">             this.fail(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l28.427"></a><span id="l28.427">                       &quot;Could not convert bytestream to Unicode: &quot; + e);</span>
<a href="#l28.428"></a><span id="l28.428">             return;</span>
<a href="#l28.429"></a><span id="l28.429">         }</span>
<a href="#l28.430"></a><span id="l28.430"> </span>
<a href="#l28.431"></a><span id="l28.431" class="difflineplus">+        let objData;</span>
<a href="#l28.432"></a><span id="l28.432" class="difflineplus">+        try {</span>
<a href="#l28.433"></a><span id="l28.433" class="difflineplus">+            if (result.length) {</span>
<a href="#l28.434"></a><span id="l28.434" class="difflineplus">+                objData = JSON.parse(result);</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineplus">+            } else {</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineplus">+                objData = { status: &quot;No Content&quot; };</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineplus">+            }</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineplus">+        } catch (e) {</span>
<a href="#l28.439"></a><span id="l28.439" class="difflineplus">+            cal.ERROR(&quot;[calGoogleCalendar] Could not parse API response as &quot; +</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineplus">+                      &quot;JSON: &quot; + result);</span>
<a href="#l28.441"></a><span id="l28.441" class="difflineplus">+            this.fail(Components.results.NS_ERROR_FAILURE, result);</span>
<a href="#l28.442"></a><span id="l28.442" class="difflineplus">+        }</span>
<a href="#l28.443"></a><span id="l28.443" class="difflineplus">+</span>
<a href="#l28.444"></a><span id="l28.444">         // Calculate Google Clock Skew</span>
<a href="#l28.445"></a><span id="l28.445">         let serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span>
<a href="#l28.446"></a><span id="l28.446">         let curDate = new Date();</span>
<a href="#l28.447"></a><span id="l28.447"> </span>
<a href="#l28.448"></a><span id="l28.448">         // The utility function getCorrectedDate in calGoogleUtils.js receives</span>
<a href="#l28.449"></a><span id="l28.449">         // its clock skew seconds from here. The clock skew is updated on each</span>
<a href="#l28.450"></a><span id="l28.450" class="difflineminus">-        // request and is therefore quite accurate.</span>
<a href="#l28.451"></a><span id="l28.451" class="difflineminus">-        getCorrectedDate.mClockSkew = curDate.getTime() - serverDate.getTime();</span>
<a href="#l28.452"></a><span id="l28.452" class="difflineplus">+        // request and is therefore quite accurate. As this calculation doesn't</span>
<a href="#l28.453"></a><span id="l28.453" class="difflineplus">+        // take latency into account it might overlap 1-2 seconds, but better</span>
<a href="#l28.454"></a><span id="l28.454" class="difflineplus">+        // one event too much than one event too little.</span>
<a href="#l28.455"></a><span id="l28.455" class="difflineplus">+        getCorrectedDate.mClockSkew = Math.floor((curDate.getTime() - serverDate.getTime()) / 1000);</span>
<a href="#l28.456"></a><span id="l28.456" class="difflineplus">+        if (getCorrectedDate.mClockSkew != 0) {</span>
<a href="#l28.457"></a><span id="l28.457" class="difflineplus">+            cal.LOG(&quot;[calGoogleRequest] Clock skew is &quot; + getCorrectedDate.mClockSkew + &quot; seconds&quot;);</span>
<a href="#l28.458"></a><span id="l28.458" class="difflineplus">+        }</span>
<a href="#l28.459"></a><span id="l28.459"> </span>
<a href="#l28.460"></a><span id="l28.460">         // Remember when this request happened</span>
<a href="#l28.461"></a><span id="l28.461" class="difflineminus">-        this.requestDate = cal.jsDateToDateTime(serverDate);</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineplus">+        this.requestDate = cal.createDateTime();</span>
<a href="#l28.463"></a><span id="l28.463" class="difflineplus">+        this.requestDate.nativeTime = serverDate.getTime() * 1000;</span>
<a href="#l28.464"></a><span id="l28.464" class="difflineplus">+</span>
<a href="#l28.465"></a><span id="l28.465" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Request &quot; + this.method + &quot; &quot; +</span>
<a href="#l28.466"></a><span id="l28.466" class="difflineplus">+                httpChannel.URI.spec + &quot; responded with HTTP &quot;</span>
<a href="#l28.467"></a><span id="l28.467" class="difflineplus">+                + httpChannel.responseStatus);</span>
<a href="#l28.468"></a><span id="l28.468"> </span>
<a href="#l28.469"></a><span id="l28.469">         // Handle all (documented) error codes</span>
<a href="#l28.470"></a><span id="l28.470">         switch (httpChannel.responseStatus) {</span>
<a href="#l28.471"></a><span id="l28.471">             case 200: /* No error. */</span>
<a href="#l28.472"></a><span id="l28.472">             case 201: /* Creation of a resource was successful. */</span>
<a href="#l28.473"></a><span id="l28.473" class="difflineplus">+            case 204: /* No content */</span>
<a href="#l28.474"></a><span id="l28.474">                 // Everything worked out, we are done</span>
<a href="#l28.475"></a><span id="l28.475" class="difflineminus">-                this.succeed(result);</span>
<a href="#l28.476"></a><span id="l28.476" class="difflineplus">+                if (this.calendar) {</span>
<a href="#l28.477"></a><span id="l28.477" class="difflineplus">+                    this.calendar.setProperty(&quot;currentStatus&quot;, 0);</span>
<a href="#l28.478"></a><span id="l28.478" class="difflineplus">+                }</span>
<a href="#l28.479"></a><span id="l28.479" class="difflineplus">+                this.succeed(objData);</span>
<a href="#l28.480"></a><span id="l28.480">                 break;</span>
<a href="#l28.481"></a><span id="l28.481" class="difflineminus">-</span>
<a href="#l28.482"></a><span id="l28.482" class="difflineplus">+            case 304: /* Not modified */</span>
<a href="#l28.483"></a><span id="l28.483" class="difflineplus">+                this.fail(calGoogleRequest.NOT_MODIFIED, objData);</span>
<a href="#l28.484"></a><span id="l28.484" class="difflineplus">+                break;</span>
<a href="#l28.485"></a><span id="l28.485">             case 401: /* Authorization required. */</span>
<a href="#l28.486"></a><span id="l28.486" class="difflineminus">-            case 403: /* Unsupported standard parameter, or authentication or</span>
<a href="#l28.487"></a><span id="l28.487" class="difflineplus">+            case 403: { /* Unsupported standard parameter, or authentication or</span>
<a href="#l28.488"></a><span id="l28.488">                          Authorization failed. */</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Login failed for &quot; + this.mSession.userName +</span>
<a href="#l28.490"></a><span id="l28.490" class="difflineminus">-                        &quot; HTTP Status &quot; + httpChannel.responseStatus);</span>
<a href="#l28.491"></a><span id="l28.491" class="difflineminus">-</span>
<a href="#l28.492"></a><span id="l28.492" class="difflineminus">-                // login failed. auth token must be invalid, password too</span>
<a href="#l28.493"></a><span id="l28.493" class="difflineminus">-</span>
<a href="#l28.494"></a><span id="l28.494" class="difflineminus">-                if (this.type == this.MODIFY ||</span>
<a href="#l28.495"></a><span id="l28.495" class="difflineminus">-                    this.type == this.DELETE ||</span>
<a href="#l28.496"></a><span id="l28.496" class="difflineminus">-                    this.type == this.ADD) {</span>
<a href="#l28.497"></a><span id="l28.497" class="difflineminus">-                    // Encountering this error on a write request means the</span>
<a href="#l28.498"></a><span id="l28.498" class="difflineminus">-                    // calendar is readonly</span>
<a href="#l28.499"></a><span id="l28.499" class="difflineminus">-                    this.fail(Components.interfaces.calIErrors.CAL_IS_READONLY, result);</span>
<a href="#l28.500"></a><span id="l28.500" class="difflineminus">-                } else if (!this.reauthenticate) {</span>
<a href="#l28.501"></a><span id="l28.501" class="difflineminus">-                    // If no reauth was requested, then don't invalidate the</span>
<a href="#l28.502"></a><span id="l28.502" class="difflineminus">-                    // whole session and just bail out</span>
<a href="#l28.503"></a><span id="l28.503" class="difflineminus">-                    this.fail(kGOOGLE_LOGIN_FAILED, result);</span>
<a href="#l28.504"></a><span id="l28.504" class="difflineminus">-                } else if (this.type == this.LOGIN) {</span>
<a href="#l28.505"></a><span id="l28.505" class="difflineminus">-                    // If this was a login request itself, then fail it.</span>
<a href="#l28.506"></a><span id="l28.506" class="difflineminus">-                    // That will take care of logging in again</span>
<a href="#l28.507"></a><span id="l28.507" class="difflineminus">-                    this.mSession.invalidate();</span>
<a href="#l28.508"></a><span id="l28.508" class="difflineminus">-                    this.fail(kGOOGLE_LOGIN_FAILED, result);</span>
<a href="#l28.509"></a><span id="l28.509" class="difflineminus">-                } else {</span>
<a href="#l28.510"></a><span id="l28.510" class="difflineminus">-                    // Retry the request. Invalidating the session will trigger</span>
<a href="#l28.511"></a><span id="l28.511" class="difflineminus">-                    // a new login dialog.</span>
<a href="#l28.512"></a><span id="l28.512" class="difflineminus">-                    this.mSession.invalidate();</span>
<a href="#l28.513"></a><span id="l28.513" class="difflineminus">-                    this.mSession.asyncItemRequest(this);</span>
<a href="#l28.514"></a><span id="l28.514" class="difflineplus">+                let reason = objData &amp;&amp; objData.error &amp;&amp;</span>
<a href="#l28.515"></a><span id="l28.515" class="difflineplus">+                             objData.error.errors &amp;&amp; objData.error.errors[0] &amp;&amp;</span>
<a href="#l28.516"></a><span id="l28.516" class="difflineplus">+                             objData.error.errors[0].reason;</span>
<a href="#l28.517"></a><span id="l28.517" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Login failed for &quot; + this.mSession.id +</span>
<a href="#l28.518"></a><span id="l28.518" class="difflineplus">+                        &quot; HTTP Status: &quot; + httpChannel.responseStatus +</span>
<a href="#l28.519"></a><span id="l28.519" class="difflineplus">+                        &quot; Reason: &quot; + (reason || result));</span>
<a href="#l28.520"></a><span id="l28.520" class="difflineplus">+                switch (reason) {</span>
<a href="#l28.521"></a><span id="l28.521" class="difflineplus">+                    case &quot;invalid_client&quot;:</span>
<a href="#l28.522"></a><span id="l28.522" class="difflineplus">+                    case &quot;unauthorized_client&quot;:</span>
<a href="#l28.523"></a><span id="l28.523" class="difflineplus">+                        this.mSession.notifyOutdated();</span>
<a href="#l28.524"></a><span id="l28.524" class="difflineplus">+                        if (this.calendar) {</span>
<a href="#l28.525"></a><span id="l28.525" class="difflineplus">+                            this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l28.526"></a><span id="l28.526" class="difflineplus">+                            this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.TOKEN_FAILURE);</span>
<a href="#l28.527"></a><span id="l28.527" class="difflineplus">+                        }</span>
<a href="#l28.528"></a><span id="l28.528" class="difflineplus">+                        this.fail(calGoogleRequest.TOKEN_FAILURE, reason);</span>
<a href="#l28.529"></a><span id="l28.529" class="difflineplus">+                        break;</span>
<a href="#l28.530"></a><span id="l28.530" class="difflineplus">+                    case &quot;variableTermLimitExceeded&quot;:</span>
<a href="#l28.531"></a><span id="l28.531" class="difflineplus">+                    case &quot;userRateLimitExceeded&quot;:</span>
<a href="#l28.532"></a><span id="l28.532" class="difflineplus">+                    case &quot;dailyLimitExceeded&quot;:</span>
<a href="#l28.533"></a><span id="l28.533" class="difflineplus">+                    case &quot;quotaExceeded&quot;:</span>
<a href="#l28.534"></a><span id="l28.534" class="difflineplus">+                        this.mSession.notifyQuotaExceeded();</span>
<a href="#l28.535"></a><span id="l28.535" class="difflineplus">+                        if (this.calendar) {</span>
<a href="#l28.536"></a><span id="l28.536" class="difflineplus">+                            this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l28.537"></a><span id="l28.537" class="difflineplus">+                            this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.QUOTA_FAILURE);</span>
<a href="#l28.538"></a><span id="l28.538" class="difflineplus">+                        }</span>
<a href="#l28.539"></a><span id="l28.539" class="difflineplus">+                        this.fail(calGoogleRequest.QUOTA_FAILURE, reason);</span>
<a href="#l28.540"></a><span id="l28.540" class="difflineplus">+                        break;</span>
<a href="#l28.541"></a><span id="l28.541" class="difflineplus">+                    case &quot;insufficientPermissions&quot;:</span>
<a href="#l28.542"></a><span id="l28.542" class="difflineplus">+                        if (this.type == this.MODIFY || this.type == this.DELETE || this.type == this.ADD) {</span>
<a href="#l28.543"></a><span id="l28.543" class="difflineplus">+                            this.fail(cIE.MODIFICATION_FAILED, objData);</span>
<a href="#l28.544"></a><span id="l28.544" class="difflineplus">+                        } else {</span>
<a href="#l28.545"></a><span id="l28.545" class="difflineplus">+                            this.fail(cIE.READ_FAILED, objData);</span>
<a href="#l28.546"></a><span id="l28.546" class="difflineplus">+                        }</span>
<a href="#l28.547"></a><span id="l28.547" class="difflineplus">+                        break;</span>
<a href="#l28.548"></a><span id="l28.548" class="difflineplus">+                    case &quot;authError&quot;:</span>
<a href="#l28.549"></a><span id="l28.549" class="difflineplus">+                    case &quot;invalidCredentials&quot;:</span>
<a href="#l28.550"></a><span id="l28.550" class="difflineplus">+                        this.mSession.invalidate();</span>
<a href="#l28.551"></a><span id="l28.551" class="difflineplus">+                        if (this.reauthenticate) {</span>
<a href="#l28.552"></a><span id="l28.552" class="difflineplus">+                            this.reauthenticate = false;</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineplus">+                            this.mSession.asyncItemRequest(this).then(function(aOperation, aData) {</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineplus">+                                this.succeed(aData);</span>
<a href="#l28.555"></a><span id="l28.555" class="difflineplus">+                            }.bind(this), function(e) {</span>
<a href="#l28.556"></a><span id="l28.556" class="difflineplus">+                                this.fail(e.result, e.message || e);</span>
<a href="#l28.557"></a><span id="l28.557" class="difflineplus">+                            }.bind(this));</span>
<a href="#l28.558"></a><span id="l28.558" class="difflineplus">+                        } else {</span>
<a href="#l28.559"></a><span id="l28.559" class="difflineplus">+                            this.fail(calGoogleRequest.LOGIN_FAILED, reason);</span>
<a href="#l28.560"></a><span id="l28.560" class="difflineplus">+                        }</span>
<a href="#l28.561"></a><span id="l28.561" class="difflineplus">+                        break;</span>
<a href="#l28.562"></a><span id="l28.562" class="difflineplus">+                    default:</span>
<a href="#l28.563"></a><span id="l28.563" class="difflineplus">+                        if (this.calendar) {</span>
<a href="#l28.564"></a><span id="l28.564" class="difflineplus">+                            this.calendar.setProperty(&quot;currentStatus&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l28.565"></a><span id="l28.565" class="difflineplus">+                        }</span>
<a href="#l28.566"></a><span id="l28.566" class="difflineplus">+                        this.fail(Components.results.NS_ERROR_FAILURE, result);</span>
<a href="#l28.567"></a><span id="l28.567" class="difflineplus">+                        break;</span>
<a href="#l28.568"></a><span id="l28.568">                 }</span>
<a href="#l28.569"></a><span id="l28.569"> </span>
<a href="#l28.570"></a><span id="l28.570">                 break;</span>
<a href="#l28.571"></a><span id="l28.571" class="difflineplus">+            }</span>
<a href="#l28.572"></a><span id="l28.572">             case 404: /* The resource was not found on the server, which is</span>
<a href="#l28.573"></a><span id="l28.573">                          also a conflict */</span>
<a href="#l28.574"></a><span id="l28.574">                 //  404 NOT FOUND: Resource (such as a feed or entry) not found.</span>
<a href="#l28.575"></a><span id="l28.575" class="difflineminus">-                this.fail(kGOOGLE_CONFLICT_DELETED, &quot;&quot;);</span>
<a href="#l28.576"></a><span id="l28.576" class="difflineplus">+                // 410 Gone: Happens when deleting an event that has already</span>
<a href="#l28.577"></a><span id="l28.577" class="difflineplus">+                //           been deleted.</span>
<a href="#l28.578"></a><span id="l28.578" class="difflineplus">+                this.fail(calGoogleRequest.CONFLICT_DELETED, objData);</span>
<a href="#l28.579"></a><span id="l28.579">                 break;</span>
<a href="#l28.580"></a><span id="l28.580" class="difflineplus">+            case 410:</span>
<a href="#l28.581"></a><span id="l28.581" class="difflineplus">+                this.fail(calGoogleRequest.RESOURCE_GONE, objData);</span>
<a href="#l28.582"></a><span id="l28.582" class="difflineplus">+                break;</span>
<a href="#l28.583"></a><span id="l28.583" class="difflineplus">+            case 412:</span>
<a href="#l28.584"></a><span id="l28.584">             case 409: /* Specified version number doesn't match resource's</span>
<a href="#l28.585"></a><span id="l28.585">                          latest version number. */</span>
<a href="#l28.586"></a><span id="l28.586" class="difflineminus">-                this.fail(kGOOGLE_CONFLICT_MODIFY, result);</span>
<a href="#l28.587"></a><span id="l28.587" class="difflineplus">+                this.fail(calGoogleRequest.CONFLICT_MODIFY, objData);</span>
<a href="#l28.588"></a><span id="l28.588">                 break;</span>
<a href="#l28.589"></a><span id="l28.589" class="difflineminus">-            case 400:</span>
<a href="#l28.590"></a><span id="l28.590" class="difflineminus">-                //  400 BAD REQUEST: Invalid request URI or header, or</span>
<a href="#l28.591"></a><span id="l28.591" class="difflineminus">-                //                   unsupported nonstandard parameter.</span>
<a href="#l28.592"></a><span id="l28.592" class="difflineplus">+            case 400: {</span>
<a href="#l28.593"></a><span id="l28.593" class="difflineplus">+                // Some bad requests we can handle</span>
<a href="#l28.594"></a><span id="l28.594" class="difflineplus">+                let error = objData &amp;&amp; objData.error &amp;&amp;</span>
<a href="#l28.595"></a><span id="l28.595" class="difflineplus">+                            objData.error.errors &amp;&amp; objData.error.errors[0];</span>
<a href="#l28.596"></a><span id="l28.596"> </span>
<a href="#l28.597"></a><span id="l28.597" class="difflineminus">-                // HACK Ugh, this sucks. If we send a lower sequence number, Google</span>
<a href="#l28.598"></a><span id="l28.598" class="difflineminus">-                // will throw a 400 and not a 409, even though both cases are a conflict.</span>
<a href="#l28.599"></a><span id="l28.599" class="difflineminus">-                if (result == &quot;Cannot decrease the sequence number of an event&quot;) {</span>
<a href="#l28.600"></a><span id="l28.600" class="difflineminus">-                    this.fail(kGOOGLE_CONFLICT_MODIFY, &quot;SEQUENCE-HACK&quot;);</span>
<a href="#l28.601"></a><span id="l28.601" class="difflineminus">-                    break;</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineplus">+                if (error.message == &quot;Invalid sync token value.&quot;) {</span>
<a href="#l28.603"></a><span id="l28.603" class="difflineplus">+                    this.fail(calGoogleRequest.RESOURCE_GONE, objData);</span>
<a href="#l28.604"></a><span id="l28.604" class="difflineplus">+                    return;</span>
<a href="#l28.605"></a><span id="l28.605">                 }</span>
<a href="#l28.606"></a><span id="l28.606" class="difflineminus">-</span>
<a href="#l28.607"></a><span id="l28.607" class="difflineminus">-                // Otherwise fall through</span>
<a href="#l28.608"></a><span id="l28.608" class="difflineplus">+            }</span>
<a href="#l28.609"></a><span id="l28.609" class="difflineplus">+            // Otherwise fall through</span>
<a href="#l28.610"></a><span id="l28.610">             default:</span>
<a href="#l28.611"></a><span id="l28.611">                 // The following codes are caught here:</span>
<a href="#l28.612"></a><span id="l28.612">                 //  500 INTERNAL SERVER ERROR: Internal error. This is the</span>
<a href="#l28.613"></a><span id="l28.613">                 //                             default code that is used for</span>
<a href="#l28.614"></a><span id="l28.614">                 //                             all unrecognized errors.</span>
<a href="#l28.615"></a><span id="l28.615">                 //</span>
<a href="#l28.616"></a><span id="l28.616"> </span>
<a href="#l28.617"></a><span id="l28.617">                 // Something else went wrong</span>
<a href="#l28.618"></a><span id="l28.618" class="difflineminus">-                let error = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l28.619"></a><span id="l28.619" class="difflineminus">-                            httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l28.620"></a><span id="l28.620" class="difflineminus">-                            httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l28.621"></a><span id="l28.621" class="difflineminus">-                            result;</span>
<a href="#l28.622"></a><span id="l28.622" class="difflineplus">+                let msg = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l28.623"></a><span id="l28.623" class="difflineplus">+                          httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l28.624"></a><span id="l28.624" class="difflineplus">+                          httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l28.625"></a><span id="l28.625" class="difflineplus">+                          result;</span>
<a href="#l28.626"></a><span id="l28.626" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] &quot; + msg);</span>
<a href="#l28.627"></a><span id="l28.627"> </span>
<a href="#l28.628"></a><span id="l28.628" class="difflineminus">-                this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, error);</span>
<a href="#l28.629"></a><span id="l28.629" class="difflineplus">+                this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, msg);</span>
<a href="#l28.630"></a><span id="l28.630">                 break;</span>
<a href="#l28.631"></a><span id="l28.631">         }</span>
<a href="#l28.632"></a><span id="l28.632">     }</span>
<a href="#l28.633"></a><span id="l28.633"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">rename from calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l29.2"></a><span id="l29.2">rename to calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineat">@@ -1,577 +1,498 @@</span>
<a href="#l29.6"></a><span id="l29.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/OAuth2.jsm&quot;);</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;);</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-// This constant is an arbitrary large number. It is used to tell google to get</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-// many events, the exact number is not important.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-const kMANY_EVENTS = 0x7FFFFFFF;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+CuImport(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;, this);</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+CuImport(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+CuImport(&quot;resource://gre/modules/Promise.jsm&quot;, this);</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+CuImport(&quot;resource://gre/modules/Task.jsm&quot;, this);</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+CuImport(&quot;resource://gre/modules/Timer.jsm&quot;, this);</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-function calGoogleSessionManager() {</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-    this.wrappedJSObject = this;</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+CuImport(&quot;resource:///modules/iteratorUtils.jsm&quot;, this);</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-}</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-const calGoogleSessionManagerClassID = Components.ID(&quot;{6a7ba1f0-f271-49b0-8e93-5ca33651b4af}&quot;);</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-const calGoogleSessionManagerInterfaces = [Components.interfaces.calIGoogleSessionManager];</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-calGoogleSessionManager.prototype = {</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-    mSessionMap: {},</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;, this);</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+const cIFBI = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+const nIPM = Components.interfaces.nsIPermissionManager;</span>
<a href="#l29.45"></a><span id="l29.45"> </span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-    classID: calGoogleSessionManagerClassID,</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI(calGoogleSessionManagerInterfaces),</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-        classID: calGoogleSessionManagerClassID,</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;,</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-        classDescription: &quot;Google Calendar Session Manager&quot;,</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-        interfaces: calGoogleSessionManagerInterfaces,</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-    }),</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+const NOTIFY_TIMEOUT = 60 * 1000;</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;getGoogleSessionManager&quot;];</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+let gdataSessionMap = new Map();</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+var calGoogleSessionManager = {</span>
<a href="#l29.61"></a><span id="l29.61">     /**</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-     * getSessionByUsername</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-     * Get a Session object for the specified username. If aCreate is false,</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+     * Get a Session object for the specified calendar. If aCreate is false,</span>
<a href="#l29.65"></a><span id="l29.65">      * null will be returned if the session doesn't exist. Otherwise, the</span>
<a href="#l29.66"></a><span id="l29.66">      * session will be created.</span>
<a href="#l29.67"></a><span id="l29.67">      *</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-     * @param aUsername The username to get the session for</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-     * @param aCreate   If true, the session will be created prior to returning</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+     * @param aCalendar  The calendar to get the session for.</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+     * @param aCreate    If true, the session will be created prior to returning.</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+     * @return           The initialized session object.</span>
<a href="#l29.73"></a><span id="l29.73">      */</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-    getSessionByUsername: function cGSM_getSessionByUsername(aUsername, aCreate) {</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-        // If the username contains no @, assume @gmail.com</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-        // XXX Maybe use accountType=GOOGLE and just pass the raw username?</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-        if (aUsername.indexOf('@') == -1) {</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-            aUsername += &quot;@gmail.com&quot;;</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+    getSessionByCalendar: function(aCalendar, aCreate) {</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+        let id = null;</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+        let uri = aCalendar.uri;</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+        let host = (function() { try { return uri.host; } catch (e) {} })();</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+        const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+        if (aCalendar.type != &quot;gdata&quot;) {</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+            return;</span>
<a href="#l29.87"></a><span id="l29.87">         }</span>
<a href="#l29.88"></a><span id="l29.88"> </span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-        // Check if the session exists</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-        if (!this.mSessionMap.hasOwnProperty(aUsername)) {</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-            if (!aCreate) {</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-                return null;</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-            }</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Creating session for: &quot; + aUsername);</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-            this.mSessionMap[aUsername] = new calGoogleSession(aUsername);</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-        } else {</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Reusing session for: &quot; + aUsername);</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+        if (uri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+            let [fullUser, path] = uri.path.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+            id = fullUser || cal.getUUID();</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+        } else if (host == &quot;www.google.com&quot; &amp;&amp; uri.path.startsWith(&quot;/calendar/feeds&quot;) &amp;&amp; protocols.some(function(s) uri.schemeIs(s))) {</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+            let googleCalendarName = aCalendar.getProperty(&quot;googleCalendarName&quot;);</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+            let googleUser = Preferences.get(&quot;calendar.google.calPrefs.&quot; + googleCalendarName  + &quot;.googleUser&quot;);</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+            id = googleUser || googleCalendarName || cal.getUUID();</span>
<a href="#l29.105"></a><span id="l29.105">         }</span>
<a href="#l29.106"></a><span id="l29.106"> </span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-        // XXX What happens if the username is &quot;toSource&quot; :)</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-        return this.mSessionMap[aUsername];</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+        return id ? this.getSessionById(id, aCreate) : null;</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+    },</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+    getSessionById: function(aSessionId, aCreate) {</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+        // Check if the session exists</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+        if (gdataSessionMap.has(aSessionId)) {</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+            cal.LOG(&quot;[calGoogleSessionManager] Reusing session &quot; + aSessionId);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+        } else if (aCreate) {</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+            cal.LOG(&quot;[calGoogleSessionManager] Creating session &quot; + aSessionId);</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+            gdataSessionMap.set(aSessionId, new calGoogleSession(aSessionId));</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+        }</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+        return gdataSessionMap.get(aSessionId);</span>
<a href="#l29.122"></a><span id="l29.122">     }</span>
<a href="#l29.123"></a><span id="l29.123"> };</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+function getGoogleSessionManager() calGoogleSessionManager;</span>
<a href="#l29.125"></a><span id="l29.125"> </span>
<a href="#l29.126"></a><span id="l29.126"> /**</span>
<a href="#l29.127"></a><span id="l29.127">  * calGoogleSession</span>
<a href="#l29.128"></a><span id="l29.128">  * This Implements a Session object to communicate with google</span>
<a href="#l29.129"></a><span id="l29.129">  *</span>
<a href="#l29.130"></a><span id="l29.130">  * @constructor</span>
<a href="#l29.131"></a><span id="l29.131">  * @class</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+ * @param aId       The ID for the new session.</span>
<a href="#l29.133"></a><span id="l29.133">  */</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineminus">-function calGoogleSession(aUsername) {</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineminus">-    this.mItemQueue = new Array();</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineminus">-    this.mGoogleUser = aUsername;</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineplus">+function calGoogleSession(aId) {</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineplus">+    this.mId = aId;</span>
<a href="#l29.139"></a><span id="l29.139">     this.wrappedJSObject = this;</span>
<a href="#l29.140"></a><span id="l29.140"> </span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+    this.setupOAuth();</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+</span>
<a href="#l29.143"></a><span id="l29.143">     // Register a freebusy provider for this session</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-    getFreeBusyService().addProvider(this);</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+    cal.getFreeBusyService().addProvider(this);</span>
<a href="#l29.146"></a><span id="l29.146"> }</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-const calGoogleSessionClassID = Components.ID(&quot;{652f6233-e03f-438a-bd3b-39877f68c0f4}&quot;);</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-const calGoogleSessionInterfaces = [Components.interfaces.calIGoogleSession];</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+</span>
<a href="#l29.150"></a><span id="l29.150"> calGoogleSession.prototype = {</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-    classID: calGoogleSessionClassID,</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-    QueryInterface: XPCOMUtils.generateQI(calGoogleSessionInterfaces),</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-        classID: calGoogleSessionClassID,</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/session;1&quot;,</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineminus">-        classDescription: &quot;Google Calendar Session&quot;,</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineminus">-        interfaces: calGoogleSessionInterfaces</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-    }),</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+    mId: null,</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineplus">+    mSessionID: null,</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+    mLoginPromise: null,</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+    get id() this.mId,</span>
<a href="#l29.164"></a><span id="l29.164"> </span>
<a href="#l29.165"></a><span id="l29.165" class="difflineminus">-    /* Member Variables */</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineminus">-    mGoogleUser: null,</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineminus">-    // This must be |undefined|, we need this variable to be tri-state.</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineminus">-    mGooglePass: undefined,</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-    mGoogleFullName: null,</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-    mAuthToken: null,</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-    mSessionID: null,</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineminus">-</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-    mLoggingIn: false,</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-    mPersistPassword: false,</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-    mItemQueue: null,</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-    mCalendarName: null,</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineminus">-    /**</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineminus">-     * readonly attribute authToken</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineminus">-     *</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineminus">-     * The auth token returned from Google Accounts</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineminus">-     */</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineminus">-    get authToken() {</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineminus">-        return this.mAuthToken;</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineplus">+    notifyQuotaExceeded: function() {</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+        let now = new Date();</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineplus">+        let tt = (now - this.mLastNotified);</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+        if (!this.mLastNotified || (now - this.mLastNotified) &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+            this.mLastNotified = now;</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+            let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+            let quotaString = getProviderString(&quot;quotaExceeded&quot;, this.id);</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineplus">+            Services.prompt.alert(cal.getCalendarWindow(), title, quotaString);</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineplus">+        } else {</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Throttling quota notification, last was &quot; + (now - this.mLastNotified) + &quot; ms ago&quot;);</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+        }</span>
<a href="#l29.197"></a><span id="l29.197">     },</span>
<a href="#l29.198"></a><span id="l29.198"> </span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-    /**</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineminus">-     * readonly attribute userName</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineminus">-     *</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-     * The username for this session. To get a session with a different</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-     * username, use calIGoogleSessionManager.</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-     */</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-    get userName() {</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineminus">-        return this.mGoogleUser;</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineminus">-    },</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineminus">-    /**</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-     * attribute persist</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineminus">-     *</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineminus">-     * If set, the password will persist across restarts.</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineminus">-     */</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineminus">-    get persist() {</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineminus">-        return this.mPersistPassword;</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-    },</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-    set persist(v) {</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-        return this.mPersistPassword = v;</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineminus">-    },</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineminus">-</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineminus">-    /**</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-     * attribute AUTF8String fullName</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-     *</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineminus">-     * The user's full name, usually retrieved from the XML &lt;author&gt; fields.</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-     */</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-    get fullName() {</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-        return this.mGoogleFullName;</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-    },</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-    set fullName(v) {</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-        return this.mGoogleFullName = v;</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+    notifyOutdated: function() {</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineplus">+        let now = new Date();</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+        let tt = (now - this.mLastNotified);</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+        if (!this.mLastNotified || (now - this.mLastNotified) &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+            this.mLastNotified = now;</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+            let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+            let outdatedString = getProviderString(&quot;providerOutdated&quot;);</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+            Services.prompt.alert(cal.getCalendarWindow(), title, outdatedString);</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+        } else {</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Throttling outdated notification, last was &quot; + (now - this.mLastNotified) + &quot; ms ago&quot;);</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+        }</span>
<a href="#l29.242"></a><span id="l29.242">     },</span>
<a href="#l29.243"></a><span id="l29.243"> </span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-    /**</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineminus">-     * attribute AUTF8String password</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineminus">-     *</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineminus">-     * The password used to authenticate. It is only important to implement the</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineminus">-     * setter here, since the password is only used internally.</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineminus">-     */</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineminus">-    get password() {</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineminus">-        return this.mGooglePass;</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineminus">-    },</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineminus">-    set password(v) {</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineminus">-        return this.mGooglePass = v;</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-    },</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+    setupOAuth: function setupOAuth() {</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineplus">+        let sessionId = this.mId;</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineplus">+        let authTitle = cal.calGetString(&quot;commonDialogs&quot;, &quot;EnterUserPasswordFor&quot;,</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineplus">+                                         [this.id], &quot;global&quot;);</span>
<a href="#l29.260"></a><span id="l29.260"> </span>
<a href="#l29.261"></a><span id="l29.261" class="difflineminus">-    /**</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-     * invalidate</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineminus">-     * Resets the Auth token and password.</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineminus">-     */</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineminus">-    invalidate: function cGS_invalidate() {</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineminus">-        this.mAuthToken = null;</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineminus">-        this.mGooglePass = null;</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineminus">-        this.persist = false;</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineminus">-</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-        passwordManagerRemove(this.mGoogleUser);</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-    },</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineminus">-</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineminus">-    getCalendars: function cGS_getCalendars(aListener) {</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineminus">-    },</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineminus">-</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineminus">-    /**</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineminus">-     * failQueue</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineminus">-     * Fails all requests in this session's queue. Optionally only fail requests</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">-     * for a certain calendar</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineminus">-     *</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineminus">-     * @param aCode     Failure Code</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineminus">-     * @param aCalendar The calendar to fail for. Can be null.</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineminus">-     */</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineminus">-    failQueue: function cGS_failQueue(aCode, aCalendar) {</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineminus">-        function cGS_failQueue_failInQueue(element, index, arr) {</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineminus">-            if (!aCalendar || (aCalendar &amp;&amp; element.calendar == aCalendar)) {</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineminus">-                element.fail(aCode, null);</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineminus">-                return false;</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+        // Set up a new OAuth2 instance for logging in.</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineplus">+        this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_CLIENT_SECRET);</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineplus">+        this.oauth.extraAuthParams = [</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineplus">+          [&quot;login_hint&quot;, sessionId],</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineplus">+          // Use application locale for login dialog</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineplus">+          [&quot;hl&quot;, Preferences.get(&quot;general.useragent.locale&quot;, &quot;en-US&quot;)]</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineplus">+        ];</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+        this.oauth.requestWindowURI = &quot;chrome://gdata-provider/content/browserRequest.xul&quot;;</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineplus">+        this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=600&quot;;</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineplus">+        this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l29.300"></a><span id="l29.300"> </span>
<a href="#l29.301"></a><span id="l29.301" class="difflineminus">-            }</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-            return true;</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-        }</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineminus">-        this.mItemQueue = this.mItemQueue.filter(cGS_failQueue_failInQueue);</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineminus">-    },</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineminus">-</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineminus">-    /**</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineminus">-     * loginAndContinue</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineminus">-     * Prepares a login request, then requests via #asyncRawRequest</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineminus">-     *</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineminus">-     *</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineminus">-     * @param aCalendar    The calendar of the request that initiated the login.</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineminus">-     */</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineminus">-    loginAndContinue: function cGS_loginAndContinue(aCalendar) {</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineminus">-        if (this.mLoggingIn) {</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] loginAndContinue called while logging in&quot;);</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-            return;</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-        }</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineminus">-        try {</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Logging in to &quot; + this.mGoogleUser);</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineplus">+        // Overwrite the refreshToken attribute, since we want to save it in</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+        // the password manager</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineplus">+        let pwMgrId = &quot;Google Calendar OAuth Token&quot;;</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineplus">+        Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+            get: function getRefreshToken() {</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineplus">+                if (!this.mRefreshToken) {</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineplus">+                    let pass = { value: null };</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+                    try {</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineplus">+                        cal.auth.passwordManagerGet(sessionId, pass, sessionId, pwMgrId);</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineplus">+                    } catch (e if e.result == Components.results.NS_ERROR_ABORT) {</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineplus">+                        // User might have cancelled the master password prompt, thats ok</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineplus">+                    }</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineplus">+                    this.mRefreshToken = pass.value;</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineplus">+                }</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineplus">+                return this.mRefreshToken;</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineplus">+            },</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+            set: function setRefreshToken(val) {</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineplus">+                try {</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineplus">+                    if (!val) {</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineplus">+                        cal.auth.passwordManagerRemove(sessionId, sessionId, pwMgrId);</span>
<a href="#l29.342"></a><span id="l29.342" class="difflineplus">+                    } else {</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineplus">+                        cal.auth.passwordManagerSave(sessionId, val, sessionId, pwMgrId);</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineplus">+                    }</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineplus">+                } catch (e if e.result == Components.results.NS_ERROR_ABORT) {</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineplus">+                    // User might have cancelled the master password prompt, thats ok</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineplus">+                }</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineplus">+                return (this.mRefreshToken = val);</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineplus">+            },</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineplus">+            enumerable: true</span>
<a href="#l29.351"></a><span id="l29.351" class="difflineplus">+        });</span>
<a href="#l29.352"></a><span id="l29.352"> </span>
<a href="#l29.353"></a><span id="l29.353" class="difflineminus">-            // We need to have a user and should not be logging in</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineminus">-            ASSERT(!this.mLoggingIn);</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineminus">-            ASSERT(this.mGoogleUser);</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineminus">-</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineminus">-            // Start logging in</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineminus">-            this.mLoggingIn = true;</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineminus">-</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineminus">-            if (this.mGooglePass === undefined) {</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineminus">-                // This happens only on the first run. Try to get the password</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineminus">-                // from the password manager.</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineminus">-                let password = {};</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineminus">-                passwordManagerGet(this.mGoogleUser, password);</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineminus">-                if (password.value) {</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineminus">-                    cal.LOG(&quot;Retrieved Password for &quot; + this.mGoogleUser +</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-                            &quot; from password manager&quot;);</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineminus">-                    this.mPersistPassword = true;</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineminus">-                    this.mGooglePass = password.value;</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineminus">-                } else {</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineminus">-                    // Could not get the password from the password manager, set</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineminus">-                    // it to null to make sure the password is prompted for in</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineminus">-                    // the next block.</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineminus">-                    this.mGooglePass = null;</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineplus">+        // If the user has disabled cookies, we need to add an exception for</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineplus">+        // Google so authentication works. If the user has explicitly blocked</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineplus">+        // google.com then we won't overwrite the rule though.</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineplus">+        if (Preferences.get(&quot;network.cookie.cookieBehavior&quot;) == 2) {</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineplus">+            let found = null;</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineplus">+            for (let perm in fixIterator(Services.perms.enumerator, Components.interfaces.nsIPermission)) {</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineplus">+                if (perm.type == &quot;cookie&quot; &amp;&amp; perm.host == &quot;google.com&quot;) {</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineplus">+                    found = perm;</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineplus">+                    break;</span>
<a href="#l29.384"></a><span id="l29.384">                 }</span>
<a href="#l29.385"></a><span id="l29.385">             }</span>
<a href="#l29.386"></a><span id="l29.386"> </span>
<a href="#l29.387"></a><span id="l29.387" class="difflineminus">-            // Check if we have a password. If not, authentication may have</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineminus">-            // failed.</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineminus">-            if (!this.mGooglePass) {</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineminus">-                let username = { value: this.mGoogleUser };</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineminus">-                let password = { value: null };</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineminus">-                let persist = { value: false };</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineminus">-</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineminus">-                // Try getting a new password, potentially switching sesssions.</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineminus">-                let calendarName = (aCalendar ?</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineminus">-                                    aCalendar.googleCalendarName :</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineminus">-                                    this.mGoogleUser);</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineminus">-</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineminus">-                if (getCalendarCredentials(calendarName,</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineminus">-                                           username,</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineminus">-                                           password,</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineminus">-                                           persist)) {</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineminus">-</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineminus">-                    cal.LOG(&quot;[calGoogleCalendar] Got the pw from the calendar credentials: &quot; +</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineminus">-                            calendarName);</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineminus">-</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineminus">-                    // If a different username was entered, switch sessions</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineminus">-</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineminus">-                    if (aCalendar &amp;&amp; username.value != this.mGoogleUser) {</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineminus">-                        let newSession = getGoogleSessionManager()</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineminus">-                                         .getSessionByUsername(username.value,</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineminus">-                                                               true);</span>
<a href="#l29.413"></a><span id="l29.413" class="difflineminus">-                        newSession.password = password.value;</span>
<a href="#l29.414"></a><span id="l29.414" class="difflineminus">-                        newSession.persist = persist.value;</span>
<a href="#l29.415"></a><span id="l29.415" class="difflineminus">-                        setCalendarPref(aCalendar,</span>
<a href="#l29.416"></a><span id="l29.416" class="difflineminus">-                                        &quot;googleUser&quot;,</span>
<a href="#l29.417"></a><span id="l29.417" class="difflineminus">-                                        &quot;CHAR&quot;,</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineminus">-                                        username.value);</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineminus">-</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineminus">-                        // Set the new session for the calendar</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineminus">-                        aCalendar.session = newSession;</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineminus">-                        cal.LOG(&quot;[calGoogleCalendar] Setting &quot; + aCalendar.name +</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineminus">-                                &quot;'s Session to &quot; + newSession.userName);</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineminus">-</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineminus">-                        // Move all requests by this calendar to its new session</span>
<a href="#l29.426"></a><span id="l29.426" class="difflineminus">-                        function cGS_login_moveToSession(element, index, arr) {</span>
<a href="#l29.427"></a><span id="l29.427" class="difflineminus">-                            if (element.calendar == aCalendar) {</span>
<a href="#l29.428"></a><span id="l29.428" class="difflineminus">-                                cal.LOG(&quot;[calGoogleCalendar] Moving &quot; + element.uri + &quot; to &quot; +</span>
<a href="#l29.429"></a><span id="l29.429" class="difflineminus">-                                        newSession.userName);</span>
<a href="#l29.430"></a><span id="l29.430" class="difflineminus">-                                newSession.asyncItemRequest(element);</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineminus">-                                return false;</span>
<a href="#l29.432"></a><span id="l29.432" class="difflineminus">-                            }</span>
<a href="#l29.433"></a><span id="l29.433" class="difflineminus">-                            return true;</span>
<a href="#l29.434"></a><span id="l29.434" class="difflineminus">-                        }</span>
<a href="#l29.435"></a><span id="l29.435" class="difflineminus">-                        this.mItemQueue = this.mItemQueue</span>
<a href="#l29.436"></a><span id="l29.436" class="difflineminus">-                                          .filter(cGS_login_moveToSession);</span>
<a href="#l29.437"></a><span id="l29.437" class="difflineminus">-</span>
<a href="#l29.438"></a><span id="l29.438" class="difflineminus">-                        // Do not complete the request here, since it has been</span>
<a href="#l29.439"></a><span id="l29.439" class="difflineminus">-                        // moved. This is not an error though, so nothing is</span>
<a href="#l29.440"></a><span id="l29.440" class="difflineminus">-                        // thrown.</span>
<a href="#l29.441"></a><span id="l29.441" class="difflineminus">-                        return;</span>
<a href="#l29.442"></a><span id="l29.442" class="difflineminus">-                    }</span>
<a href="#l29.443"></a><span id="l29.443" class="difflineminus">-</span>
<a href="#l29.444"></a><span id="l29.444" class="difflineminus">-                    // If we arrive at this point, then the session was not</span>
<a href="#l29.445"></a><span id="l29.445" class="difflineminus">-                    // changed. Just adapt the password from the dialog and</span>
<a href="#l29.446"></a><span id="l29.446" class="difflineminus">-                    // continue.</span>
<a href="#l29.447"></a><span id="l29.447" class="difflineminus">-                    this.mGooglePass = password.value;</span>
<a href="#l29.448"></a><span id="l29.448" class="difflineminus">-                    this.persist = persist.value;</span>
<a href="#l29.449"></a><span id="l29.449" class="difflineminus">-                } else {</span>
<a href="#l29.450"></a><span id="l29.450" class="difflineminus">-                    cal.LOG(&quot;[calGoogleCalendar] Could not get any credentials for &quot; +</span>
<a href="#l29.451"></a><span id="l29.451" class="difflineminus">-                            calendarName + &quot; (&quot; +</span>
<a href="#l29.452"></a><span id="l29.452" class="difflineminus">-                            this.mGoogleUser + &quot;)&quot;);</span>
<a href="#l29.453"></a><span id="l29.453" class="difflineminus">-</span>
<a href="#l29.454"></a><span id="l29.454" class="difflineminus">-                    if (aCalendar) {</span>
<a href="#l29.455"></a><span id="l29.455" class="difflineminus">-                        // First of all, disable the calendar so no further login</span>
<a href="#l29.456"></a><span id="l29.456" class="difflineminus">-                        // dialogs show up.</span>
<a href="#l29.457"></a><span id="l29.457" class="difflineminus">-                        aCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l29.458"></a><span id="l29.458" class="difflineminus">-                        aCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l29.459"></a><span id="l29.459" class="difflineminus">-</span>
<a href="#l29.460"></a><span id="l29.460" class="difflineminus">-                        // Unset the session in the requesting calendar, if the user</span>
<a href="#l29.461"></a><span id="l29.461" class="difflineminus">-                        // canceled the login dialog that also asks for the</span>
<a href="#l29.462"></a><span id="l29.462" class="difflineminus">-                        // username, then the session is not valid. This also</span>
<a href="#l29.463"></a><span id="l29.463" class="difflineminus">-                        // prevents multiple login windows.</span>
<a href="#l29.464"></a><span id="l29.464" class="difflineminus">-                        aCalendar.session = null;</span>
<a href="#l29.465"></a><span id="l29.465" class="difflineminus">-                    }</span>
<a href="#l29.466"></a><span id="l29.466" class="difflineminus">-</span>
<a href="#l29.467"></a><span id="l29.467" class="difflineminus">-                    // We are done logging in</span>
<a href="#l29.468"></a><span id="l29.468" class="difflineminus">-                    this.mLoggingIn = false;</span>
<a href="#l29.469"></a><span id="l29.469" class="difflineminus">-</span>
<a href="#l29.470"></a><span id="l29.470" class="difflineminus">-                    // The User even canceled the login prompt asking for</span>
<a href="#l29.471"></a><span id="l29.471" class="difflineminus">-                    // the user. This means we have to fail all requests</span>
<a href="#l29.472"></a><span id="l29.472" class="difflineminus">-                    // that belong to that calendar and are in the queue. This</span>
<a href="#l29.473"></a><span id="l29.473" class="difflineminus">-                    // will also include the request that initiated the login</span>
<a href="#l29.474"></a><span id="l29.474" class="difflineminus">-                    // request, so that dosent need to be handled extra. If no</span>
<a href="#l29.475"></a><span id="l29.475" class="difflineminus">-                    // calendar was passed, fail all request in that queue</span>
<a href="#l29.476"></a><span id="l29.476" class="difflineminus">-                    this.failQueue(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l29.477"></a><span id="l29.477" class="difflineminus">-                                   aCalendar);</span>
<a href="#l29.478"></a><span id="l29.478" class="difflineminus">-                    return;</span>
<a href="#l29.479"></a><span id="l29.479" class="difflineminus">-                }</span>
<a href="#l29.480"></a><span id="l29.480" class="difflineplus">+            if (!found || found.capability != nIPM.DENY_ACTION) {</span>
<a href="#l29.481"></a><span id="l29.481" class="difflineplus">+                Services.perms.remove(&quot;google.com&quot;, &quot;cookie&quot;);</span>
<a href="#l29.482"></a><span id="l29.482" class="difflineplus">+                let uri = Services.io.newURI(&quot;http://google.com&quot;, null, null);</span>
<a href="#l29.483"></a><span id="l29.483" class="difflineplus">+                Services.perms.add(uri, &quot;cookie&quot;, nIPM.ALLOW_ACTION, nIPM.EXPIRE_SESSION);</span>
<a href="#l29.484"></a><span id="l29.484">             }</span>
<a href="#l29.485"></a><span id="l29.485" class="difflineminus">-</span>
<a href="#l29.486"></a><span id="l29.486" class="difflineminus">-            // Now we should have a password</span>
<a href="#l29.487"></a><span id="l29.487" class="difflineminus">-            ASSERT(this.mGooglePass);</span>
<a href="#l29.488"></a><span id="l29.488" class="difflineminus">-</span>
<a href="#l29.489"></a><span id="l29.489" class="difflineminus">-            // Get Version info</span>
<a href="#l29.490"></a><span id="l29.490" class="difflineminus">-            let source = Services.appinfo.vendor + &quot;-&quot; +</span>
<a href="#l29.491"></a><span id="l29.491" class="difflineminus">-                         Services.appinfo.name + &quot;-&quot; +</span>
<a href="#l29.492"></a><span id="l29.492" class="difflineminus">-                         Services.appinfo.version;</span>
<a href="#l29.493"></a><span id="l29.493" class="difflineminus">-</span>
<a href="#l29.494"></a><span id="l29.494" class="difflineminus">-            // Request Login</span>
<a href="#l29.495"></a><span id="l29.495" class="difflineminus">-            let request = new calGoogleRequest(this);</span>
<a href="#l29.496"></a><span id="l29.496" class="difflineminus">-</span>
<a href="#l29.497"></a><span id="l29.497" class="difflineminus">-            request.type = request.LOGIN;</span>
<a href="#l29.498"></a><span id="l29.498" class="difflineminus">-            request.calendar = aCalendar;</span>
<a href="#l29.499"></a><span id="l29.499" class="difflineminus">-            request.responseListener = this;</span>
<a href="#l29.500"></a><span id="l29.500" class="difflineminus">-</span>
<a href="#l29.501"></a><span id="l29.501" class="difflineminus">-            request.setUploadData(&quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l29.502"></a><span id="l29.502" class="difflineminus">-                                  &quot;Email=&quot; + encodeURIComponent(this.mGoogleUser) +</span>
<a href="#l29.503"></a><span id="l29.503" class="difflineminus">-                                  &quot;&amp;Passwd=&quot; + encodeURIComponent(this.mGooglePass) +</span>
<a href="#l29.504"></a><span id="l29.504" class="difflineminus">-                                  &quot;&amp;accountType=HOSTED_OR_GOOGLE&quot; +</span>
<a href="#l29.505"></a><span id="l29.505" class="difflineminus">-                                  &quot;&amp;source=&quot; + encodeURIComponent(source) +</span>
<a href="#l29.506"></a><span id="l29.506" class="difflineminus">-                                  &quot;&amp;service=cl&quot;);</span>
<a href="#l29.507"></a><span id="l29.507" class="difflineminus">-            this.asyncRawRequest(request);</span>
<a href="#l29.508"></a><span id="l29.508" class="difflineminus">-        } catch (e) {</span>
<a href="#l29.509"></a><span id="l29.509" class="difflineminus">-            // If something went wrong, reset the login state just in case</span>
<a href="#l29.510"></a><span id="l29.510" class="difflineminus">-            this.mLoggingIn = false;</span>
<a href="#l29.511"></a><span id="l29.511" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l29.512"></a><span id="l29.512" class="difflineminus">-</span>
<a href="#l29.513"></a><span id="l29.513" class="difflineminus">-            // If something went wrong, then this.loginComplete should handle</span>
<a href="#l29.514"></a><span id="l29.514" class="difflineminus">-            // the error. We don't need to take care of the request that</span>
<a href="#l29.515"></a><span id="l29.515" class="difflineminus">-            // initiated the login, since it is also in the item queue.</span>
<a href="#l29.516"></a><span id="l29.516" class="difflineminus">-            this.onResult({ status: e.result}, e.message);</span>
<a href="#l29.517"></a><span id="l29.517">         }</span>
<a href="#l29.518"></a><span id="l29.518">     },</span>
<a href="#l29.519"></a><span id="l29.519"> </span>
<a href="#l29.520"></a><span id="l29.520" class="difflineplus">+    get accessToken() this.oauth.accessToken,</span>
<a href="#l29.521"></a><span id="l29.521" class="difflineplus">+    get refreshToken() this.oauth.refreshToken,</span>
<a href="#l29.522"></a><span id="l29.522" class="difflineplus">+    set refreshToken(val) this.oauth.refreshToken = val,</span>
<a href="#l29.523"></a><span id="l29.523" class="difflineplus">+</span>
<a href="#l29.524"></a><span id="l29.524">     /**</span>
<a href="#l29.525"></a><span id="l29.525" class="difflineminus">-     * onResult (loginComplete)</span>
<a href="#l29.526"></a><span id="l29.526" class="difflineminus">-     * Callback function that is called when the login request to Google</span>
<a href="#l29.527"></a><span id="l29.527" class="difflineminus">-     * Accounts has finished</span>
<a href="#l29.528"></a><span id="l29.528" class="difflineminus">-     *  - Retrieves the Authentication Token</span>
<a href="#l29.529"></a><span id="l29.529" class="difflineminus">-     *  - Saves the Password in the Password Manager</span>
<a href="#l29.530"></a><span id="l29.530" class="difflineminus">-     *  - Processes the Item Queue</span>
<a href="#l29.531"></a><span id="l29.531" class="difflineminus">-     *</span>
<a href="#l29.532"></a><span id="l29.532" class="difflineminus">-     * @private</span>
<a href="#l29.533"></a><span id="l29.533" class="difflineminus">-     * @param aOperation    The calIOperation that initiated the login</span>
<a href="#l29.534"></a><span id="l29.534" class="difflineminus">-     * @param aData         The (String) Result of the Request</span>
<a href="#l29.535"></a><span id="l29.535" class="difflineminus">-     *                      (or an Error Message)</span>
<a href="#l29.536"></a><span id="l29.536" class="difflineplus">+     * Resets the access token, it will be re-retrieved on the next request.</span>
<a href="#l29.537"></a><span id="l29.537" class="difflineplus">+     */</span>
<a href="#l29.538"></a><span id="l29.538" class="difflineplus">+    invalidate: function cGS_invalidate() {</span>
<a href="#l29.539"></a><span id="l29.539" class="difflineplus">+        cal.LOG(&quot;[calGoogleSession] Invalidating session, will reauthenticate on next request&quot;);</span>
<a href="#l29.540"></a><span id="l29.540" class="difflineplus">+        this.oauth.accessToken = null;</span>
<a href="#l29.541"></a><span id="l29.541" class="difflineplus">+    },</span>
<a href="#l29.542"></a><span id="l29.542" class="difflineplus">+</span>
<a href="#l29.543"></a><span id="l29.543" class="difflineplus">+    /**</span>
<a href="#l29.544"></a><span id="l29.544" class="difflineplus">+     * Returns a promise resolved when the login is complete.</span>
<a href="#l29.545"></a><span id="l29.545">      */</span>
<a href="#l29.546"></a><span id="l29.546" class="difflineminus">-     onResult: function cGS_onResult(aOperation, aData) {</span>
<a href="#l29.547"></a><span id="l29.547" class="difflineminus">-        // About mLoggingIn: this should only be set to false when either</span>
<a href="#l29.548"></a><span id="l29.548" class="difflineminus">-        // something went wrong or mAuthToken is set. This avoids redundant</span>
<a href="#l29.549"></a><span id="l29.549" class="difflineminus">-        // logins to Google. Hence mLoggingIn is set three times in the course</span>
<a href="#l29.550"></a><span id="l29.550" class="difflineminus">-        // of this function</span>
<a href="#l29.551"></a><span id="l29.551" class="difflineplus">+    login: function() {</span>
<a href="#l29.552"></a><span id="l29.552" class="difflineplus">+        if (this.mLoginPromise) {</span>
<a href="#l29.553"></a><span id="l29.553" class="difflineplus">+            return this.mLoginPromise;</span>
<a href="#l29.554"></a><span id="l29.554" class="difflineplus">+        }</span>
<a href="#l29.555"></a><span id="l29.555" class="difflineplus">+        let deferred = Promise.defer();</span>
<a href="#l29.556"></a><span id="l29.556" class="difflineplus">+</span>
<a href="#l29.557"></a><span id="l29.557" class="difflineplus">+        try {</span>
<a href="#l29.558"></a><span id="l29.558" class="difflineplus">+            // Start logging in</span>
<a href="#l29.559"></a><span id="l29.559" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Logging in session &quot; + this.mId);</span>
<a href="#l29.560"></a><span id="l29.560" class="difflineplus">+            let accessToken = this.accessToken;</span>
<a href="#l29.561"></a><span id="l29.561" class="difflineplus">+            let refreshToken = this.refreshToken;</span>
<a href="#l29.562"></a><span id="l29.562"> </span>
<a href="#l29.563"></a><span id="l29.563" class="difflineminus">-        if (!aData || !Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l29.564"></a><span id="l29.564" class="difflineminus">-            this.mLoggingIn = false;</span>
<a href="#l29.565"></a><span id="l29.565" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Login failed. Status: &quot; + aOperation.status);</span>
<a href="#l29.566"></a><span id="l29.566" class="difflineplus">+            let authSuccess = function() {</span>
<a href="#l29.567"></a><span id="l29.567" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Successfully acquired a new&quot; +</span>
<a href="#l29.568"></a><span id="l29.568" class="difflineplus">+                        &quot; OAuth token for &quot; + this.mId);</span>
<a href="#l29.569"></a><span id="l29.569" class="difflineplus">+                deferred.resolve(this.accessToken);</span>
<a href="#l29.570"></a><span id="l29.570" class="difflineplus">+            }.bind(this);</span>
<a href="#l29.571"></a><span id="l29.571" class="difflineplus">+</span>
<a href="#l29.572"></a><span id="l29.572" class="difflineplus">+            let authFailed = function(aData) {</span>
<a href="#l29.573"></a><span id="l29.573" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Failed to acquire a new&quot; +</span>
<a href="#l29.574"></a><span id="l29.574" class="difflineplus">+                        &quot; OAuth token for &quot; + this.mId + &quot; data: &quot; + aData);</span>
<a href="#l29.575"></a><span id="l29.575" class="difflineplus">+</span>
<a href="#l29.576"></a><span id="l29.576" class="difflineplus">+                let error = null;</span>
<a href="#l29.577"></a><span id="l29.577" class="difflineplus">+                if (aData) {</span>
<a href="#l29.578"></a><span id="l29.578" class="difflineplus">+                    let dataObj;</span>
<a href="#l29.579"></a><span id="l29.579" class="difflineplus">+                    try { dataObj = JSON.parse(aData); } catch (e) {}</span>
<a href="#l29.580"></a><span id="l29.580" class="difflineplus">+                    error = dataObj &amp;&amp; dataObj.error;</span>
<a href="#l29.581"></a><span id="l29.581" class="difflineplus">+                }</span>
<a href="#l29.582"></a><span id="l29.582"> </span>
<a href="#l29.583"></a><span id="l29.583" class="difflineminus">-            if (aOperation.status == kGOOGLE_LOGIN_FAILED &amp;&amp;</span>
<a href="#l29.584"></a><span id="l29.584" class="difflineminus">-                aOperation.reauthenticate) {</span>
<a href="#l29.585"></a><span id="l29.585" class="difflineminus">-                // If the login failed, then retry the login. This is not an</span>
<a href="#l29.586"></a><span id="l29.586" class="difflineminus">-                // error that should trigger failing the calICalendar's request.</span>
<a href="#l29.587"></a><span id="l29.587" class="difflineminus">-                this.loginAndContinue(aOperation.calendar);</span>
<a href="#l29.588"></a><span id="l29.588" class="difflineminus">-            } else {</span>
<a href="#l29.589"></a><span id="l29.589" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Failing queue with &quot; + aOperation.status);</span>
<a href="#l29.590"></a><span id="l29.590" class="difflineminus">-                this.failQueue(aOperation.status);</span>
<a href="#l29.591"></a><span id="l29.591" class="difflineminus">-            }</span>
<a href="#l29.592"></a><span id="l29.592" class="difflineminus">-        } else {</span>
<a href="#l29.593"></a><span id="l29.593" class="difflineminus">-            let start = aData.indexOf(&quot;Auth=&quot;);</span>
<a href="#l29.594"></a><span id="l29.594" class="difflineminus">-            if (start == -1) {</span>
<a href="#l29.595"></a><span id="l29.595" class="difflineminus">-                // The Auth token could not be extracted</span>
<a href="#l29.596"></a><span id="l29.596" class="difflineminus">-                this.mLoggingIn = false;</span>
<a href="#l29.597"></a><span id="l29.597" class="difflineminus">-                this.invalidate();</span>
<a href="#l29.598"></a><span id="l29.598" class="difflineplus">+                if (error == &quot;invalid_client&quot; || error == &quot;unauthorized_client&quot; || error == &quot;http_401&quot;) {</span>
<a href="#l29.599"></a><span id="l29.599" class="difflineplus">+                    this.notifyOutdated();</span>
<a href="#l29.600"></a><span id="l29.600" class="difflineplus">+                } else {</span>
<a href="#l29.601"></a><span id="l29.601" class="difflineplus">+                    cal.ERROR(&quot;[calGoogleSession] Authentication failure: &quot; + aData);</span>
<a href="#l29.602"></a><span id="l29.602" class="difflineplus">+                }</span>
<a href="#l29.603"></a><span id="l29.603" class="difflineplus">+                deferred.reject(new Components.Exception(error));</span>
<a href="#l29.604"></a><span id="l29.604" class="difflineplus">+            }.bind(this);</span>
<a href="#l29.605"></a><span id="l29.605" class="difflineplus">+</span>
<a href="#l29.606"></a><span id="l29.606" class="difflineplus">+            let connect = function() {</span>
<a href="#l29.607"></a><span id="l29.607" class="difflineplus">+                // Use the async prompter to avoid multiple master password prompts</span>
<a href="#l29.608"></a><span id="l29.608" class="difflineplus">+                let self = this;</span>
<a href="#l29.609"></a><span id="l29.609" class="difflineplus">+                let promptlistener = {</span>
<a href="#l29.610"></a><span id="l29.610" class="difflineplus">+                    onPromptStart: function() {</span>
<a href="#l29.611"></a><span id="l29.611" class="difflineplus">+                        // Usually this function should be synchronous. The OAuth</span>
<a href="#l29.612"></a><span id="l29.612" class="difflineplus">+                        // connection itself is asynchronous, but if a master</span>
<a href="#l29.613"></a><span id="l29.613" class="difflineplus">+                        // password is prompted it will block on that.</span>
<a href="#l29.614"></a><span id="l29.614" class="difflineplus">+                        this.onPromptAuthAvailable();</span>
<a href="#l29.615"></a><span id="l29.615" class="difflineplus">+                        return true;</span>
<a href="#l29.616"></a><span id="l29.616" class="difflineplus">+                    },</span>
<a href="#l29.617"></a><span id="l29.617"> </span>
<a href="#l29.618"></a><span id="l29.618" class="difflineminus">-                // Retry login</span>
<a href="#l29.619"></a><span id="l29.619" class="difflineminus">-                this.loginAndContinue(aOperation.calendar);</span>
<a href="#l29.620"></a><span id="l29.620" class="difflineminus">-            } else {</span>
<a href="#l29.621"></a><span id="l29.621" class="difflineminus">-                this.mAuthToken = aData.substring(start + 5, aData.length - 1);</span>
<a href="#l29.622"></a><span id="l29.622" class="difflineminus">-</span>
<a href="#l29.623"></a><span id="l29.623" class="difflineminus">-                this.mLoggingIn = false;</span>
<a href="#l29.624"></a><span id="l29.624" class="difflineplus">+                    onPromptAuthAvailable: function() {</span>
<a href="#l29.625"></a><span id="l29.625" class="difflineplus">+                        self.oauth.connect(authSuccess, authFailed, true, false);</span>
<a href="#l29.626"></a><span id="l29.626" class="difflineplus">+                    },</span>
<a href="#l29.627"></a><span id="l29.627" class="difflineplus">+                    onPromptCanceled: authFailed</span>
<a href="#l29.628"></a><span id="l29.628" class="difflineplus">+                };</span>
<a href="#l29.629"></a><span id="l29.629" class="difflineplus">+                let asyncprompter = Components.classes[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l29.630"></a><span id="l29.630" class="difflineplus">+                                              .getService(Components.interfaces.nsIMsgAsyncPrompter);</span>
<a href="#l29.631"></a><span id="l29.631" class="difflineplus">+                asyncprompter.queueAsyncAuthPrompt(&quot;googleapi://&quot; + this.id, false, promptlistener);</span>
<a href="#l29.632"></a><span id="l29.632" class="difflineplus">+            }.bind(this);</span>
<a href="#l29.633"></a><span id="l29.633"> </span>
<a href="#l29.634"></a><span id="l29.634" class="difflineminus">-                if (this.persist) {</span>
<a href="#l29.635"></a><span id="l29.635" class="difflineminus">-                    try {</span>
<a href="#l29.636"></a><span id="l29.636" class="difflineminus">-                        passwordManagerSave(this.mGoogleUser,</span>
<a href="#l29.637"></a><span id="l29.637" class="difflineminus">-                                            this.mGooglePass);</span>
<a href="#l29.638"></a><span id="l29.638" class="difflineminus">-                    } catch (e) {</span>
<a href="#l29.639"></a><span id="l29.639" class="difflineminus">-                        // This error is non-fatal, but would constrict</span>
<a href="#l29.640"></a><span id="l29.640" class="difflineminus">-                        // functionality</span>
<a href="#l29.641"></a><span id="l29.641" class="difflineminus">-                        cal.LOG(&quot;[calGoogleCalendar] Error adding password to manager&quot;);</span>
<a href="#l29.642"></a><span id="l29.642" class="difflineplus">+            if (accessToken) {</span>
<a href="#l29.643"></a><span id="l29.643" class="difflineplus">+                deferred.resolve(accessToken);</span>
<a href="#l29.644"></a><span id="l29.644" class="difflineplus">+            } else {</span>
<a href="#l29.645"></a><span id="l29.645" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] No access token for &quot; + this.mId +</span>
<a href="#l29.646"></a><span id="l29.646" class="difflineplus">+                        &quot;, refreshing token&quot;);</span>
<a href="#l29.647"></a><span id="l29.647" class="difflineplus">+                // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l29.648"></a><span id="l29.648" class="difflineplus">+                // master password prompt will show just the buttons and</span>
<a href="#l29.649"></a><span id="l29.649" class="difflineplus">+                // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l29.650"></a><span id="l29.650" class="difflineplus">+                // all is well.</span>
<a href="#l29.651"></a><span id="l29.651" class="difflineplus">+                function postpone() {</span>
<a href="#l29.652"></a><span id="l29.652" class="difflineplus">+                    let win = cal.getCalendarWindow();</span>
<a href="#l29.653"></a><span id="l29.653" class="difflineplus">+                    if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l29.654"></a><span id="l29.654" class="difflineplus">+                        setTimeout(postpone, 400);</span>
<a href="#l29.655"></a><span id="l29.655" class="difflineplus">+                    } else {</span>
<a href="#l29.656"></a><span id="l29.656" class="difflineplus">+                        connect();</span>
<a href="#l29.657"></a><span id="l29.657">                     }</span>
<a href="#l29.658"></a><span id="l29.658">                 }</span>
<a href="#l29.659"></a><span id="l29.659" class="difflineminus">-</span>
<a href="#l29.660"></a><span id="l29.660" class="difflineminus">-                // Process Items that were requested while logging in</span>
<a href="#l29.661"></a><span id="l29.661" class="difflineminus">-                let request;</span>
<a href="#l29.662"></a><span id="l29.662" class="difflineminus">-                // Extra parentheses to avoid js strict warning.</span>
<a href="#l29.663"></a><span id="l29.663" class="difflineminus">-                while ((request = this.mItemQueue.shift())) {</span>
<a href="#l29.664"></a><span id="l29.664" class="difflineminus">-                    cal.LOG(&quot;[calGoogleCalendar] Processing Queue Item: &quot; + request.uri);</span>
<a href="#l29.665"></a><span id="l29.665" class="difflineminus">-                    request.commit(this);</span>
<a href="#l29.666"></a><span id="l29.666" class="difflineminus">-                }</span>
<a href="#l29.667"></a><span id="l29.667" class="difflineplus">+                setTimeout(postpone, 0);</span>
<a href="#l29.668"></a><span id="l29.668">             }</span>
<a href="#l29.669"></a><span id="l29.669" class="difflineplus">+        } catch (e) {</span>
<a href="#l29.670"></a><span id="l29.670" class="difflineplus">+            // If something went wrong, reset the login state just in case</span>
<a href="#l29.671"></a><span id="l29.671" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l29.672"></a><span id="l29.672" class="difflineplus">+            deferred.reject(e);</span>
<a href="#l29.673"></a><span id="l29.673">         }</span>
<a href="#l29.674"></a><span id="l29.674" class="difflineplus">+        return deferred.promise.then(function(accessToken) {</span>
<a href="#l29.675"></a><span id="l29.675" class="difflineplus">+            this.mLoginPromise = null;</span>
<a href="#l29.676"></a><span id="l29.676" class="difflineplus">+            return accessToken;</span>
<a href="#l29.677"></a><span id="l29.677" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l29.678"></a><span id="l29.678" class="difflineplus">+            this.mLoginPromise = null;</span>
<a href="#l29.679"></a><span id="l29.679" class="difflineplus">+            throw e;</span>
<a href="#l29.680"></a><span id="l29.680" class="difflineplus">+        }.bind(this));</span>
<a href="#l29.681"></a><span id="l29.681">     },</span>
<a href="#l29.682"></a><span id="l29.682"> </span>
<a href="#l29.683"></a><span id="l29.683">     /**</span>
<a href="#l29.684"></a><span id="l29.684">      * asyncItemRequest</span>
<a href="#l29.685"></a><span id="l29.685">      * get or post an Item from or to Google using the Queue.</span>
<a href="#l29.686"></a><span id="l29.686">      *</span>
<a href="#l29.687"></a><span id="l29.687">      * @param aRequest          The Request Object. This is an instance of</span>
<a href="#l29.688"></a><span id="l29.688" class="difflineminus">-     *                          calGoogleRequest</span>
<a href="#l29.689"></a><span id="l29.689" class="difflineplus">+     *                          calGoogleRequest.</span>
<a href="#l29.690"></a><span id="l29.690">      */</span>
<a href="#l29.691"></a><span id="l29.691">     asyncItemRequest: function cGS_asyncItemRequest(aRequest) {</span>
<a href="#l29.692"></a><span id="l29.692" class="difflineminus">-</span>
<a href="#l29.693"></a><span id="l29.693" class="difflineminus">-        if (!this.mLoggingIn &amp;&amp; this.mAuthToken) {</span>
<a href="#l29.694"></a><span id="l29.694" class="difflineminus">-            // We are not currently logging in and we have an auth token, so</span>
<a href="#l29.695"></a><span id="l29.695" class="difflineminus">-            // directly try the login request</span>
<a href="#l29.696"></a><span id="l29.696" class="difflineminus">-            this.asyncRawRequest(aRequest);</span>
<a href="#l29.697"></a><span id="l29.697" class="difflineminus">-        } else {</span>
<a href="#l29.698"></a><span id="l29.698" class="difflineminus">-            // Push the request in the queue to be executed later</span>
<a href="#l29.699"></a><span id="l29.699" class="difflineminus">-            this.mItemQueue.push(aRequest);</span>
<a href="#l29.700"></a><span id="l29.700" class="difflineminus">-</span>
<a href="#l29.701"></a><span id="l29.701" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l29.702"></a><span id="l29.702" class="difflineplus">+        let tokenExpiresIn = Math.floor((this.oauth.tokenExpires - (new Date()).getTime()) / 1000);</span>
<a href="#l29.703"></a><span id="l29.703" class="difflineplus">+        if (tokenExpiresIn &lt; 0 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l29.704"></a><span id="l29.704" class="difflineplus">+            cal.LOG(&quot;[calGoogleSession] Token expired &quot; + (-tokenExpiresIn) + &quot; seconds ago, resetting&quot;);</span>
<a href="#l29.705"></a><span id="l29.705" class="difflineplus">+            this.oauth.accessToken = null;</span>
<a href="#l29.706"></a><span id="l29.706" class="difflineplus">+        }</span>
<a href="#l29.707"></a><span id="l29.707"> </span>
<a href="#l29.708"></a><span id="l29.708" class="difflineminus">-            // If we are logging in, then we are done since the passed request</span>
<a href="#l29.709"></a><span id="l29.709" class="difflineminus">-            // will be processed when the login is complete. Otherwise start</span>
<a href="#l29.710"></a><span id="l29.710" class="difflineminus">-            // logging in.</span>
<a href="#l29.711"></a><span id="l29.711" class="difflineminus">-            if (!this.mLoggingIn &amp;&amp; this.mAuthToken == null) {</span>
<a href="#l29.712"></a><span id="l29.712" class="difflineminus">-                // We need to do this on a timeout, otherwise the UI thread will</span>
<a href="#l29.713"></a><span id="l29.713" class="difflineminus">-                // block when the password prompt is shown.</span>
<a href="#l29.714"></a><span id="l29.714" class="difflineminus">-                setTimeout(function() {</span>
<a href="#l29.715"></a><span id="l29.715" class="difflineminus">-                    this.loginAndContinue(aRequest.calendar);</span>
<a href="#l29.716"></a><span id="l29.716" class="difflineminus">-                }, 0, this);</span>
<a href="#l29.717"></a><span id="l29.717" class="difflineplus">+        if (this.accessToken) {</span>
<a href="#l29.718"></a><span id="l29.718" class="difflineplus">+            // Already have a token, we can request directly. If the token is</span>
<a href="#l29.719"></a><span id="l29.719" class="difflineplus">+            // about to expire use it, but refresh the token while we are here.</span>
<a href="#l29.720"></a><span id="l29.720" class="difflineplus">+            if (tokenExpiresIn &lt; 30 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l29.721"></a><span id="l29.721" class="difflineplus">+                cal.LOG(&quot;[calGoogleSession] Token will expire in &quot; + tokenExpiresIn + &quot; seconds, refreshing&quot;);</span>
<a href="#l29.722"></a><span id="l29.722" class="difflineplus">+                this.mLoginPromise = this.login();</span>
<a href="#l29.723"></a><span id="l29.723" class="difflineplus">+                this.mLoginPromise.then(function() {</span>
<a href="#l29.724"></a><span id="l29.724" class="difflineplus">+                    cal.LOG(&quot;[calGoogleSession] Premature token refresh completed&quot;);</span>
<a href="#l29.725"></a><span id="l29.725" class="difflineplus">+                });</span>
<a href="#l29.726"></a><span id="l29.726">             }</span>
<a href="#l29.727"></a><span id="l29.727" class="difflineplus">+            return aRequest.commit(this);</span>
<a href="#l29.728"></a><span id="l29.728" class="difflineplus">+        } else if (this.mLoginPromise) {</span>
<a href="#l29.729"></a><span id="l29.729" class="difflineplus">+            // We are logging in and have no token, queue the request</span>
<a href="#l29.730"></a><span id="l29.730" class="difflineplus">+            cal.LOG(&quot;[calGoogleSession] Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l29.731"></a><span id="l29.731" class="difflineplus">+            return this.mLoginPromise.then(function() {</span>
<a href="#l29.732"></a><span id="l29.732" class="difflineplus">+                return aRequest.commit(this);</span>
<a href="#l29.733"></a><span id="l29.733" class="difflineplus">+            }.bind(this), function(e) {</span>
<a href="#l29.734"></a><span id="l29.734" class="difflineplus">+                // If the user cancelled the login dialog, then disable the</span>
<a href="#l29.735"></a><span id="l29.735" class="difflineplus">+                // calendar until the next startup or manual enable.</span>
<a href="#l29.736"></a><span id="l29.736" class="difflineplus">+                if (aRequest.calendar &amp;&amp; e.message == &quot;cancelled&quot;) {</span>
<a href="#l29.737"></a><span id="l29.737" class="difflineplus">+                    aRequest.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l29.738"></a><span id="l29.738" class="difflineplus">+                    aRequest.calendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l29.739"></a><span id="l29.739" class="difflineplus">+                    aRequest.calendar.setProperty(&quot;currentStatus&quot;,</span>
<a href="#l29.740"></a><span id="l29.740" class="difflineplus">+                                    Components.results.NS_ERROR_FAILURE);</span>
<a href="#l29.741"></a><span id="l29.741" class="difflineplus">+                }</span>
<a href="#l29.742"></a><span id="l29.742" class="difflineplus">+</span>
<a href="#l29.743"></a><span id="l29.743" class="difflineplus">+                throw e;</span>
<a href="#l29.744"></a><span id="l29.744" class="difflineplus">+            }.bind(this));</span>
<a href="#l29.745"></a><span id="l29.745" class="difflineplus">+        } else {</span>
<a href="#l29.746"></a><span id="l29.746" class="difflineplus">+            // Not logging in and no token, get the login promise and retry.</span>
<a href="#l29.747"></a><span id="l29.747" class="difflineplus">+            this.mLoginPromise = this.login();</span>
<a href="#l29.748"></a><span id="l29.748" class="difflineplus">+            return this.asyncItemRequest(aRequest);</span>
<a href="#l29.749"></a><span id="l29.749">         }</span>
<a href="#l29.750"></a><span id="l29.750">     },</span>
<a href="#l29.751"></a><span id="l29.751"> </span>
<a href="#l29.752"></a><span id="l29.752" class="difflineminus">-    /**</span>
<a href="#l29.753"></a><span id="l29.753" class="difflineminus">-     * asyncRawRequest</span>
<a href="#l29.754"></a><span id="l29.754" class="difflineminus">-     * get or post an Item from or to Google without the Queue.</span>
<a href="#l29.755"></a><span id="l29.755" class="difflineminus">-     *</span>
<a href="#l29.756"></a><span id="l29.756" class="difflineminus">-     * @param aRequest          The Request Object. This is an instance of</span>
<a href="#l29.757"></a><span id="l29.757" class="difflineminus">-     *                          calGoogleRequest</span>
<a href="#l29.758"></a><span id="l29.758" class="difflineminus">-     */</span>
<a href="#l29.759"></a><span id="l29.759" class="difflineminus">-    asyncRawRequest: function cGS_asyncRawRequest(aRequest) {</span>
<a href="#l29.760"></a><span id="l29.760" class="difflineminus">-        // Request is handled by an instance of the calGoogleRequest</span>
<a href="#l29.761"></a><span id="l29.761" class="difflineminus">-        // We don't need to keep track of these requests, they</span>
<a href="#l29.762"></a><span id="l29.762" class="difflineminus">-        // pass to a listener or just die</span>
<a href="#l29.763"></a><span id="l29.763" class="difflineplus">+    asyncPaginatedRequest: function(aRequest, onFirst, onEach, onLast) {</span>
<a href="#l29.764"></a><span id="l29.764" class="difflineplus">+        return Task.spawn(function() {</span>
<a href="#l29.765"></a><span id="l29.765" class="difflineplus">+            let data = yield this.asyncItemRequest(aRequest);</span>
<a href="#l29.766"></a><span id="l29.766" class="difflineplus">+</span>
<a href="#l29.767"></a><span id="l29.767" class="difflineplus">+            if (onFirst) {</span>
<a href="#l29.768"></a><span id="l29.768" class="difflineplus">+                yield onFirst(data);</span>
<a href="#l29.769"></a><span id="l29.769" class="difflineplus">+            }</span>
<a href="#l29.770"></a><span id="l29.770"> </span>
<a href="#l29.771"></a><span id="l29.771" class="difflineminus">-        ASSERT(aRequest);</span>
<a href="#l29.772"></a><span id="l29.772" class="difflineminus">-        aRequest.commit(this);</span>
<a href="#l29.773"></a><span id="l29.773" class="difflineplus">+            if (onEach) {</span>
<a href="#l29.774"></a><span id="l29.774" class="difflineplus">+                yield onEach(data);</span>
<a href="#l29.775"></a><span id="l29.775" class="difflineplus">+            }</span>
<a href="#l29.776"></a><span id="l29.776" class="difflineplus">+</span>
<a href="#l29.777"></a><span id="l29.777" class="difflineplus">+            if (data.nextPageToken) {</span>
<a href="#l29.778"></a><span id="l29.778" class="difflineplus">+                aRequest.addQueryParameter(&quot;pageToken&quot;, data.nextPageToken);</span>
<a href="#l29.779"></a><span id="l29.779" class="difflineplus">+                throw new Task.Result(yield this.asyncPaginatedRequest(aRequest, null, onEach, onLast));</span>
<a href="#l29.780"></a><span id="l29.780" class="difflineplus">+            } else if (onLast) {</span>
<a href="#l29.781"></a><span id="l29.781" class="difflineplus">+                throw new Task.Result(yield onLast(data));</span>
<a href="#l29.782"></a><span id="l29.782" class="difflineplus">+            }</span>
<a href="#l29.783"></a><span id="l29.783" class="difflineplus">+        }.bind(this));</span>
<a href="#l29.784"></a><span id="l29.784">     },</span>
<a href="#l29.785"></a><span id="l29.785"> </span>
<a href="#l29.786"></a><span id="l29.786">     /**</span>
<a href="#l29.787"></a><span id="l29.787">      * calIFreeBusyProvider Implementation</span>
<a href="#l29.788"></a><span id="l29.788">      */</span>
<a href="#l29.789"></a><span id="l29.789">     getFreeBusyIntervals: function cGS_getFreeBusyIntervals(aCalId,</span>
<a href="#l29.790"></a><span id="l29.790">                                                             aRangeStart,</span>
<a href="#l29.791"></a><span id="l29.791">                                                             aRangeEnd,</span>
<a href="#l29.792"></a><span id="l29.792">                                                             aBusyTypes,</span>
<a href="#l29.793"></a><span id="l29.793">                                                             aListener) {</span>
<a href="#l29.794"></a><span id="l29.794" class="difflineminus">-        if (aCalId.indexOf(&quot;@&quot;) &lt; 0 || aCalId.indexOf(&quot;.&quot;) &lt; 0) {</span>
<a href="#l29.795"></a><span id="l29.795" class="difflineplus">+        let completeSync = function(aIntervals) {</span>
<a href="#l29.796"></a><span id="l29.796" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l29.797"></a><span id="l29.797" class="difflineplus">+                    &quot;suceeded, returning &quot; + aIntervals.length + &quot; intervals&quot;);</span>
<a href="#l29.798"></a><span id="l29.798" class="difflineplus">+            aListener.onResult({ status: Components.results.NS_OK }, aIntervals);</span>
<a href="#l29.799"></a><span id="l29.799" class="difflineplus">+        }.bind(this);</span>
<a href="#l29.800"></a><span id="l29.800" class="difflineplus">+</span>
<a href="#l29.801"></a><span id="l29.801" class="difflineplus">+        let failSync = function(aStatus, aMessage) {</span>
<a href="#l29.802"></a><span id="l29.802" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l29.803"></a><span id="l29.803" class="difflineplus">+                    &quot; failed (&quot; + aStatus + &quot;): &quot; + aMessage);</span>
<a href="#l29.804"></a><span id="l29.804" class="difflineplus">+            aListener.onResult({ status: aStatus }, aMessage);</span>
<a href="#l29.805"></a><span id="l29.805" class="difflineplus">+        }.bind(this);</span>
<a href="#l29.806"></a><span id="l29.806" class="difflineplus">+</span>
<a href="#l29.807"></a><span id="l29.807" class="difflineplus">+        if (aCalId.indexOf(&quot;@&quot;) &lt; 0 || aCalId.indexOf(&quot;.&quot;) &lt; 0 ||</span>
<a href="#l29.808"></a><span id="l29.808" class="difflineplus">+            !aCalId.toLowerCase().startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l29.809"></a><span id="l29.809">             // No valid email, screw it</span>
<a href="#l29.810"></a><span id="l29.810" class="difflineminus">-            aListener.onResult(null, null);</span>
<a href="#l29.811"></a><span id="l29.811" class="difflineminus">-            return null;</span>
<a href="#l29.812"></a><span id="l29.812" class="difflineplus">+            return failSync(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l29.813"></a><span id="l29.813">         }</span>
<a href="#l29.814"></a><span id="l29.814"> </span>
<a href="#l29.815"></a><span id="l29.815" class="difflineminus">-        // Requesting only a DATE returns items based on UTC. Therefore, we make</span>
<a href="#l29.816"></a><span id="l29.816" class="difflineminus">-        // sure both start and end dates include a time and timezone. This may</span>
<a href="#l29.817"></a><span id="l29.817" class="difflineminus">-        // not quite be what was requested, but I'd say its a shortcoming of</span>
<a href="#l29.818"></a><span id="l29.818" class="difflineminus">-        // rfc3339.</span>
<a href="#l29.819"></a><span id="l29.819">         if (aRangeStart) {</span>
<a href="#l29.820"></a><span id="l29.820" class="difflineminus">-            aRangeStart = aRangeStart.clone();</span>
<a href="#l29.821"></a><span id="l29.821" class="difflineminus">-            aRangeStart.isDate = false;</span>
<a href="#l29.822"></a><span id="l29.822" class="difflineplus">+            aRangeStart = aRangeStart.getInTimezone(cal.UTC());</span>
<a href="#l29.823"></a><span id="l29.823">         }</span>
<a href="#l29.824"></a><span id="l29.824">         if (aRangeEnd) {</span>
<a href="#l29.825"></a><span id="l29.825" class="difflineminus">-            aRangeEnd = aRangeEnd.clone();</span>
<a href="#l29.826"></a><span id="l29.826" class="difflineminus">-            aRangeEnd.isDate = false;</span>
<a href="#l29.827"></a><span id="l29.827" class="difflineplus">+            aRangeEnd = aRangeEnd.getInTimezone(cal.UTC());</span>
<a href="#l29.828"></a><span id="l29.828">         }</span>
<a href="#l29.829"></a><span id="l29.829"> </span>
<a href="#l29.830"></a><span id="l29.830">         let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l29.831"></a><span id="l29.831">         let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l29.832"></a><span id="l29.832" class="difflineminus">-</span>
<a href="#l29.833"></a><span id="l29.833" class="difflineminus">-        let request = new calGoogleRequest(this);</span>
<a href="#l29.834"></a><span id="l29.834" class="difflineplus">+        /* 7 is the length of &quot;mailto:&quot;, we've asserted this above */</span>
<a href="#l29.835"></a><span id="l29.835" class="difflineplus">+        let strippedCalId = aCalId.substr(7);</span>
<a href="#l29.836"></a><span id="l29.836"> </span>
<a href="#l29.837"></a><span id="l29.837" class="difflineminus">-        request.type = request.GET;</span>
<a href="#l29.838"></a><span id="l29.838" class="difflineminus">-        request.uri = &quot;https://www.google.com/calendar/feeds/&quot; +</span>
<a href="#l29.839"></a><span id="l29.839" class="difflineminus">-                      encodeURIComponent(aCalId.replace(/^mailto:/i, &quot;&quot;)) +</span>
<a href="#l29.840"></a><span id="l29.840" class="difflineminus">-                      &quot;/private/free-busy&quot;;</span>
<a href="#l29.841"></a><span id="l29.841" class="difflineminus">-        request.operationListener = aListener;</span>
<a href="#l29.842"></a><span id="l29.842" class="difflineminus">-        request.itemRangeStart = aRangeStart;</span>
<a href="#l29.843"></a><span id="l29.843" class="difflineminus">-        request.itemRangeEnd = aRangeEnd;</span>
<a href="#l29.844"></a><span id="l29.844" class="difflineplus">+        let requestData = {</span>
<a href="#l29.845"></a><span id="l29.845" class="difflineplus">+          timeMin: rfcRangeStart,</span>
<a href="#l29.846"></a><span id="l29.846" class="difflineplus">+          timeMax: rfcRangeEnd,</span>
<a href="#l29.847"></a><span id="l29.847" class="difflineplus">+          items: [ { id: strippedCalId } ]</span>
<a href="#l29.848"></a><span id="l29.848" class="difflineplus">+        };</span>
<a href="#l29.849"></a><span id="l29.849" class="difflineplus">+</span>
<a href="#l29.850"></a><span id="l29.850" class="difflineplus">+        let request = new calGoogleRequest();</span>
<a href="#l29.851"></a><span id="l29.851" class="difflineplus">+        request.type = request.ADD;</span>
<a href="#l29.852"></a><span id="l29.852" class="difflineplus">+        request.calendar = null;</span>
<a href="#l29.853"></a><span id="l29.853" class="difflineplus">+        request.uri = API_BASE.EVENTS + &quot;freeBusy&quot;;</span>
<a href="#l29.854"></a><span id="l29.854">         request.reauthenticate = false;</span>
<a href="#l29.855"></a><span id="l29.855" class="difflineplus">+        request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l29.856"></a><span id="l29.856" class="difflineplus">+                              JSON.stringify(requestData));</span>
<a href="#l29.857"></a><span id="l29.857"> </span>
<a href="#l29.858"></a><span id="l29.858">         // Request Parameters</span>
<a href="#l29.859"></a><span id="l29.859" class="difflineminus">-        request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l29.860"></a><span id="l29.860" class="difflineminus">-        request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l29.861"></a><span id="l29.861" class="difflineminus">-        request.addQueryParameter(&quot;singleevents&quot;, &quot;true&quot;);</span>
<a href="#l29.862"></a><span id="l29.862" class="difflineminus">-        request.addQueryParameter(&quot;start-min&quot;, rfcRangeStart);</span>
<a href="#l29.863"></a><span id="l29.863" class="difflineminus">-        request.addQueryParameter(&quot;start-max&quot;, rfcRangeEnd);</span>
<a href="#l29.864"></a><span id="l29.864" class="difflineplus">+        this.asyncItemRequest(request).then(function(aData) {</span>
<a href="#l29.865"></a><span id="l29.865" class="difflineplus">+            if (&quot;calendars&quot; in aData &amp;&amp; strippedCalId in aData.calendars) {</span>
<a href="#l29.866"></a><span id="l29.866" class="difflineplus">+                let calData = aData.calendars[strippedCalId];</span>
<a href="#l29.867"></a><span id="l29.867" class="difflineplus">+                let reason = calData.errors &amp;&amp; calData.errors[0] &amp;&amp; calData.errors[0].reason;</span>
<a href="#l29.868"></a><span id="l29.868" class="difflineplus">+                if (reason) {</span>
<a href="#l29.869"></a><span id="l29.869" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason);</span>
<a href="#l29.870"></a><span id="l29.870" class="difflineplus">+                    failSync(Components.results.NS_ERROR_FAILURE, reason);</span>
<a href="#l29.871"></a><span id="l29.871" class="difflineplus">+                } else {</span>
<a href="#l29.872"></a><span id="l29.872" class="difflineplus">+                    let utcZone = cal.UTC();</span>
<a href="#l29.873"></a><span id="l29.873" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Found &quot; + calData.busy.length + &quot; busy slots within range for &quot; + strippedCalId);</span>
<a href="#l29.874"></a><span id="l29.874" class="difflineplus">+                    let busyRanges = calData.busy.map(function(entry) {</span>
<a href="#l29.875"></a><span id="l29.875" class="difflineplus">+                        let start = cal.fromRFC3339(entry.start, utcZone);</span>
<a href="#l29.876"></a><span id="l29.876" class="difflineplus">+                        let end = cal.fromRFC3339(entry.end, utcZone);</span>
<a href="#l29.877"></a><span id="l29.877" class="difflineplus">+                        let interval = new cal.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l29.878"></a><span id="l29.878" class="difflineplus">+                        LOGinterval(interval);</span>
<a href="#l29.879"></a><span id="l29.879" class="difflineplus">+                        return interval;</span>
<a href="#l29.880"></a><span id="l29.880" class="difflineplus">+                    });</span>
<a href="#l29.881"></a><span id="l29.881" class="difflineplus">+                    completeSync(busyRanges);</span>
<a href="#l29.882"></a><span id="l29.882" class="difflineplus">+                }</span>
<a href="#l29.883"></a><span id="l29.883" class="difflineplus">+            } else {</span>
<a href="#l29.884"></a><span id="l29.884" class="difflineplus">+                cal.ERROR(&quot;[calGoogleCalendar] Invalid freebusy response: &quot; + aData.toSource());</span>
<a href="#l29.885"></a><span id="l29.885" class="difflineplus">+                failSync(Components.results.NS_ERROR_FAILURE, (aData &amp;&amp; aData.toSource()));</span>
<a href="#l29.886"></a><span id="l29.886" class="difflineplus">+            }</span>
<a href="#l29.887"></a><span id="l29.887" class="difflineplus">+        }.bind(this), function(e) {</span>
<a href="#l29.888"></a><span id="l29.888" class="difflineplus">+            cal.ERROR(&quot;[calGoogleCalendar] Failed freebusy request: &quot; + e);</span>
<a href="#l29.889"></a><span id="l29.889" class="difflineplus">+            return failSync(request.status, null);</span>
<a href="#l29.890"></a><span id="l29.890" class="difflineplus">+        }.bind(this));</span>
<a href="#l29.891"></a><span id="l29.891"> </span>
<a href="#l29.892"></a><span id="l29.892" class="difflineminus">-        let session = this;</span>
<a href="#l29.893"></a><span id="l29.893" class="difflineminus">-        request.responseListener = {</span>
<a href="#l29.894"></a><span id="l29.894" class="difflineminus">-            onResult: function cGS_getFreeBusyIntervals_onResult(aOperation, aData) {</span>
<a href="#l29.895"></a><span id="l29.895" class="difflineminus">-                session.getFreeBusyIntervals_response(aOperation,</span>
<a href="#l29.896"></a><span id="l29.896" class="difflineminus">-                                                      aData,</span>
<a href="#l29.897"></a><span id="l29.897" class="difflineminus">-                                                      aCalId,</span>
<a href="#l29.898"></a><span id="l29.898" class="difflineminus">-                                                      aRangeStart,</span>
<a href="#l29.899"></a><span id="l29.899" class="difflineminus">-                                                      aRangeEnd);</span>
<a href="#l29.900"></a><span id="l29.900" class="difflineminus">-            }</span>
<a href="#l29.901"></a><span id="l29.901" class="difflineminus">-        };</span>
<a href="#l29.902"></a><span id="l29.902" class="difflineminus">-</span>
<a href="#l29.903"></a><span id="l29.903" class="difflineminus">-        this.asyncItemRequest(request);</span>
<a href="#l29.904"></a><span id="l29.904">         return request;</span>
<a href="#l29.905"></a><span id="l29.905">     },</span>
<a href="#l29.906"></a><span id="l29.906"> </span>
<a href="#l29.907"></a><span id="l29.907" class="difflineminus">-    getFreeBusyIntervals_response: function getFreeBusyIntervals_response(aOperation,</span>
<a href="#l29.908"></a><span id="l29.908" class="difflineminus">-                                                                          aData,</span>
<a href="#l29.909"></a><span id="l29.909" class="difflineminus">-                                                                          aCalId,</span>
<a href="#l29.910"></a><span id="l29.910" class="difflineminus">-                                                                          aRangeStart,</span>
<a href="#l29.911"></a><span id="l29.911" class="difflineminus">-                                                                          aRangeEnd) {</span>
<a href="#l29.912"></a><span id="l29.912" class="difflineminus">-        // Prepare Namespaces</span>
<a href="#l29.913"></a><span id="l29.913" class="difflineminus">-        if (aOperation.status == kGOOGLE_LOGIN_FAILED ||</span>
<a href="#l29.914"></a><span id="l29.914" class="difflineminus">-            !Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l29.915"></a><span id="l29.915" class="difflineminus">-            aOperation.operationListener.onResult(aOperation, null);</span>
<a href="#l29.916"></a><span id="l29.916" class="difflineminus">-            return;</span>
<a href="#l29.917"></a><span id="l29.917" class="difflineminus">-        }</span>
<a href="#l29.918"></a><span id="l29.918" class="difflineplus">+    getCalendarList: function() {</span>
<a href="#l29.919"></a><span id="l29.919" class="difflineplus">+        let calendarRequest = new calGoogleRequest();</span>
<a href="#l29.920"></a><span id="l29.920" class="difflineplus">+        calendarRequest.type = calendarRequest.GET;</span>
<a href="#l29.921"></a><span id="l29.921" class="difflineplus">+        calendarRequest.uri = API_BASE.EVENTS + &quot;users/me/calendarList&quot;;</span>
<a href="#l29.922"></a><span id="l29.922"> </span>
<a href="#l29.923"></a><span id="l29.923" class="difflineminus">-        // A feed was passed back, parse it.</span>
<a href="#l29.924"></a><span id="l29.924" class="difflineminus">-        let xml = cal.xml.parseString(aData);</span>
<a href="#l29.925"></a><span id="l29.925" class="difflineminus">-        let timezoneString = gdataXPathFirst(xml, 'atom:feed/gCal:timezone/@value') || &quot;UTC&quot;;</span>
<a href="#l29.926"></a><span id="l29.926" class="difflineminus">-        let timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l29.927"></a><span id="l29.927" class="difflineplus">+        let items = [];</span>
<a href="#l29.928"></a><span id="l29.928" class="difflineplus">+        return this.asyncPaginatedRequest(calendarRequest, null, function(data) {</span>
<a href="#l29.929"></a><span id="l29.929" class="difflineplus">+            Array.prototype.push.apply(items, data.items);</span>
<a href="#l29.930"></a><span id="l29.930" class="difflineplus">+        }.bind(this), function() {</span>
<a href="#l29.931"></a><span id="l29.931" class="difflineplus">+            return items;</span>
<a href="#l29.932"></a><span id="l29.932" class="difflineplus">+        }.bind(this));</span>
<a href="#l29.933"></a><span id="l29.933" class="difflineplus">+    },</span>
<a href="#l29.934"></a><span id="l29.934"> </span>
<a href="#l29.935"></a><span id="l29.935" class="difflineminus">-        let intervals = [];</span>
<a href="#l29.936"></a><span id="l29.936" class="difflineminus">-        const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l29.937"></a><span id="l29.937" class="difflineminus">-        for each (let entry in gdataXPath(xml, 'atom:feed/atom:entry')) {</span>
<a href="#l29.938"></a><span id="l29.938" class="difflineminus">-            let start = cal.fromRFC3339(gdataXPathFirst(entry, 'gd:when/@startTime'), timezone);</span>
<a href="#l29.939"></a><span id="l29.939" class="difflineminus">-            let end = cal.fromRFC3339(gdataXPathFirst(entry, 'gd:when/@endTime'), timezone);</span>
<a href="#l29.940"></a><span id="l29.940" class="difflineminus">-            let interval = new cal.FreeBusyInterval(aCalId, fbtypes.BUSY, start, end);</span>
<a href="#l29.941"></a><span id="l29.941" class="difflineminus">-            LOGinterval(interval);</span>
<a href="#l29.942"></a><span id="l29.942" class="difflineminus">-            intervals.push(interval);</span>
<a href="#l29.943"></a><span id="l29.943" class="difflineminus">-        }</span>
<a href="#l29.944"></a><span id="l29.944" class="difflineminus">-</span>
<a href="#l29.945"></a><span id="l29.945" class="difflineminus">-        aOperation.operationListener.onResult(aOperation, intervals);</span>
<a href="#l29.946"></a><span id="l29.946" class="difflineplus">+    getTasksList: function() {</span>
<a href="#l29.947"></a><span id="l29.947" class="difflineplus">+        let tasksRequest = new calGoogleRequest();</span>
<a href="#l29.948"></a><span id="l29.948" class="difflineplus">+        tasksRequest.type = tasksRequest.GET;</span>
<a href="#l29.949"></a><span id="l29.949" class="difflineplus">+        tasksRequest.uri = API_BASE.TASKS + &quot;users/@me/lists&quot;;</span>
<a href="#l29.950"></a><span id="l29.950" class="difflineplus">+        let items = [];</span>
<a href="#l29.951"></a><span id="l29.951" class="difflineplus">+        return this.asyncPaginatedRequest(tasksRequest, null, function(data) {</span>
<a href="#l29.952"></a><span id="l29.952" class="difflineplus">+            Array.prototype.push.apply(items, data.items);</span>
<a href="#l29.953"></a><span id="l29.953" class="difflineplus">+        }.bind(this), function() {</span>
<a href="#l29.954"></a><span id="l29.954" class="difflineplus">+            return items;</span>
<a href="#l29.955"></a><span id="l29.955" class="difflineplus">+        }.bind(this));</span>
<a href="#l29.956"></a><span id="l29.956">     }</span>
<a href="#l29.957"></a><span id="l29.957"> };</span>
<a href="#l29.958"></a><span id="l29.958" class="difflineplus">+</span>
<a href="#l29.959"></a><span id="l29.959" class="difflineplus">+// Before you spend time trying to find out what this means, please note</span>
<a href="#l29.960"></a><span id="l29.960" class="difflineplus">+// that doing so and using the information WILL cause Google to revoke</span>
<a href="#l29.961"></a><span id="l29.961" class="difflineplus">+// this extension's privileges, which means not one Lightning user will</span>
<a href="#l29.962"></a><span id="l29.962" class="difflineplus">+// be able to connect to Google Calendar using Lightning. This will cause</span>
<a href="#l29.963"></a><span id="l29.963" class="difflineplus">+// unhappy users all around which means that the developers will have to</span>
<a href="#l29.964"></a><span id="l29.964" class="difflineplus">+// spend more time with user support, which means less time for features,</span>
<a href="#l29.965"></a><span id="l29.965" class="difflineplus">+// releases and bugfixes.  For a paid developer this would actually mean</span>
<a href="#l29.966"></a><span id="l29.966" class="difflineplus">+// financial harm.</span>
<a href="#l29.967"></a><span id="l29.967" class="difflineplus">+// Do you really want all of this to be your fault? Instead of using the</span>
<a href="#l29.968"></a><span id="l29.968" class="difflineplus">+// information contained here please get your own copy, its really easy.</span>
<a href="#l29.969"></a><span id="l29.969" class="difflineplus">+this[&quot;\x65\x76\x61\x6C&quot;]([String[&quot;\x66\x72\x6F\x6D\x43\x68\x61\x72\x43\x6F&quot;+</span>
<a href="#l29.970"></a><span id="l29.970" class="difflineplus">+&quot;\x64\x65&quot;]((&quot;dpotu!PBVUI`CBTF`VSJ&gt;#iuuqt;00bddpvout/hpphmf/dpn0p0#&lt;dpotu!&quot;+</span>
<a href="#l29.971"></a><span id="l29.971" class="difflineplus">+&quot;PBVUI`TDPQF&gt;#iuuqt;00xxx/hpphmfbqjt/dpn0bvui0dbmfoebs!iuuqt;00xxx/hpphmfb&quot;+</span>
<a href="#l29.972"></a><span id="l29.972" class="difflineplus">+&quot;qjt/dpn0bvui0ubtlt#&lt;dpotu!PBVUI`DMJFOU`JE&gt;#758881386533.nrvnr8u9gw9:fdcmf&quot;+</span>
<a href="#l29.973"></a><span id="l29.973" class="difflineplus">+&quot;h8g:bc5s1eflb:l/bqqt/hpphmfvtfsdpoufou/dpn#&lt;dpotu!PBVUI`DMJFOU`TFDSFU&gt;#uY&quot;+</span>
<a href="#l29.974"></a><span id="l29.974" class="difflineplus">+&quot;JZpUr:b5JBhJSeys18uYbN#&lt;&quot;)[&quot;\x63\x68\x61\x72\x43\x6F\x64\x65\x41\x74&quot;](i)-1)</span>
<a href="#l29.975"></a><span id="l29.975" class="difflineplus">+for(i in (function(){let x=303; while (x--) yield x})())].reverse().join(&quot;&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">rename from calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l30.2"></a><span id="l30.2">rename to calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineat">@@ -1,544 +1,373 @@</span>
<a href="#l30.6"></a><span id="l30.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.7"></a><span id="l30.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.8"></a><span id="l30.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-const atomNS = &quot;http://www.w3.org/2005/Atom&quot;;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-const gdNS = &quot;http://schemas.google.com/g/2005&quot;;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-const gcalNS = &quot;http://schemas.google.com/gCal/2005&quot;;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/shim/Loader.jsm&quot;).shimIt(this);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;);</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/timezoneMap.jsm&quot;);</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-function gdataNSResolver(prefix) {</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-    const ns = {</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-        atom: atomNS,</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-        gd: gdNS,</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-        gCal: gcalNS</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-    };</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+CuImport(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+CuImport(&quot;resource://gre/modules/Preferences.jsm&quot;, this);</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+CuImport(&quot;resource://gre/modules/Promise.jsm&quot;, this);</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+CuImport(&quot;resource://gre/modules/Task.jsm&quot;, this);</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-    return ns[prefix] || atomNS;</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-}</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-function gdataXPath(aNode, aExpr, aType) {</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-    return cal.xml.evalXPath(aNode, aExpr, gdataNSResolver, aType);</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-}</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-function gdataXPathFirst(aNode, aExpr, aType) {</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-    // Different than the caldav/ics functions, this one will return an empty string on null</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-    return cal.xml.evalXPathFirst(aNode, aExpr, gdataNSResolver, aType) || &quot;&quot;;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-}</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calUtils.jsm&quot;, this);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;, this);</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+CuImport(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;, this);</span>
<a href="#l30.48"></a><span id="l30.48"> </span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-/**</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">- * getGoogleSessionManager</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">- * Shortcut to the google session manager</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">- */</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-function getGoogleSessionManager() {</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-    if (this.mObject === undefined) {</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-        this.mObject =</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-            Components.classes[&quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;]</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-                      .createInstance(Components.interfaces.calIGoogleSessionManager);</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-    }</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-    return this.mObject;</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-}</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+const cIE = Components.interfaces.calIErrors;</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+const cIC = Components.interfaces.calICalendar;</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+const FOUR_WEEKS_IN_MINUTES = 40320;</span>
<a href="#l30.66"></a><span id="l30.66"> </span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-/**</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">- * setCalendarPref</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">- * Helper to set an independant Calendar Preference, since I cannot use the</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">- * calendar manager because of early initialization Problems.</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">- *</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">- * @param aCalendar     The Calendar to set the pref for</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">- * @param aPrefName     The Preference name</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">- * @param aPrefType     The type of the preference (&quot;BOOL&quot;, &quot;INT&quot;, &quot;CHAR&quot;)</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">- * @param aPrefValue    The Preference value</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">- *</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">- * @return              The value of aPrefValue</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">- *</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">- * @require aCalendar.googleCalendarName</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">- */</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-function setCalendarPref(aCalendar, aPrefName, aPrefType, aPrefValue) {</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-    Preferences.set(&quot;calendar.google.calPrefs.&quot; + aCalendar.googleCalendarName + &quot;.&quot; +</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-                    aPrefName, aPrefValue, aPrefType);</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-    return aPrefValue;</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-}</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+var EXPORTED_SYMBOLS = [</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+    &quot;ItemToJSON&quot;, &quot;JSONToItem&quot;, &quot;ItemSaver&quot;,</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+    &quot;checkResolveConflict&quot;, &quot;getGoogleId&quot;,</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+    &quot;getItemMetadata&quot;, &quot;saveItemMetadata&quot;,</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+    &quot;deleteItemMetadata&quot;, &quot;migrateItemMetadata&quot;,</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+    &quot;JSONToAlarm&quot;, &quot;getProviderString&quot;,</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+    &quot;monkeyPatch&quot;, &quot;spinEventLoop&quot;,</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+    /* backwards compatibility: */</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+    &quot;promisifyCalendar&quot;, &quot;PromiseAll&quot;</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+];</span>
<a href="#l30.98"></a><span id="l30.98"> </span>
<a href="#l30.99"></a><span id="l30.99"> /**</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">- * getCalendarPref</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">- * Helper to get an independant Calendar Preference, since I cannot use the</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">- * calendar manager because of early initialization Problems.</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">- *</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">- * @param aCalendar     The calendar to set the pref for</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">- * @param aPrefName     The preference name</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">- *</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">- * @return              The preference value</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+ * Retrives the Google ID associated with this event. This is either a simple</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+ * id or the id in combination with the recurrence id.</span>
<a href="#l30.110"></a><span id="l30.110">  *</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">- * @require aCalendar.googleCalendarName</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">- */</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-function getCalendarPref(aCalendar, aPrefName) {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-    return Preferences.get(&quot;calendar.google.calPrefs.&quot; +</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-                           aCalendar.googleCalendarName + &quot;.&quot;  + aPrefName);</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-}</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-/**</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">- * getFormattedString</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">- * Returns the string from the properties file, formatted with args</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">- *</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">- * @param aBundleName   The .properties file to access</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">- * @param aStringName   The property to access</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">- * @param aFormatArgs   An array of arguments to format the string</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">- * @param aComponent    Optionally, the stringbundle component name</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">- * @return              The formatted string</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+ * @param aItem             The Item to get the id for.</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+ * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l30.129"></a><span id="l30.129">  */</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-function getFormattedString(aBundleName, aStringName, aFormatArgs, aComponent) {</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-    return calGetString(aBundleName, aStringName, aFormatArgs, aComponent || &quot;gdata-provider&quot;);</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-}</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-/**</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">- * getCalendarCredentials</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">- * Tries to get the username/password combination of a specific calendar name</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">- * from the password manager or asks the user.</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">- *</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">- * @param   in  aCalendarName   The calendar name to look up. Can be null.</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">- * @param   out aUsername       The username that belongs to the calendar.</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineminus">- * @param   out aPassword       The password that belongs to the calendar.</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">- * @param   out aSavePassword   Should the password be saved?</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">- * @return  Could a password be retrieved?</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">- */</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-function getCalendarCredentials(aCalendarName,</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineminus">-                                aUsername,</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-                                aPassword,</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-                                aSavePassword) {</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-    return cal.auth.getCredentials(&quot;Google Calendar&quot;,</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineminus">-                                   aCalendarName,</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-                                   aUsername,</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-                                   aPassword,</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-                                   aSavePassword);</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-}</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-/**</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">- * Gets the date and time that Google's http server last sent us. Note the</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">- * passed argument is modified. This might not be the exact server time (i.e it</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">- * may be off by network latency), but it does give a good guess when syncing.</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">- *</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">- * @param aDate     The date to modify</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">- */</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-function getCorrectedDate(aDate) {</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-    if (!getCorrectedDate.mClockSkew) {</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-        return aDate;</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+function getGoogleId(aItem, aOfflineStorage) {</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+    let meta = getItemMetadata(aOfflineStorage, aItem) ||</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+               getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+    let baseId = meta ? meta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+    if (aItem.recurrenceId) {</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+        let recSuffix = &quot;_&quot; + aItem.recurrenceId.getInTimezone(cal.UTC()).icalString;</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+        if (!baseId.endsWith(recSuffix)) {</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+            baseId += recSuffix;</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+        }</span>
<a href="#l30.176"></a><span id="l30.176">     }</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-    aDate.second += getCorrectedDate.mClockSkew;</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-    return aDate;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+    return baseId;</span>
<a href="#l30.181"></a><span id="l30.181"> }</span>
<a href="#l30.182"></a><span id="l30.182"> </span>
<a href="#l30.183"></a><span id="l30.183"> /**</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">- * The timezone service to translate Google timezones.</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+ * Save metadata for the given hash id.</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+ *</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+ * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+ * @param aId               The hash id to save metadata with.</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+ * @param aMetadata         The metadata object to save.</span>
<a href="#l30.190"></a><span id="l30.190">  */</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-var gdataTimezoneService = {</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-    ctz: cal.getTimezoneService(),</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-    get floating() {</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-        return this.ctz.floating;</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-    },</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-    get UTC() {</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-        return this.ctz.UTC;</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-    },</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-    get version() {</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-        return this.ctz.version;</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-    },</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-    get defaultTimezone() {</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-        return this.ctz.defaultTimezone;</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-    },</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineminus">-</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-    getTimezone: function gTS_getTimezone(aTzid) {</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-        if (aTzid == &quot;Etc/GMT&quot;) {</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-            // Most timezones are covered by the timezone service, there is one</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-            // exception I've found out about. GMT without DST is pretty close</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-            // to UTC, lets take it.</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-            return UTC();</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-        }</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-        let baseTZ = this.ctz.getTimezone(aTzid);</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineminus">-        ASSERT(baseTZ, &quot;Unknown Timezone requested: &quot; + aTzid);</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineminus">-        return baseTZ;</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineminus">-    }</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineminus">-};</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-/**</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">- * passwordManagerSave</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">- * Helper to insert an entry to the password manager.</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">- *</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">- * @param aUserName     The username to search</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">- * @param aPassword     The corresponding password</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">- */</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-function passwordManagerSave(aUsername, aPassword) {</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-    cal.auth.passwordManagerSave(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-}</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-/**</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">- * passwordManagerGet</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">- * Helper to retrieve an entry from the password manager</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">- *</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineminus">- * @param in  aUsername     The username to search</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">- * @param out aPassword     The corresponding password</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">- * @return                  Does an entry exist in the password manager</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">- */</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-function passwordManagerGet(aUsername, aPassword) {</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineminus">-    return cal.auth.passwordManagerGet(aUsername, aPassword, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-}</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-/**</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">- * passwordManagerRemove</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">- * Helper to remove an entry from the password manager</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">- *</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">- * @param aUsername     The username to remove.</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">- * @return              Could the user be removed?</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">- */</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineminus">-function passwordManagerRemove(aUsername) {</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-    return cal.auth.passwordManagerRemove(aUsername, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+function saveItemMetadata(aOfflineStorage, aId, aMetadata) {</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+    // Save metadata using the same format as for the CalDAV provider, this</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+    // will make things easier when upgrading to the new item based metadata.</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+    let meta = [aMetadata.etag, aMetadata.path, false].join(&quot;\u001A&quot;);</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+    aOfflineStorage.setMetaData(aId, meta);</span>
<a href="#l30.261"></a><span id="l30.261"> }</span>
<a href="#l30.262"></a><span id="l30.262"> </span>
<a href="#l30.263"></a><span id="l30.263"> /**</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineminus">- * If the operation has signaled that a conflict occurred, then prompt the user</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineminus">- * to overwrite. If the user chooses to overwrite, restart the request with the</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">- * right parameters so the request succeeds.</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+ * Migrate item metadata from aOldItem to aNewItem. If aOldItem is a recurring</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+ * event and an exception was turned into an EXDATE, the metadata will be</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+ * updated accordingly.</span>
<a href="#l30.270"></a><span id="l30.270">  *</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">- * @param aOperation        The operation to check</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">- * @param aItem             The updated item from the response</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">- * @return                  False if further processing should be cancelled</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+ * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+ * @param aOldItem          The item to migrate from.</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+ * @param aNewItem          The item to migrate to.</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+ * @param aMetadata         The metadata for this new item.</span>
<a href="#l30.278"></a><span id="l30.278">  */</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineminus">-function resolveConflicts(aOperation, aItem) {</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-    if (aItem &amp;&amp; (aOperation.status == kGOOGLE_CONFLICT_DELETED ||</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-                  aOperation.status == kGOOGLE_CONFLICT_MODIFY)) {</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-        if (aItem == &quot;SEQUENCE-HACK&quot;) {</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-            // Working around a Google issue here, see what happens on a 400</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-            // code in calGoogleRequest.js. This will cause a new request</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineminus">-            // without the sequence number. In return, we get a new item with</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-            // the correct sequence number.</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-            let newItem =  aOperation.newItem.clone();</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineminus">-            let session = aOperation.calendar.session;</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-            newItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-            let xmlEntry = ItemToXMLEntry(newItem, aOperation.calendar,</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-                                          session.userName, session.fullName);</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineplus">+function migrateItemMetadata(aOfflineStorage, aOldItem, aNewItem, aMetadata) {</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+    if (aNewItem.status == &quot;CANCELLED&quot;) {</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineplus">+        deleteItemMetadata(aOfflineStorage, aNewItem);</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+    } else {</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+        saveItemMetadata(aOfflineStorage, aNewItem.hashId, aMetadata);</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+    }</span>
<a href="#l30.298"></a><span id="l30.298"> </span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-            aOperation.newItem = newItem;</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-            aOperation.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, cal.xml.serializeDOM(xmlEntry));</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-            session.asyncItemRequest(aOperation);</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-            return false;</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-        } else if (aOperation.status == kGOOGLE_CONFLICT_DELETED &amp;&amp;</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineminus">-                   aOperation.type == aOperation.DELETE) {</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineminus">-            // Deleted on the server and deleted locally. Great!</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-            return true;</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-        } else {</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-            // If a conflict occurred, then prompt</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-            let method = (aOperation.type == aOperation.DELETE ? &quot;delete&quot; : &quot;modify&quot;)</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineminus">-            let inputItem = aOperation.oldItem || aOperation.newItem;</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-            let overwrite = cal.promptOverwrite(method, inputItem);</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-            if (overwrite) {</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-                if (aOperation.status == kGOOGLE_CONFLICT_DELETED &amp;&amp;</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineminus">-                    aOperation.type == aOperation.MODIFY) {</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-                    // The item was deleted on the server, but modified locally.</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-                    // Add it again</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-                    aOperation.type = aOperation.ADD;</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-                    aOperation.uri = aOperation.calendar.fullUri.spec;</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-                    return false;</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-                } else if (aOperation.status == kGOOGLE_CONFLICT_MODIFY &amp;&amp;</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineminus">-                           aOperation.type == aOperation.MODIFY) {</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-                    // The item was modified in both places, repeat the current</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-                    // request with the edit uri of the updated event</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-                    aOperation.uri = getItemEditURI(aItem);</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">-                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">-                    return false;</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-                } else if (aOperation.status == kGOOGLE_CONFLICT_MODIFY &amp;&amp;</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">-                           aOperation.type == aOperation.DELETE) {</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-                    // Modified on the server, deleted locally. Just repeat the</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-                    // delete request with the updated edit uri.</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-                    aOperation.uri = getItemEditURI(aItem);</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-                    return false;</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-                }</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineplus">+    // If an exception was turned into an EXDATE, we need to clear its metadata</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineplus">+    if (aOldItem.recurrenceInfo &amp;&amp; aNewItem.recurrenceInfo) {</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+        let newExIds = new Set(aNewItem.recurrenceInfo.getExceptionIds({}).map(function(x) x.icalString));</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+        for each (let exId in aOldItem.recurrenceInfo.getExceptionIds({})) {</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+            if (!newExIds.has(exId.icalString)) {</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+                let ex = aOldItem.recurrenceInfo.getExceptionFor(exId);</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+                deleteItemMetadata(aOfflineStorage, ex);</span>
<a href="#l30.343"></a><span id="l30.343">             }</span>
<a href="#l30.344"></a><span id="l30.344">         }</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-        // Otherwise, we can just continue using the item that was parsed, it</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-        // is the newest version on the server.</span>
<a href="#l30.347"></a><span id="l30.347">     }</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-    return true;</span>
<a href="#l30.349"></a><span id="l30.349"> }</span>
<a href="#l30.350"></a><span id="l30.350"> </span>
<a href="#l30.351"></a><span id="l30.351"> /**</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">- * Helper function to convert raw data directly into a calIItemBase. If the</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">- * passed operation signals an error, then throw an exception</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineplus">+ * Delete metadata for the given item.</span>
<a href="#l30.355"></a><span id="l30.355">  *</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">- * @param aOperation        The operation to check for errors</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">- * @param aData             The result from the response</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineminus">- * @param aGoogleCalendar   The calIGoogleCalendar to operate on</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineminus">- * @param aReferenceItem    The reference item to apply the information to</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineminus">- * @return                  The parsed item</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineminus">- * @throws                  An exception on a parsing or request error</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineplus">+ * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineplus">+ * @param aItem             The item to delete metadata for.</span>
<a href="#l30.364"></a><span id="l30.364">  */</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineminus">-function DataToItem(aOperation, aData, aGoogleCalendar, aReferenceItem) {</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineminus">-    if (aOperation.status == kGOOGLE_CONFLICT_DELETED ||</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineminus">-        aOperation.status == kGOOGLE_CONFLICT_MODIFY ||</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineminus">-        Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-        let item;</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-        if (aData == &quot;SEQUENCE-HACK&quot;) {</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-            // Working around a Google issue here, see what happens on a 400</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-            // code in calGoogleRequest.js. This will be processed in</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-            // resolveConflicts().</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-            return &quot;SEQUENCE-HACK&quot;;</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+function deleteItemMetadata(aOfflineStorage, aItem) {</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineplus">+    aOfflineStorage.deleteMetaData(aItem.hashId);</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineplus">+    if (aItem.recurrenceInfo) {</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineplus">+        let recInfo = aItem.recurrenceInfo;</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineplus">+        for each (let exId in recInfo.getExceptionIds({})) {</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+            let occ = recInfo.getExceptionFor(exId);</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineplus">+            aOfflineStorage.deleteMetaData(occ.hashId);</span>
<a href="#l30.383"></a><span id="l30.383">         }</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineminus">-</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineminus">-        if (aData &amp;&amp; aData.length) {</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-            let xml = cal.xml.parseString(aData);</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + aData + &quot;\n&quot;);</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineminus">-</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineminus">-            // Get the local timezone from the preferences</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-            let timezone = calendarDefaultTimezone();</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-            // Parse the Item with the given timezone</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-            item = XMLEntryToItem(xml.documentElement, timezone,</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-                                  aGoogleCalendar,</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineminus">-                                  aReferenceItem);</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-        } else {</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineminus">-            cal.LOG(&quot;[calGoogleCalendar] No content, using reference item instead &quot;);</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineminus">-            // No data happens for example on delete. Just assume the reference</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-            // item.</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineminus">-            item = aReferenceItem.clone();</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineminus">-        }</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineminus">-</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-        LOGitem(item);</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineminus">-        item.calendar = aGoogleCalendar.superCalendar;</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineminus">-        return item;</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineminus">-    } else {</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-        throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l30.408"></a><span id="l30.408">     }</span>
<a href="#l30.409"></a><span id="l30.409"> }</span>
<a href="#l30.410"></a><span id="l30.410"> </span>
<a href="#l30.411"></a><span id="l30.411"> /**</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">- * ItemToXMLEntry</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">- * Converts a calIEvent to a string of xml data.</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineplus">+ * Retrieve the item metadata for the given item</span>
<a href="#l30.415"></a><span id="l30.415">  *</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">- * @param aItem         The item to convert</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineminus">- * @param aCalendar     The calendar to use, this must be a calIGoogleCalendar</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineminus">- * @param aAuthorEmail  The email of the author of the event</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineminus">- * @param aAuthorName   The full name of the author of the event</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineminus">- * @return              The xml data of the item</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineplus">+ * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineplus">+ * @param aItem             The item to retrieve metadat for.</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineplus">+ */</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineplus">+function getItemMetadata(aOfflineStorage, aItem) {</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineplus">+    let data = null;</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineplus">+    let meta = aOfflineStorage.getMetaData(aItem.hashId);</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineplus">+    let parts = meta &amp;&amp; meta.split(&quot;\u001A&quot;);</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineplus">+    if (parts &amp;&amp; parts.length == 3) {</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineplus">+        data = { etag: parts[0], path: parts[1] };</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineplus">+    } else if (parts &amp;&amp; parts.length == 1) {</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineplus">+        // Temporary migration for alpha versions of this provider.</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+        data = { etag: parts[0], path: aItem.getProperty(&quot;X-GOOGLE-ID&quot;) }</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineplus">+    }</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineplus">+    return data;</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+}</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineplus">+</span>
<a href="#l30.437"></a><span id="l30.437" class="difflineplus">+/**</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineplus">+ * Covnvert a calIDateTime date to the JSON object expected by Google.</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineplus">+ *</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineplus">+ * @param aDate     The date to convert.</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineplus">+ * @return          The converted JS Object.</span>
<a href="#l30.442"></a><span id="l30.442">  */</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineminus">-function ItemToXMLEntry(aItem, aCalendar, aAuthorEmail, aAuthorName) {</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineminus">-    let selfIsOrganizer = (!aItem.organizer ||</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineminus">-                            aItem.organizer.id == &quot;mailto:&quot; + aCalendar.googleCalendarName);</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineplus">+function dateToJSON(aDate) {</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineplus">+    let jsonData = {};</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineplus">+    let tzid = aDate.timezone.tzid;</span>
<a href="#l30.449"></a><span id="l30.449" class="difflineplus">+    jsonData[aDate.isDate ? &quot;date&quot; : &quot;dateTime&quot;] = cal.toRFC3339(aDate);</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineplus">+    if (!aDate.isDate &amp;&amp; tzid != &quot;floating&quot;) {</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineplus">+        if (tzid in windowsTimezoneMap) {</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+            // A Windows timezone, likely an outlook invitation.</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineplus">+            jsonData.timeZone = windowsTimezoneMap[tzid];</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineplus">+        } else if (tzid.match(/^[^\/ ]+\/[^\/ ]+$/)) {</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineplus">+            // An Olson timezone id</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineplus">+            jsonData.timeZone = aDate.timezone.tzid;</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineplus">+        } else {</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineplus">+            // Uhh...something. Google requires a timezone id for recurring</span>
<a href="#l30.459"></a><span id="l30.459" class="difflineplus">+            // events, we can fake it with Etc/ timezones.</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineplus">+            let full_tzoffset = aDate.timezoneOffset;</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineplus">+            let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineplus">+            let sign = (full_tzoffset &lt; 0 ? &quot;-&quot; : &quot;+&quot;);</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+            if (tzoffset_hr == 0) {</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineplus">+                jsonData.timezone = &quot;UTC&quot;;</span>
<a href="#l30.465"></a><span id="l30.465" class="difflineplus">+            } else {</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineplus">+                jsonData.timeZone = &quot;Etc/GMT&quot; + sign + tzoffset_hr;</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineplus">+            }</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineplus">+        }</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineplus">+    }</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineplus">+    return jsonData;</span>
<a href="#l30.471"></a><span id="l30.471" class="difflineplus">+}</span>
<a href="#l30.472"></a><span id="l30.472"> </span>
<a href="#l30.473"></a><span id="l30.473" class="difflineminus">-    function addExtendedProperty(aName, aValue) {</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-        if (!selfIsOrganizer || !aValue) {</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-            // We can't set extended properties if we are not the organizer,</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-            // discard. Also, if the value is null/false, we can delete the</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineminus">-            // extended property by not adding it.</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineplus">+/**</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineplus">+ * Convert a JSON date object as received by Google into a calIDateTime.</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineplus">+ *</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineplus">+ * @param aEntry                The JSON entry to convert.</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineplus">+ * @param aDefaultTimezone      The timezone to use if not contained aEntry.</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineplus">+ * @return                      The converted calIDateTime.</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineplus">+ */</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineplus">+function JSONToDate(aEntry, aDefaultTimezone) {</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineplus">+    if (aEntry) {</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineplus">+        let tzs = cal.getTimezoneService();</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineplus">+        let timezone = (&quot;timeZone&quot; in aEntry &amp;&amp; tzs.getTimezone(aEntry.timeZone)) || aDefaultTimezone;</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineplus">+        return cal.fromRFC3339(aEntry.dateTime || aEntry.date, timezone);</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineplus">+    } else {</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineplus">+        return null;</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineplus">+    }</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineplus">+}</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineplus">+</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineplus">+/**</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineplus">+ * Like cal.toRFC3339, but include milliseconds. Google timestamps require</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineplus">+ * this.</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineplus">+ *</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineplus">+ * @param dt        The calIDateTime to convert.</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineplus">+ * @return          The RFC3339 string stamp.</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineplus">+ */</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineplus">+function toRFC3339Fraction(dt) {</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineplus">+    let str = cal.toRFC3339(dt);</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineplus">+    return str ? str.replace(/(Z?)$/, &quot;.000$1&quot;) : null;</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineplus">+}</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineplus">+</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineplus">+/**</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineplus">+ * Converts a calIEvent to a JS Object that can be serialized to JSON.</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+ *</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+ * @param aItem         The item to convert.</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineplus">+ * @return              A JS Object representing the item.</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineplus">+ */</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineplus">+function EventToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l30.514"></a><span id="l30.514" class="difflineplus">+    function addExtendedProperty(aName, aValue, aPrivate) {</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineplus">+        if (!aValue) {</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineplus">+            // We unset an extended prop by not adding it</span>
<a href="#l30.517"></a><span id="l30.517">             return;</span>
<a href="#l30.518"></a><span id="l30.518">         }</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineminus">-        let gdExtendedProp = document.createElementNS(gdNS, &quot;extendedProperty&quot;);</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineminus">-        gdExtendedProp.setAttribute(&quot;name&quot;, aName);</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineminus">-        gdExtendedProp.setAttribute(&quot;value&quot;, aValue || &quot;&quot;);</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineminus">-        entry.appendChild(gdExtendedProp);</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineplus">+</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+        if (!(&quot;extendedProperties&quot; in itemData)) {</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineplus">+            itemData.extendedProperties = {};</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineplus">+        }</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineplus">+        if (aPrivate) {</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineplus">+            if (!(&quot;private&quot; in itemData.extendedProperties)) {</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+                itemData.extendedProperties.private = {};</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineplus">+            }</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineplus">+            itemData.extendedProperties.private[aName] = aValue;</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineplus">+        } else {</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineplus">+            if (!(&quot;shared&quot; in itemData.extendedProperties)) {</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineplus">+                itemData.extendedProperties.shared = {};</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineplus">+            }</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineplus">+            itemData.extendedProperties.shared[aName] = aValue;</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineplus">+        }</span>
<a href="#l30.538"></a><span id="l30.538">     }</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineminus">-</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineminus">-    if (!aItem) {</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineplus">+    function setIf(data, prop, value) {</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineplus">+        if (value) data[prop] = value;</span>
<a href="#l30.544"></a><span id="l30.544">     }</span>
<a href="#l30.545"></a><span id="l30.545"> </span>
<a href="#l30.546"></a><span id="l30.546" class="difflineminus">-    const kEVENT_SCHEMA = &quot;http://schemas.google.com/g/2005#event.&quot;;</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+    let itemData = {};</span>
<a href="#l30.548"></a><span id="l30.548"> </span>
<a href="#l30.549"></a><span id="l30.549" class="difflineminus">-    // Document creation</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineminus">-    let document = cal.xml.parseString('&lt;entry xmlns=&quot;' + atomNS + '&quot; xmlns:gd=&quot;' + gdNS + '&quot; xmlns:gCal=&quot;' + gcalNS + '&quot;/&gt;');</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-    let entry = document.documentElement;</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineplus">+    itemData.start = dateToJSON(aItem.startDate);</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineplus">+    itemData.end = dateToJSON(aItem.endDate);</span>
<a href="#l30.554"></a><span id="l30.554"> </span>
<a href="#l30.555"></a><span id="l30.555" class="difflineminus">-    // Helper functions</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineminus">-    function elemNS(ns, name) document.createElementNS(ns, name);</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineminus">-    function addElemNS(ns, name, parent) (parent || entry).appendChild(elemNS(ns, name));</span>
<a href="#l30.558"></a><span id="l30.558" class="difflineminus">-</span>
<a href="#l30.559"></a><span id="l30.559" class="difflineminus">-    // Basic elements</span>
<a href="#l30.560"></a><span id="l30.560" class="difflineminus">-    let kindElement = addElemNS(atomNS, &quot;category&quot;);</span>
<a href="#l30.561"></a><span id="l30.561" class="difflineminus">-    kindElement.setAttribute(&quot;scheme&quot;, &quot;http://schemas.google.com/g/2005#kind&quot;);</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-    kindElement.setAttribute(&quot;term&quot;, &quot;http://schemas.google.com/g/2005#event&quot;);</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineminus">-</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-    let titleElement = addElemNS(atomNS, &quot;title&quot;);</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineminus">-    titleElement.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-    titleElement.textContent = aItem.title;</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineplus">+    if (aIsImport &amp;&amp; aItem.id) {</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineplus">+        itemData.iCalUID = aItem.id;</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineplus">+        setIf(itemData, &quot;created&quot;, toRFC3339Fraction(aItem.creationDate));</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineplus">+        setIf(itemData, &quot;updated&quot;, toRFC3339Fraction(aItem.lastModifiedTime));</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineplus">+    }</span>
<a href="#l30.572"></a><span id="l30.572"> </span>
<a href="#l30.573"></a><span id="l30.573" class="difflineminus">-    // atom:content</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineminus">-    let contentElement = addElemNS(atomNS, &quot;content&quot;);</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineminus">-    contentElement.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineminus">-    contentElement.textContent = aItem.getProperty(&quot;DESCRIPTION&quot;) || &quot;&quot;;</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineplus">+    setIf(itemData, &quot;summary&quot;, aItem.title);</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineplus">+    setIf(itemData, &quot;description&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineplus">+    setIf(itemData, &quot;location&quot;, aItem.getProperty(&quot;LOCATION&quot;));</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineplus">+    setIf(itemData, &quot;transparency&quot;, aItem.getProperty(&quot;TRANSP&quot;) &amp;&amp; aItem.getProperty(&quot;TRANSP&quot;).toLowerCase());</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+    setIf(itemData, &quot;visibility&quot;, aItem.privacy &amp;&amp; aItem.privacy.toLowerCase());</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineplus">+    setIf(itemData, &quot;sequence&quot;, aItem.getProperty(&quot;SEQUENCE&quot;));</span>
<a href="#l30.583"></a><span id="l30.583"> </span>
<a href="#l30.584"></a><span id="l30.584" class="difflineminus">-    // atom:author</span>
<a href="#l30.585"></a><span id="l30.585" class="difflineminus">-    let authorElement = addElemNS(atomNS, &quot;author&quot;);</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineminus">-    addElemNS(atomNS, &quot;name&quot;, authorElement).textContent = aAuthorName || aAuthorEmail;</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineminus">-    addElemNS(atomNS, &quot;email&quot;, authorElement).textContent = aAuthorEmail;</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineminus">-</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineminus">-    // gd:transparency</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineminus">-    let transpElement = addElemNS(gdNS, &quot;transparency&quot;);</span>
<a href="#l30.591"></a><span id="l30.591" class="difflineminus">-    let transpValue = aItem.getProperty(&quot;TRANSP&quot;) || &quot;opaque&quot;;</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineminus">-    transpElement.setAttribute(&quot;value&quot;, kEVENT_SCHEMA + transpValue.toLowerCase());</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineminus">-</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineminus">-    // gd:eventStatus</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineminus">-    let status = aItem.status || &quot;confirmed&quot;;</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineminus">-    if (status == &quot;CANCELLED&quot;) {</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineplus">+    // eventStatus</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineplus">+    let status = aItem.status &amp;&amp; aItem.status.toLowerCase();</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineplus">+    if (status == &quot;cancelled&quot;) {</span>
<a href="#l30.600"></a><span id="l30.600">         // If the status is canceled, then the event will be deleted. Since the</span>
<a href="#l30.601"></a><span id="l30.601">         // user didn't choose to delete the event, we will protect him and not</span>
<a href="#l30.602"></a><span id="l30.602">         // allow this status to be set</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineminus">-        throw new Components.Exception(&quot;&quot;,</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineplus">+        throw new Components.Exception(&quot;The status CANCELLED is reserved, delete the event instead!&quot;,</span>
<a href="#l30.605"></a><span id="l30.605">                                        Components.results.NS_ERROR_LOSS_OF_SIGNIFICANT_DATA);</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineminus">-    } else if (status == &quot;NONE&quot;) {</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-        status = &quot;CONFIRMED&quot;;</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineplus">+    } else if (status == &quot;none&quot;) {</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineplus">+        status = null;</span>
<a href="#l30.610"></a><span id="l30.610">     }</span>
<a href="#l30.611"></a><span id="l30.611" class="difflineminus">-    addElemNS(gdNS, &quot;eventStatus&quot;).setAttribute(&quot;value&quot;, kEVENT_SCHEMA + status.toLowerCase());</span>
<a href="#l30.612"></a><span id="l30.612" class="difflineminus">-</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineminus">-    // gd:where</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineminus">-    addElemNS(gdNS, &quot;where&quot;).setAttribute(&quot;valueString&quot;, aItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;);</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineminus">-</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineminus">-    // gd:who</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineminus">-    if (Preferences.get(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineminus">-        // XXX Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineplus">+    setIf(itemData, &quot;status&quot;, status);</span>
<a href="#l30.620"></a><span id="l30.620"> </span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-        let attendees = aItem.getAttendees({});</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-        if (aItem.organizer) {</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-            // Taking care of the organizer is the same as taking care of any other</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-            // attendee. Add the organizer to the local attendees list.</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineminus">-            attendees.push(aItem.organizer);</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineminus">-        }</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineplus">+    // Google does not support categories natively, but allows us to store data</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineplus">+    // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineplus">+    let categories = cal.categoriesArrayToString(aItem.getCategories({}));</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineplus">+    addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;, categories);</span>
<a href="#l30.631"></a><span id="l30.631"> </span>
<a href="#l30.632"></a><span id="l30.632" class="difflineminus">-        const attendeeStatusMap = {</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-            &quot;REQ-PARTICIPANT&quot;: &quot;required&quot;,</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineminus">-            &quot;OPT-PARTICIPANT&quot;: &quot;optional&quot;,</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineminus">-            &quot;NON-PARTICIPANT&quot;: null,</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineminus">-            &quot;CHAIR&quot;: null,</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineminus">-</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineminus">-            &quot;NEEDS-ACTION&quot;: &quot;invited&quot;,</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-            &quot;ACCEPTED&quot;: &quot;accepted&quot;,</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineplus">+    // Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineplus">+    if (Preferences.get(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineplus">+        const statusMap = {</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineplus">+            &quot;NEEDS-ACTION&quot;: &quot;needsAction&quot;,</span>
<a href="#l30.644"></a><span id="l30.644">             &quot;DECLINED&quot;: &quot;declined&quot;,</span>
<a href="#l30.645"></a><span id="l30.645">             &quot;TENTATIVE&quot;: &quot;tentative&quot;,</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineminus">-            &quot;DELEGATED&quot;: &quot;tentative&quot;</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineplus">+            &quot;ACCEPTED&quot;: &quot;accepted&quot;</span>
<a href="#l30.648"></a><span id="l30.648">         };</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineminus">-</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineminus">-        for each (let attendee in attendees) {</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-            if (attendee.userType &amp;&amp; attendee.userType != &quot;INDIVIDUAL&quot;) {</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-                // We can only take care of individuals.</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineminus">-                continue;</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineplus">+        function createAttendee(attendee) {</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineplus">+            let attendeeData = {};</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineplus">+            if (aItem.organizer.id == attendee.id) {</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineplus">+                needsOrganizer = false;</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineplus">+            }</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineplus">+            let lowerId = attendee.id.toLowerCase();</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineplus">+            if (lowerId.startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineplus">+                attendeeData.email = attendee.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineplus">+            } else if (lowerId.startsWith(&quot;urn:id:&quot;)) {</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineplus">+                attendeeData.id = attendee.id.replace(/^urn:id:/i, &quot;&quot;);</span>
<a href="#l30.664"></a><span id="l30.664">             }</span>
<a href="#l30.665"></a><span id="l30.665"> </span>
<a href="#l30.666"></a><span id="l30.666" class="difflineminus">-            let xmlAttendee = addElemNS(gdNS, &quot;who&quot;);</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineminus">-</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-            // Strip &quot;mailto:&quot; part</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineminus">-            xmlAttendee.setAttribute(&quot;email&quot;, attendee.id.replace(/^mailto:/, &quot;&quot;));</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineminus">-</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineminus">-            if (attendee.isOrganizer) {</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineminus">-                xmlAttendee.setAttribute(&quot;rel&quot;, kEVENT_SCHEMA + &quot;organizer&quot;);</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-            } else {</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineminus">-                xmlAttendee.setAttribute(&quot;rel&quot;, kEVENT_SCHEMA + &quot;attendee&quot;);</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineminus">-            }</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineplus">+            setIf(attendeeData, &quot;displayName&quot;, attendee.commonName);</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineplus">+            setIf(attendeeData, &quot;optional&quot;, attendee.role &amp;&amp; attendee.role != &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineplus">+            setIf(attendeeData, &quot;responseStatus&quot;, statusMap[attendee.participationStatus]);</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineplus">+            setIf(attendeeData, &quot;comment&quot;, attendee.getProperty(&quot;COMMENT&quot;));</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineplus">+            setIf(attendeeData, &quot;resource&quot;, attendee.userType &amp;&amp; attendee.userType != &quot;INDIVIDUAL&quot;);</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineplus">+            setIf(attendeeData, &quot;additionalGuests&quot;, attendee.getProperty(&quot;X-NUM-GUESTS&quot;));</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineplus">+            return attendeeData;</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineplus">+        }</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineplus">+        let needsOrganizer = true;</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineplus">+        let attendees = aItem.getAttendees({});</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineplus">+        let attendeeData = [ createAttendee(a) for each (a in attendees) ];</span>
<a href="#l30.687"></a><span id="l30.687"> </span>
<a href="#l30.688"></a><span id="l30.688" class="difflineminus">-            if (attendee.commonName) {</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineminus">-                xmlAttendee.setAttribute(&quot;valueString&quot;, attendee.commonName);</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-            }</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineminus">-</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineminus">-            if (attendeeStatusMap[attendee.role]) {</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineminus">-                let attendeeTypeElement = addElemNS(gdNS, &quot;attendeeType&quot;, xmlAttendee);</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineminus">-                let attendeeTypeValue = kEVENT_SCHEMA + attendeeStatusMap[attendee.role];</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-                attendeeTypeElement.setAttribute(&quot;value&quot;, attendeeTypeValue);</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineminus">-            }</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineminus">-</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineminus">-            if (attendeeStatusMap[attendee.participationStatus]) {</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineminus">-                let attendeeStatusElement = addElemNS(gdNS, &quot;attendeeStatus&quot;, xmlAttendee);</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineminus">-                let attendeeStatusValue = kEVENT_SCHEMA + attendeeStatusMap[attendee.participationStatus];</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineminus">-                attendeeStatusElement.setAttribute(&quot;value&quot;, attendeeStatusValue);</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineplus">+        if (aItem.organizer) {</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineplus">+            itemData.organizer = createAttendee(aItem.organizer);</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineplus">+            if (needsOrganizer) {</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineplus">+                attendeeData.push(itemData.organizer);</span>
<a href="#l30.706"></a><span id="l30.706">             }</span>
<a href="#l30.707"></a><span id="l30.707">         }</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineplus">+</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineplus">+        if (attendeeData.length) itemData.attendees = attendeeData;</span>
<a href="#l30.710"></a><span id="l30.710">     }</span>
<a href="#l30.711"></a><span id="l30.711"> </span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">-    // Don't notify attendees by default. Use a preference in case the user</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineminus">-    // wants this to be turned on.</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineminus">-    let notify = Preferences.get(&quot;calendar.google.sendEventNotifications&quot;, false);</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineminus">-    addElemNS(gcalNS, &quot;sendEventNotifications&quot;).setAttribute(&quot;value&quot;, notify ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineminus">-</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineminus">-    // gd:when</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineminus">-    let duration = aItem.endDate.subtractDate(aItem.startDate);</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineminus">-    let whenElement;</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineminus">-    if (!aItem.recurrenceInfo) {</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineminus">-        // gd:when isn't allowed for recurring items where gd:recurrence is set</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineminus">-        whenElement = addElemNS(gdNS, &quot;when&quot;);</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineminus">-        whenElement.setAttribute(&quot;startTime&quot;, cal.toRFC3339(aItem.startDate));</span>
<a href="#l30.724"></a><span id="l30.724" class="difflineminus">-        whenElement.setAttribute(&quot;endTime&quot;, cal.toRFC3339(aItem.endDate));</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-    }</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineminus">-</span>
<a href="#l30.727"></a><span id="l30.727" class="difflineminus">-    // gd:reminder</span>
<a href="#l30.728"></a><span id="l30.728" class="difflineplus">+    // reminder</span>
<a href="#l30.729"></a><span id="l30.729">     let alarms = aItem.getAlarms({});</span>
<a href="#l30.730"></a><span id="l30.730">     let actionMap = {</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineminus">-        DISPLAY: &quot;alert&quot;,</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineplus">+        DISPLAY: &quot;popup&quot;,</span>
<a href="#l30.733"></a><span id="l30.733">         EMAIL: &quot;email&quot;,</span>
<a href="#l30.734"></a><span id="l30.734">         SMS: &quot;sms&quot;</span>
<a href="#l30.735"></a><span id="l30.735">     };</span>
<a href="#l30.736"></a><span id="l30.736" class="difflineminus">-    if (selfIsOrganizer) {</span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-        for (let i = 0; i &lt; 5 &amp;&amp; i &lt; alarms.length; i++) {</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineminus">-            let alarm = alarms[i];</span>
<a href="#l30.739"></a><span id="l30.739" class="difflineminus">-            let gdReminder;</span>
<a href="#l30.740"></a><span id="l30.740" class="difflineminus">-            if (aItem.recurrenceInfo) {</span>
<a href="#l30.741"></a><span id="l30.741" class="difflineminus">-                // On recurring items, set the reminder directly in the &lt;entry&gt; tag.</span>
<a href="#l30.742"></a><span id="l30.742" class="difflineminus">-                gdReminder = addElemNS(gdNS, &quot;reminder&quot;);</span>
<a href="#l30.743"></a><span id="l30.743" class="difflineplus">+</span>
<a href="#l30.744"></a><span id="l30.744" class="difflineplus">+    itemData.reminders = { overrides: [], useDefault: false };</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineplus">+    for (let i = 0; i &lt; 5 &amp;&amp; i &lt; alarms.length; i++) {</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineplus">+        let alarm = alarms[i];</span>
<a href="#l30.747"></a><span id="l30.747" class="difflineplus">+        let alarmOffset;</span>
<a href="#l30.748"></a><span id="l30.748" class="difflineplus">+        let alarmData = {};</span>
<a href="#l30.749"></a><span id="l30.749" class="difflineplus">+</span>
<a href="#l30.750"></a><span id="l30.750" class="difflineplus">+        if (alarm.getProperty(&quot;X-DEFAULT-ALARM&quot;)) {</span>
<a href="#l30.751"></a><span id="l30.751" class="difflineplus">+            // This is a default alarm, it shouldn't be set as an override</span>
<a href="#l30.752"></a><span id="l30.752" class="difflineplus">+            itemData.reminders.useDefault = true;</span>
<a href="#l30.753"></a><span id="l30.753" class="difflineplus">+            continue;</span>
<a href="#l30.754"></a><span id="l30.754" class="difflineplus">+        }</span>
<a href="#l30.755"></a><span id="l30.755" class="difflineplus">+</span>
<a href="#l30.756"></a><span id="l30.756" class="difflineplus">+        alarmData.method = actionMap[alarm.action] || &quot;popup&quot;;</span>
<a href="#l30.757"></a><span id="l30.757" class="difflineplus">+</span>
<a href="#l30.758"></a><span id="l30.758" class="difflineplus">+        if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l30.759"></a><span id="l30.759" class="difflineplus">+            alarmOffset = aItem.startDate.subtractDate(alarm.alarmDate);</span>
<a href="#l30.760"></a><span id="l30.760" class="difflineplus">+        } else {</span>
<a href="#l30.761"></a><span id="l30.761" class="difflineplus">+            if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l30.762"></a><span id="l30.762" class="difflineplus">+                // Google always uses an alarm offset related to the start time</span>
<a href="#l30.763"></a><span id="l30.763" class="difflineplus">+                // for relative alarms.</span>
<a href="#l30.764"></a><span id="l30.764" class="difflineplus">+                alarmOffset = alarm.alarmOffset.clone();</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineplus">+                alarmOffset.addDuration(aItem.endDate.subtractDate(aItem.startDate));</span>
<a href="#l30.766"></a><span id="l30.766">             } else {</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineminus">-                // Otherwise, its a child of the gd:when element</span>
<a href="#l30.768"></a><span id="l30.768" class="difflineminus">-                gdReminder = addElemNS(gdNS, &quot;reminder&quot;, whenElement);</span>
<a href="#l30.769"></a><span id="l30.769" class="difflineminus">-            }</span>
<a href="#l30.770"></a><span id="l30.770" class="difflineminus">-            if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l30.771"></a><span id="l30.771" class="difflineminus">-                // Setting an absolute date can be done directly. Google will take</span>
<a href="#l30.772"></a><span id="l30.772" class="difflineminus">-                // care of calculating the offset.</span>
<a href="#l30.773"></a><span id="l30.773" class="difflineminus">-                gdReminder.setAttribute(&quot;absoluteTime&quot;, cal.toRFC3339(alarm.alarmDate));</span>
<a href="#l30.774"></a><span id="l30.774" class="difflineminus">-            } else {</span>
<a href="#l30.775"></a><span id="l30.775" class="difflineminus">-                let alarmOffset = alarm.offset;</span>
<a href="#l30.776"></a><span id="l30.776" class="difflineminus">-                if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l30.777"></a><span id="l30.777" class="difflineminus">-                    // Google always uses an alarm offset related to the start time</span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-                    // for relative alarms.</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-                    alarmOffset = alarmOffset.clone();</span>
<a href="#l30.780"></a><span id="l30.780" class="difflineminus">-                    alarmOffset.addDuration(duration);</span>
<a href="#l30.781"></a><span id="l30.781" class="difflineminus">-                }</span>
<a href="#l30.782"></a><span id="l30.782" class="difflineminus">-</span>
<a href="#l30.783"></a><span id="l30.783" class="difflineminus">-                gdReminder.setAttribute(&quot;minutes&quot;, -alarmOffset.inSeconds / 60);</span>
<a href="#l30.784"></a><span id="l30.784" class="difflineminus">-                gdReminder.setAttribute(&quot;method&quot;, actionMap[alarm.action] || &quot;alert&quot;);</span>
<a href="#l30.785"></a><span id="l30.785" class="difflineplus">+                alarmOffset = alarm.offset;</span>
<a href="#l30.786"></a><span id="l30.786">             }</span>
<a href="#l30.787"></a><span id="l30.787">         }</span>
<a href="#l30.788"></a><span id="l30.788" class="difflineminus">-    } else if (alarms.length) {</span>
<a href="#l30.789"></a><span id="l30.789" class="difflineminus">-        // We need to reset this so the item gets returned correctly.</span>
<a href="#l30.790"></a><span id="l30.790" class="difflineminus">-        aItem.clearAlarms();</span>
<a href="#l30.791"></a><span id="l30.791" class="difflineplus">+        alarmData.minutes = -alarmOffset.inSeconds / 60;</span>
<a href="#l30.792"></a><span id="l30.792" class="difflineplus">+</span>
<a href="#l30.793"></a><span id="l30.793" class="difflineplus">+        // Google doesn't allow alarms after the event starts, or more than 4</span>
<a href="#l30.794"></a><span id="l30.794" class="difflineplus">+        // weeks before the event. Make sure the minutes are within range.</span>
<a href="#l30.795"></a><span id="l30.795" class="difflineplus">+        alarmData.minutes = Math.min(Math.max(0, alarmData.minutes), FOUR_WEEKS_IN_MINUTES);</span>
<a href="#l30.796"></a><span id="l30.796" class="difflineplus">+</span>
<a href="#l30.797"></a><span id="l30.797" class="difflineplus">+        itemData.reminders.overrides.push(alarmData);</span>
<a href="#l30.798"></a><span id="l30.798">     }</span>
<a href="#l30.799"></a><span id="l30.799"> </span>
<a href="#l30.800"></a><span id="l30.800">     // gd:extendedProperty (alarmLastAck)</span>
<a href="#l30.801"></a><span id="l30.801" class="difflineminus">-    addExtendedProperty(&quot;X-MOZ-LASTACK&quot;, cal.toRFC3339(aItem.alarmLastAck));</span>
<a href="#l30.802"></a><span id="l30.802" class="difflineplus">+    addExtendedProperty(&quot;X-MOZ-LASTACK&quot;, cal.toRFC3339(aItem.alarmLastAck), true);</span>
<a href="#l30.803"></a><span id="l30.803"> </span>
<a href="#l30.804"></a><span id="l30.804">     // XXX While Google now supports multiple alarms and alarm values, we still</span>
<a href="#l30.805"></a><span id="l30.805">     // need to fix bug 353492 first so we can better take care of finding out</span>
<a href="#l30.806"></a><span id="l30.806">     // what alarm is used for snoozing.</span>
<a href="#l30.807"></a><span id="l30.807"> </span>
<a href="#l30.808"></a><span id="l30.808">     // gd:extendedProperty (snooze time)</span>
<a href="#l30.809"></a><span id="l30.809">     let itemSnoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l30.810"></a><span id="l30.810">     let icalSnoozeTime = null;</span>
<a href="#l30.811"></a><span id="l30.811">     if (itemSnoozeTime) {</span>
<a href="#l30.812"></a><span id="l30.812">         // The propery is saved as a string, translate back to calIDateTime.</span>
<a href="#l30.813"></a><span id="l30.813">         icalSnoozeTime = cal.createDateTime();</span>
<a href="#l30.814"></a><span id="l30.814">         icalSnoozeTime.icalString = itemSnoozeTime;</span>
<a href="#l30.815"></a><span id="l30.815">     }</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineminus">-    addExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, cal.toRFC3339(icalSnoozeTime));</span>
<a href="#l30.817"></a><span id="l30.817" class="difflineplus">+    addExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, cal.toRFC3339(icalSnoozeTime), true);</span>
<a href="#l30.818"></a><span id="l30.818"> </span>
<a href="#l30.819"></a><span id="l30.819">     // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l30.820"></a><span id="l30.820">     let snoozeValue = &quot;&quot;;</span>
<a href="#l30.821"></a><span id="l30.821">     if (aItem.recurrenceInfo) {</span>
<a href="#l30.822"></a><span id="l30.822">         // This is an evil workaround since we don't have a really good system</span>
<a href="#l30.823"></a><span id="l30.823">         // to save the snooze time for recurring alarms or even retrieve them</span>
<a href="#l30.824"></a><span id="l30.824">         // from the event. This should change when we have multiple alarms</span>
<a href="#l30.825"></a><span id="l30.825">         // support.</span>
<a href="#l30.826"></a><span id="l30.826" class="difflineat">@@ -546,767 +375,976 @@ function ItemToXMLEntry(aItem, aCalendar</span>
<a href="#l30.827"></a><span id="l30.827">         let enumerator = aItem.propertyEnumerator;</span>
<a href="#l30.828"></a><span id="l30.828">         while (enumerator.hasMoreElements()) {</span>
<a href="#l30.829"></a><span id="l30.829">             let prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l30.830"></a><span id="l30.830">             if (prop.name.substr(0, 18) == &quot;X-MOZ-SNOOZE-TIME-&quot;) {</span>
<a href="#l30.831"></a><span id="l30.831">                 // We have a snooze time for a recurring event, add it to our object</span>
<a href="#l30.832"></a><span id="l30.832">                 snoozeObj[prop.name.substr(18)] = prop.value;</span>
<a href="#l30.833"></a><span id="l30.833">             }</span>
<a href="#l30.834"></a><span id="l30.834">         }</span>
<a href="#l30.835"></a><span id="l30.835" class="difflineminus">-        snoozeValue = JSON.stringify(snoozeObj);</span>
<a href="#l30.836"></a><span id="l30.836" class="difflineplus">+        if (Object.keys(snoozeObj).length &gt; 0) {</span>
<a href="#l30.837"></a><span id="l30.837" class="difflineplus">+            snoozeValue = JSON.stringify(snoozeObj);</span>
<a href="#l30.838"></a><span id="l30.838" class="difflineplus">+        }</span>
<a href="#l30.839"></a><span id="l30.839">     }</span>
<a href="#l30.840"></a><span id="l30.840">     // Now save the snooze object in source format as an extended property. Do</span>
<a href="#l30.841"></a><span id="l30.841">     // so always, since its currently impossible to unset extended properties.</span>
<a href="#l30.842"></a><span id="l30.842" class="difflineminus">-    addExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;, snoozeValue);</span>
<a href="#l30.843"></a><span id="l30.843" class="difflineminus">-</span>
<a href="#l30.844"></a><span id="l30.844" class="difflineminus">-    // gd:visibility</span>
<a href="#l30.845"></a><span id="l30.845" class="difflineminus">-    let privacy = aItem.privacy || &quot;default&quot;;</span>
<a href="#l30.846"></a><span id="l30.846" class="difflineminus">-    addElemNS(gdNS, &quot;visibility&quot;).setAttribute(&quot;value&quot;, kEVENT_SCHEMA + privacy.toLowerCase());</span>
<a href="#l30.847"></a><span id="l30.847" class="difflineplus">+    addExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;, snoozeValue, true);</span>
<a href="#l30.848"></a><span id="l30.848"> </span>
<a href="#l30.849"></a><span id="l30.849" class="difflineminus">-    // categories</span>
<a href="#l30.850"></a><span id="l30.850" class="difflineminus">-    // Google does not support categories natively, but allows us to store data</span>
<a href="#l30.851"></a><span id="l30.851" class="difflineminus">-    // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l30.852"></a><span id="l30.852" class="difflineminus">-    addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;,</span>
<a href="#l30.853"></a><span id="l30.853" class="difflineminus">-                        categoriesArrayToString(aItem.getCategories({})));</span>
<a href="#l30.854"></a><span id="l30.854" class="difflineplus">+    // recurrence information</span>
<a href="#l30.855"></a><span id="l30.855" class="difflineplus">+    if (aItem.recurrenceInfo) {</span>
<a href="#l30.856"></a><span id="l30.856" class="difflineplus">+        itemData.recurrence = [];</span>
<a href="#l30.857"></a><span id="l30.857" class="difflineplus">+        let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineplus">+        for each (let ritem in recurrenceItems) {</span>
<a href="#l30.859"></a><span id="l30.859" class="difflineplus">+            let prop = ritem.icalProperty;</span>
<a href="#l30.860"></a><span id="l30.860" class="difflineplus">+            if (ritem instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l30.861"></a><span id="l30.861" class="difflineplus">+                // EXDATES require special casing, since they might contain</span>
<a href="#l30.862"></a><span id="l30.862" class="difflineplus">+                // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l30.863"></a><span id="l30.863" class="difflineplus">+                // convert to UTC before serialization.</span>
<a href="#l30.864"></a><span id="l30.864" class="difflineplus">+                prop.valueAsDatetime = ritem.date.getInTimezone(cal.UTC());</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineplus">+            }</span>
<a href="#l30.866"></a><span id="l30.866" class="difflineplus">+            itemData.recurrence.push(prop.icalString.trim());</span>
<a href="#l30.867"></a><span id="l30.867" class="difflineplus">+        }</span>
<a href="#l30.868"></a><span id="l30.868" class="difflineplus">+    } else if (aItem.recurrenceId) {</span>
<a href="#l30.869"></a><span id="l30.869" class="difflineplus">+        itemData.originalStartTime = dateToJSON(aItem.recurrenceId);</span>
<a href="#l30.870"></a><span id="l30.870" class="difflineplus">+        let parentMeta = getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l30.871"></a><span id="l30.871" class="difflineplus">+        itemData.recurringEventId = parentMeta ? parentMeta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l30.872"></a><span id="l30.872" class="difflineplus">+    }</span>
<a href="#l30.873"></a><span id="l30.873"> </span>
<a href="#l30.874"></a><span id="l30.874" class="difflineminus">-    // gd:recurrence</span>
<a href="#l30.875"></a><span id="l30.875" class="difflineminus">-    if (aItem.recurrenceInfo) {</span>
<a href="#l30.876"></a><span id="l30.876" class="difflineminus">-        try {</span>
<a href="#l30.877"></a><span id="l30.877" class="difflineminus">-            const kNEWLINE = &quot;\r\n&quot;;</span>
<a href="#l30.878"></a><span id="l30.878" class="difflineminus">-            let icalString;</span>
<a href="#l30.879"></a><span id="l30.879" class="difflineminus">-            let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l30.880"></a><span id="l30.880" class="difflineplus">+    return itemData;</span>
<a href="#l30.881"></a><span id="l30.881" class="difflineplus">+}</span>
<a href="#l30.882"></a><span id="l30.882"> </span>
<a href="#l30.883"></a><span id="l30.883" class="difflineminus">-            // Dates of the master event</span>
<a href="#l30.884"></a><span id="l30.884" class="difflineminus">-            let startTZID = aItem.startDate.timezone.tzid;</span>
<a href="#l30.885"></a><span id="l30.885" class="difflineminus">-            let endTZID = aItem.endDate.timezone.tzid;</span>
<a href="#l30.886"></a><span id="l30.886" class="difflineminus">-            icalString = &quot;DTSTART;TZID=&quot; + startTZID</span>
<a href="#l30.887"></a><span id="l30.887" class="difflineminus">-                         + &quot;:&quot; + aItem.startDate.icalString + kNEWLINE</span>
<a href="#l30.888"></a><span id="l30.888" class="difflineminus">-                         + &quot;DTEND;TZID=&quot; + endTZID</span>
<a href="#l30.889"></a><span id="l30.889" class="difflineminus">-                         + &quot;:&quot;  + aItem.endDate.icalString + kNEWLINE;</span>
<a href="#l30.890"></a><span id="l30.890" class="difflineplus">+/**</span>
<a href="#l30.891"></a><span id="l30.891" class="difflineplus">+ * Converts a calITodo to a JS Object that can be serialized to JSON.</span>
<a href="#l30.892"></a><span id="l30.892" class="difflineplus">+ *</span>
<a href="#l30.893"></a><span id="l30.893" class="difflineplus">+ * @param aItem         The item to convert.</span>
<a href="#l30.894"></a><span id="l30.894" class="difflineplus">+ * @return              A JS Object representing the item.</span>
<a href="#l30.895"></a><span id="l30.895" class="difflineplus">+ */</span>
<a href="#l30.896"></a><span id="l30.896" class="difflineplus">+function TaskToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l30.897"></a><span id="l30.897" class="difflineplus">+    function setIf(data, prop, value) {</span>
<a href="#l30.898"></a><span id="l30.898" class="difflineplus">+        if (value) data[prop] = value;</span>
<a href="#l30.899"></a><span id="l30.899" class="difflineplus">+    }</span>
<a href="#l30.900"></a><span id="l30.900" class="difflineplus">+</span>
<a href="#l30.901"></a><span id="l30.901" class="difflineplus">+    let itemData = {};</span>
<a href="#l30.902"></a><span id="l30.902"> </span>
<a href="#l30.903"></a><span id="l30.903" class="difflineminus">-            // Add all recurrence items to the ical string</span>
<a href="#l30.904"></a><span id="l30.904" class="difflineminus">-            for each (let ritem in recurrenceItems) {</span>
<a href="#l30.905"></a><span id="l30.905" class="difflineminus">-                let prop = ritem.icalProperty;</span>
<a href="#l30.906"></a><span id="l30.906" class="difflineminus">-                let wrappedRItem = cal.wrapInstance(wrappedRItem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l30.907"></a><span id="l30.907" class="difflineminus">-                if (wrappedRItem) {</span>
<a href="#l30.908"></a><span id="l30.908" class="difflineminus">-                    // EXDATES require special casing, since they might contain</span>
<a href="#l30.909"></a><span id="l30.909" class="difflineminus">-                    // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l30.910"></a><span id="l30.910" class="difflineminus">-                    // convert to UTC before serialization.</span>
<a href="#l30.911"></a><span id="l30.911" class="difflineminus">-                    prop.valueAsDatetime = wrappedRItem.date.getInTimezone(cal.UTC());</span>
<a href="#l30.912"></a><span id="l30.912" class="difflineminus">-                }</span>
<a href="#l30.913"></a><span id="l30.913" class="difflineminus">-                icalString += prop.icalString;</span>
<a href="#l30.914"></a><span id="l30.914" class="difflineminus">-            }</span>
<a href="#l30.915"></a><span id="l30.915" class="difflineplus">+    setIf(itemData, &quot;id&quot;, aItem.id);</span>
<a href="#l30.916"></a><span id="l30.916" class="difflineplus">+    setIf(itemData, &quot;title&quot;, aItem.title);</span>
<a href="#l30.917"></a><span id="l30.917" class="difflineplus">+    setIf(itemData, &quot;notes&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l30.918"></a><span id="l30.918" class="difflineplus">+    setIf(itemData, &quot;position&quot;, aItem.getProperty(&quot;X-SORTKEY&quot;));</span>
<a href="#l30.919"></a><span id="l30.919" class="difflineplus">+    itemData.status = (aItem.isCompleted ? &quot;completed&quot; : &quot;needsAction&quot;);</span>
<a href="#l30.920"></a><span id="l30.920"> </span>
<a href="#l30.921"></a><span id="l30.921" class="difflineminus">-            // Put the ical string in a &lt;gd:recurrence&gt; tag</span>
<a href="#l30.922"></a><span id="l30.922" class="difflineminus">-            addElemNS(gdNS, &quot;recurrence&quot;).textContent = icalString + kNEWLINE;</span>
<a href="#l30.923"></a><span id="l30.923" class="difflineminus">-        } catch (e) {</span>
<a href="#l30.924"></a><span id="l30.924" class="difflineminus">-            cal.ERROR(&quot;[calGoogleCalendar] Error: &quot; + e);</span>
<a href="#l30.925"></a><span id="l30.925" class="difflineplus">+    if (aItem.dueDate) {</span>
<a href="#l30.926"></a><span id="l30.926" class="difflineplus">+        let dueDate = aItem.dueDate.getInTimezone(cal.UTC());</span>
<a href="#l30.927"></a><span id="l30.927" class="difflineplus">+        dueDate.isDate = false;</span>
<a href="#l30.928"></a><span id="l30.928" class="difflineplus">+        itemData.due = cal.toRFC3339(dueDate);</span>
<a href="#l30.929"></a><span id="l30.929" class="difflineplus">+    }</span>
<a href="#l30.930"></a><span id="l30.930" class="difflineplus">+    setIf(itemData, &quot;completed&quot;, cal.toRFC3339(aItem.completedDate));</span>
<a href="#l30.931"></a><span id="l30.931" class="difflineplus">+</span>
<a href="#l30.932"></a><span id="l30.932" class="difflineplus">+    for each (let relation in aItem.getRelations({})) {</span>
<a href="#l30.933"></a><span id="l30.933" class="difflineplus">+        if (relation.relId &amp;&amp;</span>
<a href="#l30.934"></a><span id="l30.934" class="difflineplus">+            (!relation.relType || relation.relType == &quot;PARENT&quot;)) {</span>
<a href="#l30.935"></a><span id="l30.935" class="difflineplus">+            itemData.parent = relation.relId;</span>
<a href="#l30.936"></a><span id="l30.936" class="difflineplus">+            break;</span>
<a href="#l30.937"></a><span id="l30.937">         }</span>
<a href="#l30.938"></a><span id="l30.938">     }</span>
<a href="#l30.939"></a><span id="l30.939"> </span>
<a href="#l30.940"></a><span id="l30.940" class="difflineminus">-    // gd:originalEvent</span>
<a href="#l30.941"></a><span id="l30.941" class="difflineminus">-    if (aItem.recurrenceId) {</span>
<a href="#l30.942"></a><span id="l30.942" class="difflineminus">-        let originalEvent = addElemNS(gdNS, &quot;originalEvent&quot;);</span>
<a href="#l30.943"></a><span id="l30.943" class="difflineminus">-        originalEvent.setAttribute(&quot;id&quot;, aItem.parentItem.id);</span>
<a href="#l30.944"></a><span id="l30.944" class="difflineminus">-</span>
<a href="#l30.945"></a><span id="l30.945" class="difflineminus">-        let origWhen = addElemNS(gdNS, &quot;when&quot;, originalEvent)</span>
<a href="#l30.946"></a><span id="l30.946" class="difflineminus">-        origWhen.setAttribute(&quot;startTime&quot;, cal.toRFC3339(aItem.recurrenceId.getInTimezone(cal.UTC())));</span>
<a href="#l30.947"></a><span id="l30.947" class="difflineplus">+    let attachments = aItem.getAttachments({});</span>
<a href="#l30.948"></a><span id="l30.948" class="difflineplus">+    if (attachments.length) itemData.links = [];</span>
<a href="#l30.949"></a><span id="l30.949" class="difflineplus">+    for each (let attach in aItem.getAttachments({})) {</span>
<a href="#l30.950"></a><span id="l30.950" class="difflineplus">+        let attachData = {};</span>
<a href="#l30.951"></a><span id="l30.951" class="difflineplus">+        attachData.link = attach.uri.spec;</span>
<a href="#l30.952"></a><span id="l30.952" class="difflineplus">+        attachData.description = attach.getParameter(&quot;FILENAME&quot;);</span>
<a href="#l30.953"></a><span id="l30.953" class="difflineplus">+        attachData.type = attach.getParameter(&quot;X-TYPE&quot;);</span>
<a href="#l30.954"></a><span id="l30.954" class="difflineplus">+        itemData.links.push(attachData);</span>
<a href="#l30.955"></a><span id="l30.955">     }</span>
<a href="#l30.956"></a><span id="l30.956"> </span>
<a href="#l30.957"></a><span id="l30.957" class="difflineminus">-    // While it may sometimes not work out, we can always try to set the uid and</span>
<a href="#l30.958"></a><span id="l30.958" class="difflineminus">-    // sequence properties</span>
<a href="#l30.959"></a><span id="l30.959" class="difflineminus">-    let sequence = aItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l30.960"></a><span id="l30.960" class="difflineminus">-    if (sequence) {</span>
<a href="#l30.961"></a><span id="l30.961" class="difflineminus">-        addElemNS(gcalNS, &quot;sequence&quot;).setAttribute(&quot;value&quot;, sequence);</span>
<a href="#l30.962"></a><span id="l30.962" class="difflineminus">-    }</span>
<a href="#l30.963"></a><span id="l30.963" class="difflineminus">-    addElemNS(gcalNS, &quot;uid&quot;).setAttribute(&quot;value&quot;, aItem.id || &quot;&quot;);</span>
<a href="#l30.964"></a><span id="l30.964" class="difflineminus">-</span>
<a href="#l30.965"></a><span id="l30.965" class="difflineminus">-    // XXX Google currently has no priority support. See</span>
<a href="#l30.966"></a><span id="l30.966" class="difflineminus">-    // http://code.google.com/p/google-gdata/issues/detail?id=52</span>
<a href="#l30.967"></a><span id="l30.967" class="difflineminus">-    // for details.</span>
<a href="#l30.968"></a><span id="l30.968" class="difflineminus">-</span>
<a href="#l30.969"></a><span id="l30.969" class="difflineminus">-    return document;</span>
<a href="#l30.970"></a><span id="l30.970" class="difflineplus">+    return itemData;</span>
<a href="#l30.971"></a><span id="l30.971"> }</span>
<a href="#l30.972"></a><span id="l30.972"> </span>
<a href="#l30.973"></a><span id="l30.973"> /**</span>
<a href="#l30.974"></a><span id="l30.974" class="difflineminus">- * relevantFieldsMatch</span>
<a href="#l30.975"></a><span id="l30.975" class="difflineminus">- * Tests if all google supported fields match</span>
<a href="#l30.976"></a><span id="l30.976" class="difflineplus">+ * Convenience function to convert any item type (task/event) to its JSON</span>
<a href="#l30.977"></a><span id="l30.977" class="difflineplus">+ * representation</span>
<a href="#l30.978"></a><span id="l30.978">  *</span>
<a href="#l30.979"></a><span id="l30.979" class="difflineminus">- * @param a The reference item</span>
<a href="#l30.980"></a><span id="l30.980" class="difflineminus">- * @param b The comparing item</span>
<a href="#l30.981"></a><span id="l30.981" class="difflineminus">- * @return  true if all relevant fields match, otherwise false</span>
<a href="#l30.982"></a><span id="l30.982" class="difflineplus">+ * @param aItem         The item to convert</span>
<a href="#l30.983"></a><span id="l30.983" class="difflineplus">+ * @return              A JS Object representing the item.</span>
<a href="#l30.984"></a><span id="l30.984">  */</span>
<a href="#l30.985"></a><span id="l30.985" class="difflineminus">-function relevantFieldsMatch(a, b) {</span>
<a href="#l30.986"></a><span id="l30.986" class="difflineplus">+function ItemToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l30.987"></a><span id="l30.987" class="difflineplus">+    if (cal.isEvent(aItem)) {</span>
<a href="#l30.988"></a><span id="l30.988" class="difflineplus">+        return EventToJSON(aItem, aOfflineStorage, aIsImport);</span>
<a href="#l30.989"></a><span id="l30.989" class="difflineplus">+    } else if (cal.isToDo(aItem)) {</span>
<a href="#l30.990"></a><span id="l30.990" class="difflineplus">+        return TaskToJSON(aItem, aOfflineStorage, aIsImport);</span>
<a href="#l30.991"></a><span id="l30.991" class="difflineplus">+    } else {</span>
<a href="#l30.992"></a><span id="l30.992" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Invalid item type: &quot; + aItem.icalString);</span>
<a href="#l30.993"></a><span id="l30.993" class="difflineplus">+        return null;</span>
<a href="#l30.994"></a><span id="l30.994" class="difflineplus">+    }</span>
<a href="#l30.995"></a><span id="l30.995" class="difflineplus">+}</span>
<a href="#l30.996"></a><span id="l30.996"> </span>
<a href="#l30.997"></a><span id="l30.997" class="difflineminus">-    // flat values</span>
<a href="#l30.998"></a><span id="l30.998" class="difflineminus">-    if (a.id != b.id ||</span>
<a href="#l30.999"></a><span id="l30.999" class="difflineminus">-        a.title != b.title ||</span>
<a href="#l30.1000"></a><span id="l30.1000" class="difflineminus">-        a.status != b.status ||</span>
<a href="#l30.1001"></a><span id="l30.1001" class="difflineminus">-        a.privacy != b.privacy) {</span>
<a href="#l30.1002"></a><span id="l30.1002" class="difflineminus">-        return false;</span>
<a href="#l30.1003"></a><span id="l30.1003" class="difflineplus">+/**</span>
<a href="#l30.1004"></a><span id="l30.1004" class="difflineplus">+ * Sets up the recurrence info on the item</span>
<a href="#l30.1005"></a><span id="l30.1005" class="difflineplus">+ *</span>
<a href="#l30.1006"></a><span id="l30.1006" class="difflineplus">+ * @param aItem              The item to setup recurrence for.</span>
<a href="#l30.1007"></a><span id="l30.1007" class="difflineplus">+ * @param aRecurrence        The JSON entry describing recurrence.</span>
<a href="#l30.1008"></a><span id="l30.1008" class="difflineplus">+ */</span>
<a href="#l30.1009"></a><span id="l30.1009" class="difflineplus">+function setupRecurrence(aItem, aRecurrence, aTimezone) {</span>
<a href="#l30.1010"></a><span id="l30.1010" class="difflineplus">+    if (!aRecurrence) {</span>
<a href="#l30.1011"></a><span id="l30.1011" class="difflineplus">+        return;</span>
<a href="#l30.1012"></a><span id="l30.1012" class="difflineplus">+    }</span>
<a href="#l30.1013"></a><span id="l30.1013" class="difflineplus">+</span>
<a href="#l30.1014"></a><span id="l30.1014" class="difflineplus">+    if (!aItem.recurrenceInfo) {</span>
<a href="#l30.1015"></a><span id="l30.1015" class="difflineplus">+        aItem.recurrenceInfo = cal.createRecurrenceInfo(aItem);</span>
<a href="#l30.1016"></a><span id="l30.1016" class="difflineplus">+    } else {</span>
<a href="#l30.1017"></a><span id="l30.1017" class="difflineplus">+        aItem.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l30.1018"></a><span id="l30.1018">     }</span>
<a href="#l30.1019"></a><span id="l30.1019"> </span>
<a href="#l30.1020"></a><span id="l30.1020" class="difflineminus">-    function compareNotNull(prop) {</span>
<a href="#l30.1021"></a><span id="l30.1021" class="difflineminus">-        let ap = a[prop];</span>
<a href="#l30.1022"></a><span id="l30.1022" class="difflineminus">-        let bp = b[prop];</span>
<a href="#l30.1023"></a><span id="l30.1023" class="difflineminus">-        return (ap &amp;&amp; !bp || !ap &amp;&amp; bp ||</span>
<a href="#l30.1024"></a><span id="l30.1024" class="difflineminus">-                (typeof(ap) == 'object' &amp;&amp; ap &amp;&amp; bp &amp;&amp;</span>
<a href="#l30.1025"></a><span id="l30.1025" class="difflineminus">-                 ap.compare &amp;&amp; ap.compare(bp)));</span>
<a href="#l30.1026"></a><span id="l30.1026" class="difflineplus">+    let rootComp;</span>
<a href="#l30.1027"></a><span id="l30.1027" class="difflineplus">+    try {</span>
<a href="#l30.1028"></a><span id="l30.1028" class="difflineplus">+        let vevent = &quot;BEGIN:VEVENT\r\n&quot; + aRecurrence.join(&quot;\r\n&quot;) + &quot;\r\nEND:VEVENT&quot;;</span>
<a href="#l30.1029"></a><span id="l30.1029" class="difflineplus">+        rootComp = cal.getIcsService().parseICS(vevent, null);</span>
<a href="#l30.1030"></a><span id="l30.1030" class="difflineplus">+    } catch (e) {</span>
<a href="#l30.1031"></a><span id="l30.1031" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Unable to parse recurrence item: &quot; + vevent);</span>
<a href="#l30.1032"></a><span id="l30.1032">     }</span>
<a href="#l30.1033"></a><span id="l30.1033"> </span>
<a href="#l30.1034"></a><span id="l30.1034" class="difflineminus">-    // Object flat values</span>
<a href="#l30.1035"></a><span id="l30.1035" class="difflineminus">-    if (compareNotNull(&quot;recurrenceInfo&quot;) ||</span>
<a href="#l30.1036"></a><span id="l30.1036" class="difflineminus">-        compareNotNull(&quot;alarmLastAck&quot;) ||</span>
<a href="#l30.1037"></a><span id="l30.1037" class="difflineminus">-        /* Compare startDate and endDate */</span>
<a href="#l30.1038"></a><span id="l30.1038" class="difflineminus">-        compareNotNull(&quot;startDate&quot;) ||</span>
<a href="#l30.1039"></a><span id="l30.1039" class="difflineminus">-        compareNotNull(&quot;endDate&quot;) ||</span>
<a href="#l30.1040"></a><span id="l30.1040" class="difflineminus">-        (a.startDate.isDate != b.startDate.isDate) ||</span>
<a href="#l30.1041"></a><span id="l30.1041" class="difflineminus">-        (a.endDate.isDate != b.endDate.isDate)) {</span>
<a href="#l30.1042"></a><span id="l30.1042" class="difflineminus">-        return false;</span>
<a href="#l30.1043"></a><span id="l30.1043" class="difflineminus">-    }</span>
<a href="#l30.1044"></a><span id="l30.1044" class="difflineminus">-</span>
<a href="#l30.1045"></a><span id="l30.1045" class="difflineminus">-    // Properties</span>
<a href="#l30.1046"></a><span id="l30.1046" class="difflineminus">-    const kPROPERTIES = [&quot;DESCRIPTION&quot;, &quot;TRANSP&quot;, &quot;X-GOOGLE-EDITURL&quot;,</span>
<a href="#l30.1047"></a><span id="l30.1047" class="difflineminus">-                         &quot;LOCATION&quot;, &quot;X-MOZ-SNOOZE-TIME&quot;];</span>
<a href="#l30.1048"></a><span id="l30.1048" class="difflineminus">-</span>
<a href="#l30.1049"></a><span id="l30.1049" class="difflineminus">-    for each (let p in kPROPERTIES) {</span>
<a href="#l30.1050"></a><span id="l30.1050" class="difflineminus">-        // null and an empty string should be handled as non-relevant</span>
<a href="#l30.1051"></a><span id="l30.1051" class="difflineminus">-        if ((a.getProperty(p) || &quot;&quot;) != (b.getProperty(p) || &quot;&quot;)) {</span>
<a href="#l30.1052"></a><span id="l30.1052" class="difflineminus">-            return false;</span>
<a href="#l30.1053"></a><span id="l30.1053" class="difflineplus">+    let hasRecurringRules = false;</span>
<a href="#l30.1054"></a><span id="l30.1054" class="difflineplus">+    for (let prop in cal.ical.propertyIterator(rootComp)) {</span>
<a href="#l30.1055"></a><span id="l30.1055" class="difflineplus">+       switch (prop.propertyName) {</span>
<a href="#l30.1056"></a><span id="l30.1056" class="difflineplus">+            case &quot;RDATE&quot;:</span>
<a href="#l30.1057"></a><span id="l30.1057" class="difflineplus">+            case &quot;EXDATE&quot;:</span>
<a href="#l30.1058"></a><span id="l30.1058" class="difflineplus">+                let recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l30.1059"></a><span id="l30.1059" class="difflineplus">+                              .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l30.1060"></a><span id="l30.1060" class="difflineplus">+                try {</span>
<a href="#l30.1061"></a><span id="l30.1061" class="difflineplus">+                    recItem.icalProperty = prop;</span>
<a href="#l30.1062"></a><span id="l30.1062" class="difflineplus">+                    aItem.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l30.1063"></a><span id="l30.1063" class="difflineplus">+                    hasRecurringRules = true;</span>
<a href="#l30.1064"></a><span id="l30.1064" class="difflineplus">+                } catch (e) {</span>
<a href="#l30.1065"></a><span id="l30.1065" class="difflineplus">+                    cal.ERROR(&quot;[calGoogleCalendar] Error parsing &quot; +</span>
<a href="#l30.1066"></a><span id="l30.1066" class="difflineplus">+                              prop.propertyName + &quot; (&quot; +</span>
<a href="#l30.1067"></a><span id="l30.1067" class="difflineplus">+                              prop.icalString + &quot;):&quot; + e);</span>
<a href="#l30.1068"></a><span id="l30.1068" class="difflineplus">+                }</span>
<a href="#l30.1069"></a><span id="l30.1069" class="difflineplus">+                break;</span>
<a href="#l30.1070"></a><span id="l30.1070" class="difflineplus">+            case &quot;RRULE&quot;:</span>
<a href="#l30.1071"></a><span id="l30.1071" class="difflineplus">+                let recRule = cal.createRecurrenceRule();</span>
<a href="#l30.1072"></a><span id="l30.1072" class="difflineplus">+                try {</span>
<a href="#l30.1073"></a><span id="l30.1073" class="difflineplus">+                    recRule.icalProperty = prop;</span>
<a href="#l30.1074"></a><span id="l30.1074" class="difflineplus">+                    aItem.recurrenceInfo.appendRecurrenceItem(recRule);</span>
<a href="#l30.1075"></a><span id="l30.1075" class="difflineplus">+                    hasRecurringRules = true;</span>
<a href="#l30.1076"></a><span id="l30.1076" class="difflineplus">+                } catch (e) {</span>
<a href="#l30.1077"></a><span id="l30.1077" class="difflineplus">+                    cal.ERROR(&quot;[calGoogleCalendar] Error parsing RRULE (&quot; +</span>
<a href="#l30.1078"></a><span id="l30.1078" class="difflineplus">+                              prop.icalString + &quot;):&quot; + e);</span>
<a href="#l30.1079"></a><span id="l30.1079" class="difflineplus">+                }</span>
<a href="#l30.1080"></a><span id="l30.1080" class="difflineplus">+                break;</span>
<a href="#l30.1081"></a><span id="l30.1081">         }</span>
<a href="#l30.1082"></a><span id="l30.1082">     }</span>
<a href="#l30.1083"></a><span id="l30.1083"> </span>
<a href="#l30.1084"></a><span id="l30.1084" class="difflineminus">-    // categories</span>
<a href="#l30.1085"></a><span id="l30.1085" class="difflineminus">-    let aCat = a.getCategories({});</span>
<a href="#l30.1086"></a><span id="l30.1086" class="difflineminus">-    let bCat = b.getCategories({});</span>
<a href="#l30.1087"></a><span id="l30.1087" class="difflineminus">-    if ((aCat.length != bCat.length) ||</span>
<a href="#l30.1088"></a><span id="l30.1088" class="difflineminus">-        aCat.some(function notIn(cat) { return (bCat.indexOf(cat) == -1); })) {</span>
<a href="#l30.1089"></a><span id="l30.1089" class="difflineminus">-        return false;</span>
<a href="#l30.1090"></a><span id="l30.1090" class="difflineminus">-    }</span>
<a href="#l30.1091"></a><span id="l30.1091" class="difflineminus">-</span>
<a href="#l30.1092"></a><span id="l30.1092" class="difflineminus">-    // attendees and organzier</span>
<a href="#l30.1093"></a><span id="l30.1093" class="difflineminus">-    let aa = a.getAttendees({});</span>
<a href="#l30.1094"></a><span id="l30.1094" class="difflineminus">-    let ab = b.getAttendees({});</span>
<a href="#l30.1095"></a><span id="l30.1095" class="difflineminus">-    if (aa.length != ab.length) {</span>
<a href="#l30.1096"></a><span id="l30.1096" class="difflineminus">-        return false;</span>
<a href="#l30.1097"></a><span id="l30.1097" class="difflineminus">-    }</span>
<a href="#l30.1098"></a><span id="l30.1098" class="difflineminus">-</span>
<a href="#l30.1099"></a><span id="l30.1099" class="difflineminus">-    if ((a.organizer &amp;&amp; !b.organizer) ||</span>
<a href="#l30.1100"></a><span id="l30.1100" class="difflineminus">-        (!a.organizer &amp;&amp; b.organizer) ||</span>
<a href="#l30.1101"></a><span id="l30.1101" class="difflineminus">-        (a.organizer &amp;&amp; b.organizer &amp;&amp; a.organizer.id != b.organizer.id)) {</span>
<a href="#l30.1102"></a><span id="l30.1102" class="difflineminus">-        return false;</span>
<a href="#l30.1103"></a><span id="l30.1103" class="difflineminus">-    }</span>
<a href="#l30.1104"></a><span id="l30.1104" class="difflineminus">-</span>
<a href="#l30.1105"></a><span id="l30.1105" class="difflineminus">-    // go through attendees in a, check if its id is in b</span>
<a href="#l30.1106"></a><span id="l30.1106" class="difflineminus">-    for each (let attendee in aa) {</span>
<a href="#l30.1107"></a><span id="l30.1107" class="difflineminus">-        let ba = b.getAttendeeById(attendee.id);</span>
<a href="#l30.1108"></a><span id="l30.1108" class="difflineminus">-        if (!ba ||</span>
<a href="#l30.1109"></a><span id="l30.1109" class="difflineminus">-            ba.participationStatus != attendee.participationStatus ||</span>
<a href="#l30.1110"></a><span id="l30.1110" class="difflineminus">-            ba.commonName != attendee.commonName ||</span>
<a href="#l30.1111"></a><span id="l30.1111" class="difflineminus">-            ba.isOrganizer != attendee.isOrganizer ||</span>
<a href="#l30.1112"></a><span id="l30.1112" class="difflineminus">-            ba.role != attendee.role) {</span>
<a href="#l30.1113"></a><span id="l30.1113" class="difflineminus">-            return false;</span>
<a href="#l30.1114"></a><span id="l30.1114" class="difflineminus">-        }</span>
<a href="#l30.1115"></a><span id="l30.1115" class="difflineplus">+    if (!hasRecurringRules) {</span>
<a href="#l30.1116"></a><span id="l30.1116" class="difflineplus">+        // If there were no parsable recurrence items, then clear the</span>
<a href="#l30.1117"></a><span id="l30.1117" class="difflineplus">+        // recurrence info.</span>
<a href="#l30.1118"></a><span id="l30.1118" class="difflineplus">+        aItem.recurrenceInfo = null;</span>
<a href="#l30.1119"></a><span id="l30.1119">     }</span>
<a href="#l30.1120"></a><span id="l30.1120" class="difflineminus">-</span>
<a href="#l30.1121"></a><span id="l30.1121" class="difflineminus">-    // Alarms</span>
<a href="#l30.1122"></a><span id="l30.1122" class="difflineminus">-    aa = a.getAlarms({});</span>
<a href="#l30.1123"></a><span id="l30.1123" class="difflineminus">-    ab = b.getAlarms({});</span>
<a href="#l30.1124"></a><span id="l30.1124" class="difflineminus">-</span>
<a href="#l30.1125"></a><span id="l30.1125" class="difflineminus">-    if (aa.length != ab.length) {</span>
<a href="#l30.1126"></a><span id="l30.1126" class="difflineminus">-        return false;</span>
<a href="#l30.1127"></a><span id="l30.1127" class="difflineminus">-    }</span>
<a href="#l30.1128"></a><span id="l30.1128" class="difflineminus">-</span>
<a href="#l30.1129"></a><span id="l30.1129" class="difflineminus">-    let alarmMap = {};</span>
<a href="#l30.1130"></a><span id="l30.1130" class="difflineminus">-    for each (let alarm in aa) {</span>
<a href="#l30.1131"></a><span id="l30.1131" class="difflineminus">-        alarmMap[alarm.icalString] = true;</span>
<a href="#l30.1132"></a><span id="l30.1132" class="difflineminus">-    }</span>
<a href="#l30.1133"></a><span id="l30.1133" class="difflineminus">-    let found = 0;</span>
<a href="#l30.1134"></a><span id="l30.1134" class="difflineminus">-    for each (let alarm in ab) {</span>
<a href="#l30.1135"></a><span id="l30.1135" class="difflineminus">-        if (alarm.icalString in alarmMap) {</span>
<a href="#l30.1136"></a><span id="l30.1136" class="difflineminus">-            found++;</span>
<a href="#l30.1137"></a><span id="l30.1137" class="difflineminus">-        }</span>
<a href="#l30.1138"></a><span id="l30.1138" class="difflineminus">-    }</span>
<a href="#l30.1139"></a><span id="l30.1139" class="difflineminus">-</span>
<a href="#l30.1140"></a><span id="l30.1140" class="difflineminus">-    if (found != ab.length) {</span>
<a href="#l30.1141"></a><span id="l30.1141" class="difflineminus">-        return false;</span>
<a href="#l30.1142"></a><span id="l30.1142" class="difflineminus">-    }</span>
<a href="#l30.1143"></a><span id="l30.1143" class="difflineminus">-</span>
<a href="#l30.1144"></a><span id="l30.1144" class="difflineminus">-    // Recurrence Items</span>
<a href="#l30.1145"></a><span id="l30.1145" class="difflineminus">-    if (a.recurrenceInfo) {</span>
<a href="#l30.1146"></a><span id="l30.1146" class="difflineminus">-        let ra = a.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l30.1147"></a><span id="l30.1147" class="difflineminus">-        let rb = b.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l30.1148"></a><span id="l30.1148" class="difflineminus">-</span>
<a href="#l30.1149"></a><span id="l30.1149" class="difflineminus">-        // If we have more or less, it definitly changed.</span>
<a href="#l30.1150"></a><span id="l30.1150" class="difflineminus">-        if (ra.length != rb.length) {</span>
<a href="#l30.1151"></a><span id="l30.1151" class="difflineminus">-            return false;</span>
<a href="#l30.1152"></a><span id="l30.1152" class="difflineminus">-        }</span>
<a href="#l30.1153"></a><span id="l30.1153" class="difflineminus">-</span>
<a href="#l30.1154"></a><span id="l30.1154" class="difflineminus">-        // I assume that if the recurrence pattern has not changed, the order</span>
<a href="#l30.1155"></a><span id="l30.1155" class="difflineminus">-        // of the recurrence items should not change. Anything more will be</span>
<a href="#l30.1156"></a><span id="l30.1156" class="difflineminus">-        // very expensive.</span>
<a href="#l30.1157"></a><span id="l30.1157" class="difflineminus">-        for (let i = 0; i &lt; ra.length; i++) {</span>
<a href="#l30.1158"></a><span id="l30.1158" class="difflineminus">-            if (ra[i].icalProperty.icalString !=</span>
<a href="#l30.1159"></a><span id="l30.1159" class="difflineminus">-                rb[i].icalProperty.icalString) {</span>
<a href="#l30.1160"></a><span id="l30.1160" class="difflineminus">-                return false;</span>
<a href="#l30.1161"></a><span id="l30.1161" class="difflineminus">-            }</span>
<a href="#l30.1162"></a><span id="l30.1162" class="difflineminus">-        }</span>
<a href="#l30.1163"></a><span id="l30.1163" class="difflineminus">-    }</span>
<a href="#l30.1164"></a><span id="l30.1164" class="difflineminus">-</span>
<a href="#l30.1165"></a><span id="l30.1165" class="difflineminus">-    return true;</span>
<a href="#l30.1166"></a><span id="l30.1166"> }</span>
<a href="#l30.1167"></a><span id="l30.1167"> </span>
<a href="#l30.1168"></a><span id="l30.1168"> /**</span>
<a href="#l30.1169"></a><span id="l30.1169" class="difflineminus">- * getItemEditURI</span>
<a href="#l30.1170"></a><span id="l30.1170" class="difflineminus">- * Helper to get the item's edit URI</span>
<a href="#l30.1171"></a><span id="l30.1171" class="difflineplus">+ * Create an alarm from the JSON reminder entry</span>
<a href="#l30.1172"></a><span id="l30.1172">  *</span>
<a href="#l30.1173"></a><span id="l30.1173" class="difflineminus">- * @param aItem         The item to get it from</span>
<a href="#l30.1174"></a><span id="l30.1174" class="difflineminus">- * @return              The edit URI</span>
<a href="#l30.1175"></a><span id="l30.1175" class="difflineplus">+ * @param aEntry            The JSON reminder entry.</span>
<a href="#l30.1176"></a><span id="l30.1176" class="difflineplus">+ * @param aDefault          (optional) If true, this is a default alarm.</span>
<a href="#l30.1177"></a><span id="l30.1177" class="difflineplus">+ * @return                  The translated calIAlarm.</span>
<a href="#l30.1178"></a><span id="l30.1178">  */</span>
<a href="#l30.1179"></a><span id="l30.1179" class="difflineminus">-function getItemEditURI(aItem) {</span>
<a href="#l30.1180"></a><span id="l30.1180" class="difflineplus">+function JSONToAlarm(aEntry, aDefault) {</span>
<a href="#l30.1181"></a><span id="l30.1181" class="difflineplus">+    const alarmActionMap = {</span>
<a href="#l30.1182"></a><span id="l30.1182" class="difflineplus">+        email: &quot;EMAIL&quot;,</span>
<a href="#l30.1183"></a><span id="l30.1183" class="difflineplus">+        popup: &quot;DISPLAY&quot;,</span>
<a href="#l30.1184"></a><span id="l30.1184" class="difflineplus">+        sms: &quot;SMS&quot;</span>
<a href="#l30.1185"></a><span id="l30.1185" class="difflineplus">+    };</span>
<a href="#l30.1186"></a><span id="l30.1186" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l30.1187"></a><span id="l30.1187" class="difflineplus">+    let alarmOffset = cal.createDuration();</span>
<a href="#l30.1188"></a><span id="l30.1188" class="difflineplus">+    alarm.action = alarmActionMap[aEntry.method] || &quot;DISPLAY&quot;;</span>
<a href="#l30.1189"></a><span id="l30.1189" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l30.1190"></a><span id="l30.1190" class="difflineplus">+    alarmOffset.inSeconds = -aEntry.minutes * 60;</span>
<a href="#l30.1191"></a><span id="l30.1191" class="difflineplus">+    alarmOffset.normalize();</span>
<a href="#l30.1192"></a><span id="l30.1192" class="difflineplus">+    alarm.offset = alarmOffset;</span>
<a href="#l30.1193"></a><span id="l30.1193"> </span>
<a href="#l30.1194"></a><span id="l30.1194" class="difflineminus">-    ASSERT(aItem);</span>
<a href="#l30.1195"></a><span id="l30.1195" class="difflineminus">-    let edituri = aItem.getProperty(&quot;X-GOOGLE-EDITURL&quot;);</span>
<a href="#l30.1196"></a><span id="l30.1196" class="difflineminus">-    if (!edituri) {</span>
<a href="#l30.1197"></a><span id="l30.1197" class="difflineminus">-        // If the item has no edit uri, it is read-only</span>
<a href="#l30.1198"></a><span id="l30.1198" class="difflineminus">-        throw new Components.Exception(&quot;The item is readonly&quot;, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l30.1199"></a><span id="l30.1199" class="difflineplus">+    if (aDefault) {</span>
<a href="#l30.1200"></a><span id="l30.1200" class="difflineplus">+        alarm.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l30.1201"></a><span id="l30.1201">     }</span>
<a href="#l30.1202"></a><span id="l30.1202" class="difflineminus">-    return edituri;</span>
<a href="#l30.1203"></a><span id="l30.1203" class="difflineminus">-}</span>
<a href="#l30.1204"></a><span id="l30.1204" class="difflineminus">-</span>
<a href="#l30.1205"></a><span id="l30.1205" class="difflineminus">-function getIdFromEntry(aXMLEntry) {</span>
<a href="#l30.1206"></a><span id="l30.1206" class="difflineminus">-    let id = gdataXPathFirst(aXMLEntry, 'gCal:uid/@value');</span>
<a href="#l30.1207"></a><span id="l30.1207" class="difflineminus">-    return id.replace(/@google.com/,&quot;&quot;);</span>
<a href="#l30.1208"></a><span id="l30.1208" class="difflineminus">-}</span>
<a href="#l30.1209"></a><span id="l30.1209" class="difflineminus">-</span>
<a href="#l30.1210"></a><span id="l30.1210" class="difflineminus">-function getRecurrenceIdFromEntry(aXMLEntry, aTimezone) {</span>
<a href="#l30.1211"></a><span id="l30.1211" class="difflineminus">-    let rId = gdataXPathFirst(aXMLEntry, 'gd:originalEvent/gd:when/@startTime');</span>
<a href="#l30.1212"></a><span id="l30.1212" class="difflineminus">-    return (rId ? cal.fromRFC3339(rId.toString(), aTimezone) : null);</span>
<a href="#l30.1213"></a><span id="l30.1213" class="difflineplus">+    return alarm;</span>
<a href="#l30.1214"></a><span id="l30.1214"> }</span>
<a href="#l30.1215"></a><span id="l30.1215"> </span>
<a href="#l30.1216"></a><span id="l30.1216"> /**</span>
<a href="#l30.1217"></a><span id="l30.1217" class="difflineminus">- * XMLEntryToItem</span>
<a href="#l30.1218"></a><span id="l30.1218" class="difflineminus">- * Converts a string of xml data to a calIEvent.</span>
<a href="#l30.1219"></a><span id="l30.1219" class="difflineplus">+ * Converts a JS Object representing the event to a calIEvent.</span>
<a href="#l30.1220"></a><span id="l30.1220">  *</span>
<a href="#l30.1221"></a><span id="l30.1221" class="difflineminus">- * @param aXMLEntry         The xml data of the item</span>
<a href="#l30.1222"></a><span id="l30.1222" class="difflineminus">- * @param aTimezone         The timezone the event is most likely in</span>
<a href="#l30.1223"></a><span id="l30.1223" class="difflineminus">- * @param aCalendar         The calendar this item will belong to. This needs to</span>
<a href="#l30.1224"></a><span id="l30.1224" class="difflineminus">- *                              be a calIGoogleCalendar instance.</span>
<a href="#l30.1225"></a><span id="l30.1225" class="difflineminus">- * @param aReferenceItem    The item to apply the information from the xml to.</span>
<a href="#l30.1226"></a><span id="l30.1226" class="difflineminus">- *                              If null, a new item will be used.</span>
<a href="#l30.1227"></a><span id="l30.1227" class="difflineplus">+ * @param aEntry            The JS Object representation of the item.</span>
<a href="#l30.1228"></a><span id="l30.1228" class="difflineplus">+ * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l30.1229"></a><span id="l30.1229" class="difflineplus">+ * @param aTimezone         The Timezone the event is most likely in.</span>
<a href="#l30.1230"></a><span id="l30.1230" class="difflineplus">+ * @param aDefaultReminders An array of default reminders, as a JS Object.</span>
<a href="#l30.1231"></a><span id="l30.1231" class="difflineplus">+ * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l30.1232"></a><span id="l30.1232">  * @return                  The calIEvent with the item data.</span>
<a href="#l30.1233"></a><span id="l30.1233">  */</span>
<a href="#l30.1234"></a><span id="l30.1234" class="difflineminus">-function XMLEntryToItem(aXMLEntry, aTimezone, aCalendar, aReferenceItem) {</span>
<a href="#l30.1235"></a><span id="l30.1235" class="difflineminus">-</span>
<a href="#l30.1236"></a><span id="l30.1236" class="difflineminus">-    function getExtendedProperty(x) gdataXPathFirst(aXMLEntry, 'gd:extendedProperty[@name=&quot;' + x + '&quot;]/@value');</span>
<a href="#l30.1237"></a><span id="l30.1237" class="difflineplus">+function JSONToEvent(aEntry, aCalendar, aTimezone, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l30.1238"></a><span id="l30.1238" class="difflineplus">+    aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l30.1239"></a><span id="l30.1239" class="difflineplus">+    aMetadata = aMetadata || {};</span>
<a href="#l30.1240"></a><span id="l30.1240" class="difflineplus">+    let item = aReferenceItem || cal.createEvent();</span>
<a href="#l30.1241"></a><span id="l30.1241" class="difflineplus">+    item.calendar = aCalendar.superCalendar;</span>
<a href="#l30.1242"></a><span id="l30.1242" class="difflineplus">+    let privateProps = (&quot;extendedProperties&quot; in aEntry &amp;&amp; aEntry.extendedProperties.private) || {};</span>
<a href="#l30.1243"></a><span id="l30.1243" class="difflineplus">+    let sharedProps = (&quot;extendedProperties&quot; in aEntry &amp;&amp; aEntry.extendedProperties.shared) || {};</span>
<a href="#l30.1244"></a><span id="l30.1244" class="difflineplus">+    let accessRole = aCalendar.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l30.1245"></a><span id="l30.1245"> </span>
<a href="#l30.1246"></a><span id="l30.1246" class="difflineminus">-    if (!aXMLEntry) {</span>
<a href="#l30.1247"></a><span id="l30.1247" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l30.1248"></a><span id="l30.1248" class="difflineminus">-    } else if (typeof aXMLEntry == &quot;string&quot;) {</span>
<a href="#l30.1249"></a><span id="l30.1249" class="difflineminus">-        aXMLEntry = cal.xml.parseString(aXMLEntry);</span>
<a href="#l30.1250"></a><span id="l30.1250" class="difflineplus">+    LOGverbose(&quot;[calGoogleCalendar] Parsing entry:\n&quot; +</span>
<a href="#l30.1251"></a><span id="l30.1251" class="difflineplus">+               JSON.stringify(aEntry, null, &quot; &quot;) + &quot;\n&quot;);</span>
<a href="#l30.1252"></a><span id="l30.1252" class="difflineplus">+</span>
<a href="#l30.1253"></a><span id="l30.1253" class="difflineplus">+    if (!aEntry || !(&quot;kind&quot; in aEntry) || aEntry.kind != &quot;calendar#event&quot;) {</span>
<a href="#l30.1254"></a><span id="l30.1254" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Attempt to decode invalid event: &quot; +</span>
<a href="#l30.1255"></a><span id="l30.1255" class="difflineplus">+                  (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;)));</span>
<a href="#l30.1256"></a><span id="l30.1256" class="difflineplus">+        return null;</span>
<a href="#l30.1257"></a><span id="l30.1257">     }</span>
<a href="#l30.1258"></a><span id="l30.1258"> </span>
<a href="#l30.1259"></a><span id="l30.1259" class="difflineminus">-    let item = (aReferenceItem ? aReferenceItem.clone() : cal.createEvent());</span>
<a href="#l30.1260"></a><span id="l30.1260" class="difflineminus">-</span>
<a href="#l30.1261"></a><span id="l30.1261">     try {</span>
<a href="#l30.1262"></a><span id="l30.1262" class="difflineminus">-        // id</span>
<a href="#l30.1263"></a><span id="l30.1263" class="difflineminus">-        item.id = getIdFromEntry(aXMLEntry);</span>
<a href="#l30.1264"></a><span id="l30.1264" class="difflineminus">-</span>
<a href="#l30.1265"></a><span id="l30.1265" class="difflineminus">-        // sequence</span>
<a href="#l30.1266"></a><span id="l30.1266" class="difflineminus">-        item.setProperty(&quot;SEQUENCE&quot;, gdataXPathFirst(aXMLEntry, 'gCal:sequence/@value') || 0);</span>
<a href="#l30.1267"></a><span id="l30.1267" class="difflineminus">-</span>
<a href="#l30.1268"></a><span id="l30.1268" class="difflineminus">-        // link (edit url)</span>
<a href="#l30.1269"></a><span id="l30.1269" class="difflineminus">-        // Since Google doesn't set the edit url to be https if the request is</span>
<a href="#l30.1270"></a><span id="l30.1270" class="difflineminus">-        // https, we need to work around this here.</span>
<a href="#l30.1271"></a><span id="l30.1271" class="difflineminus">-        let editUrl = gdataXPathFirst(aXMLEntry, 'atom:link[@rel=&quot;edit&quot;]/@href');</span>
<a href="#l30.1272"></a><span id="l30.1272" class="difflineminus">-        if (aCalendar.uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l30.1273"></a><span id="l30.1273" class="difflineminus">-            editUrl = editUrl.replace(/^http:/, &quot;https:&quot;);</span>
<a href="#l30.1274"></a><span id="l30.1274" class="difflineplus">+        item.id = aEntry.iCalUID || ((aEntry.recurringEventId || aEntry.id) + &quot;@google.com&quot;);</span>
<a href="#l30.1275"></a><span id="l30.1275" class="difflineplus">+        item.recurrenceId = JSONToDate(aEntry.originalStartTime, aTimezone);</span>
<a href="#l30.1276"></a><span id="l30.1276" class="difflineplus">+        if (!item.recurrenceId) {</span>
<a href="#l30.1277"></a><span id="l30.1277" class="difflineplus">+            // Sometimes recurring event instances don't have recurringEventId</span>
<a href="#l30.1278"></a><span id="l30.1278" class="difflineplus">+            // set, but are still instances. work around by detecting the ID.</span>
<a href="#l30.1279"></a><span id="l30.1279" class="difflineplus">+            // http://code.google.com/a/google.com/p/apps-api-issues/issues/detail?id=3199</span>
<a href="#l30.1280"></a><span id="l30.1280" class="difflineplus">+            let hack = aEntry.id.match(/([^_]*)_(\d{8}(T\d{6}Z)?)/);</span>
<a href="#l30.1281"></a><span id="l30.1281" class="difflineplus">+            item.recurrenceId = hack ? cal.createDateTime(hack[2]) : null;</span>
<a href="#l30.1282"></a><span id="l30.1282">         }</span>
<a href="#l30.1283"></a><span id="l30.1283" class="difflineminus">-        item.setProperty(&quot;X-GOOGLE-EDITURL&quot;, editUrl);</span>
<a href="#l30.1284"></a><span id="l30.1284" class="difflineminus">-</span>
<a href="#l30.1285"></a><span id="l30.1285" class="difflineminus">-        // link (alternative representation, html)</span>
<a href="#l30.1286"></a><span id="l30.1286" class="difflineminus">-        let htmlUrl = gdataXPathFirst(aXMLEntry, 'atom:link[@rel=&quot;alternate&quot;]/@href');</span>
<a href="#l30.1287"></a><span id="l30.1287" class="difflineminus">-        if (aCalendar.uri.schemeIs(&quot;https&quot;)) {</span>
<a href="#l30.1288"></a><span id="l30.1288" class="difflineminus">-            htmlUrl = htmlUrl.replace(/^http:/, &quot;https:&quot;);</span>
<a href="#l30.1289"></a><span id="l30.1289" class="difflineplus">+        item.status = (aEntry.status ? aEntry.status.toUpperCase() : null);</span>
<a href="#l30.1290"></a><span id="l30.1290" class="difflineplus">+        item.title = aEntry.summary;</span>
<a href="#l30.1291"></a><span id="l30.1291" class="difflineplus">+        if (accessRole == &quot;freeBusyReader&quot;) {</span>
<a href="#l30.1292"></a><span id="l30.1292" class="difflineplus">+            item.title = getProviderString(&quot;busyTitle&quot;, aCalendar.name);</span>
<a href="#l30.1293"></a><span id="l30.1293">         }</span>
<a href="#l30.1294"></a><span id="l30.1294" class="difflineminus">-        item.setProperty(&quot;URL&quot;, htmlUrl);</span>
<a href="#l30.1295"></a><span id="l30.1295" class="difflineplus">+        item.privacy = (aEntry.visibility ? aEntry.visibility.toUpperCase() : null);</span>
<a href="#l30.1296"></a><span id="l30.1296"> </span>
<a href="#l30.1297"></a><span id="l30.1297" class="difflineminus">-        // title</span>
<a href="#l30.1298"></a><span id="l30.1298" class="difflineminus">-        item.title = gdataXPathFirst(aXMLEntry, 'atom:title[@type=&quot;text&quot;]/text()');</span>
<a href="#l30.1299"></a><span id="l30.1299" class="difflineminus">-</span>
<a href="#l30.1300"></a><span id="l30.1300" class="difflineminus">-        // content</span>
<a href="#l30.1301"></a><span id="l30.1301" class="difflineminus">-        item.setProperty(&quot;DESCRIPTION&quot;, gdataXPathFirst(aXMLEntry, 'atom:content[@type=&quot;text&quot;]/text()'));</span>
<a href="#l30.1302"></a><span id="l30.1302" class="difflineplus">+        item.setProperty(&quot;URL&quot;, aEntry.htmlLink &amp;&amp; aCalendar.uri.schemeIs(&quot;https&quot;) ? aEntry.htmlLink.replace(/^http:/, &quot;https:&quot;) : aEntry.htmlLink);</span>
<a href="#l30.1303"></a><span id="l30.1303" class="difflineplus">+        item.setProperty(&quot;CREATED&quot;, (aEntry.created ? cal.fromRFC3339(aEntry.created, aTimezone).getInTimezone(cal.UTC()) : null));</span>
<a href="#l30.1304"></a><span id="l30.1304" class="difflineplus">+        item.setProperty(&quot;DESCRIPTION&quot;, aEntry.description);</span>
<a href="#l30.1305"></a><span id="l30.1305" class="difflineplus">+        item.setProperty(&quot;LOCATION&quot;, aEntry.location);</span>
<a href="#l30.1306"></a><span id="l30.1306" class="difflineplus">+        item.setProperty(&quot;TRANSP&quot;, (aEntry.transparency ? aEntry.transparency.toUpperCase() : null));</span>
<a href="#l30.1307"></a><span id="l30.1307" class="difflineplus">+        item.setProperty(&quot;SEQUENCE&quot;, aEntry.sequence);</span>
<a href="#l30.1308"></a><span id="l30.1308" class="difflineplus">+        aMetadata.etag = aEntry.etag;</span>
<a href="#l30.1309"></a><span id="l30.1309" class="difflineplus">+        aMetadata.path = aEntry.id;</span>
<a href="#l30.1310"></a><span id="l30.1310"> </span>
<a href="#l30.1311"></a><span id="l30.1311" class="difflineminus">-        // gd:transparency</span>
<a href="#l30.1312"></a><span id="l30.1312" class="difflineminus">-        item.setProperty(&quot;TRANSP&quot;, gdataXPathFirst(aXMLEntry, 'gd:transparency/@value').substring(39).toUpperCase());</span>
<a href="#l30.1313"></a><span id="l30.1313" class="difflineminus">-</span>
<a href="#l30.1314"></a><span id="l30.1314" class="difflineminus">-        // gd:eventStatus</span>
<a href="#l30.1315"></a><span id="l30.1315" class="difflineminus">-        item.status = gdataXPathFirst(aXMLEntry, 'gd:eventStatus/@value').substring(39).toUpperCase();</span>
<a href="#l30.1316"></a><span id="l30.1316" class="difflineminus">-</span>
<a href="#l30.1317"></a><span id="l30.1317" class="difflineminus">-        // gd:reminder (preparation)</span>
<a href="#l30.1318"></a><span id="l30.1318" class="difflineminus">-        // If a reference item was passed, it may already contain alarms. Since</span>
<a href="#l30.1319"></a><span id="l30.1319" class="difflineminus">-        // we have no alarm id or such and the alarms are contained in every</span>
<a href="#l30.1320"></a><span id="l30.1320" class="difflineminus">-        // feed, we can go ahead and clear the alarms here.</span>
<a href="#l30.1321"></a><span id="l30.1321" class="difflineminus">-        item.clearAlarms();</span>
<a href="#l30.1322"></a><span id="l30.1322" class="difflineplus">+        // organizer</span>
<a href="#l30.1323"></a><span id="l30.1323" class="difflineplus">+        if (aEntry.organizer) {</span>
<a href="#l30.1324"></a><span id="l30.1324" class="difflineplus">+            let organizer = cal.createAttendee();</span>
<a href="#l30.1325"></a><span id="l30.1325" class="difflineplus">+            if (aEntry.organizer.email) {</span>
<a href="#l30.1326"></a><span id="l30.1326" class="difflineplus">+                organizer.id = &quot;mailto:&quot; + aEntry.organizer.email;</span>
<a href="#l30.1327"></a><span id="l30.1327" class="difflineplus">+            } else {</span>
<a href="#l30.1328"></a><span id="l30.1328" class="difflineplus">+                organizer.id = &quot;urn:id:&quot; + aEntry.organizer.id;</span>
<a href="#l30.1329"></a><span id="l30.1329" class="difflineplus">+            }</span>
<a href="#l30.1330"></a><span id="l30.1330" class="difflineplus">+            organizer.commonName = aEntry.organizer.displayName;</span>
<a href="#l30.1331"></a><span id="l30.1331" class="difflineplus">+            organizer.isOrganizer = true;</span>
<a href="#l30.1332"></a><span id="l30.1332" class="difflineplus">+            item.organizer = organizer;</span>
<a href="#l30.1333"></a><span id="l30.1333"> </span>
<a href="#l30.1334"></a><span id="l30.1334" class="difflineminus">-        /**</span>
<a href="#l30.1335"></a><span id="l30.1335" class="difflineminus">-         * Helper function to parse all reminders in a tagset.</span>
<a href="#l30.1336"></a><span id="l30.1336" class="difflineminus">-         *</span>
<a href="#l30.1337"></a><span id="l30.1337" class="difflineminus">-         * @param reminderTags      The tagset to parse.</span>
<a href="#l30.1338"></a><span id="l30.1338" class="difflineminus">-         */</span>
<a href="#l30.1339"></a><span id="l30.1339" class="difflineminus">-        function parseReminders(reminderTags) {</span>
<a href="#l30.1340"></a><span id="l30.1340" class="difflineminus">-            let organizerEmail = gdataXPathFirst(aXMLEntry, 'gd:who[@rel=&quot;http://schemas.google.com/g/2005#event.organizer&quot;]/@email');</span>
<a href="#l30.1341"></a><span id="l30.1341" class="difflineminus">-            if (organizerEmail != aCalendar.googleCalendarName) {</span>
<a href="#l30.1342"></a><span id="l30.1342" class="difflineminus">-                // We are not the organizer, so its not smart to set alarms on</span>
<a href="#l30.1343"></a><span id="l30.1343" class="difflineminus">-                // this event.</span>
<a href="#l30.1344"></a><span id="l30.1344" class="difflineminus">-                return;</span>
<a href="#l30.1345"></a><span id="l30.1345" class="difflineplus">+            if (aEntry.organizer.self &amp;&amp; aCalendar.session) {</span>
<a href="#l30.1346"></a><span id="l30.1346" class="difflineplus">+                // Remember the display name, we found ourselves!</span>
<a href="#l30.1347"></a><span id="l30.1347" class="difflineplus">+                aCalendar.setProperty(&quot;organizerCN&quot;, aEntry.organizer.displayName);</span>
<a href="#l30.1348"></a><span id="l30.1348">             }</span>
<a href="#l30.1349"></a><span id="l30.1349" class="difflineminus">-            const actionMap = {</span>
<a href="#l30.1350"></a><span id="l30.1350" class="difflineminus">-                email: &quot;EMAIL&quot;,</span>
<a href="#l30.1351"></a><span id="l30.1351" class="difflineminus">-                alert: &quot;DISPLAY&quot;,</span>
<a href="#l30.1352"></a><span id="l30.1352" class="difflineminus">-                sms: &quot;SMS&quot;</span>
<a href="#l30.1353"></a><span id="l30.1353" class="difflineminus">-            };</span>
<a href="#l30.1354"></a><span id="l30.1354" class="difflineminus">-            for each (let reminderTag in reminderTags) {</span>
<a href="#l30.1355"></a><span id="l30.1355" class="difflineminus">-                let alarm = cal.createAlarm();</span>
<a href="#l30.1356"></a><span id="l30.1356" class="difflineminus">-                alarm.action = actionMap[reminderTag.getAttribute(&quot;method&quot;)] || &quot;DISPLAY&quot;;</span>
<a href="#l30.1357"></a><span id="l30.1357" class="difflineplus">+        } else {</span>
<a href="#l30.1358"></a><span id="l30.1358" class="difflineplus">+            item.organizer = null;</span>
<a href="#l30.1359"></a><span id="l30.1359" class="difflineplus">+        }</span>
<a href="#l30.1360"></a><span id="l30.1360" class="difflineplus">+</span>
<a href="#l30.1361"></a><span id="l30.1361" class="difflineplus">+        // start and end</span>
<a href="#l30.1362"></a><span id="l30.1362" class="difflineplus">+        item.startDate = JSONToDate(aEntry.start, aTimezone);</span>
<a href="#l30.1363"></a><span id="l30.1363" class="difflineplus">+        item.endDate = JSONToDate(aEntry.end, aTimezone);</span>
<a href="#l30.1364"></a><span id="l30.1364" class="difflineplus">+</span>
<a href="#l30.1365"></a><span id="l30.1365" class="difflineplus">+        // recurrence</span>
<a href="#l30.1366"></a><span id="l30.1366" class="difflineplus">+        setupRecurrence(item, aEntry.recurrence, aTimezone);</span>
<a href="#l30.1367"></a><span id="l30.1367"> </span>
<a href="#l30.1368"></a><span id="l30.1368" class="difflineminus">-                let absoluteTime = reminderTag.getAttribute(&quot;absoluteTime&quot;);</span>
<a href="#l30.1369"></a><span id="l30.1369" class="difflineminus">-                if (absoluteTime) {</span>
<a href="#l30.1370"></a><span id="l30.1370" class="difflineminus">-                    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l30.1371"></a><span id="l30.1371" class="difflineminus">-                    alarm.alarmDate = cal.fromRFC3339(absoluteTime, aTimezone);</span>
<a href="#l30.1372"></a><span id="l30.1372" class="difflineplus">+        // attendees</span>
<a href="#l30.1373"></a><span id="l30.1373" class="difflineplus">+        item.removeAllAttendees();</span>
<a href="#l30.1374"></a><span id="l30.1374" class="difflineplus">+        if (aEntry.attendees) {</span>
<a href="#l30.1375"></a><span id="l30.1375" class="difflineplus">+            const statusMap = {</span>
<a href="#l30.1376"></a><span id="l30.1376" class="difflineplus">+                needsAction: &quot;NEEDS-ACTION&quot;,</span>
<a href="#l30.1377"></a><span id="l30.1377" class="difflineplus">+                declined: &quot;DECLINED&quot;,</span>
<a href="#l30.1378"></a><span id="l30.1378" class="difflineplus">+                tentative: &quot;TENTATIVE&quot;,</span>
<a href="#l30.1379"></a><span id="l30.1379" class="difflineplus">+                accepted: &quot;ACCEPTED&quot;</span>
<a href="#l30.1380"></a><span id="l30.1380" class="difflineplus">+            };</span>
<a href="#l30.1381"></a><span id="l30.1381" class="difflineplus">+            for each (let attendeeEntry in aEntry.attendees) {</span>
<a href="#l30.1382"></a><span id="l30.1382" class="difflineplus">+                let attendee = cal.createAttendee();</span>
<a href="#l30.1383"></a><span id="l30.1383" class="difflineplus">+                if (attendeeEntry.email) {</span>
<a href="#l30.1384"></a><span id="l30.1384" class="difflineplus">+                    attendee.id = &quot;mailto:&quot; + attendeeEntry.email;</span>
<a href="#l30.1385"></a><span id="l30.1385">                 } else {</span>
<a href="#l30.1386"></a><span id="l30.1386" class="difflineminus">-                    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l30.1387"></a><span id="l30.1387" class="difflineminus">-                    let alarmOffset = cal.createDuration();</span>
<a href="#l30.1388"></a><span id="l30.1388" class="difflineminus">-                    let days = reminderTag.getAttribute(&quot;days&quot;);</span>
<a href="#l30.1389"></a><span id="l30.1389" class="difflineminus">-                    let hours = reminderTag.getAttribute(&quot;hours&quot;);</span>
<a href="#l30.1390"></a><span id="l30.1390" class="difflineminus">-                    let minutes = reminderTag.getAttribute(&quot;minutes&quot;);</span>
<a href="#l30.1391"></a><span id="l30.1391" class="difflineplus">+                    attendee.id = &quot;urn:id:&quot; + attendeeEntry.id;</span>
<a href="#l30.1392"></a><span id="l30.1392" class="difflineplus">+                }</span>
<a href="#l30.1393"></a><span id="l30.1393" class="difflineplus">+                attendee.commonName = attendeeEntry.displayName;</span>
<a href="#l30.1394"></a><span id="l30.1394"> </span>
<a href="#l30.1395"></a><span id="l30.1395" class="difflineminus">-                    if (days) {</span>
<a href="#l30.1396"></a><span id="l30.1396" class="difflineminus">-                        alarmOffset.days = -days;</span>
<a href="#l30.1397"></a><span id="l30.1397" class="difflineminus">-                    } else if (hours) {</span>
<a href="#l30.1398"></a><span id="l30.1398" class="difflineminus">-                        alarmOffset.hours = -hours;</span>
<a href="#l30.1399"></a><span id="l30.1399" class="difflineminus">-                    } else if (minutes) {</span>
<a href="#l30.1400"></a><span id="l30.1400" class="difflineminus">-                        alarmOffset.minutes = -minutes;</span>
<a href="#l30.1401"></a><span id="l30.1401" class="difflineminus">-                    } else {</span>
<a href="#l30.1402"></a><span id="l30.1402" class="difflineminus">-                        // Invalid alarm, skip it</span>
<a href="#l30.1403"></a><span id="l30.1403" class="difflineminus">-                        continue;</span>
<a href="#l30.1404"></a><span id="l30.1404" class="difflineminus">-                    }</span>
<a href="#l30.1405"></a><span id="l30.1405" class="difflineminus">-                    alarmOffset.normalize();</span>
<a href="#l30.1406"></a><span id="l30.1406" class="difflineminus">-                    alarm.offset = alarmOffset;</span>
<a href="#l30.1407"></a><span id="l30.1407" class="difflineplus">+                if (attendeeEntry.optional) {</span>
<a href="#l30.1408"></a><span id="l30.1408" class="difflineplus">+                    attendee.role = &quot;OPT-PARTICIPANT&quot;;</span>
<a href="#l30.1409"></a><span id="l30.1409" class="difflineplus">+                } else {</span>
<a href="#l30.1410"></a><span id="l30.1410" class="difflineplus">+                    attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l30.1411"></a><span id="l30.1411">                 }</span>
<a href="#l30.1412"></a><span id="l30.1412" class="difflineminus">-                item.addAlarm(alarm);</span>
<a href="#l30.1413"></a><span id="l30.1413" class="difflineplus">+</span>
<a href="#l30.1414"></a><span id="l30.1414" class="difflineplus">+                attendee.participationStatus = statusMap[attendeeEntry.responseStatus];</span>
<a href="#l30.1415"></a><span id="l30.1415" class="difflineplus">+</span>
<a href="#l30.1416"></a><span id="l30.1416" class="difflineplus">+                if (attendeeEntry.resource) {</span>
<a href="#l30.1417"></a><span id="l30.1417" class="difflineplus">+                    attendee.userType = &quot;RESOURCE&quot;;</span>
<a href="#l30.1418"></a><span id="l30.1418" class="difflineplus">+                } else {</span>
<a href="#l30.1419"></a><span id="l30.1419" class="difflineplus">+                    attendee.userType = &quot;INDIVIDUAL&quot;;</span>
<a href="#l30.1420"></a><span id="l30.1420" class="difflineplus">+                }</span>
<a href="#l30.1421"></a><span id="l30.1421" class="difflineplus">+</span>
<a href="#l30.1422"></a><span id="l30.1422" class="difflineplus">+                item.addAttendee(attendee);</span>
<a href="#l30.1423"></a><span id="l30.1423">             }</span>
<a href="#l30.1424"></a><span id="l30.1424">         }</span>
<a href="#l30.1425"></a><span id="l30.1425"> </span>
<a href="#l30.1426"></a><span id="l30.1426" class="difflineminus">-        // gd:when</span>
<a href="#l30.1427"></a><span id="l30.1427" class="difflineminus">-        let recurrenceInfo = gdataXPathFirst(aXMLEntry, 'gd:recurrence/text()');</span>
<a href="#l30.1428"></a><span id="l30.1428" class="difflineminus">-        if (!recurrenceInfo || recurrenceInfo.length == 0) {</span>
<a href="#l30.1429"></a><span id="l30.1429" class="difflineminus">-            // If no recurrence information is given, then there will only be</span>
<a href="#l30.1430"></a><span id="l30.1430" class="difflineminus">-            // one gd:when tag. Otherwise, we will be parsing the startDate from</span>
<a href="#l30.1431"></a><span id="l30.1431" class="difflineminus">-            // the recurrence information.</span>
<a href="#l30.1432"></a><span id="l30.1432" class="difflineminus">-            item.startDate = cal.fromRFC3339(gdataXPathFirst(aXMLEntry, 'gd:when/@startTime'), aTimezone);</span>
<a href="#l30.1433"></a><span id="l30.1433" class="difflineminus">-            item.endDate = cal.fromRFC3339(gdataXPathFirst(aXMLEntry, 'gd:when/@endTime'), aTimezone);</span>
<a href="#l30.1434"></a><span id="l30.1434" class="difflineminus">-</span>
<a href="#l30.1435"></a><span id="l30.1435" class="difflineminus">-            if (!item.endDate) {</span>
<a href="#l30.1436"></a><span id="l30.1436" class="difflineminus">-                // We have a zero-duration event</span>
<a href="#l30.1437"></a><span id="l30.1437" class="difflineminus">-                item.endDate = item.startDate.clone();</span>
<a href="#l30.1438"></a><span id="l30.1438" class="difflineminus">-            }</span>
<a href="#l30.1439"></a><span id="l30.1439" class="difflineminus">-</span>
<a href="#l30.1440"></a><span id="l30.1440" class="difflineminus">-            // gd:reminder</span>
<a href="#l30.1441"></a><span id="l30.1441" class="difflineminus">-            parseReminders(gdataXPath(aXMLEntry, 'gd:when/gd:reminder'));</span>
<a href="#l30.1442"></a><span id="l30.1442" class="difflineminus">-        } else {</span>
<a href="#l30.1443"></a><span id="l30.1443" class="difflineminus">-            if (!item.recurrenceInfo) {</span>
<a href="#l30.1444"></a><span id="l30.1444" class="difflineminus">-                item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l30.1445"></a><span id="l30.1445" class="difflineminus">-            } else {</span>
<a href="#l30.1446"></a><span id="l30.1446" class="difflineminus">-                item.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l30.1447"></a><span id="l30.1447" class="difflineminus">-            }</span>
<a href="#l30.1448"></a><span id="l30.1448" class="difflineminus">-</span>
<a href="#l30.1449"></a><span id="l30.1449" class="difflineminus">-            // We don't really care about google's timezone info for</span>
<a href="#l30.1450"></a><span id="l30.1450" class="difflineminus">-            // now. This may change when bug 314339 is fixed. Split out</span>
<a href="#l30.1451"></a><span id="l30.1451" class="difflineminus">-            // the timezone information so we only have the first bit</span>
<a href="#l30.1452"></a><span id="l30.1452" class="difflineminus">-            let vevent = recurrenceInfo;</span>
<a href="#l30.1453"></a><span id="l30.1453" class="difflineminus">-            let splitpos = recurrenceInfo.indexOf(&quot;BEGIN:VTIMEZONE&quot;);</span>
<a href="#l30.1454"></a><span id="l30.1454" class="difflineminus">-            if (splitpos &gt; -1) {</span>
<a href="#l30.1455"></a><span id="l30.1455" class="difflineminus">-                // Sometimes (i.e if only DATE values are specified), no</span>
<a href="#l30.1456"></a><span id="l30.1456" class="difflineminus">-                // timezone info is contained. Only remove it if it shows up.</span>
<a href="#l30.1457"></a><span id="l30.1457" class="difflineminus">-                vevent = recurrenceInfo.substring(0, splitpos);</span>
<a href="#l30.1458"></a><span id="l30.1458" class="difflineminus">-            }</span>
<a href="#l30.1459"></a><span id="l30.1459" class="difflineminus">-</span>
<a href="#l30.1460"></a><span id="l30.1460" class="difflineminus">-            vevent = &quot;BEGIN:VEVENT\n&quot; + vevent + &quot;END:VEVENT&quot;;</span>
<a href="#l30.1461"></a><span id="l30.1461" class="difflineminus">-            let icsService = cal.getIcsService();</span>
<a href="#l30.1462"></a><span id="l30.1462" class="difflineplus">+        // reminders</span>
<a href="#l30.1463"></a><span id="l30.1463" class="difflineplus">+        item.clearAlarms();</span>
<a href="#l30.1464"></a><span id="l30.1464"> </span>
<a href="#l30.1465"></a><span id="l30.1465" class="difflineminus">-            let rootComp = icsService.parseICS(vevent, gdataTimezoneService);</span>
<a href="#l30.1466"></a><span id="l30.1466" class="difflineminus">-            let i = 0;</span>
<a href="#l30.1467"></a><span id="l30.1467" class="difflineminus">-            let hasRecurringRules = false;</span>
<a href="#l30.1468"></a><span id="l30.1468" class="difflineminus">-            for (let prop in cal.ical.propertyIterator(rootComp)) {</span>
<a href="#l30.1469"></a><span id="l30.1469" class="difflineminus">-               switch (prop.propertyName) {</span>
<a href="#l30.1470"></a><span id="l30.1470" class="difflineminus">-                    case &quot;EXDATE&quot;:</span>
<a href="#l30.1471"></a><span id="l30.1471" class="difflineminus">-                        let recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l30.1472"></a><span id="l30.1472" class="difflineminus">-                                      .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l30.1473"></a><span id="l30.1473" class="difflineminus">-                        try {</span>
<a href="#l30.1474"></a><span id="l30.1474" class="difflineminus">-                            recItem.icalProperty = prop;</span>
<a href="#l30.1475"></a><span id="l30.1475" class="difflineminus">-                            item.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l30.1476"></a><span id="l30.1476" class="difflineminus">-                            hasRecurringRules = true;</span>
<a href="#l30.1477"></a><span id="l30.1477" class="difflineminus">-                        } catch (e) {</span>
<a href="#l30.1478"></a><span id="l30.1478" class="difflineminus">-                            Components.utils.reportError(e);</span>
<a href="#l30.1479"></a><span id="l30.1479" class="difflineminus">-                        }</span>
<a href="#l30.1480"></a><span id="l30.1480" class="difflineminus">-                        break;</span>
<a href="#l30.1481"></a><span id="l30.1481" class="difflineminus">-                    case &quot;RRULE&quot;:</span>
<a href="#l30.1482"></a><span id="l30.1482" class="difflineminus">-                        let recRule = cal.createRecurrenceRule();</span>
<a href="#l30.1483"></a><span id="l30.1483" class="difflineminus">-                        try {</span>
<a href="#l30.1484"></a><span id="l30.1484" class="difflineminus">-                            recRule.icalProperty = prop;</span>
<a href="#l30.1485"></a><span id="l30.1485" class="difflineminus">-                            item.recurrenceInfo.appendRecurrenceItem(recRule);</span>
<a href="#l30.1486"></a><span id="l30.1486" class="difflineminus">-                            hasRecurringRules = true;</span>
<a href="#l30.1487"></a><span id="l30.1487" class="difflineminus">-                        } catch (e) {</span>
<a href="#l30.1488"></a><span id="l30.1488" class="difflineminus">-                            Components.utils.reportError(e);</span>
<a href="#l30.1489"></a><span id="l30.1489" class="difflineminus">-                        }</span>
<a href="#l30.1490"></a><span id="l30.1490" class="difflineminus">-                        break;</span>
<a href="#l30.1491"></a><span id="l30.1491" class="difflineminus">-                    case &quot;DTSTART&quot;:</span>
<a href="#l30.1492"></a><span id="l30.1492" class="difflineminus">-                        item.startDate = prop.valueAsDatetime;</span>
<a href="#l30.1493"></a><span id="l30.1493" class="difflineminus">-                        break;</span>
<a href="#l30.1494"></a><span id="l30.1494" class="difflineminus">-                    case &quot;DTEND&quot;:</span>
<a href="#l30.1495"></a><span id="l30.1495" class="difflineminus">-                        item.endDate = prop.valueAsDatetime;</span>
<a href="#l30.1496"></a><span id="l30.1496" class="difflineminus">-                        break;</span>
<a href="#l30.1497"></a><span id="l30.1497" class="difflineminus">-                }</span>
<a href="#l30.1498"></a><span id="l30.1498" class="difflineminus">-            }</span>
<a href="#l30.1499"></a><span id="l30.1499" class="difflineminus">-</span>
<a href="#l30.1500"></a><span id="l30.1500" class="difflineminus">-            if (!hasRecurringRules) {</span>
<a href="#l30.1501"></a><span id="l30.1501" class="difflineminus">-                // Sometimes Google gives us events that have &lt;gd:recurrence&gt;</span>
<a href="#l30.1502"></a><span id="l30.1502" class="difflineminus">-                // but contain no recurrence rules. Treat the event as a normal</span>
<a href="#l30.1503"></a><span id="l30.1503" class="difflineminus">-                // event. See gdata issue 353.</span>
<a href="#l30.1504"></a><span id="l30.1504" class="difflineminus">-                item.recurrenceInfo = null;</span>
<a href="#l30.1505"></a><span id="l30.1505" class="difflineminus">-            }</span>
<a href="#l30.1506"></a><span id="l30.1506" class="difflineminus">-</span>
<a href="#l30.1507"></a><span id="l30.1507" class="difflineminus">-            // gd:reminder (for recurring events)</span>
<a href="#l30.1508"></a><span id="l30.1508" class="difflineminus">-            // This element is supplied as a direct child to the &lt;entry&gt; element</span>
<a href="#l30.1509"></a><span id="l30.1509" class="difflineminus">-            // for recurring items.</span>
<a href="#l30.1510"></a><span id="l30.1510" class="difflineminus">-            parseReminders(gdataXPath(aXMLEntry, 'gd:reminder'));</span>
<a href="#l30.1511"></a><span id="l30.1511" class="difflineplus">+        if (aEntry.reminders &amp;&amp; aEntry.reminders.useDefault) {</span>
<a href="#l30.1512"></a><span id="l30.1512" class="difflineplus">+            aDefaultReminders.forEach(item.addAlarm, item);</span>
<a href="#l30.1513"></a><span id="l30.1513">         }</span>
<a href="#l30.1514"></a><span id="l30.1514"> </span>
<a href="#l30.1515"></a><span id="l30.1515" class="difflineminus">-        // gd:recurrenceException</span>
<a href="#l30.1516"></a><span id="l30.1516" class="difflineminus">-        let exceptions = gdataXPath(aXMLEntry, 'gd:recurrenceException[@specialized=&quot;true&quot;]/gd:entryLink/atom:entry');</span>
<a href="#l30.1517"></a><span id="l30.1517" class="difflineminus">-        for each (let exception in exceptions) {</span>
<a href="#l30.1518"></a><span id="l30.1518" class="difflineminus">-            // We only want specialized exceptions, mainly becuase I haven't</span>
<a href="#l30.1519"></a><span id="l30.1519" class="difflineminus">-            // quite found out if a non-specialized exception also corresponds</span>
<a href="#l30.1520"></a><span id="l30.1520" class="difflineminus">-            // to a normal exception as libical knows it.</span>
<a href="#l30.1521"></a><span id="l30.1521" class="difflineminus">-            let excItem = XMLEntryToItem(exception, aTimezone, aCalendar);</span>
<a href="#l30.1522"></a><span id="l30.1522" class="difflineminus">-</span>
<a href="#l30.1523"></a><span id="l30.1523" class="difflineminus">-            // Google uses the status field to reflect negative exceptions.</span>
<a href="#l30.1524"></a><span id="l30.1524" class="difflineminus">-            if (excItem.status == &quot;CANCELED&quot;) {</span>
<a href="#l30.1525"></a><span id="l30.1525" class="difflineminus">-                item.recurrenceInfo.removeOccurrenceAt(excItem.recurrenceId);</span>
<a href="#l30.1526"></a><span id="l30.1526" class="difflineminus">-            } else {</span>
<a href="#l30.1527"></a><span id="l30.1527" class="difflineminus">-                excItem.calendar = aCalendar.superCalendar;</span>
<a href="#l30.1528"></a><span id="l30.1528" class="difflineminus">-                item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l30.1529"></a><span id="l30.1529" class="difflineplus">+        if (aEntry.reminders &amp;&amp; aEntry.reminders.overrides) {</span>
<a href="#l30.1530"></a><span id="l30.1530" class="difflineplus">+            for each (let reminderEntry in aEntry.reminders.overrides) {</span>
<a href="#l30.1531"></a><span id="l30.1531" class="difflineplus">+                item.addAlarm(JSONToAlarm(reminderEntry));</span>
<a href="#l30.1532"></a><span id="l30.1532">             }</span>
<a href="#l30.1533"></a><span id="l30.1533">         }</span>
<a href="#l30.1534"></a><span id="l30.1534"> </span>
<a href="#l30.1535"></a><span id="l30.1535" class="difflineminus">-        // gd:extendedProperty (alarmLastAck)</span>
<a href="#l30.1536"></a><span id="l30.1536" class="difflineminus">-        item.alarmLastAck = cal.fromRFC3339(getExtendedProperty(&quot;X-MOZ-LASTACK&quot;), aTimezone);</span>
<a href="#l30.1537"></a><span id="l30.1537" class="difflineplus">+        // extendedProperty (alarmLastAck)</span>
<a href="#l30.1538"></a><span id="l30.1538" class="difflineplus">+        item.alarmLastAck = cal.fromRFC3339(privateProps[&quot;X-MOZ-LASTACK&quot;], aTimezone);</span>
<a href="#l30.1539"></a><span id="l30.1539"> </span>
<a href="#l30.1540"></a><span id="l30.1540" class="difflineminus">-        // gd:extendedProperty (snooze time)</span>
<a href="#l30.1541"></a><span id="l30.1541" class="difflineminus">-        let dtSnoozeTime = cal.fromRFC3339(getExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;), aTimezone);</span>
<a href="#l30.1542"></a><span id="l30.1542" class="difflineplus">+        // extendedProperty (snooze time)</span>
<a href="#l30.1543"></a><span id="l30.1543" class="difflineplus">+        let dtSnoozeTime = cal.fromRFC3339(privateProps[&quot;X-MOZ-SNOOZE-TIME&quot;], aTimezone);</span>
<a href="#l30.1544"></a><span id="l30.1544">         let snoozeProperty = (dtSnoozeTime ? dtSnoozeTime.icalString : null);</span>
<a href="#l30.1545"></a><span id="l30.1545">         item.setProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, snoozeProperty);</span>
<a href="#l30.1546"></a><span id="l30.1546"> </span>
<a href="#l30.1547"></a><span id="l30.1547" class="difflineminus">-        // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l30.1548"></a><span id="l30.1548" class="difflineplus">+        // extendedProperty (snooze recurring alarms)</span>
<a href="#l30.1549"></a><span id="l30.1549">         if (item.recurrenceInfo) {</span>
<a href="#l30.1550"></a><span id="l30.1550">             // Transform back the string into our snooze properties</span>
<a href="#l30.1551"></a><span id="l30.1551">             let snoozeObj;</span>
<a href="#l30.1552"></a><span id="l30.1552">             try {</span>
<a href="#l30.1553"></a><span id="l30.1553" class="difflineminus">-                let snoozeString = getExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;);</span>
<a href="#l30.1554"></a><span id="l30.1554" class="difflineplus">+                let snoozeString = privateProps[&quot;X-GOOGLE-SNOOZE-RECUR&quot;];</span>
<a href="#l30.1555"></a><span id="l30.1555">                 snoozeObj = JSON.parse(snoozeString);</span>
<a href="#l30.1556"></a><span id="l30.1556">             } catch (e) {</span>
<a href="#l30.1557"></a><span id="l30.1557">                 // Just swallow parsing errors, not so important.</span>
<a href="#l30.1558"></a><span id="l30.1558">             }</span>
<a href="#l30.1559"></a><span id="l30.1559"> </span>
<a href="#l30.1560"></a><span id="l30.1560">             if (snoozeObj) {</span>
<a href="#l30.1561"></a><span id="l30.1561">                 for (let rid in snoozeObj) {</span>
<a href="#l30.1562"></a><span id="l30.1562" class="difflineminus">-                    item.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + rid,</span>
<a href="#l30.1563"></a><span id="l30.1563" class="difflineminus">-                                     snoozeObj[rid]);</span>
<a href="#l30.1564"></a><span id="l30.1564" class="difflineplus">+                    item.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + rid, snoozeObj[rid]);</span>
<a href="#l30.1565"></a><span id="l30.1565">                 }</span>
<a href="#l30.1566"></a><span id="l30.1566">             }</span>
<a href="#l30.1567"></a><span id="l30.1567">         }</span>
<a href="#l30.1568"></a><span id="l30.1568"> </span>
<a href="#l30.1569"></a><span id="l30.1569" class="difflineminus">-        // gd:where</span>
<a href="#l30.1570"></a><span id="l30.1570" class="difflineminus">-        item.setProperty(&quot;LOCATION&quot;, gdataXPathFirst(aXMLEntry, 'gd:where/@valueString'));</span>
<a href="#l30.1571"></a><span id="l30.1571" class="difflineminus">-</span>
<a href="#l30.1572"></a><span id="l30.1572" class="difflineminus">-        // gd:who</span>
<a href="#l30.1573"></a><span id="l30.1573" class="difflineminus">-        if (Preferences.get(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l30.1574"></a><span id="l30.1574" class="difflineminus">-            // XXX Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l30.1575"></a><span id="l30.1575" class="difflineminus">-</span>
<a href="#l30.1576"></a><span id="l30.1576" class="difflineminus">-            // This object can easily translate Google's values to our values.</span>
<a href="#l30.1577"></a><span id="l30.1577" class="difflineminus">-            const attendeeStatusMap = {</span>
<a href="#l30.1578"></a><span id="l30.1578" class="difflineminus">-                // role</span>
<a href="#l30.1579"></a><span id="l30.1579" class="difflineminus">-                &quot;event.optional&quot;: &quot;OPT-PARTICIPANT&quot;,</span>
<a href="#l30.1580"></a><span id="l30.1580" class="difflineminus">-                &quot;event.required&quot;: &quot;REQ-PARTICIPANT&quot;,</span>
<a href="#l30.1581"></a><span id="l30.1581" class="difflineminus">-</span>
<a href="#l30.1582"></a><span id="l30.1582" class="difflineminus">-                // Participation Statii</span>
<a href="#l30.1583"></a><span id="l30.1583" class="difflineminus">-                &quot;event.accepted&quot;: &quot;ACCEPTED&quot;,</span>
<a href="#l30.1584"></a><span id="l30.1584" class="difflineminus">-                &quot;event.declined&quot;: &quot;DECLINED&quot;,</span>
<a href="#l30.1585"></a><span id="l30.1585" class="difflineminus">-                &quot;event.invited&quot;: &quot;NEEDS-ACTION&quot;,</span>
<a href="#l30.1586"></a><span id="l30.1586" class="difflineminus">-                &quot;event.tentative&quot;: &quot;TENTATIVE&quot;</span>
<a href="#l30.1587"></a><span id="l30.1587" class="difflineminus">-            };</span>
<a href="#l30.1588"></a><span id="l30.1588" class="difflineminus">-</span>
<a href="#l30.1589"></a><span id="l30.1589" class="difflineminus">-            // Clear all attendees in case a reference item was passed</span>
<a href="#l30.1590"></a><span id="l30.1590" class="difflineminus">-            item.removeAllAttendees();</span>
<a href="#l30.1591"></a><span id="l30.1591" class="difflineminus">-</span>
<a href="#l30.1592"></a><span id="l30.1592" class="difflineminus">-            // Iterate all attendee tags.</span>
<a href="#l30.1593"></a><span id="l30.1593" class="difflineminus">-            for each (let who in gdataXPath(aXMLEntry, 'gd:who')) {</span>
<a href="#l30.1594"></a><span id="l30.1594" class="difflineminus">-                let attendee = cal.createAttendee();</span>
<a href="#l30.1595"></a><span id="l30.1595" class="difflineminus">-                let rel = who.getAttribute(&quot;rel&quot;).substring(33);</span>
<a href="#l30.1596"></a><span id="l30.1596" class="difflineminus">-                let type = gdataXPathFirst(who, 'gd:attendeeType/@value').substring(33);</span>
<a href="#l30.1597"></a><span id="l30.1597" class="difflineminus">-                let status = gdataXPathFirst(who, 'gd:attendeeStatus/@value').substring(33);</span>
<a href="#l30.1598"></a><span id="l30.1598" class="difflineminus">-</span>
<a href="#l30.1599"></a><span id="l30.1599" class="difflineminus">-                attendee.id = &quot;mailto:&quot; + who.getAttribute(&quot;email&quot;)</span>
<a href="#l30.1600"></a><span id="l30.1600" class="difflineminus">-                attendee.commonName = who.getAttribute(&quot;valueString&quot;);</span>
<a href="#l30.1601"></a><span id="l30.1601" class="difflineminus">-                attendee.rsvp = &quot;FALSE&quot;;</span>
<a href="#l30.1602"></a><span id="l30.1602" class="difflineminus">-                attendee.userType = &quot;INDIVIDUAL&quot;;</span>
<a href="#l30.1603"></a><span id="l30.1603" class="difflineminus">-                attendee.isOrganizer = (rel == &quot;event.organizer&quot;);</span>
<a href="#l30.1604"></a><span id="l30.1604" class="difflineminus">-                attendee.participationStatus = attendeeStatusMap[status];</span>
<a href="#l30.1605"></a><span id="l30.1605" class="difflineminus">-                attendee.role = attendeeStatusMap[type]</span>
<a href="#l30.1606"></a><span id="l30.1606" class="difflineminus">-                attendee.makeImmutable();</span>
<a href="#l30.1607"></a><span id="l30.1607" class="difflineminus">-</span>
<a href="#l30.1608"></a><span id="l30.1608" class="difflineminus">-                if (attendee.isOrganizer) {</span>
<a href="#l30.1609"></a><span id="l30.1609" class="difflineminus">-                    item.organizer = attendee;</span>
<a href="#l30.1610"></a><span id="l30.1610" class="difflineminus">-                } else {</span>
<a href="#l30.1611"></a><span id="l30.1611" class="difflineminus">-                    item.addAttendee(attendee);</span>
<a href="#l30.1612"></a><span id="l30.1612" class="difflineminus">-                }</span>
<a href="#l30.1613"></a><span id="l30.1613" class="difflineminus">-            }</span>
<a href="#l30.1614"></a><span id="l30.1614" class="difflineminus">-        }</span>
<a href="#l30.1615"></a><span id="l30.1615" class="difflineminus">-</span>
<a href="#l30.1616"></a><span id="l30.1616" class="difflineminus">-        // gd:originalEvent</span>
<a href="#l30.1617"></a><span id="l30.1617" class="difflineminus">-        item.recurrenceId = getRecurrenceIdFromEntry(aXMLEntry, aTimezone);</span>
<a href="#l30.1618"></a><span id="l30.1618" class="difflineminus">-</span>
<a href="#l30.1619"></a><span id="l30.1619" class="difflineminus">-        // gd:visibility</span>
<a href="#l30.1620"></a><span id="l30.1620" class="difflineminus">-        item.privacy = gdataXPathFirst(aXMLEntry, &quot;gd:visibility/@value&quot;).substring(39).toUpperCase();</span>
<a href="#l30.1621"></a><span id="l30.1621" class="difflineminus">-</span>
<a href="#l30.1622"></a><span id="l30.1622" class="difflineminus">-        // category</span>
<a href="#l30.1623"></a><span id="l30.1623">         // Google does not support categories natively, but allows us to store</span>
<a href="#l30.1624"></a><span id="l30.1624">         // data as an &quot;extendedProperty&quot;, and here it's going to be retrieved</span>
<a href="#l30.1625"></a><span id="l30.1625">         // again</span>
<a href="#l30.1626"></a><span id="l30.1626" class="difflineminus">-        let categories = cal.categoriesStringToArray(getExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;));</span>
<a href="#l30.1627"></a><span id="l30.1627" class="difflineplus">+        let categories = cal.categoriesStringToArray(sharedProps[&quot;X-MOZ-CATEGORIES&quot;]);</span>
<a href="#l30.1628"></a><span id="l30.1628">         item.setCategories(categories.length, categories);</span>
<a href="#l30.1629"></a><span id="l30.1629"> </span>
<a href="#l30.1630"></a><span id="l30.1630" class="difflineminus">-        // published</span>
<a href="#l30.1631"></a><span id="l30.1631" class="difflineminus">-        let createdText = gdataXPathFirst(aXMLEntry, 'atom:published/text()');</span>
<a href="#l30.1632"></a><span id="l30.1632" class="difflineminus">-        item.setProperty(&quot;CREATED&quot;, cal.fromRFC3339(createdText, aTimezone).getInTimezone(cal.UTC()));</span>
<a href="#l30.1633"></a><span id="l30.1633" class="difflineminus">-</span>
<a href="#l30.1634"></a><span id="l30.1634">         // updated (This must be set last!)</span>
<a href="#l30.1635"></a><span id="l30.1635" class="difflineminus">-        let lastmodText = gdataXPathFirst(aXMLEntry, 'atom:updated/text()');</span>
<a href="#l30.1636"></a><span id="l30.1636" class="difflineminus">-        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(lastmodText, aTimezone).getInTimezone(cal.UTC()));</span>
<a href="#l30.1637"></a><span id="l30.1637" class="difflineminus">-</span>
<a href="#l30.1638"></a><span id="l30.1638" class="difflineminus">-        // XXX Google currently has no priority support. See</span>
<a href="#l30.1639"></a><span id="l30.1639" class="difflineminus">-        // http://code.google.com/p/google-gdata/issues/detail?id=52</span>
<a href="#l30.1640"></a><span id="l30.1640" class="difflineminus">-        // for details.</span>
<a href="#l30.1641"></a><span id="l30.1641" class="difflineplus">+        if (aEntry.updated) {</span>
<a href="#l30.1642"></a><span id="l30.1642" class="difflineplus">+            let updated = cal.fromRFC3339(aEntry.updated, aTimezone).getInTimezone(cal.UTC());</span>
<a href="#l30.1643"></a><span id="l30.1643" class="difflineplus">+            item.setProperty(&quot;DTSTAMP&quot;, updated);</span>
<a href="#l30.1644"></a><span id="l30.1644" class="difflineplus">+            item.setProperty(&quot;LAST-MODIFIED&quot;, updated);</span>
<a href="#l30.1645"></a><span id="l30.1645" class="difflineplus">+        }</span>
<a href="#l30.1646"></a><span id="l30.1646">     } catch (e) {</span>
<a href="#l30.1647"></a><span id="l30.1647" class="difflineminus">-        cal.ERROR(&quot;Error parsing XML stream&quot; + e);</span>
<a href="#l30.1648"></a><span id="l30.1648" class="difflineplus">+        cal.ERROR(stringException(e));</span>
<a href="#l30.1649"></a><span id="l30.1649">         throw e;</span>
<a href="#l30.1650"></a><span id="l30.1650">     }</span>
<a href="#l30.1651"></a><span id="l30.1651">     return item;</span>
<a href="#l30.1652"></a><span id="l30.1652"> }</span>
<a href="#l30.1653"></a><span id="l30.1653"> </span>
<a href="#l30.1654"></a><span id="l30.1654"> /**</span>
<a href="#l30.1655"></a><span id="l30.1655" class="difflineminus">- * Expand an item to occurrences, if the operation's item filter requests it.</span>
<a href="#l30.1656"></a><span id="l30.1656" class="difflineminus">- * Otherwise returns the item in an array.</span>
<a href="#l30.1657"></a><span id="l30.1657" class="difflineplus">+ * Converts a JS Object representing the task to a calITodo.</span>
<a href="#l30.1658"></a><span id="l30.1658">  *</span>
<a href="#l30.1659"></a><span id="l30.1659" class="difflineminus">- * @param aItem         The item to expand</span>
<a href="#l30.1660"></a><span id="l30.1660" class="difflineminus">- * @param aOperation    The calIGoogleRequest that contains the filter and</span>
<a href="#l30.1661"></a><span id="l30.1661" class="difflineminus">- *                        ranges.</span>
<a href="#l30.1662"></a><span id="l30.1662" class="difflineminus">- * @return              The (possibly expanded) items in an array.</span>
<a href="#l30.1663"></a><span id="l30.1663" class="difflineplus">+ * @param aEntry            The JS Object representation of the item.</span>
<a href="#l30.1664"></a><span id="l30.1664" class="difflineplus">+ * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l30.1665"></a><span id="l30.1665" class="difflineplus">+ * @param aTimezone         The Timezone the task is most likely in.</span>
<a href="#l30.1666"></a><span id="l30.1666" class="difflineplus">+ * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l30.1667"></a><span id="l30.1667" class="difflineplus">+ * @return                  The calITodo with the item data.</span>
<a href="#l30.1668"></a><span id="l30.1668">  */</span>
<a href="#l30.1669"></a><span id="l30.1669" class="difflineminus">-function expandItems(aItem, aOperation) {</span>
<a href="#l30.1670"></a><span id="l30.1670" class="difflineminus">-    let expandedItems;</span>
<a href="#l30.1671"></a><span id="l30.1671" class="difflineminus">-    if (aOperation.itemFilter &amp;</span>
<a href="#l30.1672"></a><span id="l30.1672" class="difflineminus">-        Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) {</span>
<a href="#l30.1673"></a><span id="l30.1673" class="difflineminus">-        expandedItems = aItem.getOccurrencesBetween(aOperation.itemRangeStart,</span>
<a href="#l30.1674"></a><span id="l30.1674" class="difflineminus">-                                                    aOperation.itemRangeEnd,</span>
<a href="#l30.1675"></a><span id="l30.1675" class="difflineminus">-                                                    {});</span>
<a href="#l30.1676"></a><span id="l30.1676" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Expanded item &quot; + aItem.title + &quot; to &quot; +</span>
<a href="#l30.1677"></a><span id="l30.1677" class="difflineminus">-                expandedItems.length + &quot; items&quot;);</span>
<a href="#l30.1678"></a><span id="l30.1678" class="difflineplus">+function JSONToTask(aEntry, aCalendar, aTimezone, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l30.1679"></a><span id="l30.1679" class="difflineplus">+    aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l30.1680"></a><span id="l30.1680" class="difflineplus">+    aMetadata = aMetadata || {};</span>
<a href="#l30.1681"></a><span id="l30.1681" class="difflineplus">+    if (!aEntry || !(&quot;kind&quot; in aEntry) || aEntry.kind != &quot;tasks#task&quot;) {</span>
<a href="#l30.1682"></a><span id="l30.1682" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Attempt to decode invalid task: &quot; +</span>
<a href="#l30.1683"></a><span id="l30.1683" class="difflineplus">+                  (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;)));</span>
<a href="#l30.1684"></a><span id="l30.1684" class="difflineplus">+        return null;</span>
<a href="#l30.1685"></a><span id="l30.1685">     }</span>
<a href="#l30.1686"></a><span id="l30.1686" class="difflineminus">-    return expandedItems || [aItem];</span>
<a href="#l30.1687"></a><span id="l30.1687" class="difflineplus">+    let item = cal.createTodo();</span>
<a href="#l30.1688"></a><span id="l30.1688" class="difflineplus">+    item.calendar = aCalendar.superCalendar;</span>
<a href="#l30.1689"></a><span id="l30.1689" class="difflineplus">+    try {</span>
<a href="#l30.1690"></a><span id="l30.1690" class="difflineplus">+        item.id = aEntry.id;</span>
<a href="#l30.1691"></a><span id="l30.1691" class="difflineplus">+        item.title = aEntry.title || &quot;&quot;;</span>
<a href="#l30.1692"></a><span id="l30.1692" class="difflineplus">+        item.setProperty(&quot;DESCRIPTION&quot;, aEntry.notes);</span>
<a href="#l30.1693"></a><span id="l30.1693" class="difflineplus">+        item.setProperty(&quot;X-GOOGLE-SORTKEY&quot;, aEntry.position);</span>
<a href="#l30.1694"></a><span id="l30.1694" class="difflineplus">+        item.isCompleted = (aEntry.status == &quot;completed&quot;);</span>
<a href="#l30.1695"></a><span id="l30.1695" class="difflineplus">+</span>
<a href="#l30.1696"></a><span id="l30.1696" class="difflineplus">+        aMetadata.etag = aEntry.etag;</span>
<a href="#l30.1697"></a><span id="l30.1697" class="difflineplus">+        aMetadata.path = aEntry.id;</span>
<a href="#l30.1698"></a><span id="l30.1698" class="difflineplus">+</span>
<a href="#l30.1699"></a><span id="l30.1699" class="difflineplus">+        // Google Tasks don't have a due time, but still use 0:00 UTC. They</span>
<a href="#l30.1700"></a><span id="l30.1700" class="difflineplus">+        // should really be using floating time.</span>
<a href="#l30.1701"></a><span id="l30.1701" class="difflineplus">+        item.dueDate = cal.fromRFC3339(aEntry.due, cal.floating())</span>
<a href="#l30.1702"></a><span id="l30.1702" class="difflineplus">+        if (item.dueDate) {</span>
<a href="#l30.1703"></a><span id="l30.1703" class="difflineplus">+            item.dueDate.timezone = cal.floating();</span>
<a href="#l30.1704"></a><span id="l30.1704" class="difflineplus">+            item.dueDate.isDate = true;</span>
<a href="#l30.1705"></a><span id="l30.1705" class="difflineplus">+        }</span>
<a href="#l30.1706"></a><span id="l30.1706" class="difflineplus">+        item.completedDate = cal.fromRFC3339(aEntry.completed, aTimezone);</span>
<a href="#l30.1707"></a><span id="l30.1707" class="difflineplus">+        if (aEntry.deleted) {</span>
<a href="#l30.1708"></a><span id="l30.1708" class="difflineplus">+            item.status = &quot;CANCELLED&quot;;</span>
<a href="#l30.1709"></a><span id="l30.1709" class="difflineplus">+        } else if (aEntry.status == &quot;needsAction&quot;) {</span>
<a href="#l30.1710"></a><span id="l30.1710" class="difflineplus">+            item.status = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l30.1711"></a><span id="l30.1711" class="difflineplus">+        } else {</span>
<a href="#l30.1712"></a><span id="l30.1712" class="difflineplus">+            item.status = &quot;COMPLETED&quot;;</span>
<a href="#l30.1713"></a><span id="l30.1713" class="difflineplus">+        }</span>
<a href="#l30.1714"></a><span id="l30.1714" class="difflineplus">+</span>
<a href="#l30.1715"></a><span id="l30.1715" class="difflineplus">+        if (aEntry.parent) {</span>
<a href="#l30.1716"></a><span id="l30.1716" class="difflineplus">+            let relation = cal.createRelation();</span>
<a href="#l30.1717"></a><span id="l30.1717" class="difflineplus">+            relation.relType = &quot;PARENT&quot;;</span>
<a href="#l30.1718"></a><span id="l30.1718" class="difflineplus">+            relation.relId = aEntry.parent;</span>
<a href="#l30.1719"></a><span id="l30.1719" class="difflineplus">+            item.addRelation(relation);</span>
<a href="#l30.1720"></a><span id="l30.1720" class="difflineplus">+        }</span>
<a href="#l30.1721"></a><span id="l30.1721" class="difflineplus">+</span>
<a href="#l30.1722"></a><span id="l30.1722" class="difflineplus">+        if (aEntry.links) {</span>
<a href="#l30.1723"></a><span id="l30.1723" class="difflineplus">+            for each (let link in aEntry.links) {</span>
<a href="#l30.1724"></a><span id="l30.1724" class="difflineplus">+                let attach = cal.createAttachment();</span>
<a href="#l30.1725"></a><span id="l30.1725" class="difflineplus">+                attach.uri = Services.io.newURI(link.link, null, null);</span>
<a href="#l30.1726"></a><span id="l30.1726" class="difflineplus">+                attach.setParameter(&quot;FILENAME&quot;, link.description);</span>
<a href="#l30.1727"></a><span id="l30.1727" class="difflineplus">+                attach.setParameter(&quot;X-GOOGLE-TYPE&quot;, link.type);</span>
<a href="#l30.1728"></a><span id="l30.1728" class="difflineplus">+                item.addAttachment(attach);</span>
<a href="#l30.1729"></a><span id="l30.1729" class="difflineplus">+            }</span>
<a href="#l30.1730"></a><span id="l30.1730" class="difflineplus">+        }</span>
<a href="#l30.1731"></a><span id="l30.1731" class="difflineplus">+</span>
<a href="#l30.1732"></a><span id="l30.1732" class="difflineplus">+        // updated (This must be set last!)</span>
<a href="#l30.1733"></a><span id="l30.1733" class="difflineplus">+        item.setProperty(&quot;DTSTAMP&quot;, cal.fromRFC3339(aEntry.updated, aTimezone).getInTimezone(cal.UTC()));</span>
<a href="#l30.1734"></a><span id="l30.1734" class="difflineplus">+        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(aEntry.updated, aTimezone).getInTimezone(cal.UTC()));</span>
<a href="#l30.1735"></a><span id="l30.1735" class="difflineplus">+    } catch (e) {</span>
<a href="#l30.1736"></a><span id="l30.1736" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Error parsing JSON tasks stream: &quot; + stringException(e));</span>
<a href="#l30.1737"></a><span id="l30.1737" class="difflineplus">+        throw e;</span>
<a href="#l30.1738"></a><span id="l30.1738" class="difflineplus">+    }</span>
<a href="#l30.1739"></a><span id="l30.1739" class="difflineplus">+</span>
<a href="#l30.1740"></a><span id="l30.1740" class="difflineplus">+    return item;</span>
<a href="#l30.1741"></a><span id="l30.1741"> }</span>
<a href="#l30.1742"></a><span id="l30.1742"> </span>
<a href="#l30.1743"></a><span id="l30.1743"> /**</span>
<a href="#l30.1744"></a><span id="l30.1744" class="difflineminus">- * Returns true if the exception passed is one that should cause the cache</span>
<a href="#l30.1745"></a><span id="l30.1745" class="difflineminus">- * layer to retry the operation. This is usually a network error or other</span>
<a href="#l30.1746"></a><span id="l30.1746" class="difflineminus">- * temporary error</span>
<a href="#l30.1747"></a><span id="l30.1747" class="difflineplus">+ * Convenience function to convert any JSON reply (task/event) to a calendar</span>
<a href="#l30.1748"></a><span id="l30.1748" class="difflineplus">+ * item.</span>
<a href="#l30.1749"></a><span id="l30.1749">  *</span>
<a href="#l30.1750"></a><span id="l30.1750" class="difflineminus">- * @param e     The exception to check</span>
<a href="#l30.1751"></a><span id="l30.1751" class="difflineplus">+ * @param aEntry            The JS Object representation of the item.</span>
<a href="#l30.1752"></a><span id="l30.1752" class="difflineplus">+ * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l30.1753"></a><span id="l30.1753" class="difflineplus">+ * @param aTimezone         The Timezone the task is most likely in.</span>
<a href="#l30.1754"></a><span id="l30.1754" class="difflineplus">+ * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l30.1755"></a><span id="l30.1755" class="difflineplus">+ * @return                  The specialized calIItemBase with the item data.</span>
<a href="#l30.1756"></a><span id="l30.1756">  */</span>
<a href="#l30.1757"></a><span id="l30.1757" class="difflineminus">-function isCacheException(e) {</span>
<a href="#l30.1758"></a><span id="l30.1758" class="difflineminus">-    // Stolen from nserror.h</span>
<a href="#l30.1759"></a><span id="l30.1759" class="difflineminus">-    const NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l30.1760"></a><span id="l30.1760" class="difflineminus">-    function NS_ERROR_GET_MODULE(code) {</span>
<a href="#l30.1761"></a><span id="l30.1761" class="difflineminus">-        return (((code &gt;&gt; 16) - 0x45) &amp; 0x1fff);</span>
<a href="#l30.1762"></a><span id="l30.1762" class="difflineminus">-    }</span>
<a href="#l30.1763"></a><span id="l30.1763" class="difflineminus">-</span>
<a href="#l30.1764"></a><span id="l30.1764" class="difflineminus">-    if (NS_ERROR_GET_MODULE(e.result) == NS_ERROR_MODULE_NETWORK &amp;&amp;</span>
<a href="#l30.1765"></a><span id="l30.1765" class="difflineminus">-        !Components.isSuccessCode(e.result)) {</span>
<a href="#l30.1766"></a><span id="l30.1766" class="difflineminus">-        // This is a network error, which most likely means we should</span>
<a href="#l30.1767"></a><span id="l30.1767" class="difflineminus">-        // retry it some time.</span>
<a href="#l30.1768"></a><span id="l30.1768" class="difflineminus">-        return true;</span>
<a href="#l30.1769"></a><span id="l30.1769" class="difflineminus">-    }</span>
<a href="#l30.1770"></a><span id="l30.1770" class="difflineminus">-</span>
<a href="#l30.1771"></a><span id="l30.1771" class="difflineminus">-    // Other potential errors we want to retry with</span>
<a href="#l30.1772"></a><span id="l30.1772" class="difflineminus">-    switch (e.result) {</span>
<a href="#l30.1773"></a><span id="l30.1773" class="difflineminus">-        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l30.1774"></a><span id="l30.1774" class="difflineminus">-            return true;</span>
<a href="#l30.1775"></a><span id="l30.1775" class="difflineminus">-        default:</span>
<a href="#l30.1776"></a><span id="l30.1776" class="difflineminus">-            return false;</span>
<a href="#l30.1777"></a><span id="l30.1777" class="difflineplus">+function JSONToItem(aEntry, aCalendar, aTimezone, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l30.1778"></a><span id="l30.1778" class="difflineplus">+    aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l30.1779"></a><span id="l30.1779" class="difflineplus">+    aMetadata = aMetadata || {};</span>
<a href="#l30.1780"></a><span id="l30.1780" class="difflineplus">+    if (aEntry.kind == &quot;tasks#task&quot;) {</span>
<a href="#l30.1781"></a><span id="l30.1781" class="difflineplus">+        return JSONToTask.apply(null, arguments);</span>
<a href="#l30.1782"></a><span id="l30.1782" class="difflineplus">+    } else if (aEntry.kind = &quot;calendar#event&quot;) {</span>
<a href="#l30.1783"></a><span id="l30.1783" class="difflineplus">+        return JSONToEvent.apply(null, arguments);</span>
<a href="#l30.1784"></a><span id="l30.1784" class="difflineplus">+    } else {</span>
<a href="#l30.1785"></a><span id="l30.1785" class="difflineplus">+        cal.ERROR(&quot;[calGoogleCalendar] Invalid item type: &quot; + aData.kind);</span>
<a href="#l30.1786"></a><span id="l30.1786" class="difflineplus">+        return null;</span>
<a href="#l30.1787"></a><span id="l30.1787">     }</span>
<a href="#l30.1788"></a><span id="l30.1788"> }</span>
<a href="#l30.1789"></a><span id="l30.1789"> </span>
<a href="#l30.1790"></a><span id="l30.1790"> /**</span>
<a href="#l30.1791"></a><span id="l30.1791" class="difflineminus">- * Helper prototype to set a certain variable to the first item passed via get</span>
<a href="#l30.1792"></a><span id="l30.1792" class="difflineminus">- * listener. Cleans up code.</span>
<a href="#l30.1793"></a><span id="l30.1793" class="difflineplus">+ * Save items spread over multiple pages to the calendar's offline storage.</span>
<a href="#l30.1794"></a><span id="l30.1794" class="difflineplus">+ *</span>
<a href="#l30.1795"></a><span id="l30.1795" class="difflineplus">+ * @param aCalendar     The calendar the events belong to.</span>
<a href="#l30.1796"></a><span id="l30.1796">  */</span>
<a href="#l30.1797"></a><span id="l30.1797" class="difflineminus">-function syncSetter(aObj) {</span>
<a href="#l30.1798"></a><span id="l30.1798" class="difflineminus">-    this.mObj = aObj</span>
<a href="#l30.1799"></a><span id="l30.1799" class="difflineplus">+function ItemSaver(aCalendar) {</span>
<a href="#l30.1800"></a><span id="l30.1800" class="difflineplus">+    this.calendar = aCalendar;</span>
<a href="#l30.1801"></a><span id="l30.1801" class="difflineplus">+    this.offlineStorage = this.calendar.offlineStorage;</span>
<a href="#l30.1802"></a><span id="l30.1802" class="difflineplus">+    this.promiseOfflineStorage = promisifyCalendar(this.calendar.offlineStorage);</span>
<a href="#l30.1803"></a><span id="l30.1803" class="difflineplus">+    this.missingParents = [];</span>
<a href="#l30.1804"></a><span id="l30.1804" class="difflineplus">+    this.masterItems = Object.create(null);</span>
<a href="#l30.1805"></a><span id="l30.1805" class="difflineplus">+    this.metaData = Object.create(null);</span>
<a href="#l30.1806"></a><span id="l30.1806"> }</span>
<a href="#l30.1807"></a><span id="l30.1807" class="difflineminus">-syncSetter.prototype = {</span>
<a href="#l30.1808"></a><span id="l30.1808" class="difflineplus">+ItemSaver.prototype = {</span>
<a href="#l30.1809"></a><span id="l30.1809" class="difflineplus">+    masterItems: null,</span>
<a href="#l30.1810"></a><span id="l30.1810" class="difflineplus">+    missingParents: null,</span>
<a href="#l30.1811"></a><span id="l30.1811" class="difflineplus">+</span>
<a href="#l30.1812"></a><span id="l30.1812" class="difflineplus">+    /**</span>
<a href="#l30.1813"></a><span id="l30.1813" class="difflineplus">+     * Convenience function to apply a list of items (task/event) in JSON form to</span>
<a href="#l30.1814"></a><span id="l30.1814" class="difflineplus">+     * the given calendar.</span>
<a href="#l30.1815"></a><span id="l30.1815" class="difflineplus">+     *</span>
<a href="#l30.1816"></a><span id="l30.1816" class="difflineplus">+     * @param aData         The JS Object from the list response.</span>
<a href="#l30.1817"></a><span id="l30.1817" class="difflineplus">+     * @return              A promise resolved when completed.</span>
<a href="#l30.1818"></a><span id="l30.1818" class="difflineplus">+     */</span>
<a href="#l30.1819"></a><span id="l30.1819" class="difflineplus">+    parseItemStream: function(aData) {</span>
<a href="#l30.1820"></a><span id="l30.1820" class="difflineplus">+        if (aData.kind == &quot;calendar#events&quot;) {</span>
<a href="#l30.1821"></a><span id="l30.1821" class="difflineplus">+            return this.parseEventStream(aData);</span>
<a href="#l30.1822"></a><span id="l30.1822" class="difflineplus">+        } else if (aData.kind == &quot;tasks#tasks&quot;) {</span>
<a href="#l30.1823"></a><span id="l30.1823" class="difflineplus">+            return this.parseTaskStream(aData);</span>
<a href="#l30.1824"></a><span id="l30.1824" class="difflineplus">+        } else {</span>
<a href="#l30.1825"></a><span id="l30.1825" class="difflineplus">+            let message = &quot;Invalid Stream type: &quot; + (aData ? aData.kind || aData.toSource() : null);</span>
<a href="#l30.1826"></a><span id="l30.1826" class="difflineplus">+            throw new Components.Exception(message, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l30.1827"></a><span id="l30.1827" class="difflineplus">+        }</span>
<a href="#l30.1828"></a><span id="l30.1828" class="difflineplus">+    },</span>
<a href="#l30.1829"></a><span id="l30.1829"> </span>
<a href="#l30.1830"></a><span id="l30.1830" class="difflineminus">-    onGetResult: function syncSetter_onGetResult(aCal,</span>
<a href="#l30.1831"></a><span id="l30.1831" class="difflineminus">-                                                 aStatus,</span>
<a href="#l30.1832"></a><span id="l30.1832" class="difflineminus">-                                                 aIID,</span>
<a href="#l30.1833"></a><span id="l30.1833" class="difflineminus">-                                                 aDetail,</span>
<a href="#l30.1834"></a><span id="l30.1834" class="difflineminus">-                                                 aCount,</span>
<a href="#l30.1835"></a><span id="l30.1835" class="difflineminus">-                                                 aItems) {</span>
<a href="#l30.1836"></a><span id="l30.1836" class="difflineminus">-        this.mObj.value = aItems[0];</span>
<a href="#l30.1837"></a><span id="l30.1837" class="difflineplus">+    /**</span>
<a href="#l30.1838"></a><span id="l30.1838" class="difflineplus">+     * Parse the response from Google's list command into tasks and modify the</span>
<a href="#l30.1839"></a><span id="l30.1839" class="difflineplus">+     * calendar's offline storage to reflect those changes.</span>
<a href="#l30.1840"></a><span id="l30.1840" class="difflineplus">+     *</span>
<a href="#l30.1841"></a><span id="l30.1841" class="difflineplus">+     * @param aData         The JS Object from the list response.</span>
<a href="#l30.1842"></a><span id="l30.1842" class="difflineplus">+     * @return              A promise resolved when completed.</span>
<a href="#l30.1843"></a><span id="l30.1843" class="difflineplus">+     */</span>
<a href="#l30.1844"></a><span id="l30.1844" class="difflineplus">+    parseTaskStream: function(aData) {</span>
<a href="#l30.1845"></a><span id="l30.1845" class="difflineplus">+        return Task.spawn(function() {</span>
<a href="#l30.1846"></a><span id="l30.1846" class="difflineplus">+            if (!aData.items || !aData.items.length) {</span>
<a href="#l30.1847"></a><span id="l30.1847" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] No tasks have been changed on &quot; + this.calendar.name);</span>
<a href="#l30.1848"></a><span id="l30.1848" class="difflineplus">+            } else {</span>
<a href="#l30.1849"></a><span id="l30.1849" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received tasks&quot;);</span>
<a href="#l30.1850"></a><span id="l30.1850" class="difflineplus">+                let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l30.1851"></a><span id="l30.1851" class="difflineplus">+</span>
<a href="#l30.1852"></a><span id="l30.1852" class="difflineplus">+                let act = new ActivityShell(this.calendar, &quot;Task&quot;);</span>
<a href="#l30.1853"></a><span id="l30.1853" class="difflineplus">+                let total = aData.items.length;</span>
<a href="#l30.1854"></a><span id="l30.1854" class="difflineplus">+                for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l30.1855"></a><span id="l30.1855" class="difflineplus">+                    let entry = aData.items[cur];</span>
<a href="#l30.1856"></a><span id="l30.1856" class="difflineplus">+                    //let metaData = Object.create(null);</span>
<a href="#l30.1857"></a><span id="l30.1857" class="difflineplus">+                    let metaData = {};</span>
<a href="#l30.1858"></a><span id="l30.1858" class="difflineplus">+                    let item = JSONToTask(entry, this.calendar, defaultTimezone, null, null, metaData);</span>
<a href="#l30.1859"></a><span id="l30.1859" class="difflineplus">+                    this.metaData[item.hashId] = metaData;</span>
<a href="#l30.1860"></a><span id="l30.1860" class="difflineplus">+</span>
<a href="#l30.1861"></a><span id="l30.1861" class="difflineplus">+                    yield this.commitItem(item);</span>
<a href="#l30.1862"></a><span id="l30.1862" class="difflineplus">+</span>
<a href="#l30.1863"></a><span id="l30.1863" class="difflineplus">+                    if (yield spinEventLoop()) {</span>
<a href="#l30.1864"></a><span id="l30.1864" class="difflineplus">+                        act.setProgress(cur, total);</span>
<a href="#l30.1865"></a><span id="l30.1865" class="difflineplus">+                    }</span>
<a href="#l30.1866"></a><span id="l30.1866" class="difflineplus">+                }</span>
<a href="#l30.1867"></a><span id="l30.1867" class="difflineplus">+                act.complete();</span>
<a href="#l30.1868"></a><span id="l30.1868" class="difflineplus">+            }</span>
<a href="#l30.1869"></a><span id="l30.1869" class="difflineplus">+        }.bind(this));</span>
<a href="#l30.1870"></a><span id="l30.1870">     },</span>
<a href="#l30.1871"></a><span id="l30.1871"> </span>
<a href="#l30.1872"></a><span id="l30.1872" class="difflineminus">-    onOperationComplete: function syncSetter_onOperationComplete(aCal,</span>
<a href="#l30.1873"></a><span id="l30.1873" class="difflineminus">-                                                                 aStatus,</span>
<a href="#l30.1874"></a><span id="l30.1874" class="difflineminus">-                                                                 aOpType,</span>
<a href="#l30.1875"></a><span id="l30.1875" class="difflineminus">-                                                                 aId,</span>
<a href="#l30.1876"></a><span id="l30.1876" class="difflineminus">-                                                                 aDetail) {</span>
<a href="#l30.1877"></a><span id="l30.1877" class="difflineplus">+    /**</span>
<a href="#l30.1878"></a><span id="l30.1878" class="difflineplus">+     * Parse the response from Google's list command into events.</span>
<a href="#l30.1879"></a><span id="l30.1879" class="difflineplus">+     *</span>
<a href="#l30.1880"></a><span id="l30.1880" class="difflineplus">+     * @param aData         The JS Object from the list response.</span>
<a href="#l30.1881"></a><span id="l30.1881" class="difflineplus">+     * @return              A promise resolved when completed.</span>
<a href="#l30.1882"></a><span id="l30.1882" class="difflineplus">+     */</span>
<a href="#l30.1883"></a><span id="l30.1883" class="difflineplus">+    parseEventStream: function(aData) {</span>
<a href="#l30.1884"></a><span id="l30.1884" class="difflineplus">+        return Task.spawn(function() {</span>
<a href="#l30.1885"></a><span id="l30.1885" class="difflineplus">+            if (!aData.items || !aData.items.length) {</span>
<a href="#l30.1886"></a><span id="l30.1886" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] No events have been changed on &quot; + this.calendar.name);</span>
<a href="#l30.1887"></a><span id="l30.1887" class="difflineplus">+                return;</span>
<a href="#l30.1888"></a><span id="l30.1888" class="difflineplus">+            } else {</span>
<a href="#l30.1889"></a><span id="l30.1889" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received events&quot;);</span>
<a href="#l30.1890"></a><span id="l30.1890" class="difflineplus">+            }</span>
<a href="#l30.1891"></a><span id="l30.1891" class="difflineplus">+</span>
<a href="#l30.1892"></a><span id="l30.1892" class="difflineplus">+            let exceptionItems = [];</span>
<a href="#l30.1893"></a><span id="l30.1893" class="difflineplus">+            let defaultReminders = (aData.defaultReminders || []).map(function(x) JSONToAlarm(x, true));</span>
<a href="#l30.1894"></a><span id="l30.1894" class="difflineplus">+</span>
<a href="#l30.1895"></a><span id="l30.1895" class="difflineplus">+            let tzs = cal.getTimezoneService();</span>
<a href="#l30.1896"></a><span id="l30.1896" class="difflineplus">+            let defaultTimezone = (aData.timeZone ? tzs.getTimezone(aData.timeZone) :</span>
<a href="#l30.1897"></a><span id="l30.1897" class="difflineplus">+                                    cal.calendarDefaultTimezone());</span>
<a href="#l30.1898"></a><span id="l30.1898" class="difflineplus">+</span>
<a href="#l30.1899"></a><span id="l30.1899" class="difflineplus">+            // In the first pass, we go through the data and sort into master items and</span>
<a href="#l30.1900"></a><span id="l30.1900" class="difflineplus">+            // exception items, as the master item might be after the exception in the</span>
<a href="#l30.1901"></a><span id="l30.1901" class="difflineplus">+            // stream.</span>
<a href="#l30.1902"></a><span id="l30.1902" class="difflineplus">+</span>
<a href="#l30.1903"></a><span id="l30.1903" class="difflineplus">+            let act = new ActivityShell(this.calendar, &quot;Event&quot;);</span>
<a href="#l30.1904"></a><span id="l30.1904" class="difflineplus">+            let total = aData.items.length;</span>
<a href="#l30.1905"></a><span id="l30.1905" class="difflineplus">+            for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l30.1906"></a><span id="l30.1906" class="difflineplus">+                let entry = aData.items[cur];</span>
<a href="#l30.1907"></a><span id="l30.1907" class="difflineplus">+                let metaData = Object.create(null);</span>
<a href="#l30.1908"></a><span id="l30.1908" class="difflineplus">+                let item = JSONToEvent(entry, this.calendar, defaultTimezone, defaultReminders, null, metaData);</span>
<a href="#l30.1909"></a><span id="l30.1909" class="difflineplus">+                LOGitem(item);</span>
<a href="#l30.1910"></a><span id="l30.1910" class="difflineplus">+</span>
<a href="#l30.1911"></a><span id="l30.1911" class="difflineplus">+                this.metaData[item.hashId] = metaData;</span>
<a href="#l30.1912"></a><span id="l30.1912" class="difflineplus">+</span>
<a href="#l30.1913"></a><span id="l30.1913" class="difflineplus">+                if (item.recurrenceId) {</span>
<a href="#l30.1914"></a><span id="l30.1914" class="difflineplus">+                    exceptionItems.push(item);</span>
<a href="#l30.1915"></a><span id="l30.1915" class="difflineplus">+                } else {</span>
<a href="#l30.1916"></a><span id="l30.1916" class="difflineplus">+                    this.masterItems[item.id] = item;</span>
<a href="#l30.1917"></a><span id="l30.1917" class="difflineplus">+                    yield this.commitItem(item);</span>
<a href="#l30.1918"></a><span id="l30.1918" class="difflineplus">+                }</span>
<a href="#l30.1919"></a><span id="l30.1919" class="difflineplus">+</span>
<a href="#l30.1920"></a><span id="l30.1920" class="difflineplus">+                if (yield spinEventLoop()) {</span>
<a href="#l30.1921"></a><span id="l30.1921" class="difflineplus">+                    act.setProgress(cur, total);</span>
<a href="#l30.1922"></a><span id="l30.1922" class="difflineplus">+                }</span>
<a href="#l30.1923"></a><span id="l30.1923" class="difflineplus">+            }</span>
<a href="#l30.1924"></a><span id="l30.1924" class="difflineplus">+            act.complete();</span>
<a href="#l30.1925"></a><span id="l30.1925" class="difflineplus">+</span>
<a href="#l30.1926"></a><span id="l30.1926" class="difflineplus">+            // Go through all exceptions and attempt to find the master item in the</span>
<a href="#l30.1927"></a><span id="l30.1927" class="difflineplus">+            // item stream. If it can't be found there, the offline storage is asked</span>
<a href="#l30.1928"></a><span id="l30.1928" class="difflineplus">+            // for the parent item. If it still can't be found, then we have to do</span>
<a href="#l30.1929"></a><span id="l30.1929" class="difflineplus">+            // this at the end.</span>
<a href="#l30.1930"></a><span id="l30.1930" class="difflineplus">+            for each (let exc in exceptionItems) {</span>
<a href="#l30.1931"></a><span id="l30.1931" class="difflineplus">+                // If we have the master item in our cache then use it. Otherwise</span>
<a href="#l30.1932"></a><span id="l30.1932" class="difflineplus">+                // attempt to get it from the offline storage.</span>
<a href="#l30.1933"></a><span id="l30.1933" class="difflineplus">+                let item;</span>
<a href="#l30.1934"></a><span id="l30.1934" class="difflineplus">+                if (exc.id in this.masterItems) {</span>
<a href="#l30.1935"></a><span id="l30.1935" class="difflineplus">+                    item = this.masterItems[exc.id];</span>
<a href="#l30.1936"></a><span id="l30.1936" class="difflineplus">+                } else {</span>
<a href="#l30.1937"></a><span id="l30.1937" class="difflineplus">+                    item = (yield this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l30.1938"></a><span id="l30.1938" class="difflineplus">+                }</span>
<a href="#l30.1939"></a><span id="l30.1939" class="difflineplus">+</span>
<a href="#l30.1940"></a><span id="l30.1940" class="difflineplus">+                // If an item was found, we can process this exception. Otherwise</span>
<a href="#l30.1941"></a><span id="l30.1941" class="difflineplus">+                // save it for later, maybe its on the next page of the request.</span>
<a href="#l30.1942"></a><span id="l30.1942" class="difflineplus">+                if (item) {</span>
<a href="#l30.1943"></a><span id="l30.1943" class="difflineplus">+                    yield this.processException(exc, item);</span>
<a href="#l30.1944"></a><span id="l30.1944" class="difflineplus">+                } else {</span>
<a href="#l30.1945"></a><span id="l30.1945" class="difflineplus">+                    this.missingParents.push(exc);</span>
<a href="#l30.1946"></a><span id="l30.1946" class="difflineplus">+                }</span>
<a href="#l30.1947"></a><span id="l30.1947" class="difflineplus">+</span>
<a href="#l30.1948"></a><span id="l30.1948" class="difflineplus">+                yield this.commitException(exc);</span>
<a href="#l30.1949"></a><span id="l30.1949" class="difflineplus">+            }</span>
<a href="#l30.1950"></a><span id="l30.1950" class="difflineplus">+        }.bind(this));</span>
<a href="#l30.1951"></a><span id="l30.1951" class="difflineplus">+    },</span>
<a href="#l30.1952"></a><span id="l30.1952"> </span>
<a href="#l30.1953"></a><span id="l30.1953" class="difflineminus">-        if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l30.1954"></a><span id="l30.1954" class="difflineminus">-            this.mObj.value = null;</span>
<a href="#l30.1955"></a><span id="l30.1955" class="difflineplus">+    /**</span>
<a href="#l30.1956"></a><span id="l30.1956" class="difflineplus">+     * Handle the exception for the given item by committing it to the</span>
<a href="#l30.1957"></a><span id="l30.1957" class="difflineplus">+     * calendar.</span>
<a href="#l30.1958"></a><span id="l30.1958" class="difflineplus">+     *</span>
<a href="#l30.1959"></a><span id="l30.1959" class="difflineplus">+     * @param exc       The exception to process.</span>
<a href="#l30.1960"></a><span id="l30.1960" class="difflineplus">+     * @param item      The item the exception belongs to.</span>
<a href="#l30.1961"></a><span id="l30.1961" class="difflineplus">+     * @return          A promise resolved when the item is added to the</span>
<a href="#l30.1962"></a><span id="l30.1962" class="difflineplus">+     *                    calendar.</span>
<a href="#l30.1963"></a><span id="l30.1963" class="difflineplus">+     */</span>
<a href="#l30.1964"></a><span id="l30.1964" class="difflineplus">+    processException: function(exc, item) {</span>
<a href="#l30.1965"></a><span id="l30.1965" class="difflineplus">+        exc.parentItem = item;</span>
<a href="#l30.1966"></a><span id="l30.1966" class="difflineplus">+        if (exc.status == &quot;CANCELLED&quot;) {</span>
<a href="#l30.1967"></a><span id="l30.1967" class="difflineplus">+            // Canceled means the occurrence is an EXDATE.</span>
<a href="#l30.1968"></a><span id="l30.1968" class="difflineplus">+            item.recurrenceInfo.removeOccurrenceAt(exc.recurrenceId);</span>
<a href="#l30.1969"></a><span id="l30.1969" class="difflineplus">+        } else {</span>
<a href="#l30.1970"></a><span id="l30.1970" class="difflineplus">+            // Not canceled means the occurrence was modified.</span>
<a href="#l30.1971"></a><span id="l30.1971" class="difflineplus">+            item.recurrenceInfo.modifyException(exc, true);</span>
<a href="#l30.1972"></a><span id="l30.1972" class="difflineplus">+        }</span>
<a href="#l30.1973"></a><span id="l30.1973" class="difflineplus">+        this.masterItems[item.id] = item;</span>
<a href="#l30.1974"></a><span id="l30.1974" class="difflineplus">+        return this.commitItem(item);</span>
<a href="#l30.1975"></a><span id="l30.1975" class="difflineplus">+    },</span>
<a href="#l30.1976"></a><span id="l30.1976" class="difflineplus">+</span>
<a href="#l30.1977"></a><span id="l30.1977" class="difflineplus">+    /**</span>
<a href="#l30.1978"></a><span id="l30.1978" class="difflineplus">+     * Handle final tasks for the exception. This means saving the metadat for the exception.</span>
<a href="#l30.1979"></a><span id="l30.1979" class="difflineplus">+     *</span>
<a href="#l30.1980"></a><span id="l30.1980" class="difflineplus">+     * @param exc       The exception to process.</span>
<a href="#l30.1981"></a><span id="l30.1981" class="difflineplus">+     */</span>
<a href="#l30.1982"></a><span id="l30.1982" class="difflineplus">+    commitException: function(exc) {</span>
<a href="#l30.1983"></a><span id="l30.1983" class="difflineplus">+        // Make sure we also save the etag of the exception for a future request.</span>
<a href="#l30.1984"></a><span id="l30.1984" class="difflineplus">+        if (exc.hashId in this.metaData) {</span>
<a href="#l30.1985"></a><span id="l30.1985" class="difflineplus">+            saveItemMetadata(this.offlineStorage, exc.hashId, this.metaData[exc.hashId]);</span>
<a href="#l30.1986"></a><span id="l30.1986">         }</span>
<a href="#l30.1987"></a><span id="l30.1987" class="difflineplus">+    },</span>
<a href="#l30.1988"></a><span id="l30.1988" class="difflineplus">+</span>
<a href="#l30.1989"></a><span id="l30.1989" class="difflineplus">+    /**</span>
<a href="#l30.1990"></a><span id="l30.1990" class="difflineplus">+     * Handle adding the item to the calendar, or removing it if its a cancelled item.</span>
<a href="#l30.1991"></a><span id="l30.1991" class="difflineplus">+     *</span>
<a href="#l30.1992"></a><span id="l30.1992" class="difflineplus">+     * @param item      The item to process.</span>
<a href="#l30.1993"></a><span id="l30.1993" class="difflineplus">+     * @return          A promise resolved when the process is completed.</span>
<a href="#l30.1994"></a><span id="l30.1994" class="difflineplus">+     */</span>
<a href="#l30.1995"></a><span id="l30.1995" class="difflineplus">+    commitItem: function(item) {</span>
<a href="#l30.1996"></a><span id="l30.1996" class="difflineplus">+        return Task.spawn(function() {</span>
<a href="#l30.1997"></a><span id="l30.1997" class="difflineplus">+            // This is a normal item. If it was canceled, then it should be</span>
<a href="#l30.1998"></a><span id="l30.1998" class="difflineplus">+            // deleted, otherwise it should be either added or modified. The</span>
<a href="#l30.1999"></a><span id="l30.1999" class="difflineplus">+            // relaxed mode of the destination calendar takes care of the latter</span>
<a href="#l30.2000"></a><span id="l30.2000" class="difflineplus">+            // two cases.</span>
<a href="#l30.2001"></a><span id="l30.2001" class="difflineplus">+            if (item.status == &quot;CANCELLED&quot;) {</span>
<a href="#l30.2002"></a><span id="l30.2002" class="difflineplus">+                yield this.promiseOfflineStorage.deleteItem(item);</span>
<a href="#l30.2003"></a><span id="l30.2003" class="difflineplus">+            } else {</span>
<a href="#l30.2004"></a><span id="l30.2004" class="difflineplus">+                yield this.promiseOfflineStorage.modifyItem(item, null);</span>
<a href="#l30.2005"></a><span id="l30.2005" class="difflineplus">+            }</span>
<a href="#l30.2006"></a><span id="l30.2006" class="difflineplus">+</span>
<a href="#l30.2007"></a><span id="l30.2007" class="difflineplus">+            if (item.hashId in this.metaData) {</span>
<a href="#l30.2008"></a><span id="l30.2008" class="difflineplus">+                // Make sure the metadata is up to date for the next request</span>
<a href="#l30.2009"></a><span id="l30.2009" class="difflineplus">+                saveItemMetadata(this.offlineStorage, item.hashId, this.metaData[item.hashId]);</span>
<a href="#l30.2010"></a><span id="l30.2010" class="difflineplus">+            }</span>
<a href="#l30.2011"></a><span id="l30.2011" class="difflineplus">+        }.bind(this));</span>
<a href="#l30.2012"></a><span id="l30.2012" class="difflineplus">+    },</span>
<a href="#l30.2013"></a><span id="l30.2013" class="difflineplus">+</span>
<a href="#l30.2014"></a><span id="l30.2014" class="difflineplus">+    /**</span>
<a href="#l30.2015"></a><span id="l30.2015" class="difflineplus">+     * Handle all remaining exceptions in the item saver. Call this at the end</span>
<a href="#l30.2016"></a><span id="l30.2016" class="difflineplus">+     * when all items and exceptions have been loaded to ensure that any</span>
<a href="#l30.2017"></a><span id="l30.2017" class="difflineplus">+     * missing master items are searched for or created.</span>
<a href="#l30.2018"></a><span id="l30.2018" class="difflineplus">+     *</span>
<a href="#l30.2019"></a><span id="l30.2019" class="difflineplus">+     * @return          A promise resolved on completion</span>
<a href="#l30.2020"></a><span id="l30.2020" class="difflineplus">+     */</span>
<a href="#l30.2021"></a><span id="l30.2021" class="difflineplus">+    processRemainingExceptions: function() {</span>
<a href="#l30.2022"></a><span id="l30.2022" class="difflineplus">+        return Task.spawn(function() {</span>
<a href="#l30.2023"></a><span id="l30.2023" class="difflineplus">+            for each (let exc in this.missingParents) {</span>
<a href="#l30.2024"></a><span id="l30.2024" class="difflineplus">+                let item = (yield this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l30.2025"></a><span id="l30.2025" class="difflineplus">+                if (item) {</span>
<a href="#l30.2026"></a><span id="l30.2026" class="difflineplus">+                    yield this.processException(exc, item);</span>
<a href="#l30.2027"></a><span id="l30.2027" class="difflineplus">+                } else if (exc.status != &quot;CANCELLED&quot;) {</span>
<a href="#l30.2028"></a><span id="l30.2028" class="difflineplus">+                    // If the item could not be found, it could be that the</span>
<a href="#l30.2029"></a><span id="l30.2029" class="difflineplus">+                    // user is invited to an instance of a recurring event.</span>
<a href="#l30.2030"></a><span id="l30.2030" class="difflineplus">+                    // Unless this is a cancelled exception, create a mock</span>
<a href="#l30.2031"></a><span id="l30.2031" class="difflineplus">+                    // parent item with one positive RDATE.</span>
<a href="#l30.2032"></a><span id="l30.2032" class="difflineplus">+                    let item = exc.clone();</span>
<a href="#l30.2033"></a><span id="l30.2033" class="difflineplus">+                    item.recurrenceId = null;</span>
<a href="#l30.2034"></a><span id="l30.2034" class="difflineplus">+                    item.calendar = this.calendar.superCalendar;</span>
<a href="#l30.2035"></a><span id="l30.2035" class="difflineplus">+                    item.startDate = exc.recurrenceId.clone();</span>
<a href="#l30.2036"></a><span id="l30.2036" class="difflineplus">+                    item.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;);</span>
<a href="#l30.2037"></a><span id="l30.2037" class="difflineplus">+                    if (!item.id) {</span>
<a href="#l30.2038"></a><span id="l30.2038" class="difflineplus">+                        // Exceptions often don't have the iCalUID field set,</span>
<a href="#l30.2039"></a><span id="l30.2039" class="difflineplus">+                        // we need to fake it from the google id.</span>
<a href="#l30.2040"></a><span id="l30.2040" class="difflineplus">+                        let meta = this.metaData[exc.hashId];</span>
<a href="#l30.2041"></a><span id="l30.2041" class="difflineplus">+                        item.id = meta.path + &quot;@google.com&quot;;</span>
<a href="#l30.2042"></a><span id="l30.2042" class="difflineplus">+                    }</span>
<a href="#l30.2043"></a><span id="l30.2043" class="difflineplus">+                    item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l30.2044"></a><span id="l30.2044" class="difflineplus">+                    let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l30.2045"></a><span id="l30.2045" class="difflineplus">+                                          .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l30.2046"></a><span id="l30.2046" class="difflineplus">+                    rdate.date = exc.recurrenceId;</span>
<a href="#l30.2047"></a><span id="l30.2047" class="difflineplus">+                    item.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l30.2048"></a><span id="l30.2048" class="difflineplus">+                    yield this.commitItem(item);</span>
<a href="#l30.2049"></a><span id="l30.2049" class="difflineplus">+                }</span>
<a href="#l30.2050"></a><span id="l30.2050" class="difflineplus">+            }</span>
<a href="#l30.2051"></a><span id="l30.2051" class="difflineplus">+        }.bind(this));</span>
<a href="#l30.2052"></a><span id="l30.2052">     }</span>
<a href="#l30.2053"></a><span id="l30.2053"> };</span>
<a href="#l30.2054"></a><span id="l30.2054"> </span>
<a href="#l30.2055"></a><span id="l30.2055"> /**</span>
<a href="#l30.2056"></a><span id="l30.2056" class="difflineminus">- * Helper function to create a timer in a context where window.setTimeout is not</span>
<a href="#l30.2057"></a><span id="l30.2057" class="difflineminus">- * available</span>
<a href="#l30.2058"></a><span id="l30.2058" class="difflineplus">+ * A wrapper for nsIActivity to handle the synchronization process.</span>
<a href="#l30.2059"></a><span id="l30.2059">  *</span>
<a href="#l30.2060"></a><span id="l30.2060" class="difflineminus">- * @param aFunc     The function to call when the timer fires</span>
<a href="#l30.2061"></a><span id="l30.2061" class="difflineminus">- * @param aTimeout  The timeout in milliseconds.</span>
<a href="#l30.2062"></a><span id="l30.2062" class="difflineminus">- * @param aThis     (optional) The |this| object to call the function with.</span>
<a href="#l30.2063"></a><span id="l30.2063" class="difflineplus">+ * @param aCalendar     The calendar for this activity.</span>
<a href="#l30.2064"></a><span id="l30.2064">  */</span>
<a href="#l30.2065"></a><span id="l30.2065" class="difflineminus">-function setTimeout(aFunc, aTimeout, aThis) {</span>
<a href="#l30.2066"></a><span id="l30.2066" class="difflineminus">-    let timerCallback = {</span>
<a href="#l30.2067"></a><span id="l30.2067" class="difflineminus">-        notify: function setTimeout_notify() {</span>
<a href="#l30.2068"></a><span id="l30.2068" class="difflineminus">-            aFunc.call(aThis);</span>
<a href="#l30.2069"></a><span id="l30.2069" class="difflineplus">+function ActivityShell(aCalendar, aType) {</span>
<a href="#l30.2070"></a><span id="l30.2070" class="difflineplus">+    this.calendar = aCalendar;</span>
<a href="#l30.2071"></a><span id="l30.2071" class="difflineplus">+    this.type = aType;</span>
<a href="#l30.2072"></a><span id="l30.2072" class="difflineplus">+</span>
<a href="#l30.2073"></a><span id="l30.2073" class="difflineplus">+    if ('@mozilla.org/activity-process;1' in Components.classes) {</span>
<a href="#l30.2074"></a><span id="l30.2074" class="difflineplus">+        this.init();</span>
<a href="#l30.2075"></a><span id="l30.2075" class="difflineplus">+    }</span>
<a href="#l30.2076"></a><span id="l30.2076" class="difflineplus">+}</span>
<a href="#l30.2077"></a><span id="l30.2077" class="difflineplus">+</span>
<a href="#l30.2078"></a><span id="l30.2078" class="difflineplus">+ActivityShell.prototype = {</span>
<a href="#l30.2079"></a><span id="l30.2079" class="difflineplus">+    act: null,</span>
<a href="#l30.2080"></a><span id="l30.2080" class="difflineplus">+    actMgr: null,</span>
<a href="#l30.2081"></a><span id="l30.2081" class="difflineplus">+    calendar: null,</span>
<a href="#l30.2082"></a><span id="l30.2082" class="difflineplus">+    type: null,</span>
<a href="#l30.2083"></a><span id="l30.2083" class="difflineplus">+</span>
<a href="#l30.2084"></a><span id="l30.2084" class="difflineplus">+    init: function() {</span>
<a href="#l30.2085"></a><span id="l30.2085" class="difflineplus">+        this.actMgr = Components.classes['@mozilla.org/activity-manager;1']</span>
<a href="#l30.2086"></a><span id="l30.2086" class="difflineplus">+                                .getService(Components.interfaces.nsIActivityManager);</span>
<a href="#l30.2087"></a><span id="l30.2087" class="difflineplus">+        this.act =  Components.classes['@mozilla.org/activity-process;1']</span>
<a href="#l30.2088"></a><span id="l30.2088" class="difflineplus">+                              .createInstance(Components.interfaces.nsIActivityProcess);</span>
<a href="#l30.2089"></a><span id="l30.2089" class="difflineplus">+        this.act.init(getProviderString(&quot;syncStatus&quot;, this.calendar.name), this);</span>
<a href="#l30.2090"></a><span id="l30.2090" class="difflineplus">+        this.act.iconClass = &quot;syncMail&quot;;</span>
<a href="#l30.2091"></a><span id="l30.2091" class="difflineplus">+        this.act.contextType = &quot;gdata-calendar&quot;;</span>
<a href="#l30.2092"></a><span id="l30.2092" class="difflineplus">+        this.act.contextObj = this.calendar;</span>
<a href="#l30.2093"></a><span id="l30.2093" class="difflineplus">+        this.act.contextDisplayText = this.calendar.name;</span>
<a href="#l30.2094"></a><span id="l30.2094" class="difflineplus">+</span>
<a href="#l30.2095"></a><span id="l30.2095" class="difflineplus">+        this.actMgr.addActivity(this.act);</span>
<a href="#l30.2096"></a><span id="l30.2096" class="difflineplus">+    },</span>
<a href="#l30.2097"></a><span id="l30.2097" class="difflineplus">+</span>
<a href="#l30.2098"></a><span id="l30.2098" class="difflineplus">+    setProgress: function(cur, total) {</span>
<a href="#l30.2099"></a><span id="l30.2099" class="difflineplus">+        if (!this.act) {</span>
<a href="#l30.2100"></a><span id="l30.2100" class="difflineplus">+            return;</span>
<a href="#l30.2101"></a><span id="l30.2101" class="difflineplus">+        }</span>
<a href="#l30.2102"></a><span id="l30.2102" class="difflineplus">+        if (cur == total) {</span>
<a href="#l30.2103"></a><span id="l30.2103" class="difflineplus">+            this.complete();</span>
<a href="#l30.2104"></a><span id="l30.2104" class="difflineplus">+        } else {</span>
<a href="#l30.2105"></a><span id="l30.2105" class="difflineplus">+            let str = getProviderString(&quot;syncProgress&quot; + this.type, this.calendar.name, cur, total);</span>
<a href="#l30.2106"></a><span id="l30.2106" class="difflineplus">+            this.act.setProgress(str, cur, total);</span>
<a href="#l30.2107"></a><span id="l30.2107" class="difflineplus">+        }</span>
<a href="#l30.2108"></a><span id="l30.2108" class="difflineplus">+    },</span>
<a href="#l30.2109"></a><span id="l30.2109" class="difflineplus">+</span>
<a href="#l30.2110"></a><span id="l30.2110" class="difflineplus">+    complete: function() {</span>
<a href="#l30.2111"></a><span id="l30.2111" class="difflineplus">+        if (!this.act) {</span>
<a href="#l30.2112"></a><span id="l30.2112" class="difflineplus">+            return;</span>
<a href="#l30.2113"></a><span id="l30.2113">         }</span>
<a href="#l30.2114"></a><span id="l30.2114" class="difflineminus">-    };</span>
<a href="#l30.2115"></a><span id="l30.2115" class="difflineminus">-    let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l30.2116"></a><span id="l30.2116" class="difflineminus">-                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l30.2117"></a><span id="l30.2117" class="difflineminus">-    timer.initWithCallback(timerCallback, aTimeout, timer.TYPE_ONE_SHOT);</span>
<a href="#l30.2118"></a><span id="l30.2118" class="difflineplus">+        let total = this.act.totalWorkUnits;</span>
<a href="#l30.2119"></a><span id="l30.2119" class="difflineplus">+        this.act.setProgress(&quot;&quot;, total, total);</span>
<a href="#l30.2120"></a><span id="l30.2120" class="difflineplus">+        this.act.state = Components.interfaces.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l30.2121"></a><span id="l30.2121" class="difflineplus">+        this.actMgr.removeActivity(this.act.id);</span>
<a href="#l30.2122"></a><span id="l30.2122" class="difflineplus">+    }</span>
<a href="#l30.2123"></a><span id="l30.2123" class="difflineplus">+};</span>
<a href="#l30.2124"></a><span id="l30.2124" class="difflineplus">+</span>
<a href="#l30.2125"></a><span id="l30.2125" class="difflineplus">+/**</span>
<a href="#l30.2126"></a><span id="l30.2126" class="difflineplus">+ * Check if the response is a conflict and handle asking the user what to do</span>
<a href="#l30.2127"></a><span id="l30.2127" class="difflineplus">+ * about it. Will resolve if there is no conflict or with new item data.</span>
<a href="#l30.2128"></a><span id="l30.2128" class="difflineplus">+ * where status is a conflict status, see the end of this function.</span>
<a href="#l30.2129"></a><span id="l30.2129" class="difflineplus">+ *</span>
<a href="#l30.2130"></a><span id="l30.2130" class="difflineplus">+ * @param aOperation        The operation to check.</span>
<a href="#l30.2131"></a><span id="l30.2131" class="difflineplus">+ * @param aCalendar         The calendar this operation happens in</span>
<a href="#l30.2132"></a><span id="l30.2132" class="difflineplus">+ * @param aItem             The item that was passed to the server</span>
<a href="#l30.2133"></a><span id="l30.2133" class="difflineplus">+ * @return                  A promise resolved when the conflict has been resolved</span>
<a href="#l30.2134"></a><span id="l30.2134" class="difflineplus">+ */</span>
<a href="#l30.2135"></a><span id="l30.2135" class="difflineplus">+function checkResolveConflict(aOperation, aCalendar, aItem) {</span>
<a href="#l30.2136"></a><span id="l30.2136" class="difflineplus">+    return Task.spawn(function() {</span>
<a href="#l30.2137"></a><span id="l30.2137" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] A conflict occurred for &quot; + aItem.title);</span>
<a href="#l30.2138"></a><span id="l30.2138" class="difflineplus">+</span>
<a href="#l30.2139"></a><span id="l30.2139" class="difflineplus">+        let method = (aOperation.type == aOperation.DELETE ? &quot;delete&quot; : &quot;modify&quot;)</span>
<a href="#l30.2140"></a><span id="l30.2140" class="difflineplus">+        let overwrite = cal.promptOverwrite(method, aItem);</span>
<a href="#l30.2141"></a><span id="l30.2141" class="difflineplus">+        if (overwrite) {</span>
<a href="#l30.2142"></a><span id="l30.2142" class="difflineplus">+            // The user has decided to overwrite the server version. Send again</span>
<a href="#l30.2143"></a><span id="l30.2143" class="difflineplus">+            // overwriting the server version with If-Match: *</span>
<a href="#l30.2144"></a><span id="l30.2144" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Resending &quot; + method + &quot; and ignoring ETag&quot;);</span>
<a href="#l30.2145"></a><span id="l30.2145" class="difflineplus">+            aOperation.addRequestHeader(&quot;If-Match&quot;, &quot;*&quot;);</span>
<a href="#l30.2146"></a><span id="l30.2146" class="difflineplus">+            try {</span>
<a href="#l30.2147"></a><span id="l30.2147" class="difflineplus">+                throw new Task.Result(yield aCalendar.session.asyncItemRequest(aOperation));</span>
<a href="#l30.2148"></a><span id="l30.2148" class="difflineplus">+            } catch (e if e.result == calGoogleRequest.RESOURCE_GONE &amp;&amp;</span>
<a href="#l30.2149"></a><span id="l30.2149" class="difflineplus">+                          aOperation.type == aOperation.DELETE) {</span>
<a href="#l30.2150"></a><span id="l30.2150" class="difflineplus">+                // The item was deleted on the server and locally, we don't need to</span>
<a href="#l30.2151"></a><span id="l30.2151" class="difflineplus">+                // notify the user about this.</span>
<a href="#l30.2152"></a><span id="l30.2152" class="difflineplus">+                throw new Task.Result(null);</span>
<a href="#l30.2153"></a><span id="l30.2153" class="difflineplus">+            }</span>
<a href="#l30.2154"></a><span id="l30.2154" class="difflineplus">+        } else {</span>
<a href="#l30.2155"></a><span id="l30.2155" class="difflineplus">+            // The user has decided to throw away changes, use our existing</span>
<a href="#l30.2156"></a><span id="l30.2156" class="difflineplus">+            // means to update the item locally.</span>
<a href="#l30.2157"></a><span id="l30.2157" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Reload requested, cancelling change of &quot; + aItem.title);</span>
<a href="#l30.2158"></a><span id="l30.2158" class="difflineplus">+            aCalendar.superCalendar.refresh();</span>
<a href="#l30.2159"></a><span id="l30.2159" class="difflineplus">+            throw Components.Exception(null, cIE.OPERATION_CANCELLED);</span>
<a href="#l30.2160"></a><span id="l30.2160" class="difflineplus">+        }</span>
<a href="#l30.2161"></a><span id="l30.2161" class="difflineplus">+    });</span>
<a href="#l30.2162"></a><span id="l30.2162" class="difflineplus">+}</span>
<a href="#l30.2163"></a><span id="l30.2163" class="difflineplus">+</span>
<a href="#l30.2164"></a><span id="l30.2164" class="difflineplus">+/**</span>
<a href="#l30.2165"></a><span id="l30.2165" class="difflineplus">+ * Get a string from the gdata properties file</span>
<a href="#l30.2166"></a><span id="l30.2166" class="difflineplus">+ *</span>
<a href="#l30.2167"></a><span id="l30.2167" class="difflineplus">+ * @param aStringName  The name of the string within the properties file</span>
<a href="#l30.2168"></a><span id="l30.2168" class="difflineplus">+ * @param ...aParams   Optional parameters to format the string</span>
<a href="#l30.2169"></a><span id="l30.2169" class="difflineplus">+ * @return             The localized string value.</span>
<a href="#l30.2170"></a><span id="l30.2170" class="difflineplus">+ */</span>
<a href="#l30.2171"></a><span id="l30.2171" class="difflineplus">+function getProviderString(aStringName /*...aParams */) {</span>
<a href="#l30.2172"></a><span id="l30.2172" class="difflineplus">+    let aParams = Array.slice(arguments, 1);</span>
<a href="#l30.2173"></a><span id="l30.2173" class="difflineplus">+    return cal.calGetString(&quot;gdata&quot;, aStringName, aParams, &quot;gdata-provider&quot;);</span>
<a href="#l30.2174"></a><span id="l30.2174"> }</span>
<a href="#l30.2175"></a><span id="l30.2175"> </span>
<a href="#l30.2176"></a><span id="l30.2176"> /**</span>
<a href="#l30.2177"></a><span id="l30.2177" class="difflineminus">- * LOGitem</span>
<a href="#l30.2178"></a><span id="l30.2178" class="difflineminus">- * Custom logging functions</span>
<a href="#l30.2179"></a><span id="l30.2179" class="difflineplus">+ * Monkey patch the function with the name x on obj and overwrite it with func.</span>
<a href="#l30.2180"></a><span id="l30.2180" class="difflineplus">+ * The first parameter of this function is the original function that can be</span>
<a href="#l30.2181"></a><span id="l30.2181" class="difflineplus">+ * called at any time.</span>
<a href="#l30.2182"></a><span id="l30.2182" class="difflineplus">+ *</span>
<a href="#l30.2183"></a><span id="l30.2183" class="difflineplus">+ * @param obj           The object the function is on.</span>
<a href="#l30.2184"></a><span id="l30.2184" class="difflineplus">+ * @param name          The string name of the function.</span>
<a href="#l30.2185"></a><span id="l30.2185" class="difflineplus">+ * @param func          The function to monkey patch with.</span>
<a href="#l30.2186"></a><span id="l30.2186">  */</span>
<a href="#l30.2187"></a><span id="l30.2187" class="difflineminus">-function LOGitem(item) {</span>
<a href="#l30.2188"></a><span id="l30.2188" class="difflineminus">-    if (!item) {</span>
<a href="#l30.2189"></a><span id="l30.2189" class="difflineminus">-        return;</span>
<a href="#l30.2190"></a><span id="l30.2190" class="difflineplus">+function monkeyPatch(obj, x, func) {</span>
<a href="#l30.2191"></a><span id="l30.2191" class="difflineplus">+    let old = obj[x];</span>
<a href="#l30.2192"></a><span id="l30.2192" class="difflineplus">+    obj[x] = function() {</span>
<a href="#l30.2193"></a><span id="l30.2193" class="difflineplus">+        let parent = old.bind(obj);</span>
<a href="#l30.2194"></a><span id="l30.2194" class="difflineplus">+        let args = Array.slice(arguments);</span>
<a href="#l30.2195"></a><span id="l30.2195" class="difflineplus">+        args.unshift(parent);</span>
<a href="#l30.2196"></a><span id="l30.2196" class="difflineplus">+        try {</span>
<a href="#l30.2197"></a><span id="l30.2197" class="difflineplus">+            return func.apply(obj, args);</span>
<a href="#l30.2198"></a><span id="l30.2198" class="difflineplus">+        } catch (e) {</span>
<a href="#l30.2199"></a><span id="l30.2199" class="difflineplus">+            Components.utils.reportError(e);</span>
<a href="#l30.2200"></a><span id="l30.2200" class="difflineplus">+            throw e;</span>
<a href="#l30.2201"></a><span id="l30.2201" class="difflineplus">+        }</span>
<a href="#l30.2202"></a><span id="l30.2202">     }</span>
<a href="#l30.2203"></a><span id="l30.2203" class="difflineplus">+}</span>
<a href="#l30.2204"></a><span id="l30.2204" class="difflineplus">+</span>
<a href="#l30.2205"></a><span id="l30.2205" class="difflineplus">+/**</span>
<a href="#l30.2206"></a><span id="l30.2206" class="difflineplus">+ * Returns a promise that resolves after pending events have been processed.</span>
<a href="#l30.2207"></a><span id="l30.2207" class="difflineplus">+ */</span>
<a href="#l30.2208"></a><span id="l30.2208"> </span>
<a href="#l30.2209"></a><span id="l30.2209" class="difflineminus">-    let attendees = item.getAttendees({});</span>
<a href="#l30.2210"></a><span id="l30.2210" class="difflineminus">-    let attendeeString = &quot;&quot;;</span>
<a href="#l30.2211"></a><span id="l30.2211" class="difflineminus">-    for each (let a in attendees) {</span>
<a href="#l30.2212"></a><span id="l30.2212" class="difflineminus">-        attendeeString += &quot;\n&quot; + LOGattendee(a);</span>
<a href="#l30.2213"></a><span id="l30.2213" class="difflineplus">+function spinEventLoop() {</span>
<a href="#l30.2214"></a><span id="l30.2214" class="difflineplus">+    let diff = (new Date()).getTime() - spinEventLoop.lastSpin;</span>
<a href="#l30.2215"></a><span id="l30.2215" class="difflineplus">+    if (diff &lt; Preferences.get(&quot;calendar.threading.latency&quot;, 250)) {</span>
<a href="#l30.2216"></a><span id="l30.2216" class="difflineplus">+        return Promise.resolve(false);</span>
<a href="#l30.2217"></a><span id="l30.2217" class="difflineplus">+    }</span>
<a href="#l30.2218"></a><span id="l30.2218" class="difflineplus">+    spinEventLoop.lastSpin = new Date();</span>
<a href="#l30.2219"></a><span id="l30.2219" class="difflineplus">+</span>
<a href="#l30.2220"></a><span id="l30.2220" class="difflineplus">+    return new Promise(function(resolve) {</span>
<a href="#l30.2221"></a><span id="l30.2221" class="difflineplus">+      Services.tm.currentThread.dispatch({ run: function() resolve(true) }, 0);</span>
<a href="#l30.2222"></a><span id="l30.2222" class="difflineplus">+    });</span>
<a href="#l30.2223"></a><span id="l30.2223" class="difflineplus">+}</span>
<a href="#l30.2224"></a><span id="l30.2224" class="difflineplus">+spinEventLoop.lastSpin = new Date().getTime();</span>
<a href="#l30.2225"></a><span id="l30.2225" class="difflineplus">+</span>
<a href="#l30.2226"></a><span id="l30.2226" class="difflineplus">+/**</span>
<a href="#l30.2227"></a><span id="l30.2227" class="difflineplus">+ * Shim for Promise.all needed for Gecko 24</span>
<a href="#l30.2228"></a><span id="l30.2228" class="difflineplus">+ */</span>
<a href="#l30.2229"></a><span id="l30.2229" class="difflineplus">+PromiseAll = function (aValues) {</span>
<a href="#l30.2230"></a><span id="l30.2230" class="difflineplus">+  function checkForCompletion(aValue, aIndex) {</span>
<a href="#l30.2231"></a><span id="l30.2231" class="difflineplus">+    resolutionValues[aIndex] = aValue;</span>
<a href="#l30.2232"></a><span id="l30.2232" class="difflineplus">+    if (--countdown === 0) {</span>
<a href="#l30.2233"></a><span id="l30.2233" class="difflineplus">+      deferred.resolve(resolutionValues);</span>
<a href="#l30.2234"></a><span id="l30.2234">     }</span>
<a href="#l30.2235"></a><span id="l30.2235" class="difflineplus">+  }</span>
<a href="#l30.2236"></a><span id="l30.2236"> </span>
<a href="#l30.2237"></a><span id="l30.2237" class="difflineminus">-    let rstr = &quot;\n&quot;;</span>
<a href="#l30.2238"></a><span id="l30.2238" class="difflineminus">-    if (item.recurrenceInfo) {</span>
<a href="#l30.2239"></a><span id="l30.2239" class="difflineminus">-        let ritems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l30.2240"></a><span id="l30.2240" class="difflineminus">-        for each (let ritem in ritems) {</span>
<a href="#l30.2241"></a><span id="l30.2241" class="difflineminus">-            rstr += &quot;\t\t&quot; + ritem.icalProperty.icalString;</span>
<a href="#l30.2242"></a><span id="l30.2242" class="difflineminus">-        }</span>
<a href="#l30.2243"></a><span id="l30.2243" class="difflineplus">+  if (aValues == null || !Array.isArray(aValues)) {</span>
<a href="#l30.2244"></a><span id="l30.2244" class="difflineplus">+    throw new Error(&quot;Promise.all() expects an array.&quot;);</span>
<a href="#l30.2245"></a><span id="l30.2245" class="difflineplus">+  }</span>
<a href="#l30.2246"></a><span id="l30.2246" class="difflineplus">+</span>
<a href="#l30.2247"></a><span id="l30.2247" class="difflineplus">+  let values = aValues;</span>
<a href="#l30.2248"></a><span id="l30.2248" class="difflineplus">+  let countdown = values.length;</span>
<a href="#l30.2249"></a><span id="l30.2249" class="difflineplus">+  let resolutionValues = new Array(countdown);</span>
<a href="#l30.2250"></a><span id="l30.2250" class="difflineplus">+</span>
<a href="#l30.2251"></a><span id="l30.2251" class="difflineplus">+  if (!countdown) {</span>
<a href="#l30.2252"></a><span id="l30.2252" class="difflineplus">+    return Promise.resolve(resolutionValues);</span>
<a href="#l30.2253"></a><span id="l30.2253" class="difflineplus">+  }</span>
<a href="#l30.2254"></a><span id="l30.2254" class="difflineplus">+</span>
<a href="#l30.2255"></a><span id="l30.2255" class="difflineplus">+  let deferred = Promise.defer();</span>
<a href="#l30.2256"></a><span id="l30.2256" class="difflineplus">+  for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l30.2257"></a><span id="l30.2257" class="difflineplus">+    let index = i;</span>
<a href="#l30.2258"></a><span id="l30.2258" class="difflineplus">+    let value = values[i];</span>
<a href="#l30.2259"></a><span id="l30.2259" class="difflineplus">+    let resolver = function(val) checkForCompletion(val, index);</span>
<a href="#l30.2260"></a><span id="l30.2260" class="difflineplus">+</span>
<a href="#l30.2261"></a><span id="l30.2261" class="difflineplus">+    if (value &amp;&amp; typeof(value.then) == &quot;function&quot;) {</span>
<a href="#l30.2262"></a><span id="l30.2262" class="difflineplus">+      value.then(resolver, deferred.reject);</span>
<a href="#l30.2263"></a><span id="l30.2263" class="difflineplus">+    } else {</span>
<a href="#l30.2264"></a><span id="l30.2264" class="difflineplus">+      // Given value is not a promise, forward it as a resolution value.</span>
<a href="#l30.2265"></a><span id="l30.2265" class="difflineplus">+      resolver(value);</span>
<a href="#l30.2266"></a><span id="l30.2266" class="difflineplus">+    }</span>
<a href="#l30.2267"></a><span id="l30.2267" class="difflineplus">+  }</span>
<a href="#l30.2268"></a><span id="l30.2268" class="difflineplus">+</span>
<a href="#l30.2269"></a><span id="l30.2269" class="difflineplus">+  return deferred.promise;</span>
<a href="#l30.2270"></a><span id="l30.2270" class="difflineplus">+};</span>
<a href="#l30.2271"></a><span id="l30.2271"> </span>
<a href="#l30.2272"></a><span id="l30.2272" class="difflineminus">-        rstr += &quot;\tExceptions:\n&quot;;</span>
<a href="#l30.2273"></a><span id="l30.2273" class="difflineminus">-        let exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l30.2274"></a><span id="l30.2274" class="difflineminus">-        for each (let exc in exids) {</span>
<a href="#l30.2275"></a><span id="l30.2275" class="difflineminus">-            rstr += &quot;\t\t&quot; + exc + &quot;\n&quot;;</span>
<a href="#l30.2276"></a><span id="l30.2276" class="difflineplus">+/**</span>
<a href="#l30.2277"></a><span id="l30.2277" class="difflineplus">+ * Shim for calAsyncUtils' promsifyCalendar for Lightning 2.6 - 3.5</span>
<a href="#l30.2278"></a><span id="l30.2278" class="difflineplus">+ */</span>
<a href="#l30.2279"></a><span id="l30.2279" class="difflineplus">+function promisifyCalendar(aCalendar) {</span>
<a href="#l30.2280"></a><span id="l30.2280" class="difflineplus">+    function promiseOperationListener(deferred) {</span>
<a href="#l30.2281"></a><span id="l30.2281" class="difflineplus">+        return {</span>
<a href="#l30.2282"></a><span id="l30.2282" class="difflineplus">+            items: [],</span>
<a href="#l30.2283"></a><span id="l30.2283" class="difflineplus">+            itemStatus: Components.results.NS_OK,</span>
<a href="#l30.2284"></a><span id="l30.2284" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail,</span>
<a href="#l30.2285"></a><span id="l30.2285" class="difflineplus">+                                  aCount, aItems) {</span>
<a href="#l30.2286"></a><span id="l30.2286" class="difflineplus">+                this.itemStatus = aStatus;</span>
<a href="#l30.2287"></a><span id="l30.2287" class="difflineplus">+                if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l30.2288"></a><span id="l30.2288" class="difflineplus">+                    this.items = this.items.concat(aItems);</span>
<a href="#l30.2289"></a><span id="l30.2289" class="difflineplus">+                } else {</span>
<a href="#l30.2290"></a><span id="l30.2290" class="difflineplus">+                    this.itemSuccess = aStatus;</span>
<a href="#l30.2291"></a><span id="l30.2291" class="difflineplus">+                }</span>
<a href="#l30.2292"></a><span id="l30.2292" class="difflineplus">+            },</span>
<a href="#l30.2293"></a><span id="l30.2293" class="difflineplus">+</span>
<a href="#l30.2294"></a><span id="l30.2294" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l30.2295"></a><span id="l30.2295" class="difflineplus">+                if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l30.2296"></a><span id="l30.2296" class="difflineplus">+                    // This function has failed, reject with the status</span>
<a href="#l30.2297"></a><span id="l30.2297" class="difflineplus">+                    deferred.reject(aStatus)</span>
<a href="#l30.2298"></a><span id="l30.2298" class="difflineplus">+                } else if (!Components.isSuccessCode(this.itemStatus)) {</span>
<a href="#l30.2299"></a><span id="l30.2299" class="difflineplus">+                    // onGetResult has failed, reject with its status</span>
<a href="#l30.2300"></a><span id="l30.2300" class="difflineplus">+                    deferred.reject(this.itemStatus);</span>
<a href="#l30.2301"></a><span id="l30.2301" class="difflineplus">+                } else if (aOpType == cIOL.GET) {</span>
<a href="#l30.2302"></a><span id="l30.2302" class="difflineplus">+                     // Success of a GET operation: resolve with array of</span>
<a href="#l30.2303"></a><span id="l30.2303" class="difflineplus">+                     // resulting items.</span>
<a href="#l30.2304"></a><span id="l30.2304" class="difflineplus">+                    deferred.resolve(this.items);</span>
<a href="#l30.2305"></a><span id="l30.2305" class="difflineplus">+                } else { /* ADD,MODIFY,DELETE: resolve with 1 item */</span>
<a href="#l30.2306"></a><span id="l30.2306" class="difflineplus">+                    // Success of an ADD MODIFY or DELETE operation, resolve</span>
<a href="#l30.2307"></a><span id="l30.2307" class="difflineplus">+                    // with the one item that was processed.</span>
<a href="#l30.2308"></a><span id="l30.2308" class="difflineplus">+                    deferred.resolve(aDetail)</span>
<a href="#l30.2309"></a><span id="l30.2309" class="difflineplus">+                }</span>
<a href="#l30.2310"></a><span id="l30.2310" class="difflineplus">+            }</span>
<a href="#l30.2311"></a><span id="l30.2311">         }</span>
<a href="#l30.2312"></a><span id="l30.2312">     }</span>
<a href="#l30.2313"></a><span id="l30.2313"> </span>
<a href="#l30.2314"></a><span id="l30.2314" class="difflineminus">-    let astr = &quot;\n&quot;;</span>
<a href="#l30.2315"></a><span id="l30.2315" class="difflineminus">-    let alarms = item.getAlarms({});</span>
<a href="#l30.2316"></a><span id="l30.2316" class="difflineminus">-    for each (let alarm in alarms) {</span>
<a href="#l30.2317"></a><span id="l30.2317" class="difflineminus">-        astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l30.2318"></a><span id="l30.2318" class="difflineminus">-    }</span>
<a href="#l30.2319"></a><span id="l30.2319" class="difflineminus">-</span>
<a href="#l30.2320"></a><span id="l30.2320" class="difflineminus">-    cal.LOG(&quot;[calGoogleCalendar] Logging calIEvent:&quot; +</span>
<a href="#l30.2321"></a><span id="l30.2321" class="difflineminus">-        &quot;\n\tid:&quot; + item.id +</span>
<a href="#l30.2322"></a><span id="l30.2322" class="difflineminus">-        &quot;\n\tediturl:&quot; + item.getProperty(&quot;X-GOOGLE-EDITURL&quot;) +</span>
<a href="#l30.2323"></a><span id="l30.2323" class="difflineminus">-        &quot;\n\tcreated:&quot; + item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l30.2324"></a><span id="l30.2324" class="difflineminus">-        &quot;\n\tupdated:&quot; + item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l30.2325"></a><span id="l30.2325" class="difflineminus">-        &quot;\n\ttitle:&quot; + item.title +</span>
<a href="#l30.2326"></a><span id="l30.2326" class="difflineminus">-        &quot;\n\tcontent:&quot; + item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l30.2327"></a><span id="l30.2327" class="difflineminus">-        &quot;\n\ttransparency:&quot; + item.getProperty(&quot;TRANSP&quot;) +</span>
<a href="#l30.2328"></a><span id="l30.2328" class="difflineminus">-        &quot;\n\tstatus:&quot; + item.status +</span>
<a href="#l30.2329"></a><span id="l30.2329" class="difflineminus">-        &quot;\n\tstartTime:&quot; + item.startDate.toString() +</span>
<a href="#l30.2330"></a><span id="l30.2330" class="difflineminus">-        &quot;\n\tendTime:&quot; + item.endDate.toString() +</span>
<a href="#l30.2331"></a><span id="l30.2331" class="difflineminus">-        &quot;\n\tlocation:&quot; + item.getProperty(&quot;LOCATION&quot;) +</span>
<a href="#l30.2332"></a><span id="l30.2332" class="difflineminus">-        &quot;\n\tprivacy:&quot; + item.privacy +</span>
<a href="#l30.2333"></a><span id="l30.2333" class="difflineminus">-        &quot;\n\tsequence:&quot; + item.getProperty(&quot;SEQUENCE&quot;) +</span>
<a href="#l30.2334"></a><span id="l30.2334" class="difflineminus">-        &quot;\n\talarmLastAck:&quot; + item.alarmLastAck +</span>
<a href="#l30.2335"></a><span id="l30.2335" class="difflineminus">-        &quot;\n\tsnoozeTime:&quot; + item.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;) +</span>
<a href="#l30.2336"></a><span id="l30.2336" class="difflineminus">-        &quot;\n\tisOccurrence: &quot; + (item.recurrenceId != null) +</span>
<a href="#l30.2337"></a><span id="l30.2337" class="difflineminus">-        &quot;\n\tOrganizer: &quot; + LOGattendee(item.organizer) +</span>
<a href="#l30.2338"></a><span id="l30.2338" class="difflineminus">-        &quot;\n\tAttendees: &quot; + attendeeString +</span>
<a href="#l30.2339"></a><span id="l30.2339" class="difflineminus">-        &quot;\n\trecurrence: &quot; + (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;) +</span>
<a href="#l30.2340"></a><span id="l30.2340" class="difflineminus">-        &quot;\n\talarms: &quot; + (astr.length &gt; 1 ? &quot;yes: &quot; + astr : &quot;no&quot;));</span>
<a href="#l30.2341"></a><span id="l30.2341" class="difflineminus">-}</span>
<a href="#l30.2342"></a><span id="l30.2342" class="difflineminus">-</span>
<a href="#l30.2343"></a><span id="l30.2343" class="difflineminus">-function LOGattendee(aAttendee, asString) {</span>
<a href="#l30.2344"></a><span id="l30.2344" class="difflineminus">-    return aAttendee &amp;&amp;</span>
<a href="#l30.2345"></a><span id="l30.2345" class="difflineminus">-        (&quot;\n\t\tID: &quot; + aAttendee.id +</span>
<a href="#l30.2346"></a><span id="l30.2346" class="difflineminus">-         &quot;\n\t\t\tName: &quot; + aAttendee.commonName +</span>
<a href="#l30.2347"></a><span id="l30.2347" class="difflineminus">-         &quot;\n\t\t\tRsvp: &quot; + aAttendee.rsvp +</span>
<a href="#l30.2348"></a><span id="l30.2348" class="difflineminus">-         &quot;\n\t\t\tIs Organizer: &quot; +  (aAttendee.isOrganizer ? &quot;yes&quot; : &quot;no&quot;) +</span>
<a href="#l30.2349"></a><span id="l30.2349" class="difflineminus">-         &quot;\n\t\t\tRole: &quot; + aAttendee.role +</span>
<a href="#l30.2350"></a><span id="l30.2350" class="difflineminus">-         &quot;\n\t\t\tStatus: &quot; + aAttendee.participationStatus);</span>
<a href="#l30.2351"></a><span id="l30.2351" class="difflineplus">+    const promisifyProxyHandler = {</span>
<a href="#l30.2352"></a><span id="l30.2352" class="difflineplus">+        promiseOperation: function(target, name, args) {</span>
<a href="#l30.2353"></a><span id="l30.2353" class="difflineplus">+            let deferred = Promise.defer();</span>
<a href="#l30.2354"></a><span id="l30.2354" class="difflineplus">+            let listener = promiseOperationListener(deferred);</span>
<a href="#l30.2355"></a><span id="l30.2355" class="difflineplus">+            args.push(listener);</span>
<a href="#l30.2356"></a><span id="l30.2356" class="difflineplus">+            target[name].apply(target, args);</span>
<a href="#l30.2357"></a><span id="l30.2357" class="difflineplus">+            return deferred.promise;</span>
<a href="#l30.2358"></a><span id="l30.2358" class="difflineplus">+        },</span>
<a href="#l30.2359"></a><span id="l30.2359" class="difflineplus">+        get: function(target, name) {</span>
<a href="#l30.2360"></a><span id="l30.2360" class="difflineplus">+            switch (name) {</span>
<a href="#l30.2361"></a><span id="l30.2361" class="difflineplus">+                case &quot;adoptItem&quot;:</span>
<a href="#l30.2362"></a><span id="l30.2362" class="difflineplus">+                case &quot;addItem&quot;:</span>
<a href="#l30.2363"></a><span id="l30.2363" class="difflineplus">+                case &quot;modifyItem&quot;:</span>
<a href="#l30.2364"></a><span id="l30.2364" class="difflineplus">+                case &quot;deleteItem&quot;:</span>
<a href="#l30.2365"></a><span id="l30.2365" class="difflineplus">+                case &quot;getItem&quot;:</span>
<a href="#l30.2366"></a><span id="l30.2366" class="difflineplus">+                case &quot;getItems&quot;:</span>
<a href="#l30.2367"></a><span id="l30.2367" class="difflineplus">+                    return function() {</span>
<a href="#l30.2368"></a><span id="l30.2368" class="difflineplus">+                        return this.promiseOperation(target, name, Array.slice(arguments));</span>
<a href="#l30.2369"></a><span id="l30.2369" class="difflineplus">+                    }.bind(this);</span>
<a href="#l30.2370"></a><span id="l30.2370" class="difflineplus">+                case &quot;getAllItems&quot;:</span>
<a href="#l30.2371"></a><span id="l30.2371" class="difflineplus">+                    return function() {</span>
<a href="#l30.2372"></a><span id="l30.2372" class="difflineplus">+                        return this.promiseOperation(target, &quot;getItems&quot;, [cIC.ITEM_FILTER_ALL_ITEMS, 0, null, null]);</span>
<a href="#l30.2373"></a><span id="l30.2373" class="difflineplus">+                    }.bind(this);</span>
<a href="#l30.2374"></a><span id="l30.2374" class="difflineplus">+                default:</span>
<a href="#l30.2375"></a><span id="l30.2375" class="difflineplus">+                    return target[name];</span>
<a href="#l30.2376"></a><span id="l30.2376" class="difflineplus">+            }</span>
<a href="#l30.2377"></a><span id="l30.2377" class="difflineplus">+        }</span>
<a href="#l30.2378"></a><span id="l30.2378" class="difflineplus">+    };</span>
<a href="#l30.2379"></a><span id="l30.2379" class="difflineplus">+    return {</span>
<a href="#l30.2380"></a><span id="l30.2380" class="difflineplus">+        // Backwards compat, we can use |new Proxy(aCalendar, promisifyProxyHandler);| in the future.</span>
<a href="#l30.2381"></a><span id="l30.2381" class="difflineplus">+        adoptItem: function(aItem) promisifyProxyHandler.get(aCalendar, &quot;adoptItem&quot;).apply(this, arguments),</span>
<a href="#l30.2382"></a><span id="l30.2382" class="difflineplus">+        addItem: function(aItem) promisifyProxyHandler.get(aCalendar, &quot;addItem&quot;).apply(this, arguments),</span>
<a href="#l30.2383"></a><span id="l30.2383" class="difflineplus">+        modifyItem: function(aItem) promisifyProxyHandler.get(aCalendar, &quot;modifyItem&quot;).apply(this, arguments),</span>
<a href="#l30.2384"></a><span id="l30.2384" class="difflineplus">+        deleteItem: function(aItem) promisifyProxyHandler.get(aCalendar, &quot;deleteItem&quot;).apply(this, arguments),</span>
<a href="#l30.2385"></a><span id="l30.2385" class="difflineplus">+        getItem: function(aItem) promisifyProxyHandler.get(aCalendar, &quot;getItem&quot;).apply(this, arguments),</span>
<a href="#l30.2386"></a><span id="l30.2386" class="difflineplus">+        getItems: function(aItems) promisifyProxyHandler.get(aCalendar, &quot;getItems&quot;).apply(this, arguments),</span>
<a href="#l30.2387"></a><span id="l30.2387" class="difflineplus">+    };</span>
<a href="#l30.2388"></a><span id="l30.2388"> }</span>
<a href="#l30.2389"></a><span id="l30.2389" class="difflineminus">-</span>
<a href="#l30.2390"></a><span id="l30.2390" class="difflineminus">-function LOGalarm(aAlarm) {</span>
<a href="#l30.2391"></a><span id="l30.2391" class="difflineminus">-    if (!aAlarm) {</span>
<a href="#l30.2392"></a><span id="l30.2392" class="difflineminus">-        return &quot;&quot;;</span>
<a href="#l30.2393"></a><span id="l30.2393" class="difflineminus">-    }</span>
<a href="#l30.2394"></a><span id="l30.2394" class="difflineminus">-</span>
<a href="#l30.2395"></a><span id="l30.2395" class="difflineminus">-    let enumerator = aAlarm.propertyEnumerator;</span>
<a href="#l30.2396"></a><span id="l30.2396" class="difflineminus">-    let xpropstr = &quot;&quot;;</span>
<a href="#l30.2397"></a><span id="l30.2397" class="difflineminus">-    while (enumerator.hasMoreElements()) {</span>
<a href="#l30.2398"></a><span id="l30.2398" class="difflineminus">-        let el = enumerator.getNext();</span>
<a href="#l30.2399"></a><span id="l30.2399" class="difflineminus">-        xpropstr += &quot;\n\t\t\t&quot; + el.key + &quot;:&quot; + el.value;</span>
<a href="#l30.2400"></a><span id="l30.2400" class="difflineminus">-    }</span>
<a href="#l30.2401"></a><span id="l30.2401" class="difflineminus">-</span>
<a href="#l30.2402"></a><span id="l30.2402" class="difflineminus">-    return (&quot;\n\t\tAction: &quot; +  aAlarm.action +</span>
<a href="#l30.2403"></a><span id="l30.2403" class="difflineminus">-            &quot;\n\t\tOffset: &quot; + (aAlarm.offset &amp;&amp; aAlarm.offset.toString()) +</span>
<a href="#l30.2404"></a><span id="l30.2404" class="difflineminus">-            &quot;\n\t\talarmDate: &quot; + (aAlarm.alarmDate &amp;&amp; aAlarm.alarmDate.toString()) +</span>
<a href="#l30.2405"></a><span id="l30.2405" class="difflineminus">-            &quot;\n\t\trelated: &quot; + aAlarm.related +</span>
<a href="#l30.2406"></a><span id="l30.2406" class="difflineminus">-            &quot;\n\t\trepeat: &quot; + aAlarm.repeat +</span>
<a href="#l30.2407"></a><span id="l30.2407" class="difflineminus">-            &quot;\n\t\trepeatOffset: &quot; + (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span>
<a href="#l30.2408"></a><span id="l30.2408" class="difflineminus">-            &quot;\n\t\trepeatDate: &quot; + (aAlarm.repeatDate &amp;&amp; aAlarm.repeatDate.toString()) +</span>
<a href="#l30.2409"></a><span id="l30.2409" class="difflineminus">-            &quot;\n\t\tdescription: &quot; + aAlarm.description +</span>
<a href="#l30.2410"></a><span id="l30.2410" class="difflineminus">-            &quot;\n\t\tsummary: &quot; + aAlarm.summary +</span>
<a href="#l30.2411"></a><span id="l30.2411" class="difflineminus">-            &quot;\n\t\tproperties: &quot; + (xpropstr.length &gt; 0 ? &quot;yes:&quot; + xpropstr : &quot;no&quot;));</span>
<a href="#l30.2412"></a><span id="l30.2412" class="difflineminus">-}</span>
<a href="#l30.2413"></a><span id="l30.2413" class="difflineminus">-</span>
<a href="#l30.2414"></a><span id="l30.2414" class="difflineminus">-function LOGinterval(aInterval) {</span>
<a href="#l30.2415"></a><span id="l30.2415" class="difflineminus">-    const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l30.2416"></a><span id="l30.2416" class="difflineminus">-    if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l30.2417"></a><span id="l30.2417" class="difflineminus">-        type = &quot;FREE&quot;;</span>
<a href="#l30.2418"></a><span id="l30.2418" class="difflineminus">-    } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l30.2419"></a><span id="l30.2419" class="difflineminus">-        type = &quot;BUSY&quot;;</span>
<a href="#l30.2420"></a><span id="l30.2420" class="difflineminus">-    } else {</span>
<a href="#l30.2421"></a><span id="l30.2421" class="difflineminus">-        type = aInterval.freeBusyType + &quot;(UNKNOWN)&quot;;</span>
<a href="#l30.2422"></a><span id="l30.2422" class="difflineminus">-    }</span>
<a href="#l30.2423"></a><span id="l30.2423" class="difflineminus">-</span>
<a href="#l30.2424"></a><span id="l30.2424" class="difflineminus">-    cal.LOG(&quot;[calGoogleCalendar] Interval from &quot; +</span>
<a href="#l30.2425"></a><span id="l30.2425" class="difflineminus">-            aInterval.interval.start + &quot; to &quot; + aInterval.interval.end +</span>
<a href="#l30.2426"></a><span id="l30.2426" class="difflineminus">-            &quot; is &quot; + type);</span>
<a href="#l30.2427"></a><span id="l30.2427" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Calendar.jsm</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,188 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;calendarShim&quot;, &quot;gdataRegisterCalendar&quot;];</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+/**</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+ * Shim functions that can be injected into an object implementing calICalendar</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+ * to make it compatible with older versions of Lightning</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+ */</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+var calendarShim = {</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+    addItemOrUseCache: function(aItem, useCache, aListener) {</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+        let newItem = aItem.clone();</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+        return this.adoptItemOrUseCache(newItem, useCache, aListener);</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+    },</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+    adoptItemOrUseCache: function(aItem, useCache, aListener) {</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+        let self = this;</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+        let addOfflineListener = {</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+                    let storage = self.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+                    storage.addOfflineItem(detail, aListener);</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+                } else if (aListener) {</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+                    aListener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+                }</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+            }</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+        };</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+        let intermediateListener = {</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+            onGetResult: function() {},</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOp, aId, aInnerItem) {</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+                if (useCache) {</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+                    if (isUnavailableCode(aStatus)) {</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+                        self.mOfflineStorage.adoptItem(aInnerItem, addOfflineListener);</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+                    } else {</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+                        self.mOfflineStorage.addItem(aInnerItem, aListener);</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+                    }</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+                } else {</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+                    aListener.onOperationComplete.apply(aListener, arguments);</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+                }</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+            }</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+        };</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+        return this.adoptItem(aItem, intermediateListener);</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+    },</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+    modifyItemOrUseCache: function modifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener) {</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+        let self = this;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+        let modifyOfflineListener = {</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+                storage.modifyOfflineItem(detail, aListener);</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+            }</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+        };</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+        let offlineFlagListener = {</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+                    storage.modifyItem(aNewItem, aOldItem, modifyOfflineListener);</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+                } else {</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+                    self.modifyItem(aNewItem, aOldItem, aListener);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+                }</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+            }</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+        };</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+        storage.getItemOfflineFlag(aOldItem, offlineFlagListener);</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+    },</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+    deleteItemOrUseCache: function deleteItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+        let self = this;</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+        let deleteOfflineListener = {</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+                if (aListener) {</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+                    aListener.onOperationComplete(calendar, status, opType, aItem.id, aItem);</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+                }</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+            }</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+        };</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+        let offlineFlagListener = {</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+                    /* We do not delete the item from the cache, but mark it deleted */</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+                    storage.deleteOfflineItem(aItem, aListener);</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+                } else {</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+                    self.deleteItem(aItem, aListener);</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+                }</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+            }</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+        };</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+        storage.getItemOfflineFlag(aItem, offlineFlagListener);</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+    },</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+    notifyPureOperationComplete: function(aListener, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+        let protoComplete = this.__proto__.__proto__.notifyPureOperationComplete;</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+        if (protoComplete) {</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+            protoComplete.apply(this, arguments);</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+        } else {</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+            // Shim for older versions of Lightning</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+            if (aListener) {</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+                try {</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+                    aListener.onOperationComplete(this.superCalendar, aStatus, aOpType, aId, aDetail);</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+                } catch (exc) {</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+                    cal.ERROR(exc);</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+                }</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+            }</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+        }</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+    }</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+};</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+/**</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+ * Checks if the error code is a code that happens when there is a network</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+ * error or similar, that would make the calendar temporarily unavailable.</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+ *</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+ * @param result        The result code to check.</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+ * @return              True, if the code is an unavailable code.</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+ */</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+function isUnavailableCode(result) {</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+    // Stolen from nserror.h</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+    const NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+    function NS_ERROR_GET_MODULE(code) {</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+        return (((code &gt;&gt; 16) - 0x45) &amp; 0x1fff);</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+    }</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+    if (NS_ERROR_GET_MODULE(result) == NS_ERROR_MODULE_NETWORK &amp;&amp;</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+        !Components.isSuccessCode(result)) {</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+        // This is a network error, which most likely means we should</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+        // retry it some time.</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+        return true;</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+    }</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+    // Other potential errors we want to retry with</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+    switch (result) {</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+            return true;</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+        default:</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineplus">+            return false;</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+    }</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+}</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+/**</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+ * A replacement for calICalendarManager::registerCalendar, that allows</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+ * registering calendars with an existing id. This is needed for backwards</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+ * compatibility before Gecko 9.</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+ *</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+ * @param calendar      The calendar to register</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+ */</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+function gdataRegisterCalendar(calendar) {</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+    if (!calendar.id) {</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineplus">+        calendar.id = cal.getUUID();</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+    }</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+    let branch = &quot;calendar.registry.&quot; + calendar.id + &quot;.&quot;;</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+    cal.setPref(branch + &quot;type&quot;, calendar.type);</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+    cal.setPref(branch + &quot;uri&quot;, calendar.uri.spec);</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineplus">+    let calmgr = cal.getCalendarManager().wrappedJSObject;</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+    let calCachedCalendar = Components.utils.getGlobalForObject(calmgr).calCachedCalendar;</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineplus">+    if ((calendar.getProperty(&quot;cache.supported&quot;) !== false) &amp;&amp;</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineplus">+        calendar.getProperty(&quot;cache.enabled&quot;)) {</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+        calendar = new calCachedCalendar(calendar);</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+    }</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineplus">+</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineplus">+    calmgr.setupCalendar(calendar);</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineplus">+              .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+              .savePrefFile(null);</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+    if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+        calendar.refresh();</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+    }</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+    calmgr.notifyObservers(&quot;onCalendarRegistered&quot;, [calendar]);</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Http.jsm</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,79 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;percentEncode&quot;, &quot;httpRequest&quot;];</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+function percentEncode(aString)</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+  encodeURIComponent(aString).replace(/[!'()]/g, escape).replace(/\*/g, &quot;%2A&quot;);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+function httpRequest(aUrl, aOptions) {</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+  let xhr = Cc[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+              .createInstance(Ci.nsIXMLHttpRequest);</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+  xhr.mozBackgroundRequest = true; // no error dialogs</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+  xhr.open(aOptions.method || (aOptions.postData ? &quot;POST&quot; : &quot;GET&quot;), aUrl);</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+  xhr.channel.loadFlags = Ci.nsIChannel.LOAD_ANONYMOUS | // don't send cookies</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+                          Ci.nsIChannel.LOAD_BYPASS_CACHE |</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+                          Ci.nsIChannel.INHIBIT_CACHING;</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+  xhr.onerror = function(aProgressEvent) {</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+    if (aOptions.onError) {</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+      // adapted from toolkit/mozapps/extensions/nsBlocklistService.js</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+      let request = aProgressEvent.target;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+      let status;</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+      try {</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+        // may throw (local file or timeout)</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+        status = request.status;</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+      }</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+      catch (e) {</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+        request = request.channel.QueryInterface(Ci.nsIRequest);</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+        status = request.status;</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+      }</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+      // When status is 0 we don't have a valid channel.</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+      let statusText = status ? request.statusText : &quot;offline&quot;;</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+      aOptions.onError(statusText, null, this);</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+    }</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+  };</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+  xhr.onload = function(aRequest) {</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+    try {</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+      let target = aRequest.target;</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+      if (aOptions.logger)</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+        aOptions.logger.debug(&quot;Received response: &quot; + target.responseText);</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+      if (target.status &lt; 200 || target.status &gt;= 300) {</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+        let errorText = target.responseText;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+        if (!errorText || /&lt;(ht|\?x)ml\b/i.test(errorText))</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+          errorText = target.statusText;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+        throw target.status + &quot; - &quot; + errorText;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+      }</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+      if (aOptions.onLoad)</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+        aOptions.onLoad(target.responseText, this);</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+    } catch (e) {</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+      if (aOptions.onError)</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+        aOptions.onError(e, aRequest.target.responseText, this);</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+    }</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+  };</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+  if (aOptions.headers) {</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+    aOptions.headers.forEach(function(header) {</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+      xhr.setRequestHeader(header[0], header[1]);</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+    });</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  }</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+  // Handle adding postData as defined above.</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+  let POSTData = aOptions.postData || &quot;&quot;;</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+  if (Array.isArray(POSTData)) {</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+    xhr.setRequestHeader(&quot;Content-Type&quot;,</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+                         &quot;application/x-www-form-urlencoded; charset=utf-8&quot;);</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    POSTData = POSTData.map(function(p) p[0] + &quot;=&quot; + percentEncode(p[1]))</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+                       .join(&quot;&amp;&quot;);</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+  }</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  if (aOptions.logger) {</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+    aOptions.logger.log(&quot;sending request to &quot; + aUrl + &quot; (POSTData = &quot; +</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+                        POSTData + &quot;)&quot;);</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+  }</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+  xhr.send(POSTData);</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+  return xhr;</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Loader.jsm</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,206 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;CuImport&quot;, &quot;shimIt&quot;];</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+var CuImportSubstitutions = {</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+    &quot;resource://gre/modules/Promise.jsm&quot;: &quot;resource://gdata-provider/modules/shim/Promise.jsm&quot;,</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+    &quot;resource://gre/modules/Task.jsm&quot;: &quot;resource://gdata-provider/modules/shim/Task.jsm&quot;,</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+    &quot;resource://gre/modules/Timer.jsm&quot;: &quot;resource://gdata-provider/modules/shim/Timer.jsm&quot;,</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+    &quot;resource://gre/modules/Preferences.jsm&quot;: &quot;resource://gdata-provider/modules/shim/Preferences.jsm&quot;,</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+};</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+/**</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ * Attempt to import a module, falling back to the shim if it does not exist.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ */</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+function CuImport(uriSpec, globalObj) {</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+    try {</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+        Components.utils.import(uriSpec, globalObj)</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+    } catch (e if e.result == Components.results.NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+        if (uriSpec in CuImportSubstitutions) {</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+            // If we have a substitution, then load it now.</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+            Components.utils.import(CuImportSubstitutions[uriSpec], globalObj);</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+        } else {</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+            let fn = Components.stack.caller.filename;</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+            Components.utils.reportError(&quot;[calGoogleCalendar] Missing: &quot; + fn + &quot; -&gt; &quot; + uriSpec);</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+        }</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+    }</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+}</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+/**</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ * Inject any missing functions and objects into the given global</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ */</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+function shimIt(global) {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+    if (!global.String.prototype.startsWith) {</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+        Object.defineProperty(global.String.prototype, 'startsWith', {</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+            enumerable: false,</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+            configurable: false,</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+            writable: false,</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+            value: function(searchString, position) {</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+                position = position || 0;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+                return this.lastIndexOf(searchString, position) === position;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+            }</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+        });</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+    }</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+    if (!global.String.prototype.endsWith) {</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+        Object.defineProperty(global.String.prototype, 'endsWith', {</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+            value: function(searchString, position) {</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+                var subjectString = this.toString();</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+                if (position === undefined || position &gt; subjectString.length) {</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+                    position = subjectString.length;</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+                }</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+                position -= searchString.length;</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+                var lastIndex = subjectString.indexOf(searchString, position);</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+                return lastIndex !== -1 &amp;&amp; lastIndex === position;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+            }</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+        });</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+    }</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+    // See note at the bottom of https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/includes</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+    // for why the same method is used for contains/includes.</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+    if (!global.String.prototype.contains) {</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+        global.String.prototype.contains = StringContains;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+    }</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+    if (!global.String.prototype.includes) {</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+        global.String.prototype.includes = StringContains;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+    }</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+    if (!global.Map) {</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+        global.Map = Map;</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+    }</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+    if (!global.Set) {</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+        global.Set = Set;</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+    }</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+    if (typeof global.Map.prototype.forEach !== &quot;function&quot;) {</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+        global.Map.prototype.forEach = MapSetForEach;</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+    }</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+    if (typeof global.Set.prototype.forEach !== &quot;function&quot;) {</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+        global.Set.prototype.forEach = MapSetForEach;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+    }</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+}</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+/**</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+ * Implementation for String.prototype.includes/contains.</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+ */</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+function StringContains() {</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+    return String.prototype.indexOf.apply(this, arguments) !== -1;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+}</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+/**</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+ * forEach implementation for Map and Set, for Thunderbird 24</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+ */</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+function MapSetForEach(cb) {</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+    let iter = this.entries();</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+    while (1) {</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+        let k, v;</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+        try {</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+            [k,v] = iter.next();</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+        } catch (e if e instanceof StopIteration) {</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+              break;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+        }</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+        cb(v, k, this);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+    }</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+}</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+/**</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+ * This implementation of Map doesn't work quite like the ES6 Map, but it works</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+ * well enough for our purposes.</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+ */</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+function Map(values) {</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+    this.data = Object.create(null);</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+    if (values) {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+        for each (let [k,v] in values) {</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+            this.data[k] = v;</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+        }</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+    }</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+}</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+Map.prototype = {</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+    has: function(k) k in this.data,</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+    set: function(k, v) this.data[k] = v,</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+    get: function(k) this.data[k],</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+    delete: function(k) delete this.data[k],</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+    get size() Object.keys(this.data).length,</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+    forEach: function(cb) {</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+        for (let k in this.data) {</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+            cb(this.data[k], k, this);</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+        }</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+    },</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+    toSource: function() Object.prototype.toSource.call(this.data),</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+    __iterator__: function() new Iterator(this.data)</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+};</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+/**</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+ * Not a particularly fast implementation of Set, but since our keys can be</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+ * objects we can't just use normal js objects.</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+ */</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+function Set(values) {</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+    this.data = [];</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+    if (values) {</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+        values.forEach(this.add, this);</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+    }</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+}</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+Set.prototype = {</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+    has: function(v) {</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+        for each (let dv in this.data) {</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+            if (v == dv) return true;</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+        }</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+        return false;</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+    },</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+    get size() this.data.length,</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+    add: function(v) this.has(v) ? null : this.data.push(v),</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+    clear: function() this.data = [],</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+    delete: function(v) {</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+        for (let i = 0; i &lt; this.data.length; i++) {</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+            if (this.data[i] == v) {</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+                this.data.splice(i, 1);</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+                return;</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+            }</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+        }</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+    },</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+    forEach: function(cb) {</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+        for each (let v in this.data) {</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+            cb(v, v, this);</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+        }</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+    },</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+    toSource: function() this.data.toSource(),</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+    __iterator__: function() {</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+        for each (let v in this.data) {</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+            yield v;</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+        }</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+    }</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+};</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineplus">+if (!cal.hashColor) {</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+    cal.hashColor = function hashColor(str) {</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+        // This is the palette of colors in the current colorpicker implementation.</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+        // Unfortunately, there is no easy way to extract these colors from the</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+        // binding directly.</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineplus">+        const colorPalette = [&quot;#FFFFFF&quot;, &quot;#FFCCCC&quot;, &quot;#FFCC99&quot;, &quot;#FFFF99&quot;, &quot;#FFFFCC&quot;,</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+                              &quot;#99FF99&quot;, &quot;#99FFFF&quot;, &quot;#CCFFFF&quot;, &quot;#CCCCFF&quot;, &quot;#FFCCFF&quot;,</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineplus">+                              &quot;#CCCCCC&quot;, &quot;#FF6666&quot;, &quot;#FF9966&quot;, &quot;#FFFF66&quot;, &quot;#FFFF33&quot;,</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+                              &quot;#66FF99&quot;, &quot;#33FFFF&quot;, &quot;#66FFFF&quot;, &quot;#9999FF&quot;, &quot;#FF99FF&quot;,</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+                              &quot;#C0C0C0&quot;, &quot;#FF0000&quot;, &quot;#FF9900&quot;, &quot;#FFCC66&quot;, &quot;#FFFF00&quot;,</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineplus">+                              &quot;#33FF33&quot;, &quot;#66CCCC&quot;, &quot;#33CCFF&quot;, &quot;#6666CC&quot;, &quot;#CC66CC&quot;,</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineplus">+                              &quot;#999999&quot;, &quot;#CC0000&quot;, &quot;#FF6600&quot;, &quot;#FFCC33&quot;, &quot;#FFCC00&quot;,</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineplus">+                              &quot;#33CC00&quot;, &quot;#00CCCC&quot;, &quot;#3366FF&quot;, &quot;#6633FF&quot;, &quot;#CC33CC&quot;,</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+                              &quot;#666666&quot;, &quot;#990000&quot;, &quot;#CC6600&quot;, &quot;#CC9933&quot;, &quot;#999900&quot;,</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+                              &quot;#009900&quot;, &quot;#339999&quot;, &quot;#3333FF&quot;, &quot;#6600CC&quot;, &quot;#993399&quot;,</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+                              &quot;#333333&quot;, &quot;#660000&quot;, &quot;#993300&quot;, &quot;#996633&quot;, &quot;#666600&quot;,</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineplus">+                              &quot;#006600&quot;, &quot;#336666&quot;, &quot;#000099&quot;, &quot;#333399&quot;, &quot;#663366&quot;,</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineplus">+                              &quot;#000000&quot;, &quot;#330000&quot;, &quot;#663300&quot;, &quot;#663333&quot;, &quot;#333300&quot;,</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineplus">+                              &quot;#003300&quot;, &quot;#003333&quot;, &quot;#000066&quot;, &quot;#330099&quot;, &quot;#330033&quot;];</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineplus">+</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineplus">+        let sum = Array.map(str || &quot; &quot;, function(e) e.charCodeAt(0)).reduce(function(a,b) a + b);</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineplus">+        return colorPalette[sum % colorPalette.length];</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+    }</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Preferences.jsm</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;Preferences&quot;];</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+var Preferences = {</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+    has: function(k) !!cal.getPrefSafe(k),</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+    get: function(k, v) cal.getPrefSafe(k, v),</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+    set: function(k, v) cal.setPref(k, v)</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Promise.jsm</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,156 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;Promise&quot;];</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+const STATUS_PENDING = 0;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+const STATUS_RESOLVED = 1;</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+const STATUS_REJECTED = 2;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+function log(msg) {</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+    // Enable this to debug promises</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+    //dump(&quot;PROMISES: &quot; + msg + &quot;\n&quot;);</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+}</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+var PromiseWalker = {</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+    handlers: [],</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+    completePromise: function(aPromise, aStatus, aValue) {</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+        if (aPromise._status != STATUS_PENDING) {</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+            return;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+        }</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+        if (aStatus == STATUS_RESOLVED &amp;&amp; aValue &amp;&amp;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+            typeof(aValue.then) == &quot;function&quot;) {</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+          aValue.then(this.completePromise.bind(this, aPromise, STATUS_RESOLVED),</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+                      this.completePromise.bind(this, aPromise, STATUS_REJECTED));</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+          return;</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+        }</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+        aPromise._status = aStatus;</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+        aPromise._value = aValue;</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+        if (aPromise._handlers.length &gt; 0) {</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+            this.schedulePromise(aPromise);</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+        } else if (aStatus == STATUS_REJECTED) {</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+            log(&quot;Pending error: &quot; + aValue);</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+        }</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+    },</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+    scheduleWalkerLoop: function() {</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+        this.walkerLoopScheduled = true;</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+        let thread = Components.classes[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+                               .getService(Components.interfaces.nsIThreadManager)</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+                               .currentThread;</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+        thread.dispatch({</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+            run: function() {</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+                PromiseWalker.walkerLoop();</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+            }</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+        }, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+    },</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+    schedulePromise: function (aPromise) {</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+        for each (let handler in aPromise._handlers) {</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+            this.handlers.push(handler);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+        }</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+        aPromise._handlers.length = 0;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+        if (!this.walkerLoopScheduled) {</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+            this.scheduleWalkerLoop();</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+        }</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+    },</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+    walkerLoopScheduled: false,</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+    walkerLoop: function() {</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+        if (this.handlers.length &gt; 1) {</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+            this.scheduleWalkerLoop();</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+        } else {</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+            this.walkerLoopScheduled = false;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+        }</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+        while (this.handlers.length &gt; 0) {</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+            this.handlers.shift().process();</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+        }</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+    }</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+};</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+PromiseWalker.walkerLoop = PromiseWalker.walkerLoop.bind(PromiseWalker);</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+function Handler(aThisPromise, aOnResolve, aOnReject) {</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+    this.thisPromise = aThisPromise;</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+    this.onResolve = aOnResolve;</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+    this.onReject = aOnReject;</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    this.nextPromise = new Promise(function() {});</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+}</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+Handler.prototype = {</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+    process: function() {</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+        let nextStatus = this.thisPromise._status;</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+        let nextValue = this.thisPromise._value;</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+        try {</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+            if (nextStatus == STATUS_RESOLVED) {</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+                if (typeof(this.onResolve) == &quot;function&quot;) {</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+                    nextValue = this.onResolve.call(undefined, nextValue);</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+                }</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+            } else if (typeof(this.onReject) == &quot;function&quot;) {</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+                nextValue = this.onReject.call(undefined, nextValue);</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+                nextStatus = STATUS_RESOLVED;</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+            }</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+        } catch (ex) {</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+            // Enable this to get promise debugging</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+            log(&quot;EXCEPTION: &quot; + ex + &quot;\n&quot; + ex.stack + ex.printStackTrace);</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+            nextStatus = STATUS_REJECTED;</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+            nextValue = ex;</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+        }</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+        PromiseWalker.completePromise(this.nextPromise, nextStatus, nextValue);</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+    }</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+};</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+function Deferred() {</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+    this.promise = new Promise(function(aResolve, aReject) {</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+        this.resolve = aResolve;</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+        this.reject = aReject;</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+    }.bind(this));</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+}</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+function Promise(executor) {</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+    this._handlers = [];</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+    let resolve = PromiseWalker.completePromise.bind(PromiseWalker, this, STATUS_RESOLVED);</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+    let reject = PromiseWalker.completePromise.bind(PromiseWalker, this, STATUS_REJECTED);</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+    try {</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+        executor.call(undefined, resolve, reject);</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+    } catch (ex) {</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+        reject(ex);</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+    }</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+}</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+Promise.prototype = {</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+    _status: STATUS_PENDING,</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+    _value: undefined,</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+    then: function(aOnResolve, aOnReject) {</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+        let handler = new Handler(this, aOnResolve, aOnReject);</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+        this._handlers.push(handler);</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+        if (this._status != STATUS_PENDING) {</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+            PromiseWalker.schedulePromise(this);</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+        }</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+        return handler.nextPromise;</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+    },</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+    catch: function(onreject) {</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+        return this.then(undefined, onReject);</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+    }</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+};</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+Promise.defer = function() {</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+    return new Deferred();</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+};</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+Promise.resolve = function(aValue) {</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+    if (aValue instanceof Promise) {</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+        return aValue;</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+    }</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    return new Promise(function(aResolve) aResolve(aValue));</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+};</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+Promise.reject = function(aReason) {</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+    return new Promise(function(_, aReject) aReject(aReason));</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Task.jsm</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,139 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+  &quot;Task&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+];</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+Cu.import(&quot;resource://gdata-provider/modules/shim/Promise.jsm&quot;);</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+// The following error types are considered programmer errors, which should be</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+// reported (possibly redundantly) so as to let programmers fix their code.</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+const ERRORS_TO_REPORT = [&quot;EvalError&quot;, &quot;RangeError&quot;, &quot;ReferenceError&quot;, &quot;TypeError&quot;];</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+let gCurrentTask = null;</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+function linesOf(string) {</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+  let reLine = /([^\r\n])+/g;</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+  let match;</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+  while ((match = reLine.exec(string))) {</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    yield [match[0], match.index];</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+  }</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+};</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+function isGenerator(aValue) {</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+  return Object.prototype.toString.call(aValue) == &quot;[object Generator]&quot;;</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+}</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+this.Task = {</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+  spawn: function Task_spawn(aTask) {</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+    return createAsyncFunction(aTask).call(undefined);</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+  },</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+  async: function Task_async(aTask) {</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+    if (typeof(aTask) != &quot;function&quot;) {</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+      throw new TypeError(&quot;aTask argument must be a function&quot;);</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+    }</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+    return createAsyncFunction(aTask);</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+  },</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+  Result: function Task_Result(aValue) {</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+    this.value = aValue;</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+  }</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+};</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+function createAsyncFunction(aTask) {</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+  let asyncFunction = function () {</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+    let result = aTask;</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+    if (aTask &amp;&amp; typeof(aTask) == &quot;function&quot;) {</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+      if (aTask.isAsyncFunction) {</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+        throw new TypeError(</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+          &quot;Cannot use an async function in place of a promise. &quot; +</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+          &quot;You should either invoke the async function first &quot; +</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+          &quot;or use 'Task.spawn' instead of 'Task.async' to start &quot; +</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+          &quot;the Task and return its promise.&quot;);</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+      }</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+      try {</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+        // Let's call into the function ourselves.</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+        result = aTask.apply(this, arguments);</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+      } catch (ex if ex instanceof Task.Result) {</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+        return Promise.resolve(ex.value);</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+      } catch (ex) {</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+        return Promise.reject(ex);</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+      }</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+    }</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+    if (isGenerator(result)) {</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+      // This is an iterator resulting from calling a generator function.</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+      return new TaskImpl(result).deferred.promise;</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+    }</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+    // Just propagate the given value to the caller as a resolved promise.</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+    return Promise.resolve(result);</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+  };</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+  asyncFunction.isAsyncFunction = true;</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+  return asyncFunction;</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+}</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+function TaskImpl(iterator) {</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+  this.deferred = Promise.defer();</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+  this._iterator = iterator;</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+  this._run(true);</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+}</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+TaskImpl.prototype = {</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+  deferred: null,</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+  _iterator: null,</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+  _run: function TaskImpl_run(aSendResolved, aSendValue) {</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+    try {</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+      gCurrentTask = this;</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+      try {</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+        let yielded = aSendResolved ? this._iterator.send(aSendValue)</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+                                    : this._iterator.throw(aSendValue);</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+        this._handleResultValue(yielded);</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+      } catch (ex if ex instanceof Task.Result) {</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+        this.deferred.resolve(ex.value);</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+      } catch (ex if ex instanceof StopIteration) {</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+        this.deferred.resolve(undefined);</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+      } catch (ex) {</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+        this._handleException(ex);</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+      }</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+    } finally {</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+      if (gCurrentTask == this) {</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+        gCurrentTask = null;</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+      }</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+    }</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+  },</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+  _handleResultValue: function TaskImpl_handleResultValue(aValue) {</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+    if (isGenerator(aValue)) {</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+      aValue = Task.spawn(aValue);</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+    }</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+    if (aValue &amp;&amp; typeof(aValue.then) == &quot;function&quot;) {</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+      aValue.then(this._run.bind(this, true),</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+                  this._run.bind(this, false));</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+    } else {</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+      this._run(true, aValue);</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+    }</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+  },</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+  _handleException: function TaskImpl_handleException(aException) {</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+    gCurrentTask = this;</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+    this.deferred.reject(aException);</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+  }</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/shim/Timer.jsm</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;setTimeout&quot;];</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+function setTimeout(func, timeout) {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+    let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+    timer.initWithCallback({ notify: func }, timeout, timer.TYPE_ONE_SHOT);</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+    // Timer.jsm usually keeps track of the timers to be able to cancel them,</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+    // but we only use it for postponing things so this is enough.</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/timezoneMap.jsm</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,106 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+// Mappings Copyright  1991-2013 Unicode, Inc. with modifications.</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+// http://unicode.org/repos/cldr/trunk/common/supplemental/windowsZones.xml</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;windowsTimezoneMap&quot;];</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+var windowsTimezoneMap = {</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+    &quot;Hawaiian Standard Time&quot;: &quot;Pacific/Honolulu&quot;,</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+    &quot;Alaskan Standard Time&quot;: &quot;America/Anchorage&quot;,</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    &quot;Pacific Standard Time (Mexico)&quot;: &quot;America/Santa_Isabel&quot;,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+    &quot;Pacific Standard Time&quot;: &quot;America/Los_Angeles&quot;,</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+    &quot;US Mountain Standard Time&quot;: &quot;America/Phoenix&quot;,</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+    &quot;Mountain Standard Time (Mexico)&quot;: &quot;America/Chihuahua&quot;,</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+    &quot;Mountain Standard Time&quot;: &quot;America/Denver&quot;,</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+    &quot;Central America Standard Time&quot;: &quot;America/Guatemala&quot;,</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+    &quot;Central Standard Time&quot;: &quot;America/Chicago&quot;,</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+    &quot;Central Standard Time (Mexico)&quot;: &quot;America/Mexico_City&quot;,</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+    &quot;Canada Central Standard Time&quot;: &quot;America/Regina&quot;,</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+    &quot;SA Pacific Standard Time&quot;: &quot;America/Bogota&quot;,</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+    &quot;Eastern Standard Time&quot;: &quot;America/New_York&quot;,</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+    &quot;US Eastern Standard Time&quot;: &quot;America/Indianapolis&quot;,</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+    &quot;Venezuela Standard Time&quot;: &quot;America/Caracas&quot;,</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+    &quot;Paraguay Standard Time&quot;: &quot;America/Asuncion&quot;,</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+    &quot;Atlantic Standard Time&quot;: &quot;America/Halifax&quot;,</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+    &quot;Central Brazilian Standard Time&quot;: &quot;America/Cuiaba&quot;,</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+    &quot;SA Western Standard Time&quot;: &quot;America/La_Paz&quot;,</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+    &quot;Pacific SA Standard Time&quot;: &quot;America/Santiago&quot;,</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+    &quot;Newfoundland Standard Time&quot;: &quot;America/St_Johns&quot;,</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    &quot;E. South America Standard Time&quot;: &quot;America/Sao_Paulo&quot;,</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    &quot;Argentina Standard Time&quot;: &quot;America/Buenos_Aires&quot;,</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+    &quot;SA Eastern Standard Time&quot;: &quot;America/Cayenne&quot;,</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+    &quot;Greenland Standard Time&quot;: &quot;America/Godthab&quot;,</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+    &quot;Montevideo Standard Time&quot;: &quot;America/Montevideo&quot;,</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+    &quot;Bahia Standard Time&quot;: &quot;America/Bahia&quot;,</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+    &quot;Azores Standard Time&quot;: &quot;Atlantic/Azores&quot;,</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+    &quot;Cape Verde Standard Time&quot;: &quot;Atlantic/Cape_Verde&quot;,</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+    &quot;Morocco Standard Time&quot;: &quot;Africa/Casablanca&quot;,</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+    &quot;GMT Standard Time&quot;: &quot;Europe/London&quot;,</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+    &quot;Greenwich Standard Time&quot;: &quot;Atlantic/Reykjavik&quot;,</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+    &quot;W. Europe Standard Time&quot;: &quot;Europe/Berlin&quot;,</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+    &quot;Central Europe Standard Time&quot;: &quot;Europe/Budapest&quot;,</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+    &quot;Romance Standard Time&quot;: &quot;Europe/Paris&quot;,</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+    &quot;Central European Standard Time&quot;: &quot;Europe/Warsaw&quot;,</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+    &quot;W. Central Africa Standard Time&quot;: &quot;Africa/Lagos&quot;,</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+    &quot;Namibia Standard Time&quot;: &quot;Africa/Windhoek&quot;,</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+    &quot;Jordan Standard Time&quot;: &quot;Asia/Amman&quot;,</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+    &quot;GTB Standard Time&quot;: &quot;Europe/Bucharest&quot;,</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+    &quot;Middle East Standard Time&quot;: &quot;Asia/Beirut&quot;,</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+    &quot;Egypt Standard Time&quot;: &quot;Africa/Cairo&quot;,</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+    &quot;Syria Standard Time&quot;: &quot;Asia/Damascus&quot;,</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+    &quot;South Africa Standard Time&quot;: &quot;Africa/Johannesburg&quot;,</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+    &quot;FLE Standard Time&quot;: &quot;Europe/Kiev&quot;,</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+    &quot;Turkey Standard Time&quot;: &quot;Europe/Istanbul&quot;,</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    &quot;Israel Standard Time&quot;: &quot;Asia/Jerusalem&quot;,</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+    &quot;Kaliningrad Standard Time&quot;: &quot;Europe/Kaliningrad&quot;,</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+    &quot;Libya Standard Time&quot;: &quot;Africa/Tripoli&quot;,</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+    &quot;Arabic Standard Time&quot;: &quot;Asia/Baghdad&quot;,</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+    &quot;Arab Standard Time&quot;: &quot;Asia/Riyadh&quot;,</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+    &quot;Belarus Standard Time&quot;: &quot;Europe/Minsk&quot;,</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+    &quot;Russian Standard Time&quot;: &quot;Europe/Moscow&quot;,</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+    &quot;E. Africa Standard Time&quot;: &quot;Africa/Nairobi&quot;,</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+    &quot;Iran Standard Time&quot;: &quot;Asia/Tehran&quot;,</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+    &quot;Arabian Standard Time&quot;: &quot;Asia/Dubai&quot;,</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+    &quot;Azerbaijan Standard Time&quot;: &quot;Asia/Baku&quot;,</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+    &quot;Russia Time Zone 3&quot;: &quot;Europe/Samara&quot;,</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+    &quot;Mauritius Standard Time&quot;: &quot;Indian/Mauritius&quot;,</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+    &quot;Georgian Standard Time&quot;: &quot;Asia/Tbilisi&quot;,</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+    &quot;Caucasus Standard Time&quot;: &quot;Asia/Yerevan&quot;,</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+    &quot;Afghanistan Standard Time&quot;: &quot;Asia/Kabul&quot;,</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+    &quot;West Asia Standard Time&quot;: &quot;Asia/Tashkent&quot;,</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+    &quot;Ekaterinburg Standard Time&quot;: &quot;Asia/Yekaterinburg&quot;,</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+    &quot;Pakistan Standard Time&quot;: &quot;Asia/Karachi&quot;,</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+    &quot;India Standard Time&quot;: &quot;Asia/Calcutta&quot;,</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+    &quot;Sri Lanka Standard Time&quot;: &quot;Asia/Colombo&quot;,</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+    &quot;Nepal Standard Time&quot;: &quot;Asia/Katmandu&quot;,</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+    &quot;Central Asia Standard Time&quot;: &quot;Asia/Almaty&quot;,</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+    &quot;Bangladesh Standard Time&quot;: &quot;Asia/Dhaka&quot;,</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+    &quot;N. Central Asia Standard Time&quot;: &quot;Asia/Novosibirsk&quot;,</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+    &quot;Myanmar Standard Time&quot;: &quot;Asia/Rangoon&quot;,</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+    &quot;SE Asia Standard Time&quot;: &quot;Asia/Bangkok&quot;,</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+    &quot;North Asia Standard Time&quot;: &quot;Asia/Krasnoyarsk&quot;,</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+    &quot;China Standard Time&quot;: &quot;Asia/Shanghai&quot;,</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+    &quot;North Asia East Standard Time&quot;: &quot;Asia/Irkutsk&quot;,</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+    &quot;Singapore Standard Time&quot;: &quot;Asia/Singapore&quot;,</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+    &quot;W. Australia Standard Time&quot;: &quot;Australia/Perth&quot;,</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+    &quot;Taipei Standard Time&quot;: &quot;Asia/Taipei&quot;,</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+    &quot;Ulaanbaatar Standard Time&quot;: &quot;Asia/Ulaanbaatar&quot;,</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+    &quot;Tokyo Standard Time&quot;: &quot;Asia/Tokyo&quot;,</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+    &quot;Korea Standard Time&quot;: &quot;Asia/Seoul&quot;,</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+    &quot;Yakutsk Standard Time&quot;: &quot;Asia/Yakutsk&quot;,</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    &quot;Cen. Australia Standard Time&quot;: &quot;Australia/Adelaide&quot;,</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+    &quot;AUS Central Standard Time&quot;: &quot;Australia/Darwin&quot;,</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+    &quot;E. Australia Standard Time&quot;: &quot;Australia/Brisbane&quot;,</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+    &quot;AUS Eastern Standard Time&quot;: &quot;Australia/Sydney&quot;,</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+    &quot;West Pacific Standard Time&quot;: &quot;Pacific/Port_Moresby&quot;,</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+    &quot;Tasmania Standard Time&quot;: &quot;Australia/Hobart&quot;,</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+    &quot;Magadan Standard Time&quot;: &quot;Asia/Magadan&quot;,</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+    &quot;Vladivostok Standard Time&quot;: &quot;Asia/Vladivostok&quot;,</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+    &quot;Russia Time Zone 10&quot;: &quot;Asia/Srednekolymsk&quot;,</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+    &quot;Central Pacific Standard Time&quot;: &quot;Pacific/Guadalcanal&quot;,</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    &quot;Russia Time Zone 11&quot;: &quot;Asia/Kamchatka&quot;,</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+    &quot;New Zealand Standard Time&quot;: &quot;Pacific/Auckland&quot;,</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+    &quot;Fiji Standard Time&quot;: &quot;Pacific/Fiji&quot;,</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    &quot;Tonga Standard Time&quot;: &quot;Pacific/Tongatapu&quot;,</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+    &quot;Samoa Standard Time&quot;: &quot;Pacific/Apia&quot;,</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+    &quot;Line Islands Standard Time&quot;: &quot;Pacific/Kiritimati&quot;,</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/providers/gdata/moz.build</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/providers/gdata/moz.build</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,14 +1,36 @@</span>
<a href="#l39.4"></a><span id="l39.4"> # vim: set filetype=python:</span>
<a href="#l39.5"></a><span id="l39.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.7"></a><span id="l39.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+XPI_NAME = 'gdata-provider'</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+</span>
<a href="#l39.11"></a><span id="l39.11"> DIRS += [</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-    'components',</span>
<a href="#l39.13"></a><span id="l39.13">     'locales',</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-    'public',</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+]</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+    'modules/gdataLogging.jsm',</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+    'modules/gdataRequest.jsm',</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+    'modules/gdataSession.jsm',</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+    'modules/gdataUtils.jsm',</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+    'modules/OAuth2.jsm',</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+    'modules/timezoneMap.jsm',</span>
<a href="#l39.24"></a><span id="l39.24"> ]</span>
<a href="#l39.25"></a><span id="l39.25"> </span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-XPI_NAME = 'gdata-provider'</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+EXTRA_JS_MODULES.shim = [</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+    'modules/shim/Calendar.jsm',</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+    'modules/shim/Http.jsm',</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+    'modules/shim/Loader.jsm',</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+    'modules/shim/Preferences.jsm',</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+    'modules/shim/Promise.jsm',</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+    'modules/shim/Task.jsm',</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+    'modules/shim/Timer.jsm',</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+]</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+    'components/calGoogleCalendar.js',</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+    'components/calGoogleCalendar.manifest',</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+]</span>
<a href="#l39.41"></a><span id="l39.41"> </span>
<a href="#l39.42"></a><span id="l39.42"> JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- a/calendar/providers/gdata/public/calIGoogleCalendar.idl</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ /dev/null</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -1,81 +0,0 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-#include &quot;calICalendar.idl&quot;</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-interface calIGoogleSession;</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-interface nsIURI;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-[scriptable, uuid(d1a6e988-4b4d-45a5-ba46-43e501ea96e3)]</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-interface calIGoogleCalendar : calICalendar</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-{</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-    /**</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-     * attribute googleCalendarName</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-     * Google's Calendar name. This represents the &lt;calendar name&gt; in</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-     * http://www.google.com/calendar/feeds/&lt;calendar name&gt;/private/full</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-     */</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-    readonly attribute AUTF8String googleCalendarName;</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-    /**</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-     * attribute isDefaultCalendar</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-     * If true, this is the users default calendar. Non-default calendars have</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-     * a calendar name that contains &quot;@group.calendar.google.com&quot;</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-     */</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-    readonly attribute boolean isDefaultCalendar;</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-    /**</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-     * While calICalendar::uri returns the uri set by the user, fullUri returns</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-     * Google's &quot;full&quot; feed.</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-     *</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-     * XXX This will go away once the provider implements a custom add calendar</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-     * wizard, since uri will always be set to the full uri in that case.</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineminus">-     */</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineminus">-    attribute nsIURI fullUri;</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">-    /**</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-     * The username used to access the calendar. Changing this sets the session</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-     * to a calIGoogleSession object with the given username.</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-     */</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-    attribute AUTF8String googleUser;</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineminus">-</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-    /**</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-     * The session object associated with this calendar. Set this by changing</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">-     * the googleUser attribute.</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineminus">-     */</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineminus">-    readonly attribute calIGoogleSession session;</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">-</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">-    /**</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">-     * The calender title as provided by Google. This information is cached.</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">-     */</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineminus">-    attribute AUTF8String title;</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineminus">-</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">-    /**</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-     * The access level that was set in Google's calendar UI. This information</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineminus">-     * is cached.</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-     */</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineminus">-    attribute AUTF8String access;</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">-</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">-    /**</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">-     * If set, the calendar is &quot;selected&quot; in the Google Calendar UI.</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineminus">-     */</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-    attribute boolean selected;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineminus">-</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineminus">-    /**</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineminus">-     * If set, the calendar is hidden from the Google Calendar UI. It is still</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineminus">-     * visible when managing calendars though.</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-     */</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineminus">-    attribute boolean hidden;</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineminus">-</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineminus">-    /**</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineminus">-     * The color that was set in Google's calendar UI. This information is</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineminus">-     * cached.</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineminus">-     */</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineminus">-    attribute AUTF8String color;</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">-</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineminus">-    /**</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineminus">-     * The timezone that was set in Google's calendar UI. This information is</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">-     * cached.</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-     */</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineminus">-    attribute AUTF8String timezone;</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">deleted file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- a/calendar/providers/gdata/public/calIGoogleRequest.idl</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ /dev/null</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -1,123 +0,0 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">-</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineminus">-#include &quot;calIOperation.idl&quot;</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-interface calICalendar;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-interface calIGoogleSession;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-interface calIGoogleCalendar;</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-interface calIGenericOperationListener;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-interface calIOperationListener;</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-interface calIDateTime;</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-interface calIItemBase;</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-interface nsIVariant;</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-[scriptable, uuid(53a3438a-21bc-4a0f-b813-77a8b4f19282)]</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-interface calIGoogleRequest : calIOperation {</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-    const unsigned long LOGIN = 0;</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-    const unsigned long ADD = 1;</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-    const unsigned long MODIFY = 2;</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-    const unsigned long DELETE = 3;</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-    const unsigned long GET = 4;</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-    /**</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-     * The type of request. Must be one of the above constants.</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-     */</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-    attribute uint32_t type;</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-    /**</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-     * The request uri string</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-     */</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-    attribute AUTF8String uri;</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-    /**</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-     * The operation listener. This is not called by the request object, but can</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-     * be used by the response listener to call the original listener that</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-     * caused the request</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-     */</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-    attribute calIOperationListener operationListener;</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-    /**</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-     * The response listener. This will be called as soon as the request to</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-     * google has completed.</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-     */</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineminus">-    attribute calIGenericOperationListener responseListener;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineminus">-    /**</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineminus">-     * The calendar that initiated the request</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineminus">-     */</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineminus">-    attribute calIGoogleCalendar calendar;</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineminus">-</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineminus">-    /**</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-     * The destination calendar, used for synchronization runs.</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-     */</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-    attribute calICalendar destinationCal;</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-    /**</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineminus">-     * If set to false, an authentication failure should not cause any dialogs</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-     * to show up that cause reauthentication, but the failure should be</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-     * returned directly.</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-     *</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-     * This attribute defaults to true.</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineminus">-     */</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-    attribute boolean reauthenticate;</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-    /**</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-     * Various options to be carried through to the response listener.</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-     * XXX The corresponding options are not set up automatically just by</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-     * setting these options. You still need to use addQueryParameter to filter</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-     * by item range or other property.</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineminus">-     */</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineminus">-    attribute calIDateTime itemRangeStart;</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineminus">-    attribute calIDateTime itemRangeEnd;</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-    attribute unsigned long itemFilter;</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-    attribute AUTF8String itemId;</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-    attribute boolean useCache;</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineminus">-    /**</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineminus">-     * For add/modify/delete item requests, these contain the old and new items.</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineminus">-     */</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineminus">-    attribute calIItemBase newItem;</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineminus">-    attribute calIItemBase oldItem;</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineminus">-</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-    /**</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-     * Set up some upload data using the given content type</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-     *</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-     * @param aContentType      The value of the content type header to be set.</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineminus">-     * @param aData             The Data to be uploaded.</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineminus">-     */</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineminus">-    void setUploadData(in AUTF8String aContentType, in AUTF8String aData);</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineminus">-</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineminus">-    /**</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-     * Adds a query parameter to the request. These will be escaped.</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-     *</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-     * @param aKey      The key of the query parameter.</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-     * @param aValue    The value of the query parameter.</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineminus">-     */</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineminus">-    void addQueryParameter(in AUTF8String aKey, in AUTF8String aValue);</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-    /**</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineminus">-     * Run the request, using the specified session.</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-     *</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-     * @param aSession      The session to request with.</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineminus">-     */</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineminus">-    void commit(in calIGoogleSession aSession);</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-    /**</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineminus">-     * Tell listeners that the operation failed</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-     *</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineminus">-     * @param aCode     The error code to use.</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-     * @param aMessage  The error message to use.</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">-     */</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-    void fail(in uint32_t aCode, in AUTF8String aMessage);</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineminus">-    /**</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineminus">-     * Tell listeners that the operation succeeded.</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineminus">-     *</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineminus">-     * @param aMessage  The error message to use.</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineminus">-     */</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineminus">-    void succeed(in AUTF8String aMessage);</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">deleted file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- a/calendar/providers/gdata/public/calIGoogleSession.idl</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ /dev/null</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -1,84 +0,0 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">-</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">-interface calIGoogleSession;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-interface calIGoogleCalendar;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-interface calIEvent;</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-interface calIDateTime;</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-interface calIGenericOperationListener;</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-interface calIOperationListener;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-interface calIGoogleRequest;</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-interface calIOperation;</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineminus">-</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-interface nsIVariant;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-[scriptable, uuid(6a7ba1f0-f271-49b0-8e93-5ca33651b4af)]</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-interface calIGoogleSessionManager : nsISupports {</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-    /**</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-     * getSessionByUsername</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-     * Get a Session object for the specified username. If aCreate is false,</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-     * null will be returned if the session doesn't exist. Otherwise, the</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-     * session will be created.</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-     *</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-     * @param aUsername The username to get the session for</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-     * @param aCreate   If true, the session will be created prior to returning</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineminus">-     */</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-     calIGoogleSession getSessionByUsername(in AUTF8String aUsername, in boolean aCreate);</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-};</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-[scriptable, uuid(652f6233-e03f-438a-bd3b-39877f68c0f4)]</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-interface calIGoogleSession : nsISupports {</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-    /**</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-     * The Authentication Token from Google</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-     */</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-    readonly attribute AUTF8String authToken;</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineminus">-    /**</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-     * The username for this session. To get a session with a different</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-     * username, use calIGoogleSessionManager.</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineminus">-     */</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineminus">-    readonly attribute AUTF8String userName;</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-    /**</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-     * If set, the password will persist across restarts.</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-     */</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-    attribute boolean persist;</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-    /**</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-     * The user's full name, usually retrieved from the XML &lt;author&gt; fields. If</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-     * unset, this will return the userName attribute.</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-     */</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineminus">-    attribute AUTF8String fullName;</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-    /**</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-     * The password used to authenticate. It is only important to implement the</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-     * setter here, since the password is only used internally.</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-     */</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-    attribute AUTF8String password;</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-    /**</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-     * Resets the Auth token and sets the persist attribute to false.</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-     */</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-    void invalidate();</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-    /**</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-     * getCalendars</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-     * Get the list of calendars for this session. The operaion listener will be</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-     * called with an array of calIGoogleCalendars.</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-     *</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-     * @param aListener The listener to call when the calendars were retrieved</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-     */</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-    calIOperation getCalendars(in calIGenericOperationListener aListener);</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-    /**</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-     * asyncItemRequest</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-     * Send a request to Google, logging in to the session if required.</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-     *</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-     * @param aRequest      The calIGoogleRequest to send</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-     */</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-    void asyncItemRequest(in calIGoogleRequest aRequest);</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">deleted file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- a/calendar/providers/gdata/public/moz.build</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ /dev/null</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -1,13 +0,0 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineminus">-</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineminus">-XPIDL_SOURCES += [</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineminus">-    'calIGoogleCalendar.idl',</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    'calIGoogleRequest.idl',</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-    'calIGoogleSession.idl',</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-]</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-XPIDL_MODULE = 'gdata'</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,1464 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+(function load_gdata_manifest() {</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+  Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+  Services.prefs.setBoolPref(&quot;javascript.options.showInConsole&quot;, true);</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+  Services.prefs.setBoolPref(&quot;browser.dom.window.dump.enabled&quot;, true);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  Services.prefs.setBoolPref(&quot;calendar.debug.log&quot;, true);</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+  Services.prefs.setBoolPref(&quot;calendar.debug.log.verbose&quot;, true);</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+  let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+  bindir.append(&quot;extensions&quot;);</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+  bindir.append(&quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;);</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+  bindir.append(&quot;chrome.manifest&quot;);</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+  dump(&quot;Loading&quot; + bindir.path + &quot;\n&quot;);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+  Components.manager.autoRegister(bindir);</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+})();</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+Components.utils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;);</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAsyncUtils.jsm&quot;);</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+var MockConflictPrompt = {</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+    _origFunc: null,</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+    overwrite: false,</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+    register: function() {</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+        if (!this._origFunc) {</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+            this._origFunc = cal.promptOverwrite;</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+            cal.promptOverwrite = (aMode, aItem) =&gt; {</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+                return this.overwrite;</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+            };</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+        }</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+    },</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+    unregister: function() {</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+        if (this._origFunc) {</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+            cal.promptOverwrite = this._origFunc;</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+            this._origFunc = null;</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+        }</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+    }</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+};</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+function GDataServer(calendarId, tasksId) {</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+    this.server = new HttpServer();</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+    this.calendarId = calendarId;</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+    this.tasksId = tasksId;</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+    let events = &quot;/calendar/v3/calendars/&quot; + calendarId + &quot;/events&quot;;</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+    let tasks = &quot;/tasks/v1/lists/&quot; + tasksId + &quot;/tasks&quot;;</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+    let calendarList = &quot;/calendar/v3/users/me/calendarList/&quot; + calendarId;</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+    this.server.registerPathHandler(calendarList, this.router.bind(this, this.calendarListRequest.bind(this)));</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+    this.server.registerPathHandler(events, this.router.bind(this, this.eventsRequest.bind(this)));</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+    this.server.registerPrefixHandler(events + &quot;/&quot;, this.router.bind(this, this.eventsRequest.bind(this)));</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+    this.server.registerPathHandler(tasks, this.router.bind(this, this.tasksRequest.bind(this)));</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+    this.server.registerPrefixHandler(tasks + &quot;/&quot;, this.router.bind(this, this.tasksRequest.bind(this)));</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+    this.resetRequest();</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+    let sessionMgr = getGoogleSessionManager();</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+    this.session = sessionMgr.getSessionById(&quot;xpcshell&quot;, true);</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+    this.session.oauth = {</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+        accessToken: &quot;accessToken&quot;,</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+        refreshToken: &quot;refreshToken&quot;,</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+        tokenExpires: Number.MAX_VALUE,</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+        connect: function(succ, fail, ui, refresh) {</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+            this.accessToken = &quot;accessToken&quot;;</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+            succ();</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+        }</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+    };</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+}</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+GDataServer.prototype = {</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+    items: null,</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+    get baseUri() &quot;http://localhost:&quot; + this.server.identity.primaryPort + &quot;/&quot;,</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+    start: function() {</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+        this.server.start(-1);</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+        do_register_cleanup(() =&gt; this.server.stop(() =&gt; {}));</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+    },</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineplus">+    resetClient: function(client) {</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+        this.resetRequest();</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+        MockConflictPrompt.unregister();</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+        cal.getCalendarManager().unregisterCalendar(client);</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+    },</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+    resetRequest: function() {</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+        this.events = [];</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+        this.tasks = [];</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+        this.nextEtag = null;</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+        this.syncs = [];</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+        this.nextEventStatus = [];</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+        this.creator = {</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+            &quot;email&quot;: &quot;xpcshell@example.com&quot;,</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+            &quot;self&quot;: true,</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+            &quot;displayName&quot;: &quot;Eggs P. Seashell&quot;</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+        };</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+        this.eventsData = {</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+           &quot;kind&quot;: &quot;calendar#events&quot;,</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+           &quot;etag&quot;: &quot;\&quot;1410880601360000\&quot;&quot;,</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+           &quot;nextSyncToken&quot;: generateID(),</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+           &quot;updated&quot;: &quot;2014-09-16T15:16:41.360Z&quot;,</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+           &quot;accessRole&quot;: &quot;owner&quot;,</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+           &quot;summary&quot;: &quot;xpcshell&quot;,</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+           &quot;timeZone&quot;: &quot;Europe/Berlin&quot;,</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+           &quot;defaultReminders&quot;: [],</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+           &quot;items&quot;: []</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+        };</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+        this.tasksData = {</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+            &quot;kind&quot;: &quot;tasks#tasks&quot;,</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+            &quot;etag&quot;: &quot;\&quot;1410880601360000\&quot;&quot;,</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+            &quot;items&quot;: []</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+        };</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+        this.calendarListData = {</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+            &quot;kind&quot;: &quot;calendar#calendarListEntry&quot;,</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+            &quot;etag&quot;: &quot;\&quot;1410084814736000\&quot;&quot;,</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+            &quot;id&quot;: this.calendarId,</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+            &quot;summary&quot;: &quot;xpcshell&quot;,</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineplus">+            &quot;timeZone&quot;: &quot;Europe/Berlin&quot;,</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineplus">+            &quot;colorId&quot;: &quot;17&quot;,</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineplus">+            &quot;backgroundColor&quot;: &quot;#9a9cff&quot;,</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineplus">+            &quot;foregroundColor&quot;: &quot;#000000&quot;,</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineplus">+            &quot;primary&quot;: true,</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+            &quot;selected&quot;: true,</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+            &quot;accessRole&quot;: &quot;owner&quot;,</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+            &quot;defaultReminders&quot;: [],</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+            &quot;notificationSettings&quot;: {</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+                &quot;notifications&quot;: [</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+                    { &quot;type&quot;: &quot;eventCreation&quot;, &quot;method&quot;: &quot;email&quot; },</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+                    { &quot;type&quot;: &quot;eventChange&quot;, &quot;method&quot;: &quot;email&quot; },</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+                    { &quot;type&quot;: &quot;eventCancellation&quot;,  &quot;method&quot;: &quot;email&quot; }</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+                ]</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+            }</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+        };</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineplus">+    },</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+    waitForLoad: function(aCalendar) {</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+        let { resolve, promise } = Promise.defer();</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+        let observer = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+            onLoad: function() {</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+                aCalendar.removeObserver(observer);</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+                resolve(aCalendar);</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+            }</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+        });</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+        aCalendar.addObserver(observer);</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+        return promise;</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+    },</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+    getClient: function() {</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+        let uri = &quot;googleapi://xpcshell/&quot; +</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+                  &quot;?testport=&quot; + this.server.identity.primaryPort +</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+                  (this.calendarId ? &quot;&amp;calendar=&quot; + encodeURIComponent(this.calendarId) : &quot;&quot;) +</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+                  (this.tasksId ? &quot;&amp;tasks=&quot; + encodeURIComponent(this.tasksId) : &quot;&quot;);</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+        let calmgr = cal.getCalendarManager();</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+        let client = calmgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri, null, null));</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineplus">+        client.name = &quot;xpcshell&quot;;</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+        calmgr.registerCalendar(client);</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+        MockConflictPrompt.register();</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+        let cachedCalendar = calmgr.getCalendarById(client.id);</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+        return this.waitForLoad(cachedCalendar);</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+    },</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+    router: function(nextHandler, request, response) {</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+        try {</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+            let method = request.hasHeader(&quot;X-HTTP-Method-Override&quot;) ?</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineplus">+                         request.getHeader(&quot;X-HTTP-Method-Override&quot;) :</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineplus">+                         request.method;</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineplus">+            let parameters = new Map([ p.split(&quot;=&quot;, 2) for (p of request.queryString.split(&quot;&amp;&quot;)) ]);</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineplus">+</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineplus">+            let body;</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+            try {</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineplus">+                body = JSON.parse(NetUtil.readInputStreamToString(request.bodyInputStream,</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineplus">+                                  request.bodyInputStream.available()));</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+            } catch (e) {}</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+            return nextHandler(request, response, method, parameters, body);</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineplus">+        } catch (e) {</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+            do_print(&quot;Server Error: &quot; + e.fileName + &quot;:&quot; + e.lineNumber + &quot;: &quot; + e + &quot;\n&quot;);</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+        }</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineplus">+    },</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineplus">+</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+    calendarListRequest: function(request, response, method, parameters, body) {</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineplus">+        let data = this.calendarListData;</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineplus">+        response.write(JSON.stringify(data));</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineplus">+    },</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineplus">+</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineplus">+    eventsRequest: function(request, response, method, parameters, body) {</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineplus">+        if (method == &quot;GET&quot;) {</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineplus">+            let data = this.eventsData;</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineplus">+            if (request.hasHeader(&quot;timeZone&quot;)) {</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineplus">+                data.timeZone = request.getHeader(&quot;timeZone&quot;);</span>
<a href="#l44.209"></a><span id="l44.209" class="difflineplus">+            }</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineplus">+</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineplus">+            // The fakeserver doesn't support both pagination and sync tokens</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineplus">+            // for sake of simplicity.</span>
<a href="#l44.213"></a><span id="l44.213" class="difflineplus">+            if (this.syncs.length) {</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineplus">+                let syncToken = parameters.get(&quot;syncToken&quot;) || this.syncs[0].token;</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineplus">+                let sync = this.syncs.shift();</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineplus">+                let nextSyncToken = this.syncs[0] ? this.syncs[0].token : &quot;last&quot;;</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineplus">+</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineplus">+                if (!sync || syncToken != sync.token) {</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineplus">+                    do_throw(&quot;Request in wrong order or not enough syncs&quot;);</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineplus">+                }</span>
<a href="#l44.221"></a><span id="l44.221" class="difflineplus">+                if (sync.reset) {</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineplus">+                    response.setStatusLine(null, 410, &quot;Gone&quot;);</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineplus">+                    return;</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineplus">+                }</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineplus">+                data.nextSyncToken = nextSyncToken;</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineplus">+                data.items = sync.events;</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineplus">+            } else {</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+                this.paginateRequest(parameters, this.events, data);</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineplus">+            }</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineplus">+            response.write(JSON.stringify(data));</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineplus">+         } else if (method == &quot;POST&quot;) {</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineplus">+            // Add an event</span>
<a href="#l44.233"></a><span id="l44.233" class="difflineplus">+            let isImport = request.path.endsWith(&quot;/events/import&quot;);</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineplus">+            let data = this.processAddEvent(body, isImport);</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+            this.events.push(data);</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineplus">+            response.setStatusLine(null, 201, &quot;Created&quot;);</span>
<a href="#l44.237"></a><span id="l44.237" class="difflineplus">+            response.write(JSON.stringify(data));</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineplus">+         } else if (method == &quot;PUT&quot; &amp;&amp; request.path.match(/\/events\/([a-z0-9_TZ]+)$/)) {</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineplus">+            // Modify an event</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineplus">+            dump(&quot;PUTTING EVENT\n&quot; + body);</span>
<a href="#l44.241"></a><span id="l44.241" class="difflineplus">+            let eventId = RegExp.$1;</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineplus">+            this.handleModify(request, response, body, this.events, eventId,</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineplus">+                              this.processModifyEvent.bind(this));</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineplus">+        } else if (method == &quot;DELETE&quot; &amp;&amp; request.path.match(/\/events\/([a-z0-9_TZ]+)$/)) {</span>
<a href="#l44.245"></a><span id="l44.245" class="difflineplus">+            let eventId = RegExp.$1;</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineplus">+            this.handleDelete(request, response, this.events, eventId);</span>
<a href="#l44.247"></a><span id="l44.247" class="difflineplus">+        }</span>
<a href="#l44.248"></a><span id="l44.248" class="difflineplus">+    },</span>
<a href="#l44.249"></a><span id="l44.249" class="difflineplus">+</span>
<a href="#l44.250"></a><span id="l44.250" class="difflineplus">+    tasksRequest: function(request, response, method, parameters, body) {</span>
<a href="#l44.251"></a><span id="l44.251" class="difflineplus">+        if (method == &quot;GET&quot;) {</span>
<a href="#l44.252"></a><span id="l44.252" class="difflineplus">+            let data = this.tasksData;</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineplus">+</span>
<a href="#l44.254"></a><span id="l44.254" class="difflineplus">+            this.paginateRequest(parameters, this.tasks, data);</span>
<a href="#l44.255"></a><span id="l44.255" class="difflineplus">+            delete data.nextSyncToken;</span>
<a href="#l44.256"></a><span id="l44.256" class="difflineplus">+</span>
<a href="#l44.257"></a><span id="l44.257" class="difflineplus">+            response.write(JSON.stringify(data));</span>
<a href="#l44.258"></a><span id="l44.258" class="difflineplus">+        } else if (method == &quot;POST&quot;) {</span>
<a href="#l44.259"></a><span id="l44.259" class="difflineplus">+            let data = this.processAddTask(body);</span>
<a href="#l44.260"></a><span id="l44.260" class="difflineplus">+            this.tasks.push(data);</span>
<a href="#l44.261"></a><span id="l44.261" class="difflineplus">+            response.setStatusLine(null, 201, &quot;Created&quot;);</span>
<a href="#l44.262"></a><span id="l44.262" class="difflineplus">+            response.write(JSON.stringify(data));</span>
<a href="#l44.263"></a><span id="l44.263" class="difflineplus">+        } else if (method == &quot;PUT&quot; &amp;&amp; request.path.match(/\/tasks\/([A-Za-z0-9]+)$/)) {</span>
<a href="#l44.264"></a><span id="l44.264" class="difflineplus">+            let taskId = RegExp.$1;</span>
<a href="#l44.265"></a><span id="l44.265" class="difflineplus">+            this.handleModify(request, response, body, this.tasks, taskId,</span>
<a href="#l44.266"></a><span id="l44.266" class="difflineplus">+                              this.processModifyTask.bind(this));</span>
<a href="#l44.267"></a><span id="l44.267" class="difflineplus">+        } else if (method == &quot;DELETE&quot; &amp;&amp; request.path.match(/\/tasks\/([A-Za-z0-9]+)$/)) {</span>
<a href="#l44.268"></a><span id="l44.268" class="difflineplus">+            let taskId = RegExp.$1;</span>
<a href="#l44.269"></a><span id="l44.269" class="difflineplus">+            this.handleDelete(request, response, this.tasks, taskId);</span>
<a href="#l44.270"></a><span id="l44.270" class="difflineplus">+        }</span>
<a href="#l44.271"></a><span id="l44.271" class="difflineplus">+    },</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineplus">+</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineplus">+    paginateRequest: function(parameters, items, data) {</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineplus">+        let maxResults = parameters.has(&quot;maxResults&quot;) ? parseInt(parameters.get(&quot;maxResults&quot;), 10) : 50;</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineplus">+        let offset = parameters.has(&quot;pageToken&quot;) ? parseInt(parameters.get(&quot;pageToken&quot;), 10) || 0 : 0;</span>
<a href="#l44.276"></a><span id="l44.276" class="difflineplus">+        let nextOffset = offset + maxResults;</span>
<a href="#l44.277"></a><span id="l44.277" class="difflineplus">+        if (nextOffset &gt; items.length) {</span>
<a href="#l44.278"></a><span id="l44.278" class="difflineplus">+            delete data.nextPageToken;</span>
<a href="#l44.279"></a><span id="l44.279" class="difflineplus">+            data.nextSyncToken = &quot;next-sync-token&quot;;</span>
<a href="#l44.280"></a><span id="l44.280" class="difflineplus">+        } else {</span>
<a href="#l44.281"></a><span id="l44.281" class="difflineplus">+            delete data.nextSyncToken;</span>
<a href="#l44.282"></a><span id="l44.282" class="difflineplus">+            data.nextPageToken = nextOffset;</span>
<a href="#l44.283"></a><span id="l44.283" class="difflineplus">+        }</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineplus">+</span>
<a href="#l44.285"></a><span id="l44.285" class="difflineplus">+        data.items = items.slice(offset, offset + maxResults);</span>
<a href="#l44.286"></a><span id="l44.286" class="difflineplus">+    },</span>
<a href="#l44.287"></a><span id="l44.287" class="difflineplus">+</span>
<a href="#l44.288"></a><span id="l44.288" class="difflineplus">+    handleModify: function(request, response, body, items, itemId, modifyFunc) {</span>
<a href="#l44.289"></a><span id="l44.289" class="difflineplus">+        // Modify an event</span>
<a href="#l44.290"></a><span id="l44.290" class="difflineplus">+        let [foundIndex, foundItem] = findKey(items, &quot;id&quot;, itemId);</span>
<a href="#l44.291"></a><span id="l44.291" class="difflineplus">+</span>
<a href="#l44.292"></a><span id="l44.292" class="difflineplus">+        let matchTag = request.hasHeader(&quot;If-Match&quot;) ?</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineplus">+                       request.getHeader(&quot;If-Match&quot;) : null;</span>
<a href="#l44.294"></a><span id="l44.294" class="difflineplus">+</span>
<a href="#l44.295"></a><span id="l44.295" class="difflineplus">+        if (foundIndex != -1) {</span>
<a href="#l44.296"></a><span id="l44.296" class="difflineplus">+            if (!matchTag || matchTag == &quot;*&quot; || foundItem.etag == matchTag) {</span>
<a href="#l44.297"></a><span id="l44.297" class="difflineplus">+                items[foundIndex] = modifyFunc(body, itemId);</span>
<a href="#l44.298"></a><span id="l44.298" class="difflineplus">+                response.write(JSON.stringify(items[foundIndex]));</span>
<a href="#l44.299"></a><span id="l44.299" class="difflineplus">+            } else {</span>
<a href="#l44.300"></a><span id="l44.300" class="difflineplus">+                response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l44.301"></a><span id="l44.301" class="difflineplus">+            }</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineplus">+        } else if (matchTag == &quot;*&quot;) {</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineplus">+            let data = modifyFunc(body, itemId);</span>
<a href="#l44.304"></a><span id="l44.304" class="difflineplus">+            items.push(data);</span>
<a href="#l44.305"></a><span id="l44.305" class="difflineplus">+            response.write(JSON.stringify(data));</span>
<a href="#l44.306"></a><span id="l44.306" class="difflineplus">+        } else if (body.recurringEventId) {</span>
<a href="#l44.307"></a><span id="l44.307" class="difflineplus">+            // Special case for events, won't happen on tasks.  This is an</span>
<a href="#l44.308"></a><span id="l44.308" class="difflineplus">+            // exception that doesn't exist yet. Allow creation in this case.</span>
<a href="#l44.309"></a><span id="l44.309" class="difflineplus">+            let [foundParentIndex, foundParent] = findKey(items, &quot;id&quot;, body.recurringEventId);</span>
<a href="#l44.310"></a><span id="l44.310" class="difflineplus">+            if (!matchTag || foundParent.etag == matchTag) {</span>
<a href="#l44.311"></a><span id="l44.311" class="difflineplus">+                let data = modifyFunc(body, itemId);</span>
<a href="#l44.312"></a><span id="l44.312" class="difflineplus">+                items.push(data);</span>
<a href="#l44.313"></a><span id="l44.313" class="difflineplus">+                response.write(JSON.stringify(data));</span>
<a href="#l44.314"></a><span id="l44.314" class="difflineplus">+            } else {</span>
<a href="#l44.315"></a><span id="l44.315" class="difflineplus">+                response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l44.316"></a><span id="l44.316" class="difflineplus">+            }</span>
<a href="#l44.317"></a><span id="l44.317" class="difflineplus">+        } else if (matchTag) {</span>
<a href="#l44.318"></a><span id="l44.318" class="difflineplus">+            response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l44.319"></a><span id="l44.319" class="difflineplus">+        } else {</span>
<a href="#l44.320"></a><span id="l44.320" class="difflineplus">+            response.setStatusLine(null, 404, &quot;Not Found&quot;);</span>
<a href="#l44.321"></a><span id="l44.321" class="difflineplus">+        }</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineplus">+    },</span>
<a href="#l44.323"></a><span id="l44.323" class="difflineplus">+</span>
<a href="#l44.324"></a><span id="l44.324" class="difflineplus">+    handleDelete: function(request, response, items, itemId) {</span>
<a href="#l44.325"></a><span id="l44.325" class="difflineplus">+        let [foundIndex, foundItem] = findKey(items, &quot;id&quot;, itemId);</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineplus">+</span>
<a href="#l44.327"></a><span id="l44.327" class="difflineplus">+        let matchTag = request.hasHeader(&quot;If-Match&quot;) ?</span>
<a href="#l44.328"></a><span id="l44.328" class="difflineplus">+                       request.getHeader(&quot;If-Match&quot;) : null;</span>
<a href="#l44.329"></a><span id="l44.329" class="difflineplus">+</span>
<a href="#l44.330"></a><span id="l44.330" class="difflineplus">+        if (foundIndex != -1) {</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineplus">+            if (!matchTag || matchTag == &quot;*&quot; || items[foundIndex].etag == matchTag) {</span>
<a href="#l44.332"></a><span id="l44.332" class="difflineplus">+                items.splice(foundIndex, 1);</span>
<a href="#l44.333"></a><span id="l44.333" class="difflineplus">+                response.setStatusLine(null, 204, &quot;No Content&quot;);</span>
<a href="#l44.334"></a><span id="l44.334" class="difflineplus">+            } else {</span>
<a href="#l44.335"></a><span id="l44.335" class="difflineplus">+                response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l44.336"></a><span id="l44.336" class="difflineplus">+            }</span>
<a href="#l44.337"></a><span id="l44.337" class="difflineplus">+        } else if (matchTag == &quot;*&quot;) {</span>
<a href="#l44.338"></a><span id="l44.338" class="difflineplus">+            response.setStatusLine(null, 410, &quot;Gone&quot;);</span>
<a href="#l44.339"></a><span id="l44.339" class="difflineplus">+        } else if (matchTag) {</span>
<a href="#l44.340"></a><span id="l44.340" class="difflineplus">+            response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l44.341"></a><span id="l44.341" class="difflineplus">+        } else {</span>
<a href="#l44.342"></a><span id="l44.342" class="difflineplus">+            response.setStatusLine(null, 404, &quot;Not Found&quot;);</span>
<a href="#l44.343"></a><span id="l44.343" class="difflineplus">+        }</span>
<a href="#l44.344"></a><span id="l44.344" class="difflineplus">+    },</span>
<a href="#l44.345"></a><span id="l44.345" class="difflineplus">+</span>
<a href="#l44.346"></a><span id="l44.346" class="difflineplus">+    processAddEvent: function(jsonData, isImport) {</span>
<a href="#l44.347"></a><span id="l44.347" class="difflineplus">+        jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l44.348"></a><span id="l44.348" class="difflineplus">+        jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l44.349"></a><span id="l44.349" class="difflineplus">+        jsonData.id = generateID();</span>
<a href="#l44.350"></a><span id="l44.350" class="difflineplus">+        if (!isImport) jsonData.htmlLink = this.baseUri + &quot;/calendar/event?eid=&quot; + jsonData.id;</span>
<a href="#l44.351"></a><span id="l44.351" class="difflineplus">+        if (!isImport || !jsonData.iCalUID) jsonData.iCalUID = jsonData.id + &quot;@google.com&quot;;</span>
<a href="#l44.352"></a><span id="l44.352" class="difflineplus">+        if (!isImport || !jsonData.created) jsonData.created = cal.toRFC3339(cal.now());</span>
<a href="#l44.353"></a><span id="l44.353" class="difflineplus">+        if (!isImport || !jsonData.updated) jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l44.354"></a><span id="l44.354" class="difflineplus">+        if (!isImport || !jsonData.creator) jsonData.creator = this.creator;</span>
<a href="#l44.355"></a><span id="l44.355" class="difflineplus">+        if (!isImport || !jsonData.organizer) jsonData.organizer = this.creator;</span>
<a href="#l44.356"></a><span id="l44.356" class="difflineplus">+        this.nextEtag = null;</span>
<a href="#l44.357"></a><span id="l44.357" class="difflineplus">+        return jsonData;</span>
<a href="#l44.358"></a><span id="l44.358" class="difflineplus">+    },</span>
<a href="#l44.359"></a><span id="l44.359" class="difflineplus">+</span>
<a href="#l44.360"></a><span id="l44.360" class="difflineplus">+    processModifyEvent: function(jsonData, id) {</span>
<a href="#l44.361"></a><span id="l44.361" class="difflineplus">+        jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l44.362"></a><span id="l44.362" class="difflineplus">+        jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l44.363"></a><span id="l44.363" class="difflineplus">+        jsonData.updated  = cal.toRFC3339(cal.now());</span>
<a href="#l44.364"></a><span id="l44.364" class="difflineplus">+        jsonData.id = id;</span>
<a href="#l44.365"></a><span id="l44.365" class="difflineplus">+        jsonData.iCalUID = (jsonData.recurringEventId || jsonData.id) + &quot;@google.com&quot;;</span>
<a href="#l44.366"></a><span id="l44.366" class="difflineplus">+        if (!jsonData.creator) jsonData.creator = this.creator;</span>
<a href="#l44.367"></a><span id="l44.367" class="difflineplus">+        if (!jsonData.organizer) jsonData.organizer = this.creator;</span>
<a href="#l44.368"></a><span id="l44.368" class="difflineplus">+</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineplus">+        this.nextEtag = null;</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineplus">+        return jsonData;</span>
<a href="#l44.371"></a><span id="l44.371" class="difflineplus">+    },</span>
<a href="#l44.372"></a><span id="l44.372" class="difflineplus">+</span>
<a href="#l44.373"></a><span id="l44.373" class="difflineplus">+    processAddTask: function(jsonData) {</span>
<a href="#l44.374"></a><span id="l44.374" class="difflineplus">+        jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l44.375"></a><span id="l44.375" class="difflineplus">+        jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l44.376"></a><span id="l44.376" class="difflineplus">+        jsonData.id = generateID();</span>
<a href="#l44.377"></a><span id="l44.377" class="difflineplus">+        jsonData.position = generateID(); // Not a real position, but we don't really use this at the moment</span>
<a href="#l44.378"></a><span id="l44.378" class="difflineplus">+        if (!jsonData.status) jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l44.379"></a><span id="l44.379" class="difflineplus">+        if (!jsonData.updated) jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l44.380"></a><span id="l44.380" class="difflineplus">+</span>
<a href="#l44.381"></a><span id="l44.381" class="difflineplus">+        this.nextEtag = null;</span>
<a href="#l44.382"></a><span id="l44.382" class="difflineplus">+        return jsonData;</span>
<a href="#l44.383"></a><span id="l44.383" class="difflineplus">+    },</span>
<a href="#l44.384"></a><span id="l44.384" class="difflineplus">+</span>
<a href="#l44.385"></a><span id="l44.385" class="difflineplus">+    processModifyTask: function(jsonData) {</span>
<a href="#l44.386"></a><span id="l44.386" class="difflineplus">+        jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l44.387"></a><span id="l44.387" class="difflineplus">+        jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l44.388"></a><span id="l44.388" class="difflineplus">+        jsonData.updated  = cal.toRFC3339(cal.now());</span>
<a href="#l44.389"></a><span id="l44.389" class="difflineplus">+        if (!jsonData.status) jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l44.390"></a><span id="l44.390" class="difflineplus">+        if (!jsonData.updated) jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l44.391"></a><span id="l44.391" class="difflineplus">+</span>
<a href="#l44.392"></a><span id="l44.392" class="difflineplus">+        this.nextEtag = null;</span>
<a href="#l44.393"></a><span id="l44.393" class="difflineplus">+        return jsonData;</span>
<a href="#l44.394"></a><span id="l44.394" class="difflineplus">+    },</span>
<a href="#l44.395"></a><span id="l44.395" class="difflineplus">+};</span>
<a href="#l44.396"></a><span id="l44.396" class="difflineplus">+</span>
<a href="#l44.397"></a><span id="l44.397" class="difflineplus">+function findKey(container, key, searchKey) {</span>
<a href="#l44.398"></a><span id="l44.398" class="difflineplus">+    let foundIndex = -1;</span>
<a href="#l44.399"></a><span id="l44.399" class="difflineplus">+    for (let i = 0; i &lt; container.length; i++) {</span>
<a href="#l44.400"></a><span id="l44.400" class="difflineplus">+        if (container[i][key] == searchKey) {</span>
<a href="#l44.401"></a><span id="l44.401" class="difflineplus">+            foundIndex = i;</span>
<a href="#l44.402"></a><span id="l44.402" class="difflineplus">+            break;</span>
<a href="#l44.403"></a><span id="l44.403" class="difflineplus">+        }</span>
<a href="#l44.404"></a><span id="l44.404" class="difflineplus">+    }</span>
<a href="#l44.405"></a><span id="l44.405" class="difflineplus">+</span>
<a href="#l44.406"></a><span id="l44.406" class="difflineplus">+    let foundItem = foundIndex == -1 ? null : container[foundIndex];</span>
<a href="#l44.407"></a><span id="l44.407" class="difflineplus">+    return [foundIndex, foundItem];</span>
<a href="#l44.408"></a><span id="l44.408" class="difflineplus">+}</span>
<a href="#l44.409"></a><span id="l44.409" class="difflineplus">+</span>
<a href="#l44.410"></a><span id="l44.410" class="difflineplus">+function generateID() {</span>
<a href="#l44.411"></a><span id="l44.411" class="difflineplus">+    let c = &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span>
<a href="#l44.412"></a><span id="l44.412" class="difflineplus">+    let s = &quot;&quot;;</span>
<a href="#l44.413"></a><span id="l44.413" class="difflineplus">+    for (let i = 26; i; i--) {</span>
<a href="#l44.414"></a><span id="l44.414" class="difflineplus">+      s += c[Math.floor(Math.random() * c.length)];</span>
<a href="#l44.415"></a><span id="l44.415" class="difflineplus">+    }</span>
<a href="#l44.416"></a><span id="l44.416" class="difflineplus">+    return s;</span>
<a href="#l44.417"></a><span id="l44.417" class="difflineplus">+}</span>
<a href="#l44.418"></a><span id="l44.418" class="difflineplus">+</span>
<a href="#l44.419"></a><span id="l44.419" class="difflineplus">+function getAllMeta(calendar) {</span>
<a href="#l44.420"></a><span id="l44.420" class="difflineplus">+    let keys = {}, values = {};</span>
<a href="#l44.421"></a><span id="l44.421" class="difflineplus">+    calendar.getAllMetaData({}, keys, values);</span>
<a href="#l44.422"></a><span id="l44.422" class="difflineplus">+    return new Map(keys.value.map((k,i) =&gt; [k,values.value[i]]));</span>
<a href="#l44.423"></a><span id="l44.423" class="difflineplus">+}</span>
<a href="#l44.424"></a><span id="l44.424" class="difflineplus">+</span>
<a href="#l44.425"></a><span id="l44.425" class="difflineplus">+function run_test() {</span>
<a href="#l44.426"></a><span id="l44.426" class="difflineplus">+    do_get_profile();</span>
<a href="#l44.427"></a><span id="l44.427" class="difflineplus">+    cal.getCalendarManager().startup({onResult: function() {</span>
<a href="#l44.428"></a><span id="l44.428" class="difflineplus">+        gServer = new GDataServer(&quot;calendarId&quot;, &quot;tasksId&quot;);</span>
<a href="#l44.429"></a><span id="l44.429" class="difflineplus">+        gServer.start();</span>
<a href="#l44.430"></a><span id="l44.430" class="difflineplus">+        run_next_test();</span>
<a href="#l44.431"></a><span id="l44.431" class="difflineplus">+    }});</span>
<a href="#l44.432"></a><span id="l44.432" class="difflineplus">+}</span>
<a href="#l44.433"></a><span id="l44.433" class="difflineplus">+</span>
<a href="#l44.434"></a><span id="l44.434" class="difflineplus">+add_test(function test_migrate_uri() {</span>
<a href="#l44.435"></a><span id="l44.435" class="difflineplus">+    function checkMigrate(fromUri, session, calendarId, tasksId) {</span>
<a href="#l44.436"></a><span id="l44.436" class="difflineplus">+        let uri = Services.io.newURI(fromUri, null, null);</span>
<a href="#l44.437"></a><span id="l44.437" class="difflineplus">+        let client = cal.getCalendarManager().createCalendar(&quot;gdata&quot;, uri);</span>
<a href="#l44.438"></a><span id="l44.438" class="difflineplus">+</span>
<a href="#l44.439"></a><span id="l44.439" class="difflineplus">+        if (session) {</span>
<a href="#l44.440"></a><span id="l44.440" class="difflineplus">+            let target = (&quot;googleapi://&quot; + session + &quot;/?&quot; +</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineplus">+                         (calendarId ? &quot;&amp;calendar=&quot; + encodeURIComponent(calendarId) : &quot;&quot;) +</span>
<a href="#l44.442"></a><span id="l44.442" class="difflineplus">+                         (tasksId ? &quot;&amp;tasks=&quot; + encodeURIComponent(tasksId) : &quot;&quot;)).replace(&quot;?&amp;&quot;, &quot;?&quot;);</span>
<a href="#l44.443"></a><span id="l44.443" class="difflineplus">+            do_check_eq(client.getProperty(&quot;uri&quot;), target);</span>
<a href="#l44.444"></a><span id="l44.444" class="difflineplus">+        } else {</span>
<a href="#l44.445"></a><span id="l44.445" class="difflineplus">+            do_check_eq(client.getProperty(&quot;uri&quot;), null);</span>
<a href="#l44.446"></a><span id="l44.446" class="difflineplus">+        }</span>
<a href="#l44.447"></a><span id="l44.447" class="difflineplus">+    }</span>
<a href="#l44.448"></a><span id="l44.448" class="difflineplus">+</span>
<a href="#l44.449"></a><span id="l44.449" class="difflineplus">+    checkMigrate(&quot;http://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l44.450"></a><span id="l44.450" class="difflineplus">+                 &quot;example@example.com&quot;, &quot;example@example.com&quot;, null);</span>
<a href="#l44.451"></a><span id="l44.451" class="difflineplus">+</span>
<a href="#l44.452"></a><span id="l44.452" class="difflineplus">+    checkMigrate(&quot;webcal://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineplus">+                 &quot;example@example.com&quot;, &quot;example@example.com&quot;, null);</span>
<a href="#l44.454"></a><span id="l44.454" class="difflineplus">+</span>
<a href="#l44.455"></a><span id="l44.455" class="difflineplus">+    Preferences.set(&quot;calendar.google.calPrefs.example@example.com.googleUser&quot;, &quot;example@example.com&quot;);</span>
<a href="#l44.456"></a><span id="l44.456" class="difflineplus">+    checkMigrate(&quot;http://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l44.457"></a><span id="l44.457" class="difflineplus">+                 &quot;example@example.com&quot;, &quot;example@example.com&quot;, &quot;@default&quot;);</span>
<a href="#l44.458"></a><span id="l44.458" class="difflineplus">+</span>
<a href="#l44.459"></a><span id="l44.459" class="difflineplus">+    checkMigrate(&quot;ehmwtf://www.google.com/calendar/feeds/example%40example.com/public/full&quot;);</span>
<a href="#l44.460"></a><span id="l44.460" class="difflineplus">+    checkMigrate(&quot;googleapi://session/?calendar=calendarId&amp;tasksId=tasksId&quot;);</span>
<a href="#l44.461"></a><span id="l44.461" class="difflineplus">+</span>
<a href="#l44.462"></a><span id="l44.462" class="difflineplus">+    run_next_test();</span>
<a href="#l44.463"></a><span id="l44.463" class="difflineplus">+});</span>
<a href="#l44.464"></a><span id="l44.464" class="difflineplus">+</span>
<a href="#l44.465"></a><span id="l44.465" class="difflineplus">+add_task(function* test_organizerCN() {</span>
<a href="#l44.466"></a><span id="l44.466" class="difflineplus">+    gServer.events = [];</span>
<a href="#l44.467"></a><span id="l44.467" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.468"></a><span id="l44.468" class="difflineplus">+    do_check_eq(client.getProperty(&quot;organizerCN&quot;), null);</span>
<a href="#l44.469"></a><span id="l44.469" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.470"></a><span id="l44.470" class="difflineplus">+</span>
<a href="#l44.471"></a><span id="l44.471" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.472"></a><span id="l44.472" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.473"></a><span id="l44.473" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2299601498276000\&quot;&quot;,</span>
<a href="#l44.474"></a><span id="l44.474" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.475"></a><span id="l44.475" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.476"></a><span id="l44.476" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.477"></a><span id="l44.477" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.478"></a><span id="l44.478" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.479"></a><span id="l44.479" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.480"></a><span id="l44.480" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.481"></a><span id="l44.481" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.482"></a><span id="l44.482" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.483"></a><span id="l44.483" class="difflineplus">+    }];</span>
<a href="#l44.484"></a><span id="l44.484" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.485"></a><span id="l44.485" class="difflineplus">+    do_check_eq(client.getProperty(&quot;organizerCN&quot;), gServer.creator.displayName);</span>
<a href="#l44.486"></a><span id="l44.486" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.487"></a><span id="l44.487" class="difflineplus">+});</span>
<a href="#l44.488"></a><span id="l44.488" class="difflineplus">+</span>
<a href="#l44.489"></a><span id="l44.489" class="difflineplus">+add_task(function* test_always_readOnly() {</span>
<a href="#l44.490"></a><span id="l44.490" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.491"></a><span id="l44.491" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.492"></a><span id="l44.492" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2299601498276000\&quot;&quot;,</span>
<a href="#l44.493"></a><span id="l44.493" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.494"></a><span id="l44.494" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.495"></a><span id="l44.495" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.496"></a><span id="l44.496" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.497"></a><span id="l44.497" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.498"></a><span id="l44.498" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.499"></a><span id="l44.499" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.500"></a><span id="l44.500" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.502"></a><span id="l44.502" class="difflineplus">+    }];</span>
<a href="#l44.503"></a><span id="l44.503" class="difflineplus">+    gServer.calendarListData.accessRole = &quot;freeBusyReader&quot;;</span>
<a href="#l44.504"></a><span id="l44.504" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.505"></a><span id="l44.505" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l44.506"></a><span id="l44.506" class="difflineplus">+    do_check_true(client.readOnly)</span>
<a href="#l44.507"></a><span id="l44.507" class="difflineplus">+    client.readOnly = false;</span>
<a href="#l44.508"></a><span id="l44.508" class="difflineplus">+    do_check_true(client.readOnly)</span>
<a href="#l44.509"></a><span id="l44.509" class="difflineplus">+</span>
<a href="#l44.510"></a><span id="l44.510" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.512"></a><span id="l44.512" class="difflineplus">+    do_check_neq(items[0].title, &quot;New Event&quot;);</span>
<a href="#l44.513"></a><span id="l44.513" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.514"></a><span id="l44.514" class="difflineplus">+</span>
<a href="#l44.515"></a><span id="l44.515" class="difflineplus">+    gServer.calendarListData.accessRole = &quot;reader&quot;;</span>
<a href="#l44.516"></a><span id="l44.516" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.517"></a><span id="l44.517" class="difflineplus">+    do_check_true(client.readOnly)</span>
<a href="#l44.518"></a><span id="l44.518" class="difflineplus">+    client.readOnly = false;</span>
<a href="#l44.519"></a><span id="l44.519" class="difflineplus">+    do_check_true(client.readOnly)</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.521"></a><span id="l44.521" class="difflineplus">+});</span>
<a href="#l44.522"></a><span id="l44.522" class="difflineplus">+</span>
<a href="#l44.523"></a><span id="l44.523" class="difflineplus">+add_task(function* test_reset_sync() {</span>
<a href="#l44.524"></a><span id="l44.524" class="difflineplus">+    gServer.tasks = [</span>
<a href="#l44.525"></a><span id="l44.525" class="difflineplus">+       {</span>
<a href="#l44.526"></a><span id="l44.526" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.527"></a><span id="l44.527" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.528"></a><span id="l44.528" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM\&quot;&quot;,</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineplus">+        &quot;title&quot;: &quot;New Task&quot;,</span>
<a href="#l44.530"></a><span id="l44.530" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.531"></a><span id="l44.531" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.532"></a><span id="l44.532" class="difflineplus">+        &quot;position&quot;: &quot;00000000000000130998&quot;,</span>
<a href="#l44.533"></a><span id="l44.533" class="difflineplus">+        &quot;status&quot;: &quot;needsAction&quot;</span>
<a href="#l44.534"></a><span id="l44.534" class="difflineplus">+      },{</span>
<a href="#l44.535"></a><span id="l44.535" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.536"></a><span id="l44.536" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l44.537"></a><span id="l44.537" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTQyNTY0MjUwOQ\&quot;&quot;,</span>
<a href="#l44.538"></a><span id="l44.538" class="difflineplus">+        &quot;title&quot;: &quot;New Task 2&quot;,</span>
<a href="#l44.539"></a><span id="l44.539" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.540"></a><span id="l44.540" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l44.541"></a><span id="l44.541" class="difflineplus">+        &quot;position&quot;: &quot;00000000000000130993&quot;,</span>
<a href="#l44.542"></a><span id="l44.542" class="difflineplus">+        &quot;status&quot;: &quot;needsAction&quot;</span>
<a href="#l44.543"></a><span id="l44.543" class="difflineplus">+      }</span>
<a href="#l44.544"></a><span id="l44.544" class="difflineplus">+    ];</span>
<a href="#l44.545"></a><span id="l44.545" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.546"></a><span id="l44.546" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.547"></a><span id="l44.547" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.548"></a><span id="l44.548" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.549"></a><span id="l44.549" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.550"></a><span id="l44.550" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.551"></a><span id="l44.551" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.552"></a><span id="l44.552" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.553"></a><span id="l44.553" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.554"></a><span id="l44.554" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.555"></a><span id="l44.555" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.556"></a><span id="l44.556" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.557"></a><span id="l44.557" class="difflineplus">+    },{</span>
<a href="#l44.558"></a><span id="l44.558" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.559"></a><span id="l44.559" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.560"></a><span id="l44.560" class="difflineplus">+       &quot;id&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l44.561"></a><span id="l44.561" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.562"></a><span id="l44.562" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.563"></a><span id="l44.563" class="difflineplus">+       &quot;summary&quot;: &quot;New Event 2&quot;,</span>
<a href="#l44.564"></a><span id="l44.564" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.565"></a><span id="l44.565" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.566"></a><span id="l44.566" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.567"></a><span id="l44.567" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineplus">+       &quot;iCalUID&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;</span>
<a href="#l44.569"></a><span id="l44.569" class="difflineplus">+    }];</span>
<a href="#l44.570"></a><span id="l44.570" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.571"></a><span id="l44.571" class="difflineplus">+    let uncached = client.wrappedJSObject.mUncachedCalendar.wrappedJSObject;</span>
<a href="#l44.572"></a><span id="l44.572" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l44.573"></a><span id="l44.573" class="difflineplus">+</span>
<a href="#l44.574"></a><span id="l44.574" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.575"></a><span id="l44.575" class="difflineplus">+    do_check_eq(items.length, 4);</span>
<a href="#l44.576"></a><span id="l44.576" class="difflineplus">+</span>
<a href="#l44.577"></a><span id="l44.577" class="difflineplus">+    do_check_neq(client.getProperty(&quot;syncToken.events&quot;), &quot;&quot;);</span>
<a href="#l44.578"></a><span id="l44.578" class="difflineplus">+    do_check_neq(client.getProperty(&quot;lastUpdated.tasks&quot;), &quot;&quot;);</span>
<a href="#l44.579"></a><span id="l44.579" class="difflineplus">+</span>
<a href="#l44.580"></a><span id="l44.580" class="difflineplus">+    yield uncached.resetSync();</span>
<a href="#l44.581"></a><span id="l44.581" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.582"></a><span id="l44.582" class="difflineplus">+    do_check_eq(items.length, 0);</span>
<a href="#l44.583"></a><span id="l44.583" class="difflineplus">+</span>
<a href="#l44.584"></a><span id="l44.584" class="difflineplus">+    do_check_eq(client.getProperty(&quot;syncToken.events&quot;), &quot;&quot;);</span>
<a href="#l44.585"></a><span id="l44.585" class="difflineplus">+    do_check_eq(client.getProperty(&quot;lastUpdated.tasks&quot;), &quot;&quot;);</span>
<a href="#l44.586"></a><span id="l44.586" class="difflineplus">+</span>
<a href="#l44.587"></a><span id="l44.587" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.588"></a><span id="l44.588" class="difflineplus">+});</span>
<a href="#l44.589"></a><span id="l44.589" class="difflineplus">+</span>
<a href="#l44.590"></a><span id="l44.590" class="difflineplus">+add_task(function* test_basicItems() {</span>
<a href="#l44.591"></a><span id="l44.591" class="difflineplus">+    gServer.events = [</span>
<a href="#l44.592"></a><span id="l44.592" class="difflineplus">+      {</span>
<a href="#l44.593"></a><span id="l44.593" class="difflineplus">+         &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.594"></a><span id="l44.594" class="difflineplus">+         &quot;etag&quot;: &quot;\&quot;2299601498276000\&quot;&quot;,</span>
<a href="#l44.595"></a><span id="l44.595" class="difflineplus">+         &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.596"></a><span id="l44.596" class="difflineplus">+         &quot;status&quot;: &quot;confirmed&quot;,</span>
<a href="#l44.597"></a><span id="l44.597" class="difflineplus">+         &quot;htmlLink&quot;: gServer.baseUri + &quot;/calendar/event?eid=eventhash&quot;,</span>
<a href="#l44.598"></a><span id="l44.598" class="difflineplus">+         &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.599"></a><span id="l44.599" class="difflineplus">+         &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.600"></a><span id="l44.600" class="difflineplus">+         &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.601"></a><span id="l44.601" class="difflineplus">+         &quot;description&quot;: &quot;description&quot;,</span>
<a href="#l44.602"></a><span id="l44.602" class="difflineplus">+         &quot;location&quot;: &quot;Hard Drive&quot;,</span>
<a href="#l44.603"></a><span id="l44.603" class="difflineplus">+         &quot;colorId&quot;: 17,</span>
<a href="#l44.604"></a><span id="l44.604" class="difflineplus">+         &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.605"></a><span id="l44.605" class="difflineplus">+         &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.606"></a><span id="l44.606" class="difflineplus">+         &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.607"></a><span id="l44.607" class="difflineplus">+         &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.608"></a><span id="l44.608" class="difflineplus">+         &quot;transparency&quot;: &quot;transparent&quot;,</span>
<a href="#l44.609"></a><span id="l44.609" class="difflineplus">+         &quot;visibility&quot;: &quot;private&quot;,</span>
<a href="#l44.610"></a><span id="l44.610" class="difflineplus">+         &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l44.611"></a><span id="l44.611" class="difflineplus">+         &quot;sequence&quot;: 1,</span>
<a href="#l44.612"></a><span id="l44.612" class="difflineplus">+         &quot;reminders&quot;: {</span>
<a href="#l44.613"></a><span id="l44.613" class="difflineplus">+            &quot;useDefault&quot;: false,</span>
<a href="#l44.614"></a><span id="l44.614" class="difflineplus">+            &quot;overrides&quot;: [{</span>
<a href="#l44.615"></a><span id="l44.615" class="difflineplus">+                &quot;method&quot;: &quot;email&quot;,</span>
<a href="#l44.616"></a><span id="l44.616" class="difflineplus">+                &quot;minutes&quot;: 20</span>
<a href="#l44.617"></a><span id="l44.617" class="difflineplus">+             }]</span>
<a href="#l44.618"></a><span id="l44.618" class="difflineplus">+         },</span>
<a href="#l44.619"></a><span id="l44.619" class="difflineplus">+         &quot;attendees&quot;: [{</span>
<a href="#l44.620"></a><span id="l44.620" class="difflineplus">+            &quot;displayName&quot;: &quot;attendee name&quot;,</span>
<a href="#l44.621"></a><span id="l44.621" class="difflineplus">+            &quot;email&quot;: &quot;attendee@example.com&quot;,</span>
<a href="#l44.622"></a><span id="l44.622" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l44.623"></a><span id="l44.623" class="difflineplus">+            &quot;responseStatus&quot;: &quot;tentative&quot;</span>
<a href="#l44.624"></a><span id="l44.624" class="difflineplus">+        }],</span>
<a href="#l44.625"></a><span id="l44.625" class="difflineplus">+</span>
<a href="#l44.626"></a><span id="l44.626" class="difflineplus">+        &quot;extendedProperties&quot;: {</span>
<a href="#l44.627"></a><span id="l44.627" class="difflineplus">+          &quot;shared&quot;: {</span>
<a href="#l44.628"></a><span id="l44.628" class="difflineplus">+            &quot;X-MOZ-CATEGORIES&quot;: &quot;foo,bar&quot;</span>
<a href="#l44.629"></a><span id="l44.629" class="difflineplus">+          },</span>
<a href="#l44.630"></a><span id="l44.630" class="difflineplus">+          &quot;private&quot;: {</span>
<a href="#l44.631"></a><span id="l44.631" class="difflineplus">+            &quot;X-MOZ-LASTACK&quot;: &quot;2014-01-01T01:01:01Z&quot;,</span>
<a href="#l44.632"></a><span id="l44.632" class="difflineplus">+            &quot;X-MOZ-SNOOZE-TIME&quot;: &quot;2014-01-01T02:02:02Z&quot;</span>
<a href="#l44.633"></a><span id="l44.633" class="difflineplus">+          }</span>
<a href="#l44.634"></a><span id="l44.634" class="difflineplus">+        }</span>
<a href="#l44.635"></a><span id="l44.635" class="difflineplus">+      }</span>
<a href="#l44.636"></a><span id="l44.636" class="difflineplus">+    ];</span>
<a href="#l44.637"></a><span id="l44.637" class="difflineplus">+</span>
<a href="#l44.638"></a><span id="l44.638" class="difflineplus">+    gServer.tasks = [</span>
<a href="#l44.639"></a><span id="l44.639" class="difflineplus">+       {</span>
<a href="#l44.640"></a><span id="l44.640" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.641"></a><span id="l44.641" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.642"></a><span id="l44.642" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM\&quot;&quot;,</span>
<a href="#l44.643"></a><span id="l44.643" class="difflineplus">+        &quot;title&quot;: &quot;New Task&quot;,</span>
<a href="#l44.644"></a><span id="l44.644" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.645"></a><span id="l44.645" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.646"></a><span id="l44.646" class="difflineplus">+        &quot;position&quot;: &quot;00000000000000130998&quot;,</span>
<a href="#l44.647"></a><span id="l44.647" class="difflineplus">+        &quot;status&quot;: &quot;completed&quot;,</span>
<a href="#l44.648"></a><span id="l44.648" class="difflineplus">+        &quot;due&quot;: &quot;2014-09-04T00:00:00.000Z&quot;,</span>
<a href="#l44.649"></a><span id="l44.649" class="difflineplus">+        &quot;completed&quot;: &quot;2014-09-01T17:00:00.000Z&quot;,</span>
<a href="#l44.650"></a><span id="l44.650" class="difflineplus">+        &quot;notes&quot;: &quot;description&quot;,</span>
<a href="#l44.651"></a><span id="l44.651" class="difflineplus">+        &quot;parent&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;,</span>
<a href="#l44.652"></a><span id="l44.652" class="difflineplus">+        &quot;links&quot;: [{</span>
<a href="#l44.653"></a><span id="l44.653" class="difflineplus">+          &quot;link&quot;: &quot;mailto:something@example.com&quot;,</span>
<a href="#l44.654"></a><span id="l44.654" class="difflineplus">+          &quot;description&quot;: &quot;link description&quot;,</span>
<a href="#l44.655"></a><span id="l44.655" class="difflineplus">+          &quot;type&quot;: &quot;email&quot;</span>
<a href="#l44.656"></a><span id="l44.656" class="difflineplus">+        }]</span>
<a href="#l44.657"></a><span id="l44.657" class="difflineplus">+      }</span>
<a href="#l44.658"></a><span id="l44.658" class="difflineplus">+    ];</span>
<a href="#l44.659"></a><span id="l44.659" class="difflineplus">+</span>
<a href="#l44.660"></a><span id="l44.660" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.661"></a><span id="l44.661" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l44.662"></a><span id="l44.662" class="difflineplus">+</span>
<a href="#l44.663"></a><span id="l44.663" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.664"></a><span id="l44.664" class="difflineplus">+    do_check_eq(items.length, 2);</span>
<a href="#l44.665"></a><span id="l44.665" class="difflineplus">+</span>
<a href="#l44.666"></a><span id="l44.666" class="difflineplus">+    let event = cal.isEvent(items[0]) ? items[0]: items[1];</span>
<a href="#l44.667"></a><span id="l44.667" class="difflineplus">+    do_check_eq(event.id, &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;);</span>
<a href="#l44.668"></a><span id="l44.668" class="difflineplus">+    do_check_eq(event.getProperty(&quot;STATUS&quot;), &quot;CONFIRMED&quot;);</span>
<a href="#l44.669"></a><span id="l44.669" class="difflineplus">+    do_check_eq(event.getProperty(&quot;URL&quot;), gServer.baseUri + &quot;/calendar/event?eid=eventhash&quot;);</span>
<a href="#l44.670"></a><span id="l44.670" class="difflineplus">+    do_check_eq(event.getProperty(&quot;CREATED&quot;).icalString, &quot;20060608T210452Z&quot;);</span>
<a href="#l44.671"></a><span id="l44.671" class="difflineplus">+    do_check_eq(event.getProperty(&quot;LAST-MODIFIED&quot;).icalString, &quot;20060608T210549Z&quot;);</span>
<a href="#l44.672"></a><span id="l44.672" class="difflineplus">+    do_check_eq(event.title, &quot;New Event&quot;);</span>
<a href="#l44.673"></a><span id="l44.673" class="difflineplus">+    do_check_eq(event.getProperty(&quot;DESCRIPTION&quot;), &quot;description&quot;);</span>
<a href="#l44.674"></a><span id="l44.674" class="difflineplus">+    do_check_eq(event.getProperty(&quot;LOCATION&quot;), &quot;Hard Drive&quot;);</span>
<a href="#l44.675"></a><span id="l44.675" class="difflineplus">+    do_check_eq(event.organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l44.676"></a><span id="l44.676" class="difflineplus">+    do_check_eq(event.organizer.commonName, &quot;Eggs P. Seashell&quot;);</span>
<a href="#l44.677"></a><span id="l44.677" class="difflineplus">+    do_check_true(event.organizer.isOrganizer);</span>
<a href="#l44.678"></a><span id="l44.678" class="difflineplus">+    do_check_eq(event.startDate.icalString, &quot;20060610T180000&quot;);</span>
<a href="#l44.679"></a><span id="l44.679" class="difflineplus">+    do_check_eq(event.startDate.timezone.tzid, &quot;Europe/Berlin&quot;);</span>
<a href="#l44.680"></a><span id="l44.680" class="difflineplus">+    do_check_eq(event.endDate.icalString, &quot;20060610T200000&quot;);</span>
<a href="#l44.681"></a><span id="l44.681" class="difflineplus">+    do_check_eq(event.getProperty(&quot;TRANSP&quot;), &quot;TRANSPARENT&quot;);</span>
<a href="#l44.682"></a><span id="l44.682" class="difflineplus">+    do_check_eq(event.privacy, &quot;PRIVATE&quot;);</span>
<a href="#l44.683"></a><span id="l44.683" class="difflineplus">+    do_check_eq(event.getProperty(&quot;SEQUENCE&quot;), 1);</span>
<a href="#l44.684"></a><span id="l44.684" class="difflineplus">+    let alarms = event.getAlarms({});</span>
<a href="#l44.685"></a><span id="l44.685" class="difflineplus">+    do_check_eq(alarms.length, 1);</span>
<a href="#l44.686"></a><span id="l44.686" class="difflineplus">+    do_check_eq(alarms[0].action, &quot;EMAIL&quot;);</span>
<a href="#l44.687"></a><span id="l44.687" class="difflineplus">+    do_check_eq(alarms[0].related, alarms[0].ALARM_RELATED_START);</span>
<a href="#l44.688"></a><span id="l44.688" class="difflineplus">+    do_check_eq(alarms[0].offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l44.689"></a><span id="l44.689" class="difflineplus">+    do_check_null(alarms[0].getProperty(&quot;X-DEFAULT-ALARM&quot;));</span>
<a href="#l44.690"></a><span id="l44.690" class="difflineplus">+    let attendees = event.getAttendees({});</span>
<a href="#l44.691"></a><span id="l44.691" class="difflineplus">+    do_check_eq(attendees.length, 1);</span>
<a href="#l44.692"></a><span id="l44.692" class="difflineplus">+    do_check_eq(attendees[0].id, &quot;mailto:attendee@example.com&quot;);</span>
<a href="#l44.693"></a><span id="l44.693" class="difflineplus">+    do_check_eq(attendees[0].commonName, &quot;attendee name&quot;);</span>
<a href="#l44.694"></a><span id="l44.694" class="difflineplus">+    do_check_eq(attendees[0].role, &quot;OPT-PARTICIPANT&quot;);</span>
<a href="#l44.695"></a><span id="l44.695" class="difflineplus">+    do_check_eq(attendees[0].participationStatus, &quot;TENTATIVE&quot;);</span>
<a href="#l44.696"></a><span id="l44.696" class="difflineplus">+    do_check_eq(event.getCategories({}), &quot;foo,bar&quot;);</span>
<a href="#l44.697"></a><span id="l44.697" class="difflineplus">+    do_check_eq(event.alarmLastAck.icalString, &quot;20140101T010101Z&quot;);</span>
<a href="#l44.698"></a><span id="l44.698" class="difflineplus">+    do_check_eq(event.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;), &quot;20140101T020202Z&quot;);</span>
<a href="#l44.699"></a><span id="l44.699" class="difflineplus">+</span>
<a href="#l44.700"></a><span id="l44.700" class="difflineplus">+    let task = cal.isToDo(items[0]) ? items[0] : items[1];</span>
<a href="#l44.701"></a><span id="l44.701" class="difflineplus">+    do_check_eq(task.id, &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;);</span>
<a href="#l44.702"></a><span id="l44.702" class="difflineplus">+    do_check_eq(task.title, &quot;New Task&quot;);</span>
<a href="#l44.703"></a><span id="l44.703" class="difflineplus">+    do_check_eq(task.getProperty(&quot;LAST-MODIFIED&quot;).icalString, &quot;20140908T163027Z&quot;);</span>
<a href="#l44.704"></a><span id="l44.704" class="difflineplus">+    do_check_eq(task.getProperty(&quot;X-GOOGLE-SORTKEY&quot;), &quot;00000000000000130998&quot;);</span>
<a href="#l44.705"></a><span id="l44.705" class="difflineplus">+    do_check_true(task.isCompleted);</span>
<a href="#l44.706"></a><span id="l44.706" class="difflineplus">+    do_check_eq(task.dueDate.icalString, &quot;20140904&quot;);</span>
<a href="#l44.707"></a><span id="l44.707" class="difflineplus">+    do_check_eq(task.completedDate.icalString, &quot;20140901T170000Z&quot;);</span>
<a href="#l44.708"></a><span id="l44.708" class="difflineplus">+    do_check_eq(task.getProperty(&quot;DESCRIPTION&quot;), &quot;description&quot;);</span>
<a href="#l44.709"></a><span id="l44.709" class="difflineplus">+    let relations = task.getRelations({});</span>
<a href="#l44.710"></a><span id="l44.710" class="difflineplus">+    do_check_eq(relations.length, 1);</span>
<a href="#l44.711"></a><span id="l44.711" class="difflineplus">+    do_check_eq(relations[0].relType, &quot;PARENT&quot;);</span>
<a href="#l44.712"></a><span id="l44.712" class="difflineplus">+    do_check_eq(relations[0].relId, &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;);</span>
<a href="#l44.713"></a><span id="l44.713" class="difflineplus">+    let attachments = task.getAttachments({});</span>
<a href="#l44.714"></a><span id="l44.714" class="difflineplus">+    do_check_eq(attachments.length, 1);</span>
<a href="#l44.715"></a><span id="l44.715" class="difflineplus">+    do_check_eq(attachments[0].uri.spec, &quot;mailto:something@example.com&quot;);</span>
<a href="#l44.716"></a><span id="l44.716" class="difflineplus">+    do_check_eq(attachments[0].getParameter(&quot;X-GOOGLE-TYPE&quot;), &quot;email&quot;);</span>
<a href="#l44.717"></a><span id="l44.717" class="difflineplus">+    do_check_eq(attachments[0].getParameter(&quot;FILENAME&quot;), &quot;link description&quot;);</span>
<a href="#l44.718"></a><span id="l44.718" class="difflineplus">+</span>
<a href="#l44.719"></a><span id="l44.719" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.720"></a><span id="l44.720" class="difflineplus">+});</span>
<a href="#l44.721"></a><span id="l44.721" class="difflineplus">+</span>
<a href="#l44.722"></a><span id="l44.722" class="difflineplus">+add_task(function* test_addModifyDeleteItem() {</span>
<a href="#l44.723"></a><span id="l44.723" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.724"></a><span id="l44.724" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.725"></a><span id="l44.725" class="difflineplus">+    do_check_eq(gServer.events.length, 0);</span>
<a href="#l44.726"></a><span id="l44.726" class="difflineplus">+    do_check_eq(gServer.tasks.length, 0);</span>
<a href="#l44.727"></a><span id="l44.727" class="difflineplus">+</span>
<a href="#l44.728"></a><span id="l44.728" class="difflineplus">+    let event = cal.createEvent([</span>
<a href="#l44.729"></a><span id="l44.729" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l44.730"></a><span id="l44.730" class="difflineplus">+        &quot;CREATED:20060608T210452Z&quot;,</span>
<a href="#l44.731"></a><span id="l44.731" class="difflineplus">+        &quot;LAST-MODIFIED:20060608T210549Z&quot;,</span>
<a href="#l44.732"></a><span id="l44.732" class="difflineplus">+        &quot;DTSTAMP:20060608T210549Z&quot;,</span>
<a href="#l44.733"></a><span id="l44.733" class="difflineplus">+        &quot;SUMMARY:New Event&quot;,</span>
<a href="#l44.734"></a><span id="l44.734" class="difflineplus">+        &quot;STATUS:CONFIRMED&quot;,</span>
<a href="#l44.735"></a><span id="l44.735" class="difflineplus">+        &quot;ORGANIZER;CN=Eggs P. Seashell:mailto:xpcshell@example.com&quot;,</span>
<a href="#l44.736"></a><span id="l44.736" class="difflineplus">+        &quot;ATTENDEE;CN=attendee name;PARTSTAT=TENTATIVE;CUTYPE=INDIVIDUAL;ROLE=OPT-PA&quot;,</span>
<a href="#l44.737"></a><span id="l44.737" class="difflineplus">+        &quot; RTICIPANT:mailto:attendee@example.com&quot;,</span>
<a href="#l44.738"></a><span id="l44.738" class="difflineplus">+        &quot;CATEGORIES:foo&quot;,</span>
<a href="#l44.739"></a><span id="l44.739" class="difflineplus">+        &quot;CATEGORIES:bar&quot;,</span>
<a href="#l44.740"></a><span id="l44.740" class="difflineplus">+        &quot;X-MOZ-LASTACK:20140101T010101Z&quot;,</span>
<a href="#l44.741"></a><span id="l44.741" class="difflineplus">+        &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l44.742"></a><span id="l44.742" class="difflineplus">+        &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l44.743"></a><span id="l44.743" class="difflineplus">+        &quot;CLASS:PRIVATE&quot;,</span>
<a href="#l44.744"></a><span id="l44.744" class="difflineplus">+        &quot;URL:http://eventlocation&quot;,</span>
<a href="#l44.745"></a><span id="l44.745" class="difflineplus">+        &quot;DESCRIPTION:description&quot;,</span>
<a href="#l44.746"></a><span id="l44.746" class="difflineplus">+        &quot;LOCATION:Hard Drive&quot;,</span>
<a href="#l44.747"></a><span id="l44.747" class="difflineplus">+        &quot;TRANSP:TRANSPARENT&quot;,</span>
<a href="#l44.748"></a><span id="l44.748" class="difflineplus">+        &quot;SEQUENCE:1&quot;,</span>
<a href="#l44.749"></a><span id="l44.749" class="difflineplus">+        &quot;X-MOZ-SNOOZE-TIME:20140101T020202Z&quot;,</span>
<a href="#l44.750"></a><span id="l44.750" class="difflineplus">+        &quot;BEGIN:VALARM&quot;,</span>
<a href="#l44.751"></a><span id="l44.751" class="difflineplus">+        &quot;ACTION:EMAIL&quot;,</span>
<a href="#l44.752"></a><span id="l44.752" class="difflineplus">+        &quot;TRIGGER;VALUE=DURATION:-PT20M&quot;,</span>
<a href="#l44.753"></a><span id="l44.753" class="difflineplus">+        &quot;SUMMARY:Default Mozilla Summary&quot;,</span>
<a href="#l44.754"></a><span id="l44.754" class="difflineplus">+        &quot;DESCRIPTION:Default Mozilla Description&quot;,</span>
<a href="#l44.755"></a><span id="l44.755" class="difflineplus">+        &quot;END:VALARM&quot;,</span>
<a href="#l44.756"></a><span id="l44.756" class="difflineplus">+        &quot;END:VEVENT&quot;</span>
<a href="#l44.757"></a><span id="l44.757" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.758"></a><span id="l44.758" class="difflineplus">+</span>
<a href="#l44.759"></a><span id="l44.759" class="difflineplus">+    let task = cal.createTodo([</span>
<a href="#l44.760"></a><span id="l44.760" class="difflineplus">+        &quot;BEGIN:VTODO&quot;,</span>
<a href="#l44.761"></a><span id="l44.761" class="difflineplus">+        &quot;SUMMARY:New Task&quot;,</span>
<a href="#l44.762"></a><span id="l44.762" class="difflineplus">+        &quot;DESCRIPTION:description&quot;,</span>
<a href="#l44.763"></a><span id="l44.763" class="difflineplus">+        &quot;X-SORTKEY:00000000000000130998&quot;,</span>
<a href="#l44.764"></a><span id="l44.764" class="difflineplus">+        &quot;STATUS:COMPLETED&quot;,</span>
<a href="#l44.765"></a><span id="l44.765" class="difflineplus">+        &quot;DUE:20140904&quot;,</span>
<a href="#l44.766"></a><span id="l44.766" class="difflineplus">+        &quot;COMPLETED:20140901T170000Z&quot;,</span>
<a href="#l44.767"></a><span id="l44.767" class="difflineplus">+        &quot;RELATED-TO;RELTYPE=PARENT:MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;,</span>
<a href="#l44.768"></a><span id="l44.768" class="difflineplus">+        &quot;ATTACH;FILENAME=\&quot;link description\&quot;;X-GOOGLE-TYPE=email:mailto:something@example.com&quot;,</span>
<a href="#l44.769"></a><span id="l44.769" class="difflineplus">+        &quot;END:VTODO&quot;</span>
<a href="#l44.770"></a><span id="l44.770" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.771"></a><span id="l44.771" class="difflineplus">+</span>
<a href="#l44.772"></a><span id="l44.772" class="difflineplus">+    // Add an event</span>
<a href="#l44.773"></a><span id="l44.773" class="difflineplus">+    let addedEvent = yield pclient.adoptItem(event);</span>
<a href="#l44.774"></a><span id="l44.774" class="difflineplus">+    do_check_neq(addedEvent.id, null);</span>
<a href="#l44.775"></a><span id="l44.775" class="difflineplus">+    do_check_eq(addedEvent.organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l44.776"></a><span id="l44.776" class="difflineplus">+</span>
<a href="#l44.777"></a><span id="l44.777" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.778"></a><span id="l44.778" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.779"></a><span id="l44.779" class="difflineplus">+    do_check_eq(items[0].id, addedEvent.id);</span>
<a href="#l44.780"></a><span id="l44.780" class="difflineplus">+    do_check_eq(items[0].organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l44.781"></a><span id="l44.781" class="difflineplus">+</span>
<a href="#l44.782"></a><span id="l44.782" class="difflineplus">+    do_check_eq(gServer.events.length, 1)</span>
<a href="#l44.783"></a><span id="l44.783" class="difflineplus">+    do_check_eq(gServer.tasks.length, 0);</span>
<a href="#l44.784"></a><span id="l44.784" class="difflineplus">+</span>
<a href="#l44.785"></a><span id="l44.785" class="difflineplus">+    // Add a task</span>
<a href="#l44.786"></a><span id="l44.786" class="difflineplus">+    let addedTask = yield pclient.adoptItem(task);</span>
<a href="#l44.787"></a><span id="l44.787" class="difflineplus">+    do_check_neq(addedTask.id, null);</span>
<a href="#l44.788"></a><span id="l44.788" class="difflineplus">+</span>
<a href="#l44.789"></a><span id="l44.789" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.790"></a><span id="l44.790" class="difflineplus">+    do_check_eq(items.length, 2);</span>
<a href="#l44.791"></a><span id="l44.791" class="difflineplus">+    do_check_eq(items[1].id, addedTask.id);</span>
<a href="#l44.792"></a><span id="l44.792" class="difflineplus">+</span>
<a href="#l44.793"></a><span id="l44.793" class="difflineplus">+    do_check_eq(gServer.events.length, 1)</span>
<a href="#l44.794"></a><span id="l44.794" class="difflineplus">+    do_check_eq(gServer.tasks.length, 1);</span>
<a href="#l44.795"></a><span id="l44.795" class="difflineplus">+</span>
<a href="#l44.796"></a><span id="l44.796" class="difflineplus">+    // Modify an event</span>
<a href="#l44.797"></a><span id="l44.797" class="difflineplus">+    let newEvent = items[0].clone();</span>
<a href="#l44.798"></a><span id="l44.798" class="difflineplus">+    newEvent.title = &quot;changed&quot;;</span>
<a href="#l44.799"></a><span id="l44.799" class="difflineplus">+</span>
<a href="#l44.800"></a><span id="l44.800" class="difflineplus">+    let modifiedEvent = yield pclient.modifyItem(newEvent, items[0]);</span>
<a href="#l44.801"></a><span id="l44.801" class="difflineplus">+    do_check_eq(modifiedEvent.title, &quot;changed&quot;);</span>
<a href="#l44.802"></a><span id="l44.802" class="difflineplus">+    do_check_neq(modifiedEvent.getProperty(&quot;LAST-MODIFIED&quot;), addedEvent.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l44.803"></a><span id="l44.803" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.804"></a><span id="l44.804" class="difflineplus">+    do_check_eq(items.length, 2);</span>
<a href="#l44.805"></a><span id="l44.805" class="difflineplus">+    do_check_eq(items[0].title, &quot;changed&quot;);</span>
<a href="#l44.806"></a><span id="l44.806" class="difflineplus">+    do_check_eq(items[0].id, addedEvent.id);</span>
<a href="#l44.807"></a><span id="l44.807" class="difflineplus">+    do_check_eq(items[0].getProperty(&quot;LAST-MODIFIED&quot;), modifiedEvent.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l44.808"></a><span id="l44.808" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.809"></a><span id="l44.809" class="difflineplus">+    do_check_eq(gServer.tasks.length, 1);</span>
<a href="#l44.810"></a><span id="l44.810" class="difflineplus">+</span>
<a href="#l44.811"></a><span id="l44.811" class="difflineplus">+    // Modify a task</span>
<a href="#l44.812"></a><span id="l44.812" class="difflineplus">+    let newTask = items[1].clone();</span>
<a href="#l44.813"></a><span id="l44.813" class="difflineplus">+    newTask.title = &quot;changed&quot;;</span>
<a href="#l44.814"></a><span id="l44.814" class="difflineplus">+</span>
<a href="#l44.815"></a><span id="l44.815" class="difflineplus">+    let modifiedTask = yield pclient.modifyItem(newTask, items[1]);</span>
<a href="#l44.816"></a><span id="l44.816" class="difflineplus">+    do_check_eq(modifiedTask.title, &quot;changed&quot;);</span>
<a href="#l44.817"></a><span id="l44.817" class="difflineplus">+    do_check_neq(modifiedTask.getProperty(&quot;LAST-MODIFIED&quot;), addedTask.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l44.818"></a><span id="l44.818" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.819"></a><span id="l44.819" class="difflineplus">+    do_check_eq(items.length, 2);</span>
<a href="#l44.820"></a><span id="l44.820" class="difflineplus">+    do_check_eq(items[1].title, &quot;changed&quot;);</span>
<a href="#l44.821"></a><span id="l44.821" class="difflineplus">+    do_check_eq(items[1].id, addedTask.id);</span>
<a href="#l44.822"></a><span id="l44.822" class="difflineplus">+    do_check_eq(items[1].getProperty(&quot;LAST-MODIFIED&quot;), modifiedTask.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l44.823"></a><span id="l44.823" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.824"></a><span id="l44.824" class="difflineplus">+    do_check_eq(gServer.tasks.length, 1);</span>
<a href="#l44.825"></a><span id="l44.825" class="difflineplus">+</span>
<a href="#l44.826"></a><span id="l44.826" class="difflineplus">+    // Delete an event</span>
<a href="#l44.827"></a><span id="l44.827" class="difflineplus">+    yield pclient.deleteItem(modifiedEvent);</span>
<a href="#l44.828"></a><span id="l44.828" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.829"></a><span id="l44.829" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.830"></a><span id="l44.830" class="difflineplus">+    do_check_eq(gServer.events.length, 0);</span>
<a href="#l44.831"></a><span id="l44.831" class="difflineplus">+    do_check_eq(gServer.tasks.length, 1);</span>
<a href="#l44.832"></a><span id="l44.832" class="difflineplus">+</span>
<a href="#l44.833"></a><span id="l44.833" class="difflineplus">+    // Delete a task</span>
<a href="#l44.834"></a><span id="l44.834" class="difflineplus">+    yield pclient.deleteItem(modifiedTask);</span>
<a href="#l44.835"></a><span id="l44.835" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.836"></a><span id="l44.836" class="difflineplus">+    do_check_eq(items.length, 0);</span>
<a href="#l44.837"></a><span id="l44.837" class="difflineplus">+    do_check_eq(gServer.events.length, 0);</span>
<a href="#l44.838"></a><span id="l44.838" class="difflineplus">+    do_check_eq(gServer.tasks.length, 0);</span>
<a href="#l44.839"></a><span id="l44.839" class="difflineplus">+</span>
<a href="#l44.840"></a><span id="l44.840" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.841"></a><span id="l44.841" class="difflineplus">+});</span>
<a href="#l44.842"></a><span id="l44.842" class="difflineplus">+</span>
<a href="#l44.843"></a><span id="l44.843" class="difflineplus">+add_task(function* test_recurring_event() {</span>
<a href="#l44.844"></a><span id="l44.844" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.845"></a><span id="l44.845" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.846"></a><span id="l44.846" class="difflineplus">+</span>
<a href="#l44.847"></a><span id="l44.847" class="difflineplus">+    let event = cal.createEvent([</span>
<a href="#l44.848"></a><span id="l44.848" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l44.849"></a><span id="l44.849" class="difflineplus">+        &quot;SUMMARY:Recurring Event&quot;,</span>
<a href="#l44.850"></a><span id="l44.850" class="difflineplus">+        &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l44.851"></a><span id="l44.851" class="difflineplus">+        &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l44.852"></a><span id="l44.852" class="difflineplus">+        &quot;RRULE:FREQ=WEEKLY&quot;,</span>
<a href="#l44.853"></a><span id="l44.853" class="difflineplus">+        &quot;END:VEVENT&quot;</span>
<a href="#l44.854"></a><span id="l44.854" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.855"></a><span id="l44.855" class="difflineplus">+</span>
<a href="#l44.856"></a><span id="l44.856" class="difflineplus">+    event = yield pclient.addItem(event);</span>
<a href="#l44.857"></a><span id="l44.857" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.858"></a><span id="l44.858" class="difflineplus">+    do_check_eq(gServer.events[0].recurrence.length, 1);</span>
<a href="#l44.859"></a><span id="l44.859" class="difflineplus">+    do_check_eq(gServer.events[0].recurrence[0], &quot;RRULE:FREQ=WEEKLY&quot;);</span>
<a href="#l44.860"></a><span id="l44.860" class="difflineplus">+</span>
<a href="#l44.861"></a><span id="l44.861" class="difflineplus">+    let occ = event.recurrenceInfo.getNextOccurrence(event.startDate);</span>
<a href="#l44.862"></a><span id="l44.862" class="difflineplus">+    let changedOcc = occ.clone();</span>
<a href="#l44.863"></a><span id="l44.863" class="difflineplus">+    changedOcc.title = &quot;changed&quot;;</span>
<a href="#l44.864"></a><span id="l44.864" class="difflineplus">+    event.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l44.865"></a><span id="l44.865" class="difflineplus">+</span>
<a href="#l44.866"></a><span id="l44.866" class="difflineplus">+    event = yield pclient.modifyItem(changedOcc, occ);</span>
<a href="#l44.867"></a><span id="l44.867" class="difflineplus">+    occ = event.recurrenceInfo.getNextOccurrence(event.startDate);</span>
<a href="#l44.868"></a><span id="l44.868" class="difflineplus">+    do_check_eq(occ.title, &quot;changed&quot;);</span>
<a href="#l44.869"></a><span id="l44.869" class="difflineplus">+    do_check_eq(gServer.events.length, 2);</span>
<a href="#l44.870"></a><span id="l44.870" class="difflineplus">+</span>
<a href="#l44.871"></a><span id="l44.871" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.872"></a><span id="l44.872" class="difflineplus">+});</span>
<a href="#l44.873"></a><span id="l44.873" class="difflineplus">+</span>
<a href="#l44.874"></a><span id="l44.874" class="difflineplus">+add_task(function* test_import_invitation() {</span>
<a href="#l44.875"></a><span id="l44.875" class="difflineplus">+    Preferences.set(&quot;calendar.google.enableAttendees&quot;, true);</span>
<a href="#l44.876"></a><span id="l44.876" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.877"></a><span id="l44.877" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.878"></a><span id="l44.878" class="difflineplus">+    let event = cal.createEvent([</span>
<a href="#l44.879"></a><span id="l44.879" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l44.880"></a><span id="l44.880" class="difflineplus">+        &quot;UID:xpcshell-import&quot;,</span>
<a href="#l44.881"></a><span id="l44.881" class="difflineplus">+        &quot;CREATED:20060608T210452Z&quot;,</span>
<a href="#l44.882"></a><span id="l44.882" class="difflineplus">+        &quot;LAST-MODIFIED:20060608T210549Z&quot;,</span>
<a href="#l44.883"></a><span id="l44.883" class="difflineplus">+        &quot;DTSTAMP:20060608T210549Z&quot;,</span>
<a href="#l44.884"></a><span id="l44.884" class="difflineplus">+        &quot;SUMMARY:New Event&quot;,</span>
<a href="#l44.885"></a><span id="l44.885" class="difflineplus">+        &quot;STATUS:CONFIRMED&quot;,</span>
<a href="#l44.886"></a><span id="l44.886" class="difflineplus">+        &quot;ORGANIZER;CN=Omlettte B. Clam:mailto:ombclam@example.com&quot;,</span>
<a href="#l44.887"></a><span id="l44.887" class="difflineplus">+        &quot;ATTENDEE;CN=Omlettte B. Clam;PARTSTAT=ACCEPTED;CUTYPE=INDIVIDUAL;&quot;,</span>
<a href="#l44.888"></a><span id="l44.888" class="difflineplus">+        &quot; ROLE=REQ-PARTICIPANT:mailto:ombclam@example.com&quot;,</span>
<a href="#l44.889"></a><span id="l44.889" class="difflineplus">+        &quot;ATTENDEE;CN=Eggs P. Seashell;PARTSTAT=TENTATIVE;CUTYPE=INDIVIDUAL;&quot;,</span>
<a href="#l44.890"></a><span id="l44.890" class="difflineplus">+        &quot; ROLE=REQ-PARTICIPANT:mailto:xpcshell@example.com&quot;,</span>
<a href="#l44.891"></a><span id="l44.891" class="difflineplus">+        &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l44.892"></a><span id="l44.892" class="difflineplus">+        &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l44.893"></a><span id="l44.893" class="difflineplus">+        &quot;SEQUENCE:1&quot;,</span>
<a href="#l44.894"></a><span id="l44.894" class="difflineplus">+        &quot;END:VEVENT&quot;</span>
<a href="#l44.895"></a><span id="l44.895" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.896"></a><span id="l44.896" class="difflineplus">+</span>
<a href="#l44.897"></a><span id="l44.897" class="difflineplus">+    let addedItem = yield pclient.adoptItem(event);</span>
<a href="#l44.898"></a><span id="l44.898" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.899"></a><span id="l44.899" class="difflineplus">+    do_check_eq(addedItem.icalString, event.icalString);</span>
<a href="#l44.900"></a><span id="l44.900" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.901"></a><span id="l44.901" class="difflineplus">+    Preferences.set(&quot;calendar.google.enableAttendees&quot;, false);</span>
<a href="#l44.902"></a><span id="l44.902" class="difflineplus">+});</span>
<a href="#l44.903"></a><span id="l44.903" class="difflineplus">+</span>
<a href="#l44.904"></a><span id="l44.904" class="difflineplus">+add_task(function* test_metadata() {</span>
<a href="#l44.905"></a><span id="l44.905" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.906"></a><span id="l44.906" class="difflineplus">+        &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.907"></a><span id="l44.907" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.908"></a><span id="l44.908" class="difflineplus">+        &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.909"></a><span id="l44.909" class="difflineplus">+        &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.910"></a><span id="l44.910" class="difflineplus">+        &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.911"></a><span id="l44.911" class="difflineplus">+        &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.912"></a><span id="l44.912" class="difflineplus">+        &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.913"></a><span id="l44.913" class="difflineplus">+        &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.914"></a><span id="l44.914" class="difflineplus">+        &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.915"></a><span id="l44.915" class="difflineplus">+        &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.916"></a><span id="l44.916" class="difflineplus">+        &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.917"></a><span id="l44.917" class="difflineplus">+    }];</span>
<a href="#l44.918"></a><span id="l44.918" class="difflineplus">+    gServer.tasks = [{</span>
<a href="#l44.919"></a><span id="l44.919" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.920"></a><span id="l44.920" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.921"></a><span id="l44.921" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.922"></a><span id="l44.922" class="difflineplus">+        &quot;title&quot;: &quot;New Task&quot;,</span>
<a href="#l44.923"></a><span id="l44.923" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.924"></a><span id="l44.924" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.925"></a><span id="l44.925" class="difflineplus">+        &quot;notes&quot;: &quot;description&quot;</span>
<a href="#l44.926"></a><span id="l44.926" class="difflineplus">+    }];</span>
<a href="#l44.927"></a><span id="l44.927" class="difflineplus">+</span>
<a href="#l44.928"></a><span id="l44.928" class="difflineplus">+    let idToEtag = {</span>
<a href="#l44.929"></a><span id="l44.929" class="difflineplus">+        &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;: '&quot;1&quot;',</span>
<a href="#l44.930"></a><span id="l44.930" class="difflineplus">+        &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;: '&quot;2&quot;'</span>
<a href="#l44.931"></a><span id="l44.931" class="difflineplus">+    }</span>
<a href="#l44.932"></a><span id="l44.932" class="difflineplus">+</span>
<a href="#l44.933"></a><span id="l44.933" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.934"></a><span id="l44.934" class="difflineplus">+    let offline = client.wrappedJSObject.mCachedCalendar;</span>
<a href="#l44.935"></a><span id="l44.935" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.936"></a><span id="l44.936" class="difflineplus">+</span>
<a href="#l44.937"></a><span id="l44.937" class="difflineplus">+    // Check initial metadata</span>
<a href="#l44.938"></a><span id="l44.938" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.939"></a><span id="l44.939" class="difflineplus">+    let meta = getAllMeta(offline);</span>
<a href="#l44.940"></a><span id="l44.940" class="difflineplus">+    let [event, task] = items;</span>
<a href="#l44.941"></a><span id="l44.941" class="difflineplus">+    do_check_true(cal.isEvent(event));</span>
<a href="#l44.942"></a><span id="l44.942" class="difflineplus">+    do_check_true(cal.isToDo(task));</span>
<a href="#l44.943"></a><span id="l44.943" class="difflineplus">+    do_check_eq(meta.size, 2);</span>
<a href="#l44.944"></a><span id="l44.944" class="difflineplus">+    do_check_eq(meta.get(event.hashId), ['&quot;1&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.945"></a><span id="l44.945" class="difflineplus">+    do_check_eq(meta.get(task.hashId), ['&quot;2&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.946"></a><span id="l44.946" class="difflineplus">+</span>
<a href="#l44.947"></a><span id="l44.947" class="difflineplus">+    // Modify an event</span>
<a href="#l44.948"></a><span id="l44.948" class="difflineplus">+    gServer.nextEtag = '&quot;3&quot;';</span>
<a href="#l44.949"></a><span id="l44.949" class="difflineplus">+    let newEvent = event.clone();</span>
<a href="#l44.950"></a><span id="l44.950" class="difflineplus">+    newEvent.title = &quot;changed&quot;;</span>
<a href="#l44.951"></a><span id="l44.951" class="difflineplus">+    yield pclient.modifyItem(newEvent, event);</span>
<a href="#l44.952"></a><span id="l44.952" class="difflineplus">+</span>
<a href="#l44.953"></a><span id="l44.953" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.954"></a><span id="l44.954" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.955"></a><span id="l44.955" class="difflineplus">+    [event, task] = items;</span>
<a href="#l44.956"></a><span id="l44.956" class="difflineplus">+    do_check_true(cal.isEvent(event));</span>
<a href="#l44.957"></a><span id="l44.957" class="difflineplus">+    do_check_true(cal.isToDo(task));</span>
<a href="#l44.958"></a><span id="l44.958" class="difflineplus">+    do_check_eq(meta.size, 2);</span>
<a href="#l44.959"></a><span id="l44.959" class="difflineplus">+    do_check_eq(meta.get(event.hashId), ['&quot;3&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.960"></a><span id="l44.960" class="difflineplus">+    do_check_eq(meta.get(task.hashId), ['&quot;2&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.961"></a><span id="l44.961" class="difflineplus">+</span>
<a href="#l44.962"></a><span id="l44.962" class="difflineplus">+    // Modify a task</span>
<a href="#l44.963"></a><span id="l44.963" class="difflineplus">+    gServer.nextEtag = '&quot;4&quot;';</span>
<a href="#l44.964"></a><span id="l44.964" class="difflineplus">+    let newTask = task.clone();</span>
<a href="#l44.965"></a><span id="l44.965" class="difflineplus">+    newTask.title = &quot;changed&quot;;</span>
<a href="#l44.966"></a><span id="l44.966" class="difflineplus">+    yield pclient.modifyItem(newTask, task);</span>
<a href="#l44.967"></a><span id="l44.967" class="difflineplus">+</span>
<a href="#l44.968"></a><span id="l44.968" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.969"></a><span id="l44.969" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.970"></a><span id="l44.970" class="difflineplus">+    [event, task] = items;</span>
<a href="#l44.971"></a><span id="l44.971" class="difflineplus">+    do_check_eq(meta.size, 2);</span>
<a href="#l44.972"></a><span id="l44.972" class="difflineplus">+    do_check_eq(meta.get(event.hashId), ['&quot;3&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.973"></a><span id="l44.973" class="difflineplus">+    do_check_eq(meta.get(task.hashId), ['&quot;4&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.974"></a><span id="l44.974" class="difflineplus">+</span>
<a href="#l44.975"></a><span id="l44.975" class="difflineplus">+    // Delete an event</span>
<a href="#l44.976"></a><span id="l44.976" class="difflineplus">+    yield pclient.deleteItem(event);</span>
<a href="#l44.977"></a><span id="l44.977" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.978"></a><span id="l44.978" class="difflineplus">+    do_check_eq(meta.size, 1);</span>
<a href="#l44.979"></a><span id="l44.979" class="difflineplus">+    do_check_eq(meta.get(task.hashId), ['&quot;4&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.980"></a><span id="l44.980" class="difflineplus">+</span>
<a href="#l44.981"></a><span id="l44.981" class="difflineplus">+    // Delete a task</span>
<a href="#l44.982"></a><span id="l44.982" class="difflineplus">+    yield pclient.deleteItem(task);</span>
<a href="#l44.983"></a><span id="l44.983" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.984"></a><span id="l44.984" class="difflineplus">+    do_check_eq(meta.size, 0);</span>
<a href="#l44.985"></a><span id="l44.985" class="difflineplus">+</span>
<a href="#l44.986"></a><span id="l44.986" class="difflineplus">+    // Add an event</span>
<a href="#l44.987"></a><span id="l44.987" class="difflineplus">+    gServer.nextEtag = '&quot;6&quot;';</span>
<a href="#l44.988"></a><span id="l44.988" class="difflineplus">+    newEvent = yield pclient.addItem(event);</span>
<a href="#l44.989"></a><span id="l44.989" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.990"></a><span id="l44.990" class="difflineplus">+    do_check_eq(meta.size, 1);</span>
<a href="#l44.991"></a><span id="l44.991" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.992"></a><span id="l44.992" class="difflineplus">+    do_check_eq(meta.get(newEvent.hashId), ['&quot;6&quot;', gServer.events[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.993"></a><span id="l44.993" class="difflineplus">+</span>
<a href="#l44.994"></a><span id="l44.994" class="difflineplus">+    // Add a task</span>
<a href="#l44.995"></a><span id="l44.995" class="difflineplus">+    gServer.nextEtag = '&quot;7&quot;';</span>
<a href="#l44.996"></a><span id="l44.996" class="difflineplus">+    newTask = yield pclient.addItem(task);</span>
<a href="#l44.997"></a><span id="l44.997" class="difflineplus">+    meta = getAllMeta(offline);</span>
<a href="#l44.998"></a><span id="l44.998" class="difflineplus">+    do_check_eq(meta.size, 2);</span>
<a href="#l44.999"></a><span id="l44.999" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.1000"></a><span id="l44.1000" class="difflineplus">+    do_check_eq(gServer.tasks.length, 1);</span>
<a href="#l44.1001"></a><span id="l44.1001" class="difflineplus">+    do_check_eq(meta.get(newEvent.hashId), ['&quot;6&quot;', gServer.events[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.1002"></a><span id="l44.1002" class="difflineplus">+    do_check_eq(meta.get(newTask.hashId), ['&quot;7&quot;', gServer.tasks[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.1003"></a><span id="l44.1003" class="difflineplus">+</span>
<a href="#l44.1004"></a><span id="l44.1004" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1005"></a><span id="l44.1005" class="difflineplus">+});</span>
<a href="#l44.1006"></a><span id="l44.1006" class="difflineplus">+</span>
<a href="#l44.1007"></a><span id="l44.1007" class="difflineplus">+add_task(function* test_metadata_recurring() {</span>
<a href="#l44.1008"></a><span id="l44.1008" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.1009"></a><span id="l44.1009" class="difflineplus">+        &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1010"></a><span id="l44.1010" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.1011"></a><span id="l44.1011" class="difflineplus">+        &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1012"></a><span id="l44.1012" class="difflineplus">+        &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1013"></a><span id="l44.1013" class="difflineplus">+        &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1014"></a><span id="l44.1014" class="difflineplus">+        &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.1015"></a><span id="l44.1015" class="difflineplus">+        &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1016"></a><span id="l44.1016" class="difflineplus">+        &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1017"></a><span id="l44.1017" class="difflineplus">+        &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1018"></a><span id="l44.1018" class="difflineplus">+        &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1019"></a><span id="l44.1019" class="difflineplus">+        &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l44.1020"></a><span id="l44.1020" class="difflineplus">+        &quot;recurrence&quot;: [</span>
<a href="#l44.1021"></a><span id="l44.1021" class="difflineplus">+            &quot;RRULE:FREQ=WEEKLY&quot;</span>
<a href="#l44.1022"></a><span id="l44.1022" class="difflineplus">+        ]</span>
<a href="#l44.1023"></a><span id="l44.1023" class="difflineplus">+    },{</span>
<a href="#l44.1024"></a><span id="l44.1024" class="difflineplus">+        &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1025"></a><span id="l44.1025" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.1026"></a><span id="l44.1026" class="difflineplus">+        &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;,</span>
<a href="#l44.1027"></a><span id="l44.1027" class="difflineplus">+        &quot;summary&quot;: &quot;New Event changed&quot;,</span>
<a href="#l44.1028"></a><span id="l44.1028" class="difflineplus">+        &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1029"></a><span id="l44.1029" class="difflineplus">+        &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1030"></a><span id="l44.1030" class="difflineplus">+        &quot;recurringEventId&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1031"></a><span id="l44.1031" class="difflineplus">+        &quot;originalStartTime&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; }</span>
<a href="#l44.1032"></a><span id="l44.1032" class="difflineplus">+    },{</span>
<a href="#l44.1033"></a><span id="l44.1033" class="difflineplus">+        &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1034"></a><span id="l44.1034" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;3\&quot;&quot;,</span>
<a href="#l44.1035"></a><span id="l44.1035" class="difflineplus">+        &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;,</span>
<a href="#l44.1036"></a><span id="l44.1036" class="difflineplus">+        &quot;summary&quot;: &quot;New Event next week&quot;,</span>
<a href="#l44.1037"></a><span id="l44.1037" class="difflineplus">+        &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l44.1038"></a><span id="l44.1038" class="difflineplus">+        &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-17T20:00:00+02:00&quot; },</span>
<a href="#l44.1039"></a><span id="l44.1039" class="difflineplus">+        &quot;recurringEventId&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1040"></a><span id="l44.1040" class="difflineplus">+        &quot;originalStartTime&quot;: { &quot;dateTime&quot;: &quot;2006-06-17T18:00:00+02:00&quot; }</span>
<a href="#l44.1041"></a><span id="l44.1041" class="difflineplus">+    }];</span>
<a href="#l44.1042"></a><span id="l44.1042" class="difflineplus">+</span>
<a href="#l44.1043"></a><span id="l44.1043" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1044"></a><span id="l44.1044" class="difflineplus">+    let offline = client.wrappedJSObject.mCachedCalendar;</span>
<a href="#l44.1045"></a><span id="l44.1045" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.1046"></a><span id="l44.1046" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.1047"></a><span id="l44.1047" class="difflineplus">+</span>
<a href="#l44.1048"></a><span id="l44.1048" class="difflineplus">+    let meta = getAllMeta(offline);</span>
<a href="#l44.1049"></a><span id="l44.1049" class="difflineplus">+    do_check_eq(meta.size, 3);</span>
<a href="#l44.1050"></a><span id="l44.1050" class="difflineplus">+    do_check_eq(meta.get(items[0].hashId), ['&quot;1&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.1051"></a><span id="l44.1051" class="difflineplus">+</span>
<a href="#l44.1052"></a><span id="l44.1052" class="difflineplus">+    // The exception metadata should also exist</span>
<a href="#l44.1053"></a><span id="l44.1053" class="difflineplus">+    let exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l44.1054"></a><span id="l44.1054" class="difflineplus">+    do_check_eq(exIds.length, 2);</span>
<a href="#l44.1055"></a><span id="l44.1055" class="difflineplus">+    let ex = items[0].recurrenceInfo.getExceptionFor(exIds[0]);</span>
<a href="#l44.1056"></a><span id="l44.1056" class="difflineplus">+    do_check_eq(meta.get(ex.hashId), ['&quot;2&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.1057"></a><span id="l44.1057" class="difflineplus">+</span>
<a href="#l44.1058"></a><span id="l44.1058" class="difflineplus">+    // Changing an exception should retain the metadata entries</span>
<a href="#l44.1059"></a><span id="l44.1059" class="difflineplus">+    let newEx = ex.clone();</span>
<a href="#l44.1060"></a><span id="l44.1060" class="difflineplus">+    newEx.title = &quot;New Event changed again&quot;;</span>
<a href="#l44.1061"></a><span id="l44.1061" class="difflineplus">+    gServer.nextEtag = '&quot;4&quot;';</span>
<a href="#l44.1062"></a><span id="l44.1062" class="difflineplus">+    yield pclient.modifyItem(newEx, ex);</span>
<a href="#l44.1063"></a><span id="l44.1063" class="difflineplus">+    let meta = getAllMeta(offline);</span>
<a href="#l44.1064"></a><span id="l44.1064" class="difflineplus">+    do_check_eq(meta.size, 3);</span>
<a href="#l44.1065"></a><span id="l44.1065" class="difflineplus">+    do_check_eq(meta.get(newEx.hashId), ['&quot;4&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l44.1066"></a><span id="l44.1066" class="difflineplus">+</span>
<a href="#l44.1067"></a><span id="l44.1067" class="difflineplus">+    // Deleting an exception should delete the metadata, as it turns into an EXDATE</span>
<a href="#l44.1068"></a><span id="l44.1068" class="difflineplus">+    let newItem = items[0].clone();</span>
<a href="#l44.1069"></a><span id="l44.1069" class="difflineplus">+    newItem.recurrenceInfo.removeOccurrenceAt(exIds[0]);</span>
<a href="#l44.1070"></a><span id="l44.1070" class="difflineplus">+    yield pclient.modifyItem(newItem, items[0]);</span>
<a href="#l44.1071"></a><span id="l44.1071" class="difflineplus">+</span>
<a href="#l44.1072"></a><span id="l44.1072" class="difflineplus">+    let meta = getAllMeta(offline);</span>
<a href="#l44.1073"></a><span id="l44.1073" class="difflineplus">+    do_check_eq(meta.size, 2);</span>
<a href="#l44.1074"></a><span id="l44.1074" class="difflineplus">+</span>
<a href="#l44.1075"></a><span id="l44.1075" class="difflineplus">+    // Deleting the master item should remove all metadata entries</span>
<a href="#l44.1076"></a><span id="l44.1076" class="difflineplus">+    yield pclient.deleteItem(items[0]);</span>
<a href="#l44.1077"></a><span id="l44.1077" class="difflineplus">+    let meta = getAllMeta(offline);</span>
<a href="#l44.1078"></a><span id="l44.1078" class="difflineplus">+    do_check_eq(meta.size, 0);</span>
<a href="#l44.1079"></a><span id="l44.1079" class="difflineplus">+</span>
<a href="#l44.1080"></a><span id="l44.1080" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1081"></a><span id="l44.1081" class="difflineplus">+});</span>
<a href="#l44.1082"></a><span id="l44.1082" class="difflineplus">+</span>
<a href="#l44.1083"></a><span id="l44.1083" class="difflineplus">+add_task(function* test_conflict_modify() {</span>
<a href="#l44.1084"></a><span id="l44.1084" class="difflineplus">+    // TODO task/event conflicts are handled in the same way so I'm going to</span>
<a href="#l44.1085"></a><span id="l44.1085" class="difflineplus">+    // skip adding tests for tasks here, but it probably wouldn't hurt to</span>
<a href="#l44.1086"></a><span id="l44.1086" class="difflineplus">+    // create them at some point.</span>
<a href="#l44.1087"></a><span id="l44.1087" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.1088"></a><span id="l44.1088" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1089"></a><span id="l44.1089" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.1090"></a><span id="l44.1090" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1091"></a><span id="l44.1091" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1092"></a><span id="l44.1092" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1093"></a><span id="l44.1093" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.1094"></a><span id="l44.1094" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1095"></a><span id="l44.1095" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1096"></a><span id="l44.1096" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1097"></a><span id="l44.1097" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1098"></a><span id="l44.1098" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.1099"></a><span id="l44.1099" class="difflineplus">+    }];</span>
<a href="#l44.1100"></a><span id="l44.1100" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1101"></a><span id="l44.1101" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.1102"></a><span id="l44.1102" class="difflineplus">+    let item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1103"></a><span id="l44.1103" class="difflineplus">+</span>
<a href="#l44.1104"></a><span id="l44.1104" class="difflineplus">+    // Case #1: Modified on server, modify locally, overwrite conflict</span>
<a href="#l44.1105"></a><span id="l44.1105" class="difflineplus">+    MockConflictPrompt.overwrite = true;</span>
<a href="#l44.1106"></a><span id="l44.1106" class="difflineplus">+    let newItem = item.clone();</span>
<a href="#l44.1107"></a><span id="l44.1107" class="difflineplus">+    newItem.title = &quot;local change&quot;;</span>
<a href="#l44.1108"></a><span id="l44.1108" class="difflineplus">+    gServer.events[0].etag = '&quot;2&quot;';</span>
<a href="#l44.1109"></a><span id="l44.1109" class="difflineplus">+    gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l44.1110"></a><span id="l44.1110" class="difflineplus">+    let modifiedItem = yield pclient.modifyItem(newItem, item);</span>
<a href="#l44.1111"></a><span id="l44.1111" class="difflineplus">+    item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1112"></a><span id="l44.1112" class="difflineplus">+    do_check_eq(gServer.events[0].summary, &quot;local change&quot;);</span>
<a href="#l44.1113"></a><span id="l44.1113" class="difflineplus">+    do_check_neq(gServer.events[0].etag, '&quot;2&quot;')</span>
<a href="#l44.1114"></a><span id="l44.1114" class="difflineplus">+    do_check_eq(item.title, &quot;local change&quot;);</span>
<a href="#l44.1115"></a><span id="l44.1115" class="difflineplus">+    do_check_eq(modifiedItem.title, &quot;local change&quot;);</span>
<a href="#l44.1116"></a><span id="l44.1116" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.1117"></a><span id="l44.1117" class="difflineplus">+</span>
<a href="#l44.1118"></a><span id="l44.1118" class="difflineplus">+    // Case #2: Modified on server, modify locally, don't overwrite conflict</span>
<a href="#l44.1119"></a><span id="l44.1119" class="difflineplus">+    MockConflictPrompt.overwrite = false;</span>
<a href="#l44.1120"></a><span id="l44.1120" class="difflineplus">+    gServer.events[0].etag = '&quot;3&quot;';</span>
<a href="#l44.1121"></a><span id="l44.1121" class="difflineplus">+    gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l44.1122"></a><span id="l44.1122" class="difflineplus">+    try {</span>
<a href="#l44.1123"></a><span id="l44.1123" class="difflineplus">+        modifiedItem = yield pclient.modifyItem(newItem, item);</span>
<a href="#l44.1124"></a><span id="l44.1124" class="difflineplus">+        do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l44.1125"></a><span id="l44.1125" class="difflineplus">+    } catch (e if e == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l44.1126"></a><span id="l44.1126" class="difflineplus">+        // Swallow cancelling the request</span>
<a href="#l44.1127"></a><span id="l44.1127" class="difflineplus">+    }</span>
<a href="#l44.1128"></a><span id="l44.1128" class="difflineplus">+</span>
<a href="#l44.1129"></a><span id="l44.1129" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1130"></a><span id="l44.1130" class="difflineplus">+</span>
<a href="#l44.1131"></a><span id="l44.1131" class="difflineplus">+    item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1132"></a><span id="l44.1132" class="difflineplus">+    do_check_eq(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l44.1133"></a><span id="l44.1133" class="difflineplus">+    do_check_eq(gServer.events[0].etag, '&quot;3&quot;')</span>
<a href="#l44.1134"></a><span id="l44.1134" class="difflineplus">+    do_check_eq(item.title, &quot;remote change&quot;);</span>
<a href="#l44.1135"></a><span id="l44.1135" class="difflineplus">+</span>
<a href="#l44.1136"></a><span id="l44.1136" class="difflineplus">+    // Case #3: Modified on server, delete locally, don't overwrite conflict</span>
<a href="#l44.1137"></a><span id="l44.1137" class="difflineplus">+    MockConflictPrompt.overwrite = false;</span>
<a href="#l44.1138"></a><span id="l44.1138" class="difflineplus">+    gServer.events[0].etag = '&quot;4&quot;';</span>
<a href="#l44.1139"></a><span id="l44.1139" class="difflineplus">+    gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l44.1140"></a><span id="l44.1140" class="difflineplus">+    try {</span>
<a href="#l44.1141"></a><span id="l44.1141" class="difflineplus">+        yield pclient.deleteItem(item);</span>
<a href="#l44.1142"></a><span id="l44.1142" class="difflineplus">+        do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l44.1143"></a><span id="l44.1143" class="difflineplus">+    } catch (e if e == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l44.1144"></a><span id="l44.1144" class="difflineplus">+        // Swallow cancelling the request</span>
<a href="#l44.1145"></a><span id="l44.1145" class="difflineplus">+    }</span>
<a href="#l44.1146"></a><span id="l44.1146" class="difflineplus">+</span>
<a href="#l44.1147"></a><span id="l44.1147" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1148"></a><span id="l44.1148" class="difflineplus">+</span>
<a href="#l44.1149"></a><span id="l44.1149" class="difflineplus">+    item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1150"></a><span id="l44.1150" class="difflineplus">+    do_check_eq(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l44.1151"></a><span id="l44.1151" class="difflineplus">+    do_check_eq(gServer.events[0].etag, '&quot;4&quot;')</span>
<a href="#l44.1152"></a><span id="l44.1152" class="difflineplus">+    do_check_eq(item.title, &quot;remote change&quot;);</span>
<a href="#l44.1153"></a><span id="l44.1153" class="difflineplus">+</span>
<a href="#l44.1154"></a><span id="l44.1154" class="difflineplus">+    // Case #4: Modified on server, delete locally, overwrite conflict</span>
<a href="#l44.1155"></a><span id="l44.1155" class="difflineplus">+    MockConflictPrompt.overwrite = true;</span>
<a href="#l44.1156"></a><span id="l44.1156" class="difflineplus">+    gServer.events[0].etag = '&quot;5&quot;';</span>
<a href="#l44.1157"></a><span id="l44.1157" class="difflineplus">+    gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l44.1158"></a><span id="l44.1158" class="difflineplus">+    yield pclient.deleteItem(item);</span>
<a href="#l44.1159"></a><span id="l44.1159" class="difflineplus">+    item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1160"></a><span id="l44.1160" class="difflineplus">+    do_check_eq(gServer.events.length, 0);</span>
<a href="#l44.1161"></a><span id="l44.1161" class="difflineplus">+</span>
<a href="#l44.1162"></a><span id="l44.1162" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1163"></a><span id="l44.1163" class="difflineplus">+});</span>
<a href="#l44.1164"></a><span id="l44.1164" class="difflineplus">+</span>
<a href="#l44.1165"></a><span id="l44.1165" class="difflineplus">+add_task(function* test_conflict_delete() {</span>
<a href="#l44.1166"></a><span id="l44.1166" class="difflineplus">+    // TODO task/event conflicts are handled in the same way so I'm going to</span>
<a href="#l44.1167"></a><span id="l44.1167" class="difflineplus">+    // skip adding tests for tasks here, but it probably wouldn't hurt to</span>
<a href="#l44.1168"></a><span id="l44.1168" class="difflineplus">+    // create them at some point.</span>
<a href="#l44.1169"></a><span id="l44.1169" class="difflineplus">+    let coreEvent = {</span>
<a href="#l44.1170"></a><span id="l44.1170" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1171"></a><span id="l44.1171" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.1172"></a><span id="l44.1172" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1173"></a><span id="l44.1173" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1174"></a><span id="l44.1174" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1175"></a><span id="l44.1175" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.1176"></a><span id="l44.1176" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1177"></a><span id="l44.1177" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1178"></a><span id="l44.1178" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1179"></a><span id="l44.1179" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1180"></a><span id="l44.1180" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.1181"></a><span id="l44.1181" class="difflineplus">+    };</span>
<a href="#l44.1182"></a><span id="l44.1182" class="difflineplus">+</span>
<a href="#l44.1183"></a><span id="l44.1183" class="difflineplus">+    // Load intial event to server</span>
<a href="#l44.1184"></a><span id="l44.1184" class="difflineplus">+    gServer.events = [coreEvent];</span>
<a href="#l44.1185"></a><span id="l44.1185" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1186"></a><span id="l44.1186" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.1187"></a><span id="l44.1187" class="difflineplus">+    let item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1188"></a><span id="l44.1188" class="difflineplus">+</span>
<a href="#l44.1189"></a><span id="l44.1189" class="difflineplus">+    // Case #1: Deleted on server, modify locally, overwrite conflict</span>
<a href="#l44.1190"></a><span id="l44.1190" class="difflineplus">+    MockConflictPrompt.overwrite = true;</span>
<a href="#l44.1191"></a><span id="l44.1191" class="difflineplus">+    gServer.events = [];</span>
<a href="#l44.1192"></a><span id="l44.1192" class="difflineplus">+    let newItem = item.clone();</span>
<a href="#l44.1193"></a><span id="l44.1193" class="difflineplus">+    newItem.title = &quot;local change&quot;;</span>
<a href="#l44.1194"></a><span id="l44.1194" class="difflineplus">+    let modifiedItem = yield pclient.modifyItem(newItem, item);</span>
<a href="#l44.1195"></a><span id="l44.1195" class="difflineplus">+    item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1196"></a><span id="l44.1196" class="difflineplus">+    do_check_eq(gServer.events[0].summary, &quot;local change&quot;);</span>
<a href="#l44.1197"></a><span id="l44.1197" class="difflineplus">+    do_check_neq(gServer.events[0].etag, '&quot;2&quot;')</span>
<a href="#l44.1198"></a><span id="l44.1198" class="difflineplus">+    do_check_eq(item.title, &quot;local change&quot;);</span>
<a href="#l44.1199"></a><span id="l44.1199" class="difflineplus">+    do_check_eq(modifiedItem.title, &quot;local change&quot;);</span>
<a href="#l44.1200"></a><span id="l44.1200" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.1201"></a><span id="l44.1201" class="difflineplus">+</span>
<a href="#l44.1202"></a><span id="l44.1202" class="difflineplus">+    // Case #2: Deleted on server, modify locally, don't overwrite conflict</span>
<a href="#l44.1203"></a><span id="l44.1203" class="difflineplus">+    MockConflictPrompt.overwrite = false;</span>
<a href="#l44.1204"></a><span id="l44.1204" class="difflineplus">+    gServer.events = [];</span>
<a href="#l44.1205"></a><span id="l44.1205" class="difflineplus">+    try {</span>
<a href="#l44.1206"></a><span id="l44.1206" class="difflineplus">+        modifiedItem = yield pclient.modifyItem(newItem, item);</span>
<a href="#l44.1207"></a><span id="l44.1207" class="difflineplus">+        do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l44.1208"></a><span id="l44.1208" class="difflineplus">+    } catch (e if e == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l44.1209"></a><span id="l44.1209" class="difflineplus">+        // Swallow cancelling the request</span>
<a href="#l44.1210"></a><span id="l44.1210" class="difflineplus">+    }</span>
<a href="#l44.1211"></a><span id="l44.1211" class="difflineplus">+    // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l44.1212"></a><span id="l44.1212" class="difflineplus">+    coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l44.1213"></a><span id="l44.1213" class="difflineplus">+    gServer.events = [coreEvent];</span>
<a href="#l44.1214"></a><span id="l44.1214" class="difflineplus">+</span>
<a href="#l44.1215"></a><span id="l44.1215" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1216"></a><span id="l44.1216" class="difflineplus">+</span>
<a href="#l44.1217"></a><span id="l44.1217" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.1218"></a><span id="l44.1218" class="difflineplus">+    do_check_eq(items.length, 0);</span>
<a href="#l44.1219"></a><span id="l44.1219" class="difflineplus">+    do_check_eq(gServer.events.length, 1);</span>
<a href="#l44.1220"></a><span id="l44.1220" class="difflineplus">+</span>
<a href="#l44.1221"></a><span id="l44.1221" class="difflineplus">+    // Put the event back in the calendar for the next run</span>
<a href="#l44.1222"></a><span id="l44.1222" class="difflineplus">+    delete gServer.events[0].status;</span>
<a href="#l44.1223"></a><span id="l44.1223" class="difflineplus">+    client.refresh();</span>
<a href="#l44.1224"></a><span id="l44.1224" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1225"></a><span id="l44.1225" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.1226"></a><span id="l44.1226" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.1227"></a><span id="l44.1227" class="difflineplus">+</span>
<a href="#l44.1228"></a><span id="l44.1228" class="difflineplus">+    // Case #3: Deleted on server, delete locally, don't overwrite conflict</span>
<a href="#l44.1229"></a><span id="l44.1229" class="difflineplus">+    MockConflictPrompt.overwrite = false;</span>
<a href="#l44.1230"></a><span id="l44.1230" class="difflineplus">+    gServer.events = [];</span>
<a href="#l44.1231"></a><span id="l44.1231" class="difflineplus">+    try {</span>
<a href="#l44.1232"></a><span id="l44.1232" class="difflineplus">+        yield pclient.deleteItem(item);</span>
<a href="#l44.1233"></a><span id="l44.1233" class="difflineplus">+        do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l44.1234"></a><span id="l44.1234" class="difflineplus">+    } catch (e if e == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l44.1235"></a><span id="l44.1235" class="difflineplus">+        // Swallow cancelling the request</span>
<a href="#l44.1236"></a><span id="l44.1236" class="difflineplus">+    }</span>
<a href="#l44.1237"></a><span id="l44.1237" class="difflineplus">+    // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l44.1238"></a><span id="l44.1238" class="difflineplus">+    coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l44.1239"></a><span id="l44.1239" class="difflineplus">+    gServer.events = [coreEvent];</span>
<a href="#l44.1240"></a><span id="l44.1240" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1241"></a><span id="l44.1241" class="difflineplus">+</span>
<a href="#l44.1242"></a><span id="l44.1242" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.1243"></a><span id="l44.1243" class="difflineplus">+    do_check_eq(items.length, 0);</span>
<a href="#l44.1244"></a><span id="l44.1244" class="difflineplus">+</span>
<a href="#l44.1245"></a><span id="l44.1245" class="difflineplus">+    // Put the event back in the calendar for the next run</span>
<a href="#l44.1246"></a><span id="l44.1246" class="difflineplus">+    delete gServer.events[0].status;</span>
<a href="#l44.1247"></a><span id="l44.1247" class="difflineplus">+    client.refresh();</span>
<a href="#l44.1248"></a><span id="l44.1248" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1249"></a><span id="l44.1249" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.1250"></a><span id="l44.1250" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.1251"></a><span id="l44.1251" class="difflineplus">+</span>
<a href="#l44.1252"></a><span id="l44.1252" class="difflineplus">+    // Case #4: Deleted on server, delete locally, overwrite conflict</span>
<a href="#l44.1253"></a><span id="l44.1253" class="difflineplus">+    MockConflictPrompt.overwrite = true;</span>
<a href="#l44.1254"></a><span id="l44.1254" class="difflineplus">+    gServer.events = [];</span>
<a href="#l44.1255"></a><span id="l44.1255" class="difflineplus">+    yield pclient.deleteItem(item);</span>
<a href="#l44.1256"></a><span id="l44.1256" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.1257"></a><span id="l44.1257" class="difflineplus">+    do_check_eq(items.length, 0);</span>
<a href="#l44.1258"></a><span id="l44.1258" class="difflineplus">+</span>
<a href="#l44.1259"></a><span id="l44.1259" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1260"></a><span id="l44.1260" class="difflineplus">+});</span>
<a href="#l44.1261"></a><span id="l44.1261" class="difflineplus">+</span>
<a href="#l44.1262"></a><span id="l44.1262" class="difflineplus">+add_task(function* test_default_alarms() {</span>
<a href="#l44.1263"></a><span id="l44.1263" class="difflineplus">+    let defaultReminders = [</span>
<a href="#l44.1264"></a><span id="l44.1264" class="difflineplus">+        { method: &quot;popup&quot;, minutes: 10 },</span>
<a href="#l44.1265"></a><span id="l44.1265" class="difflineplus">+        { method: &quot;email&quot;, minutes: 20 },</span>
<a href="#l44.1266"></a><span id="l44.1266" class="difflineplus">+    ];</span>
<a href="#l44.1267"></a><span id="l44.1267" class="difflineplus">+    gServer.calendarListData.defaultReminders = defaultReminders;</span>
<a href="#l44.1268"></a><span id="l44.1268" class="difflineplus">+    gServer.eventsData.defaultReminders = defaultReminders;</span>
<a href="#l44.1269"></a><span id="l44.1269" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.1270"></a><span id="l44.1270" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1271"></a><span id="l44.1271" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.1272"></a><span id="l44.1272" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1273"></a><span id="l44.1273" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1274"></a><span id="l44.1274" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1275"></a><span id="l44.1275" class="difflineplus">+       &quot;summary&quot;: &quot;Default Reminder&quot;,</span>
<a href="#l44.1276"></a><span id="l44.1276" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1277"></a><span id="l44.1277" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1278"></a><span id="l44.1278" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1279"></a><span id="l44.1279" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1280"></a><span id="l44.1280" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l44.1281"></a><span id="l44.1281" class="difflineplus">+       &quot;reminders&quot;: { &quot;useDefault&quot;: true }</span>
<a href="#l44.1282"></a><span id="l44.1282" class="difflineplus">+    }];</span>
<a href="#l44.1283"></a><span id="l44.1283" class="difflineplus">+</span>
<a href="#l44.1284"></a><span id="l44.1284" class="difflineplus">+    // Case #1: read default alarms from event stream</span>
<a href="#l44.1285"></a><span id="l44.1285" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1286"></a><span id="l44.1286" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l44.1287"></a><span id="l44.1287" class="difflineplus">+    do_check_eq(client.getProperty(&quot;settings.defaultReminders&quot;), JSON.stringify(defaultReminders));</span>
<a href="#l44.1288"></a><span id="l44.1288" class="difflineplus">+</span>
<a href="#l44.1289"></a><span id="l44.1289" class="difflineplus">+    let item = (yield pclient.getAllItems())[0];</span>
<a href="#l44.1290"></a><span id="l44.1290" class="difflineplus">+    let alarms = item.getAlarms({});</span>
<a href="#l44.1291"></a><span id="l44.1291" class="difflineplus">+</span>
<a href="#l44.1292"></a><span id="l44.1292" class="difflineplus">+    do_check_eq(alarms.length, 2);</span>
<a href="#l44.1293"></a><span id="l44.1293" class="difflineplus">+    do_check_true(alarms.every(x =&gt; x.getProperty(&quot;X-DEFAULT-ALARM&quot;) == &quot;TRUE&quot;));</span>
<a href="#l44.1294"></a><span id="l44.1294" class="difflineplus">+    do_check_eq(alarms[0].action, &quot;DISPLAY&quot;);</span>
<a href="#l44.1295"></a><span id="l44.1295" class="difflineplus">+    do_check_eq(alarms[0].offset.icalString, &quot;-PT10M&quot;);</span>
<a href="#l44.1296"></a><span id="l44.1296" class="difflineplus">+    do_check_eq(alarms[1].action, &quot;EMAIL&quot;);</span>
<a href="#l44.1297"></a><span id="l44.1297" class="difflineplus">+    do_check_eq(alarms[1].offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l44.1298"></a><span id="l44.1298" class="difflineplus">+</span>
<a href="#l44.1299"></a><span id="l44.1299" class="difflineplus">+    // Case #2: add an item with only default alarms</span>
<a href="#l44.1300"></a><span id="l44.1300" class="difflineplus">+    let event = cal.createEvent([</span>
<a href="#l44.1301"></a><span id="l44.1301" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l44.1302"></a><span id="l44.1302" class="difflineplus">+        &quot;SUMMARY:Default Alarms&quot;,</span>
<a href="#l44.1303"></a><span id="l44.1303" class="difflineplus">+        &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l44.1304"></a><span id="l44.1304" class="difflineplus">+        &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l44.1305"></a><span id="l44.1305" class="difflineplus">+        &quot;BEGIN:VALARM&quot;,</span>
<a href="#l44.1306"></a><span id="l44.1306" class="difflineplus">+        &quot;X-DEFAULT-ALARM:TRUE&quot;,</span>
<a href="#l44.1307"></a><span id="l44.1307" class="difflineplus">+        &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l44.1308"></a><span id="l44.1308" class="difflineplus">+        &quot;TRIGGER;VALUE=DURATION:PT0S&quot;,</span>
<a href="#l44.1309"></a><span id="l44.1309" class="difflineplus">+        &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l44.1310"></a><span id="l44.1310" class="difflineplus">+        &quot;END:VALARM&quot;,</span>
<a href="#l44.1311"></a><span id="l44.1311" class="difflineplus">+        &quot;END:VEVENT&quot;</span>
<a href="#l44.1312"></a><span id="l44.1312" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.1313"></a><span id="l44.1313" class="difflineplus">+</span>
<a href="#l44.1314"></a><span id="l44.1314" class="difflineplus">+    yield pclient.addItem(event);</span>
<a href="#l44.1315"></a><span id="l44.1315" class="difflineplus">+    do_check_true(gServer.events[1].reminders.useDefault);</span>
<a href="#l44.1316"></a><span id="l44.1316" class="difflineplus">+    do_check_eq(gServer.events[1].reminders.overrides.length, 0);</span>
<a href="#l44.1317"></a><span id="l44.1317" class="difflineplus">+</span>
<a href="#l44.1318"></a><span id="l44.1318" class="difflineplus">+    // Case #3: Mixed default/non-default alarms. Not sure this will happen</span>
<a href="#l44.1319"></a><span id="l44.1319" class="difflineplus">+    let event = cal.createEvent([</span>
<a href="#l44.1320"></a><span id="l44.1320" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l44.1321"></a><span id="l44.1321" class="difflineplus">+        &quot;SUMMARY:Default Alarms&quot;,</span>
<a href="#l44.1322"></a><span id="l44.1322" class="difflineplus">+        &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l44.1323"></a><span id="l44.1323" class="difflineplus">+        &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l44.1324"></a><span id="l44.1324" class="difflineplus">+        &quot;BEGIN:VALARM&quot;,</span>
<a href="#l44.1325"></a><span id="l44.1325" class="difflineplus">+        &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l44.1326"></a><span id="l44.1326" class="difflineplus">+        &quot;X-DEFAULT-ALARM:TRUE&quot;,</span>
<a href="#l44.1327"></a><span id="l44.1327" class="difflineplus">+        &quot;TRIGGER;VALUE=DURATION:-PT1M&quot;,</span>
<a href="#l44.1328"></a><span id="l44.1328" class="difflineplus">+        &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l44.1329"></a><span id="l44.1329" class="difflineplus">+        &quot;END:VALARM&quot;,</span>
<a href="#l44.1330"></a><span id="l44.1330" class="difflineplus">+        &quot;BEGIN:VALARM&quot;,</span>
<a href="#l44.1331"></a><span id="l44.1331" class="difflineplus">+        &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l44.1332"></a><span id="l44.1332" class="difflineplus">+        &quot;TRIGGER;VALUE=DURATION:-PT5M&quot;,</span>
<a href="#l44.1333"></a><span id="l44.1333" class="difflineplus">+        &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l44.1334"></a><span id="l44.1334" class="difflineplus">+        &quot;END:VALARM&quot;,</span>
<a href="#l44.1335"></a><span id="l44.1335" class="difflineplus">+        &quot;END:VEVENT&quot;</span>
<a href="#l44.1336"></a><span id="l44.1336" class="difflineplus">+    ].join(&quot;\r\n&quot;));</span>
<a href="#l44.1337"></a><span id="l44.1337" class="difflineplus">+</span>
<a href="#l44.1338"></a><span id="l44.1338" class="difflineplus">+    yield pclient.addItem(event);</span>
<a href="#l44.1339"></a><span id="l44.1339" class="difflineplus">+    do_check_true(gServer.events[2].reminders.useDefault);</span>
<a href="#l44.1340"></a><span id="l44.1340" class="difflineplus">+    do_check_eq(gServer.events[2].reminders.overrides.length, 1);</span>
<a href="#l44.1341"></a><span id="l44.1341" class="difflineplus">+    do_check_eq(gServer.events[2].reminders.overrides[0].minutes, 5);</span>
<a href="#l44.1342"></a><span id="l44.1342" class="difflineplus">+</span>
<a href="#l44.1343"></a><span id="l44.1343" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1344"></a><span id="l44.1344" class="difflineplus">+});</span>
<a href="#l44.1345"></a><span id="l44.1345" class="difflineplus">+</span>
<a href="#l44.1346"></a><span id="l44.1346" class="difflineplus">+add_task(function* test_paginate() {</span>
<a href="#l44.1347"></a><span id="l44.1347" class="difflineplus">+    gServer.events = [{</span>
<a href="#l44.1348"></a><span id="l44.1348" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1349"></a><span id="l44.1349" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.1350"></a><span id="l44.1350" class="difflineplus">+       &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1351"></a><span id="l44.1351" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1352"></a><span id="l44.1352" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1353"></a><span id="l44.1353" class="difflineplus">+       &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.1354"></a><span id="l44.1354" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1355"></a><span id="l44.1355" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1356"></a><span id="l44.1356" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1357"></a><span id="l44.1357" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1358"></a><span id="l44.1358" class="difflineplus">+       &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.1359"></a><span id="l44.1359" class="difflineplus">+    },{</span>
<a href="#l44.1360"></a><span id="l44.1360" class="difflineplus">+       &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1361"></a><span id="l44.1361" class="difflineplus">+       &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.1362"></a><span id="l44.1362" class="difflineplus">+       &quot;id&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l44.1363"></a><span id="l44.1363" class="difflineplus">+       &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1364"></a><span id="l44.1364" class="difflineplus">+       &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1365"></a><span id="l44.1365" class="difflineplus">+       &quot;summary&quot;: &quot;New Event 2&quot;,</span>
<a href="#l44.1366"></a><span id="l44.1366" class="difflineplus">+       &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1367"></a><span id="l44.1367" class="difflineplus">+       &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1368"></a><span id="l44.1368" class="difflineplus">+       &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1369"></a><span id="l44.1369" class="difflineplus">+       &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1370"></a><span id="l44.1370" class="difflineplus">+       &quot;iCalUID&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;</span>
<a href="#l44.1371"></a><span id="l44.1371" class="difflineplus">+    }];</span>
<a href="#l44.1372"></a><span id="l44.1372" class="difflineplus">+</span>
<a href="#l44.1373"></a><span id="l44.1373" class="difflineplus">+    gServer.tasks = [</span>
<a href="#l44.1374"></a><span id="l44.1374" class="difflineplus">+       {</span>
<a href="#l44.1375"></a><span id="l44.1375" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.1376"></a><span id="l44.1376" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.1377"></a><span id="l44.1377" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM\&quot;&quot;,</span>
<a href="#l44.1378"></a><span id="l44.1378" class="difflineplus">+        &quot;title&quot;: &quot;New Task&quot;,</span>
<a href="#l44.1379"></a><span id="l44.1379" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.1380"></a><span id="l44.1380" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l44.1381"></a><span id="l44.1381" class="difflineplus">+        &quot;position&quot;: &quot;00000000000000130998&quot;,</span>
<a href="#l44.1382"></a><span id="l44.1382" class="difflineplus">+        &quot;status&quot;: &quot;needsAction&quot;</span>
<a href="#l44.1383"></a><span id="l44.1383" class="difflineplus">+      },{</span>
<a href="#l44.1384"></a><span id="l44.1384" class="difflineplus">+        &quot;kind&quot;: &quot;tasks#task&quot;,</span>
<a href="#l44.1385"></a><span id="l44.1385" class="difflineplus">+        &quot;id&quot;: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l44.1386"></a><span id="l44.1386" class="difflineplus">+        &quot;etag&quot;: &quot;\&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTQyNTY0MjUwOQ\&quot;&quot;,</span>
<a href="#l44.1387"></a><span id="l44.1387" class="difflineplus">+        &quot;title&quot;: &quot;New Task 2&quot;,</span>
<a href="#l44.1388"></a><span id="l44.1388" class="difflineplus">+        &quot;updated&quot;: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l44.1389"></a><span id="l44.1389" class="difflineplus">+        &quot;selfLink&quot;: gServer.baseUri + &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l44.1390"></a><span id="l44.1390" class="difflineplus">+        &quot;position&quot;: &quot;00000000000000130993&quot;,</span>
<a href="#l44.1391"></a><span id="l44.1391" class="difflineplus">+        &quot;status&quot;: &quot;needsAction&quot;</span>
<a href="#l44.1392"></a><span id="l44.1392" class="difflineplus">+      }</span>
<a href="#l44.1393"></a><span id="l44.1393" class="difflineplus">+    ];</span>
<a href="#l44.1394"></a><span id="l44.1394" class="difflineplus">+</span>
<a href="#l44.1395"></a><span id="l44.1395" class="difflineplus">+    Preferences.set(&quot;calendar.google.maxResultsPerRequest&quot;, 1);</span>
<a href="#l44.1396"></a><span id="l44.1396" class="difflineplus">+</span>
<a href="#l44.1397"></a><span id="l44.1397" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1398"></a><span id="l44.1398" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l44.1399"></a><span id="l44.1399" class="difflineplus">+</span>
<a href="#l44.1400"></a><span id="l44.1400" class="difflineplus">+    // Make sure all pages were requested</span>
<a href="#l44.1401"></a><span id="l44.1401" class="difflineplus">+    do_check_eq(gServer.eventsData.nextPageToken, null);</span>
<a href="#l44.1402"></a><span id="l44.1402" class="difflineplus">+    do_check_eq(gServer.tasksData.nextPageToken, null);</span>
<a href="#l44.1403"></a><span id="l44.1403" class="difflineplus">+</span>
<a href="#l44.1404"></a><span id="l44.1404" class="difflineplus">+    // ...and we have all items. Not checking props</span>
<a href="#l44.1405"></a><span id="l44.1405" class="difflineplus">+    // because the other tests do this sufficiently.</span>
<a href="#l44.1406"></a><span id="l44.1406" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.1407"></a><span id="l44.1407" class="difflineplus">+    do_check_eq(items.length, 4);</span>
<a href="#l44.1408"></a><span id="l44.1408" class="difflineplus">+</span>
<a href="#l44.1409"></a><span id="l44.1409" class="difflineplus">+    do_check_eq(client.getProperty(&quot;syncToken.events&quot;), &quot;next-sync-token&quot;);</span>
<a href="#l44.1410"></a><span id="l44.1410" class="difflineplus">+</span>
<a href="#l44.1411"></a><span id="l44.1411" class="difflineplus">+    Preferences.reset(&quot;calendar.google.maxResultsPerRequest&quot;);</span>
<a href="#l44.1412"></a><span id="l44.1412" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1413"></a><span id="l44.1413" class="difflineplus">+});</span>
<a href="#l44.1414"></a><span id="l44.1414" class="difflineplus">+</span>
<a href="#l44.1415"></a><span id="l44.1415" class="difflineplus">+add_task(function* test_incremental_reset() {</span>
<a href="#l44.1416"></a><span id="l44.1416" class="difflineplus">+    gServer.syncs = [{</span>
<a href="#l44.1417"></a><span id="l44.1417" class="difflineplus">+        token: &quot;1&quot;,</span>
<a href="#l44.1418"></a><span id="l44.1418" class="difflineplus">+        events: [{</span>
<a href="#l44.1419"></a><span id="l44.1419" class="difflineplus">+            &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1420"></a><span id="l44.1420" class="difflineplus">+            &quot;etag&quot;: &quot;\&quot;1\&quot;&quot;,</span>
<a href="#l44.1421"></a><span id="l44.1421" class="difflineplus">+            &quot;id&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l44.1422"></a><span id="l44.1422" class="difflineplus">+            &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1423"></a><span id="l44.1423" class="difflineplus">+            &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1424"></a><span id="l44.1424" class="difflineplus">+            &quot;summary&quot;: &quot;New Event&quot;,</span>
<a href="#l44.1425"></a><span id="l44.1425" class="difflineplus">+            &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1426"></a><span id="l44.1426" class="difflineplus">+            &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1427"></a><span id="l44.1427" class="difflineplus">+            &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1428"></a><span id="l44.1428" class="difflineplus">+            &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1429"></a><span id="l44.1429" class="difflineplus">+            &quot;iCalUID&quot;: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;</span>
<a href="#l44.1430"></a><span id="l44.1430" class="difflineplus">+        }]</span>
<a href="#l44.1431"></a><span id="l44.1431" class="difflineplus">+    },{</span>
<a href="#l44.1432"></a><span id="l44.1432" class="difflineplus">+        token: &quot;2&quot;,</span>
<a href="#l44.1433"></a><span id="l44.1433" class="difflineplus">+        reset: true</span>
<a href="#l44.1434"></a><span id="l44.1434" class="difflineplus">+    },{</span>
<a href="#l44.1435"></a><span id="l44.1435" class="difflineplus">+        token: &quot;3&quot;,</span>
<a href="#l44.1436"></a><span id="l44.1436" class="difflineplus">+        events: [{</span>
<a href="#l44.1437"></a><span id="l44.1437" class="difflineplus">+            &quot;kind&quot;: &quot;calendar#event&quot;,</span>
<a href="#l44.1438"></a><span id="l44.1438" class="difflineplus">+            &quot;etag&quot;: &quot;\&quot;2\&quot;&quot;,</span>
<a href="#l44.1439"></a><span id="l44.1439" class="difflineplus">+            &quot;id&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l44.1440"></a><span id="l44.1440" class="difflineplus">+            &quot;created&quot;: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l44.1441"></a><span id="l44.1441" class="difflineplus">+            &quot;updated&quot;: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l44.1442"></a><span id="l44.1442" class="difflineplus">+            &quot;summary&quot;: &quot;New Event 2&quot;,</span>
<a href="#l44.1443"></a><span id="l44.1443" class="difflineplus">+            &quot;creator&quot;: gServer.creator,</span>
<a href="#l44.1444"></a><span id="l44.1444" class="difflineplus">+            &quot;organizer&quot;: gServer.creator,</span>
<a href="#l44.1445"></a><span id="l44.1445" class="difflineplus">+            &quot;start&quot;: { &quot;dateTime&quot;: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l44.1446"></a><span id="l44.1446" class="difflineplus">+            &quot;end&quot;: {&quot;dateTime&quot;: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l44.1447"></a><span id="l44.1447" class="difflineplus">+            &quot;iCalUID&quot;: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;</span>
<a href="#l44.1448"></a><span id="l44.1448" class="difflineplus">+        }]</span>
<a href="#l44.1449"></a><span id="l44.1449" class="difflineplus">+    }];</span>
<a href="#l44.1450"></a><span id="l44.1450" class="difflineplus">+    let client = yield gServer.getClient();</span>
<a href="#l44.1451"></a><span id="l44.1451" class="difflineplus">+    let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l44.1452"></a><span id="l44.1452" class="difflineplus">+</span>
<a href="#l44.1453"></a><span id="l44.1453" class="difflineplus">+    let items = yield pclient.getAllItems();</span>
<a href="#l44.1454"></a><span id="l44.1454" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.1455"></a><span id="l44.1455" class="difflineplus">+    do_check_eq(items[0].title, &quot;New Event&quot;);</span>
<a href="#l44.1456"></a><span id="l44.1456" class="difflineplus">+</span>
<a href="#l44.1457"></a><span id="l44.1457" class="difflineplus">+    client.refresh();</span>
<a href="#l44.1458"></a><span id="l44.1458" class="difflineplus">+    yield gServer.waitForLoad(client);</span>
<a href="#l44.1459"></a><span id="l44.1459" class="difflineplus">+</span>
<a href="#l44.1460"></a><span id="l44.1460" class="difflineplus">+    items = yield pclient.getAllItems();</span>
<a href="#l44.1461"></a><span id="l44.1461" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l44.1462"></a><span id="l44.1462" class="difflineplus">+    do_check_eq(items[0].title, &quot;New Event 2&quot;);</span>
<a href="#l44.1463"></a><span id="l44.1463" class="difflineplus">+</span>
<a href="#l44.1464"></a><span id="l44.1464" class="difflineplus">+    do_check_eq(gServer.syncs.length, 0);</span>
<a href="#l44.1465"></a><span id="l44.1465" class="difflineplus">+    do_check_eq(client.getProperty(&quot;syncToken.events&quot;), &quot;last&quot;);</span>
<a href="#l44.1466"></a><span id="l44.1466" class="difflineplus">+</span>
<a href="#l44.1467"></a><span id="l44.1467" class="difflineplus">+    gServer.resetClient(client);</span>
<a href="#l44.1468"></a><span id="l44.1468" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/test/unit/xpcshell.ini</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell.ini</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -18,16 +18,17 @@ run-sequentially = Avoid bustage.</span>
<a href="#l45.4"></a><span id="l45.4"> [test_bug653924.js]</span>
<a href="#l45.5"></a><span id="l45.5"> [test_bug668222.js]</span>
<a href="#l45.6"></a><span id="l45.6"> [test_bug759324.js]</span>
<a href="#l45.7"></a><span id="l45.7"> [test_datetime.js]</span>
<a href="#l45.8"></a><span id="l45.8"> [test_datetime_before_1970.js]</span>
<a href="#l45.9"></a><span id="l45.9"> [test_duration.js]</span>
<a href="#l45.10"></a><span id="l45.10"> [test_freebusy.js]</span>
<a href="#l45.11"></a><span id="l45.11"> [test_freebusy_service.js]</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+[test_gdata_provider.js]</span>
<a href="#l45.13"></a><span id="l45.13"> [test_hashedarray.js]</span>
<a href="#l45.14"></a><span id="l45.14"> [test_ics.js]</span>
<a href="#l45.15"></a><span id="l45.15"> [test_ics_parser.js]</span>
<a href="#l45.16"></a><span id="l45.16"> [test_ics_service.js]</span>
<a href="#l45.17"></a><span id="l45.17"> [test_items.js]</span>
<a href="#l45.18"></a><span id="l45.18"> [test_providers.js]</span>
<a href="#l45.19"></a><span id="l45.19"> [test_recur.js]</span>
<a href="#l45.20"></a><span id="l45.20"> [test_relation.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/testsuite-targets.mk</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/testsuite-targets.mk</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -56,10 +56,11 @@ package-tests: stage-mozmill</span>
<a href="#l46.4"></a><span id="l46.4"> endif</span>
<a href="#l46.5"></a><span id="l46.5"> endif</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7"> stage-mozmill: make-stage-dir</span>
<a href="#l46.8"></a><span id="l46.8"> 	$(MAKE) -C $(DEPTH)/mail/test/mozmill stage-package</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10"> stage-calendar: make-stage-dir</span>
<a href="#l46.11"></a><span id="l46.11"> 	$(MAKE) -C $(DEPTH)/calendar/lightning stage-package</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+	$(MAKE) -C $(DEPTH)/calendar/providers/gdata stage-package</span>
<a href="#l46.13"></a><span id="l46.13"> </span>
<a href="#l46.14"></a><span id="l46.14"> .PHONY: stage-mozmill stage-calendar</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

