<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24645:0b3d20e86288e4064481902b56d7905a7f6d904b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0b3d20e86288e4064481902b56d7905a7f6d904b" />
<meta property="og:url" content="/comm-central/rev/0b3d20e86288e4064481902b56d7905a7f6d904b" />
<meta property="og:description" content="Bug 1488263 - Enable eslint in mailnews/extensions/newsblog, Part 1: format changes. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0b3d20e86288e4064481902b56d7905a7f6d904b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0b3d20e86288e4064481902b56d7905a7f6d904b">shortlog</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0b3d20e86288e4064481902b56d7905a7f6d904b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b">files</a> |
changeset |
<a href="/comm-central/raw-rev/0b3d20e86288e4064481902b56d7905a7f6d904b">raw</a>  | <a href="/comm-central/archive/0b3d20e86288e4064481902b56d7905a7f6d904b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1488263">Bug 1488263</a> - Enable eslint in mailnews/extensions/newsblog, Part 1: format changes. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;</td></tr>
<tr><td></td><td class="date age">Sat, 01 Sep 2018 22:21:43 -0600</td></tr>

<tr>
 <td>changeset 24645</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0b3d20e86288e4064481902b56d7905a7f6d904b">0b3d20e86288e4064481902b56d7905a7f6d904b</a></td>
</tr>



<tr>
<td>parent 24644</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4e3c8a14998711ec9894f5803439e9419f8a034b">4e3c8a14998711ec9894f5803439e9419f8a034b</a>
</td>
</tr>

<tr>
<td>child 24646</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/35b4619745680791f5f13f43dd446166270ff30c">35b4619745680791f5f13f43dd446166270ff30c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0b3d20e86288e4064481902b56d7905a7f6d904b">14826</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 03 Sep 2018 22:11:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@35b461974568 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=35b4619745680791f5f13f43dd446166270ff30c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=35b4619745680791f5f13f43dd446166270ff30c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=35b4619745680791f5f13f43dd446166270ff30c&newProject=comm-central&newRevision=5f30a26c656a3d3742c71e523a474698bf800dfd&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=35b4619745680791f5f13f43dd446166270ff30c&newProject=comm-central&newRevision=5f30a26c656a3d3742c71e523a474698bf800dfd&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=35b4619745680791f5f13f43dd446166270ff30c&newProject=comm-central&newRevision=5f30a26c656a3d3742c71e523a474698bf800dfd&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1488263">1488263</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1488263">Bug 1488263</a> - Enable eslint in mailnews/extensions/newsblog, Part 1: format changes. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">mailnews/extensions/newsblog/content/FeedItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">mailnews/extensions/newsblog/content/am-newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/am-newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">mailnews/extensions/newsblog/content/feed-parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-parser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">mailnews/extensions/newsblog/content/feedAccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/feedAccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/0b3d20e86288e4064481902b56d7905a7f6d904b/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,150 +1,141 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l1.5"></a><span id="l1.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // Cache for all of the feeds currently being downloaded, indexed by URL,</span>
<a href="#l1.10"></a><span id="l1.10"> // so the load event listener can access the Feed objects after it finishes</span>
<a href="#l1.11"></a><span id="l1.11"> // downloading the feed.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var FeedCache =</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+var FeedCache = {</span>
<a href="#l1.15"></a><span id="l1.15">   mFeeds: {},</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-  putFeed: function (aFeed)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  putFeed(aFeed) {</span>
<a href="#l1.20"></a><span id="l1.20">     this.mFeeds[this.normalizeHost(aFeed.url)] = aFeed;</span>
<a href="#l1.21"></a><span id="l1.21">   },</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  getFeed: function (aUrl)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+  getFeed(aUrl) {</span>
<a href="#l1.26"></a><span id="l1.26">     let index = this.normalizeHost(aUrl);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    if (index in this.mFeeds)</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    if (index in this.mFeeds) {</span>
<a href="#l1.29"></a><span id="l1.29">       return this.mFeeds[index];</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    }</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">     return null;</span>
<a href="#l1.33"></a><span id="l1.33">   },</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  removeFeed: function (aUrl)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  removeFeed(aUrl) {</span>
<a href="#l1.38"></a><span id="l1.38">     let index = this.normalizeHost(aUrl);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    if (index in this.mFeeds)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    if (index in this.mFeeds) {</span>
<a href="#l1.41"></a><span id="l1.41">       delete this.mFeeds[index];</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    }</span>
<a href="#l1.43"></a><span id="l1.43">   },</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  normalizeHost: function (aUrl)</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    try</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  normalizeHost(aUrl) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    try {</span>
<a href="#l1.51"></a><span id="l1.51">       let normalizedUrl = Services.io.newURI(aUrl);</span>
<a href="#l1.52"></a><span id="l1.52">       let newHost = normalizedUrl.host.toLowerCase();</span>
<a href="#l1.53"></a><span id="l1.53">       normalizedUrl = normalizedUrl.mutate().setHost(newHost).finalize();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-      return normalizedUrl.spec</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-    }</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-    catch (ex)</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      return normalizedUrl.spec;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    } catch (ex) {</span>
<a href="#l1.60"></a><span id="l1.60">       return aUrl;</span>
<a href="#l1.61"></a><span id="l1.61">     }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  }</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  },</span>
<a href="#l1.64"></a><span id="l1.64"> };</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66"> /**</span>
<a href="#l1.67"></a><span id="l1.67">  * A Feed object. If aFolder is the account root folder, a new subfolder</span>
<a href="#l1.68"></a><span id="l1.68">  * for the feed url is created otherwise the url will be subscribed to the</span>
<a href="#l1.69"></a><span id="l1.69">  * existing aFolder, upon successful download() completion.</span>
<a href="#l1.70"></a><span id="l1.70">  *</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">- * @param  string aFeedUrl        - feed url.</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">- * @param  nsIMsgFolder aFolder   - folder containing or to contain the feed</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">- *                                  subscription.</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+ * @constructor</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+ * @param  {String} aFeedUrl        - feed url.</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+ * @param  {nsIMsgFolder} aFolder   - folder containing or to contain the feed</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+ *                                     subscription.</span>
<a href="#l1.78"></a><span id="l1.78">  */</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-function Feed(aFeedUrl, aFolder)</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-{</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+function Feed(aFeedUrl, aFolder) {</span>
<a href="#l1.82"></a><span id="l1.82">   this.resource = FeedUtils.rdf.GetResource(aFeedUrl)</span>
<a href="#l1.83"></a><span id="l1.83">                                .QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l1.84"></a><span id="l1.84">   this.server = aFolder.server;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  if (!aFolder.isServer)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  if (!aFolder.isServer) {</span>
<a href="#l1.87"></a><span id="l1.87">     this.mFolder = aFolder;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  }</span>
<a href="#l1.89"></a><span id="l1.89"> }</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-Feed.prototype =</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-{</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+Feed.prototype = {</span>
<a href="#l1.94"></a><span id="l1.94">   description: null,</span>
<a href="#l1.95"></a><span id="l1.95">   author: null,</span>
<a href="#l1.96"></a><span id="l1.96">   request: null,</span>
<a href="#l1.97"></a><span id="l1.97">   server: null,</span>
<a href="#l1.98"></a><span id="l1.98">   downloadCallback: null,</span>
<a href="#l1.99"></a><span id="l1.99">   resource: null,</span>
<a href="#l1.100"></a><span id="l1.100">   itemsToStore: [],</span>
<a href="#l1.101"></a><span id="l1.101">   itemsStored: 0,</span>
<a href="#l1.102"></a><span id="l1.102">   fileSize: 0,</span>
<a href="#l1.103"></a><span id="l1.103">   mFolder: null,</span>
<a href="#l1.104"></a><span id="l1.104">   mInvalidFeed: false,</span>
<a href="#l1.105"></a><span id="l1.105">   mFeedType: null,</span>
<a href="#l1.106"></a><span id="l1.106">   mLastModified: null,</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  get folder()</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  get folder() {</span>
<a href="#l1.111"></a><span id="l1.111">     return this.mFolder;</span>
<a href="#l1.112"></a><span id="l1.112">   },</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  set folder (aFolder)</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-  {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  set folder(aFolder) {</span>
<a href="#l1.117"></a><span id="l1.117">     this.mFolder = aFolder;</span>
<a href="#l1.118"></a><span id="l1.118">   },</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-  get name()</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-  {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  get name() {</span>
<a href="#l1.123"></a><span id="l1.123">     // Used for the feed's title in Subscribe dialog and opml export.</span>
<a href="#l1.124"></a><span id="l1.124">     let name = this.title || this.description || this.url;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    /* eslint-disable-next-line no-control-regex */</span>
<a href="#l1.126"></a><span id="l1.126">     return name.replace(/[\n\r\t]+/g, &quot; &quot;).replace(/[\x00-\x1F]+/g, &quot;&quot;);</span>
<a href="#l1.127"></a><span id="l1.127">   },</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-  get folderName()</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  {</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    if (this.mFolderName)</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  get folderName() {</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    if (this.mFolderName) {</span>
<a href="#l1.134"></a><span id="l1.134">       return this.mFolderName;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+    }</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137">     // Get a unique sanitized name. Use title or description as a base;</span>
<a href="#l1.138"></a><span id="l1.138">     // these are mandatory by spec. Length of 80 is plenty.</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    let folderName = (this.title || this.description || &quot;&quot;).substr(0,80);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    let folderName = (this.title || this.description || &quot;&quot;).substr(0, 80);</span>
<a href="#l1.141"></a><span id="l1.141">     let defaultName = FeedUtils.strings.GetStringFromName(&quot;ImportFeedsNew&quot;);</span>
<a href="#l1.142"></a><span id="l1.142">     return this.mFolderName = FeedUtils.getSanitizedFolderName(this.server.rootMsgFolder,</span>
<a href="#l1.143"></a><span id="l1.143">                                                                folderName,</span>
<a href="#l1.144"></a><span id="l1.144">                                                                defaultName,</span>
<a href="#l1.145"></a><span id="l1.145">                                                                true);</span>
<a href="#l1.146"></a><span id="l1.146">   },</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-  download: function(aParseItems, aCallback)</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  download(aParseItems, aCallback) {</span>
<a href="#l1.151"></a><span id="l1.151">      // May be null.</span>
<a href="#l1.152"></a><span id="l1.152">     this.downloadCallback = aCallback;</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">     // Whether or not to parse items when downloading and parsing the feed.</span>
<a href="#l1.155"></a><span id="l1.155">     // Defaults to true, but setting to false is useful for obtaining</span>
<a href="#l1.156"></a><span id="l1.156">     // just the title of the feed when the user subscribes to it.</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-    this.parseItems = aParseItems == null ? true : aParseItems ? true : false;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    this.parseItems = aParseItems == null || aParseItems;</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160">     // Before we do anything, make sure the url is an http url.  This is just</span>
<a href="#l1.161"></a><span id="l1.161">     // a sanity check so we don't try opening mailto urls, imap urls, etc. that</span>
<a href="#l1.162"></a><span id="l1.162">     // the user may have tried to subscribe to as an rss feed.</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-    if (!FeedUtils.isValidScheme(this.url))</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-    {</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+    if (!FeedUtils.isValidScheme(this.url)) {</span>
<a href="#l1.166"></a><span id="l1.166">        // Simulate an invalid feed error.</span>
<a href="#l1.167"></a><span id="l1.167">       FeedUtils.log.info(&quot;Feed.download: invalid protocol for - &quot; + this.url);</span>
<a href="#l1.168"></a><span id="l1.168">       this.onParseError(this);</span>
<a href="#l1.169"></a><span id="l1.169">       return;</span>
<a href="#l1.170"></a><span id="l1.170">     }</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">     // Before we try to download the feed, make sure we aren't already</span>
<a href="#l1.173"></a><span id="l1.173">     // processing the feed by looking up the url in our feed cache.</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    if (FeedCache.getFeed(this.url))</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-    {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-      if (this.downloadCallback)</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+    if (FeedCache.getFeed(this.url)) {</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+      if (this.downloadCallback) {</span>
<a href="#l1.179"></a><span id="l1.179">         this.downloadCallback.downloaded(this, FeedUtils.kNewsBlogFeedIsBusy);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+      }</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+</span>
<a href="#l1.182"></a><span id="l1.182">       // Return, the feed is already in use.</span>
<a href="#l1.183"></a><span id="l1.183">       return;</span>
<a href="#l1.184"></a><span id="l1.184">     }</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">     if (Services.io.offline) {</span>
<a href="#l1.187"></a><span id="l1.187">       // If offline and don't want to go online, just add the feed subscription;</span>
<a href="#l1.188"></a><span id="l1.188">       // it can be verified later (the folder name will be the url if not adding</span>
<a href="#l1.189"></a><span id="l1.189">       // to an existing folder). Only for subscribe actions; passive biff and</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineat">@@ -178,42 +169,40 @@ Feed.prototype =</span>
<a href="#l1.191"></a><span id="l1.191">     this.request.onload = this.onDownloaded;</span>
<a href="#l1.192"></a><span id="l1.192">     this.request.onreadystatechange = this.onReadyStateChange;</span>
<a href="#l1.193"></a><span id="l1.193">     this.request.onerror = this.onDownloadError;</span>
<a href="#l1.194"></a><span id="l1.194">     this.request.ontimeout = this.onDownloadError;</span>
<a href="#l1.195"></a><span id="l1.195">     FeedCache.putFeed(this);</span>
<a href="#l1.196"></a><span id="l1.196">     this.request.send(null);</span>
<a href="#l1.197"></a><span id="l1.197">   },</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  onReadyStateChange: function(aEvent)</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-  {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+  onReadyStateChange(aEvent) {</span>
<a href="#l1.202"></a><span id="l1.202">     // Once a server responds with data, reset the timeout to allow potentially</span>
<a href="#l1.203"></a><span id="l1.203">     // large files to complete the download.</span>
<a href="#l1.204"></a><span id="l1.204">     let request = aEvent.target;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-    if (request.timeout &amp;&amp; request.readyState == request.LOADING)</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+    if (request.timeout &amp;&amp; request.readyState == request.LOADING) {</span>
<a href="#l1.207"></a><span id="l1.207">       request.timeout = 0;</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    }</span>
<a href="#l1.209"></a><span id="l1.209">   },</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  onDownloaded: function(aEvent)</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-  {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  onDownloaded(aEvent) {</span>
<a href="#l1.214"></a><span id="l1.214">     let request = aEvent.target;</span>
<a href="#l1.215"></a><span id="l1.215">     let isHttp = request.channel.originalURI.scheme.startsWith(&quot;http&quot;);</span>
<a href="#l1.216"></a><span id="l1.216">     let url = request.channel.originalURI.spec;</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-    if (isHttp &amp;&amp; (request.status &lt; 200 || request.status &gt;= 300))</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-    {</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+    if (isHttp &amp;&amp; (request.status &lt; 200 || request.status &gt;= 300)) {</span>
<a href="#l1.220"></a><span id="l1.220">       Feed.prototype.onDownloadError(aEvent);</span>
<a href="#l1.221"></a><span id="l1.221">       return;</span>
<a href="#l1.222"></a><span id="l1.222">     }</span>
<a href="#l1.223"></a><span id="l1.223"> </span>
<a href="#l1.224"></a><span id="l1.224">     FeedUtils.log.debug(&quot;Feed.onDownloaded: got a download, fileSize:url - &quot; +</span>
<a href="#l1.225"></a><span id="l1.225">                         aEvent.loaded + &quot; : &quot; + url);</span>
<a href="#l1.226"></a><span id="l1.226">     let feed = FeedCache.getFeed(url);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-    if (!feed)</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-      throw new Error(&quot;Feed.onDownloaded: error - couldn't retrieve feed &quot; +</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-                      &quot;from cache&quot;);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+    if (!feed) {</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+      throw new Error(&quot;Feed.onDownloaded: error - couldn't retrieve feed from cache&quot;);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    }</span>
<a href="#l1.233"></a><span id="l1.233"> </span>
<a href="#l1.234"></a><span id="l1.234">     // If the server sends a Last-Modified header, store the property on the</span>
<a href="#l1.235"></a><span id="l1.235">     // feed so we can use it when making future requests, to avoid downloading</span>
<a href="#l1.236"></a><span id="l1.236">     // and parsing feeds that have not changed.  Don't update if merely checking</span>
<a href="#l1.237"></a><span id="l1.237">     // the url, as for subscribe move/copy, as a subsequent refresh may get a 304.</span>
<a href="#l1.238"></a><span id="l1.238">     // Save the response and persist it only upon successful completion of the</span>
<a href="#l1.239"></a><span id="l1.239">     // refresh cycle (i.e. not if the request is cancelled).</span>
<a href="#l1.240"></a><span id="l1.240">     let lastModifiedHeader = request.getResponseHeader(&quot;Last-Modified&quot;);</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineat">@@ -221,454 +210,447 @@ Feed.prototype =</span>
<a href="#l1.242"></a><span id="l1.242">                            lastModifiedHeader : null;</span>
<a href="#l1.243"></a><span id="l1.243"> </span>
<a href="#l1.244"></a><span id="l1.244">     feed.fileSize = aEvent.loaded;</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246">     // The download callback is called asynchronously when parse() is done.</span>
<a href="#l1.247"></a><span id="l1.247">     feed.parse();</span>
<a href="#l1.248"></a><span id="l1.248">   },</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  onProgress: function(aEvent)</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-  {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  onProgress(aEvent) {</span>
<a href="#l1.253"></a><span id="l1.253">     let request = aEvent.target;</span>
<a href="#l1.254"></a><span id="l1.254">     let url = request.channel.originalURI.spec;</span>
<a href="#l1.255"></a><span id="l1.255">     let feed = FeedCache.getFeed(url);</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-    if (feed.downloadCallback)</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+    if (feed.downloadCallback) {</span>
<a href="#l1.259"></a><span id="l1.259">       feed.downloadCallback.onProgress(feed, aEvent.loaded, aEvent.total,</span>
<a href="#l1.260"></a><span id="l1.260">                                        aEvent.lengthComputable);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+    }</span>
<a href="#l1.262"></a><span id="l1.262">   },</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-  onDownloadError: function(aEvent)</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-  {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+  onDownloadError(aEvent) {</span>
<a href="#l1.267"></a><span id="l1.267">     let request = aEvent.target;</span>
<a href="#l1.268"></a><span id="l1.268">     let url = request.channel.originalURI.spec;</span>
<a href="#l1.269"></a><span id="l1.269">     let feed = FeedCache.getFeed(url);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    if (feed.downloadCallback)</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    {</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+    if (feed.downloadCallback) {</span>
<a href="#l1.273"></a><span id="l1.273">       // Generic network or 'not found' error initially.</span>
<a href="#l1.274"></a><span id="l1.274">       let error = FeedUtils.kNewsBlogRequestFailure;</span>
<a href="#l1.275"></a><span id="l1.275">       // Certain errors should disable the feed.</span>
<a href="#l1.276"></a><span id="l1.276">       let disable = false;</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278">       if (request.status == 304) {</span>
<a href="#l1.279"></a><span id="l1.279">         // If the http status code is 304, the feed has not been modified</span>
<a href="#l1.280"></a><span id="l1.280">         // since we last downloaded it and does not need to be parsed.</span>
<a href="#l1.281"></a><span id="l1.281">         error = FeedUtils.kNewsBlogNoNewItems;</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      }</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-      else {</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+      } else {</span>
<a href="#l1.285"></a><span id="l1.285">         let [errType, errName] = FeedUtils.createTCPErrorFromFailedXHR(request);</span>
<a href="#l1.286"></a><span id="l1.286">         FeedUtils.log.info(&quot;Feed.onDownloaded: request errType:errName:statusCode - &quot; +</span>
<a href="#l1.287"></a><span id="l1.287">                            errType + &quot;:&quot; + errName + &quot;:&quot; + request.status);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-        if (errType == &quot;SecurityCertificate&quot;)</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+        if (errType == &quot;SecurityCertificate&quot;) {</span>
<a href="#l1.290"></a><span id="l1.290">           // This is the code for nsINSSErrorsService.ERROR_CLASS_BAD_CERT</span>
<a href="#l1.291"></a><span id="l1.291">           // overrideable security certificate errors.</span>
<a href="#l1.292"></a><span id="l1.292">           error = FeedUtils.kNewsBlogBadCertError;</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+        }</span>
<a href="#l1.294"></a><span id="l1.294"> </span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-        if (request.status == 401 || request.status == 403)</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+        if (request.status == 401 || request.status == 403) {</span>
<a href="#l1.297"></a><span id="l1.297">           // Unauthorized or Forbidden.</span>
<a href="#l1.298"></a><span id="l1.298">           error = FeedUtils.kNewsBlogNoAuthError;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+        }</span>
<a href="#l1.300"></a><span id="l1.300"> </span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-        if (request.status != 0 || error == FeedUtils.kNewsBlogBadCertError)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+        if (request.status != 0 || error == FeedUtils.kNewsBlogBadCertError) {</span>
<a href="#l1.303"></a><span id="l1.303">           disable = true;</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+        }</span>
<a href="#l1.305"></a><span id="l1.305">       }</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307">       feed.downloadCallback.downloaded(feed, error, disable);</span>
<a href="#l1.308"></a><span id="l1.308">     }</span>
<a href="#l1.309"></a><span id="l1.309"> </span>
<a href="#l1.310"></a><span id="l1.310">     FeedCache.removeFeed(url);</span>
<a href="#l1.311"></a><span id="l1.311">   },</span>
<a href="#l1.312"></a><span id="l1.312"> </span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-  onParseError: function(aFeed)</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-  {</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-    if (!aFeed)</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+  onParseError(aFeed) {</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+    if (!aFeed) {</span>
<a href="#l1.318"></a><span id="l1.318">       return;</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+    }</span>
<a href="#l1.320"></a><span id="l1.320"> </span>
<a href="#l1.321"></a><span id="l1.321">     aFeed.mInvalidFeed = true;</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-    if (aFeed.downloadCallback)</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+    if (aFeed.downloadCallback) {</span>
<a href="#l1.324"></a><span id="l1.324">       aFeed.downloadCallback.downloaded(aFeed, FeedUtils.kNewsBlogInvalidFeed, true);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    }</span>
<a href="#l1.326"></a><span id="l1.326"> </span>
<a href="#l1.327"></a><span id="l1.327">     FeedCache.removeFeed(aFeed.url);</span>
<a href="#l1.328"></a><span id="l1.328">   },</span>
<a href="#l1.329"></a><span id="l1.329"> </span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-  onUrlChange: function(aFeed, aOldUrl)</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-  {</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-    if (!aFeed)</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+  onUrlChange(aFeed, aOldUrl) {</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+    if (!aFeed) {</span>
<a href="#l1.335"></a><span id="l1.335">       return;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+    }</span>
<a href="#l1.337"></a><span id="l1.337"> </span>
<a href="#l1.338"></a><span id="l1.338">     // Simulate a cancel after a url update; next cycle will check the new url.</span>
<a href="#l1.339"></a><span id="l1.339">     aFeed.mInvalidFeed = true;</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    if (aFeed.downloadCallback)</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+    if (aFeed.downloadCallback) {</span>
<a href="#l1.342"></a><span id="l1.342">       aFeed.downloadCallback.downloaded(aFeed, FeedUtils.kNewsBlogCancel);</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+    }</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345">     FeedCache.removeFeed(aOldUrl);</span>
<a href="#l1.346"></a><span id="l1.346">   },</span>
<a href="#l1.347"></a><span id="l1.347"> </span>
<a href="#l1.348"></a><span id="l1.348">   // nsIUrlListener methods for getDatabaseWithReparse().</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-  OnStartRunningUrl: function(aUrl) { },</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-  {</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-    if (Components.isSuccessCode(aExitCode))</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-    {</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+  OnStartRunningUrl(aUrl) { },</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+    if (Components.isSuccessCode(aExitCode)) {</span>
<a href="#l1.357"></a><span id="l1.357">       FeedUtils.log.debug(&quot;Feed.OnStopRunningUrl: rebuilt msgDatabase for &quot; +</span>
<a href="#l1.358"></a><span id="l1.358">                           this.folder.name + &quot; - &quot; + this.folder.filePath.path);</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-    }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-    else</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-    {</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+    } else {</span>
<a href="#l1.363"></a><span id="l1.363">       FeedUtils.log.error(&quot;Feed.OnStopRunningUrl: rebuild msgDatabase failed, &quot; +</span>
<a href="#l1.364"></a><span id="l1.364">                           &quot;error &quot; + aExitCode + &quot;, for &quot; +</span>
<a href="#l1.365"></a><span id="l1.365">                           this.folder.name + &quot; - &quot; + this.folder.filePath.path);</span>
<a href="#l1.366"></a><span id="l1.366">     }</span>
<a href="#l1.367"></a><span id="l1.367">     // Continue.</span>
<a href="#l1.368"></a><span id="l1.368">     this.storeNextItem();</span>
<a href="#l1.369"></a><span id="l1.369">   },</span>
<a href="#l1.370"></a><span id="l1.370"> </span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-  get url()</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-  {</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+  get url() {</span>
<a href="#l1.374"></a><span id="l1.374">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.375"></a><span id="l1.375">     let url = ds.GetTarget(this.resource, FeedUtils.DC_IDENTIFIER, true);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-    if (url)</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+    if (url) {</span>
<a href="#l1.378"></a><span id="l1.378">       url = url.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-    else</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+    } else {</span>
<a href="#l1.381"></a><span id="l1.381">       url = this.resource.ValueUTF8;</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+    }</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384">     return url;</span>
<a href="#l1.385"></a><span id="l1.385">   },</span>
<a href="#l1.386"></a><span id="l1.386"> </span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-  get title()</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-  {</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+  get title() {</span>
<a href="#l1.390"></a><span id="l1.390">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.391"></a><span id="l1.391">     let title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-    if (title)</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+    if (title) {</span>
<a href="#l1.394"></a><span id="l1.394">       title = title.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+    }</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397">     return title;</span>
<a href="#l1.398"></a><span id="l1.398">   },</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-  set title (aNewTitle)</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-  {</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-    if (!aNewTitle)</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+  set title(aNewTitle) {</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+    if (!aNewTitle) {</span>
<a href="#l1.405"></a><span id="l1.405">       return;</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+    }</span>
<a href="#l1.407"></a><span id="l1.407"> </span>
<a href="#l1.408"></a><span id="l1.408">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.409"></a><span id="l1.409">     aNewTitle = FeedUtils.rdf.GetLiteral(aNewTitle);</span>
<a href="#l1.410"></a><span id="l1.410">     let old_title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-    if (old_title)</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+    if (old_title) {</span>
<a href="#l1.413"></a><span id="l1.413">         ds.Change(this.resource, FeedUtils.DC_TITLE, old_title, aNewTitle);</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-    else</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+    } else {</span>
<a href="#l1.416"></a><span id="l1.416">         ds.Assert(this.resource, FeedUtils.DC_TITLE, aNewTitle, true);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+    }</span>
<a href="#l1.418"></a><span id="l1.418">   },</span>
<a href="#l1.419"></a><span id="l1.419"> </span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-  get lastModified()</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-  {</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineplus">+  get lastModified() {</span>
<a href="#l1.423"></a><span id="l1.423">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.424"></a><span id="l1.424">     let lastModified = ds.GetTarget(this.resource,</span>
<a href="#l1.425"></a><span id="l1.425">                                     FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l1.426"></a><span id="l1.426">                                     true);</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-    if (lastModified)</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+    if (lastModified) {</span>
<a href="#l1.429"></a><span id="l1.429">       lastModified = lastModified.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+    }</span>
<a href="#l1.431"></a><span id="l1.431"> </span>
<a href="#l1.432"></a><span id="l1.432">     return lastModified;</span>
<a href="#l1.433"></a><span id="l1.433">   },</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-  set lastModified(aLastModified)</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-  {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+  set lastModified(aLastModified) {</span>
<a href="#l1.438"></a><span id="l1.438">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.439"></a><span id="l1.439">     aLastModified = FeedUtils.rdf.GetLiteral(aLastModified);</span>
<a href="#l1.440"></a><span id="l1.440">     let old_lastmodified = ds.GetTarget(this.resource,</span>
<a href="#l1.441"></a><span id="l1.441">                                         FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l1.442"></a><span id="l1.442">                                         true);</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-    if (old_lastmodified)</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+    if (old_lastmodified) {</span>
<a href="#l1.445"></a><span id="l1.445">       ds.Change(this.resource, FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l1.446"></a><span id="l1.446">                 old_lastmodified, aLastModified);</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-    else</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+    } else {</span>
<a href="#l1.449"></a><span id="l1.449">       ds.Assert(this.resource, FeedUtils.DC_LASTMODIFIED, aLastModified, true);</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+    }</span>
<a href="#l1.451"></a><span id="l1.451">   },</span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-  get quickMode ()</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-  {</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+  get quickMode() {</span>
<a href="#l1.456"></a><span id="l1.456">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.457"></a><span id="l1.457">     let quickMode = ds.GetTarget(this.resource, FeedUtils.FZ_QUICKMODE, true);</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-    if (quickMode)</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-    {</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+    if (quickMode) {</span>
<a href="#l1.461"></a><span id="l1.461">       quickMode = quickMode.QueryInterface(Ci.nsIRDFLiteral);</span>
<a href="#l1.462"></a><span id="l1.462">       quickMode = quickMode.Value == &quot;true&quot;;</span>
<a href="#l1.463"></a><span id="l1.463">     }</span>
<a href="#l1.464"></a><span id="l1.464"> </span>
<a href="#l1.465"></a><span id="l1.465">     return quickMode;</span>
<a href="#l1.466"></a><span id="l1.466">   },</span>
<a href="#l1.467"></a><span id="l1.467"> </span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-  set quickMode (aNewQuickMode)</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-  {</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+  set quickMode(aNewQuickMode) {</span>
<a href="#l1.471"></a><span id="l1.471">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.472"></a><span id="l1.472">     aNewQuickMode = FeedUtils.rdf.GetLiteral(aNewQuickMode);</span>
<a href="#l1.473"></a><span id="l1.473">     let old_quickMode = ds.GetTarget(this.resource,</span>
<a href="#l1.474"></a><span id="l1.474">                                      FeedUtils.FZ_QUICKMODE,</span>
<a href="#l1.475"></a><span id="l1.475">                                      true);</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-    if (old_quickMode)</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+    if (old_quickMode) {</span>
<a href="#l1.478"></a><span id="l1.478">       ds.Change(this.resource, FeedUtils.FZ_QUICKMODE,</span>
<a href="#l1.479"></a><span id="l1.479">                 old_quickMode, aNewQuickMode);</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-    else</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+    } else {</span>
<a href="#l1.482"></a><span id="l1.482">       ds.Assert(this.resource, FeedUtils.FZ_QUICKMODE,</span>
<a href="#l1.483"></a><span id="l1.483">                 aNewQuickMode, true);</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+    }</span>
<a href="#l1.485"></a><span id="l1.485">   },</span>
<a href="#l1.486"></a><span id="l1.486"> </span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-  get options ()</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-  {</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+  get options() {</span>
<a href="#l1.490"></a><span id="l1.490">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.491"></a><span id="l1.491">     let options = ds.GetTarget(this.resource, FeedUtils.FZ_OPTIONS, true);</span>
<a href="#l1.492"></a><span id="l1.492">     options = options ? JSON.parse(options.QueryInterface(Ci.nsIRDFLiteral).Value) :</span>
<a href="#l1.493"></a><span id="l1.493">                         null;</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-    if (options &amp;&amp; options.version == FeedUtils._optionsDefault.version)</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+    if (options &amp;&amp; options.version == FeedUtils._optionsDefault.version) {</span>
<a href="#l1.496"></a><span id="l1.496">       return options;</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+    }</span>
<a href="#l1.498"></a><span id="l1.498"> </span>
<a href="#l1.499"></a><span id="l1.499">     let newOptions = FeedUtils.newOptions(options);</span>
<a href="#l1.500"></a><span id="l1.500">     this.options = newOptions;</span>
<a href="#l1.501"></a><span id="l1.501">     return newOptions;</span>
<a href="#l1.502"></a><span id="l1.502">   },</span>
<a href="#l1.503"></a><span id="l1.503"> </span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-  set options (aOptions)</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-  {</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+  set options(aOptions) {</span>
<a href="#l1.507"></a><span id="l1.507">     let newOptions = aOptions ? aOptions : FeedUtils.optionsTemplate;</span>
<a href="#l1.508"></a><span id="l1.508">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.509"></a><span id="l1.509">     newOptions = FeedUtils.rdf.GetLiteral(JSON.stringify(newOptions));</span>
<a href="#l1.510"></a><span id="l1.510">     let oldOptions = ds.GetTarget(this.resource, FeedUtils.FZ_OPTIONS, true);</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-    if (oldOptions)</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+    if (oldOptions) {</span>
<a href="#l1.513"></a><span id="l1.513">       ds.Change(this.resource, FeedUtils.FZ_OPTIONS, oldOptions, newOptions);</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-    else</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+    } else {</span>
<a href="#l1.516"></a><span id="l1.516">       ds.Assert(this.resource, FeedUtils.FZ_OPTIONS, newOptions, true);</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+    }</span>
<a href="#l1.518"></a><span id="l1.518">   },</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-  get link ()</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-  {</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+  get link() {</span>
<a href="#l1.523"></a><span id="l1.523">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.524"></a><span id="l1.524">     let link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-    if (link)</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+    if (link) {</span>
<a href="#l1.527"></a><span id="l1.527">       link = link.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+    }</span>
<a href="#l1.529"></a><span id="l1.529"> </span>
<a href="#l1.530"></a><span id="l1.530">     return link;</span>
<a href="#l1.531"></a><span id="l1.531">   },</span>
<a href="#l1.532"></a><span id="l1.532"> </span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-  set link (aNewLink)</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-  {</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-    if (!aNewLink)</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+  set link(aNewLink) {</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+    if (!aNewLink) {</span>
<a href="#l1.538"></a><span id="l1.538">       return;</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+    }</span>
<a href="#l1.540"></a><span id="l1.540"> </span>
<a href="#l1.541"></a><span id="l1.541">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.542"></a><span id="l1.542">     aNewLink = FeedUtils.rdf.GetLiteral(aNewLink);</span>
<a href="#l1.543"></a><span id="l1.543">     let old_link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-    if (old_link)</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+    if (old_link) {</span>
<a href="#l1.546"></a><span id="l1.546">       ds.Change(this.resource, FeedUtils.RSS_LINK, old_link, aNewLink);</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-    else</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+    } else {</span>
<a href="#l1.549"></a><span id="l1.549">       ds.Assert(this.resource, FeedUtils.RSS_LINK, aNewLink, true);</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+    }</span>
<a href="#l1.551"></a><span id="l1.551">   },</span>
<a href="#l1.552"></a><span id="l1.552"> </span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-  parse: function()</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-  {</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+  parse() {</span>
<a href="#l1.556"></a><span id="l1.556">     // Create a feed parser which will parse the feed.</span>
<a href="#l1.557"></a><span id="l1.557">     let parser = new FeedParser();</span>
<a href="#l1.558"></a><span id="l1.558">     this.itemsToStore = parser.parseFeed(this, this.request.responseXML);</span>
<a href="#l1.559"></a><span id="l1.559">     parser = null;</span>
<a href="#l1.560"></a><span id="l1.560"> </span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-    if (this.mInvalidFeed)</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-    {</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+    if (this.mInvalidFeed) {</span>
<a href="#l1.564"></a><span id="l1.564">       this.request = null;</span>
<a href="#l1.565"></a><span id="l1.565">       this.mInvalidFeed = false;</span>
<a href="#l1.566"></a><span id="l1.566">       return;</span>
<a href="#l1.567"></a><span id="l1.567">     }</span>
<a href="#l1.568"></a><span id="l1.568"> </span>
<a href="#l1.569"></a><span id="l1.569">     this.itemsToStoreIndex = 0;</span>
<a href="#l1.570"></a><span id="l1.570">     this.itemsStored = 0;</span>
<a href="#l1.571"></a><span id="l1.571"> </span>
<a href="#l1.572"></a><span id="l1.572">     // At this point, if we have items to potentially store and an existing</span>
<a href="#l1.573"></a><span id="l1.573">     // folder, ensure the folder's msgDatabase is openable for new message</span>
<a href="#l1.574"></a><span id="l1.574">     // processing. If not, reparse with an async nsIUrlListener |this| to</span>
<a href="#l1.575"></a><span id="l1.575">     // continue once the reparse is complete.</span>
<a href="#l1.576"></a><span id="l1.576">     if (this.itemsToStore.length &gt; 0 &amp;&amp; this.folder &amp;&amp;</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-        !FeedUtils.isMsgDatabaseOpenable(this.folder, true, this))</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineplus">+        !FeedUtils.isMsgDatabaseOpenable(this.folder, true, this)) {</span>
<a href="#l1.579"></a><span id="l1.579">       return;</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+    }</span>
<a href="#l1.581"></a><span id="l1.581"> </span>
<a href="#l1.582"></a><span id="l1.582">     // We have an msgDatabase; storeNextItem() will iterate through the parsed</span>
<a href="#l1.583"></a><span id="l1.583">     // items, storing each one.</span>
<a href="#l1.584"></a><span id="l1.584">     this.storeNextItem();</span>
<a href="#l1.585"></a><span id="l1.585">   },</span>
<a href="#l1.586"></a><span id="l1.586"> </span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-  invalidateItems: function ()</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-  {</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+  invalidateItems() {</span>
<a href="#l1.590"></a><span id="l1.590">     let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l1.591"></a><span id="l1.591">     FeedUtils.log.debug(&quot;Feed.invalidateItems: for url - &quot; + this.url);</span>
<a href="#l1.592"></a><span id="l1.592">     let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l1.593"></a><span id="l1.593">     let item;</span>
<a href="#l1.594"></a><span id="l1.594"> </span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-    while (items.hasMoreElements())</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-    {</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+    while (items.hasMoreElements()) {</span>
<a href="#l1.598"></a><span id="l1.598">       item = items.getNext();</span>
<a href="#l1.599"></a><span id="l1.599">       item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l1.600"></a><span id="l1.600">       FeedUtils.log.trace(&quot;Feed.invalidateItems: item - &quot; + item.Value);</span>
<a href="#l1.601"></a><span id="l1.601">       let valid = ds.GetTarget(item, FeedUtils.FZ_VALID, true);</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-      if (valid)</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+      if (valid) {</span>
<a href="#l1.604"></a><span id="l1.604">         ds.Unassert(item, FeedUtils.FZ_VALID, valid, true);</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+      }</span>
<a href="#l1.606"></a><span id="l1.606">     }</span>
<a href="#l1.607"></a><span id="l1.607">   },</span>
<a href="#l1.608"></a><span id="l1.608"> </span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-  removeInvalidItems: function(aDeleteFeed)</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-  {</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+  removeInvalidItems(aDeleteFeed) {</span>
<a href="#l1.612"></a><span id="l1.612">     let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l1.613"></a><span id="l1.613">     FeedUtils.log.debug(&quot;Feed.removeInvalidItems: for url - &quot; + this.url);</span>
<a href="#l1.614"></a><span id="l1.614">     let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l1.615"></a><span id="l1.615">     let item;</span>
<a href="#l1.616"></a><span id="l1.616">     let currentTime = new Date().getTime();</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-    while (items.hasMoreElements())</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-    {</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+    while (items.hasMoreElements()) {</span>
<a href="#l1.620"></a><span id="l1.620">       item = items.getNext();</span>
<a href="#l1.621"></a><span id="l1.621">       item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l1.622"></a><span id="l1.622"> </span>
<a href="#l1.623"></a><span id="l1.623">       if (ds.HasAssertion(item, FeedUtils.FZ_VALID,</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-                          FeedUtils.RDF_LITERAL_TRUE, true))</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+                          FeedUtils.RDF_LITERAL_TRUE, true)) {</span>
<a href="#l1.626"></a><span id="l1.626">         continue;</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineplus">+      }</span>
<a href="#l1.628"></a><span id="l1.628"> </span>
<a href="#l1.629"></a><span id="l1.629">       let lastSeenTime = ds.GetTarget(item, FeedUtils.FZ_LAST_SEEN_TIMESTAMP, true);</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-      if (lastSeenTime)</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-        lastSeenTime = parseInt(lastSeenTime.QueryInterface(Ci.nsIRDFLiteral).Value)</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-      else</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+      if (lastSeenTime) {</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+        lastSeenTime = parseInt(lastSeenTime.QueryInterface(Ci.nsIRDFLiteral).Value);</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineplus">+      } else {</span>
<a href="#l1.636"></a><span id="l1.636">         lastSeenTime = 0;</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+      }</span>
<a href="#l1.638"></a><span id="l1.638"> </span>
<a href="#l1.639"></a><span id="l1.639">       if ((currentTime - lastSeenTime) &lt; FeedUtils.INVALID_ITEM_PURGE_DELAY &amp;&amp;</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-          !aDeleteFeed)</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineplus">+          !aDeleteFeed) {</span>
<a href="#l1.642"></a><span id="l1.642">         // Don't immediately purge items in active feeds; do so for deleted feeds.</span>
<a href="#l1.643"></a><span id="l1.643">         continue;</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+      }</span>
<a href="#l1.645"></a><span id="l1.645"> </span>
<a href="#l1.646"></a><span id="l1.646">       FeedUtils.log.trace(&quot;Feed.removeInvalidItems: item - &quot; + item.Value);</span>
<a href="#l1.647"></a><span id="l1.647">       ds.Unassert(item, FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-      if (ds.hasArcOut(item, FeedUtils.FZ_FEED))</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+      if (ds.hasArcOut(item, FeedUtils.FZ_FEED)) {</span>
<a href="#l1.650"></a><span id="l1.650">         FeedUtils.log.debug(&quot;Feed.removeInvalidItems: &quot; + item.Value +</span>
<a href="#l1.651"></a><span id="l1.651">                             &quot; is from more than one feed; only the reference to&quot; +</span>
<a href="#l1.652"></a><span id="l1.652">                             &quot; this feed removed&quot;);</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-      else</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+      } else {</span>
<a href="#l1.655"></a><span id="l1.655">         FeedUtils.removeAssertions(ds, item);</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+      }</span>
<a href="#l1.657"></a><span id="l1.657">     }</span>
<a href="#l1.658"></a><span id="l1.658">   },</span>
<a href="#l1.659"></a><span id="l1.659"> </span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-  createFolder: function()</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-  {</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-    if (this.folder)</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+  createFolder() {</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+    if (this.folder) {</span>
<a href="#l1.665"></a><span id="l1.665">       return;</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+    }</span>
<a href="#l1.667"></a><span id="l1.667"> </span>
<a href="#l1.668"></a><span id="l1.668">     try {</span>
<a href="#l1.669"></a><span id="l1.669">       this.folder = this.server.rootMsgFolder</span>
<a href="#l1.670"></a><span id="l1.670">                                .QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l1.671"></a><span id="l1.671">                                .createLocalSubfolder(this.folderName);</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-    }</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-    catch (ex) {</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+    } catch (ex) {</span>
<a href="#l1.675"></a><span id="l1.675">       // An error creating.</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-      FeedUtils.log.info(&quot;Feed.createFolder: error creating folder - '&quot;+</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-                          this.folderName+&quot;' in parent folder &quot;+</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-                          this.server.rootMsgFolder.filePath.path + &quot; -- &quot;+ex);</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+      FeedUtils.log.info(&quot;Feed.createFolder: error creating folder - '&quot; +</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+                          this.folderName + &quot;' in parent folder &quot; +</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+                          this.server.rootMsgFolder.filePath.path + &quot; -- &quot; + ex);</span>
<a href="#l1.682"></a><span id="l1.682">       // But its remnants are still there, clean up.</span>
<a href="#l1.683"></a><span id="l1.683">       let xfolder = this.server.rootMsgFolder.getChildNamed(this.folderName);</span>
<a href="#l1.684"></a><span id="l1.684">       this.server.rootMsgFolder.propagateDelete(xfolder, true, null);</span>
<a href="#l1.685"></a><span id="l1.685">     }</span>
<a href="#l1.686"></a><span id="l1.686">   },</span>
<a href="#l1.687"></a><span id="l1.687"> </span>
<a href="#l1.688"></a><span id="l1.688">   // Gets the next item from itemsToStore and forces that item to be stored</span>
<a href="#l1.689"></a><span id="l1.689">   // to the folder.  If more items are left to be stored, fires a timer for</span>
<a href="#l1.690"></a><span id="l1.690">   // the next one, otherwise triggers a download done notification to the UI.</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-  storeNextItem: function()</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-  {</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-    if (FeedUtils.CANCEL_REQUESTED)</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-    {</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+  storeNextItem() {</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+    if (FeedUtils.CANCEL_REQUESTED) {</span>
<a href="#l1.697"></a><span id="l1.697">       FeedUtils.CANCEL_REQUESTED = false;</span>
<a href="#l1.698"></a><span id="l1.698">       this.cleanupParsingState(this, FeedUtils.kNewsBlogCancel);</span>
<a href="#l1.699"></a><span id="l1.699">       return;</span>
<a href="#l1.700"></a><span id="l1.700">     }</span>
<a href="#l1.701"></a><span id="l1.701"> </span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-    if (this.itemsToStore.length == 0)</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-    {</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+    if (this.itemsToStore.length == 0) {</span>
<a href="#l1.705"></a><span id="l1.705">       let code = FeedUtils.kNewsBlogSuccess;</span>
<a href="#l1.706"></a><span id="l1.706">       this.createFolder();</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-      if (!this.folder)</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineplus">+      if (!this.folder) {</span>
<a href="#l1.709"></a><span id="l1.709">         code = FeedUtils.kNewsBlogFileError;</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineplus">+      }</span>
<a href="#l1.711"></a><span id="l1.711"> </span>
<a href="#l1.712"></a><span id="l1.712">       this.cleanupParsingState(this, code);</span>
<a href="#l1.713"></a><span id="l1.713">       return;</span>
<a href="#l1.714"></a><span id="l1.714">     }</span>
<a href="#l1.715"></a><span id="l1.715"> </span>
<a href="#l1.716"></a><span id="l1.716">     let item = this.itemsToStore[this.itemsToStoreIndex];</span>
<a href="#l1.717"></a><span id="l1.717"> </span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    if (item.store())</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+    if (item.store()) {</span>
<a href="#l1.720"></a><span id="l1.720">       this.itemsStored++;</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+    }</span>
<a href="#l1.722"></a><span id="l1.722"> </span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-    if (!this.folder)</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-    {</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+    if (!this.folder) {</span>
<a href="#l1.726"></a><span id="l1.726">       this.cleanupParsingState(this, FeedUtils.kNewsBlogFileError);</span>
<a href="#l1.727"></a><span id="l1.727">       return;</span>
<a href="#l1.728"></a><span id="l1.728">     }</span>
<a href="#l1.729"></a><span id="l1.729"> </span>
<a href="#l1.730"></a><span id="l1.730">     this.itemsToStoreIndex++;</span>
<a href="#l1.731"></a><span id="l1.731"> </span>
<a href="#l1.732"></a><span id="l1.732">     // If the listener is tracking progress for each item, report it here.</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-    if (item.feed.downloadCallback &amp;&amp; item.feed.downloadCallback.onFeedItemStored)</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+    if (item.feed.downloadCallback &amp;&amp; item.feed.downloadCallback.onFeedItemStored) {</span>
<a href="#l1.735"></a><span id="l1.735">       item.feed.downloadCallback.onFeedItemStored(item.feed,</span>
<a href="#l1.736"></a><span id="l1.736">                                                   this.itemsToStoreIndex,</span>
<a href="#l1.737"></a><span id="l1.737">                                                   this.itemsToStore.length);</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+    }</span>
<a href="#l1.739"></a><span id="l1.739"> </span>
<a href="#l1.740"></a><span id="l1.740">     // Eventually we'll report individual progress here.</span>
<a href="#l1.741"></a><span id="l1.741"> </span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-    if (this.itemsToStoreIndex &lt; this.itemsToStore.length)</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-    {</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-      if (!this.storeItemsTimer)</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineplus">+    if (this.itemsToStoreIndex &lt; this.itemsToStore.length) {</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+      if (!this.storeItemsTimer) {</span>
<a href="#l1.747"></a><span id="l1.747">         this.storeItemsTimer = Cc[&quot;@mozilla.org/timer;1&quot;].</span>
<a href="#l1.748"></a><span id="l1.748">                                createInstance(Ci.nsITimer);</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineplus">+      }</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineplus">+</span>
<a href="#l1.751"></a><span id="l1.751">       this.storeItemsTimer.initWithCallback(this, 50, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-    }</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-    else</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-    {</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineplus">+    } else {</span>
<a href="#l1.756"></a><span id="l1.756">       // We have just finished downloading one or more feed items into the</span>
<a href="#l1.757"></a><span id="l1.757">       // destination folder; if the folder is still listed as having new</span>
<a href="#l1.758"></a><span id="l1.758">       // messages in it, then we should set the biff state on the folder so the</span>
<a href="#l1.759"></a><span id="l1.759">       // right RDF UI changes happen in the folder pane to indicate new mail.</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-      if (item.feed.folder.hasNewMessages)</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-      {</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineplus">+      if (item.feed.folder.hasNewMessages) {</span>
<a href="#l1.763"></a><span id="l1.763">         item.feed.folder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NewMail;</span>
<a href="#l1.764"></a><span id="l1.764">         // Run the bayesian spam filter, if enabled.</span>
<a href="#l1.765"></a><span id="l1.765">         item.feed.folder.callFilterPlugins(null);</span>
<a href="#l1.766"></a><span id="l1.766">       }</span>
<a href="#l1.767"></a><span id="l1.767"> </span>
<a href="#l1.768"></a><span id="l1.768">       this.cleanupParsingState(this, FeedUtils.kNewsBlogSuccess);</span>
<a href="#l1.769"></a><span id="l1.769">     }</span>
<a href="#l1.770"></a><span id="l1.770">   },</span>
<a href="#l1.771"></a><span id="l1.771"> </span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-  cleanupParsingState: function(aFeed, aCode)</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-  {</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineplus">+  cleanupParsingState(aFeed, aCode) {</span>
<a href="#l1.775"></a><span id="l1.775">     // Now that we are done parsing the feed, remove the feed from the cache.</span>
<a href="#l1.776"></a><span id="l1.776">     FeedCache.removeFeed(aFeed.url);</span>
<a href="#l1.777"></a><span id="l1.777"> </span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-    if (aFeed.parseItems)</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-    {</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+    if (aFeed.parseItems) {</span>
<a href="#l1.781"></a><span id="l1.781">       // Do this only if we're in parse/store mode.</span>
<a href="#l1.782"></a><span id="l1.782">       aFeed.removeInvalidItems(false);</span>
<a href="#l1.783"></a><span id="l1.783"> </span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-      if (aCode == FeedUtils.kNewsBlogSuccess &amp;&amp; aFeed.mLastModified)</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+      if (aCode == FeedUtils.kNewsBlogSuccess &amp;&amp; aFeed.mLastModified) {</span>
<a href="#l1.786"></a><span id="l1.786">         aFeed.lastModified = aFeed.mLastModified;</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+      }</span>
<a href="#l1.788"></a><span id="l1.788"> </span>
<a href="#l1.789"></a><span id="l1.789">       // Flush any feed item changes to disk.</span>
<a href="#l1.790"></a><span id="l1.790">       let ds = FeedUtils.getItemsDS(aFeed.server);</span>
<a href="#l1.791"></a><span id="l1.791">       ds.Flush();</span>
<a href="#l1.792"></a><span id="l1.792">       FeedUtils.log.debug(&quot;Feed.cleanupParsingState: items stored - &quot; + this.itemsStored);</span>
<a href="#l1.793"></a><span id="l1.793">     }</span>
<a href="#l1.794"></a><span id="l1.794"> </span>
<a href="#l1.795"></a><span id="l1.795">     // Force the xml http request to go away.  This helps reduce some nasty</span>
<a href="#l1.796"></a><span id="l1.796">     // assertions on shut down.</span>
<a href="#l1.797"></a><span id="l1.797">     this.request = null;</span>
<a href="#l1.798"></a><span id="l1.798">     this.itemsToStore = [];</span>
<a href="#l1.799"></a><span id="l1.799">     this.itemsToStoreIndex = 0;</span>
<a href="#l1.800"></a><span id="l1.800">     this.storeItemsTimer = null;</span>
<a href="#l1.801"></a><span id="l1.801"> </span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-    if (aFeed.downloadCallback)</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineplus">+    if (aFeed.downloadCallback) {</span>
<a href="#l1.804"></a><span id="l1.804">       aFeed.downloadCallback.downloaded(aFeed, aCode);</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineplus">+    }</span>
<a href="#l1.806"></a><span id="l1.806">   },</span>
<a href="#l1.807"></a><span id="l1.807"> </span>
<a href="#l1.808"></a><span id="l1.808">   // nsITimerCallback</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-  notify: function(aTimer)</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-  {</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineplus">+  notify(aTimer) {</span>
<a href="#l1.812"></a><span id="l1.812">     this.storeNextItem();</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-  }</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineplus">+  },</span>
<a href="#l1.815"></a><span id="l1.815"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,231 +1,213 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l2.5"></a><span id="l2.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-function FeedItem()</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-{</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+function FeedItem() {</span>
<a href="#l2.12"></a><span id="l2.12">   this.mDate = FeedUtils.getValidRFC5322Date();</span>
<a href="#l2.13"></a><span id="l2.13">   this.mParserUtils = Cc[&quot;@mozilla.org/parserutils;1&quot;].getService(Ci.nsIParserUtils);</span>
<a href="#l2.14"></a><span id="l2.14"> }</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-FeedItem.prototype =</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-{</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+FeedItem.prototype = {</span>
<a href="#l2.19"></a><span id="l2.19">   // Only for IETF Atom.</span>
<a href="#l2.20"></a><span id="l2.20">   xmlContentBase: null,</span>
<a href="#l2.21"></a><span id="l2.21">   id: null,</span>
<a href="#l2.22"></a><span id="l2.22">   feed: null,</span>
<a href="#l2.23"></a><span id="l2.23">   description: null,</span>
<a href="#l2.24"></a><span id="l2.24">   content: null,</span>
<a href="#l2.25"></a><span id="l2.25">   enclosures: [],</span>
<a href="#l2.26"></a><span id="l2.26">   title: null,</span>
<a href="#l2.27"></a><span id="l2.27">   author: &quot;anonymous&quot;,</span>
<a href="#l2.28"></a><span id="l2.28">   inReplyTo: &quot;&quot;,</span>
<a href="#l2.29"></a><span id="l2.29">   keywords: [],</span>
<a href="#l2.30"></a><span id="l2.30">   mURL: null,</span>
<a href="#l2.31"></a><span id="l2.31">   characterSet: &quot;UTF-8&quot;,</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">   ENCLOSURE_BOUNDARY_PREFIX: &quot;--------------&quot;, // 14 dashes</span>
<a href="#l2.34"></a><span id="l2.34">   ENCLOSURE_HEADER_BOUNDARY_PREFIX: &quot;------------&quot;, // 12 dashes</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  MESSAGE_TEMPLATE: '\n' +</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    '&lt;html&gt;\n' +</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    '  &lt;head&gt;\n' +</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    '    &lt;title&gt;%TITLE%&lt;/title&gt;\n' +</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    '    &lt;base href=&quot;%BASE%&quot;&gt;\n' +</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    '  &lt;/head&gt;\n' +</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    '  &lt;body id=&quot;msgFeedSummaryBody&quot; selected=&quot;false&quot;&gt;\n' +</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    '    %CONTENT%\n' +</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    '  &lt;/body&gt;\n' +</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    '&lt;/html&gt;\n',</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  MESSAGE_TEMPLATE: &quot;\n&quot; +</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    &quot;&lt;html&gt;\n&quot; +</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    &quot;  &lt;head&gt;\n&quot; +</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    &quot;    &lt;title&gt;%TITLE%&lt;/title&gt;\n&quot; +</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    &quot;    &lt;base href=\&quot;%BASE%\&quot;&gt;\n&quot; +</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    &quot;  &lt;/head&gt;\n&quot; +</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    &quot;  &lt;body id=\&quot;msgFeedSummaryBody\&quot; selected=\&quot;false\&quot;&gt;\n&quot; +</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    &quot;    %CONTENT%\n&quot; +</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    &quot;  &lt;/body&gt;\n&quot; +</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    &quot;&lt;/html&gt;\n&quot;,</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  get url()</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  get url() {</span>
<a href="#l2.59"></a><span id="l2.59">     return this.mURL;</span>
<a href="#l2.60"></a><span id="l2.60">   },</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  set url(aVal)</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    try</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  set url(aVal) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    try {</span>
<a href="#l2.68"></a><span id="l2.68">       this.mURL = Services.io.newURI(aVal).spec;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    }</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    catch(ex)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    } catch (ex) {</span>
<a href="#l2.73"></a><span id="l2.73">       // The url as published or constructed can be a non url.  It's used as a</span>
<a href="#l2.74"></a><span id="l2.74">       // feeditem identifier in feeditems.rdf, as a messageId, and as an href</span>
<a href="#l2.75"></a><span id="l2.75">       // and for the content-base header.  Save as is; ensure not null.</span>
<a href="#l2.76"></a><span id="l2.76">       this.mURL = aVal ? aVal : &quot;&quot;;</span>
<a href="#l2.77"></a><span id="l2.77">     }</span>
<a href="#l2.78"></a><span id="l2.78">   },</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  get date()</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-  {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  get date() {</span>
<a href="#l2.83"></a><span id="l2.83">     return this.mDate;</span>
<a href="#l2.84"></a><span id="l2.84">   },</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  set date (aVal)</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  set date(aVal) {</span>
<a href="#l2.89"></a><span id="l2.89">     this.mDate = aVal;</span>
<a href="#l2.90"></a><span id="l2.90">   },</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-  get identity ()</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    return this.feed.name + &quot;: &quot; + this.title + &quot; (&quot; + this.id + &quot;)&quot;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  get identity() {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    return this.feed.name + &quot;: &quot; + this.title + &quot; (&quot; + this.id + &quot;)&quot;;</span>
<a href="#l2.97"></a><span id="l2.97">   },</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-  normalizeMessageID: function(messageID)</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-  {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  normalizeMessageID(messageID) {</span>
<a href="#l2.102"></a><span id="l2.102">     // Escape occurrences of message ID meta characters &lt;, &gt;, and @.</span>
<a href="#l2.103"></a><span id="l2.103">     messageID.replace(/&lt;/g, &quot;%3C&quot;);</span>
<a href="#l2.104"></a><span id="l2.104">     messageID.replace(/&gt;/g, &quot;%3E&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     messageID.replace(/@/g, &quot;%40&quot;);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    messageID = &quot;&lt;&quot; + messageID.trim() + &quot;@&quot; + &quot;localhost.localdomain&quot; + &quot;&gt;&quot;;</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    messageID = &quot;&lt;&quot; + messageID.trim() + &quot;@localhost.localdomain&gt;&quot;;</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109">     FeedUtils.log.trace(&quot;FeedItem.normalizeMessageID: messageID - &quot; + messageID);</span>
<a href="#l2.110"></a><span id="l2.110">     return messageID;</span>
<a href="#l2.111"></a><span id="l2.111">   },</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-  get itemUniqueURI()</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  {</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  get itemUniqueURI() {</span>
<a href="#l2.116"></a><span id="l2.116">     return this.createURN(this.id);</span>
<a href="#l2.117"></a><span id="l2.117">   },</span>
<a href="#l2.118"></a><span id="l2.118"> </span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-  get contentBase()</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-  {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    if(this.xmlContentBase)</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      return this.xmlContentBase</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-    else</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      return this.mURL;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  get contentBase() {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    if (this.xmlContentBase) {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+      return this.xmlContentBase;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    }</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    return this.mURL;</span>
<a href="#l2.131"></a><span id="l2.131">   },</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  store: function()</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  store() {</span>
<a href="#l2.136"></a><span id="l2.136">     // this.title and this.content contain HTML.</span>
<a href="#l2.137"></a><span id="l2.137">     // this.mUrl and this.contentBase contain plain text.</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139">     let stored = false;</span>
<a href="#l2.140"></a><span id="l2.140">     let resource = this.findStoredResource();</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-    if (!this.feed.folder)</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    if (!this.feed.folder) {</span>
<a href="#l2.143"></a><span id="l2.143">       return stored;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+    }</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    if (resource == null)</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    if (resource == null) {</span>
<a href="#l2.149"></a><span id="l2.149">       resource = FeedUtils.rdf.GetResource(this.itemUniqueURI);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-      if (!this.content)</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-      {</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      if (!this.content) {</span>
<a href="#l2.153"></a><span id="l2.153">         FeedUtils.log.trace(&quot;FeedItem.store: &quot; + this.identity +</span>
<a href="#l2.154"></a><span id="l2.154">                             &quot; no content; storing description or title&quot;);</span>
<a href="#l2.155"></a><span id="l2.155">         this.content = this.description || this.title;</span>
<a href="#l2.156"></a><span id="l2.156">       }</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158">       let content = this.MESSAGE_TEMPLATE;</span>
<a href="#l2.159"></a><span id="l2.159">       content = content.replace(/%TITLE%/, this.title);</span>
<a href="#l2.160"></a><span id="l2.160">       content = content.replace(/%BASE%/, this.htmlEscape(this.contentBase));</span>
<a href="#l2.161"></a><span id="l2.161">       content = content.replace(/%CONTENT%/, this.content);</span>
<a href="#l2.162"></a><span id="l2.162">       this.content = content;</span>
<a href="#l2.163"></a><span id="l2.163">       this.writeToFolder();</span>
<a href="#l2.164"></a><span id="l2.164">       this.markStored(resource);</span>
<a href="#l2.165"></a><span id="l2.165">       stored = true;</span>
<a href="#l2.166"></a><span id="l2.166">     }</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+</span>
<a href="#l2.168"></a><span id="l2.168">     this.markValid(resource);</span>
<a href="#l2.169"></a><span id="l2.169">     return stored;</span>
<a href="#l2.170"></a><span id="l2.170">   },</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-  findStoredResource: function()</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-  {</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  findStoredResource() {</span>
<a href="#l2.175"></a><span id="l2.175">     // Checks to see if the item has already been stored in its feed's</span>
<a href="#l2.176"></a><span id="l2.176">     // message folder.</span>
<a href="#l2.177"></a><span id="l2.177">     FeedUtils.log.trace(&quot;FeedItem.findStoredResource: checking if stored - &quot; +</span>
<a href="#l2.178"></a><span id="l2.178">                         this.identity);</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180">     let server = this.feed.server;</span>
<a href="#l2.181"></a><span id="l2.181">     let folder = this.feed.folder;</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-    if (!folder)</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-    {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    if (!folder) {</span>
<a href="#l2.186"></a><span id="l2.186">       FeedUtils.log.debug(&quot;FeedItem.findStoredResource: folder '&quot; +</span>
<a href="#l2.187"></a><span id="l2.187">                           this.feed.folderName +</span>
<a href="#l2.188"></a><span id="l2.188">                           &quot;' doesn't exist; creating as child of &quot; +</span>
<a href="#l2.189"></a><span id="l2.189">                           server.rootMsgFolder.prettyName + &quot;\n&quot;);</span>
<a href="#l2.190"></a><span id="l2.190">       this.feed.createFolder();</span>
<a href="#l2.191"></a><span id="l2.191">       return null;</span>
<a href="#l2.192"></a><span id="l2.192">     }</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194">     let ds = FeedUtils.getItemsDS(server);</span>
<a href="#l2.195"></a><span id="l2.195">     let itemURI = this.itemUniqueURI;</span>
<a href="#l2.196"></a><span id="l2.196">     let itemResource = FeedUtils.rdf.GetResource(itemURI);</span>
<a href="#l2.197"></a><span id="l2.197"> </span>
<a href="#l2.198"></a><span id="l2.198">     let downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l2.199"></a><span id="l2.199"> </span>
<a href="#l2.200"></a><span id="l2.200">     if (!downloaded ||</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-        downloaded.QueryInterface(Ci.nsIRDFLiteral).Value == &quot;false&quot;)</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    {</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+        downloaded.QueryInterface(Ci.nsIRDFLiteral).Value == &quot;false&quot;) {</span>
<a href="#l2.204"></a><span id="l2.204">       FeedUtils.log.trace(&quot;FeedItem.findStoredResource: not stored&quot;);</span>
<a href="#l2.205"></a><span id="l2.205">       return null;</span>
<a href="#l2.206"></a><span id="l2.206">     }</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208">     FeedUtils.log.trace(&quot;FeedItem.findStoredResource: already stored&quot;);</span>
<a href="#l2.209"></a><span id="l2.209">     return itemResource;</span>
<a href="#l2.210"></a><span id="l2.210">   },</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  markValid: function(resource)</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-  {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+  markValid(resource) {</span>
<a href="#l2.215"></a><span id="l2.215">     let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l2.216"></a><span id="l2.216"> </span>
<a href="#l2.217"></a><span id="l2.217">     let newTimeStamp = FeedUtils.rdf.GetLiteral(new Date().getTime());</span>
<a href="#l2.218"></a><span id="l2.218">     let currentTimeStamp = ds.GetTarget(resource,</span>
<a href="#l2.219"></a><span id="l2.219">                                         FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l2.220"></a><span id="l2.220">                                         true);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-    if (currentTimeStamp)</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+    if (currentTimeStamp) {</span>
<a href="#l2.223"></a><span id="l2.223">       ds.Change(resource, FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l2.224"></a><span id="l2.224">                 currentTimeStamp, newTimeStamp);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-    else</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+    } else {</span>
<a href="#l2.227"></a><span id="l2.227">       ds.Assert(resource, FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l2.228"></a><span id="l2.228">                 newTimeStamp, true);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+    }</span>
<a href="#l2.230"></a><span id="l2.230"> </span>
<a href="#l2.231"></a><span id="l2.231">     if (!ds.HasAssertion(resource, FeedUtils.FZ_FEED,</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-                         FeedUtils.rdf.GetResource(this.feed.url), true))</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+                         FeedUtils.rdf.GetResource(this.feed.url), true)) {</span>
<a href="#l2.234"></a><span id="l2.234">       ds.Assert(resource, FeedUtils.FZ_FEED,</span>
<a href="#l2.235"></a><span id="l2.235">                 FeedUtils.rdf.GetResource(this.feed.url), true);</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    }</span>
<a href="#l2.237"></a><span id="l2.237"> </span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    if (ds.hasArcOut(resource, FeedUtils.FZ_VALID))</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+    if (ds.hasArcOut(resource, FeedUtils.FZ_VALID)) {</span>
<a href="#l2.241"></a><span id="l2.241">       let currentValue = ds.GetTarget(resource, FeedUtils.FZ_VALID, true);</span>
<a href="#l2.242"></a><span id="l2.242">       ds.Change(resource, FeedUtils.FZ_VALID,</span>
<a href="#l2.243"></a><span id="l2.243">                 currentValue, FeedUtils.RDF_LITERAL_TRUE);</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    } else {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_VALID, FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l2.246"></a><span id="l2.246">     }</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-    else</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-      ds.Assert(resource, FeedUtils.FZ_VALID, FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l2.249"></a><span id="l2.249">   },</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-  markStored: function(resource)</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-  {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+  markStored(resource) {</span>
<a href="#l2.254"></a><span id="l2.254">     let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256">     if (!ds.HasAssertion(resource, FeedUtils.FZ_FEED,</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-                         FeedUtils.rdf.GetResource(this.feed.url), true))</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+                         FeedUtils.rdf.GetResource(this.feed.url), true)) {</span>
<a href="#l2.259"></a><span id="l2.259">       ds.Assert(resource, FeedUtils.FZ_FEED,</span>
<a href="#l2.260"></a><span id="l2.260">                 FeedUtils.rdf.GetResource(this.feed.url), true);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+    }</span>
<a href="#l2.262"></a><span id="l2.262"> </span>
<a href="#l2.263"></a><span id="l2.263">     let currentValue;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    if (ds.hasArcOut(resource, FeedUtils.FZ_STORED))</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-    {</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+    if (ds.hasArcOut(resource, FeedUtils.FZ_STORED)) {</span>
<a href="#l2.267"></a><span id="l2.267">       currentValue = ds.GetTarget(resource, FeedUtils.FZ_STORED, true);</span>
<a href="#l2.268"></a><span id="l2.268">       ds.Change(resource, FeedUtils.FZ_STORED,</span>
<a href="#l2.269"></a><span id="l2.269">                 currentValue, FeedUtils.RDF_LITERAL_TRUE);</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-    }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-    else</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+    } else {</span>
<a href="#l2.273"></a><span id="l2.273">       ds.Assert(resource, FeedUtils.FZ_STORED,</span>
<a href="#l2.274"></a><span id="l2.274">                 FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+    }</span>
<a href="#l2.276"></a><span id="l2.276">   },</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-  writeToFolder: function()</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-  {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  writeToFolder() {</span>
<a href="#l2.281"></a><span id="l2.281">     FeedUtils.log.trace(&quot;FeedItem.writeToFolder: &quot; + this.identity +</span>
<a href="#l2.282"></a><span id="l2.282">                         &quot; writing to message folder &quot; + this.feed.name);</span>
<a href="#l2.283"></a><span id="l2.283">     // Convert the title to UTF-16 before performing our HTML entity</span>
<a href="#l2.284"></a><span id="l2.284">     // replacement reg expressions.</span>
<a href="#l2.285"></a><span id="l2.285">     let title = this.title;</span>
<a href="#l2.286"></a><span id="l2.286"> </span>
<a href="#l2.287"></a><span id="l2.287">     // The subject may contain HTML entities.  Convert these to their unencoded</span>
<a href="#l2.288"></a><span id="l2.288">     // state. i.e. &amp;amp; becomes '&amp;'.</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineat">@@ -237,101 +219,98 @@ FeedItem.prototype =</span>
<a href="#l2.290"></a><span id="l2.290"> </span>
<a href="#l2.291"></a><span id="l2.291">     // Compress white space in the subject to make it look better.  Trim</span>
<a href="#l2.292"></a><span id="l2.292">     // leading/trailing spaces to prevent mbox header folding issue at just</span>
<a href="#l2.293"></a><span id="l2.293">     // the right subject length.</span>
<a href="#l2.294"></a><span id="l2.294">     this.title = title.replace(/[\t\r\n]+/g, &quot; &quot;).trim();</span>
<a href="#l2.295"></a><span id="l2.295"> </span>
<a href="#l2.296"></a><span id="l2.296">     // If the date looks like it's in W3C-DTF format, convert it into</span>
<a href="#l2.297"></a><span id="l2.297">     // an IETF standard date.  Otherwise assume it's in IETF format.</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-    if (this.mDate.search(/^\d\d\d\d/) != -1)</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+    if (this.mDate.search(/^\d\d\d\d/) != -1) {</span>
<a href="#l2.300"></a><span id="l2.300">       this.mDate = new Date(this.mDate).toUTCString();</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    }</span>
<a href="#l2.302"></a><span id="l2.302"> </span>
<a href="#l2.303"></a><span id="l2.303">     // If there is an inreplyto value, create the headers.</span>
<a href="#l2.304"></a><span id="l2.304">     let inreplytoHdrsStr = this.inReplyTo ?</span>
<a href="#l2.305"></a><span id="l2.305">       (&quot;References: &quot; + this.inReplyTo + &quot;\n&quot; +</span>
<a href="#l2.306"></a><span id="l2.306">        &quot;In-Reply-To: &quot; + this.inReplyTo + &quot;\n&quot;) : &quot;&quot;;</span>
<a href="#l2.307"></a><span id="l2.307"> </span>
<a href="#l2.308"></a><span id="l2.308">     // If there are keywords (categories), create the headers. In the case of</span>
<a href="#l2.309"></a><span id="l2.309">     // a longer than RFC5322 recommended line length, create multiple folded</span>
<a href="#l2.310"></a><span id="l2.310">     // lines (easier to parse than multiple Keywords headers).</span>
<a href="#l2.311"></a><span id="l2.311">     let keywordsStr = &quot;&quot;;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-    if (this.keywords.length)</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-    {</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+    if (this.keywords.length) {</span>
<a href="#l2.315"></a><span id="l2.315">       let HEADER = &quot;Keywords: &quot;;</span>
<a href="#l2.316"></a><span id="l2.316">       let MAXLEN = 78;</span>
<a href="#l2.317"></a><span id="l2.317">       keywordsStr = HEADER;</span>
<a href="#l2.318"></a><span id="l2.318">       let keyword;</span>
<a href="#l2.319"></a><span id="l2.319">       let keywords = [].concat(this.keywords);</span>
<a href="#l2.320"></a><span id="l2.320">       let lines = [];</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-      while (keywords.length)</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-      {</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      while (keywords.length) {</span>
<a href="#l2.324"></a><span id="l2.324">         keyword = keywords.shift();</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-        if (keywordsStr.length + keyword.length &gt; MAXLEN)</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-        {</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-          lines.push(keywordsStr)</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+        if (keywordsStr.length + keyword.length &gt; MAXLEN) {</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+          lines.push(keywordsStr);</span>
<a href="#l2.330"></a><span id="l2.330">           keywordsStr = &quot; &quot;.repeat(HEADER.length);</span>
<a href="#l2.331"></a><span id="l2.331">         }</span>
<a href="#l2.332"></a><span id="l2.332">         keywordsStr += keyword + &quot;,&quot;;</span>
<a href="#l2.333"></a><span id="l2.333">       }</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-      keywordsStr = keywordsStr.replace(/,$/,&quot;\n&quot;);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-      lines.push(keywordsStr)</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+      keywordsStr = keywordsStr.replace(/,$/, &quot;\n&quot;);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+      lines.push(keywordsStr);</span>
<a href="#l2.338"></a><span id="l2.338">       keywordsStr = lines.join(&quot;\n&quot;);</span>
<a href="#l2.339"></a><span id="l2.339">     }</span>
<a href="#l2.340"></a><span id="l2.340"> </span>
<a href="#l2.341"></a><span id="l2.341">     // Escape occurrences of &quot;From &quot; at the beginning of lines of</span>
<a href="#l2.342"></a><span id="l2.342">     // content per the mbox standard, since &quot;From &quot; denotes a new</span>
<a href="#l2.343"></a><span id="l2.343">     // message, and add a line break so we know the last line has one.</span>
<a href="#l2.344"></a><span id="l2.344">     this.content = this.content.replace(/([\r\n]+)(&gt;*From )/g, &quot;$1&gt;$2&quot;);</span>
<a href="#l2.345"></a><span id="l2.345">     this.content += &quot;\n&quot;;</span>
<a href="#l2.346"></a><span id="l2.346"> </span>
<a href="#l2.347"></a><span id="l2.347">     // The opening line of the message, mandated by standards to start</span>
<a href="#l2.348"></a><span id="l2.348">     // with &quot;From &quot;.  It's useful to construct this separately because</span>
<a href="#l2.349"></a><span id="l2.349">     // we not only need to write it into the message, we also need to</span>
<a href="#l2.350"></a><span id="l2.350">     // use it to calculate the offset of the X-Mozilla-Status lines from</span>
<a href="#l2.351"></a><span id="l2.351">     // the front of the message for the statusOffset property of the</span>
<a href="#l2.352"></a><span id="l2.352">     // DB header object.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-    let openingLine = 'From - ' + this.mDate + '\n';</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    let openingLine = &quot;From - &quot; + this.mDate + &quot;\n&quot;;</span>
<a href="#l2.355"></a><span id="l2.355"> </span>
<a href="#l2.356"></a><span id="l2.356">     let source =</span>
<a href="#l2.357"></a><span id="l2.357">       openingLine +</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-      'X-Mozilla-Status: 0000\n' +</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-      'X-Mozilla-Status2: 00000000\n' +</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-      'X-Mozilla-Keys: ' + &quot; &quot;.repeat(80) + '\n' +</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-      'Received: by localhost; ' + FeedUtils.getValidRFC5322Date() + '\n' +</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-      'Date: ' + this.mDate + '\n' +</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-      'Message-Id: ' + this.normalizeMessageID(this.id) + '\n' +</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-      'From: ' + this.author + '\n' +</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      'MIME-Version: 1.0\n' +</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-      'Subject: ' + this.title + '\n' +</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+      &quot;X-Mozilla-Status: 0000\n&quot; +</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+      &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+      &quot;X-Mozilla-Keys: &quot; + &quot; &quot;.repeat(80) + &quot;\n&quot; +</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      &quot;Received: by localhost; &quot; + FeedUtils.getValidRFC5322Date() + &quot;\n&quot; +</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+      &quot;Date: &quot; + this.mDate + &quot;\n&quot; +</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+      &quot;Message-Id: &quot; + this.normalizeMessageID(this.id) + &quot;\n&quot; +</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+      &quot;From: &quot; + this.author + &quot;\n&quot; +</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+      &quot;MIME-Version: 1.0\n&quot; +</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+      &quot;Subject: &quot; + this.title + &quot;\n&quot; +</span>
<a href="#l2.376"></a><span id="l2.376">       inreplytoHdrsStr +</span>
<a href="#l2.377"></a><span id="l2.377">       keywordsStr +</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-      'Content-Transfer-Encoding: 8bit\n' +</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-      'Content-Base: ' + this.mURL + '\n';</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+      &quot;Content-Transfer-Encoding: 8bit\n&quot; +</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+      &quot;Content-Base: &quot; + this.mURL + &quot;\n&quot;;</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-    if (this.enclosures.length)</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-    {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+    if (this.enclosures.length) {</span>
<a href="#l2.386"></a><span id="l2.386">       let boundaryID = source.length;</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-      source += 'Content-Type: multipart/mixed; boundary=&quot;' +</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-                this.ENCLOSURE_HEADER_BOUNDARY_PREFIX + boundaryID + '&quot;' + '\n\n' +</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-                'This is a multi-part message in MIME format.\n' +</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-                this.ENCLOSURE_BOUNDARY_PREFIX + boundaryID + '\n' +</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-                'Content-Type: text/html; charset=' + this.characterSet + '\n' +</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-                'Content-Transfer-Encoding: 8bit\n' +</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+      source += &quot;Content-Type: multipart/mixed; boundary=\&quot;&quot; +</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+                this.ENCLOSURE_HEADER_BOUNDARY_PREFIX + boundaryID + &quot;\&quot;\n\n&quot; +</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+                &quot;This is a multi-part message in MIME format.\n&quot; +</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+                this.ENCLOSURE_BOUNDARY_PREFIX + boundaryID + &quot;\n&quot; +</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+                &quot;Content-Type: text/html; charset=&quot; + this.characterSet + &quot;\n&quot; +</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+                &quot;Content-Transfer-Encoding: 8bit\n&quot; +</span>
<a href="#l2.399"></a><span id="l2.399">                 this.content;</span>
<a href="#l2.400"></a><span id="l2.400"> </span>
<a href="#l2.401"></a><span id="l2.401">       this.enclosures.forEach(function(enclosure) {</span>
<a href="#l2.402"></a><span id="l2.402">         source += enclosure.convertToAttachment(boundaryID);</span>
<a href="#l2.403"></a><span id="l2.403">       });</span>
<a href="#l2.404"></a><span id="l2.404"> </span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-      source += this.ENCLOSURE_BOUNDARY_PREFIX + boundaryID + '--' + '\n\n\n';</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+      source += this.ENCLOSURE_BOUNDARY_PREFIX + boundaryID + &quot;--\n\n\n&quot;;</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+    } else {</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+      source += &quot;Content-Type: text/html; charset=&quot; + this.characterSet + &quot;\n&quot; +</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+                this.content;</span>
<a href="#l2.410"></a><span id="l2.410">     }</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-    else</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-      source += 'Content-Type: text/html; charset=' + this.characterSet + '\n' +</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-                this.content;</span>
<a href="#l2.414"></a><span id="l2.414"> </span>
<a href="#l2.415"></a><span id="l2.415">     FeedUtils.log.trace(&quot;FeedItem.writeToFolder: &quot; + this.identity +</span>
<a href="#l2.416"></a><span id="l2.416">                         &quot; is &quot; + source.length + &quot; characters long&quot;);</span>
<a href="#l2.417"></a><span id="l2.417"> </span>
<a href="#l2.418"></a><span id="l2.418">     // Get the folder and database storing the feed's messages and headers.</span>
<a href="#l2.419"></a><span id="l2.419">     let folder = this.feed.folder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l2.420"></a><span id="l2.420">     let msgFolder = folder.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l2.421"></a><span id="l2.421">     msgFolder.gettingNewMessages = true;</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineat">@@ -342,125 +321,116 @@ FeedItem.prototype =</span>
<a href="#l2.423"></a><span id="l2.423">     msgDBHdr.OrFlags(Ci.nsMsgMessageFlags.FeedMsg);</span>
<a href="#l2.424"></a><span id="l2.424">     msgFolder.gettingNewMessages = false;</span>
<a href="#l2.425"></a><span id="l2.425">     this.tagItem(msgDBHdr, this.keywords);</span>
<a href="#l2.426"></a><span id="l2.426">   },</span>
<a href="#l2.427"></a><span id="l2.427"> </span>
<a href="#l2.428"></a><span id="l2.428"> /**</span>
<a href="#l2.429"></a><span id="l2.429">  * Autotag messages.</span>
<a href="#l2.430"></a><span id="l2.430">  *</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">- * @param  nsIMsgDBHdr aMsgDBHdr - message to tag</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">- * @param  array aKeywords       - keywords (tags)</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+ * @param  {nsIMsgDBHdr} aMsgDBHdr - message to tag</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+ * @param  {Array} aKeywords       - keywords (tags)</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+ * @returns {void}</span>
<a href="#l2.436"></a><span id="l2.436">  */</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-  tagItem: function(aMsgDBHdr, aKeywords)</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-  {</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+  tagItem(aMsgDBHdr, aKeywords) {</span>
<a href="#l2.440"></a><span id="l2.440">     let category = this.feed.options.category;</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    if (!aKeywords.length || !category.enabled)</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+    if (!aKeywords.length || !category.enabled) {</span>
<a href="#l2.443"></a><span id="l2.443">       return;</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+    }</span>
<a href="#l2.445"></a><span id="l2.445"> </span>
<a href="#l2.446"></a><span id="l2.446">     let msgArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l2.447"></a><span id="l2.447">     msgArray.appendElement(aMsgDBHdr);</span>
<a href="#l2.448"></a><span id="l2.448"> </span>
<a href="#l2.449"></a><span id="l2.449">     let prefix = category.prefixEnabled ? category.prefix : &quot;&quot;;</span>
<a href="#l2.450"></a><span id="l2.450">     let rtl = Services.prefs.getIntPref(&quot;bidi.direction&quot;) == 2;</span>
<a href="#l2.451"></a><span id="l2.451"> </span>
<a href="#l2.452"></a><span id="l2.452">     let keys = [];</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-    for (let keyword of aKeywords)</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-    {</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+    for (let keyword of aKeywords) {</span>
<a href="#l2.456"></a><span id="l2.456">       keyword = rtl ? keyword + prefix : prefix + keyword;</span>
<a href="#l2.457"></a><span id="l2.457">       let keyForTag = MailServices.tags.getKeyForTag(keyword);</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-      if (!keyForTag)</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-      {</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+      if (!keyForTag) {</span>
<a href="#l2.461"></a><span id="l2.461">         // Add the tag if it doesn't exist.</span>
<a href="#l2.462"></a><span id="l2.462">         MailServices.tags.addTag(keyword, &quot;&quot;, FeedUtils.AUTOTAG);</span>
<a href="#l2.463"></a><span id="l2.463">         keyForTag = MailServices.tags.getKeyForTag(keyword);</span>
<a href="#l2.464"></a><span id="l2.464">       }</span>
<a href="#l2.465"></a><span id="l2.465"> </span>
<a href="#l2.466"></a><span id="l2.466">       // Add the tag key to the keys array.</span>
<a href="#l2.467"></a><span id="l2.467">       keys.push(keyForTag);</span>
<a href="#l2.468"></a><span id="l2.468">     }</span>
<a href="#l2.469"></a><span id="l2.469"> </span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-    if (keys.length)</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+    if (keys.length) {</span>
<a href="#l2.472"></a><span id="l2.472">       // Add the keys to the message.</span>
<a href="#l2.473"></a><span id="l2.473">       aMsgDBHdr.folder.addKeywordsToMessages(msgArray, keys.join(&quot; &quot;));</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+    }</span>
<a href="#l2.475"></a><span id="l2.475">   },</span>
<a href="#l2.476"></a><span id="l2.476"> </span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-  htmlEscape: function(s)</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-  {</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+  htmlEscape(s) {</span>
<a href="#l2.480"></a><span id="l2.480">     s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l2.481"></a><span id="l2.481">     s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l2.482"></a><span id="l2.482">     s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l2.483"></a><span id="l2.483">     s = s.replace(/'/g, &quot;&amp;#39;&quot;);</span>
<a href="#l2.484"></a><span id="l2.484">     s = s.replace(/&quot;/g, &quot;&amp;quot;&quot;);</span>
<a href="#l2.485"></a><span id="l2.485">     return s;</span>
<a href="#l2.486"></a><span id="l2.486">   },</span>
<a href="#l2.487"></a><span id="l2.487"> </span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-  createURN: function(aName)</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-  {</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+  createURN(aName) {</span>
<a href="#l2.491"></a><span id="l2.491">     // Returns name as a URN in the 'feeditem' namespace. The returned URN is</span>
<a href="#l2.492"></a><span id="l2.492">     // (or is intended to be) RFC2141 compliant.</span>
<a href="#l2.493"></a><span id="l2.493">     // The builtin encodeURI provides nearly the exact encoding functionality</span>
<a href="#l2.494"></a><span id="l2.494">     // required by the RFC.  The exceptions are that NULL characters should not</span>
<a href="#l2.495"></a><span id="l2.495">     // appear, and that #, /, ?, &amp;, and ~ should be escaped.</span>
<a href="#l2.496"></a><span id="l2.496">     // NULL characters are removed before encoding.</span>
<a href="#l2.497"></a><span id="l2.497"> </span>
<a href="#l2.498"></a><span id="l2.498">     let name = aName.replace(/\0/g, &quot;&quot;);</span>
<a href="#l2.499"></a><span id="l2.499">     let encoded = encodeURI(name);</span>
<a href="#l2.500"></a><span id="l2.500">     encoded = encoded.replace(/\#/g, &quot;%23&quot;);</span>
<a href="#l2.501"></a><span id="l2.501">     encoded = encoded.replace(/\//g, &quot;%2f&quot;);</span>
<a href="#l2.502"></a><span id="l2.502">     encoded = encoded.replace(/\?/g, &quot;%3f&quot;);</span>
<a href="#l2.503"></a><span id="l2.503">     encoded = encoded.replace(/\&amp;/g, &quot;%26&quot;);</span>
<a href="#l2.504"></a><span id="l2.504">     encoded = encoded.replace(/\~/g, &quot;%7e&quot;);</span>
<a href="#l2.505"></a><span id="l2.505"> </span>
<a href="#l2.506"></a><span id="l2.506">     return FeedUtils.FZ_ITEM_NS + encoded;</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-  }</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+  },</span>
<a href="#l2.509"></a><span id="l2.509"> };</span>
<a href="#l2.510"></a><span id="l2.510"> </span>
<a href="#l2.511"></a><span id="l2.511"> </span>
<a href="#l2.512"></a><span id="l2.512"> // A feed enclosure is to RSS what an attachment is for e-mail.  We make</span>
<a href="#l2.513"></a><span id="l2.513"> // enclosures look like attachments in the UI.</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-function FeedEnclosure(aURL, aContentType, aLength, aTitle)</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-{</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+function FeedEnclosure(aURL, aContentType, aLength, aTitle) {</span>
<a href="#l2.517"></a><span id="l2.517">   this.mURL = aURL;</span>
<a href="#l2.518"></a><span id="l2.518">   // Store a reasonable mimetype if content-type is not present.</span>
<a href="#l2.519"></a><span id="l2.519">   this.mContentType = aContentType || &quot;application/unknown&quot;;</span>
<a href="#l2.520"></a><span id="l2.520">   this.mLength = aLength;</span>
<a href="#l2.521"></a><span id="l2.521">   this.mTitle = aTitle;</span>
<a href="#l2.522"></a><span id="l2.522"> </span>
<a href="#l2.523"></a><span id="l2.523">   // Generate a fileName from the URL.</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-  if (this.mURL)</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-  {</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-    try</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-    {</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+  if (this.mURL) {</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineplus">+    try {</span>
<a href="#l2.530"></a><span id="l2.530">       this.mFileName = Services.io.newURI(this.mURL).</span>
<a href="#l2.531"></a><span id="l2.531">                                    QueryInterface(Ci.nsIURL).</span>
<a href="#l2.532"></a><span id="l2.532">                                    fileName;</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    }</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    catch(ex)</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-    {</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+    } catch (ex) {</span>
<a href="#l2.537"></a><span id="l2.537">       this.mFileName = this.mURL;</span>
<a href="#l2.538"></a><span id="l2.538">     }</span>
<a href="#l2.539"></a><span id="l2.539">   }</span>
<a href="#l2.540"></a><span id="l2.540"> }</span>
<a href="#l2.541"></a><span id="l2.541"> </span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-FeedEnclosure.prototype =</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-{</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+FeedEnclosure.prototype = {</span>
<a href="#l2.545"></a><span id="l2.545">   mURL: &quot;&quot;,</span>
<a href="#l2.546"></a><span id="l2.546">   mContentType: &quot;&quot;,</span>
<a href="#l2.547"></a><span id="l2.547">   mLength: 0,</span>
<a href="#l2.548"></a><span id="l2.548">   mFileName: &quot;&quot;,</span>
<a href="#l2.549"></a><span id="l2.549">   mTitle: &quot;&quot;,</span>
<a href="#l2.550"></a><span id="l2.550">   ENCLOSURE_BOUNDARY_PREFIX: &quot;--------------&quot;, // 14 dashes</span>
<a href="#l2.551"></a><span id="l2.551"> </span>
<a href="#l2.552"></a><span id="l2.552">   // Returns a string that looks like an e-mail attachment which represents</span>
<a href="#l2.553"></a><span id="l2.553">   // the enclosure.</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-  convertToAttachment: function(aBoundaryID)</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-  {</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-    return '\n' +</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-      this.ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + '\n' +</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-      'Content-Type: ' + this.mContentType +</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-                     '; name=&quot;' + (this.mTitle || this.mFileName) +</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-                     (this.mLength ? '&quot;; size=' + this.mLength : '&quot;') + '\n' +</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-      'X-Mozilla-External-Attachment-URL: ' + this.mURL + '\n' +</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-      'Content-Disposition: attachment; filename=&quot;' + this.mFileName + '&quot;\n\n' +</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-      FeedUtils.strings.GetStringFromName(&quot;externalAttachmentMsg&quot;) + '\n';</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-  }</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+  convertToAttachment(aBoundaryID) {</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+    return &quot;\n&quot; +</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+      this.ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + &quot;\n&quot; +</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+      &quot;Content-Type: &quot; + this.mContentType +</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+                     &quot;; name=\&quot;&quot; + (this.mTitle || this.mFileName) +</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineplus">+                     (this.mLength ? &quot;\&quot;; size=&quot; + this.mLength : &quot;\&quot;&quot;) + &quot;\n&quot; +</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+      &quot;X-Mozilla-External-Attachment-URL: &quot; + this.mURL + &quot;\n&quot; +</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+      &quot;Content-Disposition: attachment; filename=\&quot;&quot; + this.mFileName + &quot;\&quot;\n\n&quot; +</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+      FeedUtils.strings.GetStringFromName(&quot;externalAttachmentMsg&quot;) + &quot;\n&quot;;</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+  },</span>
<a href="#l2.575"></a><span id="l2.575"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l3.5"></a><span id="l3.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> this.EXPORTED_SYMBOLS = [&quot;Feed&quot;, &quot;FeedItem&quot;, &quot;FeedParser&quot;, &quot;FeedUtils&quot;];</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+/* eslint-disable-next-line no-unused-vars */</span>
<a href="#l3.12"></a><span id="l3.12"> ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.18"></a><span id="l3.18"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineat">@@ -17,68 +18,70 @@ Cu.importGlobalProperties([&quot;XMLHttpReque</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/Feed.js&quot;);</span>
<a href="#l3.23"></a><span id="l3.23"> Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/FeedItem.js&quot;);</span>
<a href="#l3.24"></a><span id="l3.24"> Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/feed-parser.js&quot;);</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> var FeedUtils = {</span>
<a href="#l3.27"></a><span id="l3.27">   MOZ_PARSERERROR_NS: &quot;http://www.mozilla.org/newlayout/xml/parsererror.xml&quot;,</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  /* eslint-disable no-multi-spaces */</span>
<a href="#l3.30"></a><span id="l3.30">   RDF_SYNTAX_NS: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;,</span>
<a href="#l3.31"></a><span id="l3.31">   RDF_SYNTAX_TYPE: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  get RDF_TYPE() { return this.rdf.GetResource(this.RDF_SYNTAX_TYPE) },</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  get RDF_TYPE() { return this.rdf.GetResource(this.RDF_SYNTAX_TYPE); },</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   RSS_090_NS: &quot;http://my.netscape.com/rdf/simple/0.9/&quot;,</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   RSS_NS: &quot;http://purl.org/rss/1.0/&quot;,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  get RSS_CHANNEL()     { return this.rdf.GetResource(this.RSS_NS + &quot;channel&quot;) },</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  get RSS_TITLE()       { return this.rdf.GetResource(this.RSS_NS + &quot;title&quot;) },</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  get RSS_DESCRIPTION() { return this.rdf.GetResource(this.RSS_NS + &quot;description&quot;) },</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  get RSS_ITEMS()       { return this.rdf.GetResource(this.RSS_NS + &quot;items&quot;) },</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  get RSS_ITEM()        { return this.rdf.GetResource(this.RSS_NS + &quot;item&quot;) },</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  get RSS_LINK()        { return this.rdf.GetResource(this.RSS_NS + &quot;link&quot;) },</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  get RSS_CHANNEL()     { return this.rdf.GetResource(this.RSS_NS + &quot;channel&quot;); },</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  get RSS_TITLE()       { return this.rdf.GetResource(this.RSS_NS + &quot;title&quot;); },</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  get RSS_DESCRIPTION() { return this.rdf.GetResource(this.RSS_NS + &quot;description&quot;); },</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  get RSS_ITEMS()       { return this.rdf.GetResource(this.RSS_NS + &quot;items&quot;); },</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  get RSS_ITEM()        { return this.rdf.GetResource(this.RSS_NS + &quot;item&quot;); },</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  get RSS_LINK()        { return this.rdf.GetResource(this.RSS_NS + &quot;link&quot;); },</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">   RSS_CONTENT_NS: &quot;http://purl.org/rss/1.0/modules/content/&quot;,</span>
<a href="#l3.52"></a><span id="l3.52">   get RSS_CONTENT_ENCODED() {</span>
<a href="#l3.53"></a><span id="l3.53">     return this.rdf.GetResource(this.RSS_CONTENT_NS + &quot;encoded&quot;);</span>
<a href="#l3.54"></a><span id="l3.54">   },</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">   RSS_SY_NS: &quot;http://purl.org/rss/1.0/modules/syndication/&quot;,</span>
<a href="#l3.57"></a><span id="l3.57">   RSS_SY_UNITS:      [&quot;hourly&quot;, &quot;daily&quot;, &quot;weekly&quot;, &quot;monthly&quot;, &quot;yearly&quot;],</span>
<a href="#l3.58"></a><span id="l3.58">   kBiffUnitsMinutes: &quot;min&quot;,</span>
<a href="#l3.59"></a><span id="l3.59">   kBiffUnitsDays:    &quot;d&quot;,</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">   DC_NS: &quot;http://purl.org/dc/elements/1.1/&quot;,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  get DC_CREATOR()      { return this.rdf.GetResource(this.DC_NS + &quot;creator&quot;) },</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  get DC_SUBJECT()      { return this.rdf.GetResource(this.DC_NS + &quot;subject&quot;) },</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  get DC_DATE()         { return this.rdf.GetResource(this.DC_NS + &quot;date&quot;) },</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  get DC_TITLE()        { return this.rdf.GetResource(this.DC_NS + &quot;title&quot;) },</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  get DC_LASTMODIFIED() { return this.rdf.GetResource(this.DC_NS + &quot;lastModified&quot;) },</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  get DC_IDENTIFIER()   { return this.rdf.GetResource(this.DC_NS + &quot;identifier&quot;) },</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  get DC_CREATOR()      { return this.rdf.GetResource(this.DC_NS + &quot;creator&quot;); },</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  get DC_SUBJECT()      { return this.rdf.GetResource(this.DC_NS + &quot;subject&quot;); },</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  get DC_DATE()         { return this.rdf.GetResource(this.DC_NS + &quot;date&quot;); },</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  get DC_TITLE()        { return this.rdf.GetResource(this.DC_NS + &quot;title&quot;); },</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  get DC_LASTMODIFIED() { return this.rdf.GetResource(this.DC_NS + &quot;lastModified&quot;); },</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  get DC_IDENTIFIER()   { return this.rdf.GetResource(this.DC_NS + &quot;identifier&quot;); },</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">   MRSS_NS: &quot;http://search.yahoo.com/mrss/&quot;,</span>
<a href="#l3.76"></a><span id="l3.76">   FEEDBURNER_NS: &quot;http://rssnamespace.org/feedburner/ext/1.0&quot;,</span>
<a href="#l3.77"></a><span id="l3.77">   ITUNES_NS: &quot;http://www.itunes.com/dtds/podcast-1.0.dtd&quot;,</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">   FZ_NS: &quot;urn:forumzilla:&quot;,</span>
<a href="#l3.80"></a><span id="l3.80">   FZ_ITEM_NS: &quot;urn:feeditem:&quot;,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-  get FZ_ROOT()       { return this.rdf.GetResource(this.FZ_NS + &quot;root&quot;) },</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  get FZ_FEEDS()      { return this.rdf.GetResource(this.FZ_NS + &quot;feeds&quot;) },</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  get FZ_FEED()       { return this.rdf.GetResource(this.FZ_NS + &quot;feed&quot;) },</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  get FZ_QUICKMODE()  { return this.rdf.GetResource(this.FZ_NS + &quot;quickMode&quot;) },</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  get FZ_DESTFOLDER() { return this.rdf.GetResource(this.FZ_NS + &quot;destFolder&quot;) },</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  get FZ_STORED()     { return this.rdf.GetResource(this.FZ_NS + &quot;stored&quot;) },</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  get FZ_VALID()      { return this.rdf.GetResource(this.FZ_NS + &quot;valid&quot;) },</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  get FZ_ROOT()       { return this.rdf.GetResource(this.FZ_NS + &quot;root&quot;); },</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  get FZ_FEEDS()      { return this.rdf.GetResource(this.FZ_NS + &quot;feeds&quot;); },</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  get FZ_FEED()       { return this.rdf.GetResource(this.FZ_NS + &quot;feed&quot;); },</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  get FZ_QUICKMODE()  { return this.rdf.GetResource(this.FZ_NS + &quot;quickMode&quot;); },</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  get FZ_DESTFOLDER() { return this.rdf.GetResource(this.FZ_NS + &quot;destFolder&quot;); },</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  get FZ_STORED()     { return this.rdf.GetResource(this.FZ_NS + &quot;stored&quot;); },</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  get FZ_VALID()      { return this.rdf.GetResource(this.FZ_NS + &quot;valid&quot;); },</span>
<a href="#l3.95"></a><span id="l3.95">   get FZ_OPTIONS()    { return this.rdf.GetResource(this.FZ_NS + &quot;options&quot;); },</span>
<a href="#l3.96"></a><span id="l3.96">   get FZ_LAST_SEEN_TIMESTAMP() {</span>
<a href="#l3.97"></a><span id="l3.97">     return this.rdf.GetResource(this.FZ_NS + &quot;last-seen-timestamp&quot;);</span>
<a href="#l3.98"></a><span id="l3.98">   },</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  get RDF_LITERAL_TRUE()  { return this.rdf.GetLiteral(&quot;true&quot;) },</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  get RDF_LITERAL_FALSE() { return this.rdf.GetLiteral(&quot;false&quot;) },</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  get RDF_LITERAL_TRUE()  { return this.rdf.GetLiteral(&quot;true&quot;); },</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  get RDF_LITERAL_FALSE() { return this.rdf.GetLiteral(&quot;false&quot;); },</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  /* eslint-enable no-multi-spaces */</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">   // Atom constants</span>
<a href="#l3.107"></a><span id="l3.107">   ATOM_03_NS: &quot;http://purl.org/atom/ns#&quot;,</span>
<a href="#l3.108"></a><span id="l3.108">   ATOM_IETF_NS: &quot;http://www.w3.org/2005/Atom&quot;,</span>
<a href="#l3.109"></a><span id="l3.109">   ATOM_THREAD_NS: &quot;http://purl.org/syndication/thread/1.0&quot;,</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">   // Accept content mimetype preferences for feeds.</span>
<a href="#l3.112"></a><span id="l3.112">   REQUEST_ACCEPT: &quot;application/atom+xml,&quot; +</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -90,31 +93,33 @@ var FeedUtils = {</span>
<a href="#l3.114"></a><span id="l3.114">   REQUEST_TIMEOUT: 30 * 1000,</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">   MILLISECONDS_PER_DAY: 24 * 60 * 60 * 1000,</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118">   // Maximum number of concurrent in progress feeds, across all accounts.</span>
<a href="#l3.119"></a><span id="l3.119">   kMaxConcurrentFeeds: 25,</span>
<a href="#l3.120"></a><span id="l3.120">   get MAX_CONCURRENT_FEEDS() {</span>
<a href="#l3.121"></a><span id="l3.121">     let pref = &quot;rss.max_concurrent_feeds&quot;;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    if (Services.prefs.prefHasUserValue(pref))</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    if (Services.prefs.prefHasUserValue(pref)) {</span>
<a href="#l3.124"></a><span id="l3.124">       return Services.prefs.getIntPref(pref);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+    }</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">     Services.prefs.setIntPref(pref, FeedUtils.kMaxConcurrentFeeds);</span>
<a href="#l3.128"></a><span id="l3.128">     return FeedUtils.kMaxConcurrentFeeds;</span>
<a href="#l3.129"></a><span id="l3.129">   },</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131">   // The amount of time, specified in milliseconds, to leave an item in the</span>
<a href="#l3.132"></a><span id="l3.132">   // feeditems.rdf cache after the item has disappeared from the publisher's</span>
<a href="#l3.133"></a><span id="l3.133">   // file. The default delay is one day.</span>
<a href="#l3.134"></a><span id="l3.134">   kInvalidItemPurgeDelayDays: 1,</span>
<a href="#l3.135"></a><span id="l3.135">   get INVALID_ITEM_PURGE_DELAY() {</span>
<a href="#l3.136"></a><span id="l3.136">     let pref = &quot;rss.invalid_item_purge_delay_days&quot;;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    if (Services.prefs.prefHasUserValue(pref))</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    if (Services.prefs.prefHasUserValue(pref)) {</span>
<a href="#l3.139"></a><span id="l3.139">       return Services.prefs.getIntPref(pref) * this.MILLISECONDS_PER_DAY;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    }</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142">     Services.prefs.setIntPref(pref, FeedUtils.kInvalidItemPurgeDelayDays);</span>
<a href="#l3.143"></a><span id="l3.143">     return FeedUtils.kInvalidItemPurgeDelayDays * this.MILLISECONDS_PER_DAY;</span>
<a href="#l3.144"></a><span id="l3.144">   },</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146">   // Polling inverval to check individual feed update interval preference.</span>
<a href="#l3.147"></a><span id="l3.147">   kBiffPollMinutes: 1,</span>
<a href="#l3.148"></a><span id="l3.148">   kNewsBlogSuccess: 0,</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineat">@@ -130,55 +135,56 @@ var FeedUtils = {</span>
<a href="#l3.150"></a><span id="l3.150">   // Invalid certificate, for overridable user exception errors.</span>
<a href="#l3.151"></a><span id="l3.151">   kNewsBlogBadCertError: 7,</span>
<a href="#l3.152"></a><span id="l3.152">   // For 401 Unauthorized or 403 Forbidden.</span>
<a href="#l3.153"></a><span id="l3.153">   kNewsBlogNoAuthError: 8,</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">   CANCEL_REQUESTED: false,</span>
<a href="#l3.156"></a><span id="l3.156">   AUTOTAG: &quot;~AUTOTAG&quot;,</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-/**</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">- * Get all rss account servers rootFolders.</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">- *</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">- * @return array of nsIMsgIncomingServer (empty array if none).</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">- */</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  getAllRssServerRootFolders: function() {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  /**</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+   * Get all rss account servers rootFolders.</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+   *</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+   * @returns {nsIMsgIncomingServer}[] - Array of servers (empty array if none).</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+   */</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  getAllRssServerRootFolders() {</span>
<a href="#l3.170"></a><span id="l3.170">     let rssRootFolders = [];</span>
<a href="#l3.171"></a><span id="l3.171">     let allServers = MailServices.accounts.allServers;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; i++)</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+    for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l3.175"></a><span id="l3.175">       let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-      if (server &amp;&amp; server.type == &quot;rss&quot;)</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+      if (server &amp;&amp; server.type == &quot;rss&quot;) {</span>
<a href="#l3.178"></a><span id="l3.178">         rssRootFolders.push(server.rootFolder);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+      }</span>
<a href="#l3.180"></a><span id="l3.180">     }</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182">     // By default, Tb sorts by hostname, ie Feeds, Feeds-1, and not by alpha</span>
<a href="#l3.183"></a><span id="l3.183">     // prettyName.  Do the same as a stock install to match folderpane order.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-    rssRootFolders.sort(function(a, b) { return a.hostname &gt; b.hostname });</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+    rssRootFolders.sort(function(a, b) { return a.hostname &gt; b.hostname; });</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187">     return rssRootFolders;</span>
<a href="#l3.188"></a><span id="l3.188">   },</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-/**</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">- * Create rss account.</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">- *</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">- * @param  string [aName] - optional account name to override default.</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">- * @return nsIMsgAccount.</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">- */</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  createRssAccount: function(aName) {</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+  /**</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+   * Create rss account.</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+   *</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+   * @param {String} aName     - Optional account name to override default.</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+   * @returns {nsIMsgAccount}  - The creaged account.</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+   */</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  createRssAccount(aName) {</span>
<a href="#l3.204"></a><span id="l3.204">     let userName = &quot;nobody&quot;;</span>
<a href="#l3.205"></a><span id="l3.205">     let hostName = &quot;Feeds&quot;;</span>
<a href="#l3.206"></a><span id="l3.206">     let hostNamePref = hostName;</span>
<a href="#l3.207"></a><span id="l3.207">     let server;</span>
<a href="#l3.208"></a><span id="l3.208">     let serverType = &quot;rss&quot;;</span>
<a href="#l3.209"></a><span id="l3.209">     let defaultName = FeedUtils.strings.GetStringFromName(&quot;feeds-accountname&quot;);</span>
<a href="#l3.210"></a><span id="l3.210">     let i = 2;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    while (MailServices.accounts.findRealServer(userName, hostName, serverType, 0))</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    while (MailServices.accounts.findRealServer(userName, hostName, serverType, 0)) {</span>
<a href="#l3.213"></a><span id="l3.213">       // If &quot;Feeds&quot; exists, try &quot;Feeds-2&quot;, then &quot;Feeds-3&quot;, etc.</span>
<a href="#l3.214"></a><span id="l3.214">       hostName = hostNamePref + &quot;-&quot; + i++;</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    }</span>
<a href="#l3.216"></a><span id="l3.216"> </span>
<a href="#l3.217"></a><span id="l3.217">     server = MailServices.accounts.createIncomingServer(userName, hostName, serverType);</span>
<a href="#l3.218"></a><span id="l3.218">     server.biffMinutes = FeedUtils.kBiffPollMinutes;</span>
<a href="#l3.219"></a><span id="l3.219">     server.prettyName = aName ? aName : defaultName;</span>
<a href="#l3.220"></a><span id="l3.220">     server.valid = true;</span>
<a href="#l3.221"></a><span id="l3.221">     let account = MailServices.accounts.createAccount();</span>
<a href="#l3.222"></a><span id="l3.222">     account.incomingServer = server;</span>
<a href="#l3.223"></a><span id="l3.223">     // Initialize the feed_options now.</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineat">@@ -188,90 +194,91 @@ var FeedUtils = {</span>
<a href="#l3.225"></a><span id="l3.225">     // deletes will throw until restart creates it.</span>
<a href="#l3.226"></a><span id="l3.226">     server.msgStore.discoverSubFolders(server.rootMsgFolder, false);</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">     // Create &quot;Local Folders&quot; if none exist yet as it's guaranteed that</span>
<a href="#l3.229"></a><span id="l3.229">     // those exist when any account exists.</span>
<a href="#l3.230"></a><span id="l3.230">     let localFolders;</span>
<a href="#l3.231"></a><span id="l3.231">     try {</span>
<a href="#l3.232"></a><span id="l3.232">       localFolders = MailServices.accounts.localFoldersServer;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    }</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    if (!localFolders)</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    if (!localFolders) {</span>
<a href="#l3.239"></a><span id="l3.239">       MailServices.accounts.createLocalMailAccount();</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+    }</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242">     // Save new accounts in case of a crash.</span>
<a href="#l3.243"></a><span id="l3.243">     try {</span>
<a href="#l3.244"></a><span id="l3.244">       MailServices.accounts.saveAccountInfo();</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    }</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.248"></a><span id="l3.248">       this.log.error(&quot;FeedUtils.createRssAccount: error on saveAccountInfo - &quot; + ex);</span>
<a href="#l3.249"></a><span id="l3.249">     }</span>
<a href="#l3.250"></a><span id="l3.250"> </span>
<a href="#l3.251"></a><span id="l3.251">     this.log.debug(&quot;FeedUtils.createRssAccount: &quot; +</span>
<a href="#l3.252"></a><span id="l3.252">                    account.incomingServer.rootFolder.prettyName);</span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254">     return account;</span>
<a href="#l3.255"></a><span id="l3.255">   },</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-/**</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">- * Helper routine that checks our subscriptions list array and returns</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">- * true if the url is already in our list.  This is used to prevent the</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">- * user from subscribing to the same feed multiple times for the same server.</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">- *</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">- * @param  string aUrl                  - the url.</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">- * @param  nsIMsgIncomingServer aServer - account server.</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">- * @return boolean                      - true if exists else false.</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">- */</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-  feedAlreadyExists: function(aUrl, aServer) {</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  /**</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+   * Helper routine that checks our subscriptions list array and returns</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+   * true if the url is already in our list.  This is used to prevent the</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+   * user from subscribing to the same feed multiple times for the same server.</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+   *</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+   * @param {String} aUrl                  - The url.</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+   * @param {nsIMsgIncomingServer} aServer - Account server.</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+   * @returns {Boolean}                    - true if exists else false.</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+   */</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  feedAlreadyExists(aUrl, aServer) {</span>
<a href="#l3.277"></a><span id="l3.277">     let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l3.278"></a><span id="l3.278">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.279"></a><span id="l3.279">     let resource = this.rdf.GetResource(aUrl);</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    if (feeds.IndexOf(resource) == -1)</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+    if (feeds.IndexOf(resource) == -1) {</span>
<a href="#l3.282"></a><span id="l3.282">       return false;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+    }</span>
<a href="#l3.284"></a><span id="l3.284"> </span>
<a href="#l3.285"></a><span id="l3.285">     let folder = ds.GetTarget(resource, FeedUtils.FZ_DESTFOLDER, true)</span>
<a href="#l3.286"></a><span id="l3.286">                    .QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l3.287"></a><span id="l3.287">     this.log.info(&quot;FeedUtils.feedAlreadyExists: feed url &quot; + aUrl +</span>
<a href="#l3.288"></a><span id="l3.288">                   &quot; subscribed in folder url &quot; + decodeURI(folder));</span>
<a href="#l3.289"></a><span id="l3.289"> </span>
<a href="#l3.290"></a><span id="l3.290">     return true;</span>
<a href="#l3.291"></a><span id="l3.291">   },</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-/**</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">- * Download a feed url on biff or get new messages.</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">- *</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">- * @param   nsIMsgFolder aFolder         - folder</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">- * @param   nsIUrlListener aUrlListener  - feed url</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">- * @param   bool aIsBiff                 - true if biff, false if manual get</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">- * @param   nsIDOMWindow aMsgWindow      - window</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">- */</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-  downloadFeed: function(aFolder, aUrlListener, aIsBiff, aMsgWindow) {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+  /**</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+   * Download a feed url on biff or get new messages.</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+   *</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+   * @param {nsIMsgFolder} aFolder         - The folder.</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+   * @param {nsIUrlListener} aUrlListener  - Feed url.</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+   * @param {Boolean} aIsBiff              - true if biff, false if manual get.</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+   * @param {nsIDOMWindow} aMsgWindow      - Thr window.</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+   *</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+   */</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+  downloadFeed(aFolder, aUrlListener, aIsBiff, aMsgWindow) {</span>
<a href="#l3.313"></a><span id="l3.313">     FeedUtils.log.debug(&quot;downloadFeed: account isBiff:isOffline - &quot; +</span>
<a href="#l3.314"></a><span id="l3.314">                         aIsBiff + &quot; : &quot; + Services.io.offline);</span>
<a href="#l3.315"></a><span id="l3.315">     // User set.</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+    if (Services.io.offline) {</span>
<a href="#l3.318"></a><span id="l3.318">       return;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+    }</span>
<a href="#l3.320"></a><span id="l3.320"> </span>
<a href="#l3.321"></a><span id="l3.321">     // No network connection. Unfortunately, this is only set if the event is</span>
<a href="#l3.322"></a><span id="l3.322">     // received by Tb from the OS (ie it must already be running) and doesn't</span>
<a href="#l3.323"></a><span id="l3.323">     // necessarily mean connectivity to the internet, only the nearest network</span>
<a href="#l3.324"></a><span id="l3.324">     // point. But it's something.</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-    if (!Services.io.connectivity)</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-    {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+    if (!Services.io.connectivity) {</span>
<a href="#l3.328"></a><span id="l3.328">       FeedUtils.log.warn(&quot;downloadFeed: network connection unavailable&quot;);</span>
<a href="#l3.329"></a><span id="l3.329">       return;</span>
<a href="#l3.330"></a><span id="l3.330">     }</span>
<a href="#l3.331"></a><span id="l3.331"> </span>
<a href="#l3.332"></a><span id="l3.332">     // We don't yet support the ability to check for new articles while we are</span>
<a href="#l3.333"></a><span id="l3.333">     // in the middle of subscribing to a feed. For now, abort the check for</span>
<a href="#l3.334"></a><span id="l3.334">     // new feeds.</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-    if (FeedUtils.progressNotifier.mSubscribeMode)</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-    {</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+    if (FeedUtils.progressNotifier.mSubscribeMode) {</span>
<a href="#l3.338"></a><span id="l3.338">       FeedUtils.log.warn(&quot;downloadFeed: Aborting RSS New Mail Check. &quot; +</span>
<a href="#l3.339"></a><span id="l3.339">                          &quot;Feed subscription in progress\n&quot;);</span>
<a href="#l3.340"></a><span id="l3.340">       return;</span>
<a href="#l3.341"></a><span id="l3.341">     }</span>
<a href="#l3.342"></a><span id="l3.342"> </span>
<a href="#l3.343"></a><span id="l3.343">     let forceDownload = !aIsBiff;</span>
<a href="#l3.344"></a><span id="l3.344">     let allFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.345"></a><span id="l3.345">     if (!aFolder.isServer) {</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineat">@@ -284,44 +291,42 @@ var FeedUtils = {</span>
<a href="#l3.347"></a><span id="l3.347">     aFolder.ListDescendants(allFolders);</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349">     let folder;</span>
<a href="#l3.350"></a><span id="l3.350">     function* feeder() {</span>
<a href="#l3.351"></a><span id="l3.351">       let numFolders = allFolders.length;</span>
<a href="#l3.352"></a><span id="l3.352">       for (let i = 0; i &lt; numFolders; i++) {</span>
<a href="#l3.353"></a><span id="l3.353">         folder = allFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l3.354"></a><span id="l3.354">         FeedUtils.log.debug(&quot;downloadFeed: START x/# folderName:folderPath - &quot; +</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-                            (i+1) + &quot;/&quot; + numFolders + &quot; &quot; +</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+                            (i + 1) + &quot;/&quot; + numFolders + &quot; &quot; +</span>
<a href="#l3.357"></a><span id="l3.357">                             folder.name + &quot; : &quot; + folder.filePath.path);</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">         let feedUrlArray = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l3.360"></a><span id="l3.360">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l3.361"></a><span id="l3.361">         // database.  All folders in Trash are skipped.</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        if (!feedUrlArray)</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+        if (!feedUrlArray) {</span>
<a href="#l3.364"></a><span id="l3.364">           continue;</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+        }</span>
<a href="#l3.366"></a><span id="l3.366"> </span>
<a href="#l3.367"></a><span id="l3.367">         FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot; +</span>
<a href="#l3.368"></a><span id="l3.368">                             folder.name + &quot; : &quot; + feedUrlArray);</span>
<a href="#l3.369"></a><span id="l3.369"> </span>
<a href="#l3.370"></a><span id="l3.370">         // We need to kick off a download for each feed.</span>
<a href="#l3.371"></a><span id="l3.371">         let now = Date.now();</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-        for (let url of feedUrlArray)</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-        {</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+        for (let url of feedUrlArray) {</span>
<a href="#l3.375"></a><span id="l3.375">           // Check whether this feed should be updated; if forceDownload is true</span>
<a href="#l3.376"></a><span id="l3.376">           // skip the per feed check.</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-          if (!forceDownload)</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-          {</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+          if (!forceDownload) {</span>
<a href="#l3.380"></a><span id="l3.380">             let status = FeedUtils.getStatus(folder, url);</span>
<a href="#l3.381"></a><span id="l3.381">             if (!status.enabled ||</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-                (now - status.lastUpdateTime &lt; status.updateMinutes * 60000))</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-            {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+                (now - status.lastUpdateTime &lt; status.updateMinutes * 60000)) {</span>
<a href="#l3.385"></a><span id="l3.385">               FeedUtils.log.debug(&quot;downloadFeed: SKIP feed, &quot; +</span>
<a href="#l3.386"></a><span id="l3.386">                                   &quot;aIsBiff:enabled:minsSinceLastUpdate::url - &quot; +</span>
<a href="#l3.387"></a><span id="l3.387">                                   aIsBiff + &quot; : &quot; + status.enabled + &quot; : &quot; +</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-                                  (Math.round((now - status.lastUpdateTime) / 60) / 1000) +&quot; :: &quot;+</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+                                  (Math.round((now - status.lastUpdateTime) / 60) / 1000) + &quot; :: &quot; +</span>
<a href="#l3.390"></a><span id="l3.390">                                   url);</span>
<a href="#l3.391"></a><span id="l3.391">               continue;</span>
<a href="#l3.392"></a><span id="l3.392">             }</span>
<a href="#l3.393"></a><span id="l3.393">           }</span>
<a href="#l3.394"></a><span id="l3.394"> </span>
<a href="#l3.395"></a><span id="l3.395">           // Create a feed object.</span>
<a href="#l3.396"></a><span id="l3.396">           let feed = new Feed(url, folder);</span>
<a href="#l3.397"></a><span id="l3.397"> </span>
<a href="#l3.398"></a><span id="l3.398" class="difflineat">@@ -334,18 +339,17 @@ var FeedUtils = {</span>
<a href="#l3.399"></a><span id="l3.399">           // early returns must call downloaded() so mNumPendingFeedDownloads</span>
<a href="#l3.400"></a><span id="l3.400">           // is decremented and notification/status feedback is reset.</span>
<a href="#l3.401"></a><span id="l3.401">           FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l3.402"></a><span id="l3.402"> </span>
<a href="#l3.403"></a><span id="l3.403">           // If the current active count exceeds the max desired, exit from</span>
<a href="#l3.404"></a><span id="l3.404">           // the current poll cycle. Only throttle for a background biff; for</span>
<a href="#l3.405"></a><span id="l3.405">           // a user manual get messages, do them all.</span>
<a href="#l3.406"></a><span id="l3.406">           if (aIsBiff &amp;&amp; FeedUtils.progressNotifier.mNumPendingFeedDownloads &gt;</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-                         FeedUtils.MAX_CONCURRENT_FEEDS)</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-          {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+                         FeedUtils.MAX_CONCURRENT_FEEDS) {</span>
<a href="#l3.410"></a><span id="l3.410">             FeedUtils.log.debug(&quot;downloadFeed: RETURN active feeds count is greater &quot; +</span>
<a href="#l3.411"></a><span id="l3.411">                                 &quot;than the max - &quot; + FeedUtils.MAX_CONCURRENT_FEEDS);</span>
<a href="#l3.412"></a><span id="l3.412">             FeedUtils.progressNotifier.downloaded(feed, FeedUtils.kNewsBlogFeedIsBusy);</span>
<a href="#l3.413"></a><span id="l3.413">             return;</span>
<a href="#l3.414"></a><span id="l3.414">           }</span>
<a href="#l3.415"></a><span id="l3.415"> </span>
<a href="#l3.416"></a><span id="l3.416">           // Set status info and download.</span>
<a href="#l3.417"></a><span id="l3.417">           FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot; + url);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineat">@@ -357,18 +361,17 @@ var FeedUtils = {</span>
<a href="#l3.419"></a><span id="l3.419">               let done = getFeed.next().done;</span>
<a href="#l3.420"></a><span id="l3.420">               if (done) {</span>
<a href="#l3.421"></a><span id="l3.421">                 // Finished with all feeds in base aFolder and its subfolders.</span>
<a href="#l3.422"></a><span id="l3.422">                 FeedUtils.log.debug(&quot;downloadFeed: Finished with folder - &quot; +</span>
<a href="#l3.423"></a><span id="l3.423">                                     aFolder.name);</span>
<a href="#l3.424"></a><span id="l3.424">                 folder = null;</span>
<a href="#l3.425"></a><span id="l3.425">                 allFolders = null;</span>
<a href="#l3.426"></a><span id="l3.426">               }</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-            }</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-            catch (ex) {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+            } catch (ex) {</span>
<a href="#l3.430"></a><span id="l3.430">               FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l3.431"></a><span id="l3.431">               FeedUtils.progressNotifier.downloaded(feed, FeedUtils.kNewsBlogFeedIsBusy);</span>
<a href="#l3.432"></a><span id="l3.432">             }</span>
<a href="#l3.433"></a><span id="l3.433">           }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l3.434"></a><span id="l3.434"> </span>
<a href="#l3.435"></a><span id="l3.435">           yield undefined;</span>
<a href="#l3.436"></a><span id="l3.436">         }</span>
<a href="#l3.437"></a><span id="l3.437">       }</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineat">@@ -379,61 +382,59 @@ var FeedUtils = {</span>
<a href="#l3.439"></a><span id="l3.439">       let done = getFeed.next().done;</span>
<a href="#l3.440"></a><span id="l3.440">       if (done) {</span>
<a href="#l3.441"></a><span id="l3.441">         // Nothing to do.</span>
<a href="#l3.442"></a><span id="l3.442">         FeedUtils.log.debug(&quot;downloadFeed: Nothing to do in folder - &quot; +</span>
<a href="#l3.443"></a><span id="l3.443">                             aFolder.name);</span>
<a href="#l3.444"></a><span id="l3.444">         folder = null;</span>
<a href="#l3.445"></a><span id="l3.445">         allFolders = null;</span>
<a href="#l3.446"></a><span id="l3.446">       }</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-    }</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.450"></a><span id="l3.450">       FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l3.451"></a><span id="l3.451">       FeedUtils.progressNotifier.downloaded({folder: aFolder, url: &quot;&quot;},</span>
<a href="#l3.452"></a><span id="l3.452">                                             FeedUtils.kNewsBlogFeedIsBusy);</span>
<a href="#l3.453"></a><span id="l3.453">     }</span>
<a href="#l3.454"></a><span id="l3.454">   },</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-/**</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">- * Subscribe a new feed url.</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">- *</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">- * @param   string aUrl              - feed url</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">- * @param   nsIMsgFolder aFolder     - folder</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">- * @param   nsIDOMWindow aMsgWindow  - window</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">- */</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-  subscribeToFeed: function(aUrl, aFolder, aMsgWindow) {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+  /**</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+   * Subscribe a new feed url.</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+   *</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+   * @param {String} aUrl              - Feed url.</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+   * @param {nsIMsgFolder} aFolder     - Folder.</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+   * @param {nsIDOMWindow} aMsgWindow  - The window.</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+   *</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+   */</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+  subscribeToFeed(aUrl, aFolder, aMsgWindow) {</span>
<a href="#l3.474"></a><span id="l3.474">     // We don't support the ability to subscribe to several feeds at once yet.</span>
<a href="#l3.475"></a><span id="l3.475">     // For now, abort the subscription if we are already in the middle of</span>
<a href="#l3.476"></a><span id="l3.476">     // subscribing to a feed via drag and drop.</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-    if (FeedUtils.progressNotifier.mNumPendingFeedDownloads &gt; 0)</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-    {</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+    if (FeedUtils.progressNotifier.mNumPendingFeedDownloads &gt; 0) {</span>
<a href="#l3.480"></a><span id="l3.480">       FeedUtils.log.warn(&quot;subscribeToFeed: Aborting RSS subscription. &quot; +</span>
<a href="#l3.481"></a><span id="l3.481">                          &quot;Feed downloads already in progress\n&quot;);</span>
<a href="#l3.482"></a><span id="l3.482">       return;</span>
<a href="#l3.483"></a><span id="l3.483">     }</span>
<a href="#l3.484"></a><span id="l3.484"> </span>
<a href="#l3.485"></a><span id="l3.485">     // If aFolder is null, then use the root folder for the first RSS account.</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    if (!aFolder)</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+    if (!aFolder) {</span>
<a href="#l3.488"></a><span id="l3.488">       aFolder = FeedUtils.getAllRssServerRootFolders()[0];</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+    }</span>
<a href="#l3.490"></a><span id="l3.490"> </span>
<a href="#l3.491"></a><span id="l3.491">     // If the user has no Feeds account yet, create one.</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-    if (!aFolder)</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+    if (!aFolder) {</span>
<a href="#l3.494"></a><span id="l3.494">       aFolder = FeedUtils.createRssAccount().incomingServer.rootFolder;</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+    }</span>
<a href="#l3.496"></a><span id="l3.496"> </span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-    if (!aMsgWindow)</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-    {</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+    if (!aMsgWindow) {</span>
<a href="#l3.500"></a><span id="l3.500">       let wlist = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-      if (wlist.hasMoreElements())</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-      {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+      if (wlist.hasMoreElements()) {</span>
<a href="#l3.504"></a><span id="l3.504">         let win = wlist.getNext().QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l3.505"></a><span id="l3.505">         win.focus();</span>
<a href="#l3.506"></a><span id="l3.506">         aMsgWindow = win.msgWindow;</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-      }</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-      else</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-      {</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+      } else {</span>
<a href="#l3.511"></a><span id="l3.511">         // If there are no open windows, open one, pass it the URL, and</span>
<a href="#l3.512"></a><span id="l3.512">         // during opening it will subscribe to the feed.</span>
<a href="#l3.513"></a><span id="l3.513">         let arg = Cc[&quot;@mozilla.org/supports-string;1&quot;].</span>
<a href="#l3.514"></a><span id="l3.514">                   createInstance(Ci.nsISupportsString);</span>
<a href="#l3.515"></a><span id="l3.515">         arg.data = aUrl;</span>
<a href="#l3.516"></a><span id="l3.516">         Services.ww.openWindow(null, &quot;chrome://messenger/content/&quot;,</span>
<a href="#l3.517"></a><span id="l3.517">                                &quot;_blank&quot;, &quot;chrome,dialog=no,all&quot;, arg);</span>
<a href="#l3.518"></a><span id="l3.518">         return;</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineat">@@ -444,18 +445,17 @@ var FeedUtils = {</span>
<a href="#l3.520"></a><span id="l3.520">     // feed://example.org/feed.xml or feed:https://example.org/feed.xml.</span>
<a href="#l3.521"></a><span id="l3.521">     // Replace feed:// with http:// per the spec, then strip off feed:</span>
<a href="#l3.522"></a><span id="l3.522">     // for the second case.</span>
<a href="#l3.523"></a><span id="l3.523">     aUrl = aUrl.replace(/^feed:\x2f\x2f/i, &quot;http://&quot;);</span>
<a href="#l3.524"></a><span id="l3.524">     aUrl = aUrl.replace(/^feed:/i, &quot;&quot;);</span>
<a href="#l3.525"></a><span id="l3.525"> </span>
<a href="#l3.526"></a><span id="l3.526">     // Make sure we aren't already subscribed to this feed before we attempt</span>
<a href="#l3.527"></a><span id="l3.527">     // to subscribe to it.</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-    if (FeedUtils.feedAlreadyExists(aUrl, aFolder.server))</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-    {</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+    if (FeedUtils.feedAlreadyExists(aUrl, aFolder.server)) {</span>
<a href="#l3.531"></a><span id="l3.531">       aMsgWindow.statusFeedback.showStatusString(</span>
<a href="#l3.532"></a><span id="l3.532">         FeedUtils.strings.GetStringFromName(&quot;subscribe-feedAlreadySubscribed&quot;));</span>
<a href="#l3.533"></a><span id="l3.533">       return;</span>
<a href="#l3.534"></a><span id="l3.534">     }</span>
<a href="#l3.535"></a><span id="l3.535"> </span>
<a href="#l3.536"></a><span id="l3.536">     let feed = new Feed(aUrl, aFolder);</span>
<a href="#l3.537"></a><span id="l3.537">     // Default setting for new feeds per account settings.</span>
<a href="#l3.538"></a><span id="l3.538">     feed.quickMode = feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineat">@@ -466,119 +466,128 @@ var FeedUtils = {</span>
<a href="#l3.540"></a><span id="l3.540">     feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l3.541"></a><span id="l3.541">   },</span>
<a href="#l3.542"></a><span id="l3.542"> </span>
<a href="#l3.543"></a><span id="l3.543"> /**</span>
<a href="#l3.544"></a><span id="l3.544">  * Enable or disable updates for all subscriptions in a folder, or all</span>
<a href="#l3.545"></a><span id="l3.545">  * subscriptions in an account if the folder is the account folder.</span>
<a href="#l3.546"></a><span id="l3.546">  * A folder's subfolders' feeds are not included.</span>
<a href="#l3.547"></a><span id="l3.547">  *</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">- * @param   nsIMsgFolder aFolder     - folder or account folder (server).</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">- * @param   bool aPause              - to pause or not to pause.</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">- * @param   bool aBiffNow            - if aPause is false, and aBiffNow is true</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+ * @param {nsIMsgFolder} aFolder     - Folder or account folder (server).</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+ * @param {Boolean} aPause           - To pause or not to pause.</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+ * @param {Boolean} aBiffNow         - If aPause is false, and aBiffNow is true</span>
<a href="#l3.554"></a><span id="l3.554">  *                                     do the biff immediately.</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+ * @returns {void}</span>
<a href="#l3.556"></a><span id="l3.556">  */</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-  pauseFeedFolderUpdates: function(aFolder, aPause, aBiffNow) {</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-    if (aFolder.isServer)</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-    {</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+  pauseFeedFolderUpdates(aFolder, aPause, aBiffNow) {</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+    if (aFolder.isServer) {</span>
<a href="#l3.562"></a><span id="l3.562">       let serverFolder = aFolder.server.rootFolder;</span>
<a href="#l3.563"></a><span id="l3.563">       // Remove server from biff first. If enabling biff, this will make the</span>
<a href="#l3.564"></a><span id="l3.564">       // latest biffMinutes take effect now rather than waiting for the timer</span>
<a href="#l3.565"></a><span id="l3.565">       // to expire.</span>
<a href="#l3.566"></a><span id="l3.566">       aFolder.server.doBiff = false;</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-      if (!aPause)</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+      if (!aPause) {</span>
<a href="#l3.569"></a><span id="l3.569">         aFolder.server.doBiff = true;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+      }</span>
<a href="#l3.571"></a><span id="l3.571"> </span>
<a href="#l3.572"></a><span id="l3.572">       FeedUtils.setStatus(serverFolder, serverFolder.URI, &quot;enabled&quot;, !aPause);</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-      if (!aPause &amp;&amp; aBiffNow)</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+      if (!aPause &amp;&amp; aBiffNow) {</span>
<a href="#l3.575"></a><span id="l3.575">         aFolder.server.performBiff(null);</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+      }</span>
<a href="#l3.577"></a><span id="l3.577"> </span>
<a href="#l3.578"></a><span id="l3.578">       return;</span>
<a href="#l3.579"></a><span id="l3.579">     }</span>
<a href="#l3.580"></a><span id="l3.580"> </span>
<a href="#l3.581"></a><span id="l3.581">     let feedUrls = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-    if (!feedUrls)</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+    if (!feedUrls) {</span>
<a href="#l3.584"></a><span id="l3.584">       return;</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+    }</span>
<a href="#l3.586"></a><span id="l3.586"> </span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-    for (let feedUrl of feedUrls)</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-    {</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+    for (let feedUrl of feedUrls) {</span>
<a href="#l3.590"></a><span id="l3.590">       let feed = new Feed(feedUrl, aFolder);</span>
<a href="#l3.591"></a><span id="l3.591">       let options = feed.options;</span>
<a href="#l3.592"></a><span id="l3.592">       options.updates.enabled = !aPause;</span>
<a href="#l3.593"></a><span id="l3.593">       feed.options = options;</span>
<a href="#l3.594"></a><span id="l3.594">       FeedUtils.setStatus(aFolder, feedUrl, &quot;enabled&quot;, !aPause);</span>
<a href="#l3.595"></a><span id="l3.595">       FeedUtils.log.debug(&quot;pauseFeedFolderUpdates: enabled:url &quot; +</span>
<a href="#l3.596"></a><span id="l3.596">                           !aPause + &quot;: &quot; + feedUrl);</span>
<a href="#l3.597"></a><span id="l3.597">     }</span>
<a href="#l3.598"></a><span id="l3.598"> </span>
<a href="#l3.599"></a><span id="l3.599">     let win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-    if (win)</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-    {</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+    if (win) {</span>
<a href="#l3.603"></a><span id="l3.603">       let curItem = win.FeedSubscriptions.mView.currentItem;</span>
<a href="#l3.604"></a><span id="l3.604">       win.FeedSubscriptions.refreshSubscriptionView();</span>
<a href="#l3.605"></a><span id="l3.605">       if (curItem.container) {</span>
<a href="#l3.606"></a><span id="l3.606">         win.FeedSubscriptions.selectFolder(curItem.folder);</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-      }</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-      else</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-      {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+      } else {</span>
<a href="#l3.611"></a><span id="l3.611">         let feed = new Feed(curItem.url, curItem.parentFolder);</span>
<a href="#l3.612"></a><span id="l3.612">         win.FeedSubscriptions.selectFeed(feed);</span>
<a href="#l3.613"></a><span id="l3.613">       }</span>
<a href="#l3.614"></a><span id="l3.614">     }</span>
<a href="#l3.615"></a><span id="l3.615"> </span>
<a href="#l3.616"></a><span id="l3.616">     this.getSubscriptionsDS(aFolder.server).Flush();</span>
<a href="#l3.617"></a><span id="l3.617">   },</span>
<a href="#l3.618"></a><span id="l3.618"> </span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-/**</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">- * Add a feed record to the feeds.rdf database and update the folder's feedUrl</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">- * property.</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">- *</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">- * @param  Feed aFeed - our feed object.</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">- */</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  addFeed: function(aFeed) {</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+  /**</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+   * Add a feed record to the feeds.rdf database and update the folder's feedUrl</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+   * property.</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+   *</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+   * @param {Feed} aFeed - Our feed object.</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+   *</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+   */</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+  addFeed(aFeed) {</span>
<a href="#l3.635"></a><span id="l3.635">     let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l3.636"></a><span id="l3.636">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.637"></a><span id="l3.637"> </span>
<a href="#l3.638"></a><span id="l3.638">     // Generate a unique ID for the feed.</span>
<a href="#l3.639"></a><span id="l3.639">     let id = aFeed.url;</span>
<a href="#l3.640"></a><span id="l3.640">     let i = 1;</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000)</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+    while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000) {</span>
<a href="#l3.643"></a><span id="l3.643">       id = aFeed.url + i;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-    if (i == 1000)</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+    }</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+    if (i == 1000) {</span>
<a href="#l3.648"></a><span id="l3.648">       throw new Error(&quot;FeedUtils.addFeed: couldn't generate a unique ID &quot; +</span>
<a href="#l3.649"></a><span id="l3.649">                       &quot;for feed &quot; + aFeed.url);</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+    }</span>
<a href="#l3.651"></a><span id="l3.651"> </span>
<a href="#l3.652"></a><span id="l3.652">     // Add the feed to the list.</span>
<a href="#l3.653"></a><span id="l3.653">     let feedResource = this.rdf.GetResource(id);</span>
<a href="#l3.654"></a><span id="l3.654">     feeds.AppendElement(feedResource);</span>
<a href="#l3.655"></a><span id="l3.655">     ds.Assert(feedResource, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l3.656"></a><span id="l3.656">     ds.Assert(feedResource, this.DC_IDENTIFIER, this.rdf.GetLiteral(aFeed.url), true);</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-    if (aFeed.title)</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+    if (aFeed.title) {</span>
<a href="#l3.659"></a><span id="l3.659">       ds.Assert(feedResource, this.DC_TITLE, this.rdf.GetLiteral(aFeed.title), true);</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+    }</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+</span>
<a href="#l3.662"></a><span id="l3.662">     ds.Assert(feedResource, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l3.663"></a><span id="l3.663">     ds.Flush();</span>
<a href="#l3.664"></a><span id="l3.664"> </span>
<a href="#l3.665"></a><span id="l3.665">     // Update folderpane.</span>
<a href="#l3.666"></a><span id="l3.666">     this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l3.667"></a><span id="l3.667">   },</span>
<a href="#l3.668"></a><span id="l3.668"> </span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-/**</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">- * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">- * feedUrl property.</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">- *</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">- * @param  Feed aFeed - our feed object.</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">- */</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-  deleteFeed: function(aFeed) {</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+  /**</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+   * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+   * feedUrl property.</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+   *</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+   * @param {Feed} aFeed - Our feed object.</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+   *</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+   */</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+  deleteFeed(aFeed) {</span>
<a href="#l3.685"></a><span id="l3.685">     let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l3.686"></a><span id="l3.686"> </span>
<a href="#l3.687"></a><span id="l3.687">     // Remove the feed from the subscriptions ds.</span>
<a href="#l3.688"></a><span id="l3.688">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.689"></a><span id="l3.689">     let index = feeds.IndexOf(aFeed.resource);</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-    if (index != -1)</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+    if (index != -1) {</span>
<a href="#l3.692"></a><span id="l3.692">       feeds.RemoveElementAt(index, false);</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+    }</span>
<a href="#l3.694"></a><span id="l3.694"> </span>
<a href="#l3.695"></a><span id="l3.695">     // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l3.696"></a><span id="l3.696">     this.removeAssertions(ds, aFeed.resource);</span>
<a href="#l3.697"></a><span id="l3.697">     ds.Flush();</span>
<a href="#l3.698"></a><span id="l3.698"> </span>
<a href="#l3.699"></a><span id="l3.699">     // Remove all assertions about items in the feed from the items database.</span>
<a href="#l3.700"></a><span id="l3.700">     let itemds = this.getItemsDS(aFeed.server);</span>
<a href="#l3.701"></a><span id="l3.701">     aFeed.invalidateItems();</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineat">@@ -586,30 +595,31 @@ var FeedUtils = {</span>
<a href="#l3.703"></a><span id="l3.703">     itemds.Flush();</span>
<a href="#l3.704"></a><span id="l3.704"> </span>
<a href="#l3.705"></a><span id="l3.705">     // Update folderpane.</span>
<a href="#l3.706"></a><span id="l3.706">     this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l3.707"></a><span id="l3.707">     // Remove from cache.</span>
<a href="#l3.708"></a><span id="l3.708">     delete this[aFeed.server.serverURI][aFeed.url];</span>
<a href="#l3.709"></a><span id="l3.709">   },</span>
<a href="#l3.710"></a><span id="l3.710"> </span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-/**</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">- * Change an existing feed's url, as identified by FZ_FEED resource in the</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">- * feeds.rdf subscriptions database.</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">- *</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">- * @param  obj aFeed      - the feed object</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">- * @param  string aNewUrl - new url</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">- * @return bool           - true if successful, else false</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">- */</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-  changeUrlForFeed: function(aFeed, aNewUrl) {</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-    if (!aFeed || !aFeed.folder || !aNewUrl)</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+  /**</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+   * Change an existing feed's url, as identified by FZ_FEED resource in the</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+   * feeds.rdf subscriptions database.</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+   *</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+   * @param {Feed} aFeed      - The feed object.</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+   * @param {String} aNewUrl  - New url.</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+   *</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+   * @returns {Boolean}       - true if successful, else false.</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+   */</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+  changeUrlForFeed(aFeed, aNewUrl) {</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+    if (!aFeed || !aFeed.folder || !aNewUrl) {</span>
<a href="#l3.732"></a><span id="l3.732">       return false;</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+    }</span>
<a href="#l3.734"></a><span id="l3.734"> </span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-    if (this.feedAlreadyExists(aNewUrl, aFeed.server))</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-    {</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+    if (this.feedAlreadyExists(aNewUrl, aFeed.server)) {</span>
<a href="#l3.738"></a><span id="l3.738">       this.log.info(&quot;FeedUtils.changeUrlForFeed: new feed url &quot; + aNewUrl +</span>
<a href="#l3.739"></a><span id="l3.739">                     &quot; already subscribed in account &quot; + aFeed.server.prettyName);</span>
<a href="#l3.740"></a><span id="l3.740">       return false;</span>
<a href="#l3.741"></a><span id="l3.741">     }</span>
<a href="#l3.742"></a><span id="l3.742"> </span>
<a href="#l3.743"></a><span id="l3.743">     let title = aFeed.title;</span>
<a href="#l3.744"></a><span id="l3.744">     let link = aFeed.link;</span>
<a href="#l3.745"></a><span id="l3.745">     let quickMode = aFeed.quickMode;</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineat">@@ -619,387 +629,409 @@ var FeedUtils = {</span>
<a href="#l3.747"></a><span id="l3.747">     aFeed.resource = this.rdf.GetResource(aNewUrl).QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l3.748"></a><span id="l3.748">     aFeed.title = title;</span>
<a href="#l3.749"></a><span id="l3.749">     aFeed.link = link;</span>
<a href="#l3.750"></a><span id="l3.750">     aFeed.quickMode = quickMode;</span>
<a href="#l3.751"></a><span id="l3.751">     aFeed.options = options;</span>
<a href="#l3.752"></a><span id="l3.752">     this.addFeed(aFeed);</span>
<a href="#l3.753"></a><span id="l3.753"> </span>
<a href="#l3.754"></a><span id="l3.754">     let win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-    if (win)</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+    if (win) {</span>
<a href="#l3.757"></a><span id="l3.757">       win.FeedSubscriptions.refreshSubscriptionView(aFeed.folder, aNewUrl);</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+    }</span>
<a href="#l3.759"></a><span id="l3.759"> </span>
<a href="#l3.760"></a><span id="l3.760">     return true;</span>
<a href="#l3.761"></a><span id="l3.761">   },</span>
<a href="#l3.762"></a><span id="l3.762"> </span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-/**</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">- * Get the list of feed urls for a folder, as identified by the FZ_DESTFOLDER</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">- * tag, directly from the primary feeds.rdf subscriptions database.</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">- *</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">- * @param  nsIMsgFolder - the folder.</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">- * @return array of urls, or null if none.</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">- */</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-  getFeedUrlsInFolder: function(aFolder) {</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+  /**</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+   * Get the list of feed urls for a folder, as identified by the FZ_DESTFOLDER</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+   * tag, directly from the primary feeds.rdf subscriptions database.</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+   *</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - The folder.</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+   *</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+   * @returns {String}[]           - Array of urls, or null if none.</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+   */</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+  getFeedUrlsInFolder(aFolder) {</span>
<a href="#l3.780"></a><span id="l3.780">     if (!aFolder || aFolder.isServer || aFolder.server.type != &quot;rss&quot; ||</span>
<a href="#l3.781"></a><span id="l3.781">         aFolder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l3.782"></a><span id="l3.782">         aFolder.getFlag(Ci.nsMsgFolderFlags.Virtual) ||</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-        !aFolder.filePath.exists())</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+        !aFolder.filePath.exists()) {</span>
<a href="#l3.785"></a><span id="l3.785">       // There are never any feedUrls in the account/non-feed/trash/virtual</span>
<a href="#l3.786"></a><span id="l3.786">       // folders or in a ghost folder (nonexistent on disk yet found in</span>
<a href="#l3.787"></a><span id="l3.787">       // aFolder.subFolders).</span>
<a href="#l3.788"></a><span id="l3.788">       return null;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+    }</span>
<a href="#l3.790"></a><span id="l3.790"> </span>
<a href="#l3.791"></a><span id="l3.791">     let feedUrlArray = [];</span>
<a href="#l3.792"></a><span id="l3.792"> </span>
<a href="#l3.793"></a><span id="l3.793">     // Get the list from the feeds database.</span>
<a href="#l3.794"></a><span id="l3.794">     try {</span>
<a href="#l3.795"></a><span id="l3.795">       let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l3.796"></a><span id="l3.796">       let enumerator = ds.GetSources(this.FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-      while (enumerator.hasMoreElements())</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-      {</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+      while (enumerator.hasMoreElements()) {</span>
<a href="#l3.800"></a><span id="l3.800">         let containerArc = enumerator.getNext();</span>
<a href="#l3.801"></a><span id="l3.801">         let uri = containerArc.QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l3.802"></a><span id="l3.802">         feedUrlArray.push(uri);</span>
<a href="#l3.803"></a><span id="l3.803">       }</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-    }</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-    catch(ex)</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-    {</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.808"></a><span id="l3.808">       this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error - &quot; + ex);</span>
<a href="#l3.809"></a><span id="l3.809">       this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error for account - &quot; +</span>
<a href="#l3.810"></a><span id="l3.810">                      aFolder.server.serverURI + &quot; : &quot; + aFolder.server.prettyName);</span>
<a href="#l3.811"></a><span id="l3.811">     }</span>
<a href="#l3.812"></a><span id="l3.812"> </span>
<a href="#l3.813"></a><span id="l3.813">     return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l3.814"></a><span id="l3.814">   },</span>
<a href="#l3.815"></a><span id="l3.815"> </span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-/**</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">- * Check if the folder's msgDatabase is openable, reparse if desired.</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">- *</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">- * @param  nsIMsgFolder aFolder        - the folder</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">- * @param  boolean aReparse            - reparse if true</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">- * @param  nsIUrlListener aUrlListener - object implementing nsIUrlListener</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">- *</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">- * @return boolean              - true if msgDb is available, else false</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">- */</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-  isMsgDatabaseOpenable: function(aFolder, aReparse, aUrlListener) {</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+  /**</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+   * Check if the folder's msgDatabase is openable, reparse if desired.</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+   *</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+   * @param {nsIMsgFolder} aFolder        - The folder.</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+   * @param {Boolean} aReparse            - Reparse if true.</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+   * @param {nsIUrlListener} aUrlListener - Object implementing nsIUrlListener.</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+   *</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+   * @returns {Boolean} - true if msgDb is available, else false</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+   */</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+  isMsgDatabaseOpenable(aFolder, aReparse, aUrlListener) {</span>
<a href="#l3.836"></a><span id="l3.836">     let msgDb;</span>
<a href="#l3.837"></a><span id="l3.837">     try {</span>
<a href="#l3.838"></a><span id="l3.838">       msgDb = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l3.839"></a><span id="l3.839">                 .getService(Ci.nsIMsgDBService).openFolderDB(aFolder, true);</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-    }</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.843"></a><span id="l3.843"> </span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-    if (msgDb)</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+    if (msgDb) {</span>
<a href="#l3.846"></a><span id="l3.846">       return true;</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+    }</span>
<a href="#l3.848"></a><span id="l3.848"> </span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-    if (!aReparse)</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+    if (!aReparse) {</span>
<a href="#l3.851"></a><span id="l3.851">       return false;</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+    }</span>
<a href="#l3.853"></a><span id="l3.853"> </span>
<a href="#l3.854"></a><span id="l3.854">     // Force a reparse.</span>
<a href="#l3.855"></a><span id="l3.855">     FeedUtils.log.debug(&quot;checkMsgDb: rebuild msgDatabase for &quot; +</span>
<a href="#l3.856"></a><span id="l3.856">                         aFolder.name + &quot; - &quot; + aFolder.filePath.path);</span>
<a href="#l3.857"></a><span id="l3.857">     try {</span>
<a href="#l3.858"></a><span id="l3.858">       // Ignore error returns.</span>
<a href="#l3.859"></a><span id="l3.859">       aFolder.QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l3.860"></a><span id="l3.860">              .getDatabaseWithReparse(aUrlListener, null);</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-    }</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.864"></a><span id="l3.864"> </span>
<a href="#l3.865"></a><span id="l3.865">     return false;</span>
<a href="#l3.866"></a><span id="l3.866">   },</span>
<a href="#l3.867"></a><span id="l3.867"> </span>
<a href="#l3.868"></a><span id="l3.868">   /**</span>
<a href="#l3.869"></a><span id="l3.869">    * Return properties for nsITreeView getCellProperties, for a tree row item in</span>
<a href="#l3.870"></a><span id="l3.870">    * folderpane or subscribe dialog tree.</span>
<a href="#l3.871"></a><span id="l3.871">    *</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-   * @param   nsIMsgFolder aFolder - folder or a feed url's parent folder</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-   * @param   string aFeedUrl      - feed url for a feed row, null for folder</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-   * @return  string               - properties</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - Folder or a feed url's parent folder.</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+   * @param {String} aFeedUrl      - Feed url for a feed row, null for folder.</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+   *</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+   * @returns {String}             - The properties.</span>
<a href="#l3.879"></a><span id="l3.879">    */</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-  getFolderProperties: function(aFolder, aFeedUrl) {</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+  getFolderProperties(aFolder, aFeedUrl) {</span>
<a href="#l3.882"></a><span id="l3.882">     let folder = aFolder;</span>
<a href="#l3.883"></a><span id="l3.883">     let feedUrls = aFeedUrl ? [aFeedUrl] : this.getFeedUrlsInFolder(aFolder);</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-    if (!feedUrls &amp;&amp; !folder.isServer)</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+    if (!feedUrls &amp;&amp; !folder.isServer) {</span>
<a href="#l3.886"></a><span id="l3.886">       return &quot;&quot;;</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+    }</span>
<a href="#l3.888"></a><span id="l3.888"> </span>
<a href="#l3.889"></a><span id="l3.889">     let serverEnabled = this.getStatus(folder.server.rootFolder,</span>
<a href="#l3.890"></a><span id="l3.890">                                        folder.server.rootFolder.URI).enabled;</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-    if (folder.isServer)</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+    if (folder.isServer) {</span>
<a href="#l3.893"></a><span id="l3.893">       return !serverEnabled ? &quot; serverIsPaused&quot; : &quot;&quot;;</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+    }</span>
<a href="#l3.895"></a><span id="l3.895"> </span>
<a href="#l3.896"></a><span id="l3.896">     let properties = aFeedUrl ? &quot; isFeed-true&quot; : &quot; isFeedFolder-true&quot;;</span>
<a href="#l3.897"></a><span id="l3.897">     let hasError, isBusy, numPaused = 0;</span>
<a href="#l3.898"></a><span id="l3.898">     for (let feedUrl of feedUrls) {</span>
<a href="#l3.899"></a><span id="l3.899">       let feedStatus = this.getStatus(folder, feedUrl);</span>
<a href="#l3.900"></a><span id="l3.900">       if (feedStatus.code == FeedUtils.kNewsBlogInvalidFeed ||</span>
<a href="#l3.901"></a><span id="l3.901">           feedStatus.code == FeedUtils.kNewsBlogRequestFailure ||</span>
<a href="#l3.902"></a><span id="l3.902">           feedStatus.code == FeedUtils.kNewsBlogBadCertError ||</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-          feedStatus.code == FeedUtils.kNewsBlogNoAuthError)</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+          feedStatus.code == FeedUtils.kNewsBlogNoAuthError) {</span>
<a href="#l3.905"></a><span id="l3.905">         hasError = true;</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-      if (feedStatus.code == FeedUtils.kNewsBlogFeedIsBusy)</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+      }</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+      if (feedStatus.code == FeedUtils.kNewsBlogFeedIsBusy) {</span>
<a href="#l3.909"></a><span id="l3.909">         isBusy = true;</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-      if (!feedStatus.enabled)</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+      }</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+      if (!feedStatus.enabled) {</span>
<a href="#l3.913"></a><span id="l3.913">         numPaused++;</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+      }</span>
<a href="#l3.915"></a><span id="l3.915">     }</span>
<a href="#l3.916"></a><span id="l3.916"> </span>
<a href="#l3.917"></a><span id="l3.917">     properties += hasError ? &quot; hasError&quot; : &quot;&quot;;</span>
<a href="#l3.918"></a><span id="l3.918">     properties += isBusy ? &quot; isBusy&quot; : &quot;&quot;;</span>
<a href="#l3.919"></a><span id="l3.919">     properties += numPaused == feedUrls.length ? &quot; isPaused&quot; : &quot;&quot;;</span>
<a href="#l3.920"></a><span id="l3.920">     properties += !serverEnabled ? &quot; serverIsPaused&quot; : &quot;&quot;;</span>
<a href="#l3.921"></a><span id="l3.921"> </span>
<a href="#l3.922"></a><span id="l3.922">     return properties;</span>
<a href="#l3.923"></a><span id="l3.923">   },</span>
<a href="#l3.924"></a><span id="l3.924"> </span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-/**</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">- * Update a folderpane cached property.</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">- *</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">- * @param  nsIMsgFolder aFolder   - folder</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">- * @param  string aProperty       - property</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">- * @param  string aValue          - value</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">- * @param  string aInvalidate     - &quot;row&quot; = folder's row.</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">- *                                  &quot;all&quot; = all rows.</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">- */</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-  setFolderPaneProperty: function(aFolder, aProperty, aValue, aInvalidate) {</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+  /**</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+   * Update a folderpane cached property.</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+   *</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+   * @param {nsIMsgFolder} aFolder   - Folder.</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+   * @param {String} aProperty       - Property.</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+   * @param {String} aValue          - Value.</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+   * @param {String} aInvalidate     - &quot;row&quot; = folder's row.</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+   *                                  .&quot;all&quot; = all rows.</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+   */</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+  setFolderPaneProperty(aFolder, aProperty, aValue, aInvalidate) {</span>
<a href="#l3.946"></a><span id="l3.946">     let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-    if (!aFolder || !aProperty || !win || !(&quot;gFolderTreeView&quot; in win))</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+    if (!aFolder || !aProperty || !win || !(&quot;gFolderTreeView&quot; in win)) {</span>
<a href="#l3.949"></a><span id="l3.949">       return;</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+    }</span>
<a href="#l3.951"></a><span id="l3.951"> </span>
<a href="#l3.952"></a><span id="l3.952">     win.gFolderTreeView.setFolderCacheProperty(aFolder, aProperty, aValue);</span>
<a href="#l3.953"></a><span id="l3.953"> </span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-    if (aInvalidate == &quot;all&quot;)</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+    if (aInvalidate == &quot;all&quot;) {</span>
<a href="#l3.956"></a><span id="l3.956">       win.gFolderTreeView._tree.invalidate();</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+    }</span>
<a href="#l3.958"></a><span id="l3.958"> </span>
<a href="#l3.959"></a><span id="l3.959">     if (aInvalidate == &quot;row&quot;) {</span>
<a href="#l3.960"></a><span id="l3.960">       let row = win.gFolderTreeView.getIndexOfFolder(aFolder);</span>
<a href="#l3.961"></a><span id="l3.961">       win.gFolderTreeView._tree.invalidateRow(row);</span>
<a href="#l3.962"></a><span id="l3.962">     }</span>
<a href="#l3.963"></a><span id="l3.963">   },</span>
<a href="#l3.964"></a><span id="l3.964"> </span>
<a href="#l3.965"></a><span id="l3.965">   /**</span>
<a href="#l3.966"></a><span id="l3.966">    * Get a cached feed or folder status.</span>
<a href="#l3.967"></a><span id="l3.967">    *</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-   * @param  nsIMsgFolder aFolder   - folder</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-   * @param  string aUrl            - url key (feed url or folder URI)</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-   * @param  string aProperty       - url status property</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-   * @return string aValue          - value</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+   * @param {nsIMsgFolder} aFolder   - Folder.</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+   * @param {String} aUrl            - Url key (feed url or folder URI).</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+   *</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+   * @returns {String} aValue        - The value.</span>
<a href="#l3.976"></a><span id="l3.976">    */</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-  getStatus: function(aFolder, aUrl) {</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-    if (!aFolder || !aUrl)</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-      return;</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+  getStatus(aFolder, aUrl) {</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+    if (!aFolder || !aUrl) {</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+      return null;</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+    }</span>
<a href="#l3.984"></a><span id="l3.984"> </span>
<a href="#l3.985"></a><span id="l3.985">     let serverKey = aFolder.server.serverURI;</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-    if (!this[serverKey])</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+    if (!this[serverKey]) {</span>
<a href="#l3.988"></a><span id="l3.988">       this[serverKey] = {};</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+    }</span>
<a href="#l3.990"></a><span id="l3.990"> </span>
<a href="#l3.991"></a><span id="l3.991">     if (!this[serverKey][aUrl]) {</span>
<a href="#l3.992"></a><span id="l3.992">       // Seed the status object.</span>
<a href="#l3.993"></a><span id="l3.993">       this[serverKey][aUrl] = {};</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-      this[serverKey][aUrl][&quot;status&quot;] = this.statusTemplate;</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+      this[serverKey][aUrl].status = this.statusTemplate;</span>
<a href="#l3.996"></a><span id="l3.996">       if (FeedUtils.isValidScheme(aUrl)) {</span>
<a href="#l3.997"></a><span id="l3.997">         // Seed persisted status properties for feed urls.</span>
<a href="#l3.998"></a><span id="l3.998">         let feed = new Feed(aUrl, aFolder);</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-        this[serverKey][aUrl][&quot;status&quot;].enabled =</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+        this[serverKey][aUrl].status.enabled =</span>
<a href="#l3.1001"></a><span id="l3.1001">           feed.options.updates.enabled;</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-        this[serverKey][aUrl][&quot;status&quot;].updateMinutes =</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+        this[serverKey][aUrl].status.updateMinutes =</span>
<a href="#l3.1004"></a><span id="l3.1004">           feed.options.updates.updateMinutes;</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-        this[serverKey][aUrl][&quot;status&quot;].lastUpdateTime =</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+        this[serverKey][aUrl].status.lastUpdateTime =</span>
<a href="#l3.1007"></a><span id="l3.1007">           feed.options.updates.lastUpdateTime;</span>
<a href="#l3.1008"></a><span id="l3.1008">         feed = null;</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-      }</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-      else {</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+      } else {</span>
<a href="#l3.1012"></a><span id="l3.1012">         // Seed persisted status properties for servers.</span>
<a href="#l3.1013"></a><span id="l3.1013">         let optionsAcct = FeedUtils.getOptionsAcct(aFolder.server);</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-        this[serverKey][aUrl][&quot;status&quot;].enabled = optionsAcct.doBiff;</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+        this[serverKey][aUrl].status.enabled = optionsAcct.doBiff;</span>
<a href="#l3.1016"></a><span id="l3.1016">       }</span>
<a href="#l3.1017"></a><span id="l3.1017">       FeedUtils.log.debug(&quot;getStatus: seed url - &quot; + aUrl);</span>
<a href="#l3.1018"></a><span id="l3.1018">     }</span>
<a href="#l3.1019"></a><span id="l3.1019"> </span>
<a href="#l3.1020"></a><span id="l3.1020">     return this[serverKey][aUrl].status;</span>
<a href="#l3.1021"></a><span id="l3.1021">   },</span>
<a href="#l3.1022"></a><span id="l3.1022"> </span>
<a href="#l3.1023"></a><span id="l3.1023">   /**</span>
<a href="#l3.1024"></a><span id="l3.1024">    * Update a feed or folder status and refresh folderpane.</span>
<a href="#l3.1025"></a><span id="l3.1025">    *</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-   * @param  nsIMsgFolder aFolder   - folder</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-   * @param  string aUrl            - url key (feed url or folder URI)</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-   * @param  string aProperty       - url status property</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-   * @param  string aValue          - value</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+   * @param {nsIMsgFolder} aFolder   - Folder.</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+   * @param {String} aUrl            - Url key (feed url or folder URI).</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+   * @param {String} aProperty       - Url status property.</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+   * @param {String} aValue          - Value.</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+   *</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+   * @returns {String} aValue        - The value.</span>
<a href="#l3.1036"></a><span id="l3.1036">    */</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-  setStatus: function(aFolder, aUrl, aProperty, aValue) {</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-    if (!aFolder || !aUrl || !aProperty)</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+  setStatus(aFolder, aUrl, aProperty, aValue) {</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+    if (!aFolder || !aUrl || !aProperty) {</span>
<a href="#l3.1041"></a><span id="l3.1041">       return;</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+    }</span>
<a href="#l3.1043"></a><span id="l3.1043"> </span>
<a href="#l3.1044"></a><span id="l3.1044">     if (!this[aFolder.server.serverURI] ||</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-        !this[aFolder.server.serverURI][aUrl])</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+        !this[aFolder.server.serverURI][aUrl]) {</span>
<a href="#l3.1047"></a><span id="l3.1047">       // Not yet seeded, so do it.</span>
<a href="#l3.1048"></a><span id="l3.1048">       this.getStatus(aFolder, aUrl);</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+    }</span>
<a href="#l3.1050"></a><span id="l3.1050"> </span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-    this[aFolder.server.serverURI][aUrl][&quot;status&quot;][aProperty] = aValue;</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+    this[aFolder.server.serverURI][aUrl].status[aProperty] = aValue;</span>
<a href="#l3.1053"></a><span id="l3.1053"> </span>
<a href="#l3.1054"></a><span id="l3.1054">     let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-    if (win &amp;&amp; &quot;gFolderTreeView&quot; in win)</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-    {</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+    if (win &amp;&amp; &quot;gFolderTreeView&quot; in win) {</span>
<a href="#l3.1058"></a><span id="l3.1058">       if (aFolder.isServer) {</span>
<a href="#l3.1059"></a><span id="l3.1059">         win.gFolderTreeView._tree.invalidate();</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-      }</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-      else {</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+      } else {</span>
<a href="#l3.1063"></a><span id="l3.1063">         let row = win.gFolderTreeView.getIndexOfFolder(aFolder);</span>
<a href="#l3.1064"></a><span id="l3.1064">         win.gFolderTreeView._tree.invalidateRow(row);</span>
<a href="#l3.1065"></a><span id="l3.1065">       }</span>
<a href="#l3.1066"></a><span id="l3.1066">     }</span>
<a href="#l3.1067"></a><span id="l3.1067"> </span>
<a href="#l3.1068"></a><span id="l3.1068">     win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-    if (win)</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineplus">+    if (win) {</span>
<a href="#l3.1071"></a><span id="l3.1071">       win.FeedSubscriptions.mView.treeBox.invalidate();</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+    }</span>
<a href="#l3.1073"></a><span id="l3.1073">   },</span>
<a href="#l3.1074"></a><span id="l3.1074"> </span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-/**</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">- * Get the favicon for a feed folder subscription url (first one) or a feed</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">- * message url. The favicon service caches it in memory if places history is</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">- * not enabled.</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">- *</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">- * @param  nsIMsgFolder aFolder - the feed folder or null if aUrl</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">- * @param  string aUrl          - a url (feed, message, other) or null if aFolder</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">- * @param  string aIconUrl      - the icon url if already determined, else null</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">- * @param  nsIDOMWindow aWindow - null if requesting url without setting it</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">- * @param  function aCallback   - null or callback</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">- * @return string               - the favicon url or empty string</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">- */</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-  getFavicon: function(aFolder, aUrl, aIconUrl, aWindow, aCallback) {</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+  /**</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+   * Get the favicon for a feed folder subscription url (first one) or a feed</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+   * message url. The favicon service caches it in memory if places history is</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+   * not enabled.</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineplus">+   *</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - The feed folder or null if aUrl.</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+   * @param {String} aUrl          - A url (feed, message, other) or null if aFolder.</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineplus">+   * @param {String} aIconUrl      - The icon url if already determined, else null.</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineplus">+   * @param {nsIDOMWindow} aWindow - Null if requesting url without setting it.</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineplus">+   * @param {Function} aCallback   - Null or callback.</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+   *</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+   * @returns {String}             - The favicon url or empty string.</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+   */</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineplus">+  getFavicon(aFolder, aUrl, aIconUrl, aWindow, aCallback) {</span>
<a href="#l3.1102"></a><span id="l3.1102">     // On any error, cache an empty string to show the default favicon, and</span>
<a href="#l3.1103"></a><span id="l3.1103">     // don't try anymore in this session.</span>
<a href="#l3.1104"></a><span id="l3.1104">     let useDefaultFavicon = (() =&gt; {</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-      if (aCallback)</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+      if (aCallback) {</span>
<a href="#l3.1107"></a><span id="l3.1107">         aCallback(&quot;&quot;);</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+      }</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+</span>
<a href="#l3.1110"></a><span id="l3.1110">       return &quot;&quot;;</span>
<a href="#l3.1111"></a><span id="l3.1111">     });</span>
<a href="#l3.1112"></a><span id="l3.1112"> </span>
<a href="#l3.1113"></a><span id="l3.1113">     if (!Services.prefs.getBoolPref(&quot;browser.chrome.site_icons&quot;) ||</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-        !Services.prefs.getBoolPref(&quot;browser.chrome.favicons&quot;))</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+        !Services.prefs.getBoolPref(&quot;browser.chrome.favicons&quot;)) {</span>
<a href="#l3.1116"></a><span id="l3.1116">       return useDefaultFavicon();</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+    }</span>
<a href="#l3.1118"></a><span id="l3.1118"> </span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">-    if (aIconUrl != null)</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+    if (aIconUrl != null) {</span>
<a href="#l3.1121"></a><span id="l3.1121">       return aIconUrl;</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+    }</span>
<a href="#l3.1123"></a><span id="l3.1123"> </span>
<a href="#l3.1124"></a><span id="l3.1124">     let onLoadSuccess = (aEvent =&gt; {</span>
<a href="#l3.1125"></a><span id="l3.1125">       let iconUri = Services.io.newURI(aEvent.target.src);</span>
<a href="#l3.1126"></a><span id="l3.1126">       aWindow.specialTabs.mFaviconService.setAndFetchFaviconForPage(</span>
<a href="#l3.1127"></a><span id="l3.1127">         uri, iconUri, false,</span>
<a href="#l3.1128"></a><span id="l3.1128">         aWindow.specialTabs.mFaviconService.FAVICON_LOAD_NON_PRIVATE,</span>
<a href="#l3.1129"></a><span id="l3.1129">         null, Services.scriptSecurityManager.getSystemPrincipal());</span>
<a href="#l3.1130"></a><span id="l3.1130"> </span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-      if (aCallback)</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+      if (aCallback) {</span>
<a href="#l3.1133"></a><span id="l3.1133">         aCallback(iconUri.spec);</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineplus">+      }</span>
<a href="#l3.1135"></a><span id="l3.1135">     });</span>
<a href="#l3.1136"></a><span id="l3.1136"> </span>
<a href="#l3.1137"></a><span id="l3.1137">     let onLoadError = (aEvent =&gt; {</span>
<a href="#l3.1138"></a><span id="l3.1138">       useDefaultFavicon();</span>
<a href="#l3.1139"></a><span id="l3.1139">       let url = aEvent.target.src;</span>
<a href="#l3.1140"></a><span id="l3.1140">       aWindow.specialTabs.getFaviconFromPage(url, aCallback);</span>
<a href="#l3.1141"></a><span id="l3.1141">     });</span>
<a href="#l3.1142"></a><span id="l3.1142"> </span>
<a href="#l3.1143"></a><span id="l3.1143">     let url = aUrl;</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-    if (!url)</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-    {</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+    if (!url) {</span>
<a href="#l3.1147"></a><span id="l3.1147">       // Get the proposed iconUrl from the folder's first subscribed feed's</span>
<a href="#l3.1148"></a><span id="l3.1148">       // &lt;link&gt;.</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-      if (!aFolder)</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+      if (!aFolder) {</span>
<a href="#l3.1151"></a><span id="l3.1151">         return useDefaultFavicon();</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+      }</span>
<a href="#l3.1153"></a><span id="l3.1153"> </span>
<a href="#l3.1154"></a><span id="l3.1154">       let feedUrls = this.getFeedUrlsInFolder(aFolder);</span>
<a href="#l3.1155"></a><span id="l3.1155">       url = feedUrls ? feedUrls[0] : null;</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-      if (!url)</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineplus">+      if (!url) {</span>
<a href="#l3.1158"></a><span id="l3.1158">         return useDefaultFavicon();</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineplus">+      }</span>
<a href="#l3.1160"></a><span id="l3.1160">     }</span>
<a href="#l3.1161"></a><span id="l3.1161"> </span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-    if (aFolder)</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-    {</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineplus">+    if (aFolder) {</span>
<a href="#l3.1165"></a><span id="l3.1165">       let feed = new Feed(url, aFolder);</span>
<a href="#l3.1166"></a><span id="l3.1166">       url = feed.link &amp;&amp; feed.link.startsWith(&quot;http&quot;) ? feed.link : url;</span>
<a href="#l3.1167"></a><span id="l3.1167">     }</span>
<a href="#l3.1168"></a><span id="l3.1168"> </span>
<a href="#l3.1169"></a><span id="l3.1169">     let uri, iconUri;</span>
<a href="#l3.1170"></a><span id="l3.1170">     try {</span>
<a href="#l3.1171"></a><span id="l3.1171">       uri = Services.io.newURI(url);</span>
<a href="#l3.1172"></a><span id="l3.1172">       iconUri = Services.io.newURI(uri.prePath + &quot;/favicon.ico&quot;);</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-    }</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.1176"></a><span id="l3.1176">       return useDefaultFavicon();</span>
<a href="#l3.1177"></a><span id="l3.1177">     }</span>
<a href="#l3.1178"></a><span id="l3.1178"> </span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineminus">-    if (!aWindow)</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineplus">+    if (!aWindow) {</span>
<a href="#l3.1181"></a><span id="l3.1181">       return iconUri.spec;</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineplus">+    }</span>
<a href="#l3.1183"></a><span id="l3.1183"> </span>
<a href="#l3.1184"></a><span id="l3.1184">     aWindow.specialTabs.loadFaviconImageNode(onLoadSuccess, onLoadError,</span>
<a href="#l3.1185"></a><span id="l3.1185">                                              iconUri.spec);</span>
<a href="#l3.1186"></a><span id="l3.1186">     // Cache the favicon url initially.</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-    if (aCallback)</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+    if (aCallback) {</span>
<a href="#l3.1189"></a><span id="l3.1189">       aCallback(iconUri.spec);</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+    }</span>
<a href="#l3.1191"></a><span id="l3.1191"> </span>
<a href="#l3.1192"></a><span id="l3.1192">     return iconUri.spec;</span>
<a href="#l3.1193"></a><span id="l3.1193">   },</span>
<a href="#l3.1194"></a><span id="l3.1194"> </span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-/**</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">- * Update the feeds.rdf database for rename and move/copy folder name changes.</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">- *</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">- * @param  nsIMsgFolder aFolder      - the folder, new if rename or target of</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">- *                                      move/copy folder (new parent)</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">- * @param  nsIMsgFolder aOrigFolder  - original folder</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">- * @param  string aAction            - &quot;move&quot; or &quot;copy&quot; or &quot;rename&quot;</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineminus">- */</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineminus">-  updateSubscriptionsDS: function(aFolder, aOrigFolder, aAction) {</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineplus">+  /**</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineplus">+   * Update the feeds.rdf database for rename and move/copy folder name changes.</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineplus">+   *</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineplus">+   * @param {nsIMsgFolder} aFolder      - The folder, new if rename or target of</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineplus">+   *                                      move/copy folder (new parent).</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineplus">+   * @param {nsIMsgFolder} aOrigFolder  - Original folder.</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineplus">+   * @param {String} aAction            - &quot;move&quot; or &quot;copy&quot; or &quot;rename&quot;.</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineplus">+   *</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineplus">+   */</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineplus">+  updateSubscriptionsDS(aFolder, aOrigFolder, aAction) {</span>
<a href="#l3.1215"></a><span id="l3.1215">     this.log.debug(&quot;FeedUtils.updateSubscriptionsDS: &quot; +</span>
<a href="#l3.1216"></a><span id="l3.1216">                    &quot;\nfolder changed - &quot; + aAction +</span>
<a href="#l3.1217"></a><span id="l3.1217">                    &quot;\nnew folder  - &quot; + aFolder.filePath.path +</span>
<a href="#l3.1218"></a><span id="l3.1218">                    &quot;\norig folder - &quot; + aOrigFolder.filePath.path);</span>
<a href="#l3.1219"></a><span id="l3.1219"> </span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-    if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aOrigFolder))</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineplus">+    if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aOrigFolder)) {</span>
<a href="#l3.1222"></a><span id="l3.1222">       // Target not a feed account folder; nothing to do, or move/rename in</span>
<a href="#l3.1223"></a><span id="l3.1223">       // trash; no subscriptions already.</span>
<a href="#l3.1224"></a><span id="l3.1224">       return;</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineplus">+    }</span>
<a href="#l3.1226"></a><span id="l3.1226"> </span>
<a href="#l3.1227"></a><span id="l3.1227">     let newFolder = aFolder;</span>
<a href="#l3.1228"></a><span id="l3.1228">     let newParentURI = aFolder.URI;</span>
<a href="#l3.1229"></a><span id="l3.1229">     let origParentURI = aOrigFolder.URI;</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-    if (aAction == &quot;move&quot; || aAction == &quot;copy&quot;)</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineminus">-    {</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineplus">+    if (aAction == &quot;move&quot; || aAction == &quot;copy&quot;) {</span>
<a href="#l3.1233"></a><span id="l3.1233">       // Get the new folder. Don't process the entire parent (new dest folder)!</span>
<a href="#l3.1234"></a><span id="l3.1234">       newFolder = aFolder.getChildNamed(aOrigFolder.name);</span>
<a href="#l3.1235"></a><span id="l3.1235">       origParentURI = aOrigFolder.parent ? aOrigFolder.parent.URI :</span>
<a href="#l3.1236"></a><span id="l3.1236">                                            aOrigFolder.rootFolder.URI;</span>
<a href="#l3.1237"></a><span id="l3.1237">     }</span>
<a href="#l3.1238"></a><span id="l3.1238"> </span>
<a href="#l3.1239"></a><span id="l3.1239">     this.updateFolderChangeInFeedsDS(newFolder, aOrigFolder, null, null);</span>
<a href="#l3.1240"></a><span id="l3.1240"> </span>
<a href="#l3.1241"></a><span id="l3.1241">     // There may be subfolders, but we only get a single notification; iterate</span>
<a href="#l3.1242"></a><span id="l3.1242">     // over all descendent folders of the folder whose location has changed.</span>
<a href="#l3.1243"></a><span id="l3.1243">     let newSubFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.1244"></a><span id="l3.1244">     newFolder.ListDescendants(newSubFolders);</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineminus">-    for (let i = 0; i &lt; newSubFolders.length; i++)</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-    {</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+    for (let i = 0; i &lt; newSubFolders.length; i++) {</span>
<a href="#l3.1248"></a><span id="l3.1248">       let newSubFolder = newSubFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l3.1249"></a><span id="l3.1249">       FeedUtils.updateFolderChangeInFeedsDS(newSubFolder, aOrigFolder,</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineminus">-                                            newParentURI, origParentURI)</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineplus">+                                            newParentURI, origParentURI);</span>
<a href="#l3.1252"></a><span id="l3.1252">     }</span>
<a href="#l3.1253"></a><span id="l3.1253">   },</span>
<a href="#l3.1254"></a><span id="l3.1254"> </span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineminus">-/**</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineminus">- * Update the feeds.rdf database with the new folder's or subfolder's location</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineminus">- * for rename and move/copy name changes. The feeds.rdf subscriptions db is</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineminus">- * also synced on cross account folder copies. Note that if a copied folder's</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">- * url exists in the new account, its active subscription will be switched to</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">- * the folder being copied, to enforce the one unique url per account design.</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">- *</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">- * @param  nsIMsgFolder aFolder      - new folder</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineminus">- * @param  nsIMsgFolder aOrigFolder  - original folder</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineminus">- * @param  string aNewAncestorURI    - for subfolders, ancestor new folder</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineminus">- * @param  string aOrigAncestorURI   - for subfolders, ancestor original folder</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">- */</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-  updateFolderChangeInFeedsDS: function(aFolder, aOrigFolder,</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-                                        aNewAncestorURI, aOrigAncestorURI) {</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineplus">+  /**</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineplus">+   * Update the feeds.rdf database with the new folder's or subfolder's location</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineplus">+   * for rename and move/copy name changes. The feeds.rdf subscriptions db is</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineplus">+   * also synced on cross account folder copies. Note that if a copied folder's</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineplus">+   * url exists in the new account, its active subscription will be switched to</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineplus">+   * the folder being copied, to enforce the one unique url per account design.</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineplus">+   *</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineplus">+   * @param {nsIMsgFolder} aFolder      - New folder.</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineplus">+   * @param {nsIMsgFolder} aOrigFolder  - Original folder.</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineplus">+   * @param {String} aNewAncestorURI    - For subfolders, ancestor new folder.</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineplus">+   * @param {String} aOrigAncestorURI   - For subfolders, ancestor original folder.</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineplus">+   *</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineplus">+   */</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineplus">+  updateFolderChangeInFeedsDS(aFolder, aOrigFolder, aNewAncestorURI, aOrigAncestorURI) {</span>
<a href="#l3.1284"></a><span id="l3.1284">     this.log.debug(&quot;updateFolderChangeInFeedsDS: &quot; +</span>
<a href="#l3.1285"></a><span id="l3.1285">                    &quot;\naFolder       - &quot; + aFolder.URI +</span>
<a href="#l3.1286"></a><span id="l3.1286">                    &quot;\naOrigFolder   - &quot; + aOrigFolder.URI +</span>
<a href="#l3.1287"></a><span id="l3.1287">                    &quot;\naOrigAncestor - &quot; + aOrigAncestorURI +</span>
<a href="#l3.1288"></a><span id="l3.1288">                    &quot;\naNewAncestor  - &quot; + aNewAncestorURI);</span>
<a href="#l3.1289"></a><span id="l3.1289"> </span>
<a href="#l3.1290"></a><span id="l3.1290">     // Get the original folder's URI.</span>
<a href="#l3.1291"></a><span id="l3.1291">     let folderURI = aFolder.URI;</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineat">@@ -1008,386 +1040,390 @@ var FeedUtils = {</span>
<a href="#l3.1293"></a><span id="l3.1293">                     aOrigFolder.URI;</span>
<a href="#l3.1294"></a><span id="l3.1294">     let origFolderRes = this.rdf.GetResource(origURI);</span>
<a href="#l3.1295"></a><span id="l3.1295">     this.log.debug(&quot;updateFolderChangeInFeedsDS: urls origURI  - &quot; + origURI);</span>
<a href="#l3.1296"></a><span id="l3.1296">     // Get the original folder's url list from the feeds database.</span>
<a href="#l3.1297"></a><span id="l3.1297">     let feedUrlArray = [];</span>
<a href="#l3.1298"></a><span id="l3.1298">     let dsSrc = this.getSubscriptionsDS(aOrigFolder.server);</span>
<a href="#l3.1299"></a><span id="l3.1299">     try {</span>
<a href="#l3.1300"></a><span id="l3.1300">       let enumerator = dsSrc.GetSources(this.FZ_DESTFOLDER, origFolderRes, true);</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-      while (enumerator.hasMoreElements())</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineminus">-      {</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineplus">+      while (enumerator.hasMoreElements()) {</span>
<a href="#l3.1304"></a><span id="l3.1304">         let containerArc = enumerator.getNext();</span>
<a href="#l3.1305"></a><span id="l3.1305">         let uri = containerArc.QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l3.1306"></a><span id="l3.1306">         feedUrlArray.push(uri);</span>
<a href="#l3.1307"></a><span id="l3.1307">       }</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineminus">-    }</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-    catch(ex)</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-    {</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.1312"></a><span id="l3.1312">       this.log.error(&quot;updateFolderChangeInFeedsDS: feeds.rdf db error for account - &quot; +</span>
<a href="#l3.1313"></a><span id="l3.1313">                      aOrigFolder.server.prettyName + &quot; : &quot; + ex);</span>
<a href="#l3.1314"></a><span id="l3.1314">     }</span>
<a href="#l3.1315"></a><span id="l3.1315"> </span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-    if (!feedUrlArray.length)</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineminus">-    {</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineplus">+    if (!feedUrlArray.length) {</span>
<a href="#l3.1319"></a><span id="l3.1319">       this.log.debug(&quot;updateFolderChangeInFeedsDS: no feedUrls in this folder&quot;);</span>
<a href="#l3.1320"></a><span id="l3.1320">       return;</span>
<a href="#l3.1321"></a><span id="l3.1321">     }</span>
<a href="#l3.1322"></a><span id="l3.1322"> </span>
<a href="#l3.1323"></a><span id="l3.1323">     let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineminus">-    for (let feedUrl of feedUrlArray)</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineminus">-    {</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineplus">+    for (let feedUrl of feedUrlArray) {</span>
<a href="#l3.1327"></a><span id="l3.1327">       this.log.debug(&quot;updateFolderChangeInFeedsDS: feedUrl - &quot; + feedUrl);</span>
<a href="#l3.1328"></a><span id="l3.1328">       let feed = new Feed(feedUrl, aFolder);</span>
<a href="#l3.1329"></a><span id="l3.1329"> </span>
<a href="#l3.1330"></a><span id="l3.1330">       // If move to trash, unsubscribe.</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineminus">-      if (this.isInTrash(aFolder))</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineminus">-      {</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineplus">+      if (this.isInTrash(aFolder)) {</span>
<a href="#l3.1334"></a><span id="l3.1334">         this.deleteFeed(feed);</span>
<a href="#l3.1335"></a><span id="l3.1335" class="difflineminus">-      }</span>
<a href="#l3.1336"></a><span id="l3.1336" class="difflineminus">-      else</span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-      {</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineplus">+      } else {</span>
<a href="#l3.1339"></a><span id="l3.1339">         let folderResource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l3.1340"></a><span id="l3.1340">         // Get the node for the current folder URI.</span>
<a href="#l3.1341"></a><span id="l3.1341">         let node = ds.GetTarget(feed.resource, this.FZ_DESTFOLDER, true);</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-        if (node)</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineminus">-        {</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineplus">+        if (node) {</span>
<a href="#l3.1345"></a><span id="l3.1345">           ds.Change(feed.resource, this.FZ_DESTFOLDER, node, folderResource);</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineminus">-        }</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-        else</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineminus">-        {</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineplus">+        } else {</span>
<a href="#l3.1350"></a><span id="l3.1350">           // If adding a new feed it's a cross account action; make sure to</span>
<a href="#l3.1351"></a><span id="l3.1351">           // preserve all properties from the original datasource where</span>
<a href="#l3.1352"></a><span id="l3.1352">           // available. Otherwise use the new folder's name and default server</span>
<a href="#l3.1353"></a><span id="l3.1353">           // quickMode; preserve link and options.</span>
<a href="#l3.1354"></a><span id="l3.1354">           let feedTitle = dsSrc.GetTarget(feed.resource, this.DC_TITLE, true);</span>
<a href="#l3.1355"></a><span id="l3.1355">           feedTitle = feedTitle ? feedTitle.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l3.1356"></a><span id="l3.1356">                                   folderResource.name;</span>
<a href="#l3.1357"></a><span id="l3.1357">           let link = dsSrc.GetTarget(feed.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l3.1358"></a><span id="l3.1358">           link = link ? link.QueryInterface(Ci.nsIRDFLiteral).Value : &quot;&quot;;</span>
<a href="#l3.1359"></a><span id="l3.1359">           let quickMode = dsSrc.GetTarget(feed.resource, this.FZ_QUICKMODE, true);</span>
<a href="#l3.1360"></a><span id="l3.1360">           quickMode = quickMode ? quickMode.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l3.1361"></a><span id="l3.1361">                                   null;</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-          quickMode = quickMode == &quot;true&quot; ? true :</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineminus">-                      quickMode == &quot;false&quot; ? false :</span>
<a href="#l3.1364"></a><span id="l3.1364" class="difflineminus">-                      feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineplus">+          if (quickMode == &quot;true&quot;) {</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineplus">+            quickMode = true;</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineplus">+          } else if (quickMode == &quot;false&quot;) {</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineplus">+            quickMode = false;</span>
<a href="#l3.1369"></a><span id="l3.1369" class="difflineplus">+          } else {</span>
<a href="#l3.1370"></a><span id="l3.1370" class="difflineplus">+            quickMode = feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineplus">+          }</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineplus">+</span>
<a href="#l3.1373"></a><span id="l3.1373">           let options = dsSrc.GetTarget(feed.resource, this.FZ_OPTIONS, true);</span>
<a href="#l3.1374"></a><span id="l3.1374">           options = options ? JSON.parse(options.QueryInterface(Ci.nsIRDFLiteral).Value) :</span>
<a href="#l3.1375"></a><span id="l3.1375">                               this.optionsTemplate;</span>
<a href="#l3.1376"></a><span id="l3.1376">           // Update the feedUrl feed properties.</span>
<a href="#l3.1377"></a><span id="l3.1377">           feed.title = feedTitle;</span>
<a href="#l3.1378"></a><span id="l3.1378">           feed.link = link;</span>
<a href="#l3.1379"></a><span id="l3.1379">           feed.quickMode = quickMode;</span>
<a href="#l3.1380"></a><span id="l3.1380">           feed.options = options;</span>
<a href="#l3.1381"></a><span id="l3.1381">           this.addFeed(feed);</span>
<a href="#l3.1382"></a><span id="l3.1382">         }</span>
<a href="#l3.1383"></a><span id="l3.1383">       }</span>
<a href="#l3.1384"></a><span id="l3.1384">     }</span>
<a href="#l3.1385"></a><span id="l3.1385"> </span>
<a href="#l3.1386"></a><span id="l3.1386">     ds.Flush();</span>
<a href="#l3.1387"></a><span id="l3.1387">   },</span>
<a href="#l3.1388"></a><span id="l3.1388"> </span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-/**</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">- * When subscribing to feeds by dnd on, or adding a url to, the account</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">- * folder (only), or creating folder structure via opml import, a subfolder is</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">- * autocreated and thus the derived/given name must be sanitized to prevent</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">- * filesystem errors. Hashing invalid chars based on OS rather than filesystem</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">- * is not strictly correct.</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineminus">- *</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineminus">- * @param  nsIMsgFolder aParentFolder - parent folder</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">- * @param  string       aProposedName - proposed name</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineminus">- * @param  string       aDefaultName  - default name if proposed sanitizes to</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">- *                                      blank, caller ensures sane value</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineminus">- * @param  bool         aUnique       - if true, return a unique indexed name.</span>
<a href="#l3.1401"></a><span id="l3.1401" class="difflineminus">- * @return string                     - sanitized unique name</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineminus">- */</span>
<a href="#l3.1403"></a><span id="l3.1403" class="difflineminus">-  getSanitizedFolderName: function(aParentFolder, aProposedName, aDefaultName, aUnique) {</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineplus">+  /**</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineplus">+   * When subscribing to feeds by dnd on, or adding a url to, the account</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineplus">+   * folder (only), or creating folder structure via opml import, a subfolder is</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineplus">+   * autocreated and thus the derived/given name must be sanitized to prevent</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineplus">+   * filesystem errors. Hashing invalid chars based on OS rather than filesystem</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineplus">+   * is not strictly correct.</span>
<a href="#l3.1410"></a><span id="l3.1410" class="difflineplus">+   *</span>
<a href="#l3.1411"></a><span id="l3.1411" class="difflineplus">+   * @param {nsIMsgFolder} aParentFolder - Parent folder.</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineplus">+   * @param {String}       aProposedName - Proposed name.</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineplus">+   * @param {String}       aDefaultName  - Default name if proposed sanitizes to</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineplus">+   *                                       blank, caller ensures sane value.</span>
<a href="#l3.1415"></a><span id="l3.1415" class="difflineplus">+   * @param {Boolean}      aUnique       - If true, return a unique indexed name.</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineplus">+   *</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineplus">+   * @returns {String}                   - Sanitized unique name.</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineplus">+   */</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineplus">+  getSanitizedFolderName(aParentFolder, aProposedName, aDefaultName, aUnique) {</span>
<a href="#l3.1420"></a><span id="l3.1420">     // Clean up the name for the strictest fs (fat) and to ensure portability.</span>
<a href="#l3.1421"></a><span id="l3.1421">     // 1) Replace line breaks and tabs '\n\r\t' with a space.</span>
<a href="#l3.1422"></a><span id="l3.1422">     // 2) Remove nonprintable ascii.</span>
<a href="#l3.1423"></a><span id="l3.1423">     // 3) Remove invalid win chars '* | \ / : &lt; &gt; ? &quot;'.</span>
<a href="#l3.1424"></a><span id="l3.1424">     // 4) Remove all '.' as starting/ending with one is trouble on osx/win.</span>
<a href="#l3.1425"></a><span id="l3.1425">     // 5) No leading/trailing spaces.</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineplus">+    /* eslint-disable no-control-regex */</span>
<a href="#l3.1427"></a><span id="l3.1427">     let folderName = aProposedName.replace(/[\n\r\t]+/g, &quot; &quot;)</span>
<a href="#l3.1428"></a><span id="l3.1428">                                   .replace(/[\x00-\x1F]+/g, &quot;&quot;)</span>
<a href="#l3.1429"></a><span id="l3.1429">                                   .replace(/[*|\\\/:&lt;&gt;?&quot;]+/g, &quot;&quot;)</span>
<a href="#l3.1430"></a><span id="l3.1430">                                   .replace(/[\.]+/g, &quot;&quot;)</span>
<a href="#l3.1431"></a><span id="l3.1431">                                   .trim();</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineplus">+    /* eslint-enable no-control-regex */</span>
<a href="#l3.1433"></a><span id="l3.1433"> </span>
<a href="#l3.1434"></a><span id="l3.1434">     // Prefix with __ if name is:</span>
<a href="#l3.1435"></a><span id="l3.1435">     // 1) a reserved win filename.</span>
<a href="#l3.1436"></a><span id="l3.1436">     // 2) an undeletable/unrenameable special folder name (bug 259184).</span>
<a href="#l3.1437"></a><span id="l3.1437">     if (folderName.toUpperCase()</span>
<a href="#l3.1438"></a><span id="l3.1438">                   .match(/^COM\d$|^LPT\d$|^CON$|PRN$|^AUX$|^NUL$|^CLOCK\$/) ||</span>
<a href="#l3.1439"></a><span id="l3.1439">         folderName.toUpperCase()</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-                  .match(/^INBOX$|^OUTBOX$|^UNSENT MESSAGES$|^TRASH$/))</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineplus">+                  .match(/^INBOX$|^OUTBOX$|^UNSENT MESSAGES$|^TRASH$/)) {</span>
<a href="#l3.1442"></a><span id="l3.1442">       folderName = &quot;__&quot; + folderName;</span>
<a href="#l3.1443"></a><span id="l3.1443" class="difflineplus">+    }</span>
<a href="#l3.1444"></a><span id="l3.1444"> </span>
<a href="#l3.1445"></a><span id="l3.1445">     // Use a default if no name is found.</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-    if (!folderName)</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineplus">+    if (!folderName) {</span>
<a href="#l3.1448"></a><span id="l3.1448">       folderName = aDefaultName;</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineplus">+    }</span>
<a href="#l3.1450"></a><span id="l3.1450"> </span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineminus">-    if (!aUnique)</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineplus">+    if (!aUnique) {</span>
<a href="#l3.1453"></a><span id="l3.1453">       return folderName;</span>
<a href="#l3.1454"></a><span id="l3.1454" class="difflineplus">+    }</span>
<a href="#l3.1455"></a><span id="l3.1455"> </span>
<a href="#l3.1456"></a><span id="l3.1456">     // Now ensure the folder name is not a dupe; if so append index.</span>
<a href="#l3.1457"></a><span id="l3.1457">     let folderNameBase = folderName;</span>
<a href="#l3.1458"></a><span id="l3.1458">     let i = 2;</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-    while (aParentFolder.containsChildNamed(folderName))</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineminus">-    {</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineplus">+    while (aParentFolder.containsChildNamed(folderName)) {</span>
<a href="#l3.1462"></a><span id="l3.1462">       folderName = folderNameBase + &quot;-&quot; + i++;</span>
<a href="#l3.1463"></a><span id="l3.1463">     }</span>
<a href="#l3.1464"></a><span id="l3.1464"> </span>
<a href="#l3.1465"></a><span id="l3.1465">     return folderName;</span>
<a href="#l3.1466"></a><span id="l3.1466">   },</span>
<a href="#l3.1467"></a><span id="l3.1467"> </span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-/**</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">- * This object contains feed/account status info.</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">- */</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineplus">+  /**</span>
<a href="#l3.1472"></a><span id="l3.1472" class="difflineplus">+   * This object contains feed/account status info.</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineplus">+   */</span>
<a href="#l3.1474"></a><span id="l3.1474">   _statusDefault: {</span>
<a href="#l3.1475"></a><span id="l3.1475">     // Derived from persisted value.</span>
<a href="#l3.1476"></a><span id="l3.1476">     enabled: null,</span>
<a href="#l3.1477"></a><span id="l3.1477">     // Last update result code, a kNewsBlog* value.</span>
<a href="#l3.1478"></a><span id="l3.1478">     code: 0,</span>
<a href="#l3.1479"></a><span id="l3.1479">     updateMinutes: null,</span>
<a href="#l3.1480"></a><span id="l3.1480">     // JS Date; startup state is null indicating no update since startup.</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineminus">-    lastUpdateTime: null</span>
<a href="#l3.1482"></a><span id="l3.1482" class="difflineplus">+    lastUpdateTime: null,</span>
<a href="#l3.1483"></a><span id="l3.1483">   },</span>
<a href="#l3.1484"></a><span id="l3.1484"> </span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-  get statusTemplate()</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineminus">-  {</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineplus">+  get statusTemplate() {</span>
<a href="#l3.1488"></a><span id="l3.1488">     // Copy the object.</span>
<a href="#l3.1489"></a><span id="l3.1489">     return JSON.parse(JSON.stringify(this._statusDefault));</span>
<a href="#l3.1490"></a><span id="l3.1490">   },</span>
<a href="#l3.1491"></a><span id="l3.1491"> </span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-/**</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">- * This object will contain all persisted feed specific properties.</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineminus">- */</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineplus">+  /**</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineplus">+   * This object will contain all persisted feed specific properties.</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineplus">+   */</span>
<a href="#l3.1498"></a><span id="l3.1498">   _optionsDefault: {</span>
<a href="#l3.1499"></a><span id="l3.1499">     version: 2,</span>
<a href="#l3.1500"></a><span id="l3.1500">     updates: {</span>
<a href="#l3.1501"></a><span id="l3.1501">       enabled: true,</span>
<a href="#l3.1502"></a><span id="l3.1502">       // User set.</span>
<a href="#l3.1503"></a><span id="l3.1503">       updateMinutes: 100,</span>
<a href="#l3.1504"></a><span id="l3.1504">       // User set: &quot;min&quot;=minutes, &quot;d&quot;=days</span>
<a href="#l3.1505"></a><span id="l3.1505">       updateUnits: &quot;min&quot;,</span>
<a href="#l3.1506"></a><span id="l3.1506">       // JS Date.</span>
<a href="#l3.1507"></a><span id="l3.1507">       lastUpdateTime: null,</span>
<a href="#l3.1508"></a><span id="l3.1508">       // The last time a new message was stored. JS Date.</span>
<a href="#l3.1509"></a><span id="l3.1509">       lastDownloadTime: null,</span>
<a href="#l3.1510"></a><span id="l3.1510">       // Publisher recommended from the feed.</span>
<a href="#l3.1511"></a><span id="l3.1511">       updatePeriod: null,</span>
<a href="#l3.1512"></a><span id="l3.1512">       updateFrequency: 1,</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineminus">-      updateBase: null</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineplus">+      updateBase: null,</span>
<a href="#l3.1515"></a><span id="l3.1515">     },</span>
<a href="#l3.1516"></a><span id="l3.1516">     // Autotag and &lt;category&gt; handling options.</span>
<a href="#l3.1517"></a><span id="l3.1517">     category: {</span>
<a href="#l3.1518"></a><span id="l3.1518">       enabled: false,</span>
<a href="#l3.1519"></a><span id="l3.1519">       prefixEnabled: false,</span>
<a href="#l3.1520"></a><span id="l3.1520">       prefix: null,</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineminus">-    }</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineplus">+    },</span>
<a href="#l3.1523"></a><span id="l3.1523">   },</span>
<a href="#l3.1524"></a><span id="l3.1524"> </span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-  get optionsTemplate()</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineminus">-  {</span>
<a href="#l3.1527"></a><span id="l3.1527" class="difflineplus">+  get optionsTemplate() {</span>
<a href="#l3.1528"></a><span id="l3.1528">     // Copy the object.</span>
<a href="#l3.1529"></a><span id="l3.1529">     return JSON.parse(JSON.stringify(this._optionsDefault));</span>
<a href="#l3.1530"></a><span id="l3.1530">   },</span>
<a href="#l3.1531"></a><span id="l3.1531"> </span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineminus">-  getOptionsAcct: function(aServer)</span>
<a href="#l3.1533"></a><span id="l3.1533" class="difflineminus">-  {</span>
<a href="#l3.1534"></a><span id="l3.1534" class="difflineplus">+  getOptionsAcct(aServer) {</span>
<a href="#l3.1535"></a><span id="l3.1535">     let optionsAcct;</span>
<a href="#l3.1536"></a><span id="l3.1536">     let optionsAcctPref = &quot;mail.server.&quot; + aServer.key + &quot;.feed_options&quot;;</span>
<a href="#l3.1537"></a><span id="l3.1537">     let check_new_mail = &quot;mail.server.&quot; + aServer.key + &quot;.check_new_mail&quot;;</span>
<a href="#l3.1538"></a><span id="l3.1538">     let check_time = &quot;mail.server.&quot; + aServer.key + &quot;.check_time&quot;;</span>
<a href="#l3.1539"></a><span id="l3.1539"> </span>
<a href="#l3.1540"></a><span id="l3.1540">     // Biff enabled or not. Make sure pref exists.</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-    if (!Services.prefs.prefHasUserValue(check_new_mail))</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineplus">+    if (!Services.prefs.prefHasUserValue(check_new_mail)) {</span>
<a href="#l3.1543"></a><span id="l3.1543">       Services.prefs.setBoolPref(check_new_mail, true);</span>
<a href="#l3.1544"></a><span id="l3.1544" class="difflineplus">+    }</span>
<a href="#l3.1545"></a><span id="l3.1545"> </span>
<a href="#l3.1546"></a><span id="l3.1546">     // System polling interval. Make sure pref exists.</span>
<a href="#l3.1547"></a><span id="l3.1547" class="difflineminus">-    if (!Services.prefs.prefHasUserValue(check_time))</span>
<a href="#l3.1548"></a><span id="l3.1548" class="difflineplus">+    if (!Services.prefs.prefHasUserValue(check_time)) {</span>
<a href="#l3.1549"></a><span id="l3.1549">       Services.prefs.setIntPref(check_time, FeedUtils.kBiffPollMinutes);</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineplus">+    }</span>
<a href="#l3.1551"></a><span id="l3.1551"> </span>
<a href="#l3.1552"></a><span id="l3.1552">     try {</span>
<a href="#l3.1553"></a><span id="l3.1553">       optionsAcct = JSON.parse(Services.prefs.getCharPref(optionsAcctPref));</span>
<a href="#l3.1554"></a><span id="l3.1554">       // Add the server specific biff enabled state.</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineminus">-      optionsAcct[&quot;doBiff&quot;] = Services.prefs.getBoolPref(check_new_mail);</span>
<a href="#l3.1556"></a><span id="l3.1556" class="difflineplus">+      optionsAcct.doBiff = Services.prefs.getBoolPref(check_new_mail);</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.1558"></a><span id="l3.1558" class="difflineplus">+</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineplus">+    if (optionsAcct &amp;&amp; optionsAcct.version == this._optionsDefault.version) {</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineplus">+      return optionsAcct;</span>
<a href="#l3.1561"></a><span id="l3.1561">     }</span>
<a href="#l3.1562"></a><span id="l3.1562" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.1563"></a><span id="l3.1563" class="difflineminus">-</span>
<a href="#l3.1564"></a><span id="l3.1564" class="difflineminus">-    if (optionsAcct &amp;&amp; optionsAcct.version == this._optionsDefault.version)</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-      return optionsAcct;</span>
<a href="#l3.1566"></a><span id="l3.1566"> </span>
<a href="#l3.1567"></a><span id="l3.1567">     // Init account updates options if new or upgrading to version in</span>
<a href="#l3.1568"></a><span id="l3.1568">     // |_optionsDefault.version|.</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineminus">-    if (!optionsAcct || optionsAcct.version &lt; this._optionsDefault.version)</span>
<a href="#l3.1570"></a><span id="l3.1570" class="difflineplus">+    if (!optionsAcct || optionsAcct.version &lt; this._optionsDefault.version) {</span>
<a href="#l3.1571"></a><span id="l3.1571">       this.initAcct(aServer);</span>
<a href="#l3.1572"></a><span id="l3.1572" class="difflineplus">+    }</span>
<a href="#l3.1573"></a><span id="l3.1573"> </span>
<a href="#l3.1574"></a><span id="l3.1574">     let newOptions = this.newOptions(optionsAcct);</span>
<a href="#l3.1575"></a><span id="l3.1575">     this.setOptionsAcct(aServer, newOptions);</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineminus">-    newOptions[&quot;doBiff&quot;] = Services.prefs.getBoolPref(check_new_mail);</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineplus">+    newOptions.doBiff = Services.prefs.getBoolPref(check_new_mail);</span>
<a href="#l3.1578"></a><span id="l3.1578">     return newOptions;</span>
<a href="#l3.1579"></a><span id="l3.1579">   },</span>
<a href="#l3.1580"></a><span id="l3.1580"> </span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineminus">-  setOptionsAcct: function(aServer, aOptions)</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineminus">-  {</span>
<a href="#l3.1583"></a><span id="l3.1583" class="difflineplus">+  setOptionsAcct(aServer, aOptions) {</span>
<a href="#l3.1584"></a><span id="l3.1584">     let optionsAcctPref = &quot;mail.server.&quot; + aServer.key + &quot;.feed_options&quot;;</span>
<a href="#l3.1585"></a><span id="l3.1585">     aOptions = aOptions || this.optionsTemplate;</span>
<a href="#l3.1586"></a><span id="l3.1586">     Services.prefs.setCharPref(optionsAcctPref, JSON.stringify(aOptions));</span>
<a href="#l3.1587"></a><span id="l3.1587">   },</span>
<a href="#l3.1588"></a><span id="l3.1588"> </span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineminus">-  initAcct: function(aServer)</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-  {</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineplus">+  initAcct(aServer) {</span>
<a href="#l3.1592"></a><span id="l3.1592">     let serverPrefStr = &quot;mail.server.&quot; + aServer.key;</span>
<a href="#l3.1593"></a><span id="l3.1593">     // System polling interval. Effective after current interval expires on</span>
<a href="#l3.1594"></a><span id="l3.1594">     // change; no user facing ui.</span>
<a href="#l3.1595"></a><span id="l3.1595">     Services.prefs.setIntPref(serverPrefStr + &quot;.check_time&quot;,</span>
<a href="#l3.1596"></a><span id="l3.1596">                               FeedUtils.kBiffPollMinutes);</span>
<a href="#l3.1597"></a><span id="l3.1597"> </span>
<a href="#l3.1598"></a><span id="l3.1598">     // If this pref is false, polling on biff is disabled and account updates</span>
<a href="#l3.1599"></a><span id="l3.1599">     // are paused; ui in account server settings and folderpane context menu</span>
<a href="#l3.1600"></a><span id="l3.1600">     // (Pause All Updates). Checking Enable updates or unchecking Pause takes</span>
<a href="#l3.1601"></a><span id="l3.1601">     // effect immediately. Here on startup, we just ensure the polling interval</span>
<a href="#l3.1602"></a><span id="l3.1602">     // above is reset immediately.</span>
<a href="#l3.1603"></a><span id="l3.1603">     let doBiff = Services.prefs.getBoolPref(serverPrefStr + &quot;.check_new_mail&quot;);</span>
<a href="#l3.1604"></a><span id="l3.1604">     FeedUtils.log.debug(&quot;initAcct: &quot; + aServer.prettyName + &quot; doBiff - &quot; + doBiff);</span>
<a href="#l3.1605"></a><span id="l3.1605">     this.pauseFeedFolderUpdates(aServer.rootFolder, !doBiff, false);</span>
<a href="#l3.1606"></a><span id="l3.1606">   },</span>
<a href="#l3.1607"></a><span id="l3.1607"> </span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineminus">-  newOptions: function(aCurrentOptions)</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineminus">-  {</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineminus">-    if (!aCurrentOptions)</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineplus">+  newOptions(aCurrentOptions) {</span>
<a href="#l3.1612"></a><span id="l3.1612" class="difflineplus">+    if (!aCurrentOptions) {</span>
<a href="#l3.1613"></a><span id="l3.1613">       return this.optionsTemplate;</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineplus">+    }</span>
<a href="#l3.1615"></a><span id="l3.1615"> </span>
<a href="#l3.1616"></a><span id="l3.1616">     // Options version has changed; meld current template with existing</span>
<a href="#l3.1617"></a><span id="l3.1617">     // aCurrentOptions settings, removing items gone from the template while</span>
<a href="#l3.1618"></a><span id="l3.1618">     // preserving user settings for retained template items.</span>
<a href="#l3.1619"></a><span id="l3.1619">     let newOptions = this.optionsTemplate;</span>
<a href="#l3.1620"></a><span id="l3.1620">     this.Mixins.meld(aCurrentOptions, false, true).into(newOptions);</span>
<a href="#l3.1621"></a><span id="l3.1621">     newOptions.version = this.optionsTemplate.version;</span>
<a href="#l3.1622"></a><span id="l3.1622">     return newOptions;</span>
<a href="#l3.1623"></a><span id="l3.1623">   },</span>
<a href="#l3.1624"></a><span id="l3.1624"> </span>
<a href="#l3.1625"></a><span id="l3.1625" class="difflineminus">-/**</span>
<a href="#l3.1626"></a><span id="l3.1626" class="difflineminus">- * A generalized recursive melder of two objects. Getters/setters not included.</span>
<a href="#l3.1627"></a><span id="l3.1627" class="difflineminus">- */</span>
<a href="#l3.1628"></a><span id="l3.1628" class="difflineplus">+  /**</span>
<a href="#l3.1629"></a><span id="l3.1629" class="difflineplus">+   * A generalized recursive melder of two objects. Getters/setters not included.</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineplus">+   */</span>
<a href="#l3.1631"></a><span id="l3.1631">   Mixins: {</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineminus">-    meld: function(source, keep, replace) {</span>
<a href="#l3.1633"></a><span id="l3.1633" class="difflineplus">+    meld(source, keep, replace) {</span>
<a href="#l3.1634"></a><span id="l3.1634">       function meldin(source, target, keep, replace) {</span>
<a href="#l3.1635"></a><span id="l3.1635">         for (let attribute in source) {</span>
<a href="#l3.1636"></a><span id="l3.1636">           // Recurse for objects.</span>
<a href="#l3.1637"></a><span id="l3.1637">           if (typeof source[attribute] == &quot;object&quot; &amp;&amp;</span>
<a href="#l3.1638"></a><span id="l3.1638">               typeof target[attribute] == &quot;object&quot;) {</span>
<a href="#l3.1639"></a><span id="l3.1639">             meldin(source[attribute], target[attribute], keep, replace);</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-          }</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineminus">-          else {</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineplus">+          } else {</span>
<a href="#l3.1643"></a><span id="l3.1643">             // Use attribute values from source for the target, unless</span>
<a href="#l3.1644"></a><span id="l3.1644">             // replace is false.</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineminus">-            if (attribute in target &amp;&amp; !replace)</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineplus">+            if (attribute in target &amp;&amp; !replace) {</span>
<a href="#l3.1647"></a><span id="l3.1647">               continue;</span>
<a href="#l3.1648"></a><span id="l3.1648" class="difflineminus">-</span>
<a href="#l3.1649"></a><span id="l3.1649" class="difflineplus">+            }</span>
<a href="#l3.1650"></a><span id="l3.1650">             // Don't copy attribute from source to target if it is not in the</span>
<a href="#l3.1651"></a><span id="l3.1651">             // target, unless keep is true.</span>
<a href="#l3.1652"></a><span id="l3.1652" class="difflineminus">-            if (!(attribute in target) &amp;&amp; !keep)</span>
<a href="#l3.1653"></a><span id="l3.1653" class="difflineplus">+            if (!(attribute in target) &amp;&amp; !keep) {</span>
<a href="#l3.1654"></a><span id="l3.1654">               continue;</span>
<a href="#l3.1655"></a><span id="l3.1655" class="difflineplus">+            }</span>
<a href="#l3.1656"></a><span id="l3.1656"> </span>
<a href="#l3.1657"></a><span id="l3.1657">             target[attribute] = source[attribute];</span>
<a href="#l3.1658"></a><span id="l3.1658">           }</span>
<a href="#l3.1659"></a><span id="l3.1659">         }</span>
<a href="#l3.1660"></a><span id="l3.1660" class="difflineminus">-      };</span>
<a href="#l3.1661"></a><span id="l3.1661" class="difflineplus">+      }</span>
<a href="#l3.1662"></a><span id="l3.1662">       return {</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineminus">-        source: source,</span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineminus">-        into: function(target) {</span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineplus">+        source,</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineplus">+        into(target) {</span>
<a href="#l3.1667"></a><span id="l3.1667">           meldin(this.source, target, keep, replace);</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-        }</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineplus">+        },</span>
<a href="#l3.1670"></a><span id="l3.1670">       };</span>
<a href="#l3.1671"></a><span id="l3.1671" class="difflineminus">-    }</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineplus">+    },</span>
<a href="#l3.1673"></a><span id="l3.1673">   },</span>
<a href="#l3.1674"></a><span id="l3.1674"> </span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineminus">-  getSubscriptionsDS: function(aServer) {</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineminus">-    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI][&quot;FeedsDS&quot;])</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-      return this[aServer.serverURI][&quot;FeedsDS&quot;];</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineplus">+  getSubscriptionsDS(aServer) {</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineplus">+    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI].FeedsDS) {</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineplus">+      return this[aServer.serverURI].FeedsDS;</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineplus">+    }</span>
<a href="#l3.1682"></a><span id="l3.1682"> </span>
<a href="#l3.1683"></a><span id="l3.1683">     let file = this.getSubscriptionsFile(aServer);</span>
<a href="#l3.1684"></a><span id="l3.1684">     let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l3.1685"></a><span id="l3.1685">                           QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l3.1686"></a><span id="l3.1686">                           getURLSpecFromFile(file);</span>
<a href="#l3.1687"></a><span id="l3.1687"> </span>
<a href="#l3.1688"></a><span id="l3.1688">     // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l3.1689"></a><span id="l3.1689">     // once we've already done it once.</span>
<a href="#l3.1690"></a><span id="l3.1690">     let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l3.1691"></a><span id="l3.1691"> </span>
<a href="#l3.1692"></a><span id="l3.1692" class="difflineminus">-    if (!ds)</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineplus">+    if (!ds) {</span>
<a href="#l3.1694"></a><span id="l3.1694">       throw new Error(&quot;FeedUtils.getSubscriptionsDS: can't get feed &quot; +</span>
<a href="#l3.1695"></a><span id="l3.1695">                       &quot;subscriptions data source - &quot; + url);</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineplus">+    }</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineplus">+    if (!this[aServer.serverURI]) {</span>
<a href="#l3.1698"></a><span id="l3.1698" class="difflineplus">+      this[aServer.serverURI] = {};</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineplus">+    }</span>
<a href="#l3.1700"></a><span id="l3.1700"> </span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineminus">-    if (!this[aServer.serverURI])</span>
<a href="#l3.1702"></a><span id="l3.1702" class="difflineminus">-      this[aServer.serverURI] = {};</span>
<a href="#l3.1703"></a><span id="l3.1703" class="difflineminus">-    return this[aServer.serverURI][&quot;FeedsDS&quot;] =</span>
<a href="#l3.1704"></a><span id="l3.1704" class="difflineplus">+    return this[aServer.serverURI].FeedsDS =</span>
<a href="#l3.1705"></a><span id="l3.1705">              ds.QueryInterface(Ci.nsIRDFRemoteDataSource);</span>
<a href="#l3.1706"></a><span id="l3.1706">   },</span>
<a href="#l3.1707"></a><span id="l3.1707"> </span>
<a href="#l3.1708"></a><span id="l3.1708" class="difflineminus">-  getSubscriptionsList: function(aDataSource) {</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineplus">+  getSubscriptionsList(aDataSource) {</span>
<a href="#l3.1710"></a><span id="l3.1710">     let list = aDataSource.GetTarget(this.FZ_ROOT, this.FZ_FEEDS, true);</span>
<a href="#l3.1711"></a><span id="l3.1711">     list = list.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l3.1712"></a><span id="l3.1712">     list = this.rdfContainerUtils.MakeSeq(aDataSource, list);</span>
<a href="#l3.1713"></a><span id="l3.1713">     return list;</span>
<a href="#l3.1714"></a><span id="l3.1714">   },</span>
<a href="#l3.1715"></a><span id="l3.1715"> </span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineminus">-  getSubscriptionsFile: function(aServer) {</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineplus">+  getSubscriptionsFile(aServer) {</span>
<a href="#l3.1718"></a><span id="l3.1718">     aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l3.1719"></a><span id="l3.1719">     let file = aServer.subscriptionsDataSourcePath;</span>
<a href="#l3.1720"></a><span id="l3.1720"> </span>
<a href="#l3.1721"></a><span id="l3.1721">     // If the file doesn't exist, create it.</span>
<a href="#l3.1722"></a><span id="l3.1722" class="difflineminus">-    if (!file.exists())</span>
<a href="#l3.1723"></a><span id="l3.1723" class="difflineplus">+    if (!file.exists()) {</span>
<a href="#l3.1724"></a><span id="l3.1724">       this.createFile(file, this.FEEDS_TEMPLATE);</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineplus">+    }</span>
<a href="#l3.1726"></a><span id="l3.1726"> </span>
<a href="#l3.1727"></a><span id="l3.1727">     return file;</span>
<a href="#l3.1728"></a><span id="l3.1728">   },</span>
<a href="#l3.1729"></a><span id="l3.1729"> </span>
<a href="#l3.1730"></a><span id="l3.1730" class="difflineminus">-  FEEDS_TEMPLATE: '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l3.1731"></a><span id="l3.1731" class="difflineminus">-    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l3.1732"></a><span id="l3.1732" class="difflineminus">-    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l3.1733"></a><span id="l3.1733" class="difflineminus">-    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l3.1734"></a><span id="l3.1734" class="difflineminus">-    '  &lt;RDF:Description about=&quot;urn:forumzilla:root&quot;&gt;\n' +</span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineminus">-    '    &lt;fz:feeds&gt;\n' +</span>
<a href="#l3.1736"></a><span id="l3.1736" class="difflineminus">-    '      &lt;RDF:Seq&gt;\n' +</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineminus">-    '      &lt;/RDF:Seq&gt;\n' +</span>
<a href="#l3.1738"></a><span id="l3.1738" class="difflineminus">-    '    &lt;/fz:feeds&gt;\n' +</span>
<a href="#l3.1739"></a><span id="l3.1739" class="difflineminus">-    '  &lt;/RDF:Description&gt;\n' +</span>
<a href="#l3.1740"></a><span id="l3.1740" class="difflineminus">-    '&lt;/RDF:RDF&gt;\n',</span>
<a href="#l3.1741"></a><span id="l3.1741" class="difflineplus">+  FEEDS_TEMPLATE: &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot; +</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineplus">+    &quot;&lt;RDF:RDF xmlns:dc=\&quot;http://purl.org/dc/elements/1.1/\&quot;\n&quot; +</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineplus">+    &quot;         xmlns:fz=\&quot;urn:forumzilla:\&quot;\n&quot; +</span>
<a href="#l3.1744"></a><span id="l3.1744" class="difflineplus">+    &quot;         xmlns:RDF=\&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#\&quot;&gt;\n&quot; +</span>
<a href="#l3.1745"></a><span id="l3.1745" class="difflineplus">+    &quot;  &lt;RDF:Description about=\&quot;urn:forumzilla:root\&quot;&gt;\n&quot; +</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineplus">+    &quot;    &lt;fz:feeds&gt;\n&quot; +</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineplus">+    &quot;      &lt;RDF:Seq&gt;\n&quot; +</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineplus">+    &quot;      &lt;/RDF:Seq&gt;\n&quot; +</span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineplus">+    &quot;    &lt;/fz:feeds&gt;\n&quot; +</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineplus">+    &quot;  &lt;/RDF:Description&gt;\n&quot; +</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineplus">+    &quot;&lt;/RDF:RDF&gt;\n&quot;,</span>
<a href="#l3.1752"></a><span id="l3.1752"> </span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineminus">-  getItemsDS: function(aServer) {</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineminus">-    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI][&quot;FeedItemsDS&quot;])</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineminus">-      return this[aServer.serverURI][&quot;FeedItemsDS&quot;];</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineplus">+  getItemsDS(aServer) {</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineplus">+    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI].FeedItemsDS) {</span>
<a href="#l3.1758"></a><span id="l3.1758" class="difflineplus">+      return this[aServer.serverURI].FeedItemsDS;</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineplus">+    }</span>
<a href="#l3.1760"></a><span id="l3.1760"> </span>
<a href="#l3.1761"></a><span id="l3.1761">     let file = this.getItemsFile(aServer);</span>
<a href="#l3.1762"></a><span id="l3.1762">     let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l3.1763"></a><span id="l3.1763">                           QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l3.1764"></a><span id="l3.1764">                           getURLSpecFromFile(file);</span>
<a href="#l3.1765"></a><span id="l3.1765"> </span>
<a href="#l3.1766"></a><span id="l3.1766">     // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l3.1767"></a><span id="l3.1767">     // once we've already done it once.</span>
<a href="#l3.1768"></a><span id="l3.1768">     let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l3.1769"></a><span id="l3.1769" class="difflineminus">-    if (!ds)</span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineplus">+    if (!ds) {</span>
<a href="#l3.1771"></a><span id="l3.1771">       throw new Error(&quot;FeedUtils.getItemsDS: can't get feed items &quot; +</span>
<a href="#l3.1772"></a><span id="l3.1772">                       &quot;data source - &quot; + url);</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineminus">-</span>
<a href="#l3.1774"></a><span id="l3.1774" class="difflineplus">+    }</span>
<a href="#l3.1775"></a><span id="l3.1775">     // Note that it this point the datasource may not be loaded yet.</span>
<a href="#l3.1776"></a><span id="l3.1776">     // You have to QueryInterface it to nsIRDFRemoteDataSource and check</span>
<a href="#l3.1777"></a><span id="l3.1777">     // its &quot;loaded&quot; property to be sure.  You can also attach an observer</span>
<a href="#l3.1778"></a><span id="l3.1778">     // which will get notified when the load is complete.</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineminus">-    if (!this[aServer.serverURI])</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineplus">+    if (!this[aServer.serverURI]) {</span>
<a href="#l3.1781"></a><span id="l3.1781">       this[aServer.serverURI] = {};</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineminus">-    return this[aServer.serverURI][&quot;FeedItemsDS&quot;] =</span>
<a href="#l3.1783"></a><span id="l3.1783" class="difflineplus">+    }</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineplus">+</span>
<a href="#l3.1785"></a><span id="l3.1785" class="difflineplus">+    return this[aServer.serverURI].FeedItemsDS =</span>
<a href="#l3.1786"></a><span id="l3.1786">              ds.QueryInterface(Ci.nsIRDFRemoteDataSource);</span>
<a href="#l3.1787"></a><span id="l3.1787">   },</span>
<a href="#l3.1788"></a><span id="l3.1788"> </span>
<a href="#l3.1789"></a><span id="l3.1789" class="difflineminus">-  getItemsFile: function(aServer) {</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineplus">+  getItemsFile(aServer) {</span>
<a href="#l3.1791"></a><span id="l3.1791">     aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l3.1792"></a><span id="l3.1792">     let file = aServer.feedItemsDataSourcePath;</span>
<a href="#l3.1793"></a><span id="l3.1793"> </span>
<a href="#l3.1794"></a><span id="l3.1794">     // If the file doesn't exist, create it.</span>
<a href="#l3.1795"></a><span id="l3.1795">     if (!file.exists()) {</span>
<a href="#l3.1796"></a><span id="l3.1796">       this.createFile(file, this.FEEDITEMS_TEMPLATE);</span>
<a href="#l3.1797"></a><span id="l3.1797">       return file;</span>
<a href="#l3.1798"></a><span id="l3.1798">     }</span>
<a href="#l3.1799"></a><span id="l3.1799" class="difflineat">@@ -1399,173 +1435,164 @@ var FeedUtils = {</span>
<a href="#l3.1800"></a><span id="l3.1800">                              .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l3.1801"></a><span id="l3.1801">                              .getURLSpecFromFile(file);</span>
<a href="#l3.1802"></a><span id="l3.1802">     let request = new XMLHttpRequest();</span>
<a href="#l3.1803"></a><span id="l3.1803">     request.open(&quot;GET&quot;, fileUrl, false);</span>
<a href="#l3.1804"></a><span id="l3.1804">     request.responseType = &quot;document&quot;;</span>
<a href="#l3.1805"></a><span id="l3.1805">     request.send();</span>
<a href="#l3.1806"></a><span id="l3.1806">     let dom = request.responseXML;</span>
<a href="#l3.1807"></a><span id="l3.1807">     if ((ChromeUtils.getClassName(dom) === &quot;XMLDocument&quot;) &amp;&amp;</span>
<a href="#l3.1808"></a><span id="l3.1808" class="difflineminus">-        dom.documentElement.namespaceURI != this.MOZ_PARSERERROR_NS)</span>
<a href="#l3.1809"></a><span id="l3.1809" class="difflineplus">+        dom.documentElement.namespaceURI != this.MOZ_PARSERERROR_NS) {</span>
<a href="#l3.1810"></a><span id="l3.1810">       return file;</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineplus">+    }</span>
<a href="#l3.1812"></a><span id="l3.1812"> </span>
<a href="#l3.1813"></a><span id="l3.1813">     // Error on the file. Rename it and create a new one.</span>
<a href="#l3.1814"></a><span id="l3.1814">     this.log.debug(&quot;FeedUtils.getItemsFile: error in feeditems.rdf&quot;);</span>
<a href="#l3.1815"></a><span id="l3.1815">     let errName = &quot;feeditems_error_&quot; +</span>
<a href="#l3.1816"></a><span id="l3.1816">                   (new Date().toISOString()).replace(/\D/g, &quot;&quot;) + &quot;.rdf&quot;;</span>
<a href="#l3.1817"></a><span id="l3.1817">     file.moveTo(file.parent, errName);</span>
<a href="#l3.1818"></a><span id="l3.1818">     file = aServer.feedItemsDataSourcePath;</span>
<a href="#l3.1819"></a><span id="l3.1819">     this.createFile(file, this.FEEDITEMS_TEMPLATE);</span>
<a href="#l3.1820"></a><span id="l3.1820">     this.log.error(&quot;FeedUtils.getItemsFile: error in feeditems.rdf in account '&quot; +</span>
<a href="#l3.1821"></a><span id="l3.1821">                    aServer.prettyName + &quot;'; the file has been moved to &quot; +</span>
<a href="#l3.1822"></a><span id="l3.1822">                    errName + &quot; and a new file has been created. Recent messages &quot; +</span>
<a href="#l3.1823"></a><span id="l3.1823">                    &quot;may be duplicated.&quot;);</span>
<a href="#l3.1824"></a><span id="l3.1824">     return file;</span>
<a href="#l3.1825"></a><span id="l3.1825">   },</span>
<a href="#l3.1826"></a><span id="l3.1826"> </span>
<a href="#l3.1827"></a><span id="l3.1827" class="difflineminus">-  FEEDITEMS_TEMPLATE: '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l3.1828"></a><span id="l3.1828" class="difflineminus">-    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineminus">-    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineminus">-    '&lt;/RDF:RDF&gt;\n',</span>
<a href="#l3.1832"></a><span id="l3.1832" class="difflineplus">+  FEEDITEMS_TEMPLATE: &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot; +</span>
<a href="#l3.1833"></a><span id="l3.1833" class="difflineplus">+    &quot;&lt;RDF:RDF xmlns:dc=\&quot;http://purl.org/dc/elements/1.1/\&quot;\n&quot; +</span>
<a href="#l3.1834"></a><span id="l3.1834" class="difflineplus">+    &quot;         xmlns:fz=\&quot;urn:forumzilla:\&quot;\n&quot; +</span>
<a href="#l3.1835"></a><span id="l3.1835" class="difflineplus">+    &quot;         xmlns:RDF=\&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#\&quot;&gt;\n&quot; +</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineplus">+    &quot;&lt;/RDF:RDF&gt;\n&quot;,</span>
<a href="#l3.1837"></a><span id="l3.1837"> </span>
<a href="#l3.1838"></a><span id="l3.1838" class="difflineminus">-  createFile: function(aFile, aTemplate) {</span>
<a href="#l3.1839"></a><span id="l3.1839" class="difflineplus">+  createFile(aFile, aTemplate) {</span>
<a href="#l3.1840"></a><span id="l3.1840">     let fos = FileUtils.openSafeFileOutputStream(aFile);</span>
<a href="#l3.1841"></a><span id="l3.1841">     fos.write(aTemplate, aTemplate.length);</span>
<a href="#l3.1842"></a><span id="l3.1842">     FileUtils.closeSafeFileOutputStream(fos);</span>
<a href="#l3.1843"></a><span id="l3.1843">   },</span>
<a href="#l3.1844"></a><span id="l3.1844"> </span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineminus">-  getParentTargetForChildResource: function(aChildResource, aParentTarget,</span>
<a href="#l3.1846"></a><span id="l3.1846" class="difflineminus">-                                            aServer) {</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineplus">+  getParentTargetForChildResource(aChildResource, aParentTarget, aServer) {</span>
<a href="#l3.1848"></a><span id="l3.1848">     // Generic get feed property, based on child value. Assumes 1 unique</span>
<a href="#l3.1849"></a><span id="l3.1849">     // child value with 1 unique parent, valid for feeds.rdf structure.</span>
<a href="#l3.1850"></a><span id="l3.1850">     let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l3.1851"></a><span id="l3.1851">     let childRes = this.rdf.GetResource(aChildResource);</span>
<a href="#l3.1852"></a><span id="l3.1852">     let parent = null;</span>
<a href="#l3.1853"></a><span id="l3.1853"> </span>
<a href="#l3.1854"></a><span id="l3.1854">     let arcsIn = ds.ArcLabelsIn(childRes);</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-    while (arcsIn.hasMoreElements())</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineminus">-    {</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineplus">+    while (arcsIn.hasMoreElements()) {</span>
<a href="#l3.1858"></a><span id="l3.1858">       let arc = arcsIn.getNext();</span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineminus">-      if (arc instanceof Ci.nsIRDFResource)</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineminus">-      {</span>
<a href="#l3.1861"></a><span id="l3.1861" class="difflineplus">+      if (arc instanceof Ci.nsIRDFResource) {</span>
<a href="#l3.1862"></a><span id="l3.1862">         parent = ds.GetSource(arc, childRes, true);</span>
<a href="#l3.1863"></a><span id="l3.1863">         parent = parent.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l3.1864"></a><span id="l3.1864">         break;</span>
<a href="#l3.1865"></a><span id="l3.1865">       }</span>
<a href="#l3.1866"></a><span id="l3.1866">     }</span>
<a href="#l3.1867"></a><span id="l3.1867"> </span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineminus">-    if (parent)</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineminus">-    {</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineplus">+    if (parent) {</span>
<a href="#l3.1871"></a><span id="l3.1871">       let resource = this.rdf.GetResource(parent.Value);</span>
<a href="#l3.1872"></a><span id="l3.1872">       return ds.GetTarget(resource, aParentTarget, true);</span>
<a href="#l3.1873"></a><span id="l3.1873">     }</span>
<a href="#l3.1874"></a><span id="l3.1874"> </span>
<a href="#l3.1875"></a><span id="l3.1875">     return null;</span>
<a href="#l3.1876"></a><span id="l3.1876">   },</span>
<a href="#l3.1877"></a><span id="l3.1877"> </span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineminus">-  removeAssertions: function(aDataSource, aResource) {</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineplus">+  removeAssertions(aDataSource, aResource) {</span>
<a href="#l3.1880"></a><span id="l3.1880">     let properties = aDataSource.ArcLabelsOut(aResource);</span>
<a href="#l3.1881"></a><span id="l3.1881">     let property;</span>
<a href="#l3.1882"></a><span id="l3.1882" class="difflineminus">-    while (properties.hasMoreElements())</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineminus">-    {</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineplus">+    while (properties.hasMoreElements()) {</span>
<a href="#l3.1885"></a><span id="l3.1885">       property = properties.getNext();</span>
<a href="#l3.1886"></a><span id="l3.1886">       let values = aDataSource.GetTargets(aResource, property, true);</span>
<a href="#l3.1887"></a><span id="l3.1887">       let value;</span>
<a href="#l3.1888"></a><span id="l3.1888" class="difflineminus">-      while (values.hasMoreElements())</span>
<a href="#l3.1889"></a><span id="l3.1889" class="difflineminus">-      {</span>
<a href="#l3.1890"></a><span id="l3.1890" class="difflineplus">+      while (values.hasMoreElements()) {</span>
<a href="#l3.1891"></a><span id="l3.1891">         value = values.getNext();</span>
<a href="#l3.1892"></a><span id="l3.1892">         aDataSource.Unassert(aResource, property, value, true);</span>
<a href="#l3.1893"></a><span id="l3.1893">       }</span>
<a href="#l3.1894"></a><span id="l3.1894">     }</span>
<a href="#l3.1895"></a><span id="l3.1895">   },</span>
<a href="#l3.1896"></a><span id="l3.1896"> </span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineminus">-/**</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineminus">- * Dragging something from somewhere.  It may be a nice x-moz-url or from a</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineminus">- * browser or app that provides a less nice dataTransfer object in the event.</span>
<a href="#l3.1900"></a><span id="l3.1900" class="difflineminus">- * Extract the url and if it passes the scheme test, try to subscribe.</span>
<a href="#l3.1901"></a><span id="l3.1901" class="difflineminus">- *</span>
<a href="#l3.1902"></a><span id="l3.1902" class="difflineminus">- * @param  nsISupports aDataTransfer  - the dnd event's dataTransfer.</span>
<a href="#l3.1903"></a><span id="l3.1903" class="difflineminus">- * @return nsIURI uri                 - a uri if valid, null if none.</span>
<a href="#l3.1904"></a><span id="l3.1904" class="difflineminus">- */</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-  getFeedUriFromDataTransfer: function(aDataTransfer) {</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineplus">+  /**</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineplus">+   * Dragging something from somewhere.  It may be a nice x-moz-url or from a</span>
<a href="#l3.1908"></a><span id="l3.1908" class="difflineplus">+   * browser or app that provides a less nice dataTransfer object in the event.</span>
<a href="#l3.1909"></a><span id="l3.1909" class="difflineplus">+   * Extract the url and if it passes the scheme test, try to subscribe.</span>
<a href="#l3.1910"></a><span id="l3.1910" class="difflineplus">+   *</span>
<a href="#l3.1911"></a><span id="l3.1911" class="difflineplus">+   * @param {nsISupports} aDataTransfer  - The dnd event's dataTransfer.</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineplus">+   *</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineplus">+   * @returns {nsIURI} or null           - A uri if valid, null if none.</span>
<a href="#l3.1914"></a><span id="l3.1914" class="difflineplus">+   */</span>
<a href="#l3.1915"></a><span id="l3.1915" class="difflineplus">+  getFeedUriFromDataTransfer(aDataTransfer) {</span>
<a href="#l3.1916"></a><span id="l3.1916">     let dt = aDataTransfer;</span>
<a href="#l3.1917"></a><span id="l3.1917">     let types = [&quot;text/x-moz-url-data&quot;, &quot;text/x-moz-url&quot;];</span>
<a href="#l3.1918"></a><span id="l3.1918">     let validUri = false;</span>
<a href="#l3.1919"></a><span id="l3.1919">     let uri;</span>
<a href="#l3.1920"></a><span id="l3.1920"> </span>
<a href="#l3.1921"></a><span id="l3.1921" class="difflineminus">-    if (dt.getData(types[0]))</span>
<a href="#l3.1922"></a><span id="l3.1922" class="difflineminus">-    {</span>
<a href="#l3.1923"></a><span id="l3.1923" class="difflineplus">+    if (dt.getData(types[0])) {</span>
<a href="#l3.1924"></a><span id="l3.1924">       // The url is the data.</span>
<a href="#l3.1925"></a><span id="l3.1925">       uri = Services.io.newURI(dt.mozGetDataAt(types[0], 0));</span>
<a href="#l3.1926"></a><span id="l3.1926">       validUri = this.isValidScheme(uri);</span>
<a href="#l3.1927"></a><span id="l3.1927">       this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot; +</span>
<a href="#l3.1928"></a><span id="l3.1928">                      dt.dropEffect + &quot; : &quot; + types[0] + &quot; : &quot; + uri.spec);</span>
<a href="#l3.1929"></a><span id="l3.1929" class="difflineminus">-    }</span>
<a href="#l3.1930"></a><span id="l3.1930" class="difflineminus">-    else if (dt.getData(types[1]))</span>
<a href="#l3.1931"></a><span id="l3.1931" class="difflineminus">-    {</span>
<a href="#l3.1932"></a><span id="l3.1932" class="difflineplus">+    } else if (dt.getData(types[1])) {</span>
<a href="#l3.1933"></a><span id="l3.1933">       // The url is the first part of the data, the second part is random.</span>
<a href="#l3.1934"></a><span id="l3.1934">       uri = Services.io.newURI(dt.mozGetDataAt(types[1], 0).split(&quot;\n&quot;)[0]);</span>
<a href="#l3.1935"></a><span id="l3.1935">       validUri = this.isValidScheme(uri);</span>
<a href="#l3.1936"></a><span id="l3.1936">       this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot; +</span>
<a href="#l3.1937"></a><span id="l3.1937">                      dt.dropEffect + &quot; : &quot; + types[0] + &quot; : &quot; + uri.spec);</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineminus">-    }</span>
<a href="#l3.1939"></a><span id="l3.1939" class="difflineminus">-    else</span>
<a href="#l3.1940"></a><span id="l3.1940" class="difflineminus">-    {</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineplus">+    } else {</span>
<a href="#l3.1942"></a><span id="l3.1942">       // Go through the types and see if there's a url; get the first one.</span>
<a href="#l3.1943"></a><span id="l3.1943">       for (let i = 0; i &lt; dt.types.length; i++) {</span>
<a href="#l3.1944"></a><span id="l3.1944">         let spec = dt.mozGetDataAt(dt.types[i], 0);</span>
<a href="#l3.1945"></a><span id="l3.1945">         this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:index:type:value - &quot; +</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineminus">-                       dt.dropEffect + &quot; : &quot; + i + &quot; : &quot; + dt.types[i] + &quot; : &quot;+spec);</span>
<a href="#l3.1947"></a><span id="l3.1947" class="difflineplus">+                       dt.dropEffect + &quot; : &quot; + i + &quot; : &quot; + dt.types[i] + &quot; : &quot; + spec);</span>
<a href="#l3.1948"></a><span id="l3.1948">         try {</span>
<a href="#l3.1949"></a><span id="l3.1949">           uri = Services.io.newURI(spec);</span>
<a href="#l3.1950"></a><span id="l3.1950">           validUri = this.isValidScheme(uri);</span>
<a href="#l3.1951"></a><span id="l3.1951" class="difflineminus">-        }</span>
<a href="#l3.1952"></a><span id="l3.1952" class="difflineminus">-        catch(ex) {}</span>
<a href="#l3.1953"></a><span id="l3.1953" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l3.1954"></a><span id="l3.1954"> </span>
<a href="#l3.1955"></a><span id="l3.1955" class="difflineminus">-        if (validUri)</span>
<a href="#l3.1956"></a><span id="l3.1956" class="difflineplus">+        if (validUri) {</span>
<a href="#l3.1957"></a><span id="l3.1957">           break;</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-      };</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineplus">+        }</span>
<a href="#l3.1960"></a><span id="l3.1960" class="difflineplus">+      }</span>
<a href="#l3.1961"></a><span id="l3.1961">     }</span>
<a href="#l3.1962"></a><span id="l3.1962"> </span>
<a href="#l3.1963"></a><span id="l3.1963">     return validUri ? uri : null;</span>
<a href="#l3.1964"></a><span id="l3.1964">   },</span>
<a href="#l3.1965"></a><span id="l3.1965"> </span>
<a href="#l3.1966"></a><span id="l3.1966">   /**</span>
<a href="#l3.1967"></a><span id="l3.1967">    * Returns security/certificate/network error details for an XMLHTTPRequest.</span>
<a href="#l3.1968"></a><span id="l3.1968">    *</span>
<a href="#l3.1969"></a><span id="l3.1969" class="difflineminus">-   * @param  XMLHTTPRequest xhr - The xhr request.</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-   * @return array [string errType, string errName] (null if not determined).</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineplus">+   * @param {XMLHTTPRequest} xhr - The xhr request.</span>
<a href="#l3.1972"></a><span id="l3.1972" class="difflineplus">+   *</span>
<a href="#l3.1973"></a><span id="l3.1973" class="difflineplus">+   * @returns {Array}[{String} errType or null, {String} errName or null]</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineplus">+   *          - Array with 2 error codes, (nulls if not determined).</span>
<a href="#l3.1975"></a><span id="l3.1975">    */</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineminus">-  createTCPErrorFromFailedXHR: function(xhr) {</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineplus">+  createTCPErrorFromFailedXHR(xhr) {</span>
<a href="#l3.1978"></a><span id="l3.1978">     let status = xhr.channel.QueryInterface(Ci.nsIRequest).status;</span>
<a href="#l3.1979"></a><span id="l3.1979"> </span>
<a href="#l3.1980"></a><span id="l3.1980">     let errType = null;</span>
<a href="#l3.1981"></a><span id="l3.1981">     let errName = null;</span>
<a href="#l3.1982"></a><span id="l3.1982">     if ((status &amp; 0xff0000) === 0x5a0000) {</span>
<a href="#l3.1983"></a><span id="l3.1983">       // Security module.</span>
<a href="#l3.1984"></a><span id="l3.1984">       const nsINSSErrorsService = Ci.nsINSSErrorsService;</span>
<a href="#l3.1985"></a><span id="l3.1985">       let nssErrorsService = Cc[&quot;@mozilla.org/nss_errors_service;1&quot;]</span>
<a href="#l3.1986"></a><span id="l3.1986">                                .getService(nsINSSErrorsService);</span>
<a href="#l3.1987"></a><span id="l3.1987">       let errorClass;</span>
<a href="#l3.1988"></a><span id="l3.1988"> </span>
<a href="#l3.1989"></a><span id="l3.1989">       // getErrorClass()) will throw a generic NS_ERROR_FAILURE if the error</span>
<a href="#l3.1990"></a><span id="l3.1990">       // code is somehow not in the set of covered errors.</span>
<a href="#l3.1991"></a><span id="l3.1991">       try {</span>
<a href="#l3.1992"></a><span id="l3.1992">         errorClass = nssErrorsService.getErrorClass(status);</span>
<a href="#l3.1993"></a><span id="l3.1993" class="difflineminus">-      }</span>
<a href="#l3.1994"></a><span id="l3.1994" class="difflineminus">-      catch (ex) {</span>
<a href="#l3.1995"></a><span id="l3.1995" class="difflineplus">+      } catch (ex) {</span>
<a href="#l3.1996"></a><span id="l3.1996">         // Catch security protocol exception.</span>
<a href="#l3.1997"></a><span id="l3.1997">         errorClass = &quot;SecurityProtocol&quot;;</span>
<a href="#l3.1998"></a><span id="l3.1998">       }</span>
<a href="#l3.1999"></a><span id="l3.1999"> </span>
<a href="#l3.2000"></a><span id="l3.2000">       if (errorClass == nsINSSErrorsService.ERROR_CLASS_BAD_CERT) {</span>
<a href="#l3.2001"></a><span id="l3.2001">         errType = &quot;SecurityCertificate&quot;;</span>
<a href="#l3.2002"></a><span id="l3.2002" class="difflineminus">-      }</span>
<a href="#l3.2003"></a><span id="l3.2003" class="difflineminus">-      else {</span>
<a href="#l3.2004"></a><span id="l3.2004" class="difflineplus">+      } else {</span>
<a href="#l3.2005"></a><span id="l3.2005">         errType = &quot;SecurityProtocol&quot;;</span>
<a href="#l3.2006"></a><span id="l3.2006">       }</span>
<a href="#l3.2007"></a><span id="l3.2007"> </span>
<a href="#l3.2008"></a><span id="l3.2008">       // NSS_SEC errors (happen below the base value because of negative vals).</span>
<a href="#l3.2009"></a><span id="l3.2009">       if ((status &amp; 0xffff) &lt; Math.abs(nsINSSErrorsService.NSS_SEC_ERROR_BASE)) {</span>
<a href="#l3.2010"></a><span id="l3.2010">         // The bases are actually negative, so in our positive numeric space,</span>
<a href="#l3.2011"></a><span id="l3.2011">         // we need to subtract the base off our value.</span>
<a href="#l3.2012"></a><span id="l3.2012">         let nssErr = Math.abs(nsINSSErrorsService.NSS_SEC_ERROR_BASE) - (status &amp; 0xffff);</span>
<a href="#l3.2013"></a><span id="l3.2013" class="difflineat">@@ -1591,18 +1618,17 @@ var FeedUtils = {</span>
<a href="#l3.2014"></a><span id="l3.2014">             break;</span>
<a href="#l3.2015"></a><span id="l3.2015">           case 176: // SEC_ERROR_CERT_SIGNATURE_ALGORITHM_DISABLED, sec(176)</span>
<a href="#l3.2016"></a><span id="l3.2016">             errName = &quot;SecurityCertificateSignatureAlgorithmDisabledError&quot;;</span>
<a href="#l3.2017"></a><span id="l3.2017">             break;</span>
<a href="#l3.2018"></a><span id="l3.2018">           default:</span>
<a href="#l3.2019"></a><span id="l3.2019">             errName = &quot;SecurityError&quot;;</span>
<a href="#l3.2020"></a><span id="l3.2020">             break;</span>
<a href="#l3.2021"></a><span id="l3.2021">         }</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineminus">-      }</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineminus">-      else {</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineplus">+      } else {</span>
<a href="#l3.2025"></a><span id="l3.2025">         // Calculating the difference.</span>
<a href="#l3.2026"></a><span id="l3.2026">         let sslErr = Math.abs(nsINSSErrorsService.NSS_SSL_ERROR_BASE) - (status &amp; 0xffff);</span>
<a href="#l3.2027"></a><span id="l3.2027"> </span>
<a href="#l3.2028"></a><span id="l3.2028">         switch (sslErr) {</span>
<a href="#l3.2029"></a><span id="l3.2029">           case 3: // SSL_ERROR_NO_CERTIFICATE, ssl(3)</span>
<a href="#l3.2030"></a><span id="l3.2030">             errName = &quot;SecurityNoCertificateError&quot;;</span>
<a href="#l3.2031"></a><span id="l3.2031">             break;</span>
<a href="#l3.2032"></a><span id="l3.2032">           case 4: // SSL_ERROR_BAD_CERTIFICATE, ssl(4)</span>
<a href="#l3.2033"></a><span id="l3.2033" class="difflineat">@@ -1617,18 +1643,17 @@ var FeedUtils = {</span>
<a href="#l3.2034"></a><span id="l3.2034">           case 12: // SSL_ERROR_BAD_CERT_DOMAIN, ssl(12)</span>
<a href="#l3.2035"></a><span id="l3.2035">             errName = &quot;SecurityCertificateDomainMismatchError&quot;;</span>
<a href="#l3.2036"></a><span id="l3.2036">             break;</span>
<a href="#l3.2037"></a><span id="l3.2037">           default:</span>
<a href="#l3.2038"></a><span id="l3.2038">             errName = &quot;SecurityError&quot;;</span>
<a href="#l3.2039"></a><span id="l3.2039">             break;</span>
<a href="#l3.2040"></a><span id="l3.2040">         }</span>
<a href="#l3.2041"></a><span id="l3.2041">       }</span>
<a href="#l3.2042"></a><span id="l3.2042" class="difflineminus">-    }</span>
<a href="#l3.2043"></a><span id="l3.2043" class="difflineminus">-    else {</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineplus">+    } else {</span>
<a href="#l3.2045"></a><span id="l3.2045">       errType = &quot;Network&quot;;</span>
<a href="#l3.2046"></a><span id="l3.2046">       switch (status) {</span>
<a href="#l3.2047"></a><span id="l3.2047">         // Connect to host:port failed.</span>
<a href="#l3.2048"></a><span id="l3.2048">         case 0x804B000C: // NS_ERROR_CONNECTION_REFUSED, network(13)</span>
<a href="#l3.2049"></a><span id="l3.2049">           errName = &quot;ConnectionRefusedError&quot;;</span>
<a href="#l3.2050"></a><span id="l3.2050">           break;</span>
<a href="#l3.2051"></a><span id="l3.2051">         // network timeout error.</span>
<a href="#l3.2052"></a><span id="l3.2052">         case 0x804B000E: // NS_ERROR_NET_TIMEOUT, network(14)</span>
<a href="#l3.2053"></a><span id="l3.2053" class="difflineat">@@ -1645,240 +1670,235 @@ var FeedUtils = {</span>
<a href="#l3.2054"></a><span id="l3.2054">           errName = &quot;NetworkError&quot;;</span>
<a href="#l3.2055"></a><span id="l3.2055">           break;</span>
<a href="#l3.2056"></a><span id="l3.2056">       }</span>
<a href="#l3.2057"></a><span id="l3.2057">     }</span>
<a href="#l3.2058"></a><span id="l3.2058"> </span>
<a href="#l3.2059"></a><span id="l3.2059">     return [errType, errName];</span>
<a href="#l3.2060"></a><span id="l3.2060">   },</span>
<a href="#l3.2061"></a><span id="l3.2061"> </span>
<a href="#l3.2062"></a><span id="l3.2062" class="difflineminus">-/**</span>
<a href="#l3.2063"></a><span id="l3.2063" class="difflineminus">- * Returns if a uri/url is valid to subscribe.</span>
<a href="#l3.2064"></a><span id="l3.2064" class="difflineminus">- *</span>
<a href="#l3.2065"></a><span id="l3.2065" class="difflineminus">- * @param  nsIURI aUri or string aUrl  - the Uri/Url.</span>
<a href="#l3.2066"></a><span id="l3.2066" class="difflineminus">- * @return boolean                     - true if a valid scheme, false if not.</span>
<a href="#l3.2067"></a><span id="l3.2067" class="difflineminus">- */</span>
<a href="#l3.2068"></a><span id="l3.2068" class="difflineplus">+  /**</span>
<a href="#l3.2069"></a><span id="l3.2069" class="difflineplus">+   * Returns if a uri/url is valid to subscribe.</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineplus">+   *</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineplus">+   * @param {nsIURI} aUri or {String} aUrl  - The Uri/Url.</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineplus">+   *</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineplus">+   * @returns {Boolean}                     - true if a valid scheme, false if not.</span>
<a href="#l3.2074"></a><span id="l3.2074" class="difflineplus">+   */</span>
<a href="#l3.2075"></a><span id="l3.2075">   _validSchemes: [&quot;http&quot;, &quot;https&quot;],</span>
<a href="#l3.2076"></a><span id="l3.2076" class="difflineminus">-  isValidScheme: function(aUri) {</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineplus">+  isValidScheme(aUri) {</span>
<a href="#l3.2078"></a><span id="l3.2078">     if (!(aUri instanceof Ci.nsIURI)) {</span>
<a href="#l3.2079"></a><span id="l3.2079">       try {</span>
<a href="#l3.2080"></a><span id="l3.2080">         aUri = Services.io.newURI(aUri);</span>
<a href="#l3.2081"></a><span id="l3.2081" class="difflineminus">-      }</span>
<a href="#l3.2082"></a><span id="l3.2082" class="difflineminus">-      catch (ex) {</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineplus">+      } catch (ex) {</span>
<a href="#l3.2084"></a><span id="l3.2084">         return false;</span>
<a href="#l3.2085"></a><span id="l3.2085">       }</span>
<a href="#l3.2086"></a><span id="l3.2086">     }</span>
<a href="#l3.2087"></a><span id="l3.2087"> </span>
<a href="#l3.2088"></a><span id="l3.2088">     return this._validSchemes.includes(aUri.scheme);</span>
<a href="#l3.2089"></a><span id="l3.2089">   },</span>
<a href="#l3.2090"></a><span id="l3.2090"> </span>
<a href="#l3.2091"></a><span id="l3.2091" class="difflineminus">-/**</span>
<a href="#l3.2092"></a><span id="l3.2092" class="difflineminus">- * Is a folder Trash or in Trash.</span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineminus">- *</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineminus">- * @param  nsIMsgFolder aFolder   - the folder.</span>
<a href="#l3.2095"></a><span id="l3.2095" class="difflineminus">- * @return boolean                - true if folder is Trash else false.</span>
<a href="#l3.2096"></a><span id="l3.2096" class="difflineminus">- */</span>
<a href="#l3.2097"></a><span id="l3.2097" class="difflineminus">-  isInTrash: function(aFolder) {</span>
<a href="#l3.2098"></a><span id="l3.2098" class="difflineminus">-    let trashFolder =</span>
<a href="#l3.2099"></a><span id="l3.2099" class="difflineminus">-        aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l3.2100"></a><span id="l3.2100" class="difflineplus">+  /**</span>
<a href="#l3.2101"></a><span id="l3.2101" class="difflineplus">+   * Is a folder Trash or in Trash.</span>
<a href="#l3.2102"></a><span id="l3.2102" class="difflineplus">+   *</span>
<a href="#l3.2103"></a><span id="l3.2103" class="difflineplus">+   * @param {nsIMsgFolder} aFolder   - The folder.</span>
<a href="#l3.2104"></a><span id="l3.2104" class="difflineplus">+   *</span>
<a href="#l3.2105"></a><span id="l3.2105" class="difflineplus">+   * @returns {Boolean}              - true if folder is Trash else false.</span>
<a href="#l3.2106"></a><span id="l3.2106" class="difflineplus">+   */</span>
<a href="#l3.2107"></a><span id="l3.2107" class="difflineplus">+  isInTrash(aFolder) {</span>
<a href="#l3.2108"></a><span id="l3.2108" class="difflineplus">+    let trashFolder = aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l3.2109"></a><span id="l3.2109">     if (trashFolder &amp;&amp;</span>
<a href="#l3.2110"></a><span id="l3.2110" class="difflineminus">-        (trashFolder == aFolder || trashFolder.isAncestorOf(aFolder)))</span>
<a href="#l3.2111"></a><span id="l3.2111" class="difflineplus">+        (trashFolder == aFolder || trashFolder.isAncestorOf(aFolder))) {</span>
<a href="#l3.2112"></a><span id="l3.2112">       return true;</span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineplus">+    }</span>
<a href="#l3.2114"></a><span id="l3.2114" class="difflineplus">+</span>
<a href="#l3.2115"></a><span id="l3.2115">     return false;</span>
<a href="#l3.2116"></a><span id="l3.2116">   },</span>
<a href="#l3.2117"></a><span id="l3.2117"> </span>
<a href="#l3.2118"></a><span id="l3.2118" class="difflineminus">-/**</span>
<a href="#l3.2119"></a><span id="l3.2119" class="difflineminus">- * Return a folder path string constructed from individual folder UTF8 names</span>
<a href="#l3.2120"></a><span id="l3.2120" class="difflineminus">- * stored as properties (not possible hashes used to construct disk foldername).</span>
<a href="#l3.2121"></a><span id="l3.2121" class="difflineminus">- *</span>
<a href="#l3.2122"></a><span id="l3.2122" class="difflineminus">- * @param  nsIMsgFolder aFolder     - the folder.</span>
<a href="#l3.2123"></a><span id="l3.2123" class="difflineminus">- * @return string prettyName | null - name or null if not a disk folder.</span>
<a href="#l3.2124"></a><span id="l3.2124" class="difflineminus">- */</span>
<a href="#l3.2125"></a><span id="l3.2125" class="difflineminus">-  getFolderPrettyPath: function(aFolder) {</span>
<a href="#l3.2126"></a><span id="l3.2126" class="difflineplus">+  /**</span>
<a href="#l3.2127"></a><span id="l3.2127" class="difflineplus">+   * Return a folder path string constructed from individual folder UTF8 names</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineplus">+   * stored as properties (not possible hashes used to construct disk foldername).</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineplus">+   *</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineplus">+   * @param {nsIMsgFolder} aFolder         - The folder.</span>
<a href="#l3.2131"></a><span id="l3.2131" class="difflineplus">+   *</span>
<a href="#l3.2132"></a><span id="l3.2132" class="difflineplus">+   * @returns {String} prettyName or null  - Name or null if not a disk folder.</span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineplus">+   */</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineplus">+  getFolderPrettyPath(aFolder) {</span>
<a href="#l3.2135"></a><span id="l3.2135">     let msgFolder = MailUtils.getFolderForURI(aFolder.URI, true);</span>
<a href="#l3.2136"></a><span id="l3.2136" class="difflineminus">-    if (!msgFolder)</span>
<a href="#l3.2137"></a><span id="l3.2137" class="difflineplus">+    if (!msgFolder) {</span>
<a href="#l3.2138"></a><span id="l3.2138">       // Not a real folder uri.</span>
<a href="#l3.2139"></a><span id="l3.2139">       return null;</span>
<a href="#l3.2140"></a><span id="l3.2140" class="difflineplus">+    }</span>
<a href="#l3.2141"></a><span id="l3.2141"> </span>
<a href="#l3.2142"></a><span id="l3.2142" class="difflineminus">-    if (msgFolder.URI == msgFolder.server.serverURI)</span>
<a href="#l3.2143"></a><span id="l3.2143" class="difflineplus">+    if (msgFolder.URI == msgFolder.server.serverURI) {</span>
<a href="#l3.2144"></a><span id="l3.2144">       return msgFolder.server.prettyName;</span>
<a href="#l3.2145"></a><span id="l3.2145" class="difflineplus">+    }</span>
<a href="#l3.2146"></a><span id="l3.2146"> </span>
<a href="#l3.2147"></a><span id="l3.2147">     // Server part first.</span>
<a href="#l3.2148"></a><span id="l3.2148">     let pathParts = [msgFolder.server.prettyName];</span>
<a href="#l3.2149"></a><span id="l3.2149">     let rawPathParts = msgFolder.URI.split(msgFolder.server.serverURI + &quot;/&quot;);</span>
<a href="#l3.2150"></a><span id="l3.2150">     let folderURI = msgFolder.server.serverURI;</span>
<a href="#l3.2151"></a><span id="l3.2151">     rawPathParts = rawPathParts[1].split(&quot;/&quot;);</span>
<a href="#l3.2152"></a><span id="l3.2152" class="difflineminus">-    for (let i = 0; i &lt; rawPathParts.length - 1; i++)</span>
<a href="#l3.2153"></a><span id="l3.2153" class="difflineminus">-    {</span>
<a href="#l3.2154"></a><span id="l3.2154" class="difflineplus">+    for (let i = 0; i &lt; rawPathParts.length - 1; i++) {</span>
<a href="#l3.2155"></a><span id="l3.2155">       // Two or more folders deep parts here.</span>
<a href="#l3.2156"></a><span id="l3.2156">       folderURI += &quot;/&quot; + rawPathParts[i];</span>
<a href="#l3.2157"></a><span id="l3.2157">       msgFolder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l3.2158"></a><span id="l3.2158">       pathParts.push(msgFolder.name);</span>
<a href="#l3.2159"></a><span id="l3.2159">     }</span>
<a href="#l3.2160"></a><span id="l3.2160"> </span>
<a href="#l3.2161"></a><span id="l3.2161">     // Leaf folder last.</span>
<a href="#l3.2162"></a><span id="l3.2162">     pathParts.push(aFolder.name);</span>
<a href="#l3.2163"></a><span id="l3.2163">     return pathParts.join(&quot;/&quot;);</span>
<a href="#l3.2164"></a><span id="l3.2164">   },</span>
<a href="#l3.2165"></a><span id="l3.2165"> </span>
<a href="#l3.2166"></a><span id="l3.2166" class="difflineminus">-/**</span>
<a href="#l3.2167"></a><span id="l3.2167" class="difflineminus">- * Date validator for feeds.</span>
<a href="#l3.2168"></a><span id="l3.2168" class="difflineminus">- *</span>
<a href="#l3.2169"></a><span id="l3.2169" class="difflineminus">- * @param  string aDate - date string</span>
<a href="#l3.2170"></a><span id="l3.2170" class="difflineminus">- * @return boolean      - true if passes regex test, false if not</span>
<a href="#l3.2171"></a><span id="l3.2171" class="difflineminus">- */</span>
<a href="#l3.2172"></a><span id="l3.2172" class="difflineminus">-  isValidRFC822Date: function(aDate)</span>
<a href="#l3.2173"></a><span id="l3.2173" class="difflineminus">-  {</span>
<a href="#l3.2174"></a><span id="l3.2174" class="difflineplus">+  /**</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineplus">+   * Date validator for feeds.</span>
<a href="#l3.2176"></a><span id="l3.2176" class="difflineplus">+   *</span>
<a href="#l3.2177"></a><span id="l3.2177" class="difflineplus">+   * @param {String} aDate - Date string.</span>
<a href="#l3.2178"></a><span id="l3.2178" class="difflineplus">+   *</span>
<a href="#l3.2179"></a><span id="l3.2179" class="difflineplus">+   * @returns {Boolean}      - true if passes regex test, false if not.</span>
<a href="#l3.2180"></a><span id="l3.2180" class="difflineplus">+   */</span>
<a href="#l3.2181"></a><span id="l3.2181" class="difflineplus">+  isValidRFC822Date(aDate) {</span>
<a href="#l3.2182"></a><span id="l3.2182">     const FZ_RFC822_RE = &quot;^(((Mon)|(Tue)|(Wed)|(Thu)|(Fri)|(Sat)|(Sun)), *)?\\d\\d?&quot; +</span>
<a href="#l3.2183"></a><span id="l3.2183">     &quot; +((Jan)|(Feb)|(Mar)|(Apr)|(May)|(Jun)|(Jul)|(Aug)|(Sep)|(Oct)|(Nov)|(Dec))&quot; +</span>
<a href="#l3.2184"></a><span id="l3.2184">     &quot; +\\d\\d(\\d\\d)? +\\d\\d:\\d\\d(:\\d\\d)? +(([+-]?\\d\\d\\d\\d)|(UT)|(GMT)&quot; +</span>
<a href="#l3.2185"></a><span id="l3.2185">     &quot;|(EST)|(EDT)|(CST)|(CDT)|(MST)|(MDT)|(PST)|(PDT)|\\w)$&quot;;</span>
<a href="#l3.2186"></a><span id="l3.2186">     let regex = new RegExp(FZ_RFC822_RE);</span>
<a href="#l3.2187"></a><span id="l3.2187">     return regex.test(aDate);</span>
<a href="#l3.2188"></a><span id="l3.2188">   },</span>
<a href="#l3.2189"></a><span id="l3.2189"> </span>
<a href="#l3.2190"></a><span id="l3.2190" class="difflineminus">-/**</span>
<a href="#l3.2191"></a><span id="l3.2191" class="difflineminus">- * Create rfc5322 date.</span>
<a href="#l3.2192"></a><span id="l3.2192" class="difflineminus">- *</span>
<a href="#l3.2193"></a><span id="l3.2193" class="difflineminus">- * @param  [string] aDateString - optional date string; if null or invalid</span>
<a href="#l3.2194"></a><span id="l3.2194" class="difflineminus">- *                                 date, get the current datetime.</span>
<a href="#l3.2195"></a><span id="l3.2195" class="difflineminus">- * @return string               - an rfc5322 date string</span>
<a href="#l3.2196"></a><span id="l3.2196" class="difflineminus">- */</span>
<a href="#l3.2197"></a><span id="l3.2197" class="difflineminus">-  getValidRFC5322Date: function(aDateString)</span>
<a href="#l3.2198"></a><span id="l3.2198" class="difflineminus">-  {</span>
<a href="#l3.2199"></a><span id="l3.2199" class="difflineplus">+  /**</span>
<a href="#l3.2200"></a><span id="l3.2200" class="difflineplus">+   * Create rfc5322 date.</span>
<a href="#l3.2201"></a><span id="l3.2201" class="difflineplus">+   *</span>
<a href="#l3.2202"></a><span id="l3.2202" class="difflineplus">+   * @param {String} aDateString - Optional date string; if null or invalid</span>
<a href="#l3.2203"></a><span id="l3.2203" class="difflineplus">+   *                               date, get the current datetime.</span>
<a href="#l3.2204"></a><span id="l3.2204" class="difflineplus">+   *</span>
<a href="#l3.2205"></a><span id="l3.2205" class="difflineplus">+   * @returns {String}           - An rfc5322 date string.</span>
<a href="#l3.2206"></a><span id="l3.2206" class="difflineplus">+   */</span>
<a href="#l3.2207"></a><span id="l3.2207" class="difflineplus">+  getValidRFC5322Date(aDateString) {</span>
<a href="#l3.2208"></a><span id="l3.2208">     let d = new Date(aDateString || new Date().getTime());</span>
<a href="#l3.2209"></a><span id="l3.2209">     d = isNaN(d.getTime()) ? new Date() : d;</span>
<a href="#l3.2210"></a><span id="l3.2210">     return jsmime.headeremitter.emitStructuredHeader(&quot;Date&quot;, d, {}).substring(6).trim();</span>
<a href="#l3.2211"></a><span id="l3.2211">   },</span>
<a href="#l3.2212"></a><span id="l3.2212"> </span>
<a href="#l3.2213"></a><span id="l3.2213" class="difflineminus">-  // Progress glue code.  Acts as a go between the RSS back end and the mail</span>
<a href="#l3.2214"></a><span id="l3.2214" class="difflineminus">-  // window front end determined by the aMsgWindow parameter passed into</span>
<a href="#l3.2215"></a><span id="l3.2215" class="difflineminus">-  // nsINewsBlogFeedDownloader.</span>
<a href="#l3.2216"></a><span id="l3.2216" class="difflineplus">+  /**</span>
<a href="#l3.2217"></a><span id="l3.2217" class="difflineplus">+   * Progress glue code.  Acts as a go between the RSS back end and the mail</span>
<a href="#l3.2218"></a><span id="l3.2218" class="difflineplus">+   * window front end determined by the aMsgWindow parameter passed into</span>
<a href="#l3.2219"></a><span id="l3.2219" class="difflineplus">+   * nsINewsBlogFeedDownloader.</span>
<a href="#l3.2220"></a><span id="l3.2220" class="difflineplus">+   */</span>
<a href="#l3.2221"></a><span id="l3.2221">   progressNotifier: {</span>
<a href="#l3.2222"></a><span id="l3.2222">     mSubscribeMode: false,</span>
<a href="#l3.2223"></a><span id="l3.2223">     mMsgWindow: null,</span>
<a href="#l3.2224"></a><span id="l3.2224">     mStatusFeedback: null,</span>
<a href="#l3.2225"></a><span id="l3.2225">     mFeeds: {},</span>
<a href="#l3.2226"></a><span id="l3.2226">     // Keeps track of the total number of feeds we have been asked to download.</span>
<a href="#l3.2227"></a><span id="l3.2227">     // This number may not reflect the # of entries in our mFeeds array because</span>
<a href="#l3.2228"></a><span id="l3.2228">     // not all feeds may have reported in for the first time.</span>
<a href="#l3.2229"></a><span id="l3.2229">     mNumPendingFeedDownloads: 0,</span>
<a href="#l3.2230"></a><span id="l3.2230"> </span>
<a href="#l3.2231"></a><span id="l3.2231" class="difflineminus">-    init: function(aMsgWindow, aSubscribeMode)</span>
<a href="#l3.2232"></a><span id="l3.2232" class="difflineminus">-    {</span>
<a href="#l3.2233"></a><span id="l3.2233" class="difflineminus">-      if (this.mNumPendingFeedDownloads == 0)</span>
<a href="#l3.2234"></a><span id="l3.2234" class="difflineminus">-      {</span>
<a href="#l3.2235"></a><span id="l3.2235" class="difflineplus">+    init(aMsgWindow, aSubscribeMode) {</span>
<a href="#l3.2236"></a><span id="l3.2236" class="difflineplus">+      if (this.mNumPendingFeedDownloads == 0) {</span>
<a href="#l3.2237"></a><span id="l3.2237">         // If we aren't already in the middle of downloading feed items.</span>
<a href="#l3.2238"></a><span id="l3.2238">         this.mStatusFeedback = aMsgWindow ? aMsgWindow.statusFeedback : null;</span>
<a href="#l3.2239"></a><span id="l3.2239">         this.mSubscribeMode = aSubscribeMode;</span>
<a href="#l3.2240"></a><span id="l3.2240">         this.mMsgWindow = aMsgWindow;</span>
<a href="#l3.2241"></a><span id="l3.2241"> </span>
<a href="#l3.2242"></a><span id="l3.2242" class="difflineminus">-        if (this.mStatusFeedback)</span>
<a href="#l3.2243"></a><span id="l3.2243" class="difflineminus">-        {</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineplus">+        if (this.mStatusFeedback) {</span>
<a href="#l3.2245"></a><span id="l3.2245">           this.mStatusFeedback.startMeteors();</span>
<a href="#l3.2246"></a><span id="l3.2246">           this.mStatusFeedback.showStatusString(</span>
<a href="#l3.2247"></a><span id="l3.2247">             FeedUtils.strings.GetStringFromName(</span>
<a href="#l3.2248"></a><span id="l3.2248">               aSubscribeMode ? &quot;subscribe-validating-feed&quot; :</span>
<a href="#l3.2249"></a><span id="l3.2249">                                &quot;newsblog-getNewMsgsCheck&quot;));</span>
<a href="#l3.2250"></a><span id="l3.2250">         }</span>
<a href="#l3.2251"></a><span id="l3.2251">       }</span>
<a href="#l3.2252"></a><span id="l3.2252">     },</span>
<a href="#l3.2253"></a><span id="l3.2253"> </span>
<a href="#l3.2254"></a><span id="l3.2254">     /**</span>
<a href="#l3.2255"></a><span id="l3.2255">      * Called on final success or error resolution of a feed download and</span>
<a href="#l3.2256"></a><span id="l3.2256">      * parsing. If aDisable is true, the error shouldn't be retried continually</span>
<a href="#l3.2257"></a><span id="l3.2257">      * and the url should be verified by the user. A bad html response code or</span>
<a href="#l3.2258"></a><span id="l3.2258">      * cert error will cause the url to be disabled, while general network</span>
<a href="#l3.2259"></a><span id="l3.2259">      * connectivity errors applying to all urls will not.</span>
<a href="#l3.2260"></a><span id="l3.2260">      *</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineminus">-     * Feed feed             - The Feed object, or a synthetic object that must</span>
<a href="#l3.2262"></a><span id="l3.2262" class="difflineminus">-     *                         contain members {nsIMsgFolder folder, string url}</span>
<a href="#l3.2263"></a><span id="l3.2263" class="difflineminus">-     * kNewsBlog* aErrorcode - The resolution code.</span>
<a href="#l3.2264"></a><span id="l3.2264" class="difflineminus">-     * bool aDisable         - If true, disable/pause the feed.</span>
<a href="#l3.2265"></a><span id="l3.2265" class="difflineplus">+     * @param {Feed} feed - The Feed object, or a synthetic object that must</span>
<a href="#l3.2266"></a><span id="l3.2266" class="difflineplus">+     *                      contain members {nsIMsgFolder folder, String url}.</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineplus">+     * @param {Integer} aErrorCode  - The resolution code, a kNewsBlog* value.</span>
<a href="#l3.2268"></a><span id="l3.2268" class="difflineplus">+     * @param {Boolean} aDisable    - If true, disable/pause the feed.</span>
<a href="#l3.2269"></a><span id="l3.2269" class="difflineplus">+     *</span>
<a href="#l3.2270"></a><span id="l3.2270" class="difflineplus">+     * @returns {void}</span>
<a href="#l3.2271"></a><span id="l3.2271">      */</span>
<a href="#l3.2272"></a><span id="l3.2272" class="difflineminus">-    downloaded: function(feed, aErrorCode, aDisable)</span>
<a href="#l3.2273"></a><span id="l3.2273" class="difflineminus">-    {</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineplus">+    downloaded(feed, aErrorCode, aDisable) {</span>
<a href="#l3.2275"></a><span id="l3.2275">       let folderName = feed.folder ? feed.folder.name :</span>
<a href="#l3.2276"></a><span id="l3.2276">                                      feed.server.rootFolder.prettyName;</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineminus">-      FeedUtils.log.debug(&quot;downloaded: &quot;+</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineplus">+      FeedUtils.log.debug(&quot;downloaded: &quot; +</span>
<a href="#l3.2279"></a><span id="l3.2279">                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l3.2280"></a><span id="l3.2280">                           &quot;errorCode:folderName:feedUrl - &quot; +</span>
<a href="#l3.2281"></a><span id="l3.2281">                           aErrorCode + &quot; : &quot; + folderName + &quot; : &quot; + feed.url);</span>
<a href="#l3.2282"></a><span id="l3.2282" class="difflineminus">-      if (this.mSubscribeMode)</span>
<a href="#l3.2283"></a><span id="l3.2283" class="difflineminus">-      {</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineminus">-        {</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineplus">+      if (this.mSubscribeMode) {</span>
<a href="#l3.2287"></a><span id="l3.2287" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogSuccess) {</span>
<a href="#l3.2288"></a><span id="l3.2288">           // Add the feed to the databases.</span>
<a href="#l3.2289"></a><span id="l3.2289">           FeedUtils.addFeed(feed);</span>
<a href="#l3.2290"></a><span id="l3.2290"> </span>
<a href="#l3.2291"></a><span id="l3.2291">           // Nice touch: select the folder that now contains the newly subscribed</span>
<a href="#l3.2292"></a><span id="l3.2292">           // feed.  This is particularly nice if we just finished subscribing</span>
<a href="#l3.2293"></a><span id="l3.2293">           // to a feed URL that the operating system gave us.</span>
<a href="#l3.2294"></a><span id="l3.2294">           this.mMsgWindow.windowCommands.selectFolder(feed.folder.URI);</span>
<a href="#l3.2295"></a><span id="l3.2295"> </span>
<a href="#l3.2296"></a><span id="l3.2296">           // Check for an existing feed subscriptions window and update it.</span>
<a href="#l3.2297"></a><span id="l3.2297">           let subscriptionsWindow =</span>
<a href="#l3.2298"></a><span id="l3.2298">               Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l3.2299"></a><span id="l3.2299" class="difflineminus">-          if (subscriptionsWindow)</span>
<a href="#l3.2300"></a><span id="l3.2300" class="difflineplus">+          if (subscriptionsWindow) {</span>
<a href="#l3.2301"></a><span id="l3.2301">             subscriptionsWindow.FeedSubscriptions.</span>
<a href="#l3.2302"></a><span id="l3.2302">                                 FolderListener.folderAdded(feed.folder);</span>
<a href="#l3.2303"></a><span id="l3.2303" class="difflineminus">-        }</span>
<a href="#l3.2304"></a><span id="l3.2304" class="difflineminus">-        else</span>
<a href="#l3.2305"></a><span id="l3.2305" class="difflineminus">-        {</span>
<a href="#l3.2306"></a><span id="l3.2306" class="difflineplus">+          }</span>
<a href="#l3.2307"></a><span id="l3.2307" class="difflineplus">+        } else if (feed &amp;&amp; feed.url &amp;&amp; feed.server) {</span>
<a href="#l3.2308"></a><span id="l3.2308">           // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l3.2309"></a><span id="l3.2309" class="difflineminus">-          if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l3.2310"></a><span id="l3.2310" class="difflineminus">-            FeedUtils.deleteFeed(feed);</span>
<a href="#l3.2311"></a><span id="l3.2311" class="difflineplus">+          FeedUtils.deleteFeed(feed);</span>
<a href="#l3.2312"></a><span id="l3.2312">         }</span>
<a href="#l3.2313"></a><span id="l3.2313">       }</span>
<a href="#l3.2314"></a><span id="l3.2314"> </span>
<a href="#l3.2315"></a><span id="l3.2315" class="difflineminus">-      if (aErrorCode != FeedUtils.kNewsBlogFeedIsBusy)</span>
<a href="#l3.2316"></a><span id="l3.2316" class="difflineminus">-      {</span>
<a href="#l3.2317"></a><span id="l3.2317" class="difflineplus">+      if (aErrorCode != FeedUtils.kNewsBlogFeedIsBusy) {</span>
<a href="#l3.2318"></a><span id="l3.2318">         if (aErrorCode == FeedUtils.kNewsBlogSuccess ||</span>
<a href="#l3.2319"></a><span id="l3.2319" class="difflineminus">-            aErrorCode == FeedUtils.kNewsBlogNoNewItems)</span>
<a href="#l3.2320"></a><span id="l3.2320" class="difflineminus">-        {</span>
<a href="#l3.2321"></a><span id="l3.2321" class="difflineplus">+            aErrorCode == FeedUtils.kNewsBlogNoNewItems) {</span>
<a href="#l3.2322"></a><span id="l3.2322">           // Update lastUpdateTime only if successful normal processing.</span>
<a href="#l3.2323"></a><span id="l3.2323">           let options = feed.options;</span>
<a href="#l3.2324"></a><span id="l3.2324">           let now = Date.now();</span>
<a href="#l3.2325"></a><span id="l3.2325">           options.updates.lastUpdateTime = now;</span>
<a href="#l3.2326"></a><span id="l3.2326" class="difflineminus">-          if (feed.itemsStored)</span>
<a href="#l3.2327"></a><span id="l3.2327" class="difflineplus">+          if (feed.itemsStored) {</span>
<a href="#l3.2328"></a><span id="l3.2328">             options.updates.lastDownloadTime = now;</span>
<a href="#l3.2329"></a><span id="l3.2329" class="difflineplus">+          }</span>
<a href="#l3.2330"></a><span id="l3.2330"> </span>
<a href="#l3.2331"></a><span id="l3.2331">           // If a previously disabled due to error feed is successful, set</span>
<a href="#l3.2332"></a><span id="l3.2332">           // enabled state on, as that was the desired user setting.</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineminus">-          if (options.updates.enabled == null)</span>
<a href="#l3.2334"></a><span id="l3.2334" class="difflineminus">-          {</span>
<a href="#l3.2335"></a><span id="l3.2335" class="difflineplus">+          if (options.updates.enabled == null) {</span>
<a href="#l3.2336"></a><span id="l3.2336">             options.updates.enabled = true;</span>
<a href="#l3.2337"></a><span id="l3.2337">             FeedUtils.setStatus(feed.folder, feed.url, &quot;enabled&quot;, true);</span>
<a href="#l3.2338"></a><span id="l3.2338">           }</span>
<a href="#l3.2339"></a><span id="l3.2339"> </span>
<a href="#l3.2340"></a><span id="l3.2340">           feed.options = options;</span>
<a href="#l3.2341"></a><span id="l3.2341">           FeedUtils.setStatus(feed.folder, feed.url, &quot;lastUpdateTime&quot;, now);</span>
<a href="#l3.2342"></a><span id="l3.2342" class="difflineminus">-        }</span>
<a href="#l3.2343"></a><span id="l3.2343" class="difflineminus">-        else if (aDisable)</span>
<a href="#l3.2344"></a><span id="l3.2344" class="difflineminus">-        {</span>
<a href="#l3.2345"></a><span id="l3.2345" class="difflineplus">+        } else if (aDisable) {</span>
<a href="#l3.2346"></a><span id="l3.2346">           // Do not keep retrying feeds with error states. Set persisted state</span>
<a href="#l3.2347"></a><span id="l3.2347">           // to |null| to indicate error disable (and not user disable), but</span>
<a href="#l3.2348"></a><span id="l3.2348">           // only if the feed is user enabled.</span>
<a href="#l3.2349"></a><span id="l3.2349">           let options = feed.options;</span>
<a href="#l3.2350"></a><span id="l3.2350" class="difflineminus">-          if (options.updates.enabled)</span>
<a href="#l3.2351"></a><span id="l3.2351" class="difflineplus">+          if (options.updates.enabled) {</span>
<a href="#l3.2352"></a><span id="l3.2352">             options.updates.enabled = null;</span>
<a href="#l3.2353"></a><span id="l3.2353" class="difflineplus">+          }</span>
<a href="#l3.2354"></a><span id="l3.2354"> </span>
<a href="#l3.2355"></a><span id="l3.2355">           feed.options = options;</span>
<a href="#l3.2356"></a><span id="l3.2356">           FeedUtils.setStatus(feed.folder, feed.url, &quot;enabled&quot;, false);</span>
<a href="#l3.2357"></a><span id="l3.2357">           FeedUtils.log.warn(&quot;downloaded: updates disabled due to error, &quot; +</span>
<a href="#l3.2358"></a><span id="l3.2358">                              &quot;check the url - &quot; + feed.url);</span>
<a href="#l3.2359"></a><span id="l3.2359">         }</span>
<a href="#l3.2360"></a><span id="l3.2360"> </span>
<a href="#l3.2361"></a><span id="l3.2361" class="difflineminus">-        if (!this.mSubscribeMode)</span>
<a href="#l3.2362"></a><span id="l3.2362" class="difflineminus">-        {</span>
<a href="#l3.2363"></a><span id="l3.2363" class="difflineplus">+        if (!this.mSubscribeMode) {</span>
<a href="#l3.2364"></a><span id="l3.2364">           FeedUtils.setStatus(feed.folder, feed.url, &quot;code&quot;, aErrorCode);</span>
<a href="#l3.2365"></a><span id="l3.2365"> </span>
<a href="#l3.2366"></a><span id="l3.2366">           if (feed.folder &amp;&amp;</span>
<a href="#l3.2367"></a><span id="l3.2367" class="difflineminus">-              !FeedUtils.getFolderProperties(feed.folder).includes(&quot;isBusy&quot;))</span>
<a href="#l3.2368"></a><span id="l3.2368" class="difflineminus">-          {</span>
<a href="#l3.2369"></a><span id="l3.2369" class="difflineplus">+              !FeedUtils.getFolderProperties(feed.folder).includes(&quot;isBusy&quot;)) {</span>
<a href="#l3.2370"></a><span id="l3.2370">             // Free msgDatabase after new mail biff is set; if busy let the next</span>
<a href="#l3.2371"></a><span id="l3.2371">             // result do the freeing.  Otherwise new messages won't be indicated.</span>
<a href="#l3.2372"></a><span id="l3.2372">             // This feed may belong to a folder with multiple other feeds, some</span>
<a href="#l3.2373"></a><span id="l3.2373">             // of which may not yet be finished, so free only if the folder is</span>
<a href="#l3.2374"></a><span id="l3.2374">             // no longer busy.</span>
<a href="#l3.2375"></a><span id="l3.2375">             feed.folder.msgDatabase = null;</span>
<a href="#l3.2376"></a><span id="l3.2376">             FeedUtils.log.debug(&quot;downloaded: msgDatabase freed - &quot; + feed.folder.name);</span>
<a href="#l3.2377"></a><span id="l3.2377">           }</span>
<a href="#l3.2378"></a><span id="l3.2378" class="difflineat">@@ -1887,17 +1907,17 @@ var FeedUtils = {</span>
<a href="#l3.2379"></a><span id="l3.2379"> </span>
<a href="#l3.2380"></a><span id="l3.2380">       let message = &quot;&quot;;</span>
<a href="#l3.2381"></a><span id="l3.2381">       switch (aErrorCode) {</span>
<a href="#l3.2382"></a><span id="l3.2382">         case FeedUtils.kNewsBlogSuccess:</span>
<a href="#l3.2383"></a><span id="l3.2383">         case FeedUtils.kNewsBlogFeedIsBusy:</span>
<a href="#l3.2384"></a><span id="l3.2384">           message = &quot;&quot;;</span>
<a href="#l3.2385"></a><span id="l3.2385">           break;</span>
<a href="#l3.2386"></a><span id="l3.2386">         case FeedUtils.kNewsBlogNoNewItems:</span>
<a href="#l3.2387"></a><span id="l3.2387" class="difflineminus">-          message = feed.url+&quot;. &quot; +</span>
<a href="#l3.2388"></a><span id="l3.2388" class="difflineplus">+          message = feed.url + &quot;. &quot; +</span>
<a href="#l3.2389"></a><span id="l3.2389">                     FeedUtils.strings.GetStringFromName(</span>
<a href="#l3.2390"></a><span id="l3.2390">                       &quot;newsblog-noNewArticlesForFeed&quot;);</span>
<a href="#l3.2391"></a><span id="l3.2391">           break;</span>
<a href="#l3.2392"></a><span id="l3.2392">         case FeedUtils.kNewsBlogInvalidFeed:</span>
<a href="#l3.2393"></a><span id="l3.2393">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.2394"></a><span id="l3.2394">                       &quot;newsblog-feedNotValid&quot;, [feed.url], 1);</span>
<a href="#l3.2395"></a><span id="l3.2395">           break;</span>
<a href="#l3.2396"></a><span id="l3.2396">         case FeedUtils.kNewsBlogRequestFailure:</span>
<a href="#l3.2397"></a><span id="l3.2397" class="difflineat">@@ -1913,108 +1933,111 @@ var FeedUtils = {</span>
<a href="#l3.2398"></a><span id="l3.2398">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.2399"></a><span id="l3.2399">                       &quot;newsblog-badCertError&quot;, [host], 1);</span>
<a href="#l3.2400"></a><span id="l3.2400">           break;</span>
<a href="#l3.2401"></a><span id="l3.2401">         case FeedUtils.kNewsBlogNoAuthError:</span>
<a href="#l3.2402"></a><span id="l3.2402">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.2403"></a><span id="l3.2403">                       &quot;newsblog-noAuthError&quot;, [feed.url], 1);</span>
<a href="#l3.2404"></a><span id="l3.2404">           break;</span>
<a href="#l3.2405"></a><span id="l3.2405">       }</span>
<a href="#l3.2406"></a><span id="l3.2406" class="difflineminus">-      if (message)</span>
<a href="#l3.2407"></a><span id="l3.2407" class="difflineminus">-      {</span>
<a href="#l3.2408"></a><span id="l3.2408" class="difflineplus">+</span>
<a href="#l3.2409"></a><span id="l3.2409" class="difflineplus">+      if (message) {</span>
<a href="#l3.2410"></a><span id="l3.2410">         let location = FeedUtils.getFolderPrettyPath(feed.folder ||</span>
<a href="#l3.2411"></a><span id="l3.2411">                                                      feed.server.rootFolder) + &quot; -&gt; &quot;;</span>
<a href="#l3.2412"></a><span id="l3.2412">         FeedUtils.log.info(&quot;downloaded: &quot; +</span>
<a href="#l3.2413"></a><span id="l3.2413">                            (this.mSubscribeMode ? &quot;Subscribe: &quot; : &quot;Update: &quot;) +</span>
<a href="#l3.2414"></a><span id="l3.2414">                            location + message);</span>
<a href="#l3.2415"></a><span id="l3.2415">       }</span>
<a href="#l3.2416"></a><span id="l3.2416"> </span>
<a href="#l3.2417"></a><span id="l3.2417" class="difflineminus">-      if (this.mStatusFeedback)</span>
<a href="#l3.2418"></a><span id="l3.2418" class="difflineminus">-      {</span>
<a href="#l3.2419"></a><span id="l3.2419" class="difflineplus">+      if (this.mStatusFeedback) {</span>
<a href="#l3.2420"></a><span id="l3.2420">         this.mStatusFeedback.showStatusString(message);</span>
<a href="#l3.2421"></a><span id="l3.2421">         this.mStatusFeedback.stopMeteors();</span>
<a href="#l3.2422"></a><span id="l3.2422">       }</span>
<a href="#l3.2423"></a><span id="l3.2423"> </span>
<a href="#l3.2424"></a><span id="l3.2424">       this.mNumPendingFeedDownloads--;</span>
<a href="#l3.2425"></a><span id="l3.2425"> </span>
<a href="#l3.2426"></a><span id="l3.2426" class="difflineminus">-      if (this.mNumPendingFeedDownloads == 0)</span>
<a href="#l3.2427"></a><span id="l3.2427" class="difflineminus">-      {</span>
<a href="#l3.2428"></a><span id="l3.2428" class="difflineminus">-        if (feed.server)</span>
<a href="#l3.2429"></a><span id="l3.2429" class="difflineplus">+      if (this.mNumPendingFeedDownloads == 0) {</span>
<a href="#l3.2430"></a><span id="l3.2430" class="difflineplus">+        if (feed.server) {</span>
<a href="#l3.2431"></a><span id="l3.2431">           FeedUtils.getSubscriptionsDS(feed.server).Flush();</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineplus">+        }</span>
<a href="#l3.2433"></a><span id="l3.2433"> </span>
<a href="#l3.2434"></a><span id="l3.2434">         this.mFeeds = {};</span>
<a href="#l3.2435"></a><span id="l3.2435">         this.mSubscribeMode = false;</span>
<a href="#l3.2436"></a><span id="l3.2436">         FeedUtils.log.debug(&quot;downloaded: all pending downloads finished&quot;);</span>
<a href="#l3.2437"></a><span id="l3.2437"> </span>
<a href="#l3.2438"></a><span id="l3.2438">         // Should we do this on a timer so the text sticks around for a little</span>
<a href="#l3.2439"></a><span id="l3.2439">         // while?  It doesn't look like we do it on a timer for newsgroups so</span>
<a href="#l3.2440"></a><span id="l3.2440">         // we'll follow that model.  Don't clear the status text if we just</span>
<a href="#l3.2441"></a><span id="l3.2441">         // dumped an error to the status bar!</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogSuccess &amp;&amp; this.mStatusFeedback)</span>
<a href="#l3.2443"></a><span id="l3.2443" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogSuccess &amp;&amp; this.mStatusFeedback) {</span>
<a href="#l3.2444"></a><span id="l3.2444">           this.mStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l3.2445"></a><span id="l3.2445" class="difflineplus">+        }</span>
<a href="#l3.2446"></a><span id="l3.2446">       }</span>
<a href="#l3.2447"></a><span id="l3.2447"> </span>
<a href="#l3.2448"></a><span id="l3.2448">       feed = null;</span>
<a href="#l3.2449"></a><span id="l3.2449">     },</span>
<a href="#l3.2450"></a><span id="l3.2450"> </span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineminus">-    // This gets called after the RSS parser finishes storing a feed item to</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineminus">-    // disk. aCurrentFeedItems is an integer corresponding to how many feed</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineminus">-    // items have been downloaded so far.  aMaxFeedItems is an integer</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineminus">-    // corresponding to the total number of feed items to download</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineminus">-    onFeedItemStored: function (feed, aCurrentFeedItems, aMaxFeedItems)</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineminus">-    {</span>
<a href="#l3.2457"></a><span id="l3.2457" class="difflineplus">+    /**</span>
<a href="#l3.2458"></a><span id="l3.2458" class="difflineplus">+     * This gets called after the RSS parser finishes storing a feed item to</span>
<a href="#l3.2459"></a><span id="l3.2459" class="difflineplus">+     * disk. aCurrentFeedItems is an integer corresponding to how many feed</span>
<a href="#l3.2460"></a><span id="l3.2460" class="difflineplus">+     * items have been downloaded so far. aMaxFeedItems is an integer</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineplus">+     * corresponding to the total number of feed items to download.</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineplus">+     *</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineplus">+     * @param {Feed} feed                 - The Feed object.</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineplus">+     * @param {Integer} aCurrentFeedItems - Number downloaded so far.</span>
<a href="#l3.2465"></a><span id="l3.2465" class="difflineplus">+     * @param {Integer} aMaxFeedItems     - Total number to download.</span>
<a href="#l3.2466"></a><span id="l3.2466" class="difflineplus">+     *</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineplus">+     * @returns {void}</span>
<a href="#l3.2468"></a><span id="l3.2468" class="difflineplus">+     */</span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineplus">+    onFeedItemStored(feed, aCurrentFeedItems, aMaxFeedItems) {</span>
<a href="#l3.2470"></a><span id="l3.2470">       // We currently don't do anything here.  Eventually we may add status</span>
<a href="#l3.2471"></a><span id="l3.2471">       // text about the number of new feed articles received.</span>
<a href="#l3.2472"></a><span id="l3.2472"> </span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineminus">-      if (this.mSubscribeMode &amp;&amp; this.mStatusFeedback)</span>
<a href="#l3.2474"></a><span id="l3.2474" class="difflineminus">-      {</span>
<a href="#l3.2475"></a><span id="l3.2475" class="difflineplus">+      if (this.mSubscribeMode &amp;&amp; this.mStatusFeedback) {</span>
<a href="#l3.2476"></a><span id="l3.2476">         // If we are subscribing to a feed, show feed download progress.</span>
<a href="#l3.2477"></a><span id="l3.2477">         this.mStatusFeedback.showStatusString(</span>
<a href="#l3.2478"></a><span id="l3.2478">           FeedUtils.strings.formatStringFromName(&quot;subscribe-gettingFeedItems&quot;,</span>
<a href="#l3.2479"></a><span id="l3.2479">                                                  [aCurrentFeedItems, aMaxFeedItems], 2));</span>
<a href="#l3.2480"></a><span id="l3.2480">         this.onProgress(feed, aCurrentFeedItems, aMaxFeedItems);</span>
<a href="#l3.2481"></a><span id="l3.2481">       }</span>
<a href="#l3.2482"></a><span id="l3.2482">     },</span>
<a href="#l3.2483"></a><span id="l3.2483"> </span>
<a href="#l3.2484"></a><span id="l3.2484" class="difflineminus">-    onProgress: function(feed, aProgress, aProgressMax, aLengthComputable)</span>
<a href="#l3.2485"></a><span id="l3.2485" class="difflineminus">-    {</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineminus">-      if (feed.url in this.mFeeds)</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineplus">+    onProgress(feed, aProgress, aProgressMax, aLengthComputable) {</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineplus">+      if (feed.url in this.mFeeds) {</span>
<a href="#l3.2489"></a><span id="l3.2489">         // Have we already seen this feed?</span>
<a href="#l3.2490"></a><span id="l3.2490">         this.mFeeds[feed.url].currentProgress = aProgress;</span>
<a href="#l3.2491"></a><span id="l3.2491" class="difflineminus">-      else</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineplus">+      } else {</span>
<a href="#l3.2493"></a><span id="l3.2493">         this.mFeeds[feed.url] = {currentProgress: aProgress,</span>
<a href="#l3.2494"></a><span id="l3.2494">                                  maxProgress: aProgressMax};</span>
<a href="#l3.2495"></a><span id="l3.2495" class="difflineplus">+      }</span>
<a href="#l3.2496"></a><span id="l3.2496"> </span>
<a href="#l3.2497"></a><span id="l3.2497">       this.updateProgressBar();</span>
<a href="#l3.2498"></a><span id="l3.2498">     },</span>
<a href="#l3.2499"></a><span id="l3.2499"> </span>
<a href="#l3.2500"></a><span id="l3.2500" class="difflineminus">-    updateProgressBar: function()</span>
<a href="#l3.2501"></a><span id="l3.2501" class="difflineminus">-    {</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineplus">+    updateProgressBar() {</span>
<a href="#l3.2503"></a><span id="l3.2503">       let currentProgress = 0;</span>
<a href="#l3.2504"></a><span id="l3.2504">       let maxProgress = 0;</span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineminus">-      for (let index in this.mFeeds)</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-      {</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineplus">+      for (let index in this.mFeeds) {</span>
<a href="#l3.2508"></a><span id="l3.2508">         currentProgress += this.mFeeds[index].currentProgress;</span>
<a href="#l3.2509"></a><span id="l3.2509">         maxProgress += this.mFeeds[index].maxProgress;</span>
<a href="#l3.2510"></a><span id="l3.2510">       }</span>
<a href="#l3.2511"></a><span id="l3.2511"> </span>
<a href="#l3.2512"></a><span id="l3.2512">       // If we start seeing weird &quot;jumping&quot; behavior where the progress bar</span>
<a href="#l3.2513"></a><span id="l3.2513">       // goes below a threshold then above it again, then we can factor a</span>
<a href="#l3.2514"></a><span id="l3.2514">       // fudge factor here based on the number of feeds that have not reported</span>
<a href="#l3.2515"></a><span id="l3.2515">       // yet and the avg progress we've already received for existing feeds.</span>
<a href="#l3.2516"></a><span id="l3.2516">       // Fortunately the progressmeter is on a timer and only updates every so</span>
<a href="#l3.2517"></a><span id="l3.2517">       // often.  For the most part all of our request have initial progress</span>
<a href="#l3.2518"></a><span id="l3.2518">       // before the UI actually picks up a progress value.</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineminus">-      if (this.mStatusFeedback)</span>
<a href="#l3.2520"></a><span id="l3.2520" class="difflineminus">-      {</span>
<a href="#l3.2521"></a><span id="l3.2521" class="difflineplus">+      if (this.mStatusFeedback) {</span>
<a href="#l3.2522"></a><span id="l3.2522">         let progress = (currentProgress * 100) / maxProgress;</span>
<a href="#l3.2523"></a><span id="l3.2523">         this.mStatusFeedback.showProgress(progress);</span>
<a href="#l3.2524"></a><span id="l3.2524">       }</span>
<a href="#l3.2525"></a><span id="l3.2525" class="difflineminus">-    }</span>
<a href="#l3.2526"></a><span id="l3.2526" class="difflineminus">-  }</span>
<a href="#l3.2527"></a><span id="l3.2527" class="difflineplus">+    },</span>
<a href="#l3.2528"></a><span id="l3.2528" class="difflineplus">+  },</span>
<a href="#l3.2529"></a><span id="l3.2529"> };</span>
<a href="#l3.2530"></a><span id="l3.2530"> </span>
<a href="#l3.2531"></a><span id="l3.2531"> XPCOMUtils.defineLazyGetter(FeedUtils, &quot;log&quot;, function() {</span>
<a href="#l3.2532"></a><span id="l3.2532">   return Log4Moz.getConfiguredLogger(&quot;Feeds&quot;);</span>
<a href="#l3.2533"></a><span id="l3.2533"> });</span>
<a href="#l3.2534"></a><span id="l3.2534"> </span>
<a href="#l3.2535"></a><span id="l3.2535"> XPCOMUtils.defineLazyGetter(FeedUtils, &quot;strings&quot;, function() {</span>
<a href="#l3.2536"></a><span id="l3.2536">   return Services.strings.createBundle(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/am-newsblog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/am-newsblog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,27 +3,27 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> ChromeUtils.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var gServer, gUpdateEnabled, gUpdateValue, gBiffUnits,</span>
<a href="#l4.10"></a><span id="l4.10">     gAutotagEnable, gAutotagUsePrefix, gAutotagPrefix;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l4.15"></a><span id="l4.15">   var accountName = document.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   var title = document.getElementById(&quot;am-newsblog-title&quot;);</span>
<a href="#l4.17"></a><span id="l4.17">   var defaultTitle = title.getAttribute(&quot;defaultTitle&quot;);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   var titleValue;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  if (accountName.value)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  if (accountName.value) {</span>
<a href="#l4.22"></a><span id="l4.22">     titleValue = defaultTitle + &quot; - &lt;&quot; + accountName.value + &quot;&gt;&quot;;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  else</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  } else {</span>
<a href="#l4.25"></a><span id="l4.25">     titleValue = defaultTitle;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">   title.setAttribute(&quot;title&quot;, titleValue);</span>
<a href="#l4.29"></a><span id="l4.29">   document.title = titleValue;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   let optionsAcct = FeedUtils.getOptionsAcct(gServer);</span>
<a href="#l4.32"></a><span id="l4.32">   document.getElementById(&quot;doBiff&quot;).checked = optionsAcct.doBiff;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   gUpdateEnabled = document.getElementById(&quot;updateEnabled&quot;);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineat">@@ -43,23 +43,21 @@ function onInit(aPageId, aServerId)</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   gAutotagEnable.checked = optionsAcct.category.enabled;</span>
<a href="#l4.38"></a><span id="l4.38">   gAutotagUsePrefix.disabled = !gAutotagEnable.checked;</span>
<a href="#l4.39"></a><span id="l4.39">   gAutotagUsePrefix.checked = optionsAcct.category.prefixEnabled;</span>
<a href="#l4.40"></a><span id="l4.40">   gAutotagPrefix.disabled = gAutotagUsePrefix.disabled || !gAutotagUsePrefix.checked;</span>
<a href="#l4.41"></a><span id="l4.41">   gAutotagPrefix.value = optionsAcct.category.prefix;</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-{</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l4.47"></a><span id="l4.47">   gServer = account.incomingServer;</span>
<a href="#l4.48"></a><span id="l4.48"> }</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-function setPrefs(aNode)</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-{</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+function setPrefs(aNode) {</span>
<a href="#l4.53"></a><span id="l4.53">   let optionsAcct =  FeedUtils.getOptionsAcct(gServer);</span>
<a href="#l4.54"></a><span id="l4.54">   switch (aNode.id) {</span>
<a href="#l4.55"></a><span id="l4.55">     case &quot;doBiff&quot;:</span>
<a href="#l4.56"></a><span id="l4.56">       FeedUtils.pauseFeedFolderUpdates(gServer.rootFolder, !aNode.checked, true);</span>
<a href="#l4.57"></a><span id="l4.57">       break;</span>
<a href="#l4.58"></a><span id="l4.58">     case &quot;updateEnabled&quot;:</span>
<a href="#l4.59"></a><span id="l4.59">     case &quot;updateValue&quot;:</span>
<a href="#l4.60"></a><span id="l4.60">     case &quot;biffUnits&quot;:</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineat">@@ -80,10 +78,10 @@ function setPrefs(aNode)</span>
<a href="#l4.62"></a><span id="l4.62">       optionsAcct.category.prefixEnabled = aNode.checked;</span>
<a href="#l4.63"></a><span id="l4.63">       gAutotagPrefix.disabled = aNode.disabled || !aNode.checked;</span>
<a href="#l4.64"></a><span id="l4.64">       break;</span>
<a href="#l4.65"></a><span id="l4.65">     case &quot;autotagPrefix&quot;:</span>
<a href="#l4.66"></a><span id="l4.66">       optionsAcct.category.prefix = aNode.value;</span>
<a href="#l4.67"></a><span id="l4.67">       break;</span>
<a href="#l4.68"></a><span id="l4.68">   }</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  FeedUtils.setOptionsAcct(gServer, optionsAcct)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  FeedUtils.setOptionsAcct(gServer, optionsAcct);</span>
<a href="#l4.72"></a><span id="l4.72"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,217 +3,209 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.5"></a><span id="l5.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> Cu.importGlobalProperties([&quot;XMLSerializer&quot;]);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> /**</span>
<a href="#l5.10"></a><span id="l5.10">  * The feed parser. Depends on FeedItem.js, Feed.js.</span>
<a href="#l5.11"></a><span id="l5.11">  *</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * @return Array - array of items, or empty array for error returns or nothing</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">- *                 to do condition.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * @constructor</span>
<a href="#l5.15"></a><span id="l5.15">  */</span>
<a href="#l5.16"></a><span id="l5.16"> function FeedParser() {</span>
<a href="#l5.17"></a><span id="l5.17">   this.parsedItems = [];</span>
<a href="#l5.18"></a><span id="l5.18">   this.mSerializer = new XMLSerializer();</span>
<a href="#l5.19"></a><span id="l5.19"> }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-FeedParser.prototype =</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-{</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-  // parseFeed() returns an array of parsed items ready for processing.  It is</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  // currently a synchronous operation.  If there is an error parsing the feed,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  // parseFeed returns an empty feed in addition to calling aFeed.onParseError.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  parseFeed: function (aFeed, aDOM)</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    if (ChromeUtils.getClassName(aDOM) !== &quot;XMLDocument&quot;)</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-    {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+FeedParser.prototype = {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  /**</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+   * parseFeed() returns an array of parsed items ready for processing. It is</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   * currently a synchronous operation.  If there is an error parsing the feed,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   * parseFeed returns an empty feed in addition to calling aFeed.onParseError.</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   *</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   * @param {Feed} aFeed         - The Feed object.</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * @param {XMLDocument} aDOM   - The document to parse.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   * @returns {Array} - array of items, or empty array for error returns or</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   *                    nothing to do condition.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   */</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  parseFeed(aFeed, aDOM) {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    if (ChromeUtils.getClassName(aDOM) !== &quot;XMLDocument&quot;) {</span>
<a href="#l5.43"></a><span id="l5.43">       // No xml doc.</span>
<a href="#l5.44"></a><span id="l5.44">       aFeed.onParseError(aFeed);</span>
<a href="#l5.45"></a><span id="l5.45">       return [];</span>
<a href="#l5.46"></a><span id="l5.46">     }</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">     let doc = aDOM.documentElement;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    if (doc.namespaceURI == FeedUtils.MOZ_PARSERERROR_NS)</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    if (doc.namespaceURI == FeedUtils.MOZ_PARSERERROR_NS) {</span>
<a href="#l5.52"></a><span id="l5.52">       // Gecko caught a basic parsing error.</span>
<a href="#l5.53"></a><span id="l5.53">       let errStr = doc.firstChild.textContent + &quot;\n&quot; +</span>
<a href="#l5.54"></a><span id="l5.54">                    doc.firstElementChild.textContent;</span>
<a href="#l5.55"></a><span id="l5.55">       FeedUtils.log.info(&quot;FeedParser.parseFeed: - &quot; + errStr);</span>
<a href="#l5.56"></a><span id="l5.56">       aFeed.onParseError(aFeed);</span>
<a href="#l5.57"></a><span id="l5.57">       return [];</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    }</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    else if (aDOM.querySelector(&quot;redirect&quot;))</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    } else if (aDOM.querySelector(&quot;redirect&quot;)) {</span>
<a href="#l5.62"></a><span id="l5.62">       // Check for RSS2.0 redirect document.</span>
<a href="#l5.63"></a><span id="l5.63">       let channel = aDOM.querySelector(&quot;redirect&quot;);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-      if (this.isPermanentRedirect(aFeed, channel, null, null))</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      if (this.isPermanentRedirect(aFeed, channel, null, null)) {</span>
<a href="#l5.66"></a><span id="l5.66">         return [];</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">       aFeed.onParseError(aFeed);</span>
<a href="#l5.70"></a><span id="l5.70">       return [];</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    }</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    else if (doc.namespaceURI == FeedUtils.RDF_SYNTAX_NS &amp;&amp;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-             doc.getElementsByTagNameNS(FeedUtils.RSS_NS, &quot;channel&quot;)[0])</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-    {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      aFeed.mFeedType = &quot;RSS_1.xRDF&quot;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+    } else if (doc.namespaceURI == FeedUtils.RDF_SYNTAX_NS &amp;&amp;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+               doc.getElementsByTagNameNS(FeedUtils.RSS_NS, &quot;channel&quot;)[0]) {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_1.xRDF&quot;;</span>
<a href="#l5.79"></a><span id="l5.79">       FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+                          aFeed.mFeedType + &quot; : &quot; + aFeed.url);</span>
<a href="#l5.82"></a><span id="l5.82">       // aSource can be misencoded (XMLHttpRequest converts to UTF-8 by default),</span>
<a href="#l5.83"></a><span id="l5.83">       // but the DOM is almost always right because it uses the hints in the</span>
<a href="#l5.84"></a><span id="l5.84">       // XML file.  This is slower, but not noticeably so.  Mozilla doesn't have</span>
<a href="#l5.85"></a><span id="l5.85">       // the XMLHttpRequest.responseBody property that IE has, which provides</span>
<a href="#l5.86"></a><span id="l5.86">       // access to the unencoded response.</span>
<a href="#l5.87"></a><span id="l5.87">       let xmlString = this.mSerializer.serializeToString(doc);</span>
<a href="#l5.88"></a><span id="l5.88">       return this.parseAsRSS1(aFeed, xmlString, aFeed.request.channel.URI);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    }</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-    else if (doc.namespaceURI == FeedUtils.ATOM_03_NS)</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    {</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-      aFeed.mFeedType = &quot;ATOM_0.3&quot;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    } else if (doc.namespaceURI == FeedUtils.ATOM_03_NS) {</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+      aFeed.mFeedType = &quot;ATOM_0.3&quot;;</span>
<a href="#l5.95"></a><span id="l5.95">       FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+                          aFeed.mFeedType + &quot; : &quot; + aFeed.url);</span>
<a href="#l5.98"></a><span id="l5.98">       return this.parseAsAtom(aFeed, aDOM);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-    }</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-    else if (doc.namespaceURI == FeedUtils.ATOM_IETF_NS)</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-    {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-      aFeed.mFeedType = &quot;ATOM_IETF&quot;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    } else if (doc.namespaceURI == FeedUtils.ATOM_IETF_NS) {</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+      aFeed.mFeedType = &quot;ATOM_IETF&quot;;</span>
<a href="#l5.105"></a><span id="l5.105">       FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+                          aFeed.mFeedType + &quot; : &quot; + aFeed.url);</span>
<a href="#l5.108"></a><span id="l5.108">       return this.parseAsAtomIETF(aFeed, aDOM);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-    }</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-    else if (doc.getElementsByTagNameNS(FeedUtils.RSS_090_NS, &quot;channel&quot;)[0])</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-    {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-      aFeed.mFeedType = &quot;RSS_0.90&quot;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    } else if (doc.getElementsByTagNameNS(FeedUtils.RSS_090_NS, &quot;channel&quot;)[0]) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_0.90&quot;;</span>
<a href="#l5.115"></a><span id="l5.115">       FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+                          aFeed.mFeedType + &quot; : &quot; + aFeed.url);</span>
<a href="#l5.118"></a><span id="l5.118">       return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l5.119"></a><span id="l5.119">     }</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    else</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-    {</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-      // Parse as RSS 0.9x.  In theory even RSS 1.0 feeds could be parsed by</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-      // the 0.9x parser if the RSS namespace were the default.</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-      let rssVer = doc.localName == &quot;rss&quot; ? doc.getAttribute(&quot;version&quot;) : null;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-      if (rssVer)</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-        aFeed.mFeedType = &quot;RSS_&quot; + rssVer;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-      else</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-        aFeed.mFeedType = &quot;RSS_0.9x?&quot;;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-      return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+    // Parse as RSS 0.9x.  In theory even RSS 1.0 feeds could be parsed by</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    // the 0.9x parser if the RSS namespace were the default.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    let rssVer = doc.localName == &quot;rss&quot; ? doc.getAttribute(&quot;version&quot;) : null;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    if (rssVer) {</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_&quot; + rssVer;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    } else {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_0.9x?&quot;;</span>
<a href="#l5.140"></a><span id="l5.140">     }</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+                        aFeed.mFeedType + &quot; : &quot; + aFeed.url);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l5.144"></a><span id="l5.144">   },</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-  parseAsRSS2: function (aFeed, aDOM)</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-  {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+  parseAsRSS2(aFeed, aDOM) {</span>
<a href="#l5.149"></a><span id="l5.149">     // Get the first channel (assuming there is only one per RSS File).</span>
<a href="#l5.150"></a><span id="l5.150">     let channel = aDOM.querySelector(&quot;channel&quot;);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-    if (!channel)</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-    {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+    if (!channel) {</span>
<a href="#l5.154"></a><span id="l5.154">       aFeed.onParseError(aFeed);</span>
<a href="#l5.155"></a><span id="l5.155">       return [];</span>
<a href="#l5.156"></a><span id="l5.156">     }</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158">     // Usually the empty string, unless this is RSS .90.</span>
<a href="#l5.159"></a><span id="l5.159">     let nsURI = channel.namespaceURI || &quot;&quot;;</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-    if (this.isPermanentRedirect(aFeed, null, channel, null))</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+    if (this.isPermanentRedirect(aFeed, null, channel, null)) {</span>
<a href="#l5.163"></a><span id="l5.163">       return [];</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+    }</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166">     let tags = this.childrenByTagNameNS(channel, nsURI, &quot;title&quot;);</span>
<a href="#l5.167"></a><span id="l5.167">     aFeed.title = aFeed.title || this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.168"></a><span id="l5.168">     tags = this.childrenByTagNameNS(channel, nsURI, &quot;description&quot;);</span>
<a href="#l5.169"></a><span id="l5.169">     aFeed.description = this.getNodeValueFormatted(tags ? tags[0] : null);</span>
<a href="#l5.170"></a><span id="l5.170">     tags = this.childrenByTagNameNS(channel, nsURI, &quot;link&quot;);</span>
<a href="#l5.171"></a><span id="l5.171">     aFeed.link = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.172"></a><span id="l5.172"> </span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-    if (!(aFeed.title || aFeed.description) || !aFeed.link)</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    {</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+    if (!(aFeed.title || aFeed.description) || !aFeed.link) {</span>
<a href="#l5.176"></a><span id="l5.176">       FeedUtils.log.error(&quot;FeedParser.parseAsRSS2: missing mandatory element &quot; +</span>
<a href="#l5.177"></a><span id="l5.177">                           &quot;&lt;title&gt; and &lt;description&gt;, or &lt;link&gt;&quot;);</span>
<a href="#l5.178"></a><span id="l5.178">       aFeed.onParseError(aFeed);</span>
<a href="#l5.179"></a><span id="l5.179">       return [];</span>
<a href="#l5.180"></a><span id="l5.180">     }</span>
<a href="#l5.181"></a><span id="l5.181"> </span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-    if (!aFeed.parseItems)</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+    if (!aFeed.parseItems) {</span>
<a href="#l5.184"></a><span id="l5.184">       return [];</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+    }</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187">     this.findSyUpdateTags(aFeed, channel);</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189">     aFeed.invalidateItems();</span>
<a href="#l5.190"></a><span id="l5.190">     // XXX use getElementsByTagNameNS for now; childrenByTagNameNS would be</span>
<a href="#l5.191"></a><span id="l5.191">     // better, but RSS .90 is still with us.</span>
<a href="#l5.192"></a><span id="l5.192">     let itemNodes = aDOM.getElementsByTagNameNS(nsURI, &quot;item&quot;);</span>
<a href="#l5.193"></a><span id="l5.193">     itemNodes = itemNodes ? itemNodes : [];</span>
<a href="#l5.194"></a><span id="l5.194">     FeedUtils.log.debug(&quot;FeedParser.parseAsRSS2: items to parse - &quot; +</span>
<a href="#l5.195"></a><span id="l5.195">                         itemNodes.length);</span>
<a href="#l5.196"></a><span id="l5.196"> </span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-    for (let itemNode of itemNodes)</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-    {</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-      if (!itemNode.childElementCount)</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+    for (let itemNode of itemNodes) {</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+      if (!itemNode.childElementCount) {</span>
<a href="#l5.202"></a><span id="l5.202">         continue;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+      }</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">       let item = new FeedItem();</span>
<a href="#l5.206"></a><span id="l5.206">       item.feed = aFeed;</span>
<a href="#l5.207"></a><span id="l5.207">       item.enclosures = [];</span>
<a href="#l5.208"></a><span id="l5.208">       item.keywords = [];</span>
<a href="#l5.209"></a><span id="l5.209"> </span>
<a href="#l5.210"></a><span id="l5.210">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.FEEDBURNER_NS, &quot;origLink&quot;);</span>
<a href="#l5.211"></a><span id="l5.211">       let link = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-      if (!link)</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-      {</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+      if (!link) {</span>
<a href="#l5.215"></a><span id="l5.215">         tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;link&quot;);</span>
<a href="#l5.216"></a><span id="l5.216">         link = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.217"></a><span id="l5.217">       }</span>
<a href="#l5.218"></a><span id="l5.218">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;guid&quot;);</span>
<a href="#l5.219"></a><span id="l5.219">       let guidNode = tags ? tags[0] : null;</span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221">       let guid;</span>
<a href="#l5.222"></a><span id="l5.222">       let isPermaLink = false;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-      if (guidNode)</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-      {</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+      if (guidNode) {</span>
<a href="#l5.226"></a><span id="l5.226">         guid = this.getNodeValue(guidNode);</span>
<a href="#l5.227"></a><span id="l5.227">         // isPermaLink is true if the value is &quot;true&quot; or if the attribute is</span>
<a href="#l5.228"></a><span id="l5.228">         // not present; all other values, including &quot;false&quot; and &quot;False&quot; and</span>
<a href="#l5.229"></a><span id="l5.229">         // for that matter &quot;TRuE&quot; and &quot;meatcake&quot; are false.</span>
<a href="#l5.230"></a><span id="l5.230">         if (!guidNode.hasAttribute(&quot;isPermaLink&quot;) ||</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-            guidNode.getAttribute(&quot;isPermaLink&quot;) == &quot;true&quot;)</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+            guidNode.getAttribute(&quot;isPermaLink&quot;) == &quot;true&quot;) {</span>
<a href="#l5.233"></a><span id="l5.233">           isPermaLink = true;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+        }</span>
<a href="#l5.235"></a><span id="l5.235">         // If attribute isPermaLink is missing, it is good to check the validity</span>
<a href="#l5.236"></a><span id="l5.236">         // of &lt;guid&gt; value as an URL to avoid linking to non-URL strings.</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-        if (!guidNode.hasAttribute(&quot;isPermaLink&quot;))</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-        {</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-          try</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-          {</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+        if (!guidNode.hasAttribute(&quot;isPermaLink&quot;)) {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+          try {</span>
<a href="#l5.243"></a><span id="l5.243">             Services.io.newURI(guid);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-            if (Services.io.extractScheme(guid) == &quot;tag&quot;)</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+            if (Services.io.extractScheme(guid) == &quot;tag&quot;) {</span>
<a href="#l5.246"></a><span id="l5.246">               isPermaLink = false;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-          }</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-          catch (ex)</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-          {</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+            }</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+          } catch (ex) {</span>
<a href="#l5.252"></a><span id="l5.252">             isPermaLink = false;</span>
<a href="#l5.253"></a><span id="l5.253">           }</span>
<a href="#l5.254"></a><span id="l5.254">         }</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256">         item.id = guid;</span>
<a href="#l5.257"></a><span id="l5.257">       }</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">       let guidLink = this.validLink(guid);</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-      item.url = isPermaLink &amp;&amp; guidLink ? guidLink : link ? link : null;</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+      if (isPermaLink &amp;&amp; guidLink) {</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+        item.url = guidLink;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+      } else if (link) {</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+        item.url = link;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+      } else {</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+        item.url = null;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+      }</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+</span>
<a href="#l5.269"></a><span id="l5.269">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;description&quot;);</span>
<a href="#l5.270"></a><span id="l5.270">       item.description = this.getNodeValueFormatted(tags ? tags[0] : null);</span>
<a href="#l5.271"></a><span id="l5.271">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;title&quot;);</span>
<a href="#l5.272"></a><span id="l5.272">       item.title = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-      if (!(item.title || item.description))</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-      {</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+      if (!(item.title || item.description)) {</span>
<a href="#l5.276"></a><span id="l5.276">         FeedUtils.log.info(&quot;FeedParser.parseAsRSS2: &lt;item&gt; missing mandatory &quot; +</span>
<a href="#l5.277"></a><span id="l5.277">                            &quot;element, either &lt;title&gt; or &lt;description&gt;; skipping&quot;);</span>
<a href="#l5.278"></a><span id="l5.278">         continue;</span>
<a href="#l5.279"></a><span id="l5.279">       }</span>
<a href="#l5.280"></a><span id="l5.280"> </span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-      if (!item.id)</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-      {</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+      if (!item.id) {</span>
<a href="#l5.284"></a><span id="l5.284">         // At this point, if there is no guid, uniqueness cannot be guaranteed</span>
<a href="#l5.285"></a><span id="l5.285">         // by any of link or date (optional) or title (optional unless there</span>
<a href="#l5.286"></a><span id="l5.286">         // is no description). Use a big chunk of description; minimize dupes</span>
<a href="#l5.287"></a><span id="l5.287">         // with url and title if present.</span>
<a href="#l5.288"></a><span id="l5.288">         item.id = (item.url || item.feed.url) + &quot;#&quot; + item.title + &quot;#&quot; +</span>
<a href="#l5.289"></a><span id="l5.289">                   (this.stripTags(item.description ?</span>
<a href="#l5.290"></a><span id="l5.290">                                     item.description.substr(0, 150) : null) ||</span>
<a href="#l5.291"></a><span id="l5.291">                    item.title);</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineat">@@ -223,182 +215,177 @@ FeedParser.prototype =</span>
<a href="#l5.293"></a><span id="l5.293">       // Escape html entities in &lt;title&gt;, which are unescaped as textContent</span>
<a href="#l5.294"></a><span id="l5.294">       // values. If the title is used as content, it will remain escaped; if</span>
<a href="#l5.295"></a><span id="l5.295">       // it is used as the title, it will be unescaped upon store. Bug 1240603.</span>
<a href="#l5.296"></a><span id="l5.296">       // The &lt;description&gt; tag must follow escaping examples found in</span>
<a href="#l5.297"></a><span id="l5.297">       // http://www.rssboard.org/rss-encoding-examples, i.e. single escape angle</span>
<a href="#l5.298"></a><span id="l5.298">       // brackets for tags, which are removed if used as title, and double</span>
<a href="#l5.299"></a><span id="l5.299">       // escape entities for presentation in title.</span>
<a href="#l5.300"></a><span id="l5.300">       // Better: always use &lt;title&gt;. Best: use Atom.</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-      if (!item.title)</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+      if (!item.title) {</span>
<a href="#l5.303"></a><span id="l5.303">         item.title = this.stripTags(item.description).substr(0, 150);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-      else</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+      } else {</span>
<a href="#l5.306"></a><span id="l5.306">         item.title = item.htmlEscape(item.title);</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+      }</span>
<a href="#l5.308"></a><span id="l5.308"> </span>
<a href="#l5.309"></a><span id="l5.309">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;author&quot;);</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-      if (!tags)</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+      if (!tags) {</span>
<a href="#l5.312"></a><span id="l5.312">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.DC_NS, &quot;creator&quot;);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+      }</span>
<a href="#l5.314"></a><span id="l5.314">       item.author = this.getNodeValue(tags ? tags[0] : null) ||</span>
<a href="#l5.315"></a><span id="l5.315">                     aFeed.title ||</span>
<a href="#l5.316"></a><span id="l5.316">                     item.author;</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;pubDate&quot;);</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.321"></a><span id="l5.321">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.DC_NS, &quot;date&quot;);</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+      }</span>
<a href="#l5.323"></a><span id="l5.323">       item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.324"></a><span id="l5.324"> </span>
<a href="#l5.325"></a><span id="l5.325">       // If the date is invalid, users will see the beginning of the epoch</span>
<a href="#l5.326"></a><span id="l5.326">       // unless we reset it here, so they'll see the current time instead.</span>
<a href="#l5.327"></a><span id="l5.327">       // This is typical aggregator behavior.</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-      if (item.date)</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-      {</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+      if (item.date) {</span>
<a href="#l5.331"></a><span id="l5.331">         item.date = item.date.trim();</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-        if (!FeedUtils.isValidRFC822Date(item.date))</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-        {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+        if (!FeedUtils.isValidRFC822Date(item.date)) {</span>
<a href="#l5.335"></a><span id="l5.335">           // XXX Use this on the other formats as well.</span>
<a href="#l5.336"></a><span id="l5.336">           item.date = this.dateRescue(item.date);</span>
<a href="#l5.337"></a><span id="l5.337">         }</span>
<a href="#l5.338"></a><span id="l5.338">       }</span>
<a href="#l5.339"></a><span id="l5.339"> </span>
<a href="#l5.340"></a><span id="l5.340">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.RSS_CONTENT_NS, &quot;encoded&quot;);</span>
<a href="#l5.341"></a><span id="l5.341">       item.content = this.getNodeValueFormatted(tags ? tags[0] : null);</span>
<a href="#l5.342"></a><span id="l5.342"> </span>
<a href="#l5.343"></a><span id="l5.343">       // Handle &lt;enclosures&gt; and &lt;media:content&gt;, which may be in a</span>
<a href="#l5.344"></a><span id="l5.344">       // &lt;media:group&gt; (if present).</span>
<a href="#l5.345"></a><span id="l5.345">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;enclosure&quot;);</span>
<a href="#l5.346"></a><span id="l5.346">       let encUrls = [];</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-      if (tags)</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-        {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+      if (tags) {</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.352"></a><span id="l5.352">           let url = this.validLink(tag.getAttribute(&quot;url&quot;));</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-          if (url &amp;&amp; !encUrls.includes(url))</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-          {</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+          if (url &amp;&amp; !encUrls.includes(url)) {</span>
<a href="#l5.356"></a><span id="l5.356">             let type = this.removeUnprintableASCII(tag.getAttribute(&quot;type&quot;));</span>
<a href="#l5.357"></a><span id="l5.357">             let length = this.removeUnprintableASCII(tag.getAttribute(&quot;length&quot;));</span>
<a href="#l5.358"></a><span id="l5.358">             item.enclosures.push(new FeedEnclosure(url, type, length));</span>
<a href="#l5.359"></a><span id="l5.359">             encUrls.push(url);</span>
<a href="#l5.360"></a><span id="l5.360">           }</span>
<a href="#l5.361"></a><span id="l5.361">         }</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+      }</span>
<a href="#l5.363"></a><span id="l5.363"> </span>
<a href="#l5.364"></a><span id="l5.364">       tags = itemNode.getElementsByTagNameNS(FeedUtils.MRSS_NS, &quot;content&quot;);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-      if (tags)</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-        {</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+      if (tags) {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.370"></a><span id="l5.370">           let url = this.validLink(tag.getAttribute(&quot;url&quot;));</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-          if (url &amp;&amp; !encUrls.includes(url))</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-          {</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+          if (url &amp;&amp; !encUrls.includes(url)) {</span>
<a href="#l5.374"></a><span id="l5.374">             let type = this.removeUnprintableASCII(tag.getAttribute(&quot;type&quot;));</span>
<a href="#l5.375"></a><span id="l5.375">             let fileSize = this.removeUnprintableASCII(tag.getAttribute(&quot;fileSize&quot;));</span>
<a href="#l5.376"></a><span id="l5.376">             item.enclosures.push(new FeedEnclosure(url, type, fileSize));</span>
<a href="#l5.377"></a><span id="l5.377">           }</span>
<a href="#l5.378"></a><span id="l5.378">         }</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+      }</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381">       // The &lt;origEnclosureLink&gt; tag has no specification, especially regarding</span>
<a href="#l5.382"></a><span id="l5.382">       // whether more than one tag is allowed and, if so, how tags would</span>
<a href="#l5.383"></a><span id="l5.383">       // relate to previously declared (and well specified) enclosure urls.</span>
<a href="#l5.384"></a><span id="l5.384">       // The common usage is to include 1 origEnclosureLink, in addition to</span>
<a href="#l5.385"></a><span id="l5.385">       // the specified enclosure tags for 1 enclosure. Thus, we will replace the</span>
<a href="#l5.386"></a><span id="l5.386">       // first enclosure's, if found, url with the first &lt;origEnclosureLink&gt;</span>
<a href="#l5.387"></a><span id="l5.387">       // url only or else add the &lt;origEnclosureLink&gt; url.</span>
<a href="#l5.388"></a><span id="l5.388">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.FEEDBURNER_NS, &quot;origEnclosureLink&quot;);</span>
<a href="#l5.389"></a><span id="l5.389">       let origEncUrl = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-      if (origEncUrl)</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-      {</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-        if (item.enclosures.length)</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+      if (origEncUrl) {</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+        if (item.enclosures.length) {</span>
<a href="#l5.395"></a><span id="l5.395">           item.enclosures[0].mURL = origEncUrl;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-        else</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+        } else {</span>
<a href="#l5.398"></a><span id="l5.398">           item.enclosures.push(new FeedEnclosure(origEncUrl));</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+        }</span>
<a href="#l5.400"></a><span id="l5.400">       }</span>
<a href="#l5.401"></a><span id="l5.401"> </span>
<a href="#l5.402"></a><span id="l5.402">       // Support &lt;category&gt; and autotagging.</span>
<a href="#l5.403"></a><span id="l5.403">       tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;category&quot;);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-      if (tags)</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-      {</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-        {</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+      if (tags) {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.410"></a><span id="l5.410">           let term = this.getNodeValue(tag);</span>
<a href="#l5.411"></a><span id="l5.411">           term = term ? this.xmlUnescape(term.replace(/,/g, &quot;;&quot;)) : null;</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-          if (term &amp;&amp; !item.keywords.includes(term))</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+          if (term &amp;&amp; !item.keywords.includes(term)) {</span>
<a href="#l5.414"></a><span id="l5.414">             item.keywords.push(term);</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+          }</span>
<a href="#l5.416"></a><span id="l5.416">         }</span>
<a href="#l5.417"></a><span id="l5.417">       }</span>
<a href="#l5.418"></a><span id="l5.418"> </span>
<a href="#l5.419"></a><span id="l5.419">       this.parsedItems.push(item);</span>
<a href="#l5.420"></a><span id="l5.420">     }</span>
<a href="#l5.421"></a><span id="l5.421"> </span>
<a href="#l5.422"></a><span id="l5.422">     return this.parsedItems;</span>
<a href="#l5.423"></a><span id="l5.423">   },</span>
<a href="#l5.424"></a><span id="l5.424"> </span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-  parseAsRSS1 : function(aFeed, aSource, aBaseURI)</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-  {</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  parseAsRSS1(aFeed, aSource, aBaseURI) {</span>
<a href="#l5.428"></a><span id="l5.428">     // RSS 1.0 is valid RDF, so use the RDF parser/service to extract data.</span>
<a href="#l5.429"></a><span id="l5.429">     // Create a new RDF data source and parse the feed into it.</span>
<a href="#l5.430"></a><span id="l5.430">     let ds = Cc[&quot;@mozilla.org/rdf/datasource;1?name=in-memory-datasource&quot;].</span>
<a href="#l5.431"></a><span id="l5.431">              createInstance(Ci.nsIRDFDataSource);</span>
<a href="#l5.432"></a><span id="l5.432"> </span>
<a href="#l5.433"></a><span id="l5.433">     let rdfparser = Cc[&quot;@mozilla.org/rdf/xml-parser;1&quot;].</span>
<a href="#l5.434"></a><span id="l5.434">                     createInstance(Ci.nsIRDFXMLParser);</span>
<a href="#l5.435"></a><span id="l5.435">     rdfparser.parseString(ds, aBaseURI, aSource);</span>
<a href="#l5.436"></a><span id="l5.436"> </span>
<a href="#l5.437"></a><span id="l5.437">     // Get information about the feed as a whole.</span>
<a href="#l5.438"></a><span id="l5.438">     let channel = ds.GetSource(FeedUtils.RDF_TYPE, FeedUtils.RSS_CHANNEL, true);</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-    if (!channel)</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-    {</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+    if (!channel) {</span>
<a href="#l5.442"></a><span id="l5.442">       aFeed.onParseError(aFeed);</span>
<a href="#l5.443"></a><span id="l5.443">       return [];</span>
<a href="#l5.444"></a><span id="l5.444">     }</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-    if (this.isPermanentRedirect(aFeed, null, channel, ds))</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+    if (this.isPermanentRedirect(aFeed, null, channel, ds)) {</span>
<a href="#l5.448"></a><span id="l5.448">       return [];</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+    }</span>
<a href="#l5.450"></a><span id="l5.450"> </span>
<a href="#l5.451"></a><span id="l5.451">     aFeed.title = aFeed.title ||</span>
<a href="#l5.452"></a><span id="l5.452">                   this.getRDFTargetValue(ds, channel, FeedUtils.RSS_TITLE) ||</span>
<a href="#l5.453"></a><span id="l5.453">                   aFeed.url;</span>
<a href="#l5.454"></a><span id="l5.454">     aFeed.description = this.getRDFTargetValueFormatted(ds, channel, FeedUtils.RSS_DESCRIPTION) ||</span>
<a href="#l5.455"></a><span id="l5.455">                         &quot;&quot;;</span>
<a href="#l5.456"></a><span id="l5.456">     aFeed.link = this.validLink(this.getRDFTargetValue(ds, channel, FeedUtils.RSS_LINK)) ||</span>
<a href="#l5.457"></a><span id="l5.457">                  aFeed.url;</span>
<a href="#l5.458"></a><span id="l5.458"> </span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-    if (!(aFeed.title || aFeed.description) || !aFeed.link)</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-    {</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+    if (!(aFeed.title || aFeed.description) || !aFeed.link) {</span>
<a href="#l5.462"></a><span id="l5.462">       FeedUtils.log.error(&quot;FeedParser.parseAsRSS1: missing mandatory element &quot; +</span>
<a href="#l5.463"></a><span id="l5.463">                           &quot;&lt;title&gt; and &lt;description&gt;, or &lt;link&gt;&quot;);</span>
<a href="#l5.464"></a><span id="l5.464">       aFeed.onParseError(aFeed);</span>
<a href="#l5.465"></a><span id="l5.465">       return [];</span>
<a href="#l5.466"></a><span id="l5.466">     }</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-    if (!aFeed.parseItems)</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+    if (!aFeed.parseItems) {</span>
<a href="#l5.470"></a><span id="l5.470">       return [];</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+    }</span>
<a href="#l5.472"></a><span id="l5.472"> </span>
<a href="#l5.473"></a><span id="l5.473">     this.findSyUpdateTags(aFeed, channel, ds);</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475">     aFeed.invalidateItems();</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477">     // Ignore the &lt;items&gt; list and just get the &lt;item&gt;s.</span>
<a href="#l5.478"></a><span id="l5.478">     let items = ds.GetSources(FeedUtils.RDF_TYPE, FeedUtils.RSS_ITEM, true);</span>
<a href="#l5.479"></a><span id="l5.479"> </span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-    while (items.hasMoreElements())</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-    {</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+    while (items.hasMoreElements()) {</span>
<a href="#l5.483"></a><span id="l5.483">       let itemResource = items.getNext().QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l5.484"></a><span id="l5.484">       let item = new FeedItem();</span>
<a href="#l5.485"></a><span id="l5.485">       item.feed = aFeed;</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487">       // Prefer the value of the link tag to the item URI since the URI could be</span>
<a href="#l5.488"></a><span id="l5.488">       // a relative URN.</span>
<a href="#l5.489"></a><span id="l5.489">       let uri = itemResource.ValueUTF8;</span>
<a href="#l5.490"></a><span id="l5.490">       let link = this.validLink(this.getRDFTargetValue(ds, itemResource, FeedUtils.RSS_LINK));</span>
<a href="#l5.491"></a><span id="l5.491">       item.url = link || uri;</span>
<a href="#l5.492"></a><span id="l5.492">       item.description = this.getRDFTargetValueFormatted(ds, itemResource,</span>
<a href="#l5.493"></a><span id="l5.493">                                                          FeedUtils.RSS_DESCRIPTION);</span>
<a href="#l5.494"></a><span id="l5.494">       item.title = this.getRDFTargetValue(ds, itemResource, FeedUtils.RSS_TITLE) ||</span>
<a href="#l5.495"></a><span id="l5.495">                    this.getRDFTargetValue(ds, itemResource, FeedUtils.DC_SUBJECT) ||</span>
<a href="#l5.496"></a><span id="l5.496">                    (item.description ?</span>
<a href="#l5.497"></a><span id="l5.497">                      (this.stripTags(item.description).substr(0, 150)) : null);</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-      if (!item.url || !item.title)</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-      {</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+      if (!item.url || !item.title) {</span>
<a href="#l5.501"></a><span id="l5.501">         FeedUtils.log.info(&quot;FeedParser.parseAsRSS1: &lt;item&gt; missing mandatory &quot; +</span>
<a href="#l5.502"></a><span id="l5.502">                            &quot;element &lt;item rdf:about&gt; and &lt;link&gt;, or &lt;title&gt; and &quot; +</span>
<a href="#l5.503"></a><span id="l5.503">                            &quot;no &lt;description&gt;; skipping&quot;);</span>
<a href="#l5.504"></a><span id="l5.504">         continue;</span>
<a href="#l5.505"></a><span id="l5.505">       }</span>
<a href="#l5.506"></a><span id="l5.506"> </span>
<a href="#l5.507"></a><span id="l5.507">       item.id = item.url;</span>
<a href="#l5.508"></a><span id="l5.508">       item.url = this.validLink(item.url);</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineat">@@ -416,741 +403,723 @@ FeedParser.prototype =</span>
<a href="#l5.510"></a><span id="l5.510">     }</span>
<a href="#l5.511"></a><span id="l5.511">     FeedUtils.log.debug(&quot;FeedParser.parseAsRSS1: items parsed - &quot; +</span>
<a href="#l5.512"></a><span id="l5.512">                         this.parsedItems.length);</span>
<a href="#l5.513"></a><span id="l5.513"> </span>
<a href="#l5.514"></a><span id="l5.514">     return this.parsedItems;</span>
<a href="#l5.515"></a><span id="l5.515">   },</span>
<a href="#l5.516"></a><span id="l5.516"> </span>
<a href="#l5.517"></a><span id="l5.517">   // TODO: deprecate ATOM_03_NS.</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-  parseAsAtom: function(aFeed, aDOM)</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-  {</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+  parseAsAtom(aFeed, aDOM) {</span>
<a href="#l5.521"></a><span id="l5.521">     // Get the first channel (assuming there is only one per Atom File).</span>
<a href="#l5.522"></a><span id="l5.522">     let channel = aDOM.querySelector(&quot;feed&quot;);</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-    if (!channel)</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-    {</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+    if (!channel) {</span>
<a href="#l5.526"></a><span id="l5.526">       aFeed.onParseError(aFeed);</span>
<a href="#l5.527"></a><span id="l5.527">       return [];</span>
<a href="#l5.528"></a><span id="l5.528">     }</span>
<a href="#l5.529"></a><span id="l5.529"> </span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-    if (this.isPermanentRedirect(aFeed, null, channel, null))</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+    if (this.isPermanentRedirect(aFeed, null, channel, null)) {</span>
<a href="#l5.532"></a><span id="l5.532">       return [];</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+    }</span>
<a href="#l5.534"></a><span id="l5.534"> </span>
<a href="#l5.535"></a><span id="l5.535">     let tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;title&quot;);</span>
<a href="#l5.536"></a><span id="l5.536">     aFeed.title = aFeed.title ||</span>
<a href="#l5.537"></a><span id="l5.537">                   this.stripTags(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.538"></a><span id="l5.538">     tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;tagline&quot;);</span>
<a href="#l5.539"></a><span id="l5.539">     aFeed.description = this.getNodeValueFormatted(tags ? tags[0] : null);</span>
<a href="#l5.540"></a><span id="l5.540">     tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;link&quot;);</span>
<a href="#l5.541"></a><span id="l5.541">     aFeed.link = this.validLink(this.findAtomLink(&quot;alternate&quot;, tags));</span>
<a href="#l5.542"></a><span id="l5.542"> </span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-    if (!aFeed.title)</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-    {</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+    if (!aFeed.title) {</span>
<a href="#l5.546"></a><span id="l5.546">       FeedUtils.log.error(&quot;FeedParser.parseAsAtom: missing mandatory element &quot; +</span>
<a href="#l5.547"></a><span id="l5.547">                           &quot;&lt;title&gt;&quot;);</span>
<a href="#l5.548"></a><span id="l5.548">       aFeed.onParseError(aFeed);</span>
<a href="#l5.549"></a><span id="l5.549">       return [];</span>
<a href="#l5.550"></a><span id="l5.550">     }</span>
<a href="#l5.551"></a><span id="l5.551"> </span>
<a href="#l5.552"></a><span id="l5.552" class="difflineminus">-    if (!aFeed.parseItems)</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+    if (!aFeed.parseItems) {</span>
<a href="#l5.554"></a><span id="l5.554">       return [];</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+    }</span>
<a href="#l5.556"></a><span id="l5.556"> </span>
<a href="#l5.557"></a><span id="l5.557">     this.findSyUpdateTags(aFeed, channel);</span>
<a href="#l5.558"></a><span id="l5.558"> </span>
<a href="#l5.559"></a><span id="l5.559">     aFeed.invalidateItems();</span>
<a href="#l5.560"></a><span id="l5.560">     let items = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;entry&quot;);</span>
<a href="#l5.561"></a><span id="l5.561">     items = items ? items : [];</span>
<a href="#l5.562"></a><span id="l5.562">     FeedUtils.log.debug(&quot;FeedParser.parseAsAtom: items to parse - &quot; +</span>
<a href="#l5.563"></a><span id="l5.563">                         items.length);</span>
<a href="#l5.564"></a><span id="l5.564"> </span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-    for (let itemNode of items)</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-    {</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineminus">-      if (!itemNode.childElementCount)</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+    for (let itemNode of items) {</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+      if (!itemNode.childElementCount) {</span>
<a href="#l5.570"></a><span id="l5.570">         continue;</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+      }</span>
<a href="#l5.572"></a><span id="l5.572"> </span>
<a href="#l5.573"></a><span id="l5.573">       let item = new FeedItem();</span>
<a href="#l5.574"></a><span id="l5.574">       item.feed = aFeed;</span>
<a href="#l5.575"></a><span id="l5.575"> </span>
<a href="#l5.576"></a><span id="l5.576">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;link&quot;);</span>
<a href="#l5.577"></a><span id="l5.577">       item.url = this.validLink(this.findAtomLink(&quot;alternate&quot;, tags));</span>
<a href="#l5.578"></a><span id="l5.578"> </span>
<a href="#l5.579"></a><span id="l5.579">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;id&quot;);</span>
<a href="#l5.580"></a><span id="l5.580">       item.id = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.581"></a><span id="l5.581">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;summary&quot;);</span>
<a href="#l5.582"></a><span id="l5.582">       item.description = this.getNodeValueFormatted(tags ? tags[0] : null);</span>
<a href="#l5.583"></a><span id="l5.583">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;title&quot;);</span>
<a href="#l5.584"></a><span id="l5.584">       item.title = this.getNodeValue(tags ? tags[0] : null) ||</span>
<a href="#l5.585"></a><span id="l5.585">                    (item.description ? item.description.substr(0, 150) : null);</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-      if (!item.title || !item.id)</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-      {</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+      if (!item.title || !item.id) {</span>
<a href="#l5.589"></a><span id="l5.589">         // We're lenient about other mandatory tags, but insist on these.</span>
<a href="#l5.590"></a><span id="l5.590">         FeedUtils.log.info(&quot;FeedParser.parseAsAtom: &lt;entry&gt; missing mandatory &quot; +</span>
<a href="#l5.591"></a><span id="l5.591">                            &quot;element &lt;id&gt;, or &lt;title&gt; and no &lt;summary&gt;; skipping&quot;);</span>
<a href="#l5.592"></a><span id="l5.592">         continue;</span>
<a href="#l5.593"></a><span id="l5.593">       }</span>
<a href="#l5.594"></a><span id="l5.594"> </span>
<a href="#l5.595"></a><span id="l5.595">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;author&quot;);</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineminus">-      if (!tags)</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+      if (!tags) {</span>
<a href="#l5.598"></a><span id="l5.598">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;contributor&quot;);</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-      if (!tags)</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+      }</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+      if (!tags) {</span>
<a href="#l5.602"></a><span id="l5.602">         tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;author&quot;);</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+      }</span>
<a href="#l5.604"></a><span id="l5.604"> </span>
<a href="#l5.605"></a><span id="l5.605">       let authorEl = tags ? tags[0] : null;</span>
<a href="#l5.606"></a><span id="l5.606"> </span>
<a href="#l5.607"></a><span id="l5.607">       let author = &quot;&quot;;</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-      if (authorEl)</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-      {</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+      if (authorEl) {</span>
<a href="#l5.611"></a><span id="l5.611">         tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_03_NS, &quot;name&quot;);</span>
<a href="#l5.612"></a><span id="l5.612">         let name = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.613"></a><span id="l5.613">         tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_03_NS, &quot;email&quot;);</span>
<a href="#l5.614"></a><span id="l5.614">         let email = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-        if (name)</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+        if (name) {</span>
<a href="#l5.617"></a><span id="l5.617">           author = name + (email ? &quot; &lt;&quot; + email + &quot;&gt;&quot; : &quot;&quot;);</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineminus">-        else if (email)</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+        } else if (email) {</span>
<a href="#l5.620"></a><span id="l5.620">           author = email;</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+        }</span>
<a href="#l5.622"></a><span id="l5.622">       }</span>
<a href="#l5.623"></a><span id="l5.623"> </span>
<a href="#l5.624"></a><span id="l5.624">       item.author = author || item.author || aFeed.title;</span>
<a href="#l5.625"></a><span id="l5.625"> </span>
<a href="#l5.626"></a><span id="l5.626">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;modified&quot;);</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.629"></a><span id="l5.629">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;issued&quot;);</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+      }</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.633"></a><span id="l5.633">         tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;created&quot;);</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+      }</span>
<a href="#l5.635"></a><span id="l5.635"> </span>
<a href="#l5.636"></a><span id="l5.636">       item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.637"></a><span id="l5.637"> </span>
<a href="#l5.638"></a><span id="l5.638">       // XXX We should get the xml:base attribute from the content tag as well</span>
<a href="#l5.639"></a><span id="l5.639">       // and use it as the base HREF of the message.</span>
<a href="#l5.640"></a><span id="l5.640">       // XXX Atom feeds can have multiple content elements; we should differentiate</span>
<a href="#l5.641"></a><span id="l5.641">       // between them and pick the best one.</span>
<a href="#l5.642"></a><span id="l5.642">       // Some Atom feeds wrap the content in a CTYPE declaration; others use</span>
<a href="#l5.643"></a><span id="l5.643">       // a namespace to identify the tags as HTML; and a few are buggy and put</span>
<a href="#l5.644"></a><span id="l5.644">       // HTML tags in without declaring their namespace so they look like Atom.</span>
<a href="#l5.645"></a><span id="l5.645">       // We deal with the first two but not the third.</span>
<a href="#l5.646"></a><span id="l5.646">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;content&quot;);</span>
<a href="#l5.647"></a><span id="l5.647">       let contentNode = tags ? tags[0] : null;</span>
<a href="#l5.648"></a><span id="l5.648"> </span>
<a href="#l5.649"></a><span id="l5.649">       let content;</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-      if (contentNode)</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-      {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+      if (contentNode) {</span>
<a href="#l5.653"></a><span id="l5.653">         content = &quot;&quot;;</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-        for (let node of contentNode.childNodes)</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-        {</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-          if (node.nodeType == node.CDATA_SECTION_NODE)</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        for (let node of contentNode.childNodes) {</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+          if (node.nodeType == node.CDATA_SECTION_NODE) {</span>
<a href="#l5.659"></a><span id="l5.659">             content += node.data;</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-          else</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+          } else {</span>
<a href="#l5.662"></a><span id="l5.662">             content += this.mSerializer.serializeToString(node);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+          }</span>
<a href="#l5.664"></a><span id="l5.664">         }</span>
<a href="#l5.665"></a><span id="l5.665"> </span>
<a href="#l5.666"></a><span id="l5.666" class="difflineminus">-        if (contentNode.getAttribute(&quot;mode&quot;) == &quot;escaped&quot;)</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineminus">-        {</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+        if (contentNode.getAttribute(&quot;mode&quot;) == &quot;escaped&quot;) {</span>
<a href="#l5.669"></a><span id="l5.669">           content = content.replace(/&amp;lt;/g, &quot;&lt;&quot;);</span>
<a href="#l5.670"></a><span id="l5.670">           content = content.replace(/&amp;gt;/g, &quot;&gt;&quot;);</span>
<a href="#l5.671"></a><span id="l5.671">           content = content.replace(/&amp;amp;/g, &quot;&amp;&quot;);</span>
<a href="#l5.672"></a><span id="l5.672">         }</span>
<a href="#l5.673"></a><span id="l5.673"> </span>
<a href="#l5.674"></a><span id="l5.674" class="difflineminus">-        if (content == &quot;&quot;)</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+        if (content == &quot;&quot;) {</span>
<a href="#l5.676"></a><span id="l5.676">           content = null;</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+        }</span>
<a href="#l5.678"></a><span id="l5.678">       }</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680">       item.content = content;</span>
<a href="#l5.681"></a><span id="l5.681">       this.parsedItems.push(item);</span>
<a href="#l5.682"></a><span id="l5.682">     }</span>
<a href="#l5.683"></a><span id="l5.683"> </span>
<a href="#l5.684"></a><span id="l5.684">     return this.parsedItems;</span>
<a href="#l5.685"></a><span id="l5.685">   },</span>
<a href="#l5.686"></a><span id="l5.686"> </span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-  parseAsAtomIETF: function(aFeed, aDOM)</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-  {</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+  parseAsAtomIETF(aFeed, aDOM) {</span>
<a href="#l5.690"></a><span id="l5.690">     // Get the first channel (assuming there is only one per Atom File).</span>
<a href="#l5.691"></a><span id="l5.691">     let channel = this.childrenByTagNameNS(aDOM, FeedUtils.ATOM_IETF_NS, &quot;feed&quot;)[0];</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-    if (!channel)</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-    {</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+    if (!channel) {</span>
<a href="#l5.695"></a><span id="l5.695">       aFeed.onParseError(aFeed);</span>
<a href="#l5.696"></a><span id="l5.696">       return [];</span>
<a href="#l5.697"></a><span id="l5.697">     }</span>
<a href="#l5.698"></a><span id="l5.698"> </span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-    if (this.isPermanentRedirect(aFeed, null, channel, null))</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+    if (this.isPermanentRedirect(aFeed, null, channel, null)) {</span>
<a href="#l5.701"></a><span id="l5.701">       return [];</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+    }</span>
<a href="#l5.703"></a><span id="l5.703"> </span>
<a href="#l5.704"></a><span id="l5.704">     let contentBase = channel.getAttribute(&quot;xml:base&quot;);</span>
<a href="#l5.705"></a><span id="l5.705"> </span>
<a href="#l5.706"></a><span id="l5.706">     let tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;title&quot;);</span>
<a href="#l5.707"></a><span id="l5.707">     aFeed.title = aFeed.title ||</span>
<a href="#l5.708"></a><span id="l5.708">                   this.stripTags(this.serializeTextConstruct(tags ? tags[0] : null));</span>
<a href="#l5.709"></a><span id="l5.709"> </span>
<a href="#l5.710"></a><span id="l5.710">     tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;subtitle&quot;);</span>
<a href="#l5.711"></a><span id="l5.711">     aFeed.description = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.712"></a><span id="l5.712"> </span>
<a href="#l5.713"></a><span id="l5.713">     // Per spec, aFeed.link and contentBase may both end up null here.</span>
<a href="#l5.714"></a><span id="l5.714">     tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;link&quot;);</span>
<a href="#l5.715"></a><span id="l5.715">     aFeed.link = this.findAtomLink(&quot;self&quot;, tags, contentBase) ||</span>
<a href="#l5.716"></a><span id="l5.716">                  this.findAtomLink(&quot;alternate&quot;, tags, contentBase);</span>
<a href="#l5.717"></a><span id="l5.717">     aFeed.link = this.validLink(aFeed.link);</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineminus">-    if (!contentBase)</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+    if (!contentBase) {</span>
<a href="#l5.720"></a><span id="l5.720">       contentBase = aFeed.link;</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+    }</span>
<a href="#l5.722"></a><span id="l5.722"> </span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-    if (!aFeed.title)</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-    {</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+    if (!aFeed.title) {</span>
<a href="#l5.726"></a><span id="l5.726">       FeedUtils.log.error(&quot;FeedParser.parseAsAtomIETF: missing mandatory element &quot; +</span>
<a href="#l5.727"></a><span id="l5.727">                           &quot;&lt;title&gt;&quot;);</span>
<a href="#l5.728"></a><span id="l5.728">       aFeed.onParseError(aFeed);</span>
<a href="#l5.729"></a><span id="l5.729">       return [];</span>
<a href="#l5.730"></a><span id="l5.730">     }</span>
<a href="#l5.731"></a><span id="l5.731"> </span>
<a href="#l5.732"></a><span id="l5.732" class="difflineminus">-    if (!aFeed.parseItems)</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+    if (!aFeed.parseItems) {</span>
<a href="#l5.734"></a><span id="l5.734">       return [];</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+    }</span>
<a href="#l5.736"></a><span id="l5.736"> </span>
<a href="#l5.737"></a><span id="l5.737">     this.findSyUpdateTags(aFeed, channel);</span>
<a href="#l5.738"></a><span id="l5.738"> </span>
<a href="#l5.739"></a><span id="l5.739">     aFeed.invalidateItems();</span>
<a href="#l5.740"></a><span id="l5.740">     let items = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;entry&quot;);</span>
<a href="#l5.741"></a><span id="l5.741">     items = items ? items : [];</span>
<a href="#l5.742"></a><span id="l5.742">     FeedUtils.log.debug(&quot;FeedParser.parseAsAtomIETF: items to parse - &quot; +</span>
<a href="#l5.743"></a><span id="l5.743">                         items.length);</span>
<a href="#l5.744"></a><span id="l5.744"> </span>
<a href="#l5.745"></a><span id="l5.745" class="difflineminus">-    for (let itemNode of items)</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineminus">-    {</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-      if (!itemNode.childElementCount)</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+    for (let itemNode of items) {</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+      if (!itemNode.childElementCount) {</span>
<a href="#l5.750"></a><span id="l5.750">         continue;</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+      }</span>
<a href="#l5.752"></a><span id="l5.752"> </span>
<a href="#l5.753"></a><span id="l5.753">       let item = new FeedItem();</span>
<a href="#l5.754"></a><span id="l5.754">       item.feed = aFeed;</span>
<a href="#l5.755"></a><span id="l5.755">       item.enclosures = [];</span>
<a href="#l5.756"></a><span id="l5.756">       item.keywords = [];</span>
<a href="#l5.757"></a><span id="l5.757"> </span>
<a href="#l5.758"></a><span id="l5.758">       contentBase = itemNode.getAttribute(&quot;xml:base&quot;) || contentBase;</span>
<a href="#l5.759"></a><span id="l5.759"> </span>
<a href="#l5.760"></a><span id="l5.760">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;source&quot;);</span>
<a href="#l5.761"></a><span id="l5.761">       let source = tags ? tags[0] : null;</span>
<a href="#l5.762"></a><span id="l5.762"> </span>
<a href="#l5.763"></a><span id="l5.763">       // Per spec, item.link and contentBase may both end up null here.</span>
<a href="#l5.764"></a><span id="l5.764">       // If &lt;content&gt; is also not present, then &lt;link rel=&quot;alternate&quot;&gt; is MUST</span>
<a href="#l5.765"></a><span id="l5.765">       // but we're lenient.</span>
<a href="#l5.766"></a><span id="l5.766">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.FEEDBURNER_NS, &quot;origLink&quot;);</span>
<a href="#l5.767"></a><span id="l5.767">       item.url = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineminus">-      if (!item.url)</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-      {</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+      if (!item.url) {</span>
<a href="#l5.771"></a><span id="l5.771">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;link&quot;);</span>
<a href="#l5.772"></a><span id="l5.772">         item.url = this.validLink(this.findAtomLink(&quot;alternate&quot;, tags, contentBase)) ||</span>
<a href="#l5.773"></a><span id="l5.773">                    aFeed.link;</span>
<a href="#l5.774"></a><span id="l5.774">       }</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineminus">-      if (!contentBase)</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+      if (!contentBase) {</span>
<a href="#l5.777"></a><span id="l5.777">         contentBase = item.url;</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+      }</span>
<a href="#l5.779"></a><span id="l5.779"> </span>
<a href="#l5.780"></a><span id="l5.780">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;id&quot;);</span>
<a href="#l5.781"></a><span id="l5.781">       item.id = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.782"></a><span id="l5.782">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;summary&quot;);</span>
<a href="#l5.783"></a><span id="l5.783">       item.description = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.784"></a><span id="l5.784">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;title&quot;);</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.787"></a><span id="l5.787">         tags = this.childrenByTagNameNS(source, FeedUtils.ATOM_IETF_NS, &quot;title&quot;);</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+      }</span>
<a href="#l5.789"></a><span id="l5.789">       item.title = this.stripTags(this.serializeTextConstruct(tags ? tags[0] : null) ||</span>
<a href="#l5.790"></a><span id="l5.790">                                   (item.description ?</span>
<a href="#l5.791"></a><span id="l5.791">                                      item.description.substr(0, 150) : null));</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineminus">-      if (!item.title || !item.id)</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineminus">-      {</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+      if (!item.title || !item.id) {</span>
<a href="#l5.795"></a><span id="l5.795">         // We're lenient about other mandatory tags, but insist on these.</span>
<a href="#l5.796"></a><span id="l5.796">         FeedUtils.log.info(&quot;FeedParser.parseAsAtomIETF: &lt;entry&gt; missing mandatory &quot; +</span>
<a href="#l5.797"></a><span id="l5.797">                            &quot;element &lt;id&gt;, or &lt;title&gt; and no &lt;summary&gt;; skipping&quot;);</span>
<a href="#l5.798"></a><span id="l5.798">         continue;</span>
<a href="#l5.799"></a><span id="l5.799">       }</span>
<a href="#l5.800"></a><span id="l5.800"> </span>
<a href="#l5.801"></a><span id="l5.801">       // XXX Support multiple authors.</span>
<a href="#l5.802"></a><span id="l5.802">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineminus">-      if (!tags)</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+      if (!tags) {</span>
<a href="#l5.805"></a><span id="l5.805">         tags = this.childrenByTagNameNS(source, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineminus">-      if (!tags)</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+      }</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+      if (!tags) {</span>
<a href="#l5.809"></a><span id="l5.809">         tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+      }</span>
<a href="#l5.811"></a><span id="l5.811"> </span>
<a href="#l5.812"></a><span id="l5.812">       let authorEl = tags ? tags[0] : null;</span>
<a href="#l5.813"></a><span id="l5.813"> </span>
<a href="#l5.814"></a><span id="l5.814">       let author = &quot;&quot;;</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-      if (authorEl)</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineminus">-      {</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+      if (authorEl) {</span>
<a href="#l5.818"></a><span id="l5.818">         tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_IETF_NS, &quot;name&quot;);</span>
<a href="#l5.819"></a><span id="l5.819">         let name = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.820"></a><span id="l5.820">         tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_IETF_NS, &quot;email&quot;);</span>
<a href="#l5.821"></a><span id="l5.821">         let email = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineminus">-        if (name)</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+        if (name) {</span>
<a href="#l5.824"></a><span id="l5.824">           author = name + (email ? &quot; &lt;&quot; + email + &quot;&gt;&quot; : &quot;&quot;);</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-        else if (email)</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+        } else if (email) {</span>
<a href="#l5.827"></a><span id="l5.827">           author = email;</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+        }</span>
<a href="#l5.829"></a><span id="l5.829">       }</span>
<a href="#l5.830"></a><span id="l5.830"> </span>
<a href="#l5.831"></a><span id="l5.831">       item.author = author || item.author || aFeed.title;</span>
<a href="#l5.832"></a><span id="l5.832"> </span>
<a href="#l5.833"></a><span id="l5.833">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;updated&quot;);</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.836"></a><span id="l5.836">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;published&quot;);</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineminus">-      if (!tags || !this.getNodeValue(tags[0]))</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+      }</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+      if (!tags || !this.getNodeValue(tags[0])) {</span>
<a href="#l5.840"></a><span id="l5.840">         tags = this.childrenByTagNameNS(source, FeedUtils.ATOM_IETF_NS, &quot;published&quot;);</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+      }</span>
<a href="#l5.842"></a><span id="l5.842">       item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.843"></a><span id="l5.843"> </span>
<a href="#l5.844"></a><span id="l5.844">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;content&quot;);</span>
<a href="#l5.845"></a><span id="l5.845">       item.content = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.846"></a><span id="l5.846"> </span>
<a href="#l5.847"></a><span id="l5.847">       // Ensure relative links can be resolved and Content-Base set to an</span>
<a href="#l5.848"></a><span id="l5.848">       // absolute url for the entry. But it's not mandatory that a url is found</span>
<a href="#l5.849"></a><span id="l5.849">       // for Content-Base, per spec.</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineminus">-      if (item.content)</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineminus">-      {</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+      if (item.content) {</span>
<a href="#l5.853"></a><span id="l5.853">         item.xmlContentBase = (tags &amp;&amp; tags[0].getAttribute(&quot;xml:base&quot;)) ||</span>
<a href="#l5.854"></a><span id="l5.854">                               contentBase;</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineminus">-      }</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineminus">-      else if (item.description)</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineminus">-      {</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+      } else if (item.description) {</span>
<a href="#l5.859"></a><span id="l5.859">         tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;summary&quot;);</span>
<a href="#l5.860"></a><span id="l5.860">         item.xmlContentBase = (tags &amp;&amp; tags[0].getAttribute(&quot;xml:base&quot;)) ||</span>
<a href="#l5.861"></a><span id="l5.861">                               contentBase;</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-      }</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineminus">-      else</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineminus">-      {</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+      } else {</span>
<a href="#l5.866"></a><span id="l5.866">         item.xmlContentBase = contentBase;</span>
<a href="#l5.867"></a><span id="l5.867">       }</span>
<a href="#l5.868"></a><span id="l5.868"> </span>
<a href="#l5.869"></a><span id="l5.869">       item.xmlContentBase = this.validLink(item.xmlContentBase);</span>
<a href="#l5.870"></a><span id="l5.870"> </span>
<a href="#l5.871"></a><span id="l5.871">       // Handle &lt;link rel=&quot;enclosure&quot;&gt; (if present).</span>
<a href="#l5.872"></a><span id="l5.872">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;link&quot;);</span>
<a href="#l5.873"></a><span id="l5.873">       let encUrls = [];</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-      if (tags)</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-        {</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+      if (tags) {</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.879"></a><span id="l5.879">           let url = tag.getAttribute(&quot;rel&quot;) == &quot;enclosure&quot; ?</span>
<a href="#l5.880"></a><span id="l5.880">                       (tag.getAttribute(&quot;href&quot;) || &quot;&quot;).trim() : null;</span>
<a href="#l5.881"></a><span id="l5.881">           url = this.validLink(url);</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineminus">-          if (url &amp;&amp; !encUrls.includes(url))</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineminus">-          {</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+          if (url &amp;&amp; !encUrls.includes(url)) {</span>
<a href="#l5.885"></a><span id="l5.885">             let type = this.removeUnprintableASCII(tag.getAttribute(&quot;type&quot;));</span>
<a href="#l5.886"></a><span id="l5.886">             let length = this.removeUnprintableASCII(tag.getAttribute(&quot;length&quot;));</span>
<a href="#l5.887"></a><span id="l5.887">             let title = this.removeUnprintableASCII(tag.getAttribute(&quot;title&quot;));</span>
<a href="#l5.888"></a><span id="l5.888">             item.enclosures.push(new FeedEnclosure(url, type, length, title));</span>
<a href="#l5.889"></a><span id="l5.889">             encUrls.push(url);</span>
<a href="#l5.890"></a><span id="l5.890">           }</span>
<a href="#l5.891"></a><span id="l5.891">         }</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+      }</span>
<a href="#l5.893"></a><span id="l5.893"> </span>
<a href="#l5.894"></a><span id="l5.894">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.FEEDBURNER_NS, &quot;origEnclosureLink&quot;);</span>
<a href="#l5.895"></a><span id="l5.895">       let origEncUrl = this.validLink(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-      if (origEncUrl)</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-      {</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-        if (item.enclosures.length)</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+      if (origEncUrl) {</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+        if (item.enclosures.length) {</span>
<a href="#l5.901"></a><span id="l5.901">           item.enclosures[0].mURL = origEncUrl;</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-        else</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+        } else {</span>
<a href="#l5.904"></a><span id="l5.904">           item.enclosures.push(new FeedEnclosure(origEncUrl));</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+        }</span>
<a href="#l5.906"></a><span id="l5.906">       }</span>
<a href="#l5.907"></a><span id="l5.907"> </span>
<a href="#l5.908"></a><span id="l5.908">       // Handle atom threading extension, RFC4685.  There may be 1 or more tags,</span>
<a href="#l5.909"></a><span id="l5.909">       // and each must contain a ref attribute with 1 Message-Id equivalent</span>
<a href="#l5.910"></a><span id="l5.910">       // value.  This is the only attr of interest in the spec for presentation.</span>
<a href="#l5.911"></a><span id="l5.911">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_THREAD_NS, &quot;in-reply-to&quot;);</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-      if (tags)</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineminus">-      {</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-        {</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+      if (tags) {</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.918"></a><span id="l5.918">           let ref = this.removeUnprintableASCII(tag.getAttribute(&quot;ref&quot;));</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-          if (ref)</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+          if (ref) {</span>
<a href="#l5.921"></a><span id="l5.921">             item.inReplyTo += item.normalizeMessageID(ref) + &quot; &quot;;</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+          }</span>
<a href="#l5.923"></a><span id="l5.923">         }</span>
<a href="#l5.924"></a><span id="l5.924">         item.inReplyTo = item.inReplyTo.trimRight();</span>
<a href="#l5.925"></a><span id="l5.925">       }</span>
<a href="#l5.926"></a><span id="l5.926"> </span>
<a href="#l5.927"></a><span id="l5.927">       // Support &lt;category&gt; and autotagging.</span>
<a href="#l5.928"></a><span id="l5.928">       tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;category&quot;);</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-      if (tags)</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-      {</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-        for (let tag of tags)</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-        {</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+      if (tags) {</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+        for (let tag of tags) {</span>
<a href="#l5.935"></a><span id="l5.935">           let term = this.removeUnprintableASCII(tag.getAttribute(&quot;term&quot;));</span>
<a href="#l5.936"></a><span id="l5.936">           term = term ? this.xmlUnescape(term.replace(/,/g, &quot;;&quot;)).trim() : null;</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-          if (term &amp;&amp; !item.keywords.includes(term))</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+          if (term &amp;&amp; !item.keywords.includes(term)) {</span>
<a href="#l5.939"></a><span id="l5.939">             item.keywords.push(term);</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+          }</span>
<a href="#l5.941"></a><span id="l5.941">         }</span>
<a href="#l5.942"></a><span id="l5.942">       }</span>
<a href="#l5.943"></a><span id="l5.943"> </span>
<a href="#l5.944"></a><span id="l5.944">       this.parsedItems.push(item);</span>
<a href="#l5.945"></a><span id="l5.945">     }</span>
<a href="#l5.946"></a><span id="l5.946"> </span>
<a href="#l5.947"></a><span id="l5.947">     return this.parsedItems;</span>
<a href="#l5.948"></a><span id="l5.948">   },</span>
<a href="#l5.949"></a><span id="l5.949"> </span>
<a href="#l5.950"></a><span id="l5.950" class="difflineminus">-  isPermanentRedirect: function(aFeed, aRedirDocChannel, aFeedChannel, aDS)</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineminus">-  {</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+  isPermanentRedirect(aFeed, aRedirDocChannel, aFeedChannel, aDS) {</span>
<a href="#l5.953"></a><span id="l5.953">     // If subscribing to a new feed, do not check redirect tags.</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-    if (!aFeed.downloadCallback || aFeed.downloadCallback.mSubscribeMode)</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+    if (!aFeed.downloadCallback || aFeed.downloadCallback.mSubscribeMode) {</span>
<a href="#l5.956"></a><span id="l5.956">       return false;</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+    }</span>
<a href="#l5.958"></a><span id="l5.958"> </span>
<a href="#l5.959"></a><span id="l5.959">     let tags, tagName, newUrl;</span>
<a href="#l5.960"></a><span id="l5.960">     let oldUrl = aFeed.url;</span>
<a href="#l5.961"></a><span id="l5.961"> </span>
<a href="#l5.962"></a><span id="l5.962">     // Check for RSS2.0 redirect document &lt;newLocation&gt; tag.</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineminus">-    if (aRedirDocChannel)</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineminus">-    {</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+    if (aRedirDocChannel) {</span>
<a href="#l5.966"></a><span id="l5.966">       tagName = &quot;newLocation&quot;;</span>
<a href="#l5.967"></a><span id="l5.967">       tags = this.childrenByTagNameNS(aRedirDocChannel, &quot;&quot;, tagName);</span>
<a href="#l5.968"></a><span id="l5.968">       newUrl = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.969"></a><span id="l5.969">     }</span>
<a href="#l5.970"></a><span id="l5.970"> </span>
<a href="#l5.971"></a><span id="l5.971">     // Check for &lt;itunes:new-feed-url&gt; tag.</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineminus">-    if (aFeedChannel)</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineminus">-    {</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineplus">+    if (aFeedChannel) {</span>
<a href="#l5.975"></a><span id="l5.975">       tagName = &quot;new-feed-url&quot;;</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-      if (aDS)</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-      {</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+      if (aDS) {</span>
<a href="#l5.979"></a><span id="l5.979">         tags = FeedUtils.rdf.GetResource(FeedUtils.ITUNES_NS + tagName);</span>
<a href="#l5.980"></a><span id="l5.980">         newUrl = this.getRDFTargetValue(aDS, aFeedChannel, tags);</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineminus">-      }</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineminus">-      else</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineminus">-      {</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineplus">+      } else {</span>
<a href="#l5.985"></a><span id="l5.985">         tags = this.childrenByTagNameNS(aFeedChannel, FeedUtils.ITUNES_NS, tagName);</span>
<a href="#l5.986"></a><span id="l5.986">         newUrl = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.987"></a><span id="l5.987">       }</span>
<a href="#l5.988"></a><span id="l5.988">       tagName = &quot;itunes:&quot; + tagName;</span>
<a href="#l5.989"></a><span id="l5.989">     }</span>
<a href="#l5.990"></a><span id="l5.990"> </span>
<a href="#l5.991"></a><span id="l5.991">     if (newUrl &amp;&amp; newUrl != oldUrl &amp;&amp; FeedUtils.isValidScheme(newUrl) &amp;&amp;</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineminus">-        FeedUtils.changeUrlForFeed(aFeed, newUrl))</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineminus">-    {</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineplus">+        FeedUtils.changeUrlForFeed(aFeed, newUrl)) {</span>
<a href="#l5.995"></a><span id="l5.995">       FeedUtils.log.info(&quot;FeedParser.isPermanentRedirect: found &lt;&quot; + tagName +</span>
<a href="#l5.996"></a><span id="l5.996">                          &quot;&gt; tag; updated feed url from: &quot; + oldUrl + &quot; to: &quot; + newUrl +</span>
<a href="#l5.997"></a><span id="l5.997">                          &quot; in folder: &quot; + FeedUtils.getFolderPrettyPath(aFeed.folder));</span>
<a href="#l5.998"></a><span id="l5.998">       aFeed.onUrlChange(aFeed, oldUrl);</span>
<a href="#l5.999"></a><span id="l5.999">       return true;</span>
<a href="#l5.1000"></a><span id="l5.1000">     }</span>
<a href="#l5.1001"></a><span id="l5.1001"> </span>
<a href="#l5.1002"></a><span id="l5.1002">     return false;</span>
<a href="#l5.1003"></a><span id="l5.1003">   },</span>
<a href="#l5.1004"></a><span id="l5.1004"> </span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineminus">-  serializeTextConstruct: function(textElement)</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineminus">-  {</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineplus">+  serializeTextConstruct(textElement) {</span>
<a href="#l5.1008"></a><span id="l5.1008">     let content = &quot;&quot;;</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineminus">-    if (textElement)</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineminus">-    {</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineplus">+    if (textElement) {</span>
<a href="#l5.1012"></a><span id="l5.1012">       let textType = textElement.getAttribute(&quot;type&quot;);</span>
<a href="#l5.1013"></a><span id="l5.1013"> </span>
<a href="#l5.1014"></a><span id="l5.1014">       // Atom spec says consider it &quot;text&quot; if not present.</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-      if (!textType)</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+      if (!textType) {</span>
<a href="#l5.1017"></a><span id="l5.1017">         textType = &quot;text&quot;;</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+      }</span>
<a href="#l5.1019"></a><span id="l5.1019"> </span>
<a href="#l5.1020"></a><span id="l5.1020">       // There could be some strange content type we don't handle.</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineminus">-      if (textType != &quot;text&quot; &amp;&amp; textType != &quot;html&quot; &amp;&amp; textType != &quot;xhtml&quot;)</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineplus">+      if (textType != &quot;text&quot; &amp;&amp; textType != &quot;html&quot; &amp;&amp; textType != &quot;xhtml&quot;) {</span>
<a href="#l5.1023"></a><span id="l5.1023">         return null;</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-      for (let node of textElement.childNodes)</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-      {</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-        if (node.nodeType == node.CDATA_SECTION_NODE)</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineminus">-          content += this.xmlEscape(node.data);</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineminus">-        else</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineminus">-          content += this.mSerializer.serializeToString(node);</span>
<a href="#l5.1031"></a><span id="l5.1031">       }</span>
<a href="#l5.1032"></a><span id="l5.1032"> </span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineminus">-      if (textType == &quot;html&quot;)</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineplus">+      for (let node of textElement.childNodes) {</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineplus">+        if (node.nodeType == node.CDATA_SECTION_NODE) {</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineplus">+          content += this.xmlEscape(node.data);</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineplus">+        } else {</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+          content += this.mSerializer.serializeToString(node);</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+        }</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+      }</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineplus">+</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+      if (textType == &quot;html&quot;) {</span>
<a href="#l5.1043"></a><span id="l5.1043">         content = this.xmlUnescape(content);</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineplus">+      }</span>
<a href="#l5.1045"></a><span id="l5.1045"> </span>
<a href="#l5.1046"></a><span id="l5.1046">       content = content.trim();</span>
<a href="#l5.1047"></a><span id="l5.1047">     }</span>
<a href="#l5.1048"></a><span id="l5.1048"> </span>
<a href="#l5.1049"></a><span id="l5.1049">     // Other parts of the code depend on this being null if there's no content.</span>
<a href="#l5.1050"></a><span id="l5.1050">     return content ? content : null;</span>
<a href="#l5.1051"></a><span id="l5.1051">   },</span>
<a href="#l5.1052"></a><span id="l5.1052"> </span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineminus">-  getRDFTargetValue: function(ds, source, property)</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineminus">-  {</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineplus">+  getRDFTargetValue(ds, source, property) {</span>
<a href="#l5.1056"></a><span id="l5.1056">     let nodeValue = this.getRDFTargetValueRaw(ds, source, property);</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineminus">-    if (!nodeValue)</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineplus">+    if (!nodeValue) {</span>
<a href="#l5.1059"></a><span id="l5.1059">       return null;</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineplus">+    }</span>
<a href="#l5.1061"></a><span id="l5.1061"> </span>
<a href="#l5.1062"></a><span id="l5.1062">     nodeValue = nodeValue.replace(/[\n\r\t]+/g, &quot; &quot;);</span>
<a href="#l5.1063"></a><span id="l5.1063">     return this.removeUnprintableASCII(nodeValue);</span>
<a href="#l5.1064"></a><span id="l5.1064"> </span>
<a href="#l5.1065"></a><span id="l5.1065">   },</span>
<a href="#l5.1066"></a><span id="l5.1066"> </span>
<a href="#l5.1067"></a><span id="l5.1067" class="difflineminus">-  getRDFTargetValueFormatted: function(ds, source, property)</span>
<a href="#l5.1068"></a><span id="l5.1068" class="difflineminus">-  {</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineplus">+  getRDFTargetValueFormatted(ds, source, property) {</span>
<a href="#l5.1070"></a><span id="l5.1070">     let nodeValue = this.getRDFTargetValueRaw(ds, source, property);</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineminus">-    if (!nodeValue)</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineplus">+    if (!nodeValue) {</span>
<a href="#l5.1073"></a><span id="l5.1073">       return null;</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineplus">+    }</span>
<a href="#l5.1075"></a><span id="l5.1075"> </span>
<a href="#l5.1076"></a><span id="l5.1076">     return this.removeUnprintableASCIIexCRLFTAB(nodeValue);</span>
<a href="#l5.1077"></a><span id="l5.1077"> </span>
<a href="#l5.1078"></a><span id="l5.1078">   },</span>
<a href="#l5.1079"></a><span id="l5.1079"> </span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineminus">-  getRDFTargetValueRaw: function(ds, source, property)</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineminus">-  {</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineplus">+  getRDFTargetValueRaw(ds, source, property) {</span>
<a href="#l5.1083"></a><span id="l5.1083">     let node = ds.GetTarget(source, property, true);</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineminus">-    if (node)</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineminus">-    {</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineminus">-      try</span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineminus">-      {</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineplus">+    if (node) {</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineplus">+      try {</span>
<a href="#l5.1090"></a><span id="l5.1090">         node = node.QueryInterface(Ci.nsIRDFLiteral);</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineminus">-        if (node)</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineplus">+        if (node) {</span>
<a href="#l5.1093"></a><span id="l5.1093">           return node.Value.trim();</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineminus">-      }</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineminus">-      catch (e)</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineminus">-      {</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+        }</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+      } catch (ex) {</span>
<a href="#l5.1099"></a><span id="l5.1099">         // If the RDF was bogus, do nothing.  Rethrow if it's some other problem.</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineminus">-        if (!((e instanceof Ci.nsIXPCException) &amp;&amp;</span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineminus">-              e.result == Cr.NS_ERROR_NO_INTERFACE))</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineminus">-          throw new Error(&quot;FeedParser.getRDFTargetValue: &quot; + e);</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineplus">+        if (!((ex instanceof Ci.nsIXPCException) &amp;&amp;</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineplus">+              ex.result == Cr.NS_ERROR_NO_INTERFACE)) {</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+          throw new Error(&quot;FeedParser.getRDFTargetValue: &quot; + ex);</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineplus">+        }</span>
<a href="#l5.1107"></a><span id="l5.1107">       }</span>
<a href="#l5.1108"></a><span id="l5.1108">     }</span>
<a href="#l5.1109"></a><span id="l5.1109"> </span>
<a href="#l5.1110"></a><span id="l5.1110">     return null;</span>
<a href="#l5.1111"></a><span id="l5.1111">   },</span>
<a href="#l5.1112"></a><span id="l5.1112"> </span>
<a href="#l5.1113"></a><span id="l5.1113">   /**</span>
<a href="#l5.1114"></a><span id="l5.1114">    * Return a cleaned up node value. This is intended for values that are not</span>
<a href="#l5.1115"></a><span id="l5.1115">    * multiline and not formatted. A sequence of tab or newline is converted to</span>
<a href="#l5.1116"></a><span id="l5.1116">    * a space and unprintable ascii is removed.</span>
<a href="#l5.1117"></a><span id="l5.1117">    *</span>
<a href="#l5.1118"></a><span id="l5.1118">    * @param {Node} node  - A DOM node.</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineminus">-   * @return {String}    - A clean string value or null.</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineplus">+   * @returns {String}   - A clean string value or null.</span>
<a href="#l5.1121"></a><span id="l5.1121">    */</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineminus">-  getNodeValue: function(node)</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineminus">-  {</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+  getNodeValue(node) {</span>
<a href="#l5.1125"></a><span id="l5.1125">     let nodeValue = this.getNodeValueRaw(node);</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineminus">-    if (!nodeValue)</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineplus">+    if (!nodeValue) {</span>
<a href="#l5.1128"></a><span id="l5.1128">       return null;</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineplus">+    }</span>
<a href="#l5.1130"></a><span id="l5.1130"> </span>
<a href="#l5.1131"></a><span id="l5.1131">     nodeValue = nodeValue.replace(/[\n\r\t]+/g, &quot; &quot;);</span>
<a href="#l5.1132"></a><span id="l5.1132">     return this.removeUnprintableASCII(nodeValue);</span>
<a href="#l5.1133"></a><span id="l5.1133">   },</span>
<a href="#l5.1134"></a><span id="l5.1134"> </span>
<a href="#l5.1135"></a><span id="l5.1135">   /**</span>
<a href="#l5.1136"></a><span id="l5.1136">    * Return a cleaned up formatted node value, meaning CR/LF/TAB are retained</span>
<a href="#l5.1137"></a><span id="l5.1137">    * while all other unprintable ascii is removed. This is intended for values</span>
<a href="#l5.1138"></a><span id="l5.1138">    * that are multiline and formatted, such as content or description tags.</span>
<a href="#l5.1139"></a><span id="l5.1139">    *</span>
<a href="#l5.1140"></a><span id="l5.1140">    * @param {Node} node  - A DOM node.</span>
<a href="#l5.1141"></a><span id="l5.1141" class="difflineminus">-   * @return {String}    - A clean string value or null.</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineplus">+   * @returns {String}   - A clean string value or null.</span>
<a href="#l5.1143"></a><span id="l5.1143">    */</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineminus">-  getNodeValueFormatted: function(node)</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineminus">-  {</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+  getNodeValueFormatted(node) {</span>
<a href="#l5.1147"></a><span id="l5.1147">     let nodeValue = this.getNodeValueRaw(node);</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineminus">-    if (!nodeValue)</span>
<a href="#l5.1149"></a><span id="l5.1149" class="difflineplus">+    if (!nodeValue) {</span>
<a href="#l5.1150"></a><span id="l5.1150">       return null;</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineplus">+    }</span>
<a href="#l5.1152"></a><span id="l5.1152"> </span>
<a href="#l5.1153"></a><span id="l5.1153">     return this.removeUnprintableASCIIexCRLFTAB(nodeValue);</span>
<a href="#l5.1154"></a><span id="l5.1154">   },</span>
<a href="#l5.1155"></a><span id="l5.1155"> </span>
<a href="#l5.1156"></a><span id="l5.1156">   /**</span>
<a href="#l5.1157"></a><span id="l5.1157">    * Return a raw node value, as received. This should be sanitized as</span>
<a href="#l5.1158"></a><span id="l5.1158">    * appropriate.</span>
<a href="#l5.1159"></a><span id="l5.1159">    *</span>
<a href="#l5.1160"></a><span id="l5.1160">    * @param {Node} node  - A DOM node.</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineminus">-   * @return {String}    - A string value or null.</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineplus">+   * @returns {String}   - A string value or null.</span>
<a href="#l5.1163"></a><span id="l5.1163">    */</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineminus">-  getNodeValueRaw: function(node)</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineminus">-  {</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineminus">-    if (node &amp;&amp; node.textContent)</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+  getNodeValueRaw(node) {</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+    if (node &amp;&amp; node.textContent) {</span>
<a href="#l5.1169"></a><span id="l5.1169">       return node.textContent.trim();</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineplus">+    }</span>
<a href="#l5.1171"></a><span id="l5.1171"> </span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineminus">-    if (node &amp;&amp; node.firstChild)</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineminus">-    {</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineplus">+    if (node &amp;&amp; node.firstChild) {</span>
<a href="#l5.1175"></a><span id="l5.1175">       let ret = &quot;&quot;;</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineminus">-      for (let child = node.firstChild; child; child = child.nextSibling)</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineminus">-      {</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineplus">+      for (let child = node.firstChild; child; child = child.nextSibling) {</span>
<a href="#l5.1179"></a><span id="l5.1179">         let value = this.getNodeValueRaw(child);</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineminus">-        if (value)</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+        if (value) {</span>
<a href="#l5.1182"></a><span id="l5.1182">           ret += value;</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineplus">+        }</span>
<a href="#l5.1184"></a><span id="l5.1184">       }</span>
<a href="#l5.1185"></a><span id="l5.1185"> </span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineminus">-      if (ret)</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+      if (ret) {</span>
<a href="#l5.1188"></a><span id="l5.1188">         return ret.trim();</span>
<a href="#l5.1189"></a><span id="l5.1189" class="difflineplus">+      }</span>
<a href="#l5.1190"></a><span id="l5.1190">     }</span>
<a href="#l5.1191"></a><span id="l5.1191"> </span>
<a href="#l5.1192"></a><span id="l5.1192">     return null;</span>
<a href="#l5.1193"></a><span id="l5.1193">   },</span>
<a href="#l5.1194"></a><span id="l5.1194"> </span>
<a href="#l5.1195"></a><span id="l5.1195">   // Finds elements that are direct children of the first arg.</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineminus">-  childrenByTagNameNS: function(aElement, aNamespace, aTagName)</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineminus">-  {</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineminus">-    if (!aElement)</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineplus">+  childrenByTagNameNS(aElement, aNamespace, aTagName) {</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineplus">+    if (!aElement) {</span>
<a href="#l5.1201"></a><span id="l5.1201">       return null;</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+    }</span>
<a href="#l5.1203"></a><span id="l5.1203"> </span>
<a href="#l5.1204"></a><span id="l5.1204">     let matches = aElement.getElementsByTagNameNS(aNamespace, aTagName);</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineminus">-    let matchingChildren = new Array();</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineminus">-    for (let match of matches)</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineminus">-    {</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineminus">-      if (match.parentNode == aElement)</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineminus">-        matchingChildren.push(match)</span>
<a href="#l5.1210"></a><span id="l5.1210" class="difflineplus">+    let matchingChildren = [];</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineplus">+    for (let match of matches) {</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineplus">+      if (match.parentNode == aElement) {</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineplus">+        matchingChildren.push(match);</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineplus">+      }</span>
<a href="#l5.1215"></a><span id="l5.1215">     }</span>
<a href="#l5.1216"></a><span id="l5.1216"> </span>
<a href="#l5.1217"></a><span id="l5.1217">     return matchingChildren.length ? matchingChildren : null;</span>
<a href="#l5.1218"></a><span id="l5.1218">   },</span>
<a href="#l5.1219"></a><span id="l5.1219"> </span>
<a href="#l5.1220"></a><span id="l5.1220">   /**</span>
<a href="#l5.1221"></a><span id="l5.1221">    * Ensure &lt;link&gt; type tags start with http[s]://, ftp:// or magnet:</span>
<a href="#l5.1222"></a><span id="l5.1222">    * for values stored in mail headers (content-base and remote enclosures),</span>
<a href="#l5.1223"></a><span id="l5.1223">    * particularly to prevent data: uris, javascript, and other spoofing.</span>
<a href="#l5.1224"></a><span id="l5.1224">    *</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineminus">-   * @param {String} link - An intended http url string.</span>
<a href="#l5.1226"></a><span id="l5.1226" class="difflineminus">-   * @return {String}     - A clean string starting with http, ftp or magnet,</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineminus">-   *                        else null.</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineplus">+   * @param {String} link  - An intended http url string.</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineplus">+   * @returns {String}     - A clean string starting with http, ftp or magnet,</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineplus">+   *                         else null.</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+   * @returns {String} or null</span>
<a href="#l5.1232"></a><span id="l5.1232">    */</span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineminus">-  validLink: function(link)</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineminus">-  {</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineminus">-    if (/^((https?|ftp):\/\/|magnet:)/.test(link))</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineplus">+  validLink(link) {</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineplus">+    if (/^((https?|ftp):\/\/|magnet:)/.test(link)) {</span>
<a href="#l5.1238"></a><span id="l5.1238">       return this.removeUnprintableASCII(link.trim());</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineplus">+    }</span>
<a href="#l5.1240"></a><span id="l5.1240"> </span>
<a href="#l5.1241"></a><span id="l5.1241">     return null;</span>
<a href="#l5.1242"></a><span id="l5.1242">   },</span>
<a href="#l5.1243"></a><span id="l5.1243"> </span>
<a href="#l5.1244"></a><span id="l5.1244">   /**</span>
<a href="#l5.1245"></a><span id="l5.1245">    * Return an absolute link for &lt;entry&gt; relative links. If xml:base is</span>
<a href="#l5.1246"></a><span id="l5.1246">    * present in a &lt;feed&gt; attribute or child &lt;link&gt; element attribute, use it;</span>
<a href="#l5.1247"></a><span id="l5.1247">    * otherwise the Feed.link will be the relevant &lt;feed&gt; child &lt;link&gt; value</span>
<a href="#l5.1248"></a><span id="l5.1248">    * and will be the |baseURI| for &lt;entry&gt; child &lt;link&gt;s if there is no further</span>
<a href="#l5.1249"></a><span id="l5.1249">    * xml:base, which may be an attribute of any element.</span>
<a href="#l5.1250"></a><span id="l5.1250">    *</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineminus">-   * @param string linkRel         - the &lt;link&gt; rel attribute value to find.</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineminus">-   * @param NodeList linkElements  - the nodelist of &lt;links&gt; to search in.</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineminus">-   * @param string baseURI         - the url to use when resolving relative</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineminus">-   *                                 links to absolute values.</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineminus">-   * @return string or null        - absolute url for a &lt;link&gt;, or null if the</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineminus">-   *                                 rel type is not found.</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineplus">+   * @param {String} linkRel         - the &lt;link&gt; rel attribute value to find.</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+   * @param {NodeList} linkElements  - the nodelist of &lt;links&gt; to search in.</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+   * @param {String} baseURI         - the url to use when resolving relative</span>
<a href="#l5.1260"></a><span id="l5.1260" class="difflineplus">+   *                                   links to absolute values.</span>
<a href="#l5.1261"></a><span id="l5.1261" class="difflineplus">+   * @returns {String} or null       - absolute url for a &lt;link&gt;, or null if the</span>
<a href="#l5.1262"></a><span id="l5.1262" class="difflineplus">+   *                                   rel type is not found.</span>
<a href="#l5.1263"></a><span id="l5.1263">    */</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineminus">-  findAtomLink: function(linkRel, linkElements, baseURI)</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineminus">-  {</span>
<a href="#l5.1266"></a><span id="l5.1266" class="difflineminus">-    if (!linkElements)</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineplus">+  findAtomLink(linkRel, linkElements, baseURI) {</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+    if (!linkElements) {</span>
<a href="#l5.1269"></a><span id="l5.1269">       return null;</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineplus">+    }</span>
<a href="#l5.1271"></a><span id="l5.1271"> </span>
<a href="#l5.1272"></a><span id="l5.1272">     // XXX Need to check for MIME type and hreflang.</span>
<a href="#l5.1273"></a><span id="l5.1273">     for (let alink of linkElements) {</span>
<a href="#l5.1274"></a><span id="l5.1274">       if (alink &amp;&amp;</span>
<a href="#l5.1275"></a><span id="l5.1275">           // If there's a link rel.</span>
<a href="#l5.1276"></a><span id="l5.1276">           ((alink.getAttribute(&quot;rel&quot;) &amp;&amp; alink.getAttribute(&quot;rel&quot;) == linkRel) ||</span>
<a href="#l5.1277"></a><span id="l5.1277">            // If there isn't, assume 'alternate'.</span>
<a href="#l5.1278"></a><span id="l5.1278">            (!alink.getAttribute(&quot;rel&quot;) &amp;&amp; (linkRel == &quot;alternate&quot;))) &amp;&amp;</span>
<a href="#l5.1279"></a><span id="l5.1279" class="difflineminus">-          alink.getAttribute(&quot;href&quot;))</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineminus">-      {</span>
<a href="#l5.1281"></a><span id="l5.1281" class="difflineplus">+          alink.getAttribute(&quot;href&quot;)) {</span>
<a href="#l5.1282"></a><span id="l5.1282">         // Atom links are interpreted relative to xml:base.</span>
<a href="#l5.1283"></a><span id="l5.1283">         let href = alink.getAttribute(&quot;href&quot;);</span>
<a href="#l5.1284"></a><span id="l5.1284">         baseURI = alink.getAttribute(&quot;xml:base&quot;) || baseURI || href;</span>
<a href="#l5.1285"></a><span id="l5.1285">         try {</span>
<a href="#l5.1286"></a><span id="l5.1286">           return Services.io.newURI(baseURI).resolve(href);</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineminus">-        }</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineminus">-        catch (ex) {}</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l5.1290"></a><span id="l5.1290">       }</span>
<a href="#l5.1291"></a><span id="l5.1291">     }</span>
<a href="#l5.1292"></a><span id="l5.1292"> </span>
<a href="#l5.1293"></a><span id="l5.1293">     return null;</span>
<a href="#l5.1294"></a><span id="l5.1294">   },</span>
<a href="#l5.1295"></a><span id="l5.1295"> </span>
<a href="#l5.1296"></a><span id="l5.1296">   /**</span>
<a href="#l5.1297"></a><span id="l5.1297">    * Find RSS Syndication extension tags.</span>
<a href="#l5.1298"></a><span id="l5.1298">    * http://web.resource.org/rss/1.0/modules/syndication/</span>
<a href="#l5.1299"></a><span id="l5.1299">    *</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineminus">-   * Feed aFeed           - the feed object.</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineminus">-   * Node aChannel        - dom node for the &lt;channel&gt;.</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineminus">-   * nsIRDFDataSource aDS - passed in for rdf feeds only.</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineplus">+   * @param {Feed} aFeed           - the feed object.</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+   * @param {Node} aChannel        - dom node for the &lt;channel&gt;.</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineplus">+   * @param {nsIRDFDataSource} aDS - passed in for rdf feeds only.</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+   * @returns {void}</span>
<a href="#l5.1307"></a><span id="l5.1307">    */</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineminus">-  findSyUpdateTags: function(aFeed, aChannel, aDS)</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineminus">-  {</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+  findSyUpdateTags(aFeed, aChannel, aDS) {</span>
<a href="#l5.1311"></a><span id="l5.1311">     let tag, updatePeriod, updateFrequency, updateBase;</span>
<a href="#l5.1312"></a><span id="l5.1312" class="difflineminus">-    if (aDS)</span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineminus">-    {</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineplus">+    if (aDS) {</span>
<a href="#l5.1315"></a><span id="l5.1315">       // For rdf feeds.</span>
<a href="#l5.1316"></a><span id="l5.1316">       tag = FeedUtils.rdf.GetResource(FeedUtils.RSS_SY_NS + &quot;updatePeriod&quot;);</span>
<a href="#l5.1317"></a><span id="l5.1317">       updatePeriod = this.getRDFTargetValue(aDS, aChannel, tag) || &quot;&quot;;</span>
<a href="#l5.1318"></a><span id="l5.1318">       tag = FeedUtils.rdf.GetResource(FeedUtils.RSS_SY_NS + &quot;updateFrequency&quot;);</span>
<a href="#l5.1319"></a><span id="l5.1319">       updateFrequency = this.getRDFTargetValue(aDS, aChannel, tag) || &quot;&quot;;</span>
<a href="#l5.1320"></a><span id="l5.1320">       tag = FeedUtils.rdf.GetResource(FeedUtils.RSS_SY_NS + &quot;updateBase&quot;);</span>
<a href="#l5.1321"></a><span id="l5.1321">       updateBase = this.getRDFTargetValue(aDS, aChannel, tag) || &quot;&quot;;</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineminus">-    }</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineminus">-    else</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineminus">-    {</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+    } else {</span>
<a href="#l5.1326"></a><span id="l5.1326">       tag = this.childrenByTagNameNS(aChannel, FeedUtils.RSS_SY_NS, &quot;updatePeriod&quot;);</span>
<a href="#l5.1327"></a><span id="l5.1327">       updatePeriod = this.getNodeValue(tag ? tag[0] : null) || &quot;&quot;;</span>
<a href="#l5.1328"></a><span id="l5.1328">       tag = this.childrenByTagNameNS(aChannel, FeedUtils.RSS_SY_NS, &quot;updateFrequency&quot;);</span>
<a href="#l5.1329"></a><span id="l5.1329">       updateFrequency = this.getNodeValue(tag ? tag[0] : null) || &quot;&quot;;</span>
<a href="#l5.1330"></a><span id="l5.1330">       tag = this.childrenByTagNameNS(aChannel, FeedUtils.RSS_SY_NS, &quot;updateBase&quot;);</span>
<a href="#l5.1331"></a><span id="l5.1331">       updateBase = this.getNodeValue(tag ? tag[0] : null) || &quot;&quot;;</span>
<a href="#l5.1332"></a><span id="l5.1332">     }</span>
<a href="#l5.1333"></a><span id="l5.1333">     FeedUtils.log.debug(&quot;FeedParser.findSyUpdateTags: updatePeriod:updateFrequency - &quot; +</span>
<a href="#l5.1334"></a><span id="l5.1334">                         updatePeriod + &quot;:&quot; + updateFrequency);</span>
<a href="#l5.1335"></a><span id="l5.1335"> </span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineminus">-    if (updatePeriod)</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineminus">-    {</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineminus">-      if (FeedUtils.RSS_SY_UNITS.includes(updatePeriod.toLowerCase()))</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+    if (updatePeriod) {</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+      if (FeedUtils.RSS_SY_UNITS.includes(updatePeriod.toLowerCase())) {</span>
<a href="#l5.1341"></a><span id="l5.1341">         updatePeriod = updatePeriod.toLowerCase();</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineminus">-      else</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+      } else {</span>
<a href="#l5.1344"></a><span id="l5.1344">         updatePeriod = &quot;daily&quot;;</span>
<a href="#l5.1345"></a><span id="l5.1345" class="difflineplus">+      }</span>
<a href="#l5.1346"></a><span id="l5.1346">     }</span>
<a href="#l5.1347"></a><span id="l5.1347"> </span>
<a href="#l5.1348"></a><span id="l5.1348">     updateFrequency = isNaN(updateFrequency) ? 1 : updateFrequency;</span>
<a href="#l5.1349"></a><span id="l5.1349"> </span>
<a href="#l5.1350"></a><span id="l5.1350">     let options = aFeed.options;</span>
<a href="#l5.1351"></a><span id="l5.1351">     if (options.updates.updatePeriod == updatePeriod &amp;&amp;</span>
<a href="#l5.1352"></a><span id="l5.1352">         options.updates.updateFrequency == updateFrequency &amp;&amp;</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineminus">-        options.updates.updateBase == updateBase)</span>
<a href="#l5.1354"></a><span id="l5.1354" class="difflineplus">+        options.updates.updateBase == updateBase) {</span>
<a href="#l5.1355"></a><span id="l5.1355">       return;</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineplus">+    }</span>
<a href="#l5.1357"></a><span id="l5.1357"> </span>
<a href="#l5.1358"></a><span id="l5.1358">     options.updates.updatePeriod = updatePeriod;</span>
<a href="#l5.1359"></a><span id="l5.1359">     options.updates.updateFrequency = updateFrequency;</span>
<a href="#l5.1360"></a><span id="l5.1360">     options.updates.updateBase = updateBase;</span>
<a href="#l5.1361"></a><span id="l5.1361">     aFeed.options = options;</span>
<a href="#l5.1362"></a><span id="l5.1362">   },</span>
<a href="#l5.1363"></a><span id="l5.1363"> </span>
<a href="#l5.1364"></a><span id="l5.1364">   /**</span>
<a href="#l5.1365"></a><span id="l5.1365">    * Remove unprintable ascii, particularly CR/LF, for non formatted tag values.</span>
<a href="#l5.1366"></a><span id="l5.1366">    *</span>
<a href="#l5.1367"></a><span id="l5.1367">    * @param {String} s - String to clean.</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineminus">-   * @return {String}</span>
<a href="#l5.1369"></a><span id="l5.1369" class="difflineplus">+   * @returns {String} - Cleaned string.</span>
<a href="#l5.1370"></a><span id="l5.1370">    */</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineminus">-  removeUnprintableASCII: function(s)</span>
<a href="#l5.1372"></a><span id="l5.1372" class="difflineminus">-  {</span>
<a href="#l5.1373"></a><span id="l5.1373" class="difflineplus">+  removeUnprintableASCII(s) {</span>
<a href="#l5.1374"></a><span id="l5.1374" class="difflineplus">+    /* eslint-disable-next-line no-control-regex */</span>
<a href="#l5.1375"></a><span id="l5.1375">     return s ? s.replace(/[\x00-\x1F\x7F]+/g, &quot;&quot;) : &quot;&quot;;</span>
<a href="#l5.1376"></a><span id="l5.1376">   },</span>
<a href="#l5.1377"></a><span id="l5.1377"> </span>
<a href="#l5.1378"></a><span id="l5.1378">   /**</span>
<a href="#l5.1379"></a><span id="l5.1379">    * Remove unprintable ascii, except CR/LF/TAB, for formatted tag values.</span>
<a href="#l5.1380"></a><span id="l5.1380">    *</span>
<a href="#l5.1381"></a><span id="l5.1381">    * @param {String} s - String to clean.</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineminus">-   * @return {String}</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineplus">+   * @returns {String} - Cleaned string.</span>
<a href="#l5.1384"></a><span id="l5.1384">    */</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineminus">-  removeUnprintableASCIIexCRLFTAB: function(s)</span>
<a href="#l5.1386"></a><span id="l5.1386" class="difflineminus">-  {</span>
<a href="#l5.1387"></a><span id="l5.1387" class="difflineplus">+  removeUnprintableASCIIexCRLFTAB(s) {</span>
<a href="#l5.1388"></a><span id="l5.1388" class="difflineplus">+    /* eslint-disable-next-line no-control-regex */</span>
<a href="#l5.1389"></a><span id="l5.1389">     return s ? s.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]+/g, &quot;&quot;) : &quot;&quot;;</span>
<a href="#l5.1390"></a><span id="l5.1390">   },</span>
<a href="#l5.1391"></a><span id="l5.1391"> </span>
<a href="#l5.1392"></a><span id="l5.1392" class="difflineminus">-  stripTags: function(someHTML)</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineminus">-  {</span>
<a href="#l5.1394"></a><span id="l5.1394" class="difflineplus">+  stripTags(someHTML) {</span>
<a href="#l5.1395"></a><span id="l5.1395">     return someHTML ? someHTML.replace(/&lt;[^&gt;]+&gt;/g, &quot;&quot;) : someHTML;</span>
<a href="#l5.1396"></a><span id="l5.1396">   },</span>
<a href="#l5.1397"></a><span id="l5.1397"> </span>
<a href="#l5.1398"></a><span id="l5.1398" class="difflineminus">-  xmlUnescape: function(s)</span>
<a href="#l5.1399"></a><span id="l5.1399" class="difflineminus">-  {</span>
<a href="#l5.1400"></a><span id="l5.1400" class="difflineplus">+  xmlUnescape(s) {</span>
<a href="#l5.1401"></a><span id="l5.1401">     s = s.replace(/&amp;lt;/g, &quot;&lt;&quot;);</span>
<a href="#l5.1402"></a><span id="l5.1402">     s = s.replace(/&amp;gt;/g, &quot;&gt;&quot;);</span>
<a href="#l5.1403"></a><span id="l5.1403">     s = s.replace(/&amp;amp;/g, &quot;&amp;&quot;);</span>
<a href="#l5.1404"></a><span id="l5.1404">     return s;</span>
<a href="#l5.1405"></a><span id="l5.1405">   },</span>
<a href="#l5.1406"></a><span id="l5.1406"> </span>
<a href="#l5.1407"></a><span id="l5.1407" class="difflineminus">-  xmlEscape: function(s)</span>
<a href="#l5.1408"></a><span id="l5.1408" class="difflineminus">-  {</span>
<a href="#l5.1409"></a><span id="l5.1409" class="difflineplus">+  xmlEscape(s) {</span>
<a href="#l5.1410"></a><span id="l5.1410">     s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l5.1411"></a><span id="l5.1411">     s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l5.1412"></a><span id="l5.1412">     s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l5.1413"></a><span id="l5.1413">     return s;</span>
<a href="#l5.1414"></a><span id="l5.1414">   },</span>
<a href="#l5.1415"></a><span id="l5.1415"> </span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineminus">-  dateRescue: function(dateString)</span>
<a href="#l5.1417"></a><span id="l5.1417" class="difflineminus">-  {</span>
<a href="#l5.1418"></a><span id="l5.1418" class="difflineplus">+  dateRescue(dateString) {</span>
<a href="#l5.1419"></a><span id="l5.1419">     // Deal with various kinds of invalid dates.</span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineminus">-    if (!isNaN(parseInt(dateString)))</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineminus">-    {</span>
<a href="#l5.1422"></a><span id="l5.1422" class="difflineplus">+    if (!isNaN(parseInt(dateString))) {</span>
<a href="#l5.1423"></a><span id="l5.1423">       // It's an integer, so maybe it's a timestamp.</span>
<a href="#l5.1424"></a><span id="l5.1424">       let d = new Date(parseInt(dateString) * 1000);</span>
<a href="#l5.1425"></a><span id="l5.1425">       let now = new Date();</span>
<a href="#l5.1426"></a><span id="l5.1426">       let yeardiff = now.getFullYear() - d.getFullYear();</span>
<a href="#l5.1427"></a><span id="l5.1427">       FeedUtils.log.trace(&quot;FeedParser.dateRescue: Rescue Timestamp date - &quot; +</span>
<a href="#l5.1428"></a><span id="l5.1428">                           d.toString() + &quot; ,year diff - &quot; + yeardiff);</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineminus">-      if (yeardiff &gt;= 0 &amp;&amp; yeardiff &lt; 3)</span>
<a href="#l5.1430"></a><span id="l5.1430" class="difflineplus">+      if (yeardiff &gt;= 0 &amp;&amp; yeardiff &lt; 3) {</span>
<a href="#l5.1431"></a><span id="l5.1431">         // It's quite likely the correct date.</span>
<a href="#l5.1432"></a><span id="l5.1432">         return d.toString();</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineplus">+      }</span>
<a href="#l5.1434"></a><span id="l5.1434">     }</span>
<a href="#l5.1435"></a><span id="l5.1435"> </span>
<a href="#l5.1436"></a><span id="l5.1436">     // Could be an ISO8601/W3C date.  If not, get the current time.</span>
<a href="#l5.1437"></a><span id="l5.1437">     return FeedUtils.getValidRFC5322Date(dateString);</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineminus">-  }</span>
<a href="#l5.1439"></a><span id="l5.1439" class="difflineplus">+  },</span>
<a href="#l5.1440"></a><span id="l5.1440"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -12,692 +12,673 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l6.4"></a><span id="l6.4"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> var FeedSubscriptions = {</span>
<a href="#l6.7"></a><span id="l6.7">   get mMainWin() { return Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;); },</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   get mTree() { return document.getElementById(&quot;rssSubscriptionsList&quot;); },</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   mFeedContainers: [],</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  mRSSServer     : null,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  mActionMode    : null,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  kSubscribeMode : 1,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  kUpdateMode    : 2,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  kMoveMode      : 3,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  kCopyMode      : 4,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  kImportingOPML : 5,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  kVerifyUrlMode : 6,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  get FOLDER_ACTIONS()</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  mRSSServer:      null,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  mActionMode:     null,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  kSubscribeMode:  1,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  kUpdateMode:     2,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  kMoveMode:       3,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  kCopyMode:       4,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  kImportingOPML:  5,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  kVerifyUrlMode:  6,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  get FOLDER_ACTIONS() {</span>
<a href="#l6.33"></a><span id="l6.33">     return Ci.nsIMsgFolderNotificationService.folderAdded |</span>
<a href="#l6.34"></a><span id="l6.34">            Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l6.35"></a><span id="l6.35">            Ci.nsIMsgFolderNotificationService.folderRenamed |</span>
<a href="#l6.36"></a><span id="l6.36">            Ci.nsIMsgFolderNotificationService.folderMoveCopyCompleted;</span>
<a href="#l6.37"></a><span id="l6.37">   },</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  onLoad: function ()</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  onLoad() {</span>
<a href="#l6.42"></a><span id="l6.42">     // Extract the folder argument.</span>
<a href="#l6.43"></a><span id="l6.43">     let folder;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    if (window.arguments &amp;&amp; window.arguments[0].folder)</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    if (window.arguments &amp;&amp; window.arguments[0].folder) {</span>
<a href="#l6.46"></a><span id="l6.46">       folder = window.arguments[0].folder;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    }</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">     // Ensure dialog is fully loaded before selecting, to get visible row.</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    setTimeout(function() {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-      FeedSubscriptions.refreshSubscriptionView(folder)</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    setTimeout(() =&gt; {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+      FeedSubscriptions.refreshSubscriptionView(folder);</span>
<a href="#l6.54"></a><span id="l6.54">     }, 100);</span>
<a href="#l6.55"></a><span id="l6.55">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-loading&quot;);</span>
<a href="#l6.56"></a><span id="l6.56">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">     FeedUtils.CANCEL_REQUESTED = false;</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    if (this.mMainWin)</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    if (this.mMainWin) {</span>
<a href="#l6.63"></a><span id="l6.63">       this.mMainWin.FeedFolderNotificationService = MailServices.mfn;</span>
<a href="#l6.64"></a><span id="l6.64">       this.mMainWin.FeedFolderNotificationService</span>
<a href="#l6.65"></a><span id="l6.65">                    .addListener(this.FolderListener, this.FOLDER_ACTIONS);</span>
<a href="#l6.66"></a><span id="l6.66">     }</span>
<a href="#l6.67"></a><span id="l6.67">   },</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  onClose: function ()</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  onClose() {</span>
<a href="#l6.72"></a><span id="l6.72">     let dismissDialog = true;</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">     // If we are in the middle of subscribing to a feed, inform the user that</span>
<a href="#l6.75"></a><span id="l6.75">     // dismissing the dialog right now will abort the feed subscription.</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-    if (this.mActionMode == this.kSubscribeMode)</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    {</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    if (this.mActionMode == this.kSubscribeMode) {</span>
<a href="#l6.79"></a><span id="l6.79">       let pTitle = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.80"></a><span id="l6.80">                      &quot;subscribe-cancelSubscriptionTitle&quot;);</span>
<a href="#l6.81"></a><span id="l6.81">       let pMessage = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.82"></a><span id="l6.82">                        &quot;subscribe-cancelSubscription&quot;);</span>
<a href="#l6.83"></a><span id="l6.83">       dismissDialog =</span>
<a href="#l6.84"></a><span id="l6.84">         !(Services.prompt.confirmEx(window, pTitle, pMessage,</span>
<a href="#l6.85"></a><span id="l6.85">                                     Ci.nsIPromptService.STD_YES_NO_BUTTONS,</span>
<a href="#l6.86"></a><span id="l6.86">                                     null, null, null, null, { }));</span>
<a href="#l6.87"></a><span id="l6.87">     }</span>
<a href="#l6.88"></a><span id="l6.88"> </span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    if (dismissDialog)</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    if (dismissDialog) {</span>
<a href="#l6.92"></a><span id="l6.92">       FeedUtils.CANCEL_REQUESTED = this.mActionMode == this.kSubscribeMode;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-      if (this.mMainWin)</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-      {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+      if (this.mMainWin) {</span>
<a href="#l6.96"></a><span id="l6.96">         this.mMainWin.FeedFolderNotificationService</span>
<a href="#l6.97"></a><span id="l6.97">                      .removeListener(this.FolderListener, this.FOLDER_ACTIONS);</span>
<a href="#l6.98"></a><span id="l6.98">         delete this.mMainWin.FeedFolderNotificationService;</span>
<a href="#l6.99"></a><span id="l6.99">       }</span>
<a href="#l6.100"></a><span id="l6.100">     }</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102">     return dismissDialog;</span>
<a href="#l6.103"></a><span id="l6.103">   },</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  refreshSubscriptionView: function(aSelectFolder, aSelectFeedUrl)</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  {</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  refreshSubscriptionView(aSelectFolder, aSelectFeedUrl) {</span>
<a href="#l6.108"></a><span id="l6.108">     let item = this.mView.currentItem;</span>
<a href="#l6.109"></a><span id="l6.109">     this.loadSubscriptions();</span>
<a href="#l6.110"></a><span id="l6.110">     this.mTree.view = this.mView;</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    if (aSelectFolder &amp;&amp; !aSelectFeedUrl)</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    if (aSelectFolder &amp;&amp; !aSelectFeedUrl) {</span>
<a href="#l6.114"></a><span id="l6.114">       this.selectFolder(aSelectFolder);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    else</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    {</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    } else if (item) {</span>
<a href="#l6.118"></a><span id="l6.118">       // If no folder to select, try to select the pre rebuild selection, in</span>
<a href="#l6.119"></a><span id="l6.119">       // an existing window.  For folderpane changes in a feed account.</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-      if (item)</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-      {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-        let rootFolder = item.container ? item.folder.rootFolder :</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-                                          item.parentFolder.rootFolder;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-        if (item.container)</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-        {</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-          if (!this.selectFolder(item.folder, { open: item.open }))</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-            // The item no longer exists, an ancestor folder was deleted or</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-            // renamed/moved.</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-            this.selectFolder(rootFolder);</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+      let rootFolder = item.container ? item.folder.rootFolder :</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+                                        item.parentFolder.rootFolder;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+      if (item.container) {</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+        if (!this.selectFolder(item.folder, { open: item.open })) {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+          // The item no longer exists, an ancestor folder was deleted or</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+          // renamed/moved.</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+          this.selectFolder(rootFolder);</span>
<a href="#l6.137"></a><span id="l6.137">         }</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-        else {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-          let url = item.parentFolder == aSelectFolder ? aSelectFeedUrl :</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-                                                         item.url;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-          this.selectFeed({ folder: rootFolder, url: url }, null);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-        }</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+      } else {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+        let url = item.parentFolder == aSelectFolder ? aSelectFeedUrl :</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+                                                       item.url;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+        this.selectFeed({ folder: rootFolder, url }, null);</span>
<a href="#l6.147"></a><span id="l6.147">       }</span>
<a href="#l6.148"></a><span id="l6.148">     }</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150">     this.mView.treeBox.ensureRowIsVisible(this.mView.selection.currentIndex);</span>
<a href="#l6.151"></a><span id="l6.151">     this.clearStatusInfo();</span>
<a href="#l6.152"></a><span id="l6.152">   },</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-  mView:</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-  {</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+  mView: {</span>
<a href="#l6.157"></a><span id="l6.157">     kRowIndexUndefined: -1,</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">     get currentItem() {</span>
<a href="#l6.160"></a><span id="l6.160">       // Get the current selection, if any.</span>
<a href="#l6.161"></a><span id="l6.161">       let seln = this.selection;</span>
<a href="#l6.162"></a><span id="l6.162">       let currentSelectionIndex = seln ? seln.currentIndex : null;</span>
<a href="#l6.163"></a><span id="l6.163">       let item;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-      if (currentSelectionIndex != null)</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      if (currentSelectionIndex != null) {</span>
<a href="#l6.166"></a><span id="l6.166">         item = this.getItemAtIndex(currentSelectionIndex);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+      }</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169">       return item;</span>
<a href="#l6.170"></a><span id="l6.170">     },</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172">     /* nsITreeView */</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+    /* eslint-disable no-multi-spaces */</span>
<a href="#l6.174"></a><span id="l6.174">     treeBox: null,</span>
<a href="#l6.175"></a><span id="l6.175"> </span>
<a href="#l6.176"></a><span id="l6.176">     mRowCount: 0,</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-    get rowCount()                         { return this.mRowCount; },</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    _selection: null,</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    get selection ()                       { return this._selection; },</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    set selection (val)                    { return this._selection = val; },</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    setTree: function(aTreebox)            { this.treeBox = aTreebox; },</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    isSeparator: function(aRow)            { return false; },</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    isSorted: function()                   { return false; },</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    isSelectable: function(aRow, aColumn)  { return false; },</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    isEditable: function (aRow, aColumn)   { return false; },</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    getProgressMode : function(aRow, aCol) {},</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    cycleHeader: function(aCol)            {},</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-    cycleCell: function(aRow, aCol)        {},</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    selectionChanged: function()           {},</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    performAction: function(aAction)       {},</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    performActionOnRow: function (aAction, aRow)       {},</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    performActionOnCell: function(aAction, aRow, aCol) {},</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    getRowProperties: function(aRow)                   { return &quot;&quot;; },</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-    getColumnProperties: function(aCol)                { return &quot;&quot;; },</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    getCellValue: function (aRow, aColumn)             {},</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    setCellValue: function (aRow, aColumn, aValue)     {},</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    setCellText: function (aRow, aColumn, aValue)      {},</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    getCellProperties: function (aRow, aColumn) {</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    get rowCount()               { return this.mRowCount; },</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    _selection:                  null,</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    get selection()              { return this._selection; },</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+    set selection(val)           { return this._selection = val; },</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+    setTree(aTreebox)            { this.treeBox = aTreebox; },</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+    isSeparator(aRow)            { return false; },</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    isSorted()                   { return false; },</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+    isSelectable(aRow, aColumn)  { return false; },</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    isEditable(aRow, aColumn)    { return false; },</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    getProgressMode(aRow, aCol)  {},</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    cycleHeader(aCol)            {},</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    cycleCell(aRow, aCol)        {},</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+    selectionChanged()           {},</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+    performAction(aAction)       {},</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    performActionOnRow(aAction, aRow)        {},</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+    performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+    getRowProperties(aRow)                   { return &quot;&quot;; },</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+    getColumnProperties(aCol)                { return &quot;&quot;; },</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+    getCellValue(aRow, aColumn)              {},</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+    setCellValue(aRow, aColumn, aValue)      {},</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+    setCellText(aRow, aColumn, aValue)       {},</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+    /* eslint-enable no-multi-spaces */</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+    getCellProperties(aRow, aColumn) {</span>
<a href="#l6.230"></a><span id="l6.230">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-      if (!item)</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-        return;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-      if (AppConstants.MOZ_APP_NAME != &quot;thunderbird&quot;)</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-      {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-        return !item.folder ? &quot;serverType-rss&quot; :</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-               item.folder.isServer ? &quot;serverType-rss isServer-true&quot; : &quot;livemark&quot;;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+      if (!item) {</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+      }</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+      if (AppConstants.MOZ_APP_NAME != &quot;thunderbird&quot;) {</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+        if (!item.folder) {</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+          return &quot;serverType-rss&quot;;</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+        } else if (item.folder.isServer) {</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+          return &quot;serverType-rss isServer-true&quot;;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+        }</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+        return &quot;livemark&quot;;</span>
<a href="#l6.250"></a><span id="l6.250">       }</span>
<a href="#l6.251"></a><span id="l6.251"> </span>
<a href="#l6.252"></a><span id="l6.252">       let folder = item.folder;</span>
<a href="#l6.253"></a><span id="l6.253">       let properties = &quot;folderNameCol&quot;;</span>
<a href="#l6.254"></a><span id="l6.254">       let mainWin = FeedSubscriptions.mMainWin;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-      if (!mainWin)</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-      {</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+      if (!mainWin) {</span>
<a href="#l6.258"></a><span id="l6.258">         let hasFeeds = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-        properties += !folder ? &quot; isFeed-true&quot; :</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-                      hasFeeds ? &quot; isFeedFolder-true&quot; :</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-                      folder.isServer ? &quot; serverType-rss isServer-true&quot; : &quot;&quot;;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-      }</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-      else</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-      {</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+        if (!folder) {</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+          properties += &quot; isFeed-true&quot;;</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+        } else if (hasFeeds) {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+          properties += &quot; isFeedFolder-true&quot;;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+        } else if (folder.isServer) {</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+          properties += &quot; serverType-rss isServer-true&quot;;</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+        }</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+      } else {</span>
<a href="#l6.273"></a><span id="l6.273">         let url = folder ? null : item.url;</span>
<a href="#l6.274"></a><span id="l6.274">         folder = folder || item.parentFolder;</span>
<a href="#l6.275"></a><span id="l6.275">         properties += mainWin.FeedUtils.getFolderProperties(folder, url);</span>
<a href="#l6.276"></a><span id="l6.276">         if (this.selection.currentIndex == aRow &amp;&amp; url &amp;&amp;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-            item.options.updates.enabled &amp;&amp; properties.includes(&quot;isPaused&quot;))</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-        {</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+            item.options.updates.enabled &amp;&amp; properties.includes(&quot;isPaused&quot;)) {</span>
<a href="#l6.280"></a><span id="l6.280">           item.options.updates.enabled = false;</span>
<a href="#l6.281"></a><span id="l6.281">           FeedSubscriptions.updateFeedData(item);</span>
<a href="#l6.282"></a><span id="l6.282">         }</span>
<a href="#l6.283"></a><span id="l6.283">       }</span>
<a href="#l6.284"></a><span id="l6.284"> </span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-      item[&quot;properties&quot;] = properties;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+      item.properties = properties;</span>
<a href="#l6.287"></a><span id="l6.287">       return properties;</span>
<a href="#l6.288"></a><span id="l6.288">     },</span>
<a href="#l6.289"></a><span id="l6.289"> </span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-    isContainer: function (aRow)</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-    {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    isContainer(aRow) {</span>
<a href="#l6.293"></a><span id="l6.293">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.294"></a><span id="l6.294">       return item ? item.container : false;</span>
<a href="#l6.295"></a><span id="l6.295">     },</span>
<a href="#l6.296"></a><span id="l6.296"> </span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-    isContainerOpen: function (aRow)</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-    {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+    isContainerOpen(aRow) {</span>
<a href="#l6.300"></a><span id="l6.300">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.301"></a><span id="l6.301">       return item ? item.open : false;</span>
<a href="#l6.302"></a><span id="l6.302">     },</span>
<a href="#l6.303"></a><span id="l6.303"> </span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-    isContainerEmpty: function (aRow)</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-    {</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+    isContainerEmpty(aRow) {</span>
<a href="#l6.307"></a><span id="l6.307">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-      if (!item)</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+      if (!item) {</span>
<a href="#l6.310"></a><span id="l6.310">         return false;</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+      }</span>
<a href="#l6.312"></a><span id="l6.312"> </span>
<a href="#l6.313"></a><span id="l6.313">       return item.children.length == 0;</span>
<a href="#l6.314"></a><span id="l6.314">     },</span>
<a href="#l6.315"></a><span id="l6.315"> </span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-    getItemAtIndex: function (aRow)</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-    {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-      if (aRow &lt; 0 || aRow &gt;= FeedSubscriptions.mFeedContainers.length)</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+    getItemAtIndex(aRow) {</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+      if (aRow &lt; 0 || aRow &gt;= FeedSubscriptions.mFeedContainers.length) {</span>
<a href="#l6.321"></a><span id="l6.321">         return null;</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+      }</span>
<a href="#l6.323"></a><span id="l6.323"> </span>
<a href="#l6.324"></a><span id="l6.324">       return FeedSubscriptions.mFeedContainers[aRow];</span>
<a href="#l6.325"></a><span id="l6.325">     },</span>
<a href="#l6.326"></a><span id="l6.326"> </span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-    getItemInViewIndex: function(aFolder)</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-    {</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-      if (!aFolder || !(aFolder instanceof Ci.nsIMsgFolder))</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+    getItemInViewIndex(aFolder) {</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+      if (!aFolder || !(aFolder instanceof Ci.nsIMsgFolder)) {</span>
<a href="#l6.332"></a><span id="l6.332">         return null;</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-      for (let index = 0; index &lt; this.rowCount; index++)</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-      {</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+      }</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+      for (let index = 0; index &lt; this.rowCount; index++) {</span>
<a href="#l6.339"></a><span id="l6.339">         // Find the visible folder in the view.</span>
<a href="#l6.340"></a><span id="l6.340">         let item = this.getItemAtIndex(index);</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-        if (item &amp;&amp; item.container &amp;&amp; item.url == aFolder.URI)</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+        if (item &amp;&amp; item.container &amp;&amp; item.url == aFolder.URI) {</span>
<a href="#l6.343"></a><span id="l6.343">           return index;</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+        }</span>
<a href="#l6.345"></a><span id="l6.345">       }</span>
<a href="#l6.346"></a><span id="l6.346"> </span>
<a href="#l6.347"></a><span id="l6.347">       return null;</span>
<a href="#l6.348"></a><span id="l6.348">     },</span>
<a href="#l6.349"></a><span id="l6.349"> </span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-    removeItemAtIndex: function (aRow, aNoSelect)</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+    removeItemAtIndex(aRow, aNoSelect) {</span>
<a href="#l6.353"></a><span id="l6.353">       let itemToRemove = this.getItemAtIndex(aRow);</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-      if (!itemToRemove)</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+      if (!itemToRemove) {</span>
<a href="#l6.356"></a><span id="l6.356">         return;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-      if (itemToRemove.container &amp;&amp; itemToRemove.open)</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+      }</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+      if (itemToRemove.container &amp;&amp; itemToRemove.open) {</span>
<a href="#l6.362"></a><span id="l6.362">         // Close it, if open container.</span>
<a href="#l6.363"></a><span id="l6.363">         this.toggleOpenState(aRow);</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+      }</span>
<a href="#l6.365"></a><span id="l6.365"> </span>
<a href="#l6.366"></a><span id="l6.366">       let parentIndex = this.getParentIndex(aRow);</span>
<a href="#l6.367"></a><span id="l6.367">       let hasNextSibling = this.hasNextSibling(aRow, aRow);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-      if (parentIndex != this.kRowIndexUndefined)</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-      {</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+      if (parentIndex != this.kRowIndexUndefined) {</span>
<a href="#l6.371"></a><span id="l6.371">         let parent = this.getItemAtIndex(parentIndex);</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-        if (parent)</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-        {</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-          for (let index = 0; index &lt; parent.children.length; index++)</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-            if (parent.children[index] == itemToRemove)</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-            {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+        if (parent) {</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+          for (let index = 0; index &lt; parent.children.length; index++) {</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+            if (parent.children[index] == itemToRemove) {</span>
<a href="#l6.380"></a><span id="l6.380">               parent.children.splice(index, 1);</span>
<a href="#l6.381"></a><span id="l6.381">               break;</span>
<a href="#l6.382"></a><span id="l6.382">             }</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+          }</span>
<a href="#l6.384"></a><span id="l6.384">         }</span>
<a href="#l6.385"></a><span id="l6.385">       }</span>
<a href="#l6.386"></a><span id="l6.386"> </span>
<a href="#l6.387"></a><span id="l6.387">       // Now remove it from our view.</span>
<a href="#l6.388"></a><span id="l6.388">       FeedSubscriptions.mFeedContainers.splice(aRow, 1);</span>
<a href="#l6.389"></a><span id="l6.389"> </span>
<a href="#l6.390"></a><span id="l6.390">       // Now invalidate the correct tree rows.</span>
<a href="#l6.391"></a><span id="l6.391">       this.mRowCount--;</span>
<a href="#l6.392"></a><span id="l6.392">       this.treeBox.rowCountChanged(aRow, -1);</span>
<a href="#l6.393"></a><span id="l6.393"> </span>
<a href="#l6.394"></a><span id="l6.394">       // Now update the selection position, unless noSelect (selection is</span>
<a href="#l6.395"></a><span id="l6.395">       // done later or not at all).  If the item is the last child, select the</span>
<a href="#l6.396"></a><span id="l6.396">       // parent.  Otherwise select the next sibling.</span>
<a href="#l6.397"></a><span id="l6.397">       if (!aNoSelect) {</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-        if (aRow &lt;= FeedSubscriptions.mFeedContainers.length)</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+        if (aRow &lt;= FeedSubscriptions.mFeedContainers.length) {</span>
<a href="#l6.400"></a><span id="l6.400">           this.selection.select(hasNextSibling ? aRow : aRow - 1);</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-        else</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+        } else {</span>
<a href="#l6.403"></a><span id="l6.403">           this.selection.clearSelection();</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+        }</span>
<a href="#l6.405"></a><span id="l6.405">       }</span>
<a href="#l6.406"></a><span id="l6.406"> </span>
<a href="#l6.407"></a><span id="l6.407">       // Now refocus the tree.</span>
<a href="#l6.408"></a><span id="l6.408">       FeedSubscriptions.mTree.focus();</span>
<a href="#l6.409"></a><span id="l6.409">     },</span>
<a href="#l6.410"></a><span id="l6.410"> </span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-    getCellText: function (aRow, aColumn)</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-    {</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+    getCellText(aRow, aColumn) {</span>
<a href="#l6.414"></a><span id="l6.414">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.415"></a><span id="l6.415">       return (item &amp;&amp; aColumn.id == &quot;folderNameCol&quot;) ? item.name : &quot;&quot;;</span>
<a href="#l6.416"></a><span id="l6.416">     },</span>
<a href="#l6.417"></a><span id="l6.417"> </span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-    getImageSrc: function(aRow, aCol)</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-    {</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+    getImageSrc(aRow, aCol) {</span>
<a href="#l6.421"></a><span id="l6.421">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-      if ((item.folder &amp;&amp; item.folder.isServer) || item.open)</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+      if ((item.folder &amp;&amp; item.folder.isServer) || item.open) {</span>
<a href="#l6.424"></a><span id="l6.424">         return &quot;&quot;;</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+      }</span>
<a href="#l6.426"></a><span id="l6.426"> </span>
<a href="#l6.427"></a><span id="l6.427">       if (!item.open &amp;&amp;</span>
<a href="#l6.428"></a><span id="l6.428">           (item.properties.includes(&quot;hasError&quot;) ||</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-           item.properties.includes(&quot;isBusy&quot;)))</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+           item.properties.includes(&quot;isBusy&quot;))) {</span>
<a href="#l6.431"></a><span id="l6.431">         return &quot;&quot;;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-      if (item.favicon != null)</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+      }</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+      if (item.favicon != null) {</span>
<a href="#l6.437"></a><span id="l6.437">         return item.favicon;</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+      }</span>
<a href="#l6.439"></a><span id="l6.439"> </span>
<a href="#l6.440"></a><span id="l6.440">       if (item.folder &amp;&amp; FeedSubscriptions.mMainWin &amp;&amp;</span>
<a href="#l6.441"></a><span id="l6.441">           &quot;gFolderTreeView&quot; in FeedSubscriptions.mMainWin) {</span>
<a href="#l6.442"></a><span id="l6.442">         let favicon = FeedSubscriptions.mMainWin.gFolderTreeView</span>
<a href="#l6.443"></a><span id="l6.443">                                        .getFolderCacheProperty(item.folder, &quot;favicon&quot;);</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-        if (favicon != null)</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+        if (favicon != null) {</span>
<a href="#l6.446"></a><span id="l6.446">           return item.favicon = favicon;</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+        }</span>
<a href="#l6.448"></a><span id="l6.448">       }</span>
<a href="#l6.449"></a><span id="l6.449"> </span>
<a href="#l6.450"></a><span id="l6.450">       let callback = (iconUrl =&gt; {</span>
<a href="#l6.451"></a><span id="l6.451">         item.favicon = iconUrl;</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-        if (item.folder)</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-        {</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-          for (let child of item.children)</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-            if (!child.container)</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-            {</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+        if (item.folder) {</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+          for (let child of item.children) {</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+            if (!child.container) {</span>
<a href="#l6.460"></a><span id="l6.460">               child.favicon = iconUrl;</span>
<a href="#l6.461"></a><span id="l6.461">               break;</span>
<a href="#l6.462"></a><span id="l6.462">             }</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+          }</span>
<a href="#l6.464"></a><span id="l6.464">         }</span>
<a href="#l6.465"></a><span id="l6.465"> </span>
<a href="#l6.466"></a><span id="l6.466">         this.selection.tree.invalidateRow(aRow);</span>
<a href="#l6.467"></a><span id="l6.467">       });</span>
<a href="#l6.468"></a><span id="l6.468"> </span>
<a href="#l6.469"></a><span id="l6.469">       // A closed non server folder.</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-      if (item.folder)</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-      {</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-        for (let child of item.children)</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-        {</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+      if (item.folder) {</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+        for (let child of item.children) {</span>
<a href="#l6.476"></a><span id="l6.476">           if (!child.container) {</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-            if (child.favicon != null)</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+            if (child.favicon != null) {</span>
<a href="#l6.479"></a><span id="l6.479">               return child.favicon;</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+            }</span>
<a href="#l6.481"></a><span id="l6.481"> </span>
<a href="#l6.482"></a><span id="l6.482">             setTimeout(() =&gt; {</span>
<a href="#l6.483"></a><span id="l6.483">               FeedUtils.getFavicon(child.parentFolder, child.url, null,</span>
<a href="#l6.484"></a><span id="l6.484">                                    window, callback);</span>
<a href="#l6.485"></a><span id="l6.485">             }, 0);</span>
<a href="#l6.486"></a><span id="l6.486">             break;</span>
<a href="#l6.487"></a><span id="l6.487">           }</span>
<a href="#l6.488"></a><span id="l6.488">         }</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-      }</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-      else</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-      {</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+      } else {</span>
<a href="#l6.493"></a><span id="l6.493">         // A feed.</span>
<a href="#l6.494"></a><span id="l6.494">         setTimeout(() =&gt; {</span>
<a href="#l6.495"></a><span id="l6.495">           FeedUtils.getFavicon(item.parentFolder, item.url, null,</span>
<a href="#l6.496"></a><span id="l6.496">                                window, callback);</span>
<a href="#l6.497"></a><span id="l6.497">         }, 0);</span>
<a href="#l6.498"></a><span id="l6.498">       }</span>
<a href="#l6.499"></a><span id="l6.499"> </span>
<a href="#l6.500"></a><span id="l6.500">       // Store empty string to return default while favicons are retrieved.</span>
<a href="#l6.501"></a><span id="l6.501">       return item.favicon = &quot;&quot;;</span>
<a href="#l6.502"></a><span id="l6.502">     },</span>
<a href="#l6.503"></a><span id="l6.503"> </span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-    canDrop: function (aRow, aOrientation)</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-    {</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+    canDrop(aRow, aOrientation) {</span>
<a href="#l6.507"></a><span id="l6.507">       let dropResult = this.extractDragData(aRow);</span>
<a href="#l6.508"></a><span id="l6.508">       return aOrientation == Ci.nsITreeView.DROP_ON &amp;&amp; dropResult.canDrop &amp;&amp;</span>
<a href="#l6.509"></a><span id="l6.509">              (dropResult.dropUrl || dropResult.dropOnIndex != this.kRowIndexUndefined);</span>
<a href="#l6.510"></a><span id="l6.510">     },</span>
<a href="#l6.511"></a><span id="l6.511"> </span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-    drop: function (aRow, aOrientation)</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-    {</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+    drop(aRow, aOrientation) {</span>
<a href="#l6.515"></a><span id="l6.515">       let win = FeedSubscriptions;</span>
<a href="#l6.516"></a><span id="l6.516">       let results = this.extractDragData(aRow);</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-      if (!results.canDrop)</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+      if (!results.canDrop) {</span>
<a href="#l6.519"></a><span id="l6.519">         return;</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+      }</span>
<a href="#l6.521"></a><span id="l6.521"> </span>
<a href="#l6.522"></a><span id="l6.522">       // Preselect the drop folder.</span>
<a href="#l6.523"></a><span id="l6.523">       this.selection.select(aRow);</span>
<a href="#l6.524"></a><span id="l6.524"> </span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-      if (results.dropUrl)</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-      {</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+      if (results.dropUrl) {</span>
<a href="#l6.528"></a><span id="l6.528">         // Don't freeze the app that initiated the drop just because we are</span>
<a href="#l6.529"></a><span id="l6.529">         // in a loop waiting for the user to dimisss the add feed dialog.</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-        setTimeout(function() {</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+        setTimeout(() =&gt; {</span>
<a href="#l6.532"></a><span id="l6.532">           win.addFeed(results.dropUrl, null, true, null, win.kSubscribeMode);</span>
<a href="#l6.533"></a><span id="l6.533">         }, 0);</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+</span>
<a href="#l6.535"></a><span id="l6.535">         let folderItem = this.getItemAtIndex(aRow);</span>
<a href="#l6.536"></a><span id="l6.536">         FeedUtils.log.debug(&quot;drop: folder, url - &quot; +</span>
<a href="#l6.537"></a><span id="l6.537">                             folderItem.folder.name + &quot;, &quot; + results.dropUrl);</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-      }</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-      else if (results.dropOnIndex != this.kRowIndexUndefined)</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-      {</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+      } else if (results.dropOnIndex != this.kRowIndexUndefined) {</span>
<a href="#l6.542"></a><span id="l6.542">         win.moveCopyFeed(results.dropOnIndex, aRow, results.dropEffect);</span>
<a href="#l6.543"></a><span id="l6.543">       }</span>
<a href="#l6.544"></a><span id="l6.544">     },</span>
<a href="#l6.545"></a><span id="l6.545"> </span>
<a href="#l6.546"></a><span id="l6.546">     // Helper function for drag and drop.</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-    extractDragData: function(aRow)</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-    {</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+    extractDragData(aRow) {</span>
<a href="#l6.550"></a><span id="l6.550">       let dt = this._currentDataTransfer;</span>
<a href="#l6.551"></a><span id="l6.551">       let dragDataResults = { canDrop:     false,</span>
<a href="#l6.552"></a><span id="l6.552">                               dropUrl:     null,</span>
<a href="#l6.553"></a><span id="l6.553">                               dropOnIndex: this.kRowIndexUndefined,</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-                              dropEffect:  dt.dropEffect };</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-      if (dt.getData(&quot;text/x-moz-feed-index&quot;))</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-      {</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+                              dropEffect:  dt.dropEffect,</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+                            };</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineplus">+</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineplus">+      if (dt.getData(&quot;text/x-moz-feed-index&quot;)) {</span>
<a href="#l6.562"></a><span id="l6.562">         // Dragging a feed in the tree.</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-        if (this.selection)</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-        {</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineplus">+        if (this.selection) {</span>
<a href="#l6.566"></a><span id="l6.566">           dragDataResults.dropOnIndex = this.selection.currentIndex;</span>
<a href="#l6.567"></a><span id="l6.567"> </span>
<a href="#l6.568"></a><span id="l6.568">           let curItem = this.getItemAtIndex(this.selection.currentIndex);</span>
<a href="#l6.569"></a><span id="l6.569">           let newItem = this.getItemAtIndex(aRow);</span>
<a href="#l6.570"></a><span id="l6.570">           let curServer = curItem &amp;&amp; curItem.parentFolder ?</span>
<a href="#l6.571"></a><span id="l6.571">                             curItem.parentFolder.server : null;</span>
<a href="#l6.572"></a><span id="l6.572">           let newServer = newItem &amp;&amp; newItem.folder ?</span>
<a href="#l6.573"></a><span id="l6.573">                             newItem.folder.server : null;</span>
<a href="#l6.574"></a><span id="l6.574"> </span>
<a href="#l6.575"></a><span id="l6.575">           // No copying within the same account and no moving to the account</span>
<a href="#l6.576"></a><span id="l6.576">           // folder in the same account.</span>
<a href="#l6.577"></a><span id="l6.577">           if (!(curServer == newServer &amp;&amp;</span>
<a href="#l6.578"></a><span id="l6.578">                 (dragDataResults.dropEffect == &quot;copy&quot; ||</span>
<a href="#l6.579"></a><span id="l6.579">                  newItem.folder == curItem.parentFolder ||</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-                 newItem.folder.isServer)))</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+                 newItem.folder.isServer))) {</span>
<a href="#l6.582"></a><span id="l6.582">             dragDataResults.canDrop = true;</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineplus">+          }</span>
<a href="#l6.584"></a><span id="l6.584">         }</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-      }</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-      else</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-      {</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+      } else {</span>
<a href="#l6.589"></a><span id="l6.589">         // Try to get a feed url.</span>
<a href="#l6.590"></a><span id="l6.590">         let validUri = FeedUtils.getFeedUriFromDataTransfer(dt);</span>
<a href="#l6.591"></a><span id="l6.591"> </span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-        if (validUri)</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-        {</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+        if (validUri) {</span>
<a href="#l6.595"></a><span id="l6.595">           dragDataResults.canDrop = true;</span>
<a href="#l6.596"></a><span id="l6.596">           dragDataResults.dropUrl = validUri.spec;</span>
<a href="#l6.597"></a><span id="l6.597">         }</span>
<a href="#l6.598"></a><span id="l6.598">       }</span>
<a href="#l6.599"></a><span id="l6.599"> </span>
<a href="#l6.600"></a><span id="l6.600">       return dragDataResults;</span>
<a href="#l6.601"></a><span id="l6.601">     },</span>
<a href="#l6.602"></a><span id="l6.602"> </span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-    getParentIndex: function (aRow)</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-    {</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineplus">+    getParentIndex(aRow) {</span>
<a href="#l6.606"></a><span id="l6.606">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.607"></a><span id="l6.607"> </span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-      if (item)</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-      {</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-        for (let index = aRow; index &gt;= 0; index--)</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-          if (FeedSubscriptions.mFeedContainers[index].level &lt; item.level)</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+      if (item) {</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+        for (let index = aRow; index &gt;= 0; index--) {</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+          if (FeedSubscriptions.mFeedContainers[index].level &lt; item.level) {</span>
<a href="#l6.615"></a><span id="l6.615">             return index;</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+          }</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+        }</span>
<a href="#l6.618"></a><span id="l6.618">       }</span>
<a href="#l6.619"></a><span id="l6.619"> </span>
<a href="#l6.620"></a><span id="l6.620">       return this.kRowIndexUndefined;</span>
<a href="#l6.621"></a><span id="l6.621">     },</span>
<a href="#l6.622"></a><span id="l6.622"> </span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-    isIndexChildOfParentIndex: function (aRow, aChildRow)</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-    {</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineplus">+    isIndexChildOfParentIndex(aRow, aChildRow) {</span>
<a href="#l6.626"></a><span id="l6.626">       // For visible tree rows, not if items are children of closed folders.</span>
<a href="#l6.627"></a><span id="l6.627">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-      if (!item || aChildRow &lt;= aRow)</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineplus">+      if (!item || aChildRow &lt;= aRow) {</span>
<a href="#l6.630"></a><span id="l6.630">         return false;</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineplus">+      }</span>
<a href="#l6.632"></a><span id="l6.632"> </span>
<a href="#l6.633"></a><span id="l6.633">       let targetLevel = this.getItemAtIndex(aRow).level;</span>
<a href="#l6.634"></a><span id="l6.634">       let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l6.635"></a><span id="l6.635"> </span>
<a href="#l6.636"></a><span id="l6.636">       for (let i = aRow + 1; i &lt; rows.length; i++) {</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-        if (this.getItemAtIndex(i).level &lt;= targetLevel)</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+        if (this.getItemAtIndex(i).level &lt;= targetLevel) {</span>
<a href="#l6.639"></a><span id="l6.639">           break;</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-        if (aChildRow == i)</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineplus">+        }</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+        if (aChildRow == i) {</span>
<a href="#l6.643"></a><span id="l6.643">           return true;</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+        }</span>
<a href="#l6.645"></a><span id="l6.645">       }</span>
<a href="#l6.646"></a><span id="l6.646"> </span>
<a href="#l6.647"></a><span id="l6.647">       return false;</span>
<a href="#l6.648"></a><span id="l6.648">     },</span>
<a href="#l6.649"></a><span id="l6.649"> </span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-    hasNextSibling: function(aRow, aAfterIndex) {</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+    hasNextSibling(aRow, aAfterIndex) {</span>
<a href="#l6.652"></a><span id="l6.652">       let targetLevel = this.getItemAtIndex(aRow).level;</span>
<a href="#l6.653"></a><span id="l6.653">       let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l6.654"></a><span id="l6.654">       for (let i = aAfterIndex + 1; i &lt; rows.length; i++) {</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-        if (this.getItemAtIndex(i).level == targetLevel)</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+        if (this.getItemAtIndex(i).level == targetLevel) {</span>
<a href="#l6.657"></a><span id="l6.657">           return true;</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-        if (this.getItemAtIndex(i).level &lt; targetLevel)</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+        }</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+        if (this.getItemAtIndex(i).level &lt; targetLevel) {</span>
<a href="#l6.661"></a><span id="l6.661">           return false;</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+        }</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+      }</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+      return false;</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+    },</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+    hasPreviousSibling(aRow) {</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+      let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+      if (item &amp;&amp; aRow) {</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+        return this.getItemAtIndex(aRow - 1).level == item.level;</span>
<a href="#l6.672"></a><span id="l6.672">       }</span>
<a href="#l6.673"></a><span id="l6.673"> </span>
<a href="#l6.674"></a><span id="l6.674">       return false;</span>
<a href="#l6.675"></a><span id="l6.675">     },</span>
<a href="#l6.676"></a><span id="l6.676"> </span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-    hasPreviousSibling: function (aRow)</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-    {</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineplus">+    getLevel(aRow) {</span>
<a href="#l6.680"></a><span id="l6.680">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-      if (item &amp;&amp; aRow)</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-        return this.getItemAtIndex(aRow - 1).level == item.level;</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-      else</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-        return false;</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-    },</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-    getLevel: function (aRow)</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-    {</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-      let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-      if (!item)</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+      if (!item) {</span>
<a href="#l6.692"></a><span id="l6.692">         return 0;</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+      }</span>
<a href="#l6.694"></a><span id="l6.694"> </span>
<a href="#l6.695"></a><span id="l6.695">       return item.level;</span>
<a href="#l6.696"></a><span id="l6.696">     },</span>
<a href="#l6.697"></a><span id="l6.697"> </span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-    toggleOpenState: function (aRow)</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-    {</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineplus">+    toggleOpenState(aRow) {</span>
<a href="#l6.701"></a><span id="l6.701">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-      if (!item)</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineplus">+      if (!item) {</span>
<a href="#l6.704"></a><span id="l6.704">         return;</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+      }</span>
<a href="#l6.706"></a><span id="l6.706"> </span>
<a href="#l6.707"></a><span id="l6.707">       // Save off the current selection item.</span>
<a href="#l6.708"></a><span id="l6.708">       let seln = this.selection;</span>
<a href="#l6.709"></a><span id="l6.709">       let currentSelectionIndex = seln.currentIndex;</span>
<a href="#l6.710"></a><span id="l6.710"> </span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-      let rowsChanged = this.toggle(aRow)</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+      let rowsChanged = this.toggle(aRow);</span>
<a href="#l6.713"></a><span id="l6.713"> </span>
<a href="#l6.714"></a><span id="l6.714">       // Now restore selection, ensuring selection is maintained on toggles.</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-      if (currentSelectionIndex &gt; aRow)</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineplus">+      if (currentSelectionIndex &gt; aRow) {</span>
<a href="#l6.717"></a><span id="l6.717">         seln.currentIndex = currentSelectionIndex + rowsChanged;</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-      else</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineplus">+      } else {</span>
<a href="#l6.720"></a><span id="l6.720">         seln.select(currentSelectionIndex);</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineplus">+      }</span>
<a href="#l6.722"></a><span id="l6.722"> </span>
<a href="#l6.723"></a><span id="l6.723">       seln.selectEventsSuppressed = false;</span>
<a href="#l6.724"></a><span id="l6.724">     },</span>
<a href="#l6.725"></a><span id="l6.725"> </span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-    toggle: function (aRow)</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-    {</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+    toggle(aRow) {</span>
<a href="#l6.729"></a><span id="l6.729">       // Collapse the row, or build sub rows based on open states in the map.</span>
<a href="#l6.730"></a><span id="l6.730">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-      if (!item)</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+      if (!item) {</span>
<a href="#l6.733"></a><span id="l6.733">         return null;</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineplus">+      }</span>
<a href="#l6.735"></a><span id="l6.735"> </span>
<a href="#l6.736"></a><span id="l6.736">       let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l6.737"></a><span id="l6.737">       let rowCount = 0;</span>
<a href="#l6.738"></a><span id="l6.738">       let multiplier;</span>
<a href="#l6.739"></a><span id="l6.739"> </span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-      function addDescendants(aItem)</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-      {</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-        for (let i = 0; i &lt; aItem.children.length; i++)</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-        {</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineplus">+      function addDescendants(aItem) {</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineplus">+        for (let i = 0; i &lt; aItem.children.length; i++) {</span>
<a href="#l6.746"></a><span id="l6.746">           rowCount++;</span>
<a href="#l6.747"></a><span id="l6.747">           let child = aItem.children[i];</span>
<a href="#l6.748"></a><span id="l6.748">           rows.splice(aRow + rowCount, 0, child);</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-          if (child.open)</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineplus">+          if (child.open) {</span>
<a href="#l6.751"></a><span id="l6.751">             addDescendants(child);</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineplus">+          }</span>
<a href="#l6.753"></a><span id="l6.753">         }</span>
<a href="#l6.754"></a><span id="l6.754">       }</span>
<a href="#l6.755"></a><span id="l6.755"> </span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-      if (item.open)</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-      {</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineplus">+      if (item.open) {</span>
<a href="#l6.759"></a><span id="l6.759">         // Close the container.  Add up all subfolders and their descendants</span>
<a href="#l6.760"></a><span id="l6.760">         // who may be open.</span>
<a href="#l6.761"></a><span id="l6.761">         multiplier = -1;</span>
<a href="#l6.762"></a><span id="l6.762">         let nextRow = aRow + 1;</span>
<a href="#l6.763"></a><span id="l6.763">         let nextItem = rows[nextRow];</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-        while (nextItem &amp;&amp; nextItem.level &gt; item.level)</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-        {</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+        while (nextItem &amp;&amp; nextItem.level &gt; item.level) {</span>
<a href="#l6.767"></a><span id="l6.767">           rowCount++;</span>
<a href="#l6.768"></a><span id="l6.768">           nextItem = rows[++nextRow];</span>
<a href="#l6.769"></a><span id="l6.769">         }</span>
<a href="#l6.770"></a><span id="l6.770"> </span>
<a href="#l6.771"></a><span id="l6.771">         rows.splice(aRow + 1, rowCount);</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-      }</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-      else</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-      {</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+      } else {</span>
<a href="#l6.776"></a><span id="l6.776">         // Open the container.  Restore the open state of all subfolder and</span>
<a href="#l6.777"></a><span id="l6.777">         // their descendants.</span>
<a href="#l6.778"></a><span id="l6.778">         multiplier = 1;</span>
<a href="#l6.779"></a><span id="l6.779">         addDescendants(item);</span>
<a href="#l6.780"></a><span id="l6.780">       }</span>
<a href="#l6.781"></a><span id="l6.781"> </span>
<a href="#l6.782"></a><span id="l6.782">       let delta = multiplier * rowCount;</span>
<a href="#l6.783"></a><span id="l6.783">       this.mRowCount += delta;</span>
<a href="#l6.784"></a><span id="l6.784"> </span>
<a href="#l6.785"></a><span id="l6.785">       item.open = !item.open;</span>
<a href="#l6.786"></a><span id="l6.786">       // Suppress the select event caused by rowCountChanged.</span>
<a href="#l6.787"></a><span id="l6.787">       this.selection.selectEventsSuppressed = true;</span>
<a href="#l6.788"></a><span id="l6.788">       // Add or remove the children from our view.</span>
<a href="#l6.789"></a><span id="l6.789">       this.treeBox.rowCountChanged(aRow, delta);</span>
<a href="#l6.790"></a><span id="l6.790">       return delta;</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-    }</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineplus">+    },</span>
<a href="#l6.793"></a><span id="l6.793">   },</span>
<a href="#l6.794"></a><span id="l6.794"> </span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-  makeFolderObject: function (aFolder, aCurrentLevel)</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">-  {</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+  makeFolderObject(aFolder, aCurrentLevel) {</span>
<a href="#l6.798"></a><span id="l6.798">     let defaultQuickMode = aFolder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l6.799"></a><span id="l6.799">     let optionsAcct = aFolder.isServer ? FeedUtils.getOptionsAcct(aFolder.server) :</span>
<a href="#l6.800"></a><span id="l6.800">                                          null;</span>
<a href="#l6.801"></a><span id="l6.801">     let open = !aFolder.isServer &amp;&amp;</span>
<a href="#l6.802"></a><span id="l6.802">                aFolder.server == this.mRSSServer &amp;&amp;</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-               this.mActionMode == this.kImportingOPML ? true : false</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-    let folderObject =  { children : [],</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-                          folder   : aFolder,</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-                          name     : aFolder.prettyName,</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-                          level    : aCurrentLevel,</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-                          url      : aFolder.URI,</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-                          quickMode: defaultQuickMode,</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-                          options  : optionsAcct,</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-                          open     : open,</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-                          container: true,</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-                          favicon  : null };</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineplus">+               this.mActionMode == this.kImportingOPML;</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineplus">+    let folderObject = { children:  [],</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineplus">+                         folder:    aFolder,</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineplus">+                         name:      aFolder.prettyName,</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineplus">+                         level:     aCurrentLevel,</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineplus">+                         url:       aFolder.URI,</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineplus">+                         quickMode: defaultQuickMode,</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+                         options:   optionsAcct,</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+                         open,</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+                         container: true,</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineplus">+                         favicon:   null,</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineplus">+                       };</span>
<a href="#l6.826"></a><span id="l6.826"> </span>
<a href="#l6.827"></a><span id="l6.827">     // If a feed has any sub folders, add them to the list of children.</span>
<a href="#l6.828"></a><span id="l6.828">     let folderEnumerator = aFolder.subFolders;</span>
<a href="#l6.829"></a><span id="l6.829"> </span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-    while (folderEnumerator.hasMoreElements())</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-    {</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineplus">+    while (folderEnumerator.hasMoreElements()) {</span>
<a href="#l6.833"></a><span id="l6.833">       let folder = folderEnumerator.getNext();</span>
<a href="#l6.834"></a><span id="l6.834">       if ((folder instanceof Ci.nsIMsgFolder) &amp;&amp;</span>
<a href="#l6.835"></a><span id="l6.835">           !folder.getFlag(Ci.nsMsgFolderFlags.Trash) &amp;&amp;</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-          !folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-      {</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-        folderObject.children</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-                    .push(this.makeFolderObject(folder, aCurrentLevel + 1));</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+          !folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+        folderObject.children.push(this.makeFolderObject(folder, aCurrentLevel + 1));</span>
<a href="#l6.842"></a><span id="l6.842">       }</span>
<a href="#l6.843"></a><span id="l6.843">     }</span>
<a href="#l6.844"></a><span id="l6.844"> </span>
<a href="#l6.845"></a><span id="l6.845">     let feeds = this.getFeedsInFolder(aFolder);</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-    for (let feed of feeds)</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-    {</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineplus">+    for (let feed of feeds) {</span>
<a href="#l6.849"></a><span id="l6.849">       // Now add any feed urls for the folder.</span>
<a href="#l6.850"></a><span id="l6.850">       folderObject.children.push(this.makeFeedObject(feed,</span>
<a href="#l6.851"></a><span id="l6.851">                                                      aFolder,</span>
<a href="#l6.852"></a><span id="l6.852">                                                      aCurrentLevel + 1));</span>
<a href="#l6.853"></a><span id="l6.853">     }</span>
<a href="#l6.854"></a><span id="l6.854"> </span>
<a href="#l6.855"></a><span id="l6.855">     // Finally, set the folder's quickMode based on the its first feed's</span>
<a href="#l6.856"></a><span id="l6.856">     // quickMode, since that is how the view determines summary mode, and now</span>
<a href="#l6.857"></a><span id="l6.857">     // quickMode is updated to be the same for all feeds in a folder.</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-    if (feeds &amp;&amp; feeds[0])</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+    if (feeds &amp;&amp; feeds[0]) {</span>
<a href="#l6.860"></a><span id="l6.860">       folderObject.quickMode = feeds[0].quickMode;</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+    }</span>
<a href="#l6.862"></a><span id="l6.862"> </span>
<a href="#l6.863"></a><span id="l6.863">     folderObject.children = this.folderItemSorter(folderObject.children);</span>
<a href="#l6.864"></a><span id="l6.864"> </span>
<a href="#l6.865"></a><span id="l6.865">     return folderObject;</span>
<a href="#l6.866"></a><span id="l6.866">   },</span>
<a href="#l6.867"></a><span id="l6.867"> </span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-  folderItemSorter: function (aArray)</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-  {</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-    return aArray.sort(function(a, b) { return a.name.toLowerCase() &gt;</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-                                               b.name.toLowerCase() }).</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-                  sort(function(a, b) { return a.container &lt; b.container });</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineplus">+  folderItemSorter(aArray) {</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineplus">+    return aArray.sort(function(a, b) {</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineplus">+                         return a.name.toLowerCase() &gt; b.name.toLowerCase();</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineplus">+                       }).</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineplus">+                  sort(function(a, b) {</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineplus">+                         return a.container &lt; b.container;</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineplus">+                       });</span>
<a href="#l6.880"></a><span id="l6.880">   },</span>
<a href="#l6.881"></a><span id="l6.881"> </span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-  getFeedsInFolder: function (aFolder)</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-  {</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-    let feeds = new Array();</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineplus">+  getFeedsInFolder(aFolder) {</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineplus">+    let feeds = [];</span>
<a href="#l6.887"></a><span id="l6.887">     let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-    if (!feedUrlArray)</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineplus">+    if (!feedUrlArray) {</span>
<a href="#l6.890"></a><span id="l6.890">       // No feedUrls in this folder.</span>
<a href="#l6.891"></a><span id="l6.891">       return feeds;</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-    for (let url of feedUrlArray)</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-    {</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineplus">+    }</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineplus">+</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineplus">+    for (let url of feedUrlArray) {</span>
<a href="#l6.898"></a><span id="l6.898">       let feed = new Feed(url, aFolder);</span>
<a href="#l6.899"></a><span id="l6.899">       feeds.push(feed);</span>
<a href="#l6.900"></a><span id="l6.900">     }</span>
<a href="#l6.901"></a><span id="l6.901"> </span>
<a href="#l6.902"></a><span id="l6.902">     return feeds;</span>
<a href="#l6.903"></a><span id="l6.903">   },</span>
<a href="#l6.904"></a><span id="l6.904"> </span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-  makeFeedObject: function (aFeed, aFolder, aLevel)</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-  {</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineplus">+  makeFeedObject(aFeed, aFolder, aLevel) {</span>
<a href="#l6.908"></a><span id="l6.908">     // Look inside the data source for the feed properties.</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">-    let feed = { children    : [],</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineplus">+    let feed = { children:     [],</span>
<a href="#l6.911"></a><span id="l6.911">                  parentFolder: aFolder,</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-                 name        : aFeed.title || aFeed.description || aFeed.url,</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-                 url         : aFeed.url,</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-                 quickMode   : aFeed.quickMode,</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-                 options     : aFeed.options || FeedUtils.optionsTemplate,</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-                 level       : aLevel,</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-                 open        : false,</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-                 container   : false,</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-                 favicon     : null };</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineplus">+                 name:         aFeed.title || aFeed.description || aFeed.url,</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineplus">+                 url:          aFeed.url,</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineplus">+                 quickMode:    aFeed.quickMode,</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineplus">+                 options:      aFeed.options || FeedUtils.optionsTemplate,</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineplus">+                 level:        aLevel,</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineplus">+                 open:         false,</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineplus">+                 container:    false,</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineplus">+                 favicon:      null,</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineplus">+               };</span>
<a href="#l6.929"></a><span id="l6.929">     return feed;</span>
<a href="#l6.930"></a><span id="l6.930">   },</span>
<a href="#l6.931"></a><span id="l6.931"> </span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-  loadSubscriptions: function ()</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-  {</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineplus">+  loadSubscriptions() {</span>
<a href="#l6.935"></a><span id="l6.935">     // Put together an array of folders.  Each feed account level folder is</span>
<a href="#l6.936"></a><span id="l6.936">     // included as the root.</span>
<a href="#l6.937"></a><span id="l6.937">     let numFolders = 0;</span>
<a href="#l6.938"></a><span id="l6.938">     let feedContainers = [];</span>
<a href="#l6.939"></a><span id="l6.939">     // Get all the feed account folders.</span>
<a href="#l6.940"></a><span id="l6.940">     let feedRootFolders = FeedUtils.getAllRssServerRootFolders();</span>
<a href="#l6.941"></a><span id="l6.941"> </span>
<a href="#l6.942"></a><span id="l6.942">     feedRootFolders.forEach(function(rootFolder) {</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineat">@@ -712,215 +693,218 @@ var FeedSubscriptions = {</span>
<a href="#l6.944"></a><span id="l6.944">   },</span>
<a href="#l6.945"></a><span id="l6.945"> </span>
<a href="#l6.946"></a><span id="l6.946">   /**</span>
<a href="#l6.947"></a><span id="l6.947">    * Find the folder in the tree.  The search may be limited to subfolders of</span>
<a href="#l6.948"></a><span id="l6.948">    * a known folder, or expanded to include the entire tree. This function is</span>
<a href="#l6.949"></a><span id="l6.949">    * also used to insert/remove folders without rebuilding the tree view cache</span>
<a href="#l6.950"></a><span id="l6.950">    * (to avoid position/toggle state loss).</span>
<a href="#l6.951"></a><span id="l6.951">    *</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-   * @param  aFolder nsIMsgFolder - the folder to find.</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-   * @param  [aParams] object     - params object, containing:</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - The folder to find.</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineplus">+   * @param {Object} aParms        - The params object, containing:</span>
<a href="#l6.956"></a><span id="l6.956">    *</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-   * [parentIndex] int        - index of folder to start the search; if</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineplus">+   * {Integer} parentIndex    - index of folder to start the search; if</span>
<a href="#l6.959"></a><span id="l6.959">    *                            null (default), the index of the folder's</span>
<a href="#l6.960"></a><span id="l6.960">    *                            rootFolder will be used.</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-   * [select] boolean         - if true (default) the folder's ancestors</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineplus">+   * {Boolean} select         - if true (default) the folder's ancestors</span>
<a href="#l6.963"></a><span id="l6.963">    *                            will be opened and the folder selected.</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-   * [open] boolean           - if true (default) the folder is opened.</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-   * [remove] boolean         - delete the item from tree row cache if true,</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineplus">+   * {Boolean} open           - if true (default) the folder is opened.</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineplus">+   * {Boolean} remove         - delete the item from tree row cache if true,</span>
<a href="#l6.968"></a><span id="l6.968">    *                            false (default) otherwise.</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-   * [newFolder] nsIMsgFolder - if not null (default) the new folder,</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineplus">+   * {nsIMsgFolder} newFolder - if not null (default) the new folder,</span>
<a href="#l6.971"></a><span id="l6.971">    *                            for add or rename.</span>
<a href="#l6.972"></a><span id="l6.972">    *</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-   * @return bool found - true if found, false if not.</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineplus">+   * @returns {Boolean} found - true if found, false if not.</span>
<a href="#l6.975"></a><span id="l6.975">    */</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-  selectFolder: function(aFolder, aParms)</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-  {</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineplus">+  selectFolder(aFolder, aParms) {</span>
<a href="#l6.979"></a><span id="l6.979">     let folderURI = aFolder.URI;</span>
<a href="#l6.980"></a><span id="l6.980">     let parentIndex = aParms &amp;&amp; (&quot;parentIndex&quot; in aParms) ? aParms.parentIndex : null;</span>
<a href="#l6.981"></a><span id="l6.981">     let selectIt = aParms &amp;&amp; (&quot;select&quot; in aParms) ? aParms.select : true;</span>
<a href="#l6.982"></a><span id="l6.982">     let openIt = aParms &amp;&amp; (&quot;open&quot; in aParms) ? aParms.open : true;</span>
<a href="#l6.983"></a><span id="l6.983">     let removeIt = aParms &amp;&amp; (&quot;remove&quot; in aParms) ? aParms.remove : false;</span>
<a href="#l6.984"></a><span id="l6.984">     let newFolder = aParms &amp;&amp; (&quot;newFolder&quot; in aParms) ? aParms.newFolder : null;</span>
<a href="#l6.985"></a><span id="l6.985">     let startIndex, startItem;</span>
<a href="#l6.986"></a><span id="l6.986">     let found = false;</span>
<a href="#l6.987"></a><span id="l6.987"> </span>
<a href="#l6.988"></a><span id="l6.988">     let firstVisRow, curFirstVisRow, curLastVisRow;</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-    if (this.mView.treeBox)</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineplus">+    if (this.mView.treeBox) {</span>
<a href="#l6.991"></a><span id="l6.991">       firstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-    if (parentIndex != null)</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-    {</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineplus">+    }</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineplus">+</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineplus">+    if (parentIndex != null) {</span>
<a href="#l6.998"></a><span id="l6.998">       // Use the parentIndex if given.</span>
<a href="#l6.999"></a><span id="l6.999">       startIndex = parentIndex;</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-      if (aFolder.isServer)</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineplus">+      if (aFolder.isServer) {</span>
<a href="#l6.1002"></a><span id="l6.1002">         // Fake item for account root folder.</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-        startItem = { name: &quot;AccountRoot&quot;,</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-                      children: [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-                      container: true, open: false, url: null, level: -1};</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-      else</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineplus">+        startItem = { name:     &quot;AccountRoot&quot;,</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineplus">+                      children:  [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineplus">+                      container: true,</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineplus">+                      open:      false,</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineplus">+                      url:       null,</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineplus">+                      level:     -1,</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineplus">+                    };</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineplus">+      } else {</span>
<a href="#l6.1015"></a><span id="l6.1015">         startItem = this.mView.getItemAtIndex(startIndex);</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-    }</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-    else</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-    {</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineplus">+      }</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineplus">+    } else {</span>
<a href="#l6.1021"></a><span id="l6.1021">       // Get the folder's root parent index.</span>
<a href="#l6.1022"></a><span id="l6.1022">       let index = 0;</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-      for (index; index &lt; this.mView.rowCount; index++)</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-      {</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineplus">+      for (index; index &lt; this.mView.rowCount; index++) {</span>
<a href="#l6.1026"></a><span id="l6.1026">         let item = this.mView.getItemAtIndex(index);</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-        if (item.url == aFolder.server.rootFolder.URI)</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineplus">+        if (item.url == aFolder.server.rootFolder.URI) {</span>
<a href="#l6.1029"></a><span id="l6.1029">           break;</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+        }</span>
<a href="#l6.1031"></a><span id="l6.1031">       }</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineplus">+</span>
<a href="#l6.1033"></a><span id="l6.1033">       startIndex = index;</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-      if (aFolder.isServer)</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineplus">+      if (aFolder.isServer) {</span>
<a href="#l6.1036"></a><span id="l6.1036">         // Fake item for account root folder.</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-        startItem = { name: &quot;AccountRoot&quot;,</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-                      children: [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-                      container: true, open: false, url: null, level: -1};</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-      else</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineplus">+        startItem = { name:      &quot;AccountRoot&quot;,</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineplus">+                      children:  [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineplus">+                      container: true,</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineplus">+                      open:      false,</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineplus">+                      url:       null,</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineplus">+                      level:     -1,</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineplus">+                    };</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineplus">+      } else {</span>
<a href="#l6.1049"></a><span id="l6.1049">         startItem = this.mView.getItemAtIndex(startIndex);</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineplus">+      }</span>
<a href="#l6.1051"></a><span id="l6.1051">     }</span>
<a href="#l6.1052"></a><span id="l6.1052"> </span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-    function containsFolder(aItem)</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-    {</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineplus">+    function containsFolder(aItem) {</span>
<a href="#l6.1056"></a><span id="l6.1056">       // Search for the folder.  If it's found, set the open state on all</span>
<a href="#l6.1057"></a><span id="l6.1057">       // ancestor folders.  A toggle() rebuilds the view rows to match the map.</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-      if (aItem.url == folderURI)</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+      if (aItem.url == folderURI) {</span>
<a href="#l6.1060"></a><span id="l6.1060">         return found = true;</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineplus">+      }</span>
<a href="#l6.1062"></a><span id="l6.1062"> </span>
<a href="#l6.1063"></a><span id="l6.1063">       for (let i = 0; i &lt; aItem.children.length; i++) {</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-        if (aItem.children[i].container &amp;&amp; containsFolder(aItem.children[i]))</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-        {</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-          if (removeIt &amp;&amp; aItem.children[i].url == folderURI)</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-          {</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineplus">+        if (aItem.children[i].container &amp;&amp; containsFolder(aItem.children[i])) {</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineplus">+          if (removeIt &amp;&amp; aItem.children[i].url == folderURI) {</span>
<a href="#l6.1070"></a><span id="l6.1070">             // Get all occurrences in the tree cache arrays.</span>
<a href="#l6.1071"></a><span id="l6.1071">             FeedUtils.log.debug(&quot;selectFolder: delete in cache, &quot; +</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-                                &quot;parent:children:item:index - &quot;+</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineplus">+                                &quot;parent:children:item:index - &quot; +</span>
<a href="#l6.1074"></a><span id="l6.1074">                                 aItem.name + &quot;:&quot; + aItem.children.length + &quot;:&quot; +</span>
<a href="#l6.1075"></a><span id="l6.1075">                                 aItem.children[i].name + &quot;:&quot; + i);</span>
<a href="#l6.1076"></a><span id="l6.1076">             aItem.children.splice(i, 1);</span>
<a href="#l6.1077"></a><span id="l6.1077">             FeedUtils.log.debug(&quot;selectFolder: deleted in cache, &quot; +</span>
<a href="#l6.1078"></a><span id="l6.1078">                                 &quot;parent:children - &quot; +</span>
<a href="#l6.1079"></a><span id="l6.1079">                                 aItem.name + &quot;:&quot; + aItem.children.length);</span>
<a href="#l6.1080"></a><span id="l6.1080">             removeIt = false;</span>
<a href="#l6.1081"></a><span id="l6.1081">             return true;</span>
<a href="#l6.1082"></a><span id="l6.1082">           }</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-          if (newFolder)</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-          {</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineplus">+          if (newFolder) {</span>
<a href="#l6.1086"></a><span id="l6.1086">             let newItem = FeedSubscriptions.makeFolderObject(newFolder,</span>
<a href="#l6.1087"></a><span id="l6.1087">                                                              aItem.level + 1);</span>
<a href="#l6.1088"></a><span id="l6.1088">             newItem.open = aItem.children[i].open;</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-            if (newFolder.isServer)</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineplus">+            if (newFolder.isServer) {</span>
<a href="#l6.1091"></a><span id="l6.1091">               FeedSubscriptions.mFeedContainers[startIndex] = newItem;</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-            else</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-            {</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineplus">+            } else {</span>
<a href="#l6.1095"></a><span id="l6.1095">               aItem.children[i] = newItem;</span>
<a href="#l6.1096"></a><span id="l6.1096">               aItem.children = FeedSubscriptions.folderItemSorter(aItem.children);</span>
<a href="#l6.1097"></a><span id="l6.1097">             }</span>
<a href="#l6.1098"></a><span id="l6.1098">             FeedUtils.log.trace(&quot;selectFolder: parentName:newFolderName:newFolderItem - &quot; +</span>
<a href="#l6.1099"></a><span id="l6.1099">                                 aItem.name + &quot;:&quot; + newItem.name + &quot;:&quot; + newItem.toSource());</span>
<a href="#l6.1100"></a><span id="l6.1100">             newFolder = null;</span>
<a href="#l6.1101"></a><span id="l6.1101">             return true;</span>
<a href="#l6.1102"></a><span id="l6.1102">           }</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-          if (!found)</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-          {</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineplus">+          if (!found) {</span>
<a href="#l6.1106"></a><span id="l6.1106">             // For the folder to find.</span>
<a href="#l6.1107"></a><span id="l6.1107">             found = true;</span>
<a href="#l6.1108"></a><span id="l6.1108">             aItem.children[i].open = openIt;</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-          }</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-          else</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-          {</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineplus">+          } else if (selectIt || openIt) {</span>
<a href="#l6.1113"></a><span id="l6.1113">             // For ancestor folders.</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-            if (selectIt || openIt)</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-              aItem.children[i].open = true;</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineplus">+            aItem.children[i].open = true;</span>
<a href="#l6.1117"></a><span id="l6.1117">           }</span>
<a href="#l6.1118"></a><span id="l6.1118"> </span>
<a href="#l6.1119"></a><span id="l6.1119">           return true;</span>
<a href="#l6.1120"></a><span id="l6.1120">         }</span>
<a href="#l6.1121"></a><span id="l6.1121">       }</span>
<a href="#l6.1122"></a><span id="l6.1122"> </span>
<a href="#l6.1123"></a><span id="l6.1123">       return false;</span>
<a href="#l6.1124"></a><span id="l6.1124">     }</span>
<a href="#l6.1125"></a><span id="l6.1125"> </span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-    if (startItem)</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineminus">-    {</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineplus">+    if (startItem) {</span>
<a href="#l6.1129"></a><span id="l6.1129">       // Find a folder with a specific parent.</span>
<a href="#l6.1130"></a><span id="l6.1130">       containsFolder(startItem);</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-      if (!found)</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineplus">+      if (!found) {</span>
<a href="#l6.1133"></a><span id="l6.1133">         return false;</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-      if (!selectIt)</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineplus">+      }</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineplus">+</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineplus">+      if (!selectIt) {</span>
<a href="#l6.1139"></a><span id="l6.1139">         return true;</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-      if (startItem.open)</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineplus">+      }</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineplus">+</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineplus">+      if (startItem.open) {</span>
<a href="#l6.1145"></a><span id="l6.1145">         this.mView.toggle(startIndex);</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineplus">+      }</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineplus">+</span>
<a href="#l6.1148"></a><span id="l6.1148">       this.mView.toggleOpenState(startIndex);</span>
<a href="#l6.1149"></a><span id="l6.1149">     }</span>
<a href="#l6.1150"></a><span id="l6.1150"> </span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-    for (let index = 0; index &lt; this.mView.rowCount &amp;&amp; selectIt; index++)</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">-    {</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineplus">+    for (let index = 0; index &lt; this.mView.rowCount &amp;&amp; selectIt; index++) {</span>
<a href="#l6.1154"></a><span id="l6.1154">       // The desired folder is now in the view.</span>
<a href="#l6.1155"></a><span id="l6.1155">       let item = this.mView.getItemAtIndex(index);</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">-      if (!item.container)</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineplus">+      if (!item.container) {</span>
<a href="#l6.1158"></a><span id="l6.1158">         continue;</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-      if (item.url == folderURI)</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-      {</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineplus">+      }</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineplus">+</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineplus">+      if (item.url == folderURI) {</span>
<a href="#l6.1164"></a><span id="l6.1164">         if (item.children.length &amp;&amp;</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineminus">-            ((!item.open &amp;&amp; openIt) || (item.open &amp;&amp; !openIt)))</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineplus">+            ((!item.open &amp;&amp; openIt) || (item.open &amp;&amp; !openIt))) {</span>
<a href="#l6.1167"></a><span id="l6.1167">           this.mView.toggleOpenState(index);</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineplus">+        }</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineplus">+</span>
<a href="#l6.1170"></a><span id="l6.1170">         this.mView.selection.select(index);</span>
<a href="#l6.1171"></a><span id="l6.1171">         found = true;</span>
<a href="#l6.1172"></a><span id="l6.1172">         break;</span>
<a href="#l6.1173"></a><span id="l6.1173">       }</span>
<a href="#l6.1174"></a><span id="l6.1174">     }</span>
<a href="#l6.1175"></a><span id="l6.1175"> </span>
<a href="#l6.1176"></a><span id="l6.1176">     // Ensure tree position does not jump unnecessarily.</span>
<a href="#l6.1177"></a><span id="l6.1177">     curFirstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l6.1178"></a><span id="l6.1178">     curLastVisRow = this.mView.treeBox.getLastVisibleRow();</span>
<a href="#l6.1179"></a><span id="l6.1179">     if (firstVisRow &gt;= 0 &amp;&amp;</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-        this.mView.rowCount - curLastVisRow &gt; firstVisRow - curFirstVisRow)</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineplus">+        this.mView.rowCount - curLastVisRow &gt; firstVisRow - curFirstVisRow) {</span>
<a href="#l6.1182"></a><span id="l6.1182">       this.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineminus">-    else</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineplus">+    } else {</span>
<a href="#l6.1185"></a><span id="l6.1185">       this.mView.treeBox.ensureRowIsVisible(this.mView.rowCount - 1);</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineplus">+    }</span>
<a href="#l6.1187"></a><span id="l6.1187"> </span>
<a href="#l6.1188"></a><span id="l6.1188">     FeedUtils.log.debug(&quot;selectFolder: curIndex:firstVisRow:&quot; +</span>
<a href="#l6.1189"></a><span id="l6.1189">                         &quot;curFirstVisRow:curLastVisRow:rowCount - &quot; +</span>
<a href="#l6.1190"></a><span id="l6.1190">                         this.mView.selection.currentIndex + &quot;:&quot; +</span>
<a href="#l6.1191"></a><span id="l6.1191">                         firstVisRow + &quot;:&quot; +</span>
<a href="#l6.1192"></a><span id="l6.1192">                         curFirstVisRow + &quot;:&quot; + curLastVisRow + &quot;:&quot; + this.mView.rowCount);</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-</span>
<a href="#l6.1194"></a><span id="l6.1194">     return found;</span>
<a href="#l6.1195"></a><span id="l6.1195">   },</span>
<a href="#l6.1196"></a><span id="l6.1196"> </span>
<a href="#l6.1197"></a><span id="l6.1197">   /**</span>
<a href="#l6.1198"></a><span id="l6.1198">    * Find the feed in the tree.  The search first gets the feed's folder,</span>
<a href="#l6.1199"></a><span id="l6.1199">    * then selects the child feed.</span>
<a href="#l6.1200"></a><span id="l6.1200">    *</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineminus">-   * @param  aFeed {Feed object}    - the feed to find.</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineminus">-   * @param  [aParentIndex] integer - index to start the folder search.</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineplus">+   * @param {Feed} aFeed           - The feed to find.</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineplus">+   * @param {Integer} aParentIndex - Index to start the folder search.</span>
<a href="#l6.1205"></a><span id="l6.1205">    *</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">-   * @return found bool - true if found, false if not.</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineplus">+   * @returns {Boolean} found - true if found, false if not.</span>
<a href="#l6.1208"></a><span id="l6.1208">    */</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-  selectFeed: function(aFeed, aParentIndex)</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineminus">-  {</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineplus">+  selectFeed(aFeed, aParentIndex) {</span>
<a href="#l6.1212"></a><span id="l6.1212">     let folder = aFeed.folder;</span>
<a href="#l6.1213"></a><span id="l6.1213">     let server = aFeed.server || aFeed.folder.server;</span>
<a href="#l6.1214"></a><span id="l6.1214">     let found = false;</span>
<a href="#l6.1215"></a><span id="l6.1215"> </span>
<a href="#l6.1216"></a><span id="l6.1216">     if (aFeed.folder.isServer) {</span>
<a href="#l6.1217"></a><span id="l6.1217">       // If passed the root folder, the caller wants to get the feed's folder</span>
<a href="#l6.1218"></a><span id="l6.1218">       // from the db (for cases of an ancestor folder rename/move).</span>
<a href="#l6.1219"></a><span id="l6.1219">       let itemResource = FeedUtils.rdf.GetResource(aFeed.url);</span>
<a href="#l6.1220"></a><span id="l6.1220">       let ds = FeedUtils.getSubscriptionsDS(server);</span>
<a href="#l6.1221"></a><span id="l6.1221">       folder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l6.1222"></a><span id="l6.1222">     }</span>
<a href="#l6.1223"></a><span id="l6.1223"> </span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-    if (this.selectFolder(folder, { parentIndex: aParentIndex }))</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">-    {</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineplus">+    if (this.selectFolder(folder, { parentIndex: aParentIndex })) {</span>
<a href="#l6.1227"></a><span id="l6.1227">       let seln = this.mView.selection;</span>
<a href="#l6.1228"></a><span id="l6.1228">       let item = this.mView.currentItem;</span>
<a href="#l6.1229"></a><span id="l6.1229">       if (item) {</span>
<a href="#l6.1230"></a><span id="l6.1230">         for (let i = seln.currentIndex + 1; i &lt; this.mView.rowCount; i++) {</span>
<a href="#l6.1231"></a><span id="l6.1231">           if (this.mView.getItemAtIndex(i).url == aFeed.url) {</span>
<a href="#l6.1232"></a><span id="l6.1232">             this.mView.selection.select(i);</span>
<a href="#l6.1233"></a><span id="l6.1233">             this.mView.treeBox.ensureRowIsVisible(i);</span>
<a href="#l6.1234"></a><span id="l6.1234">             found = true;</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineat">@@ -928,44 +912,38 @@ var FeedSubscriptions = {</span>
<a href="#l6.1236"></a><span id="l6.1236">           }</span>
<a href="#l6.1237"></a><span id="l6.1237">         }</span>
<a href="#l6.1238"></a><span id="l6.1238">       }</span>
<a href="#l6.1239"></a><span id="l6.1239">     }</span>
<a href="#l6.1240"></a><span id="l6.1240"> </span>
<a href="#l6.1241"></a><span id="l6.1241">     return found;</span>
<a href="#l6.1242"></a><span id="l6.1242">   },</span>
<a href="#l6.1243"></a><span id="l6.1243"> </span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineminus">-  updateFeedData: function (aItem)</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineminus">-  {</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-    if (!aItem)</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineplus">+  updateFeedData(aItem) {</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineplus">+    if (!aItem) {</span>
<a href="#l6.1249"></a><span id="l6.1249">       return;</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineplus">+    }</span>
<a href="#l6.1251"></a><span id="l6.1251"> </span>
<a href="#l6.1252"></a><span id="l6.1252">     let nameValue = document.getElementById(&quot;nameValue&quot;);</span>
<a href="#l6.1253"></a><span id="l6.1253">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l6.1254"></a><span id="l6.1254">     let locationValidate = document.getElementById(&quot;locationValidate&quot;);</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineminus">-    let selectFolder = document.getElementById(&quot;selectFolder&quot;);</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-    let selectFolderValue = document.getElementById(&quot;selectFolderValue&quot;);</span>
<a href="#l6.1257"></a><span id="l6.1257">     let isServer = aItem.folder &amp;&amp; aItem.folder.isServer;</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-    let isFolder = aItem.folder &amp;&amp; !aItem.folder.isServer;</span>
<a href="#l6.1259"></a><span id="l6.1259">     let isFeed = !aItem.container;</span>
<a href="#l6.1260"></a><span id="l6.1260">     let server, displayFolder;</span>
<a href="#l6.1261"></a><span id="l6.1261"> </span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-    if (isFeed)</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-    {</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineplus">+    if (isFeed) {</span>
<a href="#l6.1265"></a><span id="l6.1265">       // A feed item.  Set the feed location and title info.</span>
<a href="#l6.1266"></a><span id="l6.1266">       nameValue.value = aItem.name;</span>
<a href="#l6.1267"></a><span id="l6.1267">       locationValue.value = aItem.url;</span>
<a href="#l6.1268"></a><span id="l6.1268">       locationValidate.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.1269"></a><span id="l6.1269"> </span>
<a href="#l6.1270"></a><span id="l6.1270">       // Root the location picker to the news &amp; blogs server.</span>
<a href="#l6.1271"></a><span id="l6.1271">       server = aItem.parentFolder.server;</span>
<a href="#l6.1272"></a><span id="l6.1272">       displayFolder = aItem.parentFolder;</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-    }</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineminus">-    else</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineminus">-    {</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineplus">+    } else {</span>
<a href="#l6.1277"></a><span id="l6.1277">       // A folder/container item.</span>
<a href="#l6.1278"></a><span id="l6.1278">       nameValue.value = &quot;&quot;;</span>
<a href="#l6.1279"></a><span id="l6.1279">       nameValue.disabled = true;</span>
<a href="#l6.1280"></a><span id="l6.1280">       locationValue.value = &quot;&quot;;</span>
<a href="#l6.1281"></a><span id="l6.1281">       locationValidate.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l6.1282"></a><span id="l6.1282"> </span>
<a href="#l6.1283"></a><span id="l6.1283">       server = aItem.folder.server;</span>
<a href="#l6.1284"></a><span id="l6.1284">       displayFolder = aItem.folder;</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineat">@@ -973,18 +951,19 @@ var FeedSubscriptions = {</span>
<a href="#l6.1286"></a><span id="l6.1286"> </span>
<a href="#l6.1287"></a><span id="l6.1287">     // Common to both folder and feed items.</span>
<a href="#l6.1288"></a><span id="l6.1288">     nameValue.disabled = aItem.container;</span>
<a href="#l6.1289"></a><span id="l6.1289">     this.setFolderPicker(displayFolder, isFeed);</span>
<a href="#l6.1290"></a><span id="l6.1290"> </span>
<a href="#l6.1291"></a><span id="l6.1291">     // Set quick mode value.</span>
<a href="#l6.1292"></a><span id="l6.1292">     document.getElementById(&quot;quickMode&quot;).checked = aItem.quickMode;</span>
<a href="#l6.1293"></a><span id="l6.1293"> </span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">-    if (isServer)</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineplus">+    if (isServer) {</span>
<a href="#l6.1296"></a><span id="l6.1296">       aItem.options = FeedUtils.getOptionsAcct(server);</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineplus">+    }</span>
<a href="#l6.1298"></a><span id="l6.1298"> </span>
<a href="#l6.1299"></a><span id="l6.1299">     // Update items.</span>
<a href="#l6.1300"></a><span id="l6.1300">     let updateEnabled = document.getElementById(&quot;updateEnabled&quot;);</span>
<a href="#l6.1301"></a><span id="l6.1301">     let updateValue = document.getElementById(&quot;updateValue&quot;);</span>
<a href="#l6.1302"></a><span id="l6.1302">     let biffUnits = document.getElementById(&quot;biffUnits&quot;);</span>
<a href="#l6.1303"></a><span id="l6.1303">     let recommendedUnits = document.getElementById(&quot;recommendedUnits&quot;);</span>
<a href="#l6.1304"></a><span id="l6.1304">     let recommendedUnitsVal = document.getElementById(&quot;recommendedUnitsVal&quot;);</span>
<a href="#l6.1305"></a><span id="l6.1305">     let updates = aItem.options ? aItem.options.updates :</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineat">@@ -992,199 +971,194 @@ var FeedSubscriptions = {</span>
<a href="#l6.1307"></a><span id="l6.1307"> </span>
<a href="#l6.1308"></a><span id="l6.1308">     updateEnabled.checked = updates.enabled;</span>
<a href="#l6.1309"></a><span id="l6.1309">     updateValue.disabled = !updateEnabled.checked;</span>
<a href="#l6.1310"></a><span id="l6.1310">     biffUnits.value = updates.updateUnits;</span>
<a href="#l6.1311"></a><span id="l6.1311">     let minutes = updates.updateUnits == FeedUtils.kBiffUnitsMinutes ?</span>
<a href="#l6.1312"></a><span id="l6.1312">                     updates.updateMinutes :</span>
<a href="#l6.1313"></a><span id="l6.1313">                     updates.updateMinutes / (24 * 60);</span>
<a href="#l6.1314"></a><span id="l6.1314">     updateValue.valueNumber = minutes;</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-    if (isFeed)</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineplus">+    if (isFeed) {</span>
<a href="#l6.1317"></a><span id="l6.1317">       recommendedUnitsVal.value = this.getUpdateMinutesRec(updates);</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-    else</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineplus">+    } else {</span>
<a href="#l6.1320"></a><span id="l6.1320">       recommendedUnitsVal.value = &quot;&quot;;</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineplus">+    }</span>
<a href="#l6.1322"></a><span id="l6.1322"> </span>
<a href="#l6.1323"></a><span id="l6.1323">     recommendedUnits.hidden = recommendedUnitsVal.value == &quot;&quot;;</span>
<a href="#l6.1324"></a><span id="l6.1324"> </span>
<a href="#l6.1325"></a><span id="l6.1325">     // Autotag items.</span>
<a href="#l6.1326"></a><span id="l6.1326">     let autotagEnable = document.getElementById(&quot;autotagEnable&quot;);</span>
<a href="#l6.1327"></a><span id="l6.1327">     let autotagUsePrefix = document.getElementById(&quot;autotagUsePrefix&quot;);</span>
<a href="#l6.1328"></a><span id="l6.1328">     let autotagPrefix = document.getElementById(&quot;autotagPrefix&quot;);</span>
<a href="#l6.1329"></a><span id="l6.1329">     let category = aItem.options ? aItem.options.category : null;</span>
<a href="#l6.1330"></a><span id="l6.1330"> </span>
<a href="#l6.1331"></a><span id="l6.1331">     autotagEnable.checked = category &amp;&amp; category.enabled;</span>
<a href="#l6.1332"></a><span id="l6.1332">     autotagUsePrefix.checked = category &amp;&amp; category.prefixEnabled;</span>
<a href="#l6.1333"></a><span id="l6.1333">     autotagUsePrefix.disabled = !autotagEnable.checked;</span>
<a href="#l6.1334"></a><span id="l6.1334">     autotagPrefix.disabled = autotagUsePrefix.disabled || !autotagUsePrefix.checked;</span>
<a href="#l6.1335"></a><span id="l6.1335">     autotagPrefix.value = category &amp;&amp; category.prefix ? category.prefix : &quot;&quot;;</span>
<a href="#l6.1336"></a><span id="l6.1336">   },</span>
<a href="#l6.1337"></a><span id="l6.1337"> </span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-  setFolderPicker: function(aFolder, aIsFeed)</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineminus">-  {</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineplus">+  setFolderPicker(aFolder, aIsFeed) {</span>
<a href="#l6.1341"></a><span id="l6.1341">     let folderPrettyPath = FeedUtils.getFolderPrettyPath(aFolder);</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineminus">-    if (!folderPrettyPath)</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineplus">+    if (!folderPrettyPath) {</span>
<a href="#l6.1344"></a><span id="l6.1344">       return;</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineplus">+    }</span>
<a href="#l6.1346"></a><span id="l6.1346"> </span>
<a href="#l6.1347"></a><span id="l6.1347">     let selectFolder = document.getElementById(&quot;selectFolder&quot;);</span>
<a href="#l6.1348"></a><span id="l6.1348">     let selectFolderPopup = document.getElementById(&quot;selectFolderPopup&quot;);</span>
<a href="#l6.1349"></a><span id="l6.1349">     let selectFolderValue = document.getElementById(&quot;selectFolderValue&quot;);</span>
<a href="#l6.1350"></a><span id="l6.1350"> </span>
<a href="#l6.1351"></a><span id="l6.1351">     selectFolder.setAttribute(&quot;hidden&quot;, !aIsFeed);</span>
<a href="#l6.1352"></a><span id="l6.1352">     selectFolder._folder = aFolder;</span>
<a href="#l6.1353"></a><span id="l6.1353">     selectFolderValue.setAttribute(&quot;hidden&quot;, aIsFeed);</span>
<a href="#l6.1354"></a><span id="l6.1354">     selectFolderValue.setAttribute(&quot;showfilepath&quot;, false);</span>
<a href="#l6.1355"></a><span id="l6.1355"> </span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineminus">-    if (aIsFeed)</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineminus">-    {</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineplus">+    if (aIsFeed) {</span>
<a href="#l6.1359"></a><span id="l6.1359">       selectFolderPopup._ensureInitialized();</span>
<a href="#l6.1360"></a><span id="l6.1360">       selectFolderPopup.selectFolder(aFolder);</span>
<a href="#l6.1361"></a><span id="l6.1361">       selectFolder.setAttribute(&quot;label&quot;, folderPrettyPath);</span>
<a href="#l6.1362"></a><span id="l6.1362">       selectFolder.setAttribute(&quot;uri&quot;, aFolder.URI);</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-    }</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineminus">-    else</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineminus">-    {</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineplus">+    } else {</span>
<a href="#l6.1367"></a><span id="l6.1367">       selectFolderValue.value = folderPrettyPath;</span>
<a href="#l6.1368"></a><span id="l6.1368">       selectFolderValue.setAttribute(&quot;prettypath&quot;, folderPrettyPath);</span>
<a href="#l6.1369"></a><span id="l6.1369">       selectFolderValue.setAttribute(&quot;filepath&quot;, aFolder.filePath.path);</span>
<a href="#l6.1370"></a><span id="l6.1370">     }</span>
<a href="#l6.1371"></a><span id="l6.1371">   },</span>
<a href="#l6.1372"></a><span id="l6.1372"> </span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineminus">-  onClickSelectFolderValue: function(aEvent)</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineminus">-  {</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineplus">+  onClickSelectFolderValue(aEvent) {</span>
<a href="#l6.1376"></a><span id="l6.1376">     let target = aEvent.target;</span>
<a href="#l6.1377"></a><span id="l6.1377">     if (((&quot;button&quot; in aEvent) &amp;&amp;</span>
<a href="#l6.1378"></a><span id="l6.1378">          (aEvent.button != 0 ||</span>
<a href="#l6.1379"></a><span id="l6.1379">           aEvent.originalTarget.localName != &quot;div&quot; ||</span>
<a href="#l6.1380"></a><span id="l6.1380">           target.selectionStart != target.selectionEnd)) ||</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-        (aEvent.keyCode &amp;&amp; aEvent.keyCode != aEvent.DOM_VK_RETURN))</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineplus">+        (aEvent.keyCode &amp;&amp; aEvent.keyCode != aEvent.DOM_VK_RETURN)) {</span>
<a href="#l6.1383"></a><span id="l6.1383">       return;</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineplus">+    }</span>
<a href="#l6.1385"></a><span id="l6.1385"> </span>
<a href="#l6.1386"></a><span id="l6.1386">     // Toggle between showing prettyPath and absolute filePath.</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineminus">-    if (target.getAttribute(&quot;showfilepath&quot;) == &quot;true&quot;)</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineminus">-    {</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineplus">+    if (target.getAttribute(&quot;showfilepath&quot;) == &quot;true&quot;) {</span>
<a href="#l6.1390"></a><span id="l6.1390">       target.setAttribute(&quot;showfilepath&quot;, false);</span>
<a href="#l6.1391"></a><span id="l6.1391">       target.value = target.getAttribute(&quot;prettypath&quot;);</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineminus">-    }</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineminus">-    else</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineminus">-    {</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineplus">+    } else {</span>
<a href="#l6.1396"></a><span id="l6.1396">       target.setAttribute(&quot;showfilepath&quot;, true);</span>
<a href="#l6.1397"></a><span id="l6.1397">       target.value = target.getAttribute(&quot;filepath&quot;);</span>
<a href="#l6.1398"></a><span id="l6.1398">     }</span>
<a href="#l6.1399"></a><span id="l6.1399">   },</span>
<a href="#l6.1400"></a><span id="l6.1400"> </span>
<a href="#l6.1401"></a><span id="l6.1401">   /**</span>
<a href="#l6.1402"></a><span id="l6.1402">    * The user changed the folder for storing the feed.</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineplus">+   *</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineplus">+   * @param {Event} aEvent - Event.</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineplus">+   * @returns {void}</span>
<a href="#l6.1406"></a><span id="l6.1406">    */</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineminus">-  setNewFolder: function(aEvent)</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineminus">-  {</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineplus">+  setNewFolder(aEvent) {</span>
<a href="#l6.1410"></a><span id="l6.1410">     aEvent.stopPropagation();</span>
<a href="#l6.1411"></a><span id="l6.1411">     this.setFolderPicker(aEvent.target._folder, true);</span>
<a href="#l6.1412"></a><span id="l6.1412"> </span>
<a href="#l6.1413"></a><span id="l6.1413">     let seln = this.mView.selection;</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineminus">-    if (seln.count != 1)</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineplus">+    if (seln.count != 1) {</span>
<a href="#l6.1416"></a><span id="l6.1416">       return;</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineplus">+    }</span>
<a href="#l6.1418"></a><span id="l6.1418"> </span>
<a href="#l6.1419"></a><span id="l6.1419">     let item = this.mView.getItemAtIndex(seln.currentIndex);</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineminus">-    if (!item || item.container || !item.parentFolder)</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineplus">+    if (!item || item.container || !item.parentFolder) {</span>
<a href="#l6.1422"></a><span id="l6.1422">       return;</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineplus">+    }</span>
<a href="#l6.1424"></a><span id="l6.1424"> </span>
<a href="#l6.1425"></a><span id="l6.1425">     let selectFolder = document.getElementById(&quot;selectFolder&quot;);</span>
<a href="#l6.1426"></a><span id="l6.1426">     let editFolderURI = selectFolder.getAttribute(&quot;uri&quot;);</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineminus">-    if (item.parentFolder.URI == editFolderURI)</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineplus">+    if (item.parentFolder.URI == editFolderURI) {</span>
<a href="#l6.1429"></a><span id="l6.1429">       return;</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineplus">+    }</span>
<a href="#l6.1431"></a><span id="l6.1431"> </span>
<a href="#l6.1432"></a><span id="l6.1432">     let feed = new Feed(item.url, item.parentFolder);</span>
<a href="#l6.1433"></a><span id="l6.1433"> </span>
<a href="#l6.1434"></a><span id="l6.1434">     // Make sure the new folderpicked folder is visible.</span>
<a href="#l6.1435"></a><span id="l6.1435">     this.selectFolder(selectFolder._folder);</span>
<a href="#l6.1436"></a><span id="l6.1436">     // Now go back to the feed item.</span>
<a href="#l6.1437"></a><span id="l6.1437">     this.selectFeed(feed, null);</span>
<a href="#l6.1438"></a><span id="l6.1438">     // We need to find the index of the new parent folder.</span>
<a href="#l6.1439"></a><span id="l6.1439">     let newParentIndex = this.mView.kRowIndexUndefined;</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineminus">-    for (let index = 0; index &lt; this.mView.rowCount; index++)</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineminus">-    {</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineplus">+    for (let index = 0; index &lt; this.mView.rowCount; index++) {</span>
<a href="#l6.1443"></a><span id="l6.1443">       let item = this.mView.getItemAtIndex(index);</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineminus">-      if (item &amp;&amp; item.container &amp;&amp; item.url == editFolderURI)</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineminus">-      {</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineplus">+      if (item &amp;&amp; item.container &amp;&amp; item.url == editFolderURI) {</span>
<a href="#l6.1447"></a><span id="l6.1447">         newParentIndex = index;</span>
<a href="#l6.1448"></a><span id="l6.1448">         break;</span>
<a href="#l6.1449"></a><span id="l6.1449">       }</span>
<a href="#l6.1450"></a><span id="l6.1450">     }</span>
<a href="#l6.1451"></a><span id="l6.1451"> </span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineminus">-    if (newParentIndex != this.mView.kRowIndexUndefined)</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineplus">+    if (newParentIndex != this.mView.kRowIndexUndefined) {</span>
<a href="#l6.1454"></a><span id="l6.1454">       this.moveCopyFeed(seln.currentIndex, newParentIndex, &quot;move&quot;);</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineplus">+    }</span>
<a href="#l6.1456"></a><span id="l6.1456">   },</span>
<a href="#l6.1457"></a><span id="l6.1457"> </span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-  setSummary: function(aChecked)</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-  {</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineplus">+  setSummary(aChecked) {</span>
<a href="#l6.1461"></a><span id="l6.1461">     let item = this.mView.currentItem;</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-    if (!item || !item.folder)</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineplus">+    if (!item || !item.folder) {</span>
<a href="#l6.1464"></a><span id="l6.1464">       // Not a folder.</span>
<a href="#l6.1465"></a><span id="l6.1465">       return;</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">-    if (item.folder.isServer)</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">-    {</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">-      if (document.getElementById(&quot;locationValue&quot;).value)</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineplus">+    }</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineplus">+</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineplus">+    if (item.folder.isServer) {</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineplus">+      if (document.getElementById(&quot;locationValue&quot;).value) {</span>
<a href="#l6.1474"></a><span id="l6.1474">         // Intent is to add a feed/folder to the account, so return.</span>
<a href="#l6.1475"></a><span id="l6.1475">         return;</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineplus">+      }</span>
<a href="#l6.1477"></a><span id="l6.1477"> </span>
<a href="#l6.1478"></a><span id="l6.1478">       // An account folder.  If it changes, all non feed containing subfolders</span>
<a href="#l6.1479"></a><span id="l6.1479">       // need to be updated with the new default.</span>
<a href="#l6.1480"></a><span id="l6.1480">       item.folder.server.setBoolValue(&quot;quickMode&quot;, aChecked);</span>
<a href="#l6.1481"></a><span id="l6.1481">       this.FolderListener.folderAdded(item.folder);</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineminus">-    }</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineminus">-    else if (!FeedUtils.getFeedUrlsInFolder(item.folder))</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineplus">+    } else if (!FeedUtils.getFeedUrlsInFolder(item.folder)) {</span>
<a href="#l6.1485"></a><span id="l6.1485">       // Not a folder with feeds.</span>
<a href="#l6.1486"></a><span id="l6.1486">       return;</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">-    else</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineminus">-    {</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineplus">+    } else {</span>
<a href="#l6.1490"></a><span id="l6.1490">       let feedsInFolder = this.getFeedsInFolder(item.folder);</span>
<a href="#l6.1491"></a><span id="l6.1491">       // Update the feeds database, for each feed in the folder.</span>
<a href="#l6.1492"></a><span id="l6.1492">       feedsInFolder.forEach(function(feed) { feed.quickMode = aChecked; });</span>
<a href="#l6.1493"></a><span id="l6.1493">       // Update the folder's feeds properties in the tree map.</span>
<a href="#l6.1494"></a><span id="l6.1494">       item.children.forEach(function(feed) { feed.quickMode = aChecked; });</span>
<a href="#l6.1495"></a><span id="l6.1495">       let ds = FeedUtils.getSubscriptionsDS(item.folder.server);</span>
<a href="#l6.1496"></a><span id="l6.1496">       ds.Flush();</span>
<a href="#l6.1497"></a><span id="l6.1497">     }</span>
<a href="#l6.1498"></a><span id="l6.1498"> </span>
<a href="#l6.1499"></a><span id="l6.1499">     // Update the folder in the tree map.</span>
<a href="#l6.1500"></a><span id="l6.1500">     item.quickMode = aChecked;</span>
<a href="#l6.1501"></a><span id="l6.1501">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedUpdated&quot;);</span>
<a href="#l6.1502"></a><span id="l6.1502">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1503"></a><span id="l6.1503">   },</span>
<a href="#l6.1504"></a><span id="l6.1504"> </span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-  setPrefs: function(aNode)</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-  {</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineplus">+  setPrefs(aNode) {</span>
<a href="#l6.1508"></a><span id="l6.1508">     let item = this.mView.currentItem;</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-    if (!item)</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineplus">+    if (!item) {</span>
<a href="#l6.1511"></a><span id="l6.1511">       return;</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineplus">+    }</span>
<a href="#l6.1513"></a><span id="l6.1513"> </span>
<a href="#l6.1514"></a><span id="l6.1514">     let isServer = item.folder &amp;&amp; item.folder.isServer;</span>
<a href="#l6.1515"></a><span id="l6.1515">     let isFolder = item.folder &amp;&amp; !item.folder.isServer;</span>
<a href="#l6.1516"></a><span id="l6.1516">     let updateEnabled = document.getElementById(&quot;updateEnabled&quot;);</span>
<a href="#l6.1517"></a><span id="l6.1517">     let updateValue = document.getElementById(&quot;updateValue&quot;);</span>
<a href="#l6.1518"></a><span id="l6.1518">     let biffUnits = document.getElementById(&quot;biffUnits&quot;);</span>
<a href="#l6.1519"></a><span id="l6.1519">     let autotagEnable = document.getElementById(&quot;autotagEnable&quot;);</span>
<a href="#l6.1520"></a><span id="l6.1520">     let autotagUsePrefix = document.getElementById(&quot;autotagUsePrefix&quot;);</span>
<a href="#l6.1521"></a><span id="l6.1521">     let autotagPrefix = document.getElementById(&quot;autotagPrefix&quot;);</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineminus">-    if (isFolder || (isServer &amp;&amp; document.getElementById(&quot;locationValue&quot;).value))</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineminus">-    {</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineplus">+    if (isFolder || (isServer &amp;&amp; document.getElementById(&quot;locationValue&quot;).value)) {</span>
<a href="#l6.1525"></a><span id="l6.1525">       // Intend to subscribe a feed to a folder, a value must be in the url</span>
<a href="#l6.1526"></a><span id="l6.1526">       // field. Update states for addFeed() and return.</span>
<a href="#l6.1527"></a><span id="l6.1527">       updateValue.disabled = !updateEnabled.checked;</span>
<a href="#l6.1528"></a><span id="l6.1528">       autotagUsePrefix.disabled = !autotagEnable.checked;</span>
<a href="#l6.1529"></a><span id="l6.1529">       autotagPrefix.disabled = autotagUsePrefix.disabled || !autotagUsePrefix.checked;</span>
<a href="#l6.1530"></a><span id="l6.1530">       return;</span>
<a href="#l6.1531"></a><span id="l6.1531">     }</span>
<a href="#l6.1532"></a><span id="l6.1532"> </span>
<a href="#l6.1533"></a><span id="l6.1533">     switch (aNode.id) {</span>
<a href="#l6.1534"></a><span id="l6.1534">       case &quot;nameValue&quot;:</span>
<a href="#l6.1535"></a><span id="l6.1535">         // Check to see if the title value changed, no blank title allowed.</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-        if (!aNode.value)</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-        {</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineplus">+        if (!aNode.value) {</span>
<a href="#l6.1539"></a><span id="l6.1539">           aNode.value = item.name;</span>
<a href="#l6.1540"></a><span id="l6.1540">           return;</span>
<a href="#l6.1541"></a><span id="l6.1541">         }</span>
<a href="#l6.1542"></a><span id="l6.1542"> </span>
<a href="#l6.1543"></a><span id="l6.1543">         item.name = aNode.value;</span>
<a href="#l6.1544"></a><span id="l6.1544">         let seln = this.mView.selection;</span>
<a href="#l6.1545"></a><span id="l6.1545">         seln.tree.invalidateRow(seln.currentIndex);</span>
<a href="#l6.1546"></a><span id="l6.1546">         break;</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineat">@@ -1217,46 +1191,42 @@ var FeedSubscriptions = {</span>
<a href="#l6.1548"></a><span id="l6.1548">         item.options.category.prefixEnabled = aNode.checked;</span>
<a href="#l6.1549"></a><span id="l6.1549">         item.options.category.prefix = autotagPrefix.value;</span>
<a href="#l6.1550"></a><span id="l6.1550">         break;</span>
<a href="#l6.1551"></a><span id="l6.1551">       case &quot;autotagPrefix&quot;:</span>
<a href="#l6.1552"></a><span id="l6.1552">         item.options.category.prefix = aNode.value;</span>
<a href="#l6.1553"></a><span id="l6.1553">         break;</span>
<a href="#l6.1554"></a><span id="l6.1554">     }</span>
<a href="#l6.1555"></a><span id="l6.1555"> </span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineminus">-    if (isServer)</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineminus">-    {</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineminus">-      FeedUtils.setOptionsAcct(item.folder.server, item.options)</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineminus">-    }</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineminus">-    else</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineminus">-    {</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineplus">+    if (isServer) {</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineplus">+      FeedUtils.setOptionsAcct(item.folder.server, item.options);</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineplus">+    } else {</span>
<a href="#l6.1565"></a><span id="l6.1565">       let feed = new Feed(item.url, item.parentFolder);</span>
<a href="#l6.1566"></a><span id="l6.1566">       feed.title = item.name;</span>
<a href="#l6.1567"></a><span id="l6.1567">       feed.options = item.options;</span>
<a href="#l6.1568"></a><span id="l6.1568">       let ds = FeedUtils.getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l6.1569"></a><span id="l6.1569">       ds.Flush();</span>
<a href="#l6.1570"></a><span id="l6.1570"> </span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineminus">-      if (aNode.id == &quot;updateEnabled&quot;)</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineminus">-      {</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineplus">+      if (aNode.id == &quot;updateEnabled&quot;) {</span>
<a href="#l6.1574"></a><span id="l6.1574">         FeedUtils.setStatus(item.parentFolder, item.url, &quot;enabled&quot;, aNode.checked);</span>
<a href="#l6.1575"></a><span id="l6.1575">         this.mView.selection.tree.invalidateRow(this.mView.selection.currentIndex);</span>
<a href="#l6.1576"></a><span id="l6.1576">       }</span>
<a href="#l6.1577"></a><span id="l6.1577">     }</span>
<a href="#l6.1578"></a><span id="l6.1578"> </span>
<a href="#l6.1579"></a><span id="l6.1579">     this.updateFeedData(item);</span>
<a href="#l6.1580"></a><span id="l6.1580">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedUpdated&quot;);</span>
<a href="#l6.1581"></a><span id="l6.1581">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1582"></a><span id="l6.1582">   },</span>
<a href="#l6.1583"></a><span id="l6.1583"> </span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineminus">-  getUpdateMinutesRec: function(aUpdates)</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineminus">-  {</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineplus">+  getUpdateMinutesRec(aUpdates) {</span>
<a href="#l6.1587"></a><span id="l6.1587">     // Assume the parser has stored correct/valid values for the spec. If the</span>
<a href="#l6.1588"></a><span id="l6.1588">     // feed doesn't use any of these tags, updatePeriod will be null.</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineminus">-    if (aUpdates.updatePeriod == null)</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineplus">+    if (aUpdates.updatePeriod == null) {</span>
<a href="#l6.1591"></a><span id="l6.1591">       return &quot;&quot;;</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineplus">+    }</span>
<a href="#l6.1593"></a><span id="l6.1593"> </span>
<a href="#l6.1594"></a><span id="l6.1594">     let biffUnits = document.getElementById(&quot;biffUnits&quot;).value;</span>
<a href="#l6.1595"></a><span id="l6.1595">     let units = biffUnits == FeedUtils.kBiffUnitsDays ? 1 : 24 * 60;</span>
<a href="#l6.1596"></a><span id="l6.1596">     let frequency = aUpdates.updateFrequency;</span>
<a href="#l6.1597"></a><span id="l6.1597">     let val;</span>
<a href="#l6.1598"></a><span id="l6.1598">     switch (aUpdates.updatePeriod) {</span>
<a href="#l6.1599"></a><span id="l6.1599">       case &quot;hourly&quot;:</span>
<a href="#l6.1600"></a><span id="l6.1600">         val = biffUnits == FeedUtils.kBiffUnitsDays ? 1 / frequency / 24 :</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineat">@@ -1274,156 +1244,146 @@ var FeedSubscriptions = {</span>
<a href="#l6.1602"></a><span id="l6.1602">       case &quot;yearly&quot;:</span>
<a href="#l6.1603"></a><span id="l6.1603">         val = 365 * units / frequency;</span>
<a href="#l6.1604"></a><span id="l6.1604">         break;</span>
<a href="#l6.1605"></a><span id="l6.1605">     }</span>
<a href="#l6.1606"></a><span id="l6.1606"> </span>
<a href="#l6.1607"></a><span id="l6.1607">     return val ? Math.round(val * 1000) / 1000 : &quot;&quot;;</span>
<a href="#l6.1608"></a><span id="l6.1608">   },</span>
<a href="#l6.1609"></a><span id="l6.1609"> </span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineminus">-  onKeyPress: function(aEvent)</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineminus">-  {</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineplus">+  onKeyPress(aEvent) {</span>
<a href="#l6.1613"></a><span id="l6.1613">     if (aEvent.keyCode == aEvent.DOM_VK_DELETE &amp;&amp;</span>
<a href="#l6.1614"></a><span id="l6.1614" class="difflineminus">-        aEvent.target.id == &quot;rssSubscriptionsList&quot;)</span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineplus">+        aEvent.target.id == &quot;rssSubscriptionsList&quot;) {</span>
<a href="#l6.1616"></a><span id="l6.1616">       this.removeFeed(true);</span>
<a href="#l6.1617"></a><span id="l6.1617" class="difflineplus">+    }</span>
<a href="#l6.1618"></a><span id="l6.1618"> </span>
<a href="#l6.1619"></a><span id="l6.1619">     this.clearStatusInfo();</span>
<a href="#l6.1620"></a><span id="l6.1620">   },</span>
<a href="#l6.1621"></a><span id="l6.1621"> </span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineminus">-  onSelect: function ()</span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineminus">-  {</span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineplus">+  onSelect() {</span>
<a href="#l6.1625"></a><span id="l6.1625">     let item = this.mView.currentItem;</span>
<a href="#l6.1626"></a><span id="l6.1626">     this.updateFeedData(item);</span>
<a href="#l6.1627"></a><span id="l6.1627">     this.setFocus();</span>
<a href="#l6.1628"></a><span id="l6.1628">     this.updateButtons(item);</span>
<a href="#l6.1629"></a><span id="l6.1629">   },</span>
<a href="#l6.1630"></a><span id="l6.1630"> </span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineminus">-  updateButtons: function (aSelectedItem)</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineminus">-  {</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineplus">+  updateButtons(aSelectedItem) {</span>
<a href="#l6.1634"></a><span id="l6.1634">     let item = aSelectedItem;</span>
<a href="#l6.1635"></a><span id="l6.1635">     let isServer = item &amp;&amp; item.folder &amp;&amp; item.folder.isServer;</span>
<a href="#l6.1636"></a><span id="l6.1636">     let isFeed = item &amp;&amp; !item.container;</span>
<a href="#l6.1637"></a><span id="l6.1637">     document.getElementById(&quot;addFeed&quot;).hidden = !item || isFeed;</span>
<a href="#l6.1638"></a><span id="l6.1638">     document.getElementById(&quot;updateFeed&quot;).hidden = !isFeed;</span>
<a href="#l6.1639"></a><span id="l6.1639">     document.getElementById(&quot;removeFeed&quot;).hidden = !isFeed;</span>
<a href="#l6.1640"></a><span id="l6.1640">     document.getElementById(&quot;importOPML&quot;).hidden = !isServer;</span>
<a href="#l6.1641"></a><span id="l6.1641">     document.getElementById(&quot;exportOPML&quot;).hidden = !isServer;</span>
<a href="#l6.1642"></a><span id="l6.1642"> </span>
<a href="#l6.1643"></a><span id="l6.1643">     document.getElementById(&quot;importOPML&quot;).disabled =</span>
<a href="#l6.1644"></a><span id="l6.1644">     document.getElementById(&quot;exportOPML&quot;).disabled =</span>
<a href="#l6.1645"></a><span id="l6.1645">       this.mActionMode == this.kImportingOPML;</span>
<a href="#l6.1646"></a><span id="l6.1646">   },</span>
<a href="#l6.1647"></a><span id="l6.1647"> </span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineminus">-  onMouseDown: function (aEvent)</span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineminus">-  {</span>
<a href="#l6.1650"></a><span id="l6.1650" class="difflineplus">+  onMouseDown(aEvent) {</span>
<a href="#l6.1651"></a><span id="l6.1651">     if (aEvent.button != 0 ||</span>
<a href="#l6.1652"></a><span id="l6.1652">         aEvent.target.id == &quot;validationText&quot; ||</span>
<a href="#l6.1653"></a><span id="l6.1653" class="difflineminus">-        aEvent.target.id == &quot;addCertException&quot;)</span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineplus">+        aEvent.target.id == &quot;addCertException&quot;) {</span>
<a href="#l6.1655"></a><span id="l6.1655">       return;</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineplus">+    }</span>
<a href="#l6.1657"></a><span id="l6.1657"> </span>
<a href="#l6.1658"></a><span id="l6.1658">     this.clearStatusInfo();</span>
<a href="#l6.1659"></a><span id="l6.1659">   },</span>
<a href="#l6.1660"></a><span id="l6.1660"> </span>
<a href="#l6.1661"></a><span id="l6.1661" class="difflineminus">-  onFocusChange: function ()</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineminus">-  {</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineplus">+  onFocusChange() {</span>
<a href="#l6.1664"></a><span id="l6.1664">     setTimeout(() =&gt; { this.setFocus(); }, 0);</span>
<a href="#l6.1665"></a><span id="l6.1665">   },</span>
<a href="#l6.1666"></a><span id="l6.1666"> </span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineminus">-  setFocus: function ()</span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineminus">-  {</span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineplus">+  setFocus() {</span>
<a href="#l6.1670"></a><span id="l6.1670">     let item = this.mView.currentItem;</span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineminus">-    if (!item || this.mActionMode == this.kImportingOPML)</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineplus">+    if (!item || this.mActionMode == this.kImportingOPML) {</span>
<a href="#l6.1673"></a><span id="l6.1673">       return;</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineminus">-</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineminus">-    let nameValue = document.getElementById(&quot;nameValue&quot;);</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineplus">+    }</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineplus">+</span>
<a href="#l6.1678"></a><span id="l6.1678">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l6.1679"></a><span id="l6.1679">     let updateEnabled = document.getElementById(&quot;updateEnabled&quot;);</span>
<a href="#l6.1680"></a><span id="l6.1680">     let updateValue = document.getElementById(&quot;updateValue&quot;);</span>
<a href="#l6.1681"></a><span id="l6.1681">     let biffMinutes = document.getElementById(&quot;biffMinutes&quot;);</span>
<a href="#l6.1682"></a><span id="l6.1682">     let biffDays = document.getElementById(&quot;biffDays&quot;);</span>
<a href="#l6.1683"></a><span id="l6.1683">     let quickMode = document.getElementById(&quot;quickMode&quot;);</span>
<a href="#l6.1684"></a><span id="l6.1684">     let autotagEnable = document.getElementById(&quot;autotagEnable&quot;);</span>
<a href="#l6.1685"></a><span id="l6.1685">     let autotagUsePrefix = document.getElementById(&quot;autotagUsePrefix&quot;);</span>
<a href="#l6.1686"></a><span id="l6.1686">     let autotagPrefix = document.getElementById(&quot;autotagPrefix&quot;);</span>
<a href="#l6.1687"></a><span id="l6.1687"> </span>
<a href="#l6.1688"></a><span id="l6.1688">     let addFeedButton = document.getElementById(&quot;addFeed&quot;);</span>
<a href="#l6.1689"></a><span id="l6.1689">     let updateFeedButton = document.getElementById(&quot;updateFeed&quot;);</span>
<a href="#l6.1690"></a><span id="l6.1690"> </span>
<a href="#l6.1691"></a><span id="l6.1691">     let isServer = item.folder &amp;&amp; item.folder.isServer;</span>
<a href="#l6.1692"></a><span id="l6.1692">     let isFolder = item.folder &amp;&amp; !item.folder.isServer;</span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineminus">-    let isFeed = !item.container;</span>
<a href="#l6.1694"></a><span id="l6.1694"> </span>
<a href="#l6.1695"></a><span id="l6.1695">     // Enabled by default.</span>
<a href="#l6.1696"></a><span id="l6.1696">     updateEnabled.disabled = quickMode.disabled = autotagEnable.disabled = false;</span>
<a href="#l6.1697"></a><span id="l6.1697">     updateValue.disabled = biffMinutes.disabled = biffDays.disabled = !updateEnabled.checked;</span>
<a href="#l6.1698"></a><span id="l6.1698">     autotagUsePrefix.disabled = !autotagEnable.checked;</span>
<a href="#l6.1699"></a><span id="l6.1699">     autotagPrefix.disabled = autotagUsePrefix.disabled || !autotagUsePrefix.checked;</span>
<a href="#l6.1700"></a><span id="l6.1700"> </span>
<a href="#l6.1701"></a><span id="l6.1701">     let focusedElement = window.document.commandDispatcher.focusedElement;</span>
<a href="#l6.1702"></a><span id="l6.1702"> </span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineminus">-    if (isServer)</span>
<a href="#l6.1704"></a><span id="l6.1704" class="difflineminus">-    {</span>
<a href="#l6.1705"></a><span id="l6.1705" class="difflineplus">+    if (isServer) {</span>
<a href="#l6.1706"></a><span id="l6.1706">       addFeedButton.disabled = addFeedButton != focusedElement &amp;&amp;</span>
<a href="#l6.1707"></a><span id="l6.1707">                               !locationValue.hasAttribute(&quot;focused&quot;) &amp;&amp;</span>
<a href="#l6.1708"></a><span id="l6.1708">                               !locationValue.value;</span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineminus">-    }</span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineminus">-    else if (isFolder)</span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineminus">-    {</span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineplus">+    } else if (isFolder) {</span>
<a href="#l6.1713"></a><span id="l6.1713">       let disable = !locationValue.hasAttribute(&quot;focused&quot;) &amp;&amp; !locationValue.value;</span>
<a href="#l6.1714"></a><span id="l6.1714">       // Summary is enabled for a folder with feeds or if adding a feed.</span>
<a href="#l6.1715"></a><span id="l6.1715">       quickMode.disabled = disable &amp;&amp; !FeedUtils.getFeedUrlsInFolder(item.folder);</span>
<a href="#l6.1716"></a><span id="l6.1716">       // All other options disabled unless intent is to add a feed.</span>
<a href="#l6.1717"></a><span id="l6.1717">       updateEnabled.disabled = autotagEnable.disabled = disable;</span>
<a href="#l6.1718"></a><span id="l6.1718"> </span>
<a href="#l6.1719"></a><span id="l6.1719">       addFeedButton.disabled = addFeedButton != focusedElement &amp;&amp;</span>
<a href="#l6.1720"></a><span id="l6.1720">                                !locationValue.hasAttribute(&quot;focused&quot;) &amp;&amp;</span>
<a href="#l6.1721"></a><span id="l6.1721">                                !locationValue.value;</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineminus">-    }</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineminus">-    else</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineminus">-    {</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineplus">+    } else {</span>
<a href="#l6.1726"></a><span id="l6.1726">       // Summary is disabled; applied per folder to apply to all feeds in it.</span>
<a href="#l6.1727"></a><span id="l6.1727">       quickMode.disabled = true;</span>
<a href="#l6.1728"></a><span id="l6.1728">       // Ensure the current feed url is restored if the user did not update.</span>
<a href="#l6.1729"></a><span id="l6.1729">       if (locationValue.value != item.url &amp;&amp;</span>
<a href="#l6.1730"></a><span id="l6.1730">           !locationValue.hasAttribute(&quot;focused&quot;) &amp;&amp;</span>
<a href="#l6.1731"></a><span id="l6.1731">           focusedElement != updateFeedButton &amp;&amp;</span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineminus">-          focusedElement.id != &quot;addCertException&quot;)</span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineminus">-      {</span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineplus">+          focusedElement.id != &quot;addCertException&quot;) {</span>
<a href="#l6.1735"></a><span id="l6.1735">         locationValue.value = item.url;</span>
<a href="#l6.1736"></a><span id="l6.1736">       }</span>
<a href="#l6.1737"></a><span id="l6.1737">       this.setPrefs(locationValue);</span>
<a href="#l6.1738"></a><span id="l6.1738">       // Set button state.</span>
<a href="#l6.1739"></a><span id="l6.1739">       updateFeedButton.disabled = (focusedElement != updateFeedButton ||</span>
<a href="#l6.1740"></a><span id="l6.1740">                                    updateFeedButton.disabled) &amp;&amp;</span>
<a href="#l6.1741"></a><span id="l6.1741">                                   !locationValue.hasAttribute(&quot;focused&quot;);</span>
<a href="#l6.1742"></a><span id="l6.1742">     }</span>
<a href="#l6.1743"></a><span id="l6.1743">   },</span>
<a href="#l6.1744"></a><span id="l6.1744"> </span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineminus">-  removeFeed: function (aPrompt)</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineminus">-  {</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineplus">+  removeFeed(aPrompt) {</span>
<a href="#l6.1748"></a><span id="l6.1748">     let seln = this.mView.selection;</span>
<a href="#l6.1749"></a><span id="l6.1749" class="difflineminus">-    if (seln.count != 1)</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineplus">+    if (seln.count != 1) {</span>
<a href="#l6.1751"></a><span id="l6.1751">       return;</span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineplus">+    }</span>
<a href="#l6.1753"></a><span id="l6.1753"> </span>
<a href="#l6.1754"></a><span id="l6.1754">     let itemToRemove = this.mView.getItemAtIndex(seln.currentIndex);</span>
<a href="#l6.1755"></a><span id="l6.1755"> </span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineminus">-    if (!itemToRemove || itemToRemove.container)</span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineplus">+    if (!itemToRemove || itemToRemove.container) {</span>
<a href="#l6.1758"></a><span id="l6.1758">       return;</span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineminus">-</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineminus">-    if (aPrompt)</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineminus">-    {</span>
<a href="#l6.1762"></a><span id="l6.1762" class="difflineplus">+    }</span>
<a href="#l6.1763"></a><span id="l6.1763" class="difflineplus">+</span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineplus">+    if (aPrompt) {</span>
<a href="#l6.1765"></a><span id="l6.1765">       // Confirm unsubscribe prompt.</span>
<a href="#l6.1766"></a><span id="l6.1766">       let pTitle = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.1767"></a><span id="l6.1767">                      &quot;subscribe-confirmFeedDeletionTitle&quot;);</span>
<a href="#l6.1768"></a><span id="l6.1768">       let pMessage = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.1769"></a><span id="l6.1769">                        &quot;subscribe-confirmFeedDeletion&quot;, [itemToRemove.name], 1);</span>
<a href="#l6.1770"></a><span id="l6.1770">       if (Services.prompt.confirmEx(window, pTitle, pMessage,</span>
<a href="#l6.1771"></a><span id="l6.1771">                                     Ci.nsIPromptService.STD_YES_NO_BUTTONS,</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineminus">-                                    null, null, null, null, { }))</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineplus">+                                    null, null, null, null, { })) {</span>
<a href="#l6.1774"></a><span id="l6.1774">         return;</span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineplus">+      }</span>
<a href="#l6.1776"></a><span id="l6.1776">     }</span>
<a href="#l6.1777"></a><span id="l6.1777"> </span>
<a href="#l6.1778"></a><span id="l6.1778">     let feed = new Feed(itemToRemove.url, itemToRemove.parentFolder);</span>
<a href="#l6.1779"></a><span id="l6.1779">     FeedUtils.deleteFeed(feed);</span>
<a href="#l6.1780"></a><span id="l6.1780"> </span>
<a href="#l6.1781"></a><span id="l6.1781">     // Now that we have removed the feed from the datasource, it is time to</span>
<a href="#l6.1782"></a><span id="l6.1782">     // update our view layer.  Update parent folder's quickMode if necessary</span>
<a href="#l6.1783"></a><span id="l6.1783">     // and remove the child from its parent folder object.</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineat">@@ -1440,352 +1400,348 @@ var FeedSubscriptions = {</span>
<a href="#l6.1785"></a><span id="l6.1785">    * This addFeed is used by 1) Add button, 1) Update button, 3) Drop of a</span>
<a href="#l6.1786"></a><span id="l6.1786">    * feed url on a folder (which can be an add or move).  If Update, the new</span>
<a href="#l6.1787"></a><span id="l6.1787">    * url is added and the old removed; thus aParse is false and no new messages</span>
<a href="#l6.1788"></a><span id="l6.1788">    * are downloaded, the feed is only validated and stored in the db.  If dnd,</span>
<a href="#l6.1789"></a><span id="l6.1789">    * the drop folder is selected and the url is prefilled, so proceed just as</span>
<a href="#l6.1790"></a><span id="l6.1790">    * though the url were entered manually.  This allows a user to see the dnd</span>
<a href="#l6.1791"></a><span id="l6.1791">    * url better in case of errors.</span>
<a href="#l6.1792"></a><span id="l6.1792">    *</span>
<a href="#l6.1793"></a><span id="l6.1793" class="difflineminus">-   * @param  [aFeedLocation] string    - the feed url; get the url from the</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineplus">+   * @param {String} aFeedLocation     - the feed url; get the url from the</span>
<a href="#l6.1795"></a><span id="l6.1795">    *                                     input field if null.</span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineminus">-   * @param  [aFolder] nsIMsgFolder    - folder to subscribe, current selected</span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineplus">+   * @param {nsIMsgFolder} aFolder     - folder to subscribe, current selected</span>
<a href="#l6.1798"></a><span id="l6.1798">    *                                     folder if null.</span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineminus">-   * @param  [aParse] boolean          - if true (default) parse and download</span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineplus">+   * @param {Boolean} aParse           - if true (default) parse and download</span>
<a href="#l6.1801"></a><span id="l6.1801">    *                                     the feed's articles.</span>
<a href="#l6.1802"></a><span id="l6.1802" class="difflineminus">-   * @param  [aParams] object          - additional params.</span>
<a href="#l6.1803"></a><span id="l6.1803" class="difflineminus">-   * @param  [aMode] integer           - action mode (default is kSubscribeMode)</span>
<a href="#l6.1804"></a><span id="l6.1804" class="difflineplus">+   * @param {Object} aParams           - additional params.</span>
<a href="#l6.1805"></a><span id="l6.1805" class="difflineplus">+   * @param {Integer} aMode            - action mode (default is kSubscribeMode)</span>
<a href="#l6.1806"></a><span id="l6.1806">    *                                     of the add.</span>
<a href="#l6.1807"></a><span id="l6.1807">    *</span>
<a href="#l6.1808"></a><span id="l6.1808" class="difflineminus">-   * @return success boolean           - true if edit checks passed and an</span>
<a href="#l6.1809"></a><span id="l6.1809" class="difflineplus">+   * @returns {Boolean} success        - true if edit checks passed and an</span>
<a href="#l6.1810"></a><span id="l6.1810">    *                                     async download has been initiated.</span>
<a href="#l6.1811"></a><span id="l6.1811">    */</span>
<a href="#l6.1812"></a><span id="l6.1812" class="difflineminus">-  addFeed: function(aFeedLocation, aFolder, aParse, aParams, aMode)</span>
<a href="#l6.1813"></a><span id="l6.1813" class="difflineminus">-  {</span>
<a href="#l6.1814"></a><span id="l6.1814" class="difflineplus">+  addFeed(aFeedLocation, aFolder, aParse, aParams, aMode) {</span>
<a href="#l6.1815"></a><span id="l6.1815">     let message;</span>
<a href="#l6.1816"></a><span id="l6.1816">     let parse = aParse == null ? true : aParse;</span>
<a href="#l6.1817"></a><span id="l6.1817">     let mode = aMode == null ? this.kSubscribeMode : aMode;</span>
<a href="#l6.1818"></a><span id="l6.1818">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l6.1819"></a><span id="l6.1819">     let quickMode = aParams &amp;&amp; (&quot;quickMode&quot; in aParams) ?</span>
<a href="#l6.1820"></a><span id="l6.1820">         aParams.quickMode : document.getElementById(&quot;quickMode&quot;).checked;</span>
<a href="#l6.1821"></a><span id="l6.1821">     let name = aParams &amp;&amp; (&quot;name&quot; in aParams) ?</span>
<a href="#l6.1822"></a><span id="l6.1822">         aParams.name : document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l6.1823"></a><span id="l6.1823">     let options = aParams &amp;&amp; (&quot;options&quot; in aParams) ?</span>
<a href="#l6.1824"></a><span id="l6.1824">         aParams.options : null;</span>
<a href="#l6.1825"></a><span id="l6.1825"> </span>
<a href="#l6.1826"></a><span id="l6.1826" class="difflineminus">-    if (aFeedLocation)</span>
<a href="#l6.1827"></a><span id="l6.1827" class="difflineplus">+    if (aFeedLocation) {</span>
<a href="#l6.1828"></a><span id="l6.1828">       locationValue.value = aFeedLocation;</span>
<a href="#l6.1829"></a><span id="l6.1829" class="difflineplus">+    }</span>
<a href="#l6.1830"></a><span id="l6.1830">     let feedLocation = locationValue.value.trim();</span>
<a href="#l6.1831"></a><span id="l6.1831"> </span>
<a href="#l6.1832"></a><span id="l6.1832" class="difflineminus">-    if (!feedLocation)</span>
<a href="#l6.1833"></a><span id="l6.1833" class="difflineminus">-    {</span>
<a href="#l6.1834"></a><span id="l6.1834" class="difflineplus">+    if (!feedLocation) {</span>
<a href="#l6.1835"></a><span id="l6.1835">       locationValue.focus();</span>
<a href="#l6.1836"></a><span id="l6.1836">       message = locationValue.getAttribute(&quot;placeholder&quot;);</span>
<a href="#l6.1837"></a><span id="l6.1837">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1838"></a><span id="l6.1838">       return false;</span>
<a href="#l6.1839"></a><span id="l6.1839">     }</span>
<a href="#l6.1840"></a><span id="l6.1840"> </span>
<a href="#l6.1841"></a><span id="l6.1841" class="difflineminus">-    if (!FeedUtils.isValidScheme(feedLocation))</span>
<a href="#l6.1842"></a><span id="l6.1842" class="difflineminus">-    {</span>
<a href="#l6.1843"></a><span id="l6.1843" class="difflineplus">+    if (!FeedUtils.isValidScheme(feedLocation)) {</span>
<a href="#l6.1844"></a><span id="l6.1844">       locationValue.focus();</span>
<a href="#l6.1845"></a><span id="l6.1845">       message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedNotValid&quot;);</span>
<a href="#l6.1846"></a><span id="l6.1846">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1847"></a><span id="l6.1847">       return false;</span>
<a href="#l6.1848"></a><span id="l6.1848">     }</span>
<a href="#l6.1849"></a><span id="l6.1849"> </span>
<a href="#l6.1850"></a><span id="l6.1850">     let addFolder;</span>
<a href="#l6.1851"></a><span id="l6.1851" class="difflineminus">-    if (aFolder)</span>
<a href="#l6.1852"></a><span id="l6.1852" class="difflineminus">-    {</span>
<a href="#l6.1853"></a><span id="l6.1853" class="difflineplus">+    if (aFolder) {</span>
<a href="#l6.1854"></a><span id="l6.1854">       // For Update or if passed a folder.</span>
<a href="#l6.1855"></a><span id="l6.1855" class="difflineminus">-      if (aFolder instanceof Ci.nsIMsgFolder)</span>
<a href="#l6.1856"></a><span id="l6.1856" class="difflineplus">+      if (aFolder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l6.1857"></a><span id="l6.1857">         addFolder = aFolder;</span>
<a href="#l6.1858"></a><span id="l6.1858" class="difflineminus">-    }</span>
<a href="#l6.1859"></a><span id="l6.1859" class="difflineminus">-    else</span>
<a href="#l6.1860"></a><span id="l6.1860" class="difflineminus">-    {</span>
<a href="#l6.1861"></a><span id="l6.1861" class="difflineplus">+      }</span>
<a href="#l6.1862"></a><span id="l6.1862" class="difflineplus">+    } else {</span>
<a href="#l6.1863"></a><span id="l6.1863">       // A folder must be selected for Add and Drop.</span>
<a href="#l6.1864"></a><span id="l6.1864">       let index = this.mView.selection.currentIndex;</span>
<a href="#l6.1865"></a><span id="l6.1865">       let item = this.mView.getItemAtIndex(index);</span>
<a href="#l6.1866"></a><span id="l6.1866" class="difflineminus">-      if (item &amp;&amp; item.container)</span>
<a href="#l6.1867"></a><span id="l6.1867" class="difflineplus">+      if (item &amp;&amp; item.container) {</span>
<a href="#l6.1868"></a><span id="l6.1868">         addFolder = item.folder;</span>
<a href="#l6.1869"></a><span id="l6.1869" class="difflineplus">+      }</span>
<a href="#l6.1870"></a><span id="l6.1870">     }</span>
<a href="#l6.1871"></a><span id="l6.1871"> </span>
<a href="#l6.1872"></a><span id="l6.1872">     // Shouldn't happen.  Or else not passed an nsIMsgFolder.</span>
<a href="#l6.1873"></a><span id="l6.1873" class="difflineminus">-    if (!addFolder)</span>
<a href="#l6.1874"></a><span id="l6.1874" class="difflineplus">+    if (!addFolder) {</span>
<a href="#l6.1875"></a><span id="l6.1875">       return false;</span>
<a href="#l6.1876"></a><span id="l6.1876" class="difflineplus">+    }</span>
<a href="#l6.1877"></a><span id="l6.1877"> </span>
<a href="#l6.1878"></a><span id="l6.1878">     // Before we go any further, make sure the user is not already subscribed</span>
<a href="#l6.1879"></a><span id="l6.1879">     // to this feed.</span>
<a href="#l6.1880"></a><span id="l6.1880" class="difflineminus">-    if (FeedUtils.feedAlreadyExists(feedLocation, addFolder.server))</span>
<a href="#l6.1881"></a><span id="l6.1881" class="difflineminus">-    {</span>
<a href="#l6.1882"></a><span id="l6.1882" class="difflineplus">+    if (FeedUtils.feedAlreadyExists(feedLocation, addFolder.server)) {</span>
<a href="#l6.1883"></a><span id="l6.1883">       locationValue.focus();</span>
<a href="#l6.1884"></a><span id="l6.1884">       message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.1885"></a><span id="l6.1885">                   &quot;subscribe-feedAlreadySubscribed&quot;);</span>
<a href="#l6.1886"></a><span id="l6.1886">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1887"></a><span id="l6.1887">       return false;</span>
<a href="#l6.1888"></a><span id="l6.1888">     }</span>
<a href="#l6.1889"></a><span id="l6.1889"> </span>
<a href="#l6.1890"></a><span id="l6.1890" class="difflineminus">-    if (!options)</span>
<a href="#l6.1891"></a><span id="l6.1891" class="difflineminus">-    {</span>
<a href="#l6.1892"></a><span id="l6.1892" class="difflineplus">+    if (!options) {</span>
<a href="#l6.1893"></a><span id="l6.1893">       // Not passed a param, get values from the ui.</span>
<a href="#l6.1894"></a><span id="l6.1894">       options = FeedUtils.optionsTemplate;</span>
<a href="#l6.1895"></a><span id="l6.1895">       options.updates.enabled = document.getElementById(&quot;updateEnabled&quot;).checked;</span>
<a href="#l6.1896"></a><span id="l6.1896">       let biffUnits = document.getElementById(&quot;biffUnits&quot;).value;</span>
<a href="#l6.1897"></a><span id="l6.1897">       let units = document.getElementById(&quot;updateValue&quot;).valueNumber;</span>
<a href="#l6.1898"></a><span id="l6.1898">       let minutes = biffUnits == FeedUtils.kBiffUnitsMinutes ? units : units * 24 * 60;</span>
<a href="#l6.1899"></a><span id="l6.1899">       options.updates.updateUnits = biffUnits;</span>
<a href="#l6.1900"></a><span id="l6.1900">       options.updates.updateMinutes = minutes;</span>
<a href="#l6.1901"></a><span id="l6.1901">       options.category.enabled = document.getElementById(&quot;autotagEnable&quot;).checked;</span>
<a href="#l6.1902"></a><span id="l6.1902">       options.category.prefixEnabled = document.getElementById(&quot;autotagUsePrefix&quot;).checked;</span>
<a href="#l6.1903"></a><span id="l6.1903">       options.category.prefix = document.getElementById(&quot;autotagPrefix&quot;).value;</span>
<a href="#l6.1904"></a><span id="l6.1904">     }</span>
<a href="#l6.1905"></a><span id="l6.1905"> </span>
<a href="#l6.1906"></a><span id="l6.1906" class="difflineminus">-    let feedProperties = { feedName     : name,</span>
<a href="#l6.1907"></a><span id="l6.1907" class="difflineminus">-                           feedLocation : feedLocation,</span>
<a href="#l6.1908"></a><span id="l6.1908" class="difflineminus">-                           feedFolder   : addFolder,</span>
<a href="#l6.1909"></a><span id="l6.1909" class="difflineminus">-                           quickMode    : quickMode,</span>
<a href="#l6.1910"></a><span id="l6.1910" class="difflineminus">-                           options      : options };</span>
<a href="#l6.1911"></a><span id="l6.1911" class="difflineplus">+    let feedProperties = { feedName: name,</span>
<a href="#l6.1912"></a><span id="l6.1912" class="difflineplus">+                           feedLocation,</span>
<a href="#l6.1913"></a><span id="l6.1913" class="difflineplus">+                           feedFolder: addFolder,</span>
<a href="#l6.1914"></a><span id="l6.1914" class="difflineplus">+                           quickMode,</span>
<a href="#l6.1915"></a><span id="l6.1915" class="difflineplus">+                           options,</span>
<a href="#l6.1916"></a><span id="l6.1916" class="difflineplus">+                         };</span>
<a href="#l6.1917"></a><span id="l6.1917"> </span>
<a href="#l6.1918"></a><span id="l6.1918">     let feed = this.storeFeed(feedProperties);</span>
<a href="#l6.1919"></a><span id="l6.1919" class="difflineminus">-    if (!feed)</span>
<a href="#l6.1920"></a><span id="l6.1920" class="difflineplus">+    if (!feed) {</span>
<a href="#l6.1921"></a><span id="l6.1921">       return false;</span>
<a href="#l6.1922"></a><span id="l6.1922" class="difflineplus">+    }</span>
<a href="#l6.1923"></a><span id="l6.1923"> </span>
<a href="#l6.1924"></a><span id="l6.1924">     // Now validate and start downloading the feed.</span>
<a href="#l6.1925"></a><span id="l6.1925">     message = FeedUtils.strings.GetStringFromName(&quot;subscribe-validating-feed&quot;);</span>
<a href="#l6.1926"></a><span id="l6.1926">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1927"></a><span id="l6.1927">     this.updateStatusItem(&quot;progressMeter&quot;, &quot;?&quot;);</span>
<a href="#l6.1928"></a><span id="l6.1928">     document.getElementById(&quot;addFeed&quot;).disabled = true;</span>
<a href="#l6.1929"></a><span id="l6.1929">     this.mActionMode = mode;</span>
<a href="#l6.1930"></a><span id="l6.1930">     feed.download(parse, this.mFeedDownloadCallback);</span>
<a href="#l6.1931"></a><span id="l6.1931">     return true;</span>
<a href="#l6.1932"></a><span id="l6.1932">   },</span>
<a href="#l6.1933"></a><span id="l6.1933"> </span>
<a href="#l6.1934"></a><span id="l6.1934">   // Helper routine used by addFeed and importOPMLFile.</span>
<a href="#l6.1935"></a><span id="l6.1935" class="difflineminus">-  storeFeed: function(feedProperties)</span>
<a href="#l6.1936"></a><span id="l6.1936" class="difflineminus">-  {</span>
<a href="#l6.1937"></a><span id="l6.1937" class="difflineplus">+  storeFeed(feedProperties) {</span>
<a href="#l6.1938"></a><span id="l6.1938">     let feed = new Feed(feedProperties.feedLocation, feedProperties.feedFolder);</span>
<a href="#l6.1939"></a><span id="l6.1939">     feed.title = feedProperties.feedName;</span>
<a href="#l6.1940"></a><span id="l6.1940">     feed.quickMode = feedProperties.quickMode;</span>
<a href="#l6.1941"></a><span id="l6.1941">     feed.options = feedProperties.options;</span>
<a href="#l6.1942"></a><span id="l6.1942">     return feed;</span>
<a href="#l6.1943"></a><span id="l6.1943">   },</span>
<a href="#l6.1944"></a><span id="l6.1944"> </span>
<a href="#l6.1945"></a><span id="l6.1945">   /**</span>
<a href="#l6.1946"></a><span id="l6.1946">    * When a feed item is selected, the Update button is used to verify the</span>
<a href="#l6.1947"></a><span id="l6.1947">    * existing feed url, or to verify and update the feed url if the field</span>
<a href="#l6.1948"></a><span id="l6.1948">    * has been edited. This is the only use of the Update button.</span>
<a href="#l6.1949"></a><span id="l6.1949" class="difflineplus">+   *</span>
<a href="#l6.1950"></a><span id="l6.1950" class="difflineplus">+   * @returns {void}</span>
<a href="#l6.1951"></a><span id="l6.1951">    */</span>
<a href="#l6.1952"></a><span id="l6.1952" class="difflineminus">-  updateFeed: function()</span>
<a href="#l6.1953"></a><span id="l6.1953" class="difflineminus">-  {</span>
<a href="#l6.1954"></a><span id="l6.1954" class="difflineplus">+  updateFeed() {</span>
<a href="#l6.1955"></a><span id="l6.1955">     let seln = this.mView.selection;</span>
<a href="#l6.1956"></a><span id="l6.1956" class="difflineminus">-    if (seln.count != 1)</span>
<a href="#l6.1957"></a><span id="l6.1957" class="difflineplus">+    if (seln.count != 1) {</span>
<a href="#l6.1958"></a><span id="l6.1958">       return;</span>
<a href="#l6.1959"></a><span id="l6.1959" class="difflineplus">+    }</span>
<a href="#l6.1960"></a><span id="l6.1960"> </span>
<a href="#l6.1961"></a><span id="l6.1961">     let item = this.mView.getItemAtIndex(seln.currentIndex);</span>
<a href="#l6.1962"></a><span id="l6.1962" class="difflineminus">-    if (!item || item.container || !item.parentFolder)</span>
<a href="#l6.1963"></a><span id="l6.1963" class="difflineplus">+    if (!item || item.container || !item.parentFolder) {</span>
<a href="#l6.1964"></a><span id="l6.1964">       return;</span>
<a href="#l6.1965"></a><span id="l6.1965" class="difflineplus">+    }</span>
<a href="#l6.1966"></a><span id="l6.1966"> </span>
<a href="#l6.1967"></a><span id="l6.1967">     let feed = new Feed(item.url, item.parentFolder);</span>
<a href="#l6.1968"></a><span id="l6.1968"> </span>
<a href="#l6.1969"></a><span id="l6.1969">     // Disable the button.</span>
<a href="#l6.1970"></a><span id="l6.1970">     document.getElementById(&quot;updateFeed&quot;).disabled = true;</span>
<a href="#l6.1971"></a><span id="l6.1971"> </span>
<a href="#l6.1972"></a><span id="l6.1972">     let feedLocation = document.getElementById(&quot;locationValue&quot;).value.trim();</span>
<a href="#l6.1973"></a><span id="l6.1973" class="difflineminus">-    if (feed.url != feedLocation)</span>
<a href="#l6.1974"></a><span id="l6.1974" class="difflineminus">-    {</span>
<a href="#l6.1975"></a><span id="l6.1975" class="difflineplus">+    if (feed.url != feedLocation) {</span>
<a href="#l6.1976"></a><span id="l6.1976">       // Updating a url.  We need to add the new url and delete the old, to</span>
<a href="#l6.1977"></a><span id="l6.1977">       // ensure everything is cleaned up correctly.</span>
<a href="#l6.1978"></a><span id="l6.1978" class="difflineminus">-      this.addFeed(null, item.parentFolder, false, null, this.kUpdateMode)</span>
<a href="#l6.1979"></a><span id="l6.1979" class="difflineplus">+      this.addFeed(null, item.parentFolder, false, null, this.kUpdateMode);</span>
<a href="#l6.1980"></a><span id="l6.1980">       return;</span>
<a href="#l6.1981"></a><span id="l6.1981">     }</span>
<a href="#l6.1982"></a><span id="l6.1982"> </span>
<a href="#l6.1983"></a><span id="l6.1983">     // Now we want to verify if the stored feed url still works. If it</span>
<a href="#l6.1984"></a><span id="l6.1984">     // doesn't, show the error.</span>
<a href="#l6.1985"></a><span id="l6.1985">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-validating-feed&quot;);</span>
<a href="#l6.1986"></a><span id="l6.1986">     this.mActionMode = this.kVerifyUrlMode;</span>
<a href="#l6.1987"></a><span id="l6.1987">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.1988"></a><span id="l6.1988">     this.updateStatusItem(&quot;progressMeter&quot;, &quot;?&quot;);</span>
<a href="#l6.1989"></a><span id="l6.1989">     feed.download(false, this.mFeedDownloadCallback);</span>
<a href="#l6.1990"></a><span id="l6.1990">   },</span>
<a href="#l6.1991"></a><span id="l6.1991"> </span>
<a href="#l6.1992"></a><span id="l6.1992"> /**</span>
<a href="#l6.1993"></a><span id="l6.1993">  * Moves or copies a feed to another folder or account.</span>
<a href="#l6.1994"></a><span id="l6.1994">  *</span>
<a href="#l6.1995"></a><span id="l6.1995" class="difflineminus">- * @param  int aOldFeedIndex    - index in tree of target feed item.</span>
<a href="#l6.1996"></a><span id="l6.1996" class="difflineminus">- * @param  int aNewParentIndex  - index in tree of target parent folder item.</span>
<a href="#l6.1997"></a><span id="l6.1997" class="difflineminus">- * @param  string aMoveCopy     - either &quot;move&quot; or &quot;copy&quot;.</span>
<a href="#l6.1998"></a><span id="l6.1998" class="difflineplus">+ * @param {Integer} aOldFeedIndex   - Index in tree of target feed item.</span>
<a href="#l6.1999"></a><span id="l6.1999" class="difflineplus">+ * @param {Integer} aNewParentIndex - Index in tree of target parent folder item.</span>
<a href="#l6.2000"></a><span id="l6.2000" class="difflineplus">+ * @param {String} aMoveCopy        - Either &quot;move&quot; or &quot;copy&quot;.</span>
<a href="#l6.2001"></a><span id="l6.2001" class="difflineplus">+ *</span>
<a href="#l6.2002"></a><span id="l6.2002" class="difflineplus">+ * @returns {void}</span>
<a href="#l6.2003"></a><span id="l6.2003">  */</span>
<a href="#l6.2004"></a><span id="l6.2004" class="difflineminus">-  moveCopyFeed: function(aOldFeedIndex, aNewParentIndex, aMoveCopy)</span>
<a href="#l6.2005"></a><span id="l6.2005" class="difflineminus">-  {</span>
<a href="#l6.2006"></a><span id="l6.2006" class="difflineplus">+  moveCopyFeed(aOldFeedIndex, aNewParentIndex, aMoveCopy) {</span>
<a href="#l6.2007"></a><span id="l6.2007">     let moveFeed = aMoveCopy == &quot;move&quot;;</span>
<a href="#l6.2008"></a><span id="l6.2008">     let currentItem = this.mView.getItemAtIndex(aOldFeedIndex);</span>
<a href="#l6.2009"></a><span id="l6.2009">     if (!currentItem ||</span>
<a href="#l6.2010"></a><span id="l6.2010" class="difflineminus">-        this.mView.getParentIndex(aOldFeedIndex) == aNewParentIndex)</span>
<a href="#l6.2011"></a><span id="l6.2011" class="difflineplus">+        this.mView.getParentIndex(aOldFeedIndex) == aNewParentIndex) {</span>
<a href="#l6.2012"></a><span id="l6.2012">       // If the new parent is the same as the current parent, then do nothing.</span>
<a href="#l6.2013"></a><span id="l6.2013">       return;</span>
<a href="#l6.2014"></a><span id="l6.2014" class="difflineplus">+    }</span>
<a href="#l6.2015"></a><span id="l6.2015"> </span>
<a href="#l6.2016"></a><span id="l6.2016">     let currentParentIndex = this.mView.getParentIndex(aOldFeedIndex);</span>
<a href="#l6.2017"></a><span id="l6.2017">     let currentParentItem = this.mView.getItemAtIndex(currentParentIndex);</span>
<a href="#l6.2018"></a><span id="l6.2018">     let currentParentResource = FeedUtils.rdf.GetResource(currentParentItem.url);</span>
<a href="#l6.2019"></a><span id="l6.2019">     let currentFolder = currentParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.2020"></a><span id="l6.2020"> </span>
<a href="#l6.2021"></a><span id="l6.2021">     let newParentItem = this.mView.getItemAtIndex(aNewParentIndex);</span>
<a href="#l6.2022"></a><span id="l6.2022">     let newParentResource = FeedUtils.rdf.GetResource(newParentItem.url);</span>
<a href="#l6.2023"></a><span id="l6.2023">     let newFolder = newParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.2024"></a><span id="l6.2024"> </span>
<a href="#l6.2025"></a><span id="l6.2025">     let accountMoveCopy = false;</span>
<a href="#l6.2026"></a><span id="l6.2026" class="difflineminus">-    if (currentFolder.rootFolder.URI == newFolder.rootFolder.URI)</span>
<a href="#l6.2027"></a><span id="l6.2027" class="difflineminus">-    {</span>
<a href="#l6.2028"></a><span id="l6.2028" class="difflineplus">+    if (currentFolder.rootFolder.URI == newFolder.rootFolder.URI) {</span>
<a href="#l6.2029"></a><span id="l6.2029">       // Moving within the same account/feeds db.</span>
<a href="#l6.2030"></a><span id="l6.2030" class="difflineminus">-      if (newFolder.isServer || !moveFeed)</span>
<a href="#l6.2031"></a><span id="l6.2031" class="difflineplus">+      if (newFolder.isServer || !moveFeed) {</span>
<a href="#l6.2032"></a><span id="l6.2032">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l6.2033"></a><span id="l6.2033">         // not copy, to folder in the same account.</span>
<a href="#l6.2034"></a><span id="l6.2034">         return;</span>
<a href="#l6.2035"></a><span id="l6.2035" class="difflineplus">+      }</span>
<a href="#l6.2036"></a><span id="l6.2036"> </span>
<a href="#l6.2037"></a><span id="l6.2037">       // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l6.2038"></a><span id="l6.2038">       let feedResource = FeedUtils.rdf.GetResource(currentItem.url);</span>
<a href="#l6.2039"></a><span id="l6.2039">       let ds = FeedUtils.getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l6.2040"></a><span id="l6.2040">       ds.Change(feedResource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l6.2041"></a><span id="l6.2041">                 currentParentResource, newParentResource);</span>
<a href="#l6.2042"></a><span id="l6.2042">       ds.Flush();</span>
<a href="#l6.2043"></a><span id="l6.2043"> </span>
<a href="#l6.2044"></a><span id="l6.2044">       // Update folderpane favicons.</span>
<a href="#l6.2045"></a><span id="l6.2045">       FeedUtils.setFolderPaneProperty(currentFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l6.2046"></a><span id="l6.2046">       FeedUtils.setFolderPaneProperty(newFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l6.2047"></a><span id="l6.2047" class="difflineminus">-    }</span>
<a href="#l6.2048"></a><span id="l6.2048" class="difflineminus">-    else</span>
<a href="#l6.2049"></a><span id="l6.2049" class="difflineminus">-    {</span>
<a href="#l6.2050"></a><span id="l6.2050" class="difflineplus">+    } else {</span>
<a href="#l6.2051"></a><span id="l6.2051">       // Moving/copying to a new account.  If dropping on the account folder,</span>
<a href="#l6.2052"></a><span id="l6.2052">       // a new subfolder is created if necessary.</span>
<a href="#l6.2053"></a><span id="l6.2053">       accountMoveCopy = true;</span>
<a href="#l6.2054"></a><span id="l6.2054">       let mode = moveFeed ? this.kMoveMode : this.kCopyMode;</span>
<a href="#l6.2055"></a><span id="l6.2055" class="difflineminus">-      let params = {quickMode: currentItem.quickMode,</span>
<a href="#l6.2056"></a><span id="l6.2056" class="difflineminus">-                    name:      currentItem.name,</span>
<a href="#l6.2057"></a><span id="l6.2057" class="difflineminus">-                    options:   currentItem.options};</span>
<a href="#l6.2058"></a><span id="l6.2058" class="difflineplus">+      let params = { quickMode: currentItem.quickMode,</span>
<a href="#l6.2059"></a><span id="l6.2059" class="difflineplus">+                     name:      currentItem.name,</span>
<a href="#l6.2060"></a><span id="l6.2060" class="difflineplus">+                     options:   currentItem.options,</span>
<a href="#l6.2061"></a><span id="l6.2061" class="difflineplus">+                   };</span>
<a href="#l6.2062"></a><span id="l6.2062">       // Subscribe to the new folder first.  If it already exists in the</span>
<a href="#l6.2063"></a><span id="l6.2063">       // account or on error, return.</span>
<a href="#l6.2064"></a><span id="l6.2064" class="difflineminus">-      if (!this.addFeed(currentItem.url, newFolder, false, params, mode))</span>
<a href="#l6.2065"></a><span id="l6.2065" class="difflineplus">+      if (!this.addFeed(currentItem.url, newFolder, false, params, mode)) {</span>
<a href="#l6.2066"></a><span id="l6.2066">         return;</span>
<a href="#l6.2067"></a><span id="l6.2067" class="difflineplus">+      }</span>
<a href="#l6.2068"></a><span id="l6.2068">       // Unsubscribe the feed from the old folder, if add to the new folder</span>
<a href="#l6.2069"></a><span id="l6.2069">       // is successful, and doing a move.</span>
<a href="#l6.2070"></a><span id="l6.2070" class="difflineminus">-      if (moveFeed)</span>
<a href="#l6.2071"></a><span id="l6.2071" class="difflineminus">-      {</span>
<a href="#l6.2072"></a><span id="l6.2072" class="difflineplus">+      if (moveFeed) {</span>
<a href="#l6.2073"></a><span id="l6.2073">         let feed = new Feed(currentItem.url, currentItem.parentFolder);</span>
<a href="#l6.2074"></a><span id="l6.2074">         FeedUtils.deleteFeed(feed);</span>
<a href="#l6.2075"></a><span id="l6.2075">       }</span>
<a href="#l6.2076"></a><span id="l6.2076">     }</span>
<a href="#l6.2077"></a><span id="l6.2077"> </span>
<a href="#l6.2078"></a><span id="l6.2078">     // Update local favicons.</span>
<a href="#l6.2079"></a><span id="l6.2079">     currentParentItem.favicon = newParentItem.favicon = null;</span>
<a href="#l6.2080"></a><span id="l6.2080"> </span>
<a href="#l6.2081"></a><span id="l6.2081">     // Finally, update our view layer.  Update old parent folder's quickMode</span>
<a href="#l6.2082"></a><span id="l6.2082">     // and remove the old row, if move.  Otherwise no change to the view.</span>
<a href="#l6.2083"></a><span id="l6.2083" class="difflineminus">-    if (moveFeed)</span>
<a href="#l6.2084"></a><span id="l6.2084" class="difflineminus">-    {</span>
<a href="#l6.2085"></a><span id="l6.2085" class="difflineplus">+    if (moveFeed) {</span>
<a href="#l6.2086"></a><span id="l6.2086">       this.updateFolderQuickModeInView(currentItem, currentParentItem, true);</span>
<a href="#l6.2087"></a><span id="l6.2087">       this.mView.removeItemAtIndex(aOldFeedIndex, true);</span>
<a href="#l6.2088"></a><span id="l6.2088" class="difflineminus">-      if (aNewParentIndex &gt; aOldFeedIndex)</span>
<a href="#l6.2089"></a><span id="l6.2089" class="difflineplus">+      if (aNewParentIndex &gt; aOldFeedIndex) {</span>
<a href="#l6.2090"></a><span id="l6.2090">         aNewParentIndex--;</span>
<a href="#l6.2091"></a><span id="l6.2091" class="difflineplus">+      }</span>
<a href="#l6.2092"></a><span id="l6.2092">     }</span>
<a href="#l6.2093"></a><span id="l6.2093"> </span>
<a href="#l6.2094"></a><span id="l6.2094" class="difflineminus">-    if (accountMoveCopy)</span>
<a href="#l6.2095"></a><span id="l6.2095" class="difflineminus">-    {</span>
<a href="#l6.2096"></a><span id="l6.2096" class="difflineplus">+    if (accountMoveCopy) {</span>
<a href="#l6.2097"></a><span id="l6.2097">       // If a cross account move/copy, download callback will update the view</span>
<a href="#l6.2098"></a><span id="l6.2098">       // with the new location.  Preselect folder/mode for callback.</span>
<a href="#l6.2099"></a><span id="l6.2099">       this.selectFolder(newFolder, { parentIndex: aNewParentIndex });</span>
<a href="#l6.2100"></a><span id="l6.2100">       return;</span>
<a href="#l6.2101"></a><span id="l6.2101">     }</span>
<a href="#l6.2102"></a><span id="l6.2102"> </span>
<a href="#l6.2103"></a><span id="l6.2103">     // Add the new row location to the view.</span>
<a href="#l6.2104"></a><span id="l6.2104">     currentItem.level = newParentItem.level + 1;</span>
<a href="#l6.2105"></a><span id="l6.2105">     currentItem.parentFolder = newFolder;</span>
<a href="#l6.2106"></a><span id="l6.2106">     this.updateFolderQuickModeInView(currentItem, newParentItem, false);</span>
<a href="#l6.2107"></a><span id="l6.2107">     newParentItem.children.push(currentItem);</span>
<a href="#l6.2108"></a><span id="l6.2108"> </span>
<a href="#l6.2109"></a><span id="l6.2109" class="difflineminus">-    if (newParentItem.open)</span>
<a href="#l6.2110"></a><span id="l6.2110" class="difflineplus">+    if (newParentItem.open) {</span>
<a href="#l6.2111"></a><span id="l6.2111">       // Close the container, selecting the feed will rebuild the view rows.</span>
<a href="#l6.2112"></a><span id="l6.2112">       this.mView.toggle(aNewParentIndex);</span>
<a href="#l6.2113"></a><span id="l6.2113" class="difflineplus">+    }</span>
<a href="#l6.2114"></a><span id="l6.2114"> </span>
<a href="#l6.2115"></a><span id="l6.2115">     this.selectFeed({folder: newParentItem.folder, url: currentItem.url},</span>
<a href="#l6.2116"></a><span id="l6.2116">                     aNewParentIndex);</span>
<a href="#l6.2117"></a><span id="l6.2117"> </span>
<a href="#l6.2118"></a><span id="l6.2118">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedMoved&quot;);</span>
<a href="#l6.2119"></a><span id="l6.2119">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.2120"></a><span id="l6.2120">   },</span>
<a href="#l6.2121"></a><span id="l6.2121"> </span>
<a href="#l6.2122"></a><span id="l6.2122" class="difflineminus">-  updateFolderQuickModeInView: function (aFeedItem, aParentItem, aRemove)</span>
<a href="#l6.2123"></a><span id="l6.2123" class="difflineminus">-  {</span>
<a href="#l6.2124"></a><span id="l6.2124" class="difflineplus">+  updateFolderQuickModeInView(aFeedItem, aParentItem, aRemove) {</span>
<a href="#l6.2125"></a><span id="l6.2125">     let feedItem = aFeedItem;</span>
<a href="#l6.2126"></a><span id="l6.2126">     let parentItem = aParentItem;</span>
<a href="#l6.2127"></a><span id="l6.2127">     let feedUrlArray = FeedUtils.getFeedUrlsInFolder(feedItem.parentFolder);</span>
<a href="#l6.2128"></a><span id="l6.2128">     let feedsInFolder = feedUrlArray ? feedUrlArray.length : 0;</span>
<a href="#l6.2129"></a><span id="l6.2129"> </span>
<a href="#l6.2130"></a><span id="l6.2130" class="difflineminus">-    if (aRemove &amp;&amp; feedsInFolder &lt; 1)</span>
<a href="#l6.2131"></a><span id="l6.2131" class="difflineplus">+    if (aRemove &amp;&amp; feedsInFolder &lt; 1) {</span>
<a href="#l6.2132"></a><span id="l6.2132">       // Removed only feed in folder; set quickMode to server default.</span>
<a href="#l6.2133"></a><span id="l6.2133">       parentItem.quickMode = parentItem.folder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l6.2134"></a><span id="l6.2134" class="difflineminus">-</span>
<a href="#l6.2135"></a><span id="l6.2135" class="difflineminus">-    if (!aRemove)</span>
<a href="#l6.2136"></a><span id="l6.2136" class="difflineminus">-    {</span>
<a href="#l6.2137"></a><span id="l6.2137" class="difflineplus">+    }</span>
<a href="#l6.2138"></a><span id="l6.2138" class="difflineplus">+</span>
<a href="#l6.2139"></a><span id="l6.2139" class="difflineplus">+    if (!aRemove) {</span>
<a href="#l6.2140"></a><span id="l6.2140">       // Just added a feed to a folder.  If there are already feeds in the</span>
<a href="#l6.2141"></a><span id="l6.2141">       // folder, the feed must reflect the parent's quickMode.  If it is the</span>
<a href="#l6.2142"></a><span id="l6.2142">       // only feed, update the parent folder to the feed's quickMode.</span>
<a href="#l6.2143"></a><span id="l6.2143" class="difflineminus">-      if (feedsInFolder &gt; 1)</span>
<a href="#l6.2144"></a><span id="l6.2144" class="difflineminus">-      {</span>
<a href="#l6.2145"></a><span id="l6.2145" class="difflineplus">+      if (feedsInFolder &gt; 1) {</span>
<a href="#l6.2146"></a><span id="l6.2146">         let feed = new Feed(feedItem.url, feedItem.parentFolder);</span>
<a href="#l6.2147"></a><span id="l6.2147">         feed.quickMode = parentItem.quickMode;</span>
<a href="#l6.2148"></a><span id="l6.2148">         feedItem.quickMode = parentItem.quickMode;</span>
<a href="#l6.2149"></a><span id="l6.2149" class="difflineplus">+      } else {</span>
<a href="#l6.2150"></a><span id="l6.2150" class="difflineplus">+        parentItem.quickMode = feedItem.quickMode;</span>
<a href="#l6.2151"></a><span id="l6.2151">       }</span>
<a href="#l6.2152"></a><span id="l6.2152" class="difflineminus">-      else</span>
<a href="#l6.2153"></a><span id="l6.2153" class="difflineminus">-        parentItem.quickMode = feedItem.quickMode;</span>
<a href="#l6.2154"></a><span id="l6.2154">     }</span>
<a href="#l6.2155"></a><span id="l6.2155">   },</span>
<a href="#l6.2156"></a><span id="l6.2156"> </span>
<a href="#l6.2157"></a><span id="l6.2157" class="difflineminus">-  onDragStart: function (aEvent)</span>
<a href="#l6.2158"></a><span id="l6.2158" class="difflineminus">-  {</span>
<a href="#l6.2159"></a><span id="l6.2159" class="difflineplus">+  onDragStart(aEvent) {</span>
<a href="#l6.2160"></a><span id="l6.2160">     // Get the selected feed article (if there is one).</span>
<a href="#l6.2161"></a><span id="l6.2161">     let seln = this.mView.selection;</span>
<a href="#l6.2162"></a><span id="l6.2162" class="difflineminus">-    if (seln.count != 1)</span>
<a href="#l6.2163"></a><span id="l6.2163" class="difflineplus">+    if (seln.count != 1) {</span>
<a href="#l6.2164"></a><span id="l6.2164">       return;</span>
<a href="#l6.2165"></a><span id="l6.2165" class="difflineplus">+    }</span>
<a href="#l6.2166"></a><span id="l6.2166"> </span>
<a href="#l6.2167"></a><span id="l6.2167">     // Only initiate a drag if the item is a feed (ignore folders/containers).</span>
<a href="#l6.2168"></a><span id="l6.2168">     let item = this.mView.getItemAtIndex(seln.currentIndex);</span>
<a href="#l6.2169"></a><span id="l6.2169" class="difflineminus">-    if (!item || item.container)</span>
<a href="#l6.2170"></a><span id="l6.2170" class="difflineplus">+    if (!item || item.container) {</span>
<a href="#l6.2171"></a><span id="l6.2171">       return;</span>
<a href="#l6.2172"></a><span id="l6.2172" class="difflineplus">+    }</span>
<a href="#l6.2173"></a><span id="l6.2173"> </span>
<a href="#l6.2174"></a><span id="l6.2174">     aEvent.dataTransfer.setData(&quot;text/x-moz-feed-index&quot;, seln.currentIndex);</span>
<a href="#l6.2175"></a><span id="l6.2175">     aEvent.dataTransfer.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l6.2176"></a><span id="l6.2176">   },</span>
<a href="#l6.2177"></a><span id="l6.2177"> </span>
<a href="#l6.2178"></a><span id="l6.2178" class="difflineminus">-  onDragOver: function (aEvent)</span>
<a href="#l6.2179"></a><span id="l6.2179" class="difflineminus">-  {</span>
<a href="#l6.2180"></a><span id="l6.2180" class="difflineplus">+  onDragOver(aEvent) {</span>
<a href="#l6.2181"></a><span id="l6.2181">     this.mView._currentDataTransfer = aEvent.dataTransfer;</span>
<a href="#l6.2182"></a><span id="l6.2182">   },</span>
<a href="#l6.2183"></a><span id="l6.2183"> </span>
<a href="#l6.2184"></a><span id="l6.2184" class="difflineminus">-  mFeedDownloadCallback:</span>
<a href="#l6.2185"></a><span id="l6.2185" class="difflineminus">-  {</span>
<a href="#l6.2186"></a><span id="l6.2186" class="difflineplus">+  mFeedDownloadCallback: {</span>
<a href="#l6.2187"></a><span id="l6.2187">     mSubscribeMode: true,</span>
<a href="#l6.2188"></a><span id="l6.2188" class="difflineminus">-    downloaded: function(feed, aErrorCode)</span>
<a href="#l6.2189"></a><span id="l6.2189" class="difflineminus">-    {</span>
<a href="#l6.2190"></a><span id="l6.2190" class="difflineplus">+    downloaded(feed, aErrorCode) {</span>
<a href="#l6.2191"></a><span id="l6.2191">       // Offline check is done in the context of 3pane, return to the subscribe</span>
<a href="#l6.2192"></a><span id="l6.2192">       // window once the modal prompt is dispatched.</span>
<a href="#l6.2193"></a><span id="l6.2193">       window.focus();</span>
<a href="#l6.2194"></a><span id="l6.2194">       // Feed is null if our attempt to parse the feed failed.</span>
<a href="#l6.2195"></a><span id="l6.2195">       let message = &quot;&quot;;</span>
<a href="#l6.2196"></a><span id="l6.2196">       let win = FeedSubscriptions;</span>
<a href="#l6.2197"></a><span id="l6.2197">       if (aErrorCode == FeedUtils.kNewsBlogSuccess ||</span>
<a href="#l6.2198"></a><span id="l6.2198" class="difflineminus">-          aErrorCode == FeedUtils.kNewsBlogNoNewItems)</span>
<a href="#l6.2199"></a><span id="l6.2199" class="difflineminus">-      {</span>
<a href="#l6.2200"></a><span id="l6.2200" class="difflineplus">+          aErrorCode == FeedUtils.kNewsBlogNoNewItems) {</span>
<a href="#l6.2201"></a><span id="l6.2201">         win.updateStatusItem(&quot;progressMeter&quot;, 100);</span>
<a href="#l6.2202"></a><span id="l6.2202"> </span>
<a href="#l6.2203"></a><span id="l6.2203">         if (win.mActionMode == win.kVerifyUrlMode) {</span>
<a href="#l6.2204"></a><span id="l6.2204">           // Just checking for errors, if none bye. The (non error) code</span>
<a href="#l6.2205"></a><span id="l6.2205">           // kNewsBlogNoNewItems can only happen in verify mode.</span>
<a href="#l6.2206"></a><span id="l6.2206">           win.mActionMode = null;</span>
<a href="#l6.2207"></a><span id="l6.2207">           win.clearStatusInfo();</span>
<a href="#l6.2208"></a><span id="l6.2208" class="difflineminus">-          if (Services.io.offline)</span>
<a href="#l6.2209"></a><span id="l6.2209" class="difflineplus">+          if (Services.io.offline) {</span>
<a href="#l6.2210"></a><span id="l6.2210">             return;</span>
<a href="#l6.2211"></a><span id="l6.2211" class="difflineplus">+          }</span>
<a href="#l6.2212"></a><span id="l6.2212"> </span>
<a href="#l6.2213"></a><span id="l6.2213">           message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedVerified&quot;);</span>
<a href="#l6.2214"></a><span id="l6.2214">           win.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.2215"></a><span id="l6.2215">           return;</span>
<a href="#l6.2216"></a><span id="l6.2216">         }</span>
<a href="#l6.2217"></a><span id="l6.2217"> </span>
<a href="#l6.2218"></a><span id="l6.2218">         // Update lastUpdateTime if successful.</span>
<a href="#l6.2219"></a><span id="l6.2219">         let options = feed.options;</span>
<a href="#l6.2220"></a><span id="l6.2220" class="difflineat">@@ -1795,210 +1751,210 @@ var FeedSubscriptions = {</span>
<a href="#l6.2221"></a><span id="l6.2221">         // Add the feed to the databases.</span>
<a href="#l6.2222"></a><span id="l6.2222">         FeedUtils.addFeed(feed);</span>
<a href="#l6.2223"></a><span id="l6.2223"> </span>
<a href="#l6.2224"></a><span id="l6.2224">         // Now add the feed to our view.  If adding, the current selection will</span>
<a href="#l6.2225"></a><span id="l6.2225">         // be a folder; if updating it will be a feed.  No need to rebuild the</span>
<a href="#l6.2226"></a><span id="l6.2226">         // entire view, that is too jarring.</span>
<a href="#l6.2227"></a><span id="l6.2227">         let curIndex = win.mView.selection.currentIndex;</span>
<a href="#l6.2228"></a><span id="l6.2228">         let curItem = win.mView.getItemAtIndex(curIndex);</span>
<a href="#l6.2229"></a><span id="l6.2229" class="difflineminus">-        if (curItem)</span>
<a href="#l6.2230"></a><span id="l6.2230" class="difflineminus">-        {</span>
<a href="#l6.2231"></a><span id="l6.2231" class="difflineplus">+        if (curItem) {</span>
<a href="#l6.2232"></a><span id="l6.2232">           let parentIndex, parentItem, newItem, level;</span>
<a href="#l6.2233"></a><span id="l6.2233" class="difflineminus">-          let rows = win.mFeedContainers;</span>
<a href="#l6.2234"></a><span id="l6.2234" class="difflineminus">-          if (curItem.container)</span>
<a href="#l6.2235"></a><span id="l6.2235" class="difflineminus">-          {</span>
<a href="#l6.2236"></a><span id="l6.2236" class="difflineplus">+          if (curItem.container) {</span>
<a href="#l6.2237"></a><span id="l6.2237">             // Open the container, if it exists.</span>
<a href="#l6.2238"></a><span id="l6.2238">             let folderExists = win.selectFolder(feed.folder,</span>
<a href="#l6.2239"></a><span id="l6.2239">                                                 { parentIndex: curIndex });</span>
<a href="#l6.2240"></a><span id="l6.2240" class="difflineminus">-            if (!folderExists)</span>
<a href="#l6.2241"></a><span id="l6.2241" class="difflineminus">-            {</span>
<a href="#l6.2242"></a><span id="l6.2242" class="difflineplus">+            if (!folderExists) {</span>
<a href="#l6.2243"></a><span id="l6.2243">               // This means a new folder was created.</span>
<a href="#l6.2244"></a><span id="l6.2244">               parentIndex = curIndex;</span>
<a href="#l6.2245"></a><span id="l6.2245">               parentItem = curItem;</span>
<a href="#l6.2246"></a><span id="l6.2246">               level = curItem.level + 1;</span>
<a href="#l6.2247"></a><span id="l6.2247">               newItem = win.makeFolderObject(feed.folder, level);</span>
<a href="#l6.2248"></a><span id="l6.2248" class="difflineminus">-            }</span>
<a href="#l6.2249"></a><span id="l6.2249" class="difflineminus">-            else</span>
<a href="#l6.2250"></a><span id="l6.2250" class="difflineminus">-            {</span>
<a href="#l6.2251"></a><span id="l6.2251" class="difflineplus">+            } else {</span>
<a href="#l6.2252"></a><span id="l6.2252">               // If a folder happens to exist which matches one that would</span>
<a href="#l6.2253"></a><span id="l6.2253">               // have been created, the feed system reuses it.  Get the</span>
<a href="#l6.2254"></a><span id="l6.2254">               // current item again if reusing a previously unselected folder.</span>
<a href="#l6.2255"></a><span id="l6.2255">               curIndex = win.mView.selection.currentIndex;</span>
<a href="#l6.2256"></a><span id="l6.2256">               curItem = win.mView.getItemAtIndex(curIndex);</span>
<a href="#l6.2257"></a><span id="l6.2257">               parentIndex = curIndex;</span>
<a href="#l6.2258"></a><span id="l6.2258">               parentItem = curItem;</span>
<a href="#l6.2259"></a><span id="l6.2259">               level = curItem.level + 1;</span>
<a href="#l6.2260"></a><span id="l6.2260">               newItem = win.makeFeedObject(feed, feed.folder, level);</span>
<a href="#l6.2261"></a><span id="l6.2261">             }</span>
<a href="#l6.2262"></a><span id="l6.2262" class="difflineminus">-          }</span>
<a href="#l6.2263"></a><span id="l6.2263" class="difflineminus">-          else</span>
<a href="#l6.2264"></a><span id="l6.2264" class="difflineminus">-          {</span>
<a href="#l6.2265"></a><span id="l6.2265" class="difflineplus">+          } else {</span>
<a href="#l6.2266"></a><span id="l6.2266">             // Adding a feed.</span>
<a href="#l6.2267"></a><span id="l6.2267">             parentIndex = win.mView.getParentIndex(curIndex);</span>
<a href="#l6.2268"></a><span id="l6.2268">             parentItem = win.mView.getItemAtIndex(parentIndex);</span>
<a href="#l6.2269"></a><span id="l6.2269">             level = curItem.level;</span>
<a href="#l6.2270"></a><span id="l6.2270">             newItem = win.makeFeedObject(feed, feed.folder, level);</span>
<a href="#l6.2271"></a><span id="l6.2271">           }</span>
<a href="#l6.2272"></a><span id="l6.2272"> </span>
<a href="#l6.2273"></a><span id="l6.2273" class="difflineminus">-          if (!newItem.container)</span>
<a href="#l6.2274"></a><span id="l6.2274" class="difflineplus">+          if (!newItem.container) {</span>
<a href="#l6.2275"></a><span id="l6.2275">             win.updateFolderQuickModeInView(newItem, parentItem, false);</span>
<a href="#l6.2276"></a><span id="l6.2276" class="difflineplus">+          }</span>
<a href="#l6.2277"></a><span id="l6.2277" class="difflineplus">+</span>
<a href="#l6.2278"></a><span id="l6.2278">           parentItem.children.push(newItem);</span>
<a href="#l6.2279"></a><span id="l6.2279">           parentItem.children = win.folderItemSorter(parentItem.children);</span>
<a href="#l6.2280"></a><span id="l6.2280">           parentItem.favicon = null;</span>
<a href="#l6.2281"></a><span id="l6.2281"> </span>
<a href="#l6.2282"></a><span id="l6.2282" class="difflineminus">-          if (win.mActionMode == win.kSubscribeMode)</span>
<a href="#l6.2283"></a><span id="l6.2283" class="difflineplus">+          if (win.mActionMode == win.kSubscribeMode) {</span>
<a href="#l6.2284"></a><span id="l6.2284">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2285"></a><span id="l6.2285">                         &quot;subscribe-feedAdded&quot;);</span>
<a href="#l6.2286"></a><span id="l6.2286" class="difflineminus">-          if (win.mActionMode == win.kUpdateMode)</span>
<a href="#l6.2287"></a><span id="l6.2287" class="difflineminus">-          {</span>
<a href="#l6.2288"></a><span id="l6.2288" class="difflineplus">+          }</span>
<a href="#l6.2289"></a><span id="l6.2289" class="difflineplus">+          if (win.mActionMode == win.kUpdateMode) {</span>
<a href="#l6.2290"></a><span id="l6.2290">             win.removeFeed(false);</span>
<a href="#l6.2291"></a><span id="l6.2291">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2292"></a><span id="l6.2292">                         &quot;subscribe-feedUpdated&quot;);</span>
<a href="#l6.2293"></a><span id="l6.2293">           }</span>
<a href="#l6.2294"></a><span id="l6.2294" class="difflineminus">-          if (win.mActionMode == win.kMoveMode)</span>
<a href="#l6.2295"></a><span id="l6.2295" class="difflineplus">+          if (win.mActionMode == win.kMoveMode) {</span>
<a href="#l6.2296"></a><span id="l6.2296">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2297"></a><span id="l6.2297">                         &quot;subscribe-feedMoved&quot;);</span>
<a href="#l6.2298"></a><span id="l6.2298" class="difflineminus">-          if (win.mActionMode == win.kCopyMode)</span>
<a href="#l6.2299"></a><span id="l6.2299" class="difflineplus">+          }</span>
<a href="#l6.2300"></a><span id="l6.2300" class="difflineplus">+          if (win.mActionMode == win.kCopyMode) {</span>
<a href="#l6.2301"></a><span id="l6.2301">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2302"></a><span id="l6.2302">                         &quot;subscribe-feedCopied&quot;);</span>
<a href="#l6.2303"></a><span id="l6.2303" class="difflineplus">+          }</span>
<a href="#l6.2304"></a><span id="l6.2304"> </span>
<a href="#l6.2305"></a><span id="l6.2305">           win.selectFeed(feed, parentIndex);</span>
<a href="#l6.2306"></a><span id="l6.2306">         }</span>
<a href="#l6.2307"></a><span id="l6.2307" class="difflineminus">-      }</span>
<a href="#l6.2308"></a><span id="l6.2308" class="difflineminus">-      else</span>
<a href="#l6.2309"></a><span id="l6.2309" class="difflineminus">-      {</span>
<a href="#l6.2310"></a><span id="l6.2310" class="difflineplus">+      } else {</span>
<a href="#l6.2311"></a><span id="l6.2311">         // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l6.2312"></a><span id="l6.2312">         // But only if we're not in verify mode.</span>
<a href="#l6.2313"></a><span id="l6.2313">         if (win.mActionMode != win.kVerifyUrlMode &amp;&amp;</span>
<a href="#l6.2314"></a><span id="l6.2314" class="difflineminus">-            feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l6.2315"></a><span id="l6.2315" class="difflineplus">+            feed &amp;&amp; feed.url &amp;&amp; feed.server) {</span>
<a href="#l6.2316"></a><span id="l6.2316">           FeedUtils.deleteFeed(feed);</span>
<a href="#l6.2317"></a><span id="l6.2317" class="difflineminus">-</span>
<a href="#l6.2318"></a><span id="l6.2318" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l6.2319"></a><span id="l6.2319" class="difflineplus">+        }</span>
<a href="#l6.2320"></a><span id="l6.2320" class="difflineplus">+</span>
<a href="#l6.2321"></a><span id="l6.2321" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed) {</span>
<a href="#l6.2322"></a><span id="l6.2322">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2323"></a><span id="l6.2323">                       &quot;subscribe-feedNotValid&quot;);</span>
<a href="#l6.2324"></a><span id="l6.2324" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogRequestFailure)</span>
<a href="#l6.2325"></a><span id="l6.2325" class="difflineplus">+        }</span>
<a href="#l6.2326"></a><span id="l6.2326" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogRequestFailure) {</span>
<a href="#l6.2327"></a><span id="l6.2327">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2328"></a><span id="l6.2328">                       &quot;subscribe-networkError&quot;);</span>
<a href="#l6.2329"></a><span id="l6.2329" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogFileError)</span>
<a href="#l6.2330"></a><span id="l6.2330" class="difflineplus">+        }</span>
<a href="#l6.2331"></a><span id="l6.2331" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogFileError) {</span>
<a href="#l6.2332"></a><span id="l6.2332">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2333"></a><span id="l6.2333">                       &quot;subscribe-errorOpeningFile&quot;);</span>
<a href="#l6.2334"></a><span id="l6.2334" class="difflineplus">+        }</span>
<a href="#l6.2335"></a><span id="l6.2335">         if (aErrorCode == FeedUtils.kNewsBlogBadCertError) {</span>
<a href="#l6.2336"></a><span id="l6.2336">           let host = Services.io.newURI(feed.url).host;</span>
<a href="#l6.2337"></a><span id="l6.2337">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2338"></a><span id="l6.2338">                       &quot;newsblog-badCertError&quot;, [host], 1);</span>
<a href="#l6.2339"></a><span id="l6.2339">         }</span>
<a href="#l6.2340"></a><span id="l6.2340" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogNoAuthError)</span>
<a href="#l6.2341"></a><span id="l6.2341" class="difflineplus">+        if (aErrorCode == FeedUtils.kNewsBlogNoAuthError) {</span>
<a href="#l6.2342"></a><span id="l6.2342">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2343"></a><span id="l6.2343">                       &quot;subscribe-noAuthError&quot;);</span>
<a href="#l6.2344"></a><span id="l6.2344" class="difflineplus">+        }</span>
<a href="#l6.2345"></a><span id="l6.2345"> </span>
<a href="#l6.2346"></a><span id="l6.2346">         // Focus the url if verify/update failed.</span>
<a href="#l6.2347"></a><span id="l6.2347">         if (win.mActionMode == win.kUpdateMode ||</span>
<a href="#l6.2348"></a><span id="l6.2348" class="difflineminus">-            win.mActionMode == win.kVerifyUrlMode)</span>
<a href="#l6.2349"></a><span id="l6.2349" class="difflineplus">+            win.mActionMode == win.kVerifyUrlMode) {</span>
<a href="#l6.2350"></a><span id="l6.2350">           document.getElementById(&quot;locationValue&quot;).focus();</span>
<a href="#l6.2351"></a><span id="l6.2351" class="difflineplus">+        }</span>
<a href="#l6.2352"></a><span id="l6.2352">       }</span>
<a href="#l6.2353"></a><span id="l6.2353"> </span>
<a href="#l6.2354"></a><span id="l6.2354">       win.mActionMode = null;</span>
<a href="#l6.2355"></a><span id="l6.2355">       win.clearStatusInfo();</span>
<a href="#l6.2356"></a><span id="l6.2356">       let code = feed.url.startsWith(&quot;http&quot;) ? aErrorCode : null;</span>
<a href="#l6.2357"></a><span id="l6.2357">       win.updateStatusItem(&quot;statusText&quot;, message, code);</span>
<a href="#l6.2358"></a><span id="l6.2358">     },</span>
<a href="#l6.2359"></a><span id="l6.2359"> </span>
<a href="#l6.2360"></a><span id="l6.2360">     // This gets called after the RSS parser finishes storing a feed item to</span>
<a href="#l6.2361"></a><span id="l6.2361">     // disk.  aCurrentFeedItems is an integer corresponding to how many feed</span>
<a href="#l6.2362"></a><span id="l6.2362">     // items have been downloaded so far.  aMaxFeedItems is an integer</span>
<a href="#l6.2363"></a><span id="l6.2363">     // corresponding to the total number of feed items to download.</span>
<a href="#l6.2364"></a><span id="l6.2364" class="difflineminus">-    onFeedItemStored: function (feed, aCurrentFeedItems, aMaxFeedItems)</span>
<a href="#l6.2365"></a><span id="l6.2365" class="difflineminus">-    {</span>
<a href="#l6.2366"></a><span id="l6.2366" class="difflineplus">+    onFeedItemStored(feed, aCurrentFeedItems, aMaxFeedItems) {</span>
<a href="#l6.2367"></a><span id="l6.2367">       window.focus();</span>
<a href="#l6.2368"></a><span id="l6.2368">       let message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2369"></a><span id="l6.2369">                       &quot;subscribe-gettingFeedItems&quot;,</span>
<a href="#l6.2370"></a><span id="l6.2370">                       [aCurrentFeedItems, aMaxFeedItems], 2);</span>
<a href="#l6.2371"></a><span id="l6.2371">       FeedSubscriptions.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.2372"></a><span id="l6.2372">       this.onProgress(feed, aCurrentFeedItems, aMaxFeedItems);</span>
<a href="#l6.2373"></a><span id="l6.2373">     },</span>
<a href="#l6.2374"></a><span id="l6.2374"> </span>
<a href="#l6.2375"></a><span id="l6.2375" class="difflineminus">-    onProgress: function(feed, aProgress, aProgressMax, aLengthComputable)</span>
<a href="#l6.2376"></a><span id="l6.2376" class="difflineminus">-    {</span>
<a href="#l6.2377"></a><span id="l6.2377" class="difflineplus">+    onProgress(feed, aProgress, aProgressMax, aLengthComputable) {</span>
<a href="#l6.2378"></a><span id="l6.2378">       FeedSubscriptions.updateStatusItem(&quot;progressMeter&quot;,</span>
<a href="#l6.2379"></a><span id="l6.2379">                                          (aProgress * 100) / aProgressMax);</span>
<a href="#l6.2380"></a><span id="l6.2380" class="difflineminus">-    }</span>
<a href="#l6.2381"></a><span id="l6.2381" class="difflineplus">+    },</span>
<a href="#l6.2382"></a><span id="l6.2382">   },</span>
<a href="#l6.2383"></a><span id="l6.2383"> </span>
<a href="#l6.2384"></a><span id="l6.2384">   // Status routines.</span>
<a href="#l6.2385"></a><span id="l6.2385" class="difflineminus">-  updateStatusItem: function(aID, aValue, aErrorCode)</span>
<a href="#l6.2386"></a><span id="l6.2386" class="difflineminus">-  {</span>
<a href="#l6.2387"></a><span id="l6.2387" class="difflineplus">+  updateStatusItem(aID, aValue, aErrorCode) {</span>
<a href="#l6.2388"></a><span id="l6.2388">     let el = document.getElementById(aID);</span>
<a href="#l6.2389"></a><span id="l6.2389" class="difflineminus">-    if (el.getAttribute(&quot;collapsed&quot;))</span>
<a href="#l6.2390"></a><span id="l6.2390" class="difflineplus">+    if (el.getAttribute(&quot;collapsed&quot;)) {</span>
<a href="#l6.2391"></a><span id="l6.2391">       el.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.2392"></a><span id="l6.2392" class="difflineminus">-</span>
<a href="#l6.2393"></a><span id="l6.2393" class="difflineminus">-    if (aID == &quot;progressMeter&quot;)</span>
<a href="#l6.2394"></a><span id="l6.2394" class="difflineplus">+    }</span>
<a href="#l6.2395"></a><span id="l6.2395" class="difflineplus">+</span>
<a href="#l6.2396"></a><span id="l6.2396" class="difflineplus">+    if (aID == &quot;progressMeter&quot;) {</span>
<a href="#l6.2397"></a><span id="l6.2397">       el.setAttribute(&quot;mode&quot;, aValue == &quot;?&quot; ? &quot;undetermined&quot; : &quot;determined&quot;);</span>
<a href="#l6.2398"></a><span id="l6.2398" class="difflineminus">-</span>
<a href="#l6.2399"></a><span id="l6.2399" class="difflineminus">-    if (aID == &quot;statusText&quot;)</span>
<a href="#l6.2400"></a><span id="l6.2400" class="difflineplus">+    }</span>
<a href="#l6.2401"></a><span id="l6.2401" class="difflineplus">+</span>
<a href="#l6.2402"></a><span id="l6.2402" class="difflineplus">+    if (aID == &quot;statusText&quot;) {</span>
<a href="#l6.2403"></a><span id="l6.2403">       el.textContent = aValue;</span>
<a href="#l6.2404"></a><span id="l6.2404" class="difflineminus">-    else</span>
<a href="#l6.2405"></a><span id="l6.2405" class="difflineplus">+    } else {</span>
<a href="#l6.2406"></a><span id="l6.2406">       el.value = aValue;</span>
<a href="#l6.2407"></a><span id="l6.2407" class="difflineplus">+    }</span>
<a href="#l6.2408"></a><span id="l6.2408"> </span>
<a href="#l6.2409"></a><span id="l6.2409">     el = document.getElementById(&quot;validationText&quot;);</span>
<a href="#l6.2410"></a><span id="l6.2410" class="difflineminus">-    if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l6.2411"></a><span id="l6.2411" class="difflineplus">+    if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed) {</span>
<a href="#l6.2412"></a><span id="l6.2412">       el.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.2413"></a><span id="l6.2413" class="difflineminus">-    else</span>
<a href="#l6.2414"></a><span id="l6.2414" class="difflineplus">+    } else {</span>
<a href="#l6.2415"></a><span id="l6.2415">       el.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l6.2416"></a><span id="l6.2416" class="difflineplus">+    }</span>
<a href="#l6.2417"></a><span id="l6.2417"> </span>
<a href="#l6.2418"></a><span id="l6.2418">     el = document.getElementById(&quot;addCertException&quot;);</span>
<a href="#l6.2419"></a><span id="l6.2419" class="difflineminus">-    if (aErrorCode == FeedUtils.kNewsBlogBadCertError)</span>
<a href="#l6.2420"></a><span id="l6.2420" class="difflineplus">+    if (aErrorCode == FeedUtils.kNewsBlogBadCertError) {</span>
<a href="#l6.2421"></a><span id="l6.2421">       el.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.2422"></a><span id="l6.2422" class="difflineminus">-    else</span>
<a href="#l6.2423"></a><span id="l6.2423" class="difflineplus">+    } else {</span>
<a href="#l6.2424"></a><span id="l6.2424">       el.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l6.2425"></a><span id="l6.2425" class="difflineplus">+    }</span>
<a href="#l6.2426"></a><span id="l6.2426">   },</span>
<a href="#l6.2427"></a><span id="l6.2427"> </span>
<a href="#l6.2428"></a><span id="l6.2428" class="difflineminus">-  clearStatusInfo: function()</span>
<a href="#l6.2429"></a><span id="l6.2429" class="difflineminus">-  {</span>
<a href="#l6.2430"></a><span id="l6.2430" class="difflineplus">+  clearStatusInfo() {</span>
<a href="#l6.2431"></a><span id="l6.2431">     document.getElementById(&quot;statusText&quot;).textContent = &quot;&quot;;</span>
<a href="#l6.2432"></a><span id="l6.2432">     document.getElementById(&quot;progressMeter&quot;).collapsed = true;</span>
<a href="#l6.2433"></a><span id="l6.2433">     document.getElementById(&quot;validationText&quot;).collapsed = true;</span>
<a href="#l6.2434"></a><span id="l6.2434">     document.getElementById(&quot;addCertException&quot;).collapsed = true;</span>
<a href="#l6.2435"></a><span id="l6.2435">   },</span>
<a href="#l6.2436"></a><span id="l6.2436"> </span>
<a href="#l6.2437"></a><span id="l6.2437" class="difflineminus">-  checkValidation: function(aEvent)</span>
<a href="#l6.2438"></a><span id="l6.2438" class="difflineminus">-  {</span>
<a href="#l6.2439"></a><span id="l6.2439" class="difflineminus">-    if (aEvent.button != 0)</span>
<a href="#l6.2440"></a><span id="l6.2440" class="difflineplus">+  checkValidation(aEvent) {</span>
<a href="#l6.2441"></a><span id="l6.2441" class="difflineplus">+    if (aEvent.button != 0) {</span>
<a href="#l6.2442"></a><span id="l6.2442">       return;</span>
<a href="#l6.2443"></a><span id="l6.2443" class="difflineplus">+    }</span>
<a href="#l6.2444"></a><span id="l6.2444"> </span>
<a href="#l6.2445"></a><span id="l6.2445">     let validationSite = &quot;http://validator.w3.org&quot;;</span>
<a href="#l6.2446"></a><span id="l6.2446">     let validationQuery = &quot;http://validator.w3.org/feed/check.cgi?url=&quot;;</span>
<a href="#l6.2447"></a><span id="l6.2447"> </span>
<a href="#l6.2448"></a><span id="l6.2448" class="difflineminus">-    if (this.mMainWin)</span>
<a href="#l6.2449"></a><span id="l6.2449" class="difflineminus">-    {</span>
<a href="#l6.2450"></a><span id="l6.2450" class="difflineplus">+    if (this.mMainWin) {</span>
<a href="#l6.2451"></a><span id="l6.2451">       let tabmail = this.mMainWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.2452"></a><span id="l6.2452" class="difflineminus">-      if (tabmail)</span>
<a href="#l6.2453"></a><span id="l6.2453" class="difflineminus">-      {</span>
<a href="#l6.2454"></a><span id="l6.2454" class="difflineplus">+      if (tabmail) {</span>
<a href="#l6.2455"></a><span id="l6.2455">         let feedLocation = document.getElementById(&quot;locationValue&quot;).value;</span>
<a href="#l6.2456"></a><span id="l6.2456">         let url = validationQuery + encodeURIComponent(feedLocation);</span>
<a href="#l6.2457"></a><span id="l6.2457"> </span>
<a href="#l6.2458"></a><span id="l6.2458">         this.mMainWin.focus();</span>
<a href="#l6.2459"></a><span id="l6.2459">         this.mMainWin.openContentTab(url, &quot;tab&quot;, &quot;^&quot; + validationSite);</span>
<a href="#l6.2460"></a><span id="l6.2460">         FeedUtils.log.debug(&quot;checkValidation: query url - &quot; + url);</span>
<a href="#l6.2461"></a><span id="l6.2461">       }</span>
<a href="#l6.2462"></a><span id="l6.2462">     }</span>
<a href="#l6.2463"></a><span id="l6.2463">     aEvent.stopPropagation();</span>
<a href="#l6.2464"></a><span id="l6.2464">   },</span>
<a href="#l6.2465"></a><span id="l6.2465"> </span>
<a href="#l6.2466"></a><span id="l6.2466" class="difflineminus">-  addCertExceptionDialog: function()</span>
<a href="#l6.2467"></a><span id="l6.2467" class="difflineminus">-  {</span>
<a href="#l6.2468"></a><span id="l6.2468" class="difflineplus">+  addCertExceptionDialog() {</span>
<a href="#l6.2469"></a><span id="l6.2469">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l6.2470"></a><span id="l6.2470">     let feedURL = locationValue.value.trim();</span>
<a href="#l6.2471"></a><span id="l6.2471" class="difflineminus">-    let params = { exceptionAdded : false,</span>
<a href="#l6.2472"></a><span id="l6.2472" class="difflineminus">-                   location: feedURL,</span>
<a href="#l6.2473"></a><span id="l6.2473" class="difflineminus">-                   prefetchCert: true };</span>
<a href="#l6.2474"></a><span id="l6.2474" class="difflineplus">+    let params = { exceptionAdded: false,</span>
<a href="#l6.2475"></a><span id="l6.2475" class="difflineplus">+                   location:       feedURL,</span>
<a href="#l6.2476"></a><span id="l6.2476" class="difflineplus">+                   prefetchCert:   true,</span>
<a href="#l6.2477"></a><span id="l6.2477" class="difflineplus">+                 };</span>
<a href="#l6.2478"></a><span id="l6.2478">     window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l6.2479"></a><span id="l6.2479">                       &quot;&quot;, &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l6.2480"></a><span id="l6.2480" class="difflineminus">-    if (params.exceptionAdded)</span>
<a href="#l6.2481"></a><span id="l6.2481" class="difflineplus">+    if (params.exceptionAdded) {</span>
<a href="#l6.2482"></a><span id="l6.2482">       this.clearStatusInfo();</span>
<a href="#l6.2483"></a><span id="l6.2483" class="difflineplus">+    }</span>
<a href="#l6.2484"></a><span id="l6.2484"> </span>
<a href="#l6.2485"></a><span id="l6.2485">     locationValue.focus();</span>
<a href="#l6.2486"></a><span id="l6.2486">   },</span>
<a href="#l6.2487"></a><span id="l6.2487"> </span>
<a href="#l6.2488"></a><span id="l6.2488">   // Listener for folder pane changes.</span>
<a href="#l6.2489"></a><span id="l6.2489">   FolderListener: {</span>
<a href="#l6.2490"></a><span id="l6.2490">     get feedWindow() {</span>
<a href="#l6.2491"></a><span id="l6.2491">       let subscriptionsWindow =</span>
<a href="#l6.2492"></a><span id="l6.2492" class="difflineat">@@ -2009,316 +1965,332 @@ var FeedSubscriptions = {</span>
<a href="#l6.2493"></a><span id="l6.2493">     get currentSelectedIndex() {</span>
<a href="#l6.2494"></a><span id="l6.2494">       return this.feedWindow ? this.feedWindow.mView.selection.currentIndex : -1;</span>
<a href="#l6.2495"></a><span id="l6.2495">     },</span>
<a href="#l6.2496"></a><span id="l6.2496"> </span>
<a href="#l6.2497"></a><span id="l6.2497">     get currentSelectedItem() {</span>
<a href="#l6.2498"></a><span id="l6.2498">       return this.feedWindow ? this.feedWindow.mView.currentItem : null;</span>
<a href="#l6.2499"></a><span id="l6.2499">     },</span>
<a href="#l6.2500"></a><span id="l6.2500"> </span>
<a href="#l6.2501"></a><span id="l6.2501" class="difflineminus">-    folderAdded: function(aFolder)</span>
<a href="#l6.2502"></a><span id="l6.2502" class="difflineminus">-    {</span>
<a href="#l6.2503"></a><span id="l6.2503" class="difflineplus">+    folderAdded(aFolder) {</span>
<a href="#l6.2504"></a><span id="l6.2504">       if (aFolder.server.type != &quot;rss&quot; ||</span>
<a href="#l6.2505"></a><span id="l6.2505" class="difflineminus">-          FeedUtils.isInTrash(aFolder))</span>
<a href="#l6.2506"></a><span id="l6.2506" class="difflineplus">+          FeedUtils.isInTrash(aFolder)) {</span>
<a href="#l6.2507"></a><span id="l6.2507">         return;</span>
<a href="#l6.2508"></a><span id="l6.2508" class="difflineplus">+      }</span>
<a href="#l6.2509"></a><span id="l6.2509"> </span>
<a href="#l6.2510"></a><span id="l6.2510">       let parentFolder = aFolder.isServer ? aFolder : aFolder.parent;</span>
<a href="#l6.2511"></a><span id="l6.2511">       FeedUtils.log.debug(&quot;folderAdded: folder:parent - &quot; + aFolder.name + &quot;:&quot; +</span>
<a href="#l6.2512"></a><span id="l6.2512">                           (parentFolder ? parentFolder.filePath.path : &quot;(null)&quot;));</span>
<a href="#l6.2513"></a><span id="l6.2513"> </span>
<a href="#l6.2514"></a><span id="l6.2514" class="difflineminus">-      if (!parentFolder || !this.feedWindow)</span>
<a href="#l6.2515"></a><span id="l6.2515" class="difflineplus">+      if (!parentFolder || !this.feedWindow) {</span>
<a href="#l6.2516"></a><span id="l6.2516">         return;</span>
<a href="#l6.2517"></a><span id="l6.2517" class="difflineplus">+      }</span>
<a href="#l6.2518"></a><span id="l6.2518"> </span>
<a href="#l6.2519"></a><span id="l6.2519">       let feedWindow = this.feedWindow;</span>
<a href="#l6.2520"></a><span id="l6.2520" class="difflineminus">-      let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l6.2521"></a><span id="l6.2521">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l6.2522"></a><span id="l6.2522">       let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l6.2523"></a><span id="l6.2523">       let indexInView = feedWindow.mView.getItemInViewIndex(parentFolder);</span>
<a href="#l6.2524"></a><span id="l6.2524">       let open = indexInView != null;</span>
<a href="#l6.2525"></a><span id="l6.2525"> </span>
<a href="#l6.2526"></a><span id="l6.2526" class="difflineminus">-      if (aFolder.isServer)</span>
<a href="#l6.2527"></a><span id="l6.2527" class="difflineminus">-      {</span>
<a href="#l6.2528"></a><span id="l6.2528" class="difflineminus">-        if (indexInView != null)</span>
<a href="#l6.2529"></a><span id="l6.2529" class="difflineplus">+      if (aFolder.isServer) {</span>
<a href="#l6.2530"></a><span id="l6.2530" class="difflineplus">+        if (indexInView != null) {</span>
<a href="#l6.2531"></a><span id="l6.2531">           // Existing account root folder in the view.</span>
<a href="#l6.2532"></a><span id="l6.2532">           open = feedWindow.mView.getItemAtIndex(indexInView).open;</span>
<a href="#l6.2533"></a><span id="l6.2533" class="difflineminus">-        else</span>
<a href="#l6.2534"></a><span id="l6.2534" class="difflineminus">-        {</span>
<a href="#l6.2535"></a><span id="l6.2535" class="difflineplus">+        } else {</span>
<a href="#l6.2536"></a><span id="l6.2536">           // Add the account root folder to the view.</span>
<a href="#l6.2537"></a><span id="l6.2537">           feedWindow.mFeedContainers.push(feedWindow.makeFolderObject(parentFolder, 0));</span>
<a href="#l6.2538"></a><span id="l6.2538">           feedWindow.mView.mRowCount++;</span>
<a href="#l6.2539"></a><span id="l6.2539">           feedWindow.mTree.view = feedWindow.mView;</span>
<a href="#l6.2540"></a><span id="l6.2540">           feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l6.2541"></a><span id="l6.2541">           return;</span>
<a href="#l6.2542"></a><span id="l6.2542">         }</span>
<a href="#l6.2543"></a><span id="l6.2543">       }</span>
<a href="#l6.2544"></a><span id="l6.2544"> </span>
<a href="#l6.2545"></a><span id="l6.2545">       // Rebuild the added folder's parent item in the tree row cache.</span>
<a href="#l6.2546"></a><span id="l6.2546">       feedWindow.selectFolder(parentFolder, { select: false,</span>
<a href="#l6.2547"></a><span id="l6.2547" class="difflineminus">-                                              open: open,</span>
<a href="#l6.2548"></a><span id="l6.2548" class="difflineplus">+                                              open,</span>
<a href="#l6.2549"></a><span id="l6.2549">                                               newFolder: parentFolder });</span>
<a href="#l6.2550"></a><span id="l6.2550"> </span>
<a href="#l6.2551"></a><span id="l6.2551" class="difflineminus">-      if (indexInView == null || !curSelItem)</span>
<a href="#l6.2552"></a><span id="l6.2552" class="difflineplus">+      if (indexInView == null || !curSelItem) {</span>
<a href="#l6.2553"></a><span id="l6.2553">         // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l6.2554"></a><span id="l6.2554">         return;</span>
<a href="#l6.2555"></a><span id="l6.2555" class="difflineplus">+      }</span>
<a href="#l6.2556"></a><span id="l6.2556"> </span>
<a href="#l6.2557"></a><span id="l6.2557">       let parentIndex = feedWindow.mView.getParentIndex(indexInView);</span>
<a href="#l6.2558"></a><span id="l6.2558" class="difflineminus">-      if (parentIndex == feedWindow.mView.kRowIndexUndefined)</span>
<a href="#l6.2559"></a><span id="l6.2559" class="difflineplus">+      if (parentIndex == feedWindow.mView.kRowIndexUndefined) {</span>
<a href="#l6.2560"></a><span id="l6.2560">         // Root folder is its own parent.</span>
<a href="#l6.2561"></a><span id="l6.2561">         parentIndex = indexInView;</span>
<a href="#l6.2562"></a><span id="l6.2562" class="difflineminus">-      if (open)</span>
<a href="#l6.2563"></a><span id="l6.2563" class="difflineminus">-      {</span>
<a href="#l6.2564"></a><span id="l6.2564" class="difflineplus">+      }</span>
<a href="#l6.2565"></a><span id="l6.2565" class="difflineplus">+</span>
<a href="#l6.2566"></a><span id="l6.2566" class="difflineplus">+      if (open) {</span>
<a href="#l6.2567"></a><span id="l6.2567">         // Close an open parent (or root) folder.</span>
<a href="#l6.2568"></a><span id="l6.2568">         feedWindow.mView.toggle(parentIndex);</span>
<a href="#l6.2569"></a><span id="l6.2569">         feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l6.2570"></a><span id="l6.2570">       }</span>
<a href="#l6.2571"></a><span id="l6.2571" class="difflineplus">+</span>
<a href="#l6.2572"></a><span id="l6.2572">       feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l6.2573"></a><span id="l6.2573"> </span>
<a href="#l6.2574"></a><span id="l6.2574" class="difflineminus">-      if (curSelItem.container)</span>
<a href="#l6.2575"></a><span id="l6.2575" class="difflineplus">+      if (curSelItem.container) {</span>
<a href="#l6.2576"></a><span id="l6.2576">         feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l6.2577"></a><span id="l6.2577" class="difflineminus">-      else</span>
<a href="#l6.2578"></a><span id="l6.2578" class="difflineplus">+      } else {</span>
<a href="#l6.2579"></a><span id="l6.2579">         feedWindow.selectFeed({ folder: curSelItem.parentFolder,</span>
<a href="#l6.2580"></a><span id="l6.2580" class="difflineminus">-                                url: curSelItem.url }, parentIndex);</span>
<a href="#l6.2581"></a><span id="l6.2581" class="difflineplus">+                                url: curSelItem.url },</span>
<a href="#l6.2582"></a><span id="l6.2582" class="difflineplus">+                              parentIndex);</span>
<a href="#l6.2583"></a><span id="l6.2583" class="difflineplus">+      }</span>
<a href="#l6.2584"></a><span id="l6.2584">     },</span>
<a href="#l6.2585"></a><span id="l6.2585"> </span>
<a href="#l6.2586"></a><span id="l6.2586" class="difflineminus">-    folderDeleted: function(aFolder)</span>
<a href="#l6.2587"></a><span id="l6.2587" class="difflineminus">-    {</span>
<a href="#l6.2588"></a><span id="l6.2588" class="difflineminus">-      if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aFolder))</span>
<a href="#l6.2589"></a><span id="l6.2589" class="difflineplus">+    folderDeleted(aFolder) {</span>
<a href="#l6.2590"></a><span id="l6.2590" class="difflineplus">+      if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aFolder)) {</span>
<a href="#l6.2591"></a><span id="l6.2591">         return;</span>
<a href="#l6.2592"></a><span id="l6.2592" class="difflineplus">+      }</span>
<a href="#l6.2593"></a><span id="l6.2593"> </span>
<a href="#l6.2594"></a><span id="l6.2594">       FeedUtils.log.debug(&quot;folderDeleted: folder - &quot; + aFolder.name);</span>
<a href="#l6.2595"></a><span id="l6.2595" class="difflineminus">-      if (!this.feedWindow)</span>
<a href="#l6.2596"></a><span id="l6.2596" class="difflineplus">+      if (!this.feedWindow) {</span>
<a href="#l6.2597"></a><span id="l6.2597">         return;</span>
<a href="#l6.2598"></a><span id="l6.2598" class="difflineplus">+      }</span>
<a href="#l6.2599"></a><span id="l6.2599"> </span>
<a href="#l6.2600"></a><span id="l6.2600">       let feedWindow = this.feedWindow;</span>
<a href="#l6.2601"></a><span id="l6.2601">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l6.2602"></a><span id="l6.2602">       let indexInView = feedWindow.mView.getItemInViewIndex(aFolder);</span>
<a href="#l6.2603"></a><span id="l6.2603">       let open = indexInView != null;</span>
<a href="#l6.2604"></a><span id="l6.2604"> </span>
<a href="#l6.2605"></a><span id="l6.2605">       // Delete the folder from the tree row cache.</span>
<a href="#l6.2606"></a><span id="l6.2606">       feedWindow.selectFolder(aFolder, { select: false, open: false, remove: true });</span>
<a href="#l6.2607"></a><span id="l6.2607"> </span>
<a href="#l6.2608"></a><span id="l6.2608" class="difflineminus">-      if (!open || curSelIndex &lt; 0)</span>
<a href="#l6.2609"></a><span id="l6.2609" class="difflineplus">+      if (!open || curSelIndex &lt; 0) {</span>
<a href="#l6.2610"></a><span id="l6.2610">         // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l6.2611"></a><span id="l6.2611">         return;</span>
<a href="#l6.2612"></a><span id="l6.2612" class="difflineplus">+      }</span>
<a href="#l6.2613"></a><span id="l6.2613"> </span>
<a href="#l6.2614"></a><span id="l6.2614">       let select =</span>
<a href="#l6.2615"></a><span id="l6.2615">         indexInView == curSelIndex ||</span>
<a href="#l6.2616"></a><span id="l6.2616">         feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l6.2617"></a><span id="l6.2617" class="difflineplus">+</span>
<a href="#l6.2618"></a><span id="l6.2618">       feedWindow.mView.removeItemAtIndex(indexInView, !select);</span>
<a href="#l6.2619"></a><span id="l6.2619">     },</span>
<a href="#l6.2620"></a><span id="l6.2620"> </span>
<a href="#l6.2621"></a><span id="l6.2621" class="difflineminus">-    folderRenamed: function(aOrigFolder, aNewFolder)</span>
<a href="#l6.2622"></a><span id="l6.2622" class="difflineminus">-    {</span>
<a href="#l6.2623"></a><span id="l6.2623" class="difflineminus">-      if (aNewFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aNewFolder))</span>
<a href="#l6.2624"></a><span id="l6.2624" class="difflineplus">+    folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l6.2625"></a><span id="l6.2625" class="difflineplus">+      if (aNewFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aNewFolder)) {</span>
<a href="#l6.2626"></a><span id="l6.2626">         return;</span>
<a href="#l6.2627"></a><span id="l6.2627" class="difflineplus">+      }</span>
<a href="#l6.2628"></a><span id="l6.2628"> </span>
<a href="#l6.2629"></a><span id="l6.2629">       FeedUtils.log.debug(&quot;folderRenamed: old:new - &quot; +</span>
<a href="#l6.2630"></a><span id="l6.2630">                           aOrigFolder.name + &quot;:&quot; + aNewFolder.name);</span>
<a href="#l6.2631"></a><span id="l6.2631" class="difflineminus">-      if (!this.feedWindow)</span>
<a href="#l6.2632"></a><span id="l6.2632" class="difflineplus">+      if (!this.feedWindow) {</span>
<a href="#l6.2633"></a><span id="l6.2633">         return;</span>
<a href="#l6.2634"></a><span id="l6.2634" class="difflineplus">+      }</span>
<a href="#l6.2635"></a><span id="l6.2635"> </span>
<a href="#l6.2636"></a><span id="l6.2636">       let feedWindow = this.feedWindow;</span>
<a href="#l6.2637"></a><span id="l6.2637">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l6.2638"></a><span id="l6.2638">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l6.2639"></a><span id="l6.2639">       let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l6.2640"></a><span id="l6.2640">       let indexInView = feedWindow.mView.getItemInViewIndex(aOrigFolder);</span>
<a href="#l6.2641"></a><span id="l6.2641">       let open = indexInView != null;</span>
<a href="#l6.2642"></a><span id="l6.2642"> </span>
<a href="#l6.2643"></a><span id="l6.2643">       // Rebuild the renamed folder's item in the tree row cache.</span>
<a href="#l6.2644"></a><span id="l6.2644">       feedWindow.selectFolder(aOrigFolder, { select: false,</span>
<a href="#l6.2645"></a><span id="l6.2645" class="difflineminus">-                                             open: open,</span>
<a href="#l6.2646"></a><span id="l6.2646" class="difflineplus">+                                             open,</span>
<a href="#l6.2647"></a><span id="l6.2647">                                              newFolder: aNewFolder });</span>
<a href="#l6.2648"></a><span id="l6.2648"> </span>
<a href="#l6.2649"></a><span id="l6.2649" class="difflineminus">-      if (!open || !curSelItem)</span>
<a href="#l6.2650"></a><span id="l6.2650" class="difflineplus">+      if (!open || !curSelItem) {</span>
<a href="#l6.2651"></a><span id="l6.2651">         // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l6.2652"></a><span id="l6.2652">         return;</span>
<a href="#l6.2653"></a><span id="l6.2653" class="difflineplus">+      }</span>
<a href="#l6.2654"></a><span id="l6.2654"> </span>
<a href="#l6.2655"></a><span id="l6.2655">       let select =</span>
<a href="#l6.2656"></a><span id="l6.2656">         indexInView == curSelIndex ||</span>
<a href="#l6.2657"></a><span id="l6.2657">         feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l6.2658"></a><span id="l6.2658" class="difflineplus">+</span>
<a href="#l6.2659"></a><span id="l6.2659">       let parentIndex = feedWindow.mView.getParentIndex(indexInView);</span>
<a href="#l6.2660"></a><span id="l6.2660" class="difflineminus">-      if (parentIndex == feedWindow.mView.kRowIndexUndefined)</span>
<a href="#l6.2661"></a><span id="l6.2661" class="difflineplus">+      if (parentIndex == feedWindow.mView.kRowIndexUndefined) {</span>
<a href="#l6.2662"></a><span id="l6.2662">         // Root folder is its own parent.</span>
<a href="#l6.2663"></a><span id="l6.2663">         parentIndex = indexInView;</span>
<a href="#l6.2664"></a><span id="l6.2664" class="difflineplus">+      }</span>
<a href="#l6.2665"></a><span id="l6.2665" class="difflineplus">+</span>
<a href="#l6.2666"></a><span id="l6.2666">       feedWindow.mView.toggle(parentIndex);</span>
<a href="#l6.2667"></a><span id="l6.2667">       feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l6.2668"></a><span id="l6.2668">       feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l6.2669"></a><span id="l6.2669"> </span>
<a href="#l6.2670"></a><span id="l6.2670">       if (curSelItem.container) {</span>
<a href="#l6.2671"></a><span id="l6.2671" class="difflineminus">-        if (curSelItem.folder == aOrigFolder)</span>
<a href="#l6.2672"></a><span id="l6.2672" class="difflineplus">+        if (curSelItem.folder == aOrigFolder) {</span>
<a href="#l6.2673"></a><span id="l6.2673">           feedWindow.selectFolder(aNewFolder, { open: curSelItem.open });</span>
<a href="#l6.2674"></a><span id="l6.2674" class="difflineminus">-        else if (select)</span>
<a href="#l6.2675"></a><span id="l6.2675" class="difflineplus">+        } else if (select) {</span>
<a href="#l6.2676"></a><span id="l6.2676">           feedWindow.mView.selection.select(indexInView);</span>
<a href="#l6.2677"></a><span id="l6.2677" class="difflineminus">-        else</span>
<a href="#l6.2678"></a><span id="l6.2678" class="difflineplus">+        } else {</span>
<a href="#l6.2679"></a><span id="l6.2679">           feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l6.2680"></a><span id="l6.2680" class="difflineminus">-      }</span>
<a href="#l6.2681"></a><span id="l6.2681" class="difflineminus">-      else</span>
<a href="#l6.2682"></a><span id="l6.2682" class="difflineplus">+        }</span>
<a href="#l6.2683"></a><span id="l6.2683" class="difflineplus">+      } else {</span>
<a href="#l6.2684"></a><span id="l6.2684">         feedWindow.selectFeed({ folder: curSelItem.parentFolder.rootFolder,</span>
<a href="#l6.2685"></a><span id="l6.2685">                                 url: curSelItem.url }, parentIndex);</span>
<a href="#l6.2686"></a><span id="l6.2686" class="difflineplus">+      }</span>
<a href="#l6.2687"></a><span id="l6.2687">     },</span>
<a href="#l6.2688"></a><span id="l6.2688"> </span>
<a href="#l6.2689"></a><span id="l6.2689" class="difflineminus">-    folderMoveCopyCompleted: function(aMove, aSrcFolder, aDestFolder)</span>
<a href="#l6.2690"></a><span id="l6.2690" class="difflineminus">-    {</span>
<a href="#l6.2691"></a><span id="l6.2691" class="difflineminus">-      if (aDestFolder.server.type != &quot;rss&quot;)</span>
<a href="#l6.2692"></a><span id="l6.2692" class="difflineplus">+    folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l6.2693"></a><span id="l6.2693" class="difflineplus">+      if (aDestFolder.server.type != &quot;rss&quot;) {</span>
<a href="#l6.2694"></a><span id="l6.2694">         return;</span>
<a href="#l6.2695"></a><span id="l6.2695" class="difflineplus">+      }</span>
<a href="#l6.2696"></a><span id="l6.2696"> </span>
<a href="#l6.2697"></a><span id="l6.2697">       FeedUtils.log.debug(&quot;folderMoveCopyCompleted: move:src:dest - &quot; +</span>
<a href="#l6.2698"></a><span id="l6.2698">                           aMove + &quot;:&quot; + aSrcFolder.name + &quot;:&quot; + aDestFolder.name);</span>
<a href="#l6.2699"></a><span id="l6.2699" class="difflineminus">-      if (!this.feedWindow)</span>
<a href="#l6.2700"></a><span id="l6.2700" class="difflineplus">+      if (!this.feedWindow) {</span>
<a href="#l6.2701"></a><span id="l6.2701">         return;</span>
<a href="#l6.2702"></a><span id="l6.2702" class="difflineplus">+      }</span>
<a href="#l6.2703"></a><span id="l6.2703"> </span>
<a href="#l6.2704"></a><span id="l6.2704">       let feedWindow = this.feedWindow;</span>
<a href="#l6.2705"></a><span id="l6.2705">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l6.2706"></a><span id="l6.2706">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l6.2707"></a><span id="l6.2707">       let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l6.2708"></a><span id="l6.2708">       let indexInView = feedWindow.mView.getItemInViewIndex(aSrcFolder);</span>
<a href="#l6.2709"></a><span id="l6.2709">       let destIndexInView = feedWindow.mView.getItemInViewIndex(aDestFolder);</span>
<a href="#l6.2710"></a><span id="l6.2710">       let open = indexInView != null || destIndexInView != null;</span>
<a href="#l6.2711"></a><span id="l6.2711">       let parentIndex = feedWindow.mView.getItemInViewIndex(aDestFolder.parent ||</span>
<a href="#l6.2712"></a><span id="l6.2712">                                                             aDestFolder);</span>
<a href="#l6.2713"></a><span id="l6.2713">       let select =</span>
<a href="#l6.2714"></a><span id="l6.2714">         indexInView == curSelIndex ||</span>
<a href="#l6.2715"></a><span id="l6.2715">         feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l6.2716"></a><span id="l6.2716"> </span>
<a href="#l6.2717"></a><span id="l6.2717" class="difflineminus">-      if (aMove)</span>
<a href="#l6.2718"></a><span id="l6.2718" class="difflineminus">-      {</span>
<a href="#l6.2719"></a><span id="l6.2719" class="difflineplus">+      if (aMove) {</span>
<a href="#l6.2720"></a><span id="l6.2720">         this.folderDeleted(aSrcFolder);</span>
<a href="#l6.2721"></a><span id="l6.2721" class="difflineminus">-        if (aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l6.2722"></a><span id="l6.2722" class="difflineplus">+        if (aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash)) {</span>
<a href="#l6.2723"></a><span id="l6.2723">           return;</span>
<a href="#l6.2724"></a><span id="l6.2724" class="difflineplus">+        }</span>
<a href="#l6.2725"></a><span id="l6.2725">       }</span>
<a href="#l6.2726"></a><span id="l6.2726"> </span>
<a href="#l6.2727"></a><span id="l6.2727" class="difflineminus">-      setTimeout(function() {</span>
<a href="#l6.2728"></a><span id="l6.2728" class="difflineplus">+      setTimeout(() =&gt; {</span>
<a href="#l6.2729"></a><span id="l6.2729">         // State on disk needs to settle before a folder object can be rebuilt.</span>
<a href="#l6.2730"></a><span id="l6.2730">         feedWindow.selectFolder(aDestFolder, { select: false,</span>
<a href="#l6.2731"></a><span id="l6.2731">                                                open: open || select,</span>
<a href="#l6.2732"></a><span id="l6.2732">                                                newFolder: aDestFolder });</span>
<a href="#l6.2733"></a><span id="l6.2733"> </span>
<a href="#l6.2734"></a><span id="l6.2734" class="difflineminus">-        if (!open || !curSelItem)</span>
<a href="#l6.2735"></a><span id="l6.2735" class="difflineplus">+        if (!open || !curSelItem) {</span>
<a href="#l6.2736"></a><span id="l6.2736">           // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l6.2737"></a><span id="l6.2737">           return;</span>
<a href="#l6.2738"></a><span id="l6.2738" class="difflineplus">+        }</span>
<a href="#l6.2739"></a><span id="l6.2739"> </span>
<a href="#l6.2740"></a><span id="l6.2740">         feedWindow.mView.toggle(parentIndex);</span>
<a href="#l6.2741"></a><span id="l6.2741">         feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l6.2742"></a><span id="l6.2742">         feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l6.2743"></a><span id="l6.2743"> </span>
<a href="#l6.2744"></a><span id="l6.2744">         if (curSelItem.container) {</span>
<a href="#l6.2745"></a><span id="l6.2745" class="difflineminus">-          if (curSelItem.folder == aSrcFolder || select)</span>
<a href="#l6.2746"></a><span id="l6.2746" class="difflineplus">+          if (curSelItem.folder == aSrcFolder || select) {</span>
<a href="#l6.2747"></a><span id="l6.2747">             feedWindow.selectFolder(aDestFolder, { open: true });</span>
<a href="#l6.2748"></a><span id="l6.2748" class="difflineminus">-          else</span>
<a href="#l6.2749"></a><span id="l6.2749" class="difflineplus">+          } else {</span>
<a href="#l6.2750"></a><span id="l6.2750">             feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l6.2751"></a><span id="l6.2751" class="difflineminus">-        }</span>
<a href="#l6.2752"></a><span id="l6.2752" class="difflineminus">-        else</span>
<a href="#l6.2753"></a><span id="l6.2753" class="difflineplus">+          }</span>
<a href="#l6.2754"></a><span id="l6.2754" class="difflineplus">+        } else {</span>
<a href="#l6.2755"></a><span id="l6.2755">           feedWindow.selectFeed({ folder: curSelItem.parentFolder.rootFolder,</span>
<a href="#l6.2756"></a><span id="l6.2756">                                   url: curSelItem.url }, null);</span>
<a href="#l6.2757"></a><span id="l6.2757" class="difflineplus">+        }</span>
<a href="#l6.2758"></a><span id="l6.2758">       }, 50);</span>
<a href="#l6.2759"></a><span id="l6.2759" class="difflineminus">-    }</span>
<a href="#l6.2760"></a><span id="l6.2760" class="difflineplus">+    },</span>
<a href="#l6.2761"></a><span id="l6.2761">   },</span>
<a href="#l6.2762"></a><span id="l6.2762"> </span>
<a href="#l6.2763"></a><span id="l6.2763">   /* *************************************************************** */</span>
<a href="#l6.2764"></a><span id="l6.2764">   /* OPML Functions                                                  */</span>
<a href="#l6.2765"></a><span id="l6.2765">   /* *************************************************************** */</span>
<a href="#l6.2766"></a><span id="l6.2766"> </span>
<a href="#l6.2767"></a><span id="l6.2767">   get brandShortName() {</span>
<a href="#l6.2768"></a><span id="l6.2768">     let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l6.2769"></a><span id="l6.2769">     return brandBundle ? brandBundle.getString(&quot;brandShortName&quot;) : &quot;&quot;;</span>
<a href="#l6.2770"></a><span id="l6.2770">   },</span>
<a href="#l6.2771"></a><span id="l6.2771"> </span>
<a href="#l6.2772"></a><span id="l6.2772"> /**</span>
<a href="#l6.2773"></a><span id="l6.2773">  * Export feeds as opml file Save As filepicker function.</span>
<a href="#l6.2774"></a><span id="l6.2774">  *</span>
<a href="#l6.2775"></a><span id="l6.2775" class="difflineminus">- * @param  bool aList - if true, exporting as list; if false (default)</span>
<a href="#l6.2776"></a><span id="l6.2776" class="difflineminus">- *                      exporting feeds in folder structure - used for title.</span>
<a href="#l6.2777"></a><span id="l6.2777" class="difflineminus">- * @return {Promise} nsIFile or null.</span>
<a href="#l6.2778"></a><span id="l6.2778" class="difflineplus">+ * @param {Boolean} aList - If true, exporting as list; if false (default)</span>
<a href="#l6.2779"></a><span id="l6.2779" class="difflineplus">+ *                          exporting feeds in folder structure - used for title.</span>
<a href="#l6.2780"></a><span id="l6.2780" class="difflineplus">+ * @returns {Promise} nsIFile or null.</span>
<a href="#l6.2781"></a><span id="l6.2781">  */</span>
<a href="#l6.2782"></a><span id="l6.2782" class="difflineminus">-  opmlPickSaveAsFile: function(aList)</span>
<a href="#l6.2783"></a><span id="l6.2783" class="difflineminus">-  {</span>
<a href="#l6.2784"></a><span id="l6.2784" class="difflineplus">+  opmlPickSaveAsFile(aList) {</span>
<a href="#l6.2785"></a><span id="l6.2785">     let accountName = this.mRSSServer.rootFolder.prettyName;</span>
<a href="#l6.2786"></a><span id="l6.2786">     let fileName = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2787"></a><span id="l6.2787">                      &quot;subscribe-OPMLExportDefaultFileName&quot;,</span>
<a href="#l6.2788"></a><span id="l6.2788">                      [this.brandShortName, accountName], 2);</span>
<a href="#l6.2789"></a><span id="l6.2789">     let title = aList ? FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2790"></a><span id="l6.2790">                           &quot;subscribe-OPMLExportTitleList&quot;, [accountName], 1) :</span>
<a href="#l6.2791"></a><span id="l6.2791">                         FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2792"></a><span id="l6.2792">                           &quot;subscribe-OPMLExportTitleStruct&quot;, [accountName], 1);</span>
<a href="#l6.2793"></a><span id="l6.2793">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l6.2794"></a><span id="l6.2794"> </span>
<a href="#l6.2795"></a><span id="l6.2795">     fp.defaultString = fileName;</span>
<a href="#l6.2796"></a><span id="l6.2796">     fp.defaultExtension = &quot;opml&quot;;</span>
<a href="#l6.2797"></a><span id="l6.2797" class="difflineminus">-    if (this.opmlLastSaveAsDir &amp;&amp; (this.opmlLastSaveAsDir instanceof Ci.nsIFile))</span>
<a href="#l6.2798"></a><span id="l6.2798" class="difflineplus">+    if (this.opmlLastSaveAsDir &amp;&amp; (this.opmlLastSaveAsDir instanceof Ci.nsIFile)) {</span>
<a href="#l6.2799"></a><span id="l6.2799">       fp.displayDirectory = this.opmlLastSaveAsDir;</span>
<a href="#l6.2800"></a><span id="l6.2800" class="difflineplus">+    }</span>
<a href="#l6.2801"></a><span id="l6.2801"> </span>
<a href="#l6.2802"></a><span id="l6.2802">     let opmlFilterText = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2803"></a><span id="l6.2803">                            &quot;subscribe-OPMLExportOPMLFilesFilterText&quot;);</span>
<a href="#l6.2804"></a><span id="l6.2804">     fp.appendFilter(opmlFilterText, &quot;*.opml&quot;);</span>
<a href="#l6.2805"></a><span id="l6.2805">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l6.2806"></a><span id="l6.2806">     fp.filterIndex = 0;</span>
<a href="#l6.2807"></a><span id="l6.2807">     fp.init(window, title, Ci.nsIFilePicker.modeSave);</span>
<a href="#l6.2808"></a><span id="l6.2808"> </span>
<a href="#l6.2809"></a><span id="l6.2809">     return new Promise(resolve =&gt; {</span>
<a href="#l6.2810"></a><span id="l6.2810">       fp.open(rv =&gt; {</span>
<a href="#l6.2811"></a><span id="l6.2811">         if ((rv != Ci.nsIFilePicker.returnOK &amp;&amp;</span>
<a href="#l6.2812"></a><span id="l6.2812">              rv != Ci.nsIFilePicker.returnReplace) ||</span>
<a href="#l6.2813"></a><span id="l6.2813">             !fp.file) {</span>
<a href="#l6.2814"></a><span id="l6.2814">           resolve(null);</span>
<a href="#l6.2815"></a><span id="l6.2815">           return;</span>
<a href="#l6.2816"></a><span id="l6.2816">         }</span>
<a href="#l6.2817"></a><span id="l6.2817" class="difflineplus">+</span>
<a href="#l6.2818"></a><span id="l6.2818">         this.opmlLastSaveAsDir = fp.file.parent;</span>
<a href="#l6.2819"></a><span id="l6.2819">         resolve(fp.file);</span>
<a href="#l6.2820"></a><span id="l6.2820">       });</span>
<a href="#l6.2821"></a><span id="l6.2821">     });</span>
<a href="#l6.2822"></a><span id="l6.2822">   },</span>
<a href="#l6.2823"></a><span id="l6.2823"> </span>
<a href="#l6.2824"></a><span id="l6.2824"> /**</span>
<a href="#l6.2825"></a><span id="l6.2825">  * Import feeds opml file Open filepicker function.</span>
<a href="#l6.2826"></a><span id="l6.2826">  *</span>
<a href="#l6.2827"></a><span id="l6.2827" class="difflineminus">- * @return {Promise} nsIFile or null.</span>
<a href="#l6.2828"></a><span id="l6.2828" class="difflineplus">+ * @returns {Promise} nsIFile or null.</span>
<a href="#l6.2829"></a><span id="l6.2829">  */</span>
<a href="#l6.2830"></a><span id="l6.2830" class="difflineminus">-  opmlPickOpenFile: function()</span>
<a href="#l6.2831"></a><span id="l6.2831" class="difflineminus">-  {</span>
<a href="#l6.2832"></a><span id="l6.2832" class="difflineplus">+  opmlPickOpenFile() {</span>
<a href="#l6.2833"></a><span id="l6.2833">     let title = FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportTitle&quot;);</span>
<a href="#l6.2834"></a><span id="l6.2834">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l6.2835"></a><span id="l6.2835"> </span>
<a href="#l6.2836"></a><span id="l6.2836">     fp.defaultString = &quot;&quot;;</span>
<a href="#l6.2837"></a><span id="l6.2837" class="difflineminus">-    if (this.opmlLastOpenDir &amp;&amp; (this.opmlLastOpenDir instanceof Ci.nsIFile))</span>
<a href="#l6.2838"></a><span id="l6.2838" class="difflineplus">+    if (this.opmlLastOpenDir &amp;&amp; (this.opmlLastOpenDir instanceof Ci.nsIFile)) {</span>
<a href="#l6.2839"></a><span id="l6.2839">       fp.displayDirectory = this.opmlLastOpenDir;</span>
<a href="#l6.2840"></a><span id="l6.2840" class="difflineplus">+    }</span>
<a href="#l6.2841"></a><span id="l6.2841"> </span>
<a href="#l6.2842"></a><span id="l6.2842">     let opmlFilterText = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.2843"></a><span id="l6.2843">                            &quot;subscribe-OPMLExportOPMLFilesFilterText&quot;);</span>
<a href="#l6.2844"></a><span id="l6.2844">     fp.appendFilter(opmlFilterText, &quot;*.opml&quot;);</span>
<a href="#l6.2845"></a><span id="l6.2845">     fp.appendFilters(Ci.nsIFilePicker.filterXML);</span>
<a href="#l6.2846"></a><span id="l6.2846">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l6.2847"></a><span id="l6.2847">     fp.init(window, title, Ci.nsIFilePicker.modeOpen);</span>
<a href="#l6.2848"></a><span id="l6.2848"> </span>
<a href="#l6.2849"></a><span id="l6.2849">     return new Promise(resolve =&gt; {</span>
<a href="#l6.2850"></a><span id="l6.2850">       fp.open(rv =&gt; {</span>
<a href="#l6.2851"></a><span id="l6.2851">         if (rv != Ci.nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l6.2852"></a><span id="l6.2852">           resolve(null);</span>
<a href="#l6.2853"></a><span id="l6.2853">           return;</span>
<a href="#l6.2854"></a><span id="l6.2854">         }</span>
<a href="#l6.2855"></a><span id="l6.2855" class="difflineplus">+</span>
<a href="#l6.2856"></a><span id="l6.2856">         this.opmlLastOpenDir = fp.file.parent;</span>
<a href="#l6.2857"></a><span id="l6.2857">         resolve(fp.file);</span>
<a href="#l6.2858"></a><span id="l6.2858">       });</span>
<a href="#l6.2859"></a><span id="l6.2859">     });</span>
<a href="#l6.2860"></a><span id="l6.2860">   },</span>
<a href="#l6.2861"></a><span id="l6.2861"> </span>
<a href="#l6.2862"></a><span id="l6.2862" class="difflineminus">-  exportOPML: async function(aEvent)</span>
<a href="#l6.2863"></a><span id="l6.2863" class="difflineminus">-  {</span>
<a href="#l6.2864"></a><span id="l6.2864" class="difflineplus">+  async exportOPML(aEvent) {</span>
<a href="#l6.2865"></a><span id="l6.2865">     // Account folder must be selected.</span>
<a href="#l6.2866"></a><span id="l6.2866">     let item = this.mView.currentItem;</span>
<a href="#l6.2867"></a><span id="l6.2867" class="difflineminus">-    if (!item || !item.folder || !item.folder.isServer)</span>
<a href="#l6.2868"></a><span id="l6.2868" class="difflineplus">+    if (!item || !item.folder || !item.folder.isServer) {</span>
<a href="#l6.2869"></a><span id="l6.2869">       return;</span>
<a href="#l6.2870"></a><span id="l6.2870" class="difflineplus">+    }</span>
<a href="#l6.2871"></a><span id="l6.2871"> </span>
<a href="#l6.2872"></a><span id="l6.2872">     this.mRSSServer = item.folder.server;</span>
<a href="#l6.2873"></a><span id="l6.2873">     let rootFolder = this.mRSSServer.rootFolder;</span>
<a href="#l6.2874"></a><span id="l6.2874">     let exportAsList = aEvent.ctrlKey;</span>
<a href="#l6.2875"></a><span id="l6.2875">     let SPACES2 = &quot;  &quot;;</span>
<a href="#l6.2876"></a><span id="l6.2876">     let SPACES4 = &quot;    &quot;;</span>
<a href="#l6.2877"></a><span id="l6.2877"> </span>
<a href="#l6.2878"></a><span id="l6.2878" class="difflineminus">-    if (this.mRSSServer.rootFolder.hasSubFolders)</span>
<a href="#l6.2879"></a><span id="l6.2879" class="difflineminus">-    {</span>
<a href="#l6.2880"></a><span id="l6.2880" class="difflineplus">+    if (this.mRSSServer.rootFolder.hasSubFolders) {</span>
<a href="#l6.2881"></a><span id="l6.2881">       let opmlDoc = document.implementation.createDocument(&quot;&quot;, &quot;opml&quot;, null);</span>
<a href="#l6.2882"></a><span id="l6.2882">       let opmlRoot = opmlDoc.documentElement;</span>
<a href="#l6.2883"></a><span id="l6.2883">       opmlRoot.setAttribute(&quot;version&quot;, &quot;1.0&quot;);</span>
<a href="#l6.2884"></a><span id="l6.2884">       opmlRoot.setAttribute(&quot;xmlns:fz&quot;, &quot;urn:forumzilla:&quot;);</span>
<a href="#l6.2885"></a><span id="l6.2885"> </span>
<a href="#l6.2886"></a><span id="l6.2886">       this.generatePPSpace(opmlRoot, SPACES2);</span>
<a href="#l6.2887"></a><span id="l6.2887"> </span>
<a href="#l6.2888"></a><span id="l6.2888">       // Make the &lt;head&gt; element.</span>
<a href="#l6.2889"></a><span id="l6.2889" class="difflineat">@@ -2336,172 +2308,164 @@ var FeedSubscriptions = {</span>
<a href="#l6.2890"></a><span id="l6.2890">       head.appendChild(dt);</span>
<a href="#l6.2891"></a><span id="l6.2891">       this.generatePPSpace(head, SPACES2);</span>
<a href="#l6.2892"></a><span id="l6.2892">       opmlRoot.appendChild(head);</span>
<a href="#l6.2893"></a><span id="l6.2893"> </span>
<a href="#l6.2894"></a><span id="l6.2894">       this.generatePPSpace(opmlRoot, SPACES2);</span>
<a href="#l6.2895"></a><span id="l6.2895"> </span>
<a href="#l6.2896"></a><span id="l6.2896">       // Add &lt;outline&gt;s to the &lt;body&gt;.</span>
<a href="#l6.2897"></a><span id="l6.2897">       let body = opmlDoc.createElement(&quot;body&quot;);</span>
<a href="#l6.2898"></a><span id="l6.2898" class="difflineminus">-      if (exportAsList)</span>
<a href="#l6.2899"></a><span id="l6.2899" class="difflineplus">+      if (exportAsList) {</span>
<a href="#l6.2900"></a><span id="l6.2900">         this.generateOutlineList(rootFolder, body, SPACES4.length + 2);</span>
<a href="#l6.2901"></a><span id="l6.2901" class="difflineminus">-      else</span>
<a href="#l6.2902"></a><span id="l6.2902" class="difflineplus">+      } else {</span>
<a href="#l6.2903"></a><span id="l6.2903">         this.generateOutlineStruct(rootFolder, body, SPACES4.length);</span>
<a href="#l6.2904"></a><span id="l6.2904" class="difflineplus">+      }</span>
<a href="#l6.2905"></a><span id="l6.2905"> </span>
<a href="#l6.2906"></a><span id="l6.2906">       this.generatePPSpace(body, SPACES2);</span>
<a href="#l6.2907"></a><span id="l6.2907"> </span>
<a href="#l6.2908"></a><span id="l6.2908" class="difflineminus">-      if (!body.childElementCount)</span>
<a href="#l6.2909"></a><span id="l6.2909" class="difflineplus">+      if (!body.childElementCount) {</span>
<a href="#l6.2910"></a><span id="l6.2910">         // No folders/feeds.</span>
<a href="#l6.2911"></a><span id="l6.2911">         return;</span>
<a href="#l6.2912"></a><span id="l6.2912" class="difflineplus">+      }</span>
<a href="#l6.2913"></a><span id="l6.2913"> </span>
<a href="#l6.2914"></a><span id="l6.2914">       opmlRoot.appendChild(body);</span>
<a href="#l6.2915"></a><span id="l6.2915">       this.generatePPSpace(opmlRoot, &quot;&quot;);</span>
<a href="#l6.2916"></a><span id="l6.2916"> </span>
<a href="#l6.2917"></a><span id="l6.2917" class="difflineminus">-      let serializer = new XMLSerializer();</span>
<a href="#l6.2918"></a><span id="l6.2918" class="difflineminus">-</span>
<a href="#l6.2919"></a><span id="l6.2919" class="difflineminus">-      if (FeedUtils.log.level &lt;= Log4Moz.Level.Debug)</span>
<a href="#l6.2920"></a><span id="l6.2920" class="difflineminus">-        FeedUtils.log.debug(&quot;exportOPML: opmlDoc -\n&quot; +</span>
<a href="#l6.2921"></a><span id="l6.2921" class="difflineminus">-                            serializer.serializeToString(opmlDoc) + &quot;\n&quot;);</span>
<a href="#l6.2922"></a><span id="l6.2922" class="difflineminus">-</span>
<a href="#l6.2923"></a><span id="l6.2923">       // Get file to save from filepicker.</span>
<a href="#l6.2924"></a><span id="l6.2924">       let saveAsFile = await this.opmlPickSaveAsFile(exportAsList);</span>
<a href="#l6.2925"></a><span id="l6.2925" class="difflineminus">-      if (!saveAsFile)</span>
<a href="#l6.2926"></a><span id="l6.2926" class="difflineplus">+      if (!saveAsFile) {</span>
<a href="#l6.2927"></a><span id="l6.2927">         return;</span>
<a href="#l6.2928"></a><span id="l6.2928" class="difflineplus">+      }</span>
<a href="#l6.2929"></a><span id="l6.2929"> </span>
<a href="#l6.2930"></a><span id="l6.2930">       let fos = FileUtils.openSafeFileOutputStream(saveAsFile);</span>
<a href="#l6.2931"></a><span id="l6.2931" class="difflineplus">+      let serializer = new XMLSerializer();</span>
<a href="#l6.2932"></a><span id="l6.2932">       serializer.serializeToStream(opmlDoc, fos, &quot;utf-8&quot;);</span>
<a href="#l6.2933"></a><span id="l6.2933">       FileUtils.closeSafeFileOutputStream(fos);</span>
<a href="#l6.2934"></a><span id="l6.2934"> </span>
<a href="#l6.2935"></a><span id="l6.2935">       let statusReport = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.2936"></a><span id="l6.2936">                            &quot;subscribe-OPMLExportDone&quot;, [saveAsFile.path], 1);</span>
<a href="#l6.2937"></a><span id="l6.2937">       this.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l6.2938"></a><span id="l6.2938" class="difflineplus">+      FeedUtils.log.info(&quot;exportOPML: &quot; + statusReport);</span>
<a href="#l6.2939"></a><span id="l6.2939">     }</span>
<a href="#l6.2940"></a><span id="l6.2940">   },</span>
<a href="#l6.2941"></a><span id="l6.2941"> </span>
<a href="#l6.2942"></a><span id="l6.2942" class="difflineminus">-  generatePPSpace: function(aNode, indentString)</span>
<a href="#l6.2943"></a><span id="l6.2943" class="difflineminus">-  {</span>
<a href="#l6.2944"></a><span id="l6.2944" class="difflineplus">+  generatePPSpace(aNode, indentString) {</span>
<a href="#l6.2945"></a><span id="l6.2945">     aNode.appendChild(aNode.ownerDocument.createTextNode(&quot;\n&quot;));</span>
<a href="#l6.2946"></a><span id="l6.2946">     aNode.appendChild(aNode.ownerDocument.createTextNode(indentString));</span>
<a href="#l6.2947"></a><span id="l6.2947">   },</span>
<a href="#l6.2948"></a><span id="l6.2948"> </span>
<a href="#l6.2949"></a><span id="l6.2949" class="difflineminus">-  generateOutlineList: function(baseFolder, parent, indentLevel)</span>
<a href="#l6.2950"></a><span id="l6.2950" class="difflineminus">-  {</span>
<a href="#l6.2951"></a><span id="l6.2951" class="difflineplus">+  generateOutlineList(baseFolder, parent, indentLevel) {</span>
<a href="#l6.2952"></a><span id="l6.2952">     // Pretty printing.</span>
<a href="#l6.2953"></a><span id="l6.2953">     let indentString = &quot; &quot;.repeat(indentLevel - 2);</span>
<a href="#l6.2954"></a><span id="l6.2954"> </span>
<a href="#l6.2955"></a><span id="l6.2955">     let feedOutline;</span>
<a href="#l6.2956"></a><span id="l6.2956">     let folderEnumerator = baseFolder.subFolders;</span>
<a href="#l6.2957"></a><span id="l6.2957" class="difflineminus">-    while (folderEnumerator.hasMoreElements())</span>
<a href="#l6.2958"></a><span id="l6.2958" class="difflineminus">-    {</span>
<a href="#l6.2959"></a><span id="l6.2959" class="difflineplus">+    while (folderEnumerator.hasMoreElements()) {</span>
<a href="#l6.2960"></a><span id="l6.2960">       let folder = folderEnumerator.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.2961"></a><span id="l6.2961">       FeedUtils.log.debug(&quot;generateOutlineList: folder - &quot; +</span>
<a href="#l6.2962"></a><span id="l6.2962">                           folder.filePath.path);</span>
<a href="#l6.2963"></a><span id="l6.2963">       if (!(folder instanceof Ci.nsIMsgFolder) ||</span>
<a href="#l6.2964"></a><span id="l6.2964">           folder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l6.2965"></a><span id="l6.2965" class="difflineminus">-          folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l6.2966"></a><span id="l6.2966" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l6.2967"></a><span id="l6.2967">         continue;</span>
<a href="#l6.2968"></a><span id="l6.2968" class="difflineplus">+      }</span>
<a href="#l6.2969"></a><span id="l6.2969"> </span>
<a href="#l6.2970"></a><span id="l6.2970">       FeedUtils.log.debug(&quot;generateOutlineList: CONTINUE folderName - &quot; +</span>
<a href="#l6.2971"></a><span id="l6.2971">                           folder.name);</span>
<a href="#l6.2972"></a><span id="l6.2972"> </span>
<a href="#l6.2973"></a><span id="l6.2973" class="difflineminus">-      if (folder.hasSubFolders)</span>
<a href="#l6.2974"></a><span id="l6.2974" class="difflineminus">-      {</span>
<a href="#l6.2975"></a><span id="l6.2975" class="difflineplus">+      if (folder.hasSubFolders) {</span>
<a href="#l6.2976"></a><span id="l6.2976">         FeedUtils.log.debug(&quot;generateOutlineList: has subfolders - &quot; +</span>
<a href="#l6.2977"></a><span id="l6.2977">                             folder.name);</span>
<a href="#l6.2978"></a><span id="l6.2978">         // Recurse.</span>
<a href="#l6.2979"></a><span id="l6.2979">         this.generateOutlineList(folder, parent, indentLevel);</span>
<a href="#l6.2980"></a><span id="l6.2980">       }</span>
<a href="#l6.2981"></a><span id="l6.2981"> </span>
<a href="#l6.2982"></a><span id="l6.2982">       // Add outline elements with xmlUrls.</span>
<a href="#l6.2983"></a><span id="l6.2983">       let feeds = this.getFeedsInFolder(folder);</span>
<a href="#l6.2984"></a><span id="l6.2984" class="difflineminus">-      for (let feed of feeds)</span>
<a href="#l6.2985"></a><span id="l6.2985" class="difflineminus">-      {</span>
<a href="#l6.2986"></a><span id="l6.2986" class="difflineplus">+      for (let feed of feeds) {</span>
<a href="#l6.2987"></a><span id="l6.2987">         FeedUtils.log.debug(&quot;generateOutlineList: folder has FEED url - &quot; +</span>
<a href="#l6.2988"></a><span id="l6.2988">                             folder.name + &quot; : &quot; + feed.url);</span>
<a href="#l6.2989"></a><span id="l6.2989">         feedOutline = this.exportOPMLOutline(feed, parent.ownerDocument);</span>
<a href="#l6.2990"></a><span id="l6.2990">         this.generatePPSpace(parent, indentString);</span>
<a href="#l6.2991"></a><span id="l6.2991">         parent.appendChild(feedOutline);</span>
<a href="#l6.2992"></a><span id="l6.2992">       }</span>
<a href="#l6.2993"></a><span id="l6.2993">     }</span>
<a href="#l6.2994"></a><span id="l6.2994">   },</span>
<a href="#l6.2995"></a><span id="l6.2995"> </span>
<a href="#l6.2996"></a><span id="l6.2996" class="difflineminus">-  generateOutlineStruct: function(baseFolder, parent, indentLevel)</span>
<a href="#l6.2997"></a><span id="l6.2997" class="difflineminus">-  {</span>
<a href="#l6.2998"></a><span id="l6.2998" class="difflineplus">+  generateOutlineStruct(baseFolder, parent, indentLevel) {</span>
<a href="#l6.2999"></a><span id="l6.2999">     // Pretty printing.</span>
<a href="#l6.3000"></a><span id="l6.3000" class="difflineminus">-    function indentString(len) { return &quot; &quot;.repeat(len - 2); };</span>
<a href="#l6.3001"></a><span id="l6.3001" class="difflineplus">+    function indentString(len) { return &quot; &quot;.repeat(len - 2); }</span>
<a href="#l6.3002"></a><span id="l6.3002"> </span>
<a href="#l6.3003"></a><span id="l6.3003">     let folderOutline, feedOutline;</span>
<a href="#l6.3004"></a><span id="l6.3004">     let folderEnumerator = baseFolder.subFolders;</span>
<a href="#l6.3005"></a><span id="l6.3005" class="difflineminus">-    while (folderEnumerator.hasMoreElements())</span>
<a href="#l6.3006"></a><span id="l6.3006" class="difflineminus">-    {</span>
<a href="#l6.3007"></a><span id="l6.3007" class="difflineplus">+    while (folderEnumerator.hasMoreElements()) {</span>
<a href="#l6.3008"></a><span id="l6.3008">       let folder = folderEnumerator.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.3009"></a><span id="l6.3009">       FeedUtils.log.debug(&quot;generateOutlineStruct: folder - &quot; +</span>
<a href="#l6.3010"></a><span id="l6.3010">                           folder.filePath.path);</span>
<a href="#l6.3011"></a><span id="l6.3011">       if (!(folder instanceof Ci.nsIMsgFolder) ||</span>
<a href="#l6.3012"></a><span id="l6.3012">           folder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l6.3013"></a><span id="l6.3013" class="difflineminus">-          folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l6.3014"></a><span id="l6.3014" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l6.3015"></a><span id="l6.3015">         continue;</span>
<a href="#l6.3016"></a><span id="l6.3016" class="difflineplus">+      }</span>
<a href="#l6.3017"></a><span id="l6.3017"> </span>
<a href="#l6.3018"></a><span id="l6.3018">       FeedUtils.log.debug(&quot;generateOutlineStruct: CONTINUE folderName - &quot; +</span>
<a href="#l6.3019"></a><span id="l6.3019">                           folder.name);</span>
<a href="#l6.3020"></a><span id="l6.3020"> </span>
<a href="#l6.3021"></a><span id="l6.3021">       // Make a folder outline element.</span>
<a href="#l6.3022"></a><span id="l6.3022">       folderOutline = parent.ownerDocument.createElement(&quot;outline&quot;);</span>
<a href="#l6.3023"></a><span id="l6.3023">       folderOutline.setAttribute(&quot;title&quot;, folder.prettyName);</span>
<a href="#l6.3024"></a><span id="l6.3024">       this.generatePPSpace(parent, indentString(indentLevel + 2));</span>
<a href="#l6.3025"></a><span id="l6.3025"> </span>
<a href="#l6.3026"></a><span id="l6.3026" class="difflineminus">-      if (folder.hasSubFolders)</span>
<a href="#l6.3027"></a><span id="l6.3027" class="difflineminus">-      {</span>
<a href="#l6.3028"></a><span id="l6.3028" class="difflineplus">+      if (folder.hasSubFolders) {</span>
<a href="#l6.3029"></a><span id="l6.3029">         FeedUtils.log.debug(&quot;generateOutlineStruct: has subfolders - &quot; +</span>
<a href="#l6.3030"></a><span id="l6.3030">                             folder.name);</span>
<a href="#l6.3031"></a><span id="l6.3031">         // Recurse.</span>
<a href="#l6.3032"></a><span id="l6.3032">         this.generateOutlineStruct(folder, folderOutline, indentLevel + 2);</span>
<a href="#l6.3033"></a><span id="l6.3033">       }</span>
<a href="#l6.3034"></a><span id="l6.3034"> </span>
<a href="#l6.3035"></a><span id="l6.3035">       let feeds = this.getFeedsInFolder(folder);</span>
<a href="#l6.3036"></a><span id="l6.3036" class="difflineminus">-      for (let feed of feeds)</span>
<a href="#l6.3037"></a><span id="l6.3037" class="difflineminus">-      {</span>
<a href="#l6.3038"></a><span id="l6.3038" class="difflineplus">+      for (let feed of feeds) {</span>
<a href="#l6.3039"></a><span id="l6.3039">         // Add feed outline elements with xmlUrls.</span>
<a href="#l6.3040"></a><span id="l6.3040" class="difflineminus">-        FeedUtils.log.debug(&quot;generateOutlineStruct: folder has FEED url - &quot;+</span>
<a href="#l6.3041"></a><span id="l6.3041" class="difflineplus">+        FeedUtils.log.debug(&quot;generateOutlineStruct: folder has FEED url - &quot; +</span>
<a href="#l6.3042"></a><span id="l6.3042">                             folder.name + &quot; : &quot; + feed.url);</span>
<a href="#l6.3043"></a><span id="l6.3043">         feedOutline = this.exportOPMLOutline(feed, parent.ownerDocument);</span>
<a href="#l6.3044"></a><span id="l6.3044">         this.generatePPSpace(folderOutline, indentString(indentLevel + 4));</span>
<a href="#l6.3045"></a><span id="l6.3045">         folderOutline.appendChild(feedOutline);</span>
<a href="#l6.3046"></a><span id="l6.3046">       }</span>
<a href="#l6.3047"></a><span id="l6.3047"> </span>
<a href="#l6.3048"></a><span id="l6.3048">       parent.appendChild(folderOutline);</span>
<a href="#l6.3049"></a><span id="l6.3049">     }</span>
<a href="#l6.3050"></a><span id="l6.3050">   },</span>
<a href="#l6.3051"></a><span id="l6.3051"> </span>
<a href="#l6.3052"></a><span id="l6.3052" class="difflineminus">-  exportOPMLOutline: function(aFeed, aDoc)</span>
<a href="#l6.3053"></a><span id="l6.3053" class="difflineminus">-  {</span>
<a href="#l6.3054"></a><span id="l6.3054" class="difflineplus">+  exportOPMLOutline(aFeed, aDoc) {</span>
<a href="#l6.3055"></a><span id="l6.3055">     let outRv = aDoc.createElement(&quot;outline&quot;);</span>
<a href="#l6.3056"></a><span id="l6.3056">     outRv.setAttribute(&quot;type&quot;, &quot;rss&quot;);</span>
<a href="#l6.3057"></a><span id="l6.3057">     outRv.setAttribute(&quot;title&quot;, aFeed.title);</span>
<a href="#l6.3058"></a><span id="l6.3058">     outRv.setAttribute(&quot;text&quot;, aFeed.title);</span>
<a href="#l6.3059"></a><span id="l6.3059">     outRv.setAttribute(&quot;version&quot;, &quot;RSS&quot;);</span>
<a href="#l6.3060"></a><span id="l6.3060">     outRv.setAttribute(&quot;fz:quickMode&quot;, aFeed.quickMode);</span>
<a href="#l6.3061"></a><span id="l6.3061">     outRv.setAttribute(&quot;fz:options&quot;, JSON.stringify(aFeed.options));</span>
<a href="#l6.3062"></a><span id="l6.3062">     outRv.setAttribute(&quot;xmlUrl&quot;, aFeed.url);</span>
<a href="#l6.3063"></a><span id="l6.3063">     outRv.setAttribute(&quot;htmlUrl&quot;, aFeed.link);</span>
<a href="#l6.3064"></a><span id="l6.3064">     return outRv;</span>
<a href="#l6.3065"></a><span id="l6.3065">   },</span>
<a href="#l6.3066"></a><span id="l6.3066"> </span>
<a href="#l6.3067"></a><span id="l6.3067" class="difflineminus">-  importOPML: async function()</span>
<a href="#l6.3068"></a><span id="l6.3068" class="difflineminus">-  {</span>
<a href="#l6.3069"></a><span id="l6.3069" class="difflineplus">+  async importOPML() {</span>
<a href="#l6.3070"></a><span id="l6.3070">     // Account folder must be selected in subscribe dialog.</span>
<a href="#l6.3071"></a><span id="l6.3071">     let item = this.mView ? this.mView.currentItem : null;</span>
<a href="#l6.3072"></a><span id="l6.3072" class="difflineminus">-    if (!item || !item.folder || !item.folder.isServer)</span>
<a href="#l6.3073"></a><span id="l6.3073" class="difflineplus">+    if (!item || !item.folder || !item.folder.isServer) {</span>
<a href="#l6.3074"></a><span id="l6.3074">       return;</span>
<a href="#l6.3075"></a><span id="l6.3075" class="difflineplus">+    }</span>
<a href="#l6.3076"></a><span id="l6.3076"> </span>
<a href="#l6.3077"></a><span id="l6.3077">     let server = item.folder.server;</span>
<a href="#l6.3078"></a><span id="l6.3078">     // Get file to open from filepicker.</span>
<a href="#l6.3079"></a><span id="l6.3079">     let openFile = await this.opmlPickOpenFile();</span>
<a href="#l6.3080"></a><span id="l6.3080" class="difflineminus">-    if (!openFile)</span>
<a href="#l6.3081"></a><span id="l6.3081" class="difflineplus">+    if (!openFile) {</span>
<a href="#l6.3082"></a><span id="l6.3082">       return;</span>
<a href="#l6.3083"></a><span id="l6.3083" class="difflineplus">+    }</span>
<a href="#l6.3084"></a><span id="l6.3084"> </span>
<a href="#l6.3085"></a><span id="l6.3085">     this.mActionMode = this.kImportingOPML;</span>
<a href="#l6.3086"></a><span id="l6.3086">     this.updateButtons(null);</span>
<a href="#l6.3087"></a><span id="l6.3087">     this.selectFolder(item.folder, { select: false, open: true });</span>
<a href="#l6.3088"></a><span id="l6.3088">     let statusReport = FeedUtils.strings.GetStringFromName(&quot;subscribe-loading&quot;);</span>
<a href="#l6.3089"></a><span id="l6.3089">     this.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l6.3090"></a><span id="l6.3090">     // If there were a getElementsByAttribute in html, we could go determined...</span>
<a href="#l6.3091"></a><span id="l6.3091">     this.updateStatusItem(&quot;progressMeter&quot;, &quot;?&quot;);</span>
<a href="#l6.3092"></a><span id="l6.3092" class="difflineat">@@ -2512,286 +2476,268 @@ var FeedSubscriptions = {</span>
<a href="#l6.3093"></a><span id="l6.3093">       this.clearStatusInfo();</span>
<a href="#l6.3094"></a><span id="l6.3094">     }</span>
<a href="#l6.3095"></a><span id="l6.3095">   },</span>
<a href="#l6.3096"></a><span id="l6.3096"> </span>
<a href="#l6.3097"></a><span id="l6.3097"> /**</span>
<a href="#l6.3098"></a><span id="l6.3098">  * Import opml file into a feed account.  Used by the Subscribe dialog and</span>
<a href="#l6.3099"></a><span id="l6.3099">  * the Import wizard.</span>
<a href="#l6.3100"></a><span id="l6.3100">  *</span>
<a href="#l6.3101"></a><span id="l6.3101" class="difflineminus">- * @param  nsIFile aFile                - the opml file.</span>
<a href="#l6.3102"></a><span id="l6.3102" class="difflineminus">- * @param  nsIMsgIncomingServer aServer - the account server.</span>
<a href="#l6.3103"></a><span id="l6.3103" class="difflineminus">- * @param  func aCallback               - callback function.</span>
<a href="#l6.3104"></a><span id="l6.3104" class="difflineplus">+ * @param {nsIFile} aFile                - The opml file.</span>
<a href="#l6.3105"></a><span id="l6.3105" class="difflineplus">+ * @param {nsIMsgIncomingServer} aServer - The account server.</span>
<a href="#l6.3106"></a><span id="l6.3106" class="difflineplus">+ * @param {Function} aCallback           - Callback function.</span>
<a href="#l6.3107"></a><span id="l6.3107">  *</span>
<a href="#l6.3108"></a><span id="l6.3108" class="difflineminus">- * @return bool                         - false if error.</span>
<a href="#l6.3109"></a><span id="l6.3109" class="difflineplus">+ * @returns {Boolean}                    - false if error.</span>
<a href="#l6.3110"></a><span id="l6.3110">  */</span>
<a href="#l6.3111"></a><span id="l6.3111" class="difflineminus">-  importOPMLFile: function(aFile, aServer, aCallback)</span>
<a href="#l6.3112"></a><span id="l6.3112" class="difflineminus">-  {</span>
<a href="#l6.3113"></a><span id="l6.3113" class="difflineminus">-    if (aServer &amp;&amp; (aServer instanceof Ci.nsIMsgIncomingServer))</span>
<a href="#l6.3114"></a><span id="l6.3114" class="difflineplus">+  importOPMLFile(aFile, aServer, aCallback) {</span>
<a href="#l6.3115"></a><span id="l6.3115" class="difflineplus">+    if (aServer &amp;&amp; (aServer instanceof Ci.nsIMsgIncomingServer)) {</span>
<a href="#l6.3116"></a><span id="l6.3116">       this.mRSSServer = aServer;</span>
<a href="#l6.3117"></a><span id="l6.3117" class="difflineminus">-</span>
<a href="#l6.3118"></a><span id="l6.3118" class="difflineminus">-    if (!aFile || !this.mRSSServer || !aCallback)</span>
<a href="#l6.3119"></a><span id="l6.3119" class="difflineplus">+    }</span>
<a href="#l6.3120"></a><span id="l6.3120" class="difflineplus">+</span>
<a href="#l6.3121"></a><span id="l6.3121" class="difflineplus">+    if (!aFile || !this.mRSSServer || !aCallback) {</span>
<a href="#l6.3122"></a><span id="l6.3122">       return false;</span>
<a href="#l6.3123"></a><span id="l6.3123" class="difflineplus">+    }</span>
<a href="#l6.3124"></a><span id="l6.3124"> </span>
<a href="#l6.3125"></a><span id="l6.3125">     let opmlDom, statusReport;</span>
<a href="#l6.3126"></a><span id="l6.3126">     let stream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l6.3127"></a><span id="l6.3127">                  createInstance(Ci.nsIFileInputStream);</span>
<a href="#l6.3128"></a><span id="l6.3128"> </span>
<a href="#l6.3129"></a><span id="l6.3129">     // Read in file as raw bytes, so Expat can do the decoding for us.</span>
<a href="#l6.3130"></a><span id="l6.3130">     try {</span>
<a href="#l6.3131"></a><span id="l6.3131">       stream.init(aFile, FileUtils.MODE_RDONLY, FileUtils.PERMS_FILE, 0);</span>
<a href="#l6.3132"></a><span id="l6.3132">       let parser = new DOMParser();</span>
<a href="#l6.3133"></a><span id="l6.3133">       opmlDom = parser.parseFromStream(stream, null, stream.available(),</span>
<a href="#l6.3134"></a><span id="l6.3134">                                        &quot;application/xml&quot;);</span>
<a href="#l6.3135"></a><span id="l6.3135" class="difflineminus">-    }</span>
<a href="#l6.3136"></a><span id="l6.3136" class="difflineminus">-    catch(e) {</span>
<a href="#l6.3137"></a><span id="l6.3137" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.3138"></a><span id="l6.3138">       statusReport = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.3139"></a><span id="l6.3139">                        &quot;subscribe-errorOpeningFile&quot;);</span>
<a href="#l6.3140"></a><span id="l6.3140">       Services.prompt.alert(window, null, statusReport);</span>
<a href="#l6.3141"></a><span id="l6.3141">       return false;</span>
<a href="#l6.3142"></a><span id="l6.3142" class="difflineminus">-    }</span>
<a href="#l6.3143"></a><span id="l6.3143" class="difflineminus">-    finally {</span>
<a href="#l6.3144"></a><span id="l6.3144" class="difflineplus">+    } finally {</span>
<a href="#l6.3145"></a><span id="l6.3145">       stream.close();</span>
<a href="#l6.3146"></a><span id="l6.3146">     }</span>
<a href="#l6.3147"></a><span id="l6.3147"> </span>
<a href="#l6.3148"></a><span id="l6.3148">     let body = opmlDom ? opmlDom.querySelector(&quot;body&quot;) : null;</span>
<a href="#l6.3149"></a><span id="l6.3149"> </span>
<a href="#l6.3150"></a><span id="l6.3150">     // Return if the OPML file is invalid or empty.</span>
<a href="#l6.3151"></a><span id="l6.3151">     if (!body || !body.childElementCount ||</span>
<a href="#l6.3152"></a><span id="l6.3152" class="difflineminus">-      opmlDom.documentElement.tagName != &quot;opml&quot;)</span>
<a href="#l6.3153"></a><span id="l6.3153" class="difflineminus">-    {</span>
<a href="#l6.3154"></a><span id="l6.3154" class="difflineplus">+        opmlDom.documentElement.tagName != &quot;opml&quot;) {</span>
<a href="#l6.3155"></a><span id="l6.3155">       statusReport = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.3156"></a><span id="l6.3156">                        &quot;subscribe-OPMLImportInvalidFile&quot;, [aFile.leafName], 1);</span>
<a href="#l6.3157"></a><span id="l6.3157">       Services.prompt.alert(window, null, statusReport);</span>
<a href="#l6.3158"></a><span id="l6.3158">       return false;</span>
<a href="#l6.3159"></a><span id="l6.3159">     }</span>
<a href="#l6.3160"></a><span id="l6.3160"> </span>
<a href="#l6.3161"></a><span id="l6.3161">     this.importOPMLOutlines(body, this.mRSSServer, aCallback);</span>
<a href="#l6.3162"></a><span id="l6.3162">     return true;</span>
<a href="#l6.3163"></a><span id="l6.3163">   },</span>
<a href="#l6.3164"></a><span id="l6.3164"> </span>
<a href="#l6.3165"></a><span id="l6.3165" class="difflineminus">-  importOPMLOutlines: function(aBody, aRSSServer, aCallback)</span>
<a href="#l6.3166"></a><span id="l6.3166" class="difflineminus">-  {</span>
<a href="#l6.3167"></a><span id="l6.3167" class="difflineplus">+  importOPMLOutlines(aBody, aRSSServer, aCallback) {</span>
<a href="#l6.3168"></a><span id="l6.3168">     let win = this;</span>
<a href="#l6.3169"></a><span id="l6.3169">     let rssServer = aRSSServer;</span>
<a href="#l6.3170"></a><span id="l6.3170">     let callback = aCallback;</span>
<a href="#l6.3171"></a><span id="l6.3171">     let outline, feedFolder;</span>
<a href="#l6.3172"></a><span id="l6.3172">     let badTag = false;</span>
<a href="#l6.3173"></a><span id="l6.3173">     let firstFeedInFolderQuickMode = null;</span>
<a href="#l6.3174"></a><span id="l6.3174">     let lastFolder;</span>
<a href="#l6.3175"></a><span id="l6.3175">     let feedsAdded = 0;</span>
<a href="#l6.3176"></a><span id="l6.3176">     let rssOutlines = 0;</span>
<a href="#l6.3177"></a><span id="l6.3177" class="difflineminus">-    let folderOutlines = 0;</span>
<a href="#l6.3178"></a><span id="l6.3178" class="difflineminus">-</span>
<a href="#l6.3179"></a><span id="l6.3179" class="difflineminus">-    function processor(aParentNode, aParentFolder)</span>
<a href="#l6.3180"></a><span id="l6.3180" class="difflineminus">-    {</span>
<a href="#l6.3181"></a><span id="l6.3181" class="difflineplus">+</span>
<a href="#l6.3182"></a><span id="l6.3182" class="difflineplus">+    function processor(aParentNode, aParentFolder) {</span>
<a href="#l6.3183"></a><span id="l6.3183">       FeedUtils.log.trace(&quot;importOPMLOutlines: PROCESSOR tag:name:children - &quot; +</span>
<a href="#l6.3184"></a><span id="l6.3184">                           aParentNode.tagName + &quot;:&quot; +</span>
<a href="#l6.3185"></a><span id="l6.3185">                           aParentNode.getAttribute(&quot;text&quot;) + &quot;:&quot; +</span>
<a href="#l6.3186"></a><span id="l6.3186">                           aParentNode.childElementCount);</span>
<a href="#l6.3187"></a><span id="l6.3187" class="difflineminus">-      while (true)</span>
<a href="#l6.3188"></a><span id="l6.3188" class="difflineminus">-      {</span>
<a href="#l6.3189"></a><span id="l6.3189" class="difflineminus">-        if (aParentNode.tagName == &quot;body&quot; &amp;&amp; !aParentNode.childElementCount)</span>
<a href="#l6.3190"></a><span id="l6.3190" class="difflineminus">-        {</span>
<a href="#l6.3191"></a><span id="l6.3191" class="difflineplus">+      while (true) {</span>
<a href="#l6.3192"></a><span id="l6.3192" class="difflineplus">+        if (aParentNode.tagName == &quot;body&quot; &amp;&amp; !aParentNode.childElementCount) {</span>
<a href="#l6.3193"></a><span id="l6.3193">           // Finished.</span>
<a href="#l6.3194"></a><span id="l6.3194">           let statusReport = win.importOPMLStatus(feedsAdded, rssOutlines);</span>
<a href="#l6.3195"></a><span id="l6.3195">           callback(statusReport, lastFolder, win);</span>
<a href="#l6.3196"></a><span id="l6.3196">           return;</span>
<a href="#l6.3197"></a><span id="l6.3197">         }</span>
<a href="#l6.3198"></a><span id="l6.3198"> </span>
<a href="#l6.3199"></a><span id="l6.3199">         outline = aParentNode.firstElementChild;</span>
<a href="#l6.3200"></a><span id="l6.3200" class="difflineminus">-        if (outline.tagName != &quot;outline&quot;)</span>
<a href="#l6.3201"></a><span id="l6.3201" class="difflineminus">-        {</span>
<a href="#l6.3202"></a><span id="l6.3202" class="difflineplus">+        if (outline.tagName != &quot;outline&quot;) {</span>
<a href="#l6.3203"></a><span id="l6.3203">           FeedUtils.log.info(&quot;importOPMLOutlines: skipping, node is not an &quot; +</span>
<a href="#l6.3204"></a><span id="l6.3204">                              &quot;&lt;outline&gt; - &lt;&quot; + outline.tagName + &quot;&gt;&quot;);</span>
<a href="#l6.3205"></a><span id="l6.3205">           badTag = true;</span>
<a href="#l6.3206"></a><span id="l6.3206">           break;</span>
<a href="#l6.3207"></a><span id="l6.3207">         }</span>
<a href="#l6.3208"></a><span id="l6.3208"> </span>
<a href="#l6.3209"></a><span id="l6.3209">         let outlineName = outline.getAttribute(&quot;text&quot;) ||</span>
<a href="#l6.3210"></a><span id="l6.3210">                           outline.getAttribute(&quot;title&quot;) ||</span>
<a href="#l6.3211"></a><span id="l6.3211">                           outline.getAttribute(&quot;xmlUrl&quot;);</span>
<a href="#l6.3212"></a><span id="l6.3212">         let feedUrl, folder;</span>
<a href="#l6.3213"></a><span id="l6.3213"> </span>
<a href="#l6.3214"></a><span id="l6.3214" class="difflineminus">-        if (outline.getAttribute(&quot;type&quot;) == &quot;rss&quot;)</span>
<a href="#l6.3215"></a><span id="l6.3215" class="difflineminus">-        {</span>
<a href="#l6.3216"></a><span id="l6.3216" class="difflineplus">+        if (outline.getAttribute(&quot;type&quot;) == &quot;rss&quot;) {</span>
<a href="#l6.3217"></a><span id="l6.3217">           // A feed outline.</span>
<a href="#l6.3218"></a><span id="l6.3218">           feedUrl = outline.getAttribute(&quot;xmlUrl&quot;) || outline.getAttribute(&quot;url&quot;);</span>
<a href="#l6.3219"></a><span id="l6.3219" class="difflineminus">-          if (!feedUrl)</span>
<a href="#l6.3220"></a><span id="l6.3220" class="difflineminus">-          {</span>
<a href="#l6.3221"></a><span id="l6.3221" class="difflineplus">+          if (!feedUrl) {</span>
<a href="#l6.3222"></a><span id="l6.3222">             FeedUtils.log.info(&quot;importOPMLOutlines: skipping, type=rss &lt;outline&gt; &quot; +</span>
<a href="#l6.3223"></a><span id="l6.3223">                                &quot;has no url - &quot; + outlineName);</span>
<a href="#l6.3224"></a><span id="l6.3224">             break;</span>
<a href="#l6.3225"></a><span id="l6.3225">           }</span>
<a href="#l6.3226"></a><span id="l6.3226"> </span>
<a href="#l6.3227"></a><span id="l6.3227">           rssOutlines++;</span>
<a href="#l6.3228"></a><span id="l6.3228">           feedFolder = aParentFolder;</span>
<a href="#l6.3229"></a><span id="l6.3229"> </span>
<a href="#l6.3230"></a><span id="l6.3230" class="difflineminus">-          if (FeedUtils.feedAlreadyExists(feedUrl, rssServer))</span>
<a href="#l6.3231"></a><span id="l6.3231" class="difflineminus">-          {</span>
<a href="#l6.3232"></a><span id="l6.3232" class="difflineplus">+          if (FeedUtils.feedAlreadyExists(feedUrl, rssServer)) {</span>
<a href="#l6.3233"></a><span id="l6.3233">             FeedUtils.log.info(&quot;importOPMLOutlines: feed already subscribed in account &quot; +</span>
<a href="#l6.3234"></a><span id="l6.3234">                                rssServer.prettyName + &quot;, url - &quot; + feedUrl);</span>
<a href="#l6.3235"></a><span id="l6.3235">             break;</span>
<a href="#l6.3236"></a><span id="l6.3236">           }</span>
<a href="#l6.3237"></a><span id="l6.3237"> </span>
<a href="#l6.3238"></a><span id="l6.3238">           if (aParentNode.tagName == &quot;outline&quot; &amp;&amp;</span>
<a href="#l6.3239"></a><span id="l6.3239" class="difflineminus">-              aParentNode.getAttribute(&quot;type&quot;) != &quot;rss&quot;)</span>
<a href="#l6.3240"></a><span id="l6.3240" class="difflineminus">-          {</span>
<a href="#l6.3241"></a><span id="l6.3241" class="difflineplus">+              aParentNode.getAttribute(&quot;type&quot;) != &quot;rss&quot;) {</span>
<a href="#l6.3242"></a><span id="l6.3242">             // Parent is a folder, already created.</span>
<a href="#l6.3243"></a><span id="l6.3243">             folder = feedFolder;</span>
<a href="#l6.3244"></a><span id="l6.3244" class="difflineminus">-          }</span>
<a href="#l6.3245"></a><span id="l6.3245" class="difflineminus">-          else</span>
<a href="#l6.3246"></a><span id="l6.3246" class="difflineminus">-          {</span>
<a href="#l6.3247"></a><span id="l6.3247" class="difflineplus">+          } else {</span>
<a href="#l6.3248"></a><span id="l6.3248">             // Parent is not a folder outline, likely the &lt;body&gt; in a flat list.</span>
<a href="#l6.3249"></a><span id="l6.3249">             // Create feed's folder with feed's name and account rootFolder as</span>
<a href="#l6.3250"></a><span id="l6.3250">             // parent of feed's folder.</span>
<a href="#l6.3251"></a><span id="l6.3251">             // NOTE: Assume a type=rss outline must be a leaf and is not a</span>
<a href="#l6.3252"></a><span id="l6.3252">             // direct parent of another type=rss outline; such a structure</span>
<a href="#l6.3253"></a><span id="l6.3253">             // may lead to unintended nesting and inaccurate counts.</span>
<a href="#l6.3254"></a><span id="l6.3254">             folder = rssServer.rootFolder;</span>
<a href="#l6.3255"></a><span id="l6.3255">           }</span>
<a href="#l6.3256"></a><span id="l6.3256"> </span>
<a href="#l6.3257"></a><span id="l6.3257">           // Create the feed.</span>
<a href="#l6.3258"></a><span id="l6.3258">           let quickMode = outline.hasAttribute(&quot;fz:quickMode&quot;) ?</span>
<a href="#l6.3259"></a><span id="l6.3259">                             outline.getAttribute(&quot;fz:quickMode&quot;) == &quot;true&quot; :</span>
<a href="#l6.3260"></a><span id="l6.3260">                             rssServer.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l6.3261"></a><span id="l6.3261">           let options = outline.getAttribute(&quot;fz:options&quot;);</span>
<a href="#l6.3262"></a><span id="l6.3262">           options = options ? JSON.parse(options) : null;</span>
<a href="#l6.3263"></a><span id="l6.3263"> </span>
<a href="#l6.3264"></a><span id="l6.3264" class="difflineminus">-          if (firstFeedInFolderQuickMode === null)</span>
<a href="#l6.3265"></a><span id="l6.3265" class="difflineplus">+          if (firstFeedInFolderQuickMode === null) {</span>
<a href="#l6.3266"></a><span id="l6.3266">             // The summary/web page pref applies to all feeds in a folder,</span>
<a href="#l6.3267"></a><span id="l6.3267">             // though it is a property of an individual feed.  This can be</span>
<a href="#l6.3268"></a><span id="l6.3268">             // set (and is obvious) in the subscribe dialog; ensure import</span>
<a href="#l6.3269"></a><span id="l6.3269">             // doesn't leave mismatches if mismatched in the opml file.</span>
<a href="#l6.3270"></a><span id="l6.3270">             firstFeedInFolderQuickMode = quickMode;</span>
<a href="#l6.3271"></a><span id="l6.3271" class="difflineminus">-          else</span>
<a href="#l6.3272"></a><span id="l6.3272" class="difflineplus">+          } else {</span>
<a href="#l6.3273"></a><span id="l6.3273">             quickMode = firstFeedInFolderQuickMode;</span>
<a href="#l6.3274"></a><span id="l6.3274" class="difflineminus">-</span>
<a href="#l6.3275"></a><span id="l6.3275" class="difflineminus">-          let feedProperties = { feedName     : outlineName,</span>
<a href="#l6.3276"></a><span id="l6.3276" class="difflineminus">-                                 feedLocation : feedUrl,</span>
<a href="#l6.3277"></a><span id="l6.3277" class="difflineminus">-                                 feedFolder   : folder,</span>
<a href="#l6.3278"></a><span id="l6.3278" class="difflineminus">-                                 quickMode    : quickMode,</span>
<a href="#l6.3279"></a><span id="l6.3279" class="difflineminus">-                                 options      : options };</span>
<a href="#l6.3280"></a><span id="l6.3280" class="difflineminus">-</span>
<a href="#l6.3281"></a><span id="l6.3281" class="difflineminus">-          FeedUtils.log.info(&quot;importOPMLOutlines: importing feed: name, url - &quot;+</span>
<a href="#l6.3282"></a><span id="l6.3282" class="difflineplus">+          }</span>
<a href="#l6.3283"></a><span id="l6.3283" class="difflineplus">+</span>
<a href="#l6.3284"></a><span id="l6.3284" class="difflineplus">+          let feedProperties = { feedName: outlineName,</span>
<a href="#l6.3285"></a><span id="l6.3285" class="difflineplus">+                                 feedLocation: feedUrl,</span>
<a href="#l6.3286"></a><span id="l6.3286" class="difflineplus">+                                 feedFolder: folder,</span>
<a href="#l6.3287"></a><span id="l6.3287" class="difflineplus">+                                 quickMode,</span>
<a href="#l6.3288"></a><span id="l6.3288" class="difflineplus">+                                 options,</span>
<a href="#l6.3289"></a><span id="l6.3289" class="difflineplus">+                               };</span>
<a href="#l6.3290"></a><span id="l6.3290" class="difflineplus">+</span>
<a href="#l6.3291"></a><span id="l6.3291" class="difflineplus">+          FeedUtils.log.info(&quot;importOPMLOutlines: importing feed: name, url - &quot; +</span>
<a href="#l6.3292"></a><span id="l6.3292">                              outlineName + &quot;, &quot; + feedUrl);</span>
<a href="#l6.3293"></a><span id="l6.3293"> </span>
<a href="#l6.3294"></a><span id="l6.3294">           let feed = win.storeFeed(feedProperties);</span>
<a href="#l6.3295"></a><span id="l6.3295" class="difflineminus">-          if (outline.hasAttribute(&quot;htmlUrl&quot;))</span>
<a href="#l6.3296"></a><span id="l6.3296" class="difflineplus">+          if (outline.hasAttribute(&quot;htmlUrl&quot;)) {</span>
<a href="#l6.3297"></a><span id="l6.3297">             feed.link = outline.getAttribute(&quot;htmlUrl&quot;);</span>
<a href="#l6.3298"></a><span id="l6.3298" class="difflineplus">+          }</span>
<a href="#l6.3299"></a><span id="l6.3299"> </span>
<a href="#l6.3300"></a><span id="l6.3300">           feed.createFolder();</span>
<a href="#l6.3301"></a><span id="l6.3301" class="difflineminus">-          if (!feed.folder)</span>
<a href="#l6.3302"></a><span id="l6.3302" class="difflineminus">-          {</span>
<a href="#l6.3303"></a><span id="l6.3303" class="difflineplus">+          if (!feed.folder) {</span>
<a href="#l6.3304"></a><span id="l6.3304">             // Non success. Remove intermediate traces from the feeds database.</span>
<a href="#l6.3305"></a><span id="l6.3305" class="difflineminus">-            if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l6.3306"></a><span id="l6.3306" class="difflineplus">+            if (feed &amp;&amp; feed.url &amp;&amp; feed.server) {</span>
<a href="#l6.3307"></a><span id="l6.3307">               FeedUtils.deleteFeed(feed);</span>
<a href="#l6.3308"></a><span id="l6.3308" class="difflineplus">+            }</span>
<a href="#l6.3309"></a><span id="l6.3309"> </span>
<a href="#l6.3310"></a><span id="l6.3310">             FeedUtils.log.info(&quot;importOPMLOutlines: skipping, error creating folder - '&quot; +</span>
<a href="#l6.3311"></a><span id="l6.3311">                                feed.folderName + &quot;' from outlineName - '&quot; +</span>
<a href="#l6.3312"></a><span id="l6.3312">                                outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l6.3313"></a><span id="l6.3313">                                aParentFolder.filePath.path);</span>
<a href="#l6.3314"></a><span id="l6.3314">             badTag = true;</span>
<a href="#l6.3315"></a><span id="l6.3315">             break;</span>
<a href="#l6.3316"></a><span id="l6.3316">           }</span>
<a href="#l6.3317"></a><span id="l6.3317"> </span>
<a href="#l6.3318"></a><span id="l6.3318">           // Add the feed to the databases.</span>
<a href="#l6.3319"></a><span id="l6.3319">           FeedUtils.addFeed(feed);</span>
<a href="#l6.3320"></a><span id="l6.3320">           // Feed correctly added.</span>
<a href="#l6.3321"></a><span id="l6.3321">           feedsAdded++;</span>
<a href="#l6.3322"></a><span id="l6.3322">           lastFolder = feed.folder;</span>
<a href="#l6.3323"></a><span id="l6.3323" class="difflineminus">-        }</span>
<a href="#l6.3324"></a><span id="l6.3324" class="difflineminus">-        else</span>
<a href="#l6.3325"></a><span id="l6.3325" class="difflineminus">-        {</span>
<a href="#l6.3326"></a><span id="l6.3326" class="difflineplus">+        } else {</span>
<a href="#l6.3327"></a><span id="l6.3327">           // A folder outline. If a folder exists in the account structure at</span>
<a href="#l6.3328"></a><span id="l6.3328">           // the same level as in the opml structure, feeds are placed into the</span>
<a href="#l6.3329"></a><span id="l6.3329">           // existing folder.</span>
<a href="#l6.3330"></a><span id="l6.3330">           let defaultName = FeedUtils.strings.GetStringFromName(&quot;ImportFeedsNew&quot;);</span>
<a href="#l6.3331"></a><span id="l6.3331">           let folderName = FeedUtils.getSanitizedFolderName(aParentFolder,</span>
<a href="#l6.3332"></a><span id="l6.3332">                                                             outlineName,</span>
<a href="#l6.3333"></a><span id="l6.3333">                                                             defaultName,</span>
<a href="#l6.3334"></a><span id="l6.3334">                                                             false);</span>
<a href="#l6.3335"></a><span id="l6.3335">           try {</span>
<a href="#l6.3336"></a><span id="l6.3336">             feedFolder = aParentFolder.getChildNamed(folderName);</span>
<a href="#l6.3337"></a><span id="l6.3337" class="difflineminus">-          }</span>
<a href="#l6.3338"></a><span id="l6.3338" class="difflineminus">-          catch (ex) {</span>
<a href="#l6.3339"></a><span id="l6.3339" class="difflineplus">+          } catch (ex) {</span>
<a href="#l6.3340"></a><span id="l6.3340">             // Folder not found, create it.</span>
<a href="#l6.3341"></a><span id="l6.3341">             FeedUtils.log.info(&quot;importOPMLOutlines: creating folder - '&quot; +</span>
<a href="#l6.3342"></a><span id="l6.3342">                                 folderName + &quot;' from outlineName - '&quot; +</span>
<a href="#l6.3343"></a><span id="l6.3343">                                 outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l6.3344"></a><span id="l6.3344">                                 aParentFolder.filePath.path);</span>
<a href="#l6.3345"></a><span id="l6.3345">             firstFeedInFolderQuickMode = null;</span>
<a href="#l6.3346"></a><span id="l6.3346">             try {</span>
<a href="#l6.3347"></a><span id="l6.3347">               feedFolder = aParentFolder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l6.3348"></a><span id="l6.3348">                                          createLocalSubfolder(folderName);</span>
<a href="#l6.3349"></a><span id="l6.3349" class="difflineminus">-              folderOutlines++;</span>
<a href="#l6.3350"></a><span id="l6.3350" class="difflineminus">-            }</span>
<a href="#l6.3351"></a><span id="l6.3351" class="difflineminus">-            catch (ex) {</span>
<a href="#l6.3352"></a><span id="l6.3352" class="difflineplus">+            } catch (ex) {</span>
<a href="#l6.3353"></a><span id="l6.3353">               // An error creating. Skip it.</span>
<a href="#l6.3354"></a><span id="l6.3354">               FeedUtils.log.info(&quot;importOPMLOutlines: skipping, error creating folder - '&quot; +</span>
<a href="#l6.3355"></a><span id="l6.3355">                                   folderName + &quot;' from outlineName - '&quot; +</span>
<a href="#l6.3356"></a><span id="l6.3356">                                   outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l6.3357"></a><span id="l6.3357">                                   aParentFolder.filePath.path);</span>
<a href="#l6.3358"></a><span id="l6.3358">               let xfolder = aParentFolder.getChildNamed(folderName);</span>
<a href="#l6.3359"></a><span id="l6.3359">               aParentFolder.propagateDelete(xfolder, true, null);</span>
<a href="#l6.3360"></a><span id="l6.3360">               badTag = true;</span>
<a href="#l6.3361"></a><span id="l6.3361">               break;</span>
<a href="#l6.3362"></a><span id="l6.3362">             }</span>
<a href="#l6.3363"></a><span id="l6.3363">           }</span>
<a href="#l6.3364"></a><span id="l6.3364">         }</span>
<a href="#l6.3365"></a><span id="l6.3365" class="difflineplus">+</span>
<a href="#l6.3366"></a><span id="l6.3366">         break;</span>
<a href="#l6.3367"></a><span id="l6.3367">       }</span>
<a href="#l6.3368"></a><span id="l6.3368"> </span>
<a href="#l6.3369"></a><span id="l6.3369" class="difflineminus">-      if (!outline.childElementCount || badTag)</span>
<a href="#l6.3370"></a><span id="l6.3370" class="difflineminus">-      {</span>
<a href="#l6.3371"></a><span id="l6.3371" class="difflineplus">+      if (!outline.childElementCount || badTag) {</span>
<a href="#l6.3372"></a><span id="l6.3372">         // Remove leaf nodes that are processed or bad tags from the opml dom,</span>
<a href="#l6.3373"></a><span id="l6.3373">         // and go back to reparse.  This method lets us use setTimeout to</span>
<a href="#l6.3374"></a><span id="l6.3374">         // prevent UI hang, in situations of both deep and shallow trees.</span>
<a href="#l6.3375"></a><span id="l6.3375">         // A yield/generator.next() method is fine for shallow trees, but not</span>
<a href="#l6.3376"></a><span id="l6.3376">         // the true recursion required for deeper trees; both the shallow loop</span>
<a href="#l6.3377"></a><span id="l6.3377">         // and the recurse should give it up.</span>
<a href="#l6.3378"></a><span id="l6.3378">         outline.remove();</span>
<a href="#l6.3379"></a><span id="l6.3379">         badTag = false;</span>
<a href="#l6.3380"></a><span id="l6.3380">         outline = aBody;</span>
<a href="#l6.3381"></a><span id="l6.3381">         feedFolder = rssServer.rootFolder;</span>
<a href="#l6.3382"></a><span id="l6.3382">       }</span>
<a href="#l6.3383"></a><span id="l6.3383"> </span>
<a href="#l6.3384"></a><span id="l6.3384" class="difflineminus">-      setTimeout(function() {</span>
<a href="#l6.3385"></a><span id="l6.3385" class="difflineplus">+      setTimeout(() =&gt; {</span>
<a href="#l6.3386"></a><span id="l6.3386">         processor(outline, feedFolder);</span>
<a href="#l6.3387"></a><span id="l6.3387">       }, 0);</span>
<a href="#l6.3388"></a><span id="l6.3388">     }</span>
<a href="#l6.3389"></a><span id="l6.3389"> </span>
<a href="#l6.3390"></a><span id="l6.3390">     processor(aBody, rssServer.rootFolder);</span>
<a href="#l6.3391"></a><span id="l6.3391">   },</span>
<a href="#l6.3392"></a><span id="l6.3392"> </span>
<a href="#l6.3393"></a><span id="l6.3393" class="difflineminus">-  importOPMLStatus: function(aFeedsAdded, aRssOutlines, aFolderOutlines)</span>
<a href="#l6.3394"></a><span id="l6.3394" class="difflineminus">-  {</span>
<a href="#l6.3395"></a><span id="l6.3395" class="difflineplus">+  importOPMLStatus(aFeedsAdded, aRssOutlines, aFolderOutlines) {</span>
<a href="#l6.3396"></a><span id="l6.3396">     let statusReport;</span>
<a href="#l6.3397"></a><span id="l6.3397" class="difflineminus">-    if (aRssOutlines &gt; aFeedsAdded)</span>
<a href="#l6.3398"></a><span id="l6.3398" class="difflineplus">+    if (aRssOutlines &gt; aFeedsAdded) {</span>
<a href="#l6.3399"></a><span id="l6.3399">       statusReport = FeedUtils.strings.formatStringFromName(&quot;subscribe-OPMLImportStatus&quot;,</span>
<a href="#l6.3400"></a><span id="l6.3400">         [PluralForm.get(aFeedsAdded,</span>
<a href="#l6.3401"></a><span id="l6.3401">                         FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportUniqueFeeds&quot;))</span>
<a href="#l6.3402"></a><span id="l6.3402">                    .replace(&quot;#1&quot;, aFeedsAdded),</span>
<a href="#l6.3403"></a><span id="l6.3403">          PluralForm.get(aRssOutlines,</span>
<a href="#l6.3404"></a><span id="l6.3404">                         FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFoundFeeds&quot;))</span>
<a href="#l6.3405"></a><span id="l6.3405">                    .replace(&quot;#1&quot;, aRssOutlines)], 2);</span>
<a href="#l6.3406"></a><span id="l6.3406" class="difflineminus">-    else</span>
<a href="#l6.3407"></a><span id="l6.3407" class="difflineplus">+    } else {</span>
<a href="#l6.3408"></a><span id="l6.3408">       statusReport = PluralForm.get(aFeedsAdded,</span>
<a href="#l6.3409"></a><span id="l6.3409">         FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFeedCount&quot;))</span>
<a href="#l6.3410"></a><span id="l6.3410">                          .replace(&quot;#1&quot;, aFeedsAdded);</span>
<a href="#l6.3411"></a><span id="l6.3411" class="difflineplus">+    }</span>
<a href="#l6.3412"></a><span id="l6.3412"> </span>
<a href="#l6.3413"></a><span id="l6.3413">     return statusReport;</span>
<a href="#l6.3414"></a><span id="l6.3414">   },</span>
<a href="#l6.3415"></a><span id="l6.3415"> </span>
<a href="#l6.3416"></a><span id="l6.3416" class="difflineminus">-  importOPMLFinished: function(aStatusReport, aLastFolder, aWin)</span>
<a href="#l6.3417"></a><span id="l6.3417" class="difflineminus">-  {</span>
<a href="#l6.3418"></a><span id="l6.3418" class="difflineminus">-    if (aLastFolder)</span>
<a href="#l6.3419"></a><span id="l6.3419" class="difflineminus">-    {</span>
<a href="#l6.3420"></a><span id="l6.3420" class="difflineplus">+  importOPMLFinished(aStatusReport, aLastFolder, aWin) {</span>
<a href="#l6.3421"></a><span id="l6.3421" class="difflineplus">+    if (aLastFolder) {</span>
<a href="#l6.3422"></a><span id="l6.3422">       aWin.selectFolder(aLastFolder, { select: false, newFolder: aLastFolder });</span>
<a href="#l6.3423"></a><span id="l6.3423">       aWin.selectFolder(aLastFolder.parent);</span>
<a href="#l6.3424"></a><span id="l6.3424">     }</span>
<a href="#l6.3425"></a><span id="l6.3425">     aWin.mActionMode = null;</span>
<a href="#l6.3426"></a><span id="l6.3426">     aWin.updateButtons(aWin.mView.currentItem);</span>
<a href="#l6.3427"></a><span id="l6.3427">     aWin.clearStatusInfo();</span>
<a href="#l6.3428"></a><span id="l6.3428">     aWin.updateStatusItem(&quot;statusText&quot;, aStatusReport);</span>
<a href="#l6.3429"></a><span id="l6.3429" class="difflineminus">-  }</span>
<a href="#l6.3430"></a><span id="l6.3430" class="difflineplus">+  },</span>
<a href="#l6.3431"></a><span id="l6.3431"> </span>
<a href="#l6.3432"></a><span id="l6.3432"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feedAccountWizard.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feedAccountWizard.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -4,42 +4,42 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> ChromeUtils.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> /* Feed account standalone wizard functions */</span>
<a href="#l7.9"></a><span id="l7.9"> var FeedAccountWizard = {</span>
<a href="#l7.10"></a><span id="l7.10">   accountName: &quot;&quot;,</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  accountSetupPageInit: function() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  accountSetupPageInit() {</span>
<a href="#l7.14"></a><span id="l7.14">     this.accountSetupPageValidate();</span>
<a href="#l7.15"></a><span id="l7.15">   },</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  accountSetupPageValidate: function() {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  accountSetupPageValidate() {</span>
<a href="#l7.19"></a><span id="l7.19">     this.accountName = document.getElementById(&quot;prettyName&quot;).value.trim();</span>
<a href="#l7.20"></a><span id="l7.20">     document.documentElement.canAdvance = this.accountName;</span>
<a href="#l7.21"></a><span id="l7.21">   },</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  accountSetupPageUnload: function() {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-    return;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  accountSetupPageUnload() {</span>
<a href="#l7.26"></a><span id="l7.26">   },</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  donePageInit: function() {</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  donePageInit() {</span>
<a href="#l7.30"></a><span id="l7.30">     document.getElementById(&quot;account.name.text&quot;).value = this.accountName;</span>
<a href="#l7.31"></a><span id="l7.31">   },</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  onCancel: function() {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  onCancel() {</span>
<a href="#l7.35"></a><span id="l7.35">     return true;</span>
<a href="#l7.36"></a><span id="l7.36">   },</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  onFinish: function() {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  onFinish() {</span>
<a href="#l7.40"></a><span id="l7.40">     let account = FeedUtils.createRssAccount(this.accountName);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-    if (&quot;gFolderTreeView&quot; in window.opener.top)</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    if (&quot;gFolderTreeView&quot; in window.opener.top) {</span>
<a href="#l7.43"></a><span id="l7.43">       // Opened from 3pane File-&gt;New or Appmenu New Message, or</span>
<a href="#l7.44"></a><span id="l7.44">       // Account Central link.</span>
<a href="#l7.45"></a><span id="l7.45">       window.opener.top.gFolderTreeView.selectFolder(account.incomingServer.rootMsgFolder);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    else if (&quot;selectServer&quot; in window.opener)</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    } else if (&quot;selectServer&quot; in window.opener) {</span>
<a href="#l7.48"></a><span id="l7.48">       // Opened from Account Settings.</span>
<a href="#l7.49"></a><span id="l7.49">       window.opener.selectServer(account.incomingServer);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    }</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">     window.close();</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  }</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-}</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  },</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -34,17 +34,17 @@ var FeedMessageHandler = {</span>
<a href="#l8.4"></a><span id="l8.4">     Services.prefs.setIntPref(&quot;rss.show.summary&quot;, val);</span>
<a href="#l8.5"></a><span id="l8.5">     ReloadMessage();</span>
<a href="#l8.6"></a><span id="l8.6">   },</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   /**</span>
<a href="#l8.9"></a><span id="l8.9">    * Load web page on threadpane select.</span>
<a href="#l8.10"></a><span id="l8.10">    */</span>
<a href="#l8.11"></a><span id="l8.11">   get loadWebPageOnSelectPref() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    return Services.prefs.getIntPref(&quot;rss.message.loadWebPageOnSelect&quot;) ? true : false;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    return Services.prefs.getIntPref(&quot;rss.message.loadWebPageOnSelect&quot;);</span>
<a href="#l8.14"></a><span id="l8.14">   },</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   /**</span>
<a href="#l8.17"></a><span id="l8.17">    * How to load message on open (enter/dbl click in threadpane, contextmenu).</span>
<a href="#l8.18"></a><span id="l8.18">    */</span>
<a href="#l8.19"></a><span id="l8.19">   get onOpenPref() {</span>
<a href="#l8.20"></a><span id="l8.20">     return Services.prefs.getIntPref(&quot;rss.show.content-base&quot;);</span>
<a href="#l8.21"></a><span id="l8.21">   },</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -53,109 +53,114 @@ var FeedMessageHandler = {</span>
<a href="#l8.23"></a><span id="l8.23">     Services.prefs.setIntPref(&quot;rss.show.content-base&quot;, val);</span>
<a href="#l8.24"></a><span id="l8.24">   },</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   /**</span>
<a href="#l8.27"></a><span id="l8.27">    * Determine if a message is a feed message. Prior to Tb15, a message had to</span>
<a href="#l8.28"></a><span id="l8.28">    * be in an rss acount type folder. In Tb15 and later, a flag is set on the</span>
<a href="#l8.29"></a><span id="l8.29">    * message itself upon initial store; the message can be moved to any folder.</span>
<a href="#l8.30"></a><span id="l8.30">    *</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-   * @param nsIMsgDBHdr aMsgHdr - the message.</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+   * @param {nsIMsgDBHdr} aMsgHdr - The message.</span>
<a href="#l8.33"></a><span id="l8.33">    *</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-   * @return true if message is a feed, false if not.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+   * @returns {Boolean} - true if message is a feed, false if not.</span>
<a href="#l8.36"></a><span id="l8.36">    */</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  isFeedMessage: function(aMsgHdr) {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  isFeedMessage(aMsgHdr) {</span>
<a href="#l8.39"></a><span id="l8.39">     return Boolean(aMsgHdr instanceof Ci.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l8.40"></a><span id="l8.40">                    (aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.FeedMsg ||</span>
<a href="#l8.41"></a><span id="l8.41">                     this.isFeedFolder(aMsgHdr.folder)));</span>
<a href="#l8.42"></a><span id="l8.42">   },</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">   /**</span>
<a href="#l8.45"></a><span id="l8.45">    * Determine if a folder is a feed acount folder. Trash or a folder in Trash</span>
<a href="#l8.46"></a><span id="l8.46">    * should be checked with FeedUtils.isInTrash() if required.</span>
<a href="#l8.47"></a><span id="l8.47">    *</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-   * @param nsIMsgFolder aFolder - the folder.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - The folder.</span>
<a href="#l8.50"></a><span id="l8.50">    *</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-   * @return true if folder's server.type is in FeedAccountTypes, false if not.</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+   * @returns {Boolean} - true if folder's server.type is in FeedAccountTypes,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+   *                      false if not.</span>
<a href="#l8.54"></a><span id="l8.54">    */</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  isFeedFolder: function(aFolder) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  isFeedFolder(aFolder) {</span>
<a href="#l8.57"></a><span id="l8.57">     return Boolean(aFolder instanceof Ci.nsIMsgFolder &amp;&amp;</span>
<a href="#l8.58"></a><span id="l8.58">                    this.FeedAccountTypes.includes(aFolder.server.type));</span>
<a href="#l8.59"></a><span id="l8.59">   },</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">   /**</span>
<a href="#l8.62"></a><span id="l8.62">    * Determine whether to show a feed message summary or load a web page in the</span>
<a href="#l8.63"></a><span id="l8.63">    * message pane.</span>
<a href="#l8.64"></a><span id="l8.64">    *</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-   * @param nsIMsgDBHdr aMsgHdr - the message.</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-   * @param bool aToggle        - true if in toggle mode, false otherwise.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+   * @param {nsIMsgDBHdr} aMsgHdr - The message.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   * @param {Boolean} aToggle     - true if in toggle mode, false otherwise.</span>
<a href="#l8.69"></a><span id="l8.69">    *</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-   * @return true if summary is to be displayed, false if web page.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+   * @returns {Boolean} - true if summary is to be displayed, false if web page.</span>
<a href="#l8.72"></a><span id="l8.72">    */</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  shouldShowSummary: function(aMsgHdr, aToggle) {</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  shouldShowSummary(aMsgHdr, aToggle) {</span>
<a href="#l8.75"></a><span id="l8.75">     // Not a feed message, always show summary (the message).</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    if (!this.isFeedMessage(aMsgHdr))</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    if (!this.isFeedMessage(aMsgHdr)) {</span>
<a href="#l8.78"></a><span id="l8.78">       return true;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    }</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">     // Notified of a summary reload when toggling, reset toggle and return.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-    if (!aToggle &amp;&amp; this.gToggle)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    if (!aToggle &amp;&amp; this.gToggle) {</span>
<a href="#l8.84"></a><span id="l8.84">       return !(this.gToggle = false);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    }</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87">     let showSummary = true;</span>
<a href="#l8.88"></a><span id="l8.88">     this.gToggle = aToggle;</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">     // Thunderbird 2 rss messages with 'Show article summary' not selected,</span>
<a href="#l8.91"></a><span id="l8.91">     // ie message body constructed to show web page in an iframe, can't show</span>
<a href="#l8.92"></a><span id="l8.92">     // a summary - notify user.</span>
<a href="#l8.93"></a><span id="l8.93">     let browser = getBrowser();</span>
<a href="#l8.94"></a><span id="l8.94">     let contentDoc = browser ? browser.contentDocument : null;</span>
<a href="#l8.95"></a><span id="l8.95">     let rssIframe = contentDoc ? contentDoc.getElementById(&quot;_mailrssiframe&quot;) : null;</span>
<a href="#l8.96"></a><span id="l8.96">     if (rssIframe) {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-      if (this.gToggle || this.onSelectPref == this.kSelectOverrideSummary)</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+      if (this.gToggle || this.onSelectPref == this.kSelectOverrideSummary) {</span>
<a href="#l8.99"></a><span id="l8.99">         this.gToggle = false;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+      }</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102">       return false;</span>
<a href="#l8.103"></a><span id="l8.103">     }</span>
<a href="#l8.104"></a><span id="l8.104"> </span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    if (aToggle)</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    if (aToggle) {</span>
<a href="#l8.107"></a><span id="l8.107">       // Toggle mode, flip value.</span>
<a href="#l8.108"></a><span id="l8.108">       return gShowFeedSummary = this.gShowSummary = !this.gShowSummary;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    }</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">     let wintype = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l8.112"></a><span id="l8.112">     let tabMail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.113"></a><span id="l8.113">     let messageTab = tabMail &amp;&amp; tabMail.currentTabInfo.mode.type == &quot;message&quot;;</span>
<a href="#l8.114"></a><span id="l8.114">     let messageWindow = wintype == &quot;mail:messageWindow&quot;;</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116">     switch (this.onSelectPref) {</span>
<a href="#l8.117"></a><span id="l8.117">       case this.kSelectOverrideWebPage:</span>
<a href="#l8.118"></a><span id="l8.118">         showSummary = false;</span>
<a href="#l8.119"></a><span id="l8.119">         break;</span>
<a href="#l8.120"></a><span id="l8.120">       case this.kSelectOverrideSummary:</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-        showSummary = true</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+        showSummary = true;</span>
<a href="#l8.123"></a><span id="l8.123">         break;</span>
<a href="#l8.124"></a><span id="l8.124">       case this.kSelectFeedDefault:</span>
<a href="#l8.125"></a><span id="l8.125">         // Get quickmode per feed folder pref from feeds.rdf. If the feed</span>
<a href="#l8.126"></a><span id="l8.126">         // message is not in a feed account folder (hence the folder is not in</span>
<a href="#l8.127"></a><span id="l8.127">         // the feeds database), or FZ_QUICKMODE property is not found (possible</span>
<a href="#l8.128"></a><span id="l8.128">         // in pre renovation urls), err on the side of showing the summary.</span>
<a href="#l8.129"></a><span id="l8.129">         // For the former, toggle or global override is necessary; for the</span>
<a href="#l8.130"></a><span id="l8.130">         // latter, a show summary checkbox toggle in Subscribe dialog will set</span>
<a href="#l8.131"></a><span id="l8.131">         // one on the path to bliss.</span>
<a href="#l8.132"></a><span id="l8.132">         let folder = aMsgHdr.folder, targetRes;</span>
<a href="#l8.133"></a><span id="l8.133">         try {</span>
<a href="#l8.134"></a><span id="l8.134">           targetRes = FeedUtils.getParentTargetForChildResource(</span>
<a href="#l8.135"></a><span id="l8.135">                         folder.URI, FeedUtils.FZ_QUICKMODE, folder.server);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-        }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-        catch (ex) {</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+        } catch (ex) {</span>
<a href="#l8.139"></a><span id="l8.139">           // Not in a feed account folder or other error.</span>
<a href="#l8.140"></a><span id="l8.140">           FeedUtils.log.info(&quot;FeedMessageHandler.shouldShowSummary: could not &quot; +</span>
<a href="#l8.141"></a><span id="l8.141">                              &quot;get summary pref for this folder&quot;);</span>
<a href="#l8.142"></a><span id="l8.142">         }</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144">         showSummary = targetRes &amp;&amp; targetRes.QueryInterface(Ci.nsIRDFLiteral).</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-                                             Value == &quot;false&quot; ? false : true;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+                                             Value == &quot;false&quot;;</span>
<a href="#l8.147"></a><span id="l8.147">         break;</span>
<a href="#l8.148"></a><span id="l8.148">     }</span>
<a href="#l8.149"></a><span id="l8.149"> </span>
<a href="#l8.150"></a><span id="l8.150">     gShowFeedSummary = this.gShowSummary = showSummary;</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152">     if (messageWindow || messageTab) {</span>
<a href="#l8.153"></a><span id="l8.153">       // Message opened in either standalone window or tab, due to either</span>
<a href="#l8.154"></a><span id="l8.154">       // message open pref (we are here only if the pref is 0 or 1) or</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineat">@@ -171,148 +176,143 @@ var FeedMessageHandler = {</span>
<a href="#l8.156"></a><span id="l8.156">         case this.kOpenSummary:</span>
<a href="#l8.157"></a><span id="l8.157">           showSummary = true;</span>
<a href="#l8.158"></a><span id="l8.158">           break;</span>
<a href="#l8.159"></a><span id="l8.159">       }</span>
<a href="#l8.160"></a><span id="l8.160">     }</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162">     // Auto load web page in browser on select, per pref; shouldShowSummary() is</span>
<a href="#l8.163"></a><span id="l8.163">     // always called first to 1)test if feed, 2)get summary pref, so do it here.</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-    if (this.loadWebPageOnSelectPref)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-      setTimeout(FeedMessageHandler.loadWebPage, 20, aMsgHdr, {browser:true});</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+    if (this.loadWebPageOnSelectPref) {</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+      setTimeout(FeedMessageHandler.loadWebPage, 20, aMsgHdr, {browser: true});</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    }</span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170">     return showSummary;</span>
<a href="#l8.171"></a><span id="l8.171">   },</span>
<a href="#l8.172"></a><span id="l8.172"> </span>
<a href="#l8.173"></a><span id="l8.173">   /**</span>
<a href="#l8.174"></a><span id="l8.174">    * Load a web page for feed messages. Use MsgHdrToMimeMessage() to get</span>
<a href="#l8.175"></a><span id="l8.175">    * the content-base url from the message headers. We cannot rely on</span>
<a href="#l8.176"></a><span id="l8.176">    * currentHeaderData; it has not yet been streamed at our entry point in</span>
<a href="#l8.177"></a><span id="l8.177">    * displayMessageChanged(), and in the case of a collapsed message pane it</span>
<a href="#l8.178"></a><span id="l8.178">    * is not streamed.</span>
<a href="#l8.179"></a><span id="l8.179">    *</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-   * @param nsIMsgDBHdr aMessageHdr - the message.</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-   * @param {obj} aWhere            - name value=true pair, where name is in:</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-   *                                  'messagepane', 'browser', 'tab', 'window'.</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+   * @param {nsIMsgDBHdr} aMessageHdr - The message.</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+   * @param {Object} aWhere           - name value=true pair, where name is in:</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+   *                                    'messagepane', 'browser', 'tab', 'window'.</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+   * @returns {void}</span>
<a href="#l8.187"></a><span id="l8.187">    */</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-  loadWebPage: function(aMessageHdr, aWhere) {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+  loadWebPage(aMessageHdr, aWhere) {</span>
<a href="#l8.190"></a><span id="l8.190">     MsgHdrToMimeMessage(aMessageHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l8.191"></a><span id="l8.191">       if (aMimeMsg &amp;&amp; aMimeMsg.headers[&quot;content-base&quot;] &amp;&amp;</span>
<a href="#l8.192"></a><span id="l8.192">           aMimeMsg.headers[&quot;content-base&quot;][0]) {</span>
<a href="#l8.193"></a><span id="l8.193">         let url = aMimeMsg.headers[&quot;content-base&quot;], uri;</span>
<a href="#l8.194"></a><span id="l8.194">         try {</span>
<a href="#l8.195"></a><span id="l8.195">           // The message and headers are stored as a string of UTF-8 bytes</span>
<a href="#l8.196"></a><span id="l8.196">           // and we need to convert that cpp |string| to js UTF-16 explicitly</span>
<a href="#l8.197"></a><span id="l8.197">           // for idn and non-ascii urls with this api.</span>
<a href="#l8.198"></a><span id="l8.198">           url = decodeURIComponent(escape(url));</span>
<a href="#l8.199"></a><span id="l8.199">           uri = Services.io.newURI(url);</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-        }</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-        catch (ex) {</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+        } catch (ex) {</span>
<a href="#l8.203"></a><span id="l8.203">           FeedUtils.log.info(&quot;FeedMessageHandler.loadWebPage: &quot; +</span>
<a href="#l8.204"></a><span id="l8.204">                              &quot;invalid Content-Base header url - &quot; + url);</span>
<a href="#l8.205"></a><span id="l8.205">           return;</span>
<a href="#l8.206"></a><span id="l8.206">         }</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-        if (aWhere.browser)</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+        if (aWhere.browser) {</span>
<a href="#l8.209"></a><span id="l8.209">           Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l8.210"></a><span id="l8.210">             .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l8.211"></a><span id="l8.211">             .loadURI(uri);</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-        else if (aWhere.messagepane) {</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+        } else if (aWhere.messagepane) {</span>
<a href="#l8.214"></a><span id="l8.214">           let loadFlag = getBrowser().webNavigation.LOAD_FLAGS_NONE;</span>
<a href="#l8.215"></a><span id="l8.215">           getBrowser().webNavigation.loadURI(url, loadFlag, null, null, null);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-        }</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-        else if (aWhere.tab)</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+        } else if (aWhere.tab) {</span>
<a href="#l8.219"></a><span id="l8.219">           openContentTab(url, &quot;tab&quot;, &quot;^&quot;);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        else if (aWhere.window)</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+        } else if (aWhere.window) {</span>
<a href="#l8.222"></a><span id="l8.222">           openContentTab(url, &quot;window&quot;, &quot;^&quot;);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-      }</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-      else</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+        }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+      } else {</span>
<a href="#l8.227"></a><span id="l8.227">         FeedUtils.log.info(&quot;FeedMessageHandler.loadWebPage: could not get &quot; +</span>
<a href="#l8.228"></a><span id="l8.228">                            &quot;Content-Base header url for this message&quot;);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+      }</span>
<a href="#l8.230"></a><span id="l8.230">     });</span>
<a href="#l8.231"></a><span id="l8.231">   },</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233">   /**</span>
<a href="#l8.234"></a><span id="l8.234">    * Display summary or load web page for feed messages. Caller should already</span>
<a href="#l8.235"></a><span id="l8.235">    * know if the message is a feed message.</span>
<a href="#l8.236"></a><span id="l8.236">    *</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-   * @param nsIMsgDBHdr aMsgHdr - the message.</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-   * @param bool aShowSummary   - true if summary is to be displayed, false if</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-   *                              web page.</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+   * @param {nsIMsgDBHdr} aMsgHdr  - The message.</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+   * @param {Boolean} aShowSummary - true if summary is to be displayed,</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+   *                                 false if web page.</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+   * @returns {void}</span>
<a href="#l8.244"></a><span id="l8.244">    */</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-  setContent: function(aMsgHdr, aShowSummary) {</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+  setContent(aMsgHdr, aShowSummary) {</span>
<a href="#l8.247"></a><span id="l8.247">     if (aShowSummary) {</span>
<a href="#l8.248"></a><span id="l8.248">       // Only here if toggling to summary in 3pane.</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-      if (this.gToggle &amp;&amp; gDBView &amp;&amp; GetNumSelectedMessages() == 1)</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      if (this.gToggle &amp;&amp; gDBView &amp;&amp; GetNumSelectedMessages() == 1) {</span>
<a href="#l8.251"></a><span id="l8.251">         ReloadMessage();</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-    }</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-    else {</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    } else {</span>
<a href="#l8.256"></a><span id="l8.256">       let browser = getBrowser();</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-      if (browser &amp;&amp; browser.contentDocument &amp;&amp; browser.contentDocument.body)</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      if (browser &amp;&amp; browser.contentDocument &amp;&amp; browser.contentDocument.body) {</span>
<a href="#l8.259"></a><span id="l8.259">         browser.contentDocument.body.hidden = true;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      }</span>
<a href="#l8.261"></a><span id="l8.261">       // If in a non rss folder, hide possible remote content bar on a web</span>
<a href="#l8.262"></a><span id="l8.262">       // page load, as it doesn't apply.</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-      if (&quot;msgNotificationBar&quot; in window)</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+      if (&quot;msgNotificationBar&quot; in window) {</span>
<a href="#l8.265"></a><span id="l8.265">         gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      }</span>
<a href="#l8.267"></a><span id="l8.267"> </span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-      this.loadWebPage(aMsgHdr, {messagepane:true});</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+      this.loadWebPage(aMsgHdr, {messagepane: true});</span>
<a href="#l8.270"></a><span id="l8.270">       this.gToggle = false;</span>
<a href="#l8.271"></a><span id="l8.271">     }</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-  }</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-}</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  },</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+};</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-function openSubscriptionsDialog(aFolder)</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-{</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+function openSubscriptionsDialog(aFolder) {</span>
<a href="#l8.280"></a><span id="l8.280">   // Check for an existing feed subscriptions window and focus it.</span>
<a href="#l8.281"></a><span id="l8.281">   let subscriptionsWindow =</span>
<a href="#l8.282"></a><span id="l8.282">     Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l8.283"></a><span id="l8.283"> </span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-  if (subscriptionsWindow)</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-  {</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-    if (aFolder)</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-    {</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+  if (subscriptionsWindow) {</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+    if (aFolder) {</span>
<a href="#l8.290"></a><span id="l8.290">       subscriptionsWindow.FeedSubscriptions.selectFolder(aFolder);</span>
<a href="#l8.291"></a><span id="l8.291">       subscriptionsWindow.FeedSubscriptions.mView.treeBox.ensureRowIsVisible(</span>
<a href="#l8.292"></a><span id="l8.292">         subscriptionsWindow.FeedSubscriptions.mView.selection.currentIndex);</span>
<a href="#l8.293"></a><span id="l8.293">     }</span>
<a href="#l8.294"></a><span id="l8.294"> </span>
<a href="#l8.295"></a><span id="l8.295">     subscriptionsWindow.focus();</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-  }</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-  else</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-  {</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  } else {</span>
<a href="#l8.300"></a><span id="l8.300">     window.openDialog(&quot;chrome://messenger-newsblog/content/feed-subscriptions.xul&quot;,</span>
<a href="#l8.301"></a><span id="l8.301">                       &quot;&quot;, &quot;centerscreen,chrome,dialog=no,resizable&quot;,</span>
<a href="#l8.302"></a><span id="l8.302">                       { folder: aFolder});</span>
<a href="#l8.303"></a><span id="l8.303">   }</span>
<a href="#l8.304"></a><span id="l8.304"> }</span>
<a href="#l8.305"></a><span id="l8.305"> </span>
<a href="#l8.306"></a><span id="l8.306"> // Special case attempts to reply/forward/edit as new RSS articles. For</span>
<a href="#l8.307"></a><span id="l8.307"> // messages stored prior to Tb15, we are here only if the message's folder's</span>
<a href="#l8.308"></a><span id="l8.308"> // account server is rss and feed messages moved to other types will have their</span>
<a href="#l8.309"></a><span id="l8.309"> // summaries loaded, as viewing web pages only happened in an rss account.</span>
<a href="#l8.310"></a><span id="l8.310"> // The user may choose whether to load a summary or web page link by ensuring</span>
<a href="#l8.311"></a><span id="l8.311"> // the current feed message is being viewed as either a summary or web page.</span>
<a href="#l8.312"></a><span id="l8.312"> function openComposeWindowForRSSArticle(aMsgComposeWindow, aMsgHdr, aMessageUri,</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-                                        aType, aFormat, aIdentity, aMsgWindow)</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-{</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+                                        aType, aFormat, aIdentity, aMsgWindow) {</span>
<a href="#l8.316"></a><span id="l8.316">   // Ensure right content is handled for web pages in window/tab.</span>
<a href="#l8.317"></a><span id="l8.317">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.318"></a><span id="l8.318">   let is3pane = tabmail &amp;&amp; tabmail.selectedTab &amp;&amp; tabmail.selectedTab.mode ?</span>
<a href="#l8.319"></a><span id="l8.319">                   tabmail.selectedTab.mode.type == &quot;folder&quot; : false;</span>
<a href="#l8.320"></a><span id="l8.320">   let showingwebpage = (&quot;FeedMessageHandler&quot; in window) &amp;&amp; !is3pane &amp;&amp;</span>
<a href="#l8.321"></a><span id="l8.321">                        FeedMessageHandler.onOpenPref == FeedMessageHandler.kOpenWebPage;</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-  if (gShowFeedSummary &amp;&amp; !showingwebpage)</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-  {</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+  if (gShowFeedSummary &amp;&amp; !showingwebpage) {</span>
<a href="#l8.326"></a><span id="l8.326">     // The user is viewing the summary.</span>
<a href="#l8.327"></a><span id="l8.327">     MailServices.compose.OpenComposeWindow(aMsgComposeWindow, aMsgHdr, aMessageUri,</span>
<a href="#l8.328"></a><span id="l8.328">                                            aType, aFormat, aIdentity, aMsgWindow);</span>
<a href="#l8.329"></a><span id="l8.329"> </span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-  }</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-  else</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-  {</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+  } else {</span>
<a href="#l8.334"></a><span id="l8.334">     // Set up the compose message and get the feed message's web page link.</span>
<a href="#l8.335"></a><span id="l8.335">     let msgHdr = aMsgHdr;</span>
<a href="#l8.336"></a><span id="l8.336">     let type = aType;</span>
<a href="#l8.337"></a><span id="l8.337">     let msgComposeType = Ci.nsIMsgCompType;</span>
<a href="#l8.338"></a><span id="l8.338">     let subject = msgHdr.mime2DecodedSubject;</span>
<a href="#l8.339"></a><span id="l8.339">     let fwdPrefix = Services.prefs.getCharPref(&quot;mail.forward_subject_prefix&quot;);</span>
<a href="#l8.340"></a><span id="l8.340">     fwdPrefix = fwdPrefix ? fwdPrefix + &quot;: &quot; : &quot;&quot;;</span>
<a href="#l8.341"></a><span id="l8.341"> </span>
<a href="#l8.342"></a><span id="l8.342" class="difflineat">@@ -321,52 +321,45 @@ function openComposeWindowForRSSArticle(</span>
<a href="#l8.343"></a><span id="l8.343"> </span>
<a href="#l8.344"></a><span id="l8.344">     let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l8.345"></a><span id="l8.345">                           .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l8.346"></a><span id="l8.346"> </span>
<a href="#l8.347"></a><span id="l8.347">     if (type == msgComposeType.Reply ||</span>
<a href="#l8.348"></a><span id="l8.348">         type == msgComposeType.ReplyAll ||</span>
<a href="#l8.349"></a><span id="l8.349">         type == msgComposeType.ReplyToSender ||</span>
<a href="#l8.350"></a><span id="l8.350">         type == msgComposeType.ReplyToGroup ||</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-        type == msgComposeType.ReplyToSenderAndGroup)</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-    {</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+        type == msgComposeType.ReplyToSenderAndGroup) {</span>
<a href="#l8.354"></a><span id="l8.354">       subject = &quot;Re: &quot; + subject;</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-    }</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-    else if (type == msgComposeType.ForwardInline ||</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-             type == msgComposeType.ForwardAsAttachment)</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-    {</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+    } else if (type == msgComposeType.ForwardInline ||</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+               type == msgComposeType.ForwardAsAttachment) {</span>
<a href="#l8.361"></a><span id="l8.361">       subject = fwdPrefix + subject;</span>
<a href="#l8.362"></a><span id="l8.362">     }</span>
<a href="#l8.363"></a><span id="l8.363"> </span>
<a href="#l8.364"></a><span id="l8.364">     params.composeFields = composeFields;</span>
<a href="#l8.365"></a><span id="l8.365">     params.composeFields.subject = subject;</span>
<a href="#l8.366"></a><span id="l8.366">     params.composeFields.characterSet = msgHdr.Charset;</span>
<a href="#l8.367"></a><span id="l8.367">     params.composeFields.body = &quot;&quot;;</span>
<a href="#l8.368"></a><span id="l8.368">     params.bodyIsLink = false;</span>
<a href="#l8.369"></a><span id="l8.369">     params.identity = aIdentity;</span>
<a href="#l8.370"></a><span id="l8.370"> </span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    try</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-    {</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+    try {</span>
<a href="#l8.374"></a><span id="l8.374">       // The feed's web page url is stored in the Content-Base header.</span>
<a href="#l8.375"></a><span id="l8.375">       MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l8.376"></a><span id="l8.376">         if (aMimeMsg &amp;&amp; aMimeMsg.headers[&quot;content-base&quot;] &amp;&amp;</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-            aMimeMsg.headers[&quot;content-base&quot;][0])</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-        {</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+            aMimeMsg.headers[&quot;content-base&quot;][0]) {</span>
<a href="#l8.380"></a><span id="l8.380">           let url = decodeURIComponent(escape(aMimeMsg.headers[&quot;content-base&quot;]));</span>
<a href="#l8.381"></a><span id="l8.381">           params.composeFields.body = url;</span>
<a href="#l8.382"></a><span id="l8.382">           params.bodyIsLink = true;</span>
<a href="#l8.383"></a><span id="l8.383">           MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-        }</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-        else</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+        } else {</span>
<a href="#l8.387"></a><span id="l8.387">           // No content-base url, use the summary.</span>
<a href="#l8.388"></a><span id="l8.388">           MailServices.compose.OpenComposeWindow(aMsgComposeWindow, aMsgHdr, aMessageUri,</span>
<a href="#l8.389"></a><span id="l8.389">                                                  aType, aFormat, aIdentity, aMsgWindow);</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+        }</span>
<a href="#l8.391"></a><span id="l8.391"> </span>
<a href="#l8.392"></a><span id="l8.392">       }, false, {saneBodySize: true});</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-    }</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-    catch (ex)</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-    {</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+    } catch (ex) {</span>
<a href="#l8.397"></a><span id="l8.397">       // Error getting header, use the summary.</span>
<a href="#l8.398"></a><span id="l8.398">       MailServices.compose.OpenComposeWindow(aMsgComposeWindow, aMsgHdr, aMessageUri,</span>
<a href="#l8.399"></a><span id="l8.399">                                              aType, aFormat, aIdentity, aMsgWindow);</span>
<a href="#l8.400"></a><span id="l8.400">     }</span>
<a href="#l8.401"></a><span id="l8.401">   }</span>
<a href="#l8.402"></a><span id="l8.402"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,23 +3,23 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.5"></a><span id="l9.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> ChromeUtils.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> function FeedDownloader() { }</span>
<a href="#l9.11"></a><span id="l9.11"> FeedDownloader.prototype = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  downloadFeed: function(aFolder, aUrlListener, aIsBiff, aMsgWindow) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  downloadFeed(aFolder, aUrlListener, aIsBiff, aMsgWindow) {</span>
<a href="#l9.14"></a><span id="l9.14">     FeedUtils.downloadFeed(aFolder, aUrlListener, aIsBiff, aMsgWindow);</span>
<a href="#l9.15"></a><span id="l9.15">   },</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-  subscribeToFeed: function(aUrl, aFolder, aMsgWindow) {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  subscribeToFeed(aUrl, aFolder, aMsgWindow) {</span>
<a href="#l9.18"></a><span id="l9.18">     FeedUtils.subscribeToFeed(aUrl, aFolder, aMsgWindow);</span>
<a href="#l9.19"></a><span id="l9.19">   },</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-  updateSubscriptionsDS: function(aFolder, aOrigFolder, aAction) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  updateSubscriptionsDS(aFolder, aOrigFolder, aAction) {</span>
<a href="#l9.22"></a><span id="l9.22">     FeedUtils.updateSubscriptionsDS(aFolder, aOrigFolder, aAction);</span>
<a href="#l9.23"></a><span id="l9.23">   },</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   classID: Components.ID(&quot;{5c124537-adca-4456-b2b5-641ab687d1f6}&quot;),</span>
<a href="#l9.26"></a><span id="l9.26">   QueryInterface: ChromeUtils.generateQI([Ci.nsINewsBlogFeedDownloader]),</span>
<a href="#l9.27"></a><span id="l9.27"> };</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> function FeedAcctMgrExtension() { }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

