<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29179:588fc64ebcb0946ba09005e4de0bea4019a27392</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 588fc64ebcb0946ba09005e4de0bea4019a27392" />
<meta property="og:url" content="/comm-central/rev/588fc64ebcb0946ba09005e4de0bea4019a27392" />
<meta property="og:description" content="Bug 1612239 - Remove nsIArray usage in nsIMsgAccount. r=mkmelin,pmorris DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 588fc64ebcb0946ba09005e4de0bea4019a27392 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/588fc64ebcb0946ba09005e4de0bea4019a27392">shortlog</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/588fc64ebcb0946ba09005e4de0bea4019a27392">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392">files</a> |
changeset |
<a href="/comm-central/raw-rev/588fc64ebcb0946ba09005e4de0bea4019a27392">raw</a>  | <a href="/comm-central/archive/588fc64ebcb0946ba09005e4de0bea4019a27392.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray usage in nsIMsgAccount. r=mkmelin,pmorris DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 04 Apr 2020 13:54:36 +0300</td></tr>

<tr>
 <td>changeset 29179</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/588fc64ebcb0946ba09005e4de0bea4019a27392">588fc64ebcb0946ba09005e4de0bea4019a27392</a></td>
</tr>



<tr>
<td>parent 29178</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/05ffac8e4aa4de742c1d3cf386df3e701a4dc7ac">05ffac8e4aa4de742c1d3cf386df3e701a4dc7ac</a>
</td>
</tr>

<tr>
<td>child 29180</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f511a27de53a2c36c9fcb7b0f6488a277ee18b6f">f511a27de53a2c36c9fcb7b0f6488a277ee18b6f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=588fc64ebcb0946ba09005e4de0bea4019a27392">17237</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sat, 04 Apr 2020 10:56:01 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@588fc64ebcb0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=588fc64ebcb0946ba09005e4de0bea4019a27392">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=588fc64ebcb0946ba09005e4de0bea4019a27392&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&newProject=comm-central&newRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&newProject=comm-central&newRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&newProject=comm-central&newRevision=588fc64ebcb0946ba09005e4de0bea4019a27392&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28pmorris%29&revcount=50">pmorris</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">1612239</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray usage in nsIMsgAccount. r=mkmelin,pmorris DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">calendar/base/modules/utils/calEmailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calEmailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">calendar/base/modules/utils/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">calendar/base/modules/utils/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/calendar/base/modules/utils/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">mail/components/about-support/content/accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/about-support/content/accounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">mail/components/extensions/parent/ext-accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/components/extensions/parent/ext-accounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">mail/extensions/openpgp/content/modules/configure.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/configure.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">mail/extensions/openpgp/content/modules/funcs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/funcs.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">mail/extensions/openpgp/content/modules/keyUsability.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/keyUsability.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">mail/extensions/openpgp/content/modules/stdlib/misc.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/extensions/openpgp/content/modules/stdlib/misc.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">mail/test/browser/composition/browser_sendButton.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/composition/browser_sendButton.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">mail/test/browser/multiple-identities/browser_displayNames.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mail/test/browser/multiple-identities/browser_displayNames.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">mailnews/base/prefs/content/am-identities-list.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/prefs/content/am-identities-list.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">mailnews/base/public/nsIMsgAccount.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/public/nsIMsgAccount.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">mailnews/base/src/nsMsgAccount.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">mailnews/base/src/nsMsgAccount.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccount.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">mailnews/base/test/unit/test_accountMgr2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/base/test/unit/test_accountMgr2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">mailnews/import/test/unit/resources/import_helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/mailnews/import/test/unit/resources/import_helper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">suite/mailnews/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/588fc64ebcb0946ba09005e4de0bea4019a27392/suite/mailnews/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -49,19 +49,17 @@ var calemail = {</span>
<a href="#l1.4"></a><span id="l1.4">   /**</span>
<a href="#l1.5"></a><span id="l1.5">    * Iterates all email identities and calls the passed function with identity and account.</span>
<a href="#l1.6"></a><span id="l1.6">    * If the called function returns false, iteration is stopped.</span>
<a href="#l1.7"></a><span id="l1.7">    *</span>
<a href="#l1.8"></a><span id="l1.8">    * @param {Function} aFunc       The function to be called for each identity and account</span>
<a href="#l1.9"></a><span id="l1.9">    */</span>
<a href="#l1.10"></a><span id="l1.10">   iterateIdentities(aFunc) {</span>
<a href="#l1.11"></a><span id="l1.11">     for (let account of MailServices.accounts.accounts) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      let identities = account.identities;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      for (let j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        let identity = identities.queryElementAt(j, Ci.nsIMsgIdentity);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      for (let identity of account.identities) {</span>
<a href="#l1.16"></a><span id="l1.16">         if (!aFunc(identity, account)) {</span>
<a href="#l1.17"></a><span id="l1.17">           break;</span>
<a href="#l1.18"></a><span id="l1.18">         }</span>
<a href="#l1.19"></a><span id="l1.19">       }</span>
<a href="#l1.20"></a><span id="l1.20">     }</span>
<a href="#l1.21"></a><span id="l1.21">   },</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,17 +2,16 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> var { MailServices } = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> var { calendarDeactivator } = ChromeUtils.import(</span>
<a href="#l2.10"></a><span id="l2.10">   &quot;resource:///modules/calendar/calCalendarDeactivator.jsm&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> );</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> ChromeUtils.defineModuleGetter(this, &quot;cal&quot;, &quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> /*</span>
<a href="#l2.17"></a><span id="l2.17">  * Scheduling and iTIP helper code</span>
<a href="#l2.18"></a><span id="l2.18">  */</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> // NOTE: This module should not be loaded directly, it is available when</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -504,43 +503,39 @@ var calitip = {</span>
<a href="#l2.22"></a><span id="l2.22">    * @return {String}                 The email of the intended recipient.</span>
<a href="#l2.23"></a><span id="l2.23">    */</span>
<a href="#l2.24"></a><span id="l2.24">   getMessageRecipient(aMsgHdr) {</span>
<a href="#l2.25"></a><span id="l2.25">     if (!aMsgHdr) {</span>
<a href="#l2.26"></a><span id="l2.26">       return null;</span>
<a href="#l2.27"></a><span id="l2.27">     }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">     let identities;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    let actMgr = MailServices.accounts;</span>
<a href="#l2.31"></a><span id="l2.31">     if (aMsgHdr.accountKey) {</span>
<a href="#l2.32"></a><span id="l2.32">       // First, check if the message has an account key. If so, we can use the</span>
<a href="#l2.33"></a><span id="l2.33">       // account identities to find the correct recipient</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-      // Note: fixIterator here is a stopgap, to be removed (see Bug 1612239).</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-      identities = [</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-        ...fixIterator(actMgr.getAccount(aMsgHdr.accountKey).identities, Ci.nsIMsgIdentity),</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-      ];</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+      identities = MailServices.accounts.getAccount(aMsgHdr.accountKey).identities;</span>
<a href="#l2.39"></a><span id="l2.39">     } else if (aMsgHdr.folder) {</span>
<a href="#l2.40"></a><span id="l2.40">       // Without an account key, we have to revert back to using the server</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-      identities = actMgr.getIdentitiesForServer(aMsgHdr.folder.server);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      identities = MailServices.accounts.getIdentitiesForServer(aMsgHdr.folder.server);</span>
<a href="#l2.43"></a><span id="l2.43">     }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     let emailMap = {};</span>
<a href="#l2.46"></a><span id="l2.46">     if (!identities || identities.length == 0) {</span>
<a href="#l2.47"></a><span id="l2.47">       let identity;</span>
<a href="#l2.48"></a><span id="l2.48">       // If we were not able to retrieve identities above, then we have no</span>
<a href="#l2.49"></a><span id="l2.49">       // choice but to revert to the default identity.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      let defaultAccount = actMgr.defaultAccount;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l2.52"></a><span id="l2.52">       if (defaultAccount) {</span>
<a href="#l2.53"></a><span id="l2.53">         identity = defaultAccount.defaultIdentity;</span>
<a href="#l2.54"></a><span id="l2.54">       }</span>
<a href="#l2.55"></a><span id="l2.55">       if (!identity) {</span>
<a href="#l2.56"></a><span id="l2.56">         // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l2.57"></a><span id="l2.57">         // default identity), then go ahead and use the first available</span>
<a href="#l2.58"></a><span id="l2.58">         // identity.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-        let allIdentities = actMgr.allIdentities;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+        let allIdentities = MailServices.accounts.allIdentities;</span>
<a href="#l2.61"></a><span id="l2.61">         if (allIdentities.length &gt; 0) {</span>
<a href="#l2.62"></a><span id="l2.62">           identity = allIdentities[0];</span>
<a href="#l2.63"></a><span id="l2.63">         } else {</span>
<a href="#l2.64"></a><span id="l2.64">           // If there are no identities at all, we cannot get a recipient.</span>
<a href="#l2.65"></a><span id="l2.65">           return null;</span>
<a href="#l2.66"></a><span id="l2.66">         }</span>
<a href="#l2.67"></a><span id="l2.67">       }</span>
<a href="#l2.68"></a><span id="l2.68">       emailMap[identity.email.toLowerCase()] = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -252,17 +252,17 @@ var calprovider = {</span>
<a href="#l3.4"></a><span id="l3.4">    */</span>
<a href="#l3.5"></a><span id="l3.5">   getEmailIdentityOfCalendar(aCalendar, outAccount) {</span>
<a href="#l3.6"></a><span id="l3.6">     cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l3.7"></a><span id="l3.7">     let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l3.8"></a><span id="l3.8">     if (key === null) {</span>
<a href="#l3.9"></a><span id="l3.9">       // take default account/identity:</span>
<a href="#l3.10"></a><span id="l3.10">       let findIdentity = function(account) {</span>
<a href="#l3.11"></a><span id="l3.11">         if (account &amp;&amp; account.identities.length) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          return account.defaultIdentity || account.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          return account.defaultIdentity || account.identities[0];</span>
<a href="#l3.14"></a><span id="l3.14">         }</span>
<a href="#l3.15"></a><span id="l3.15">         return null;</span>
<a href="#l3.16"></a><span id="l3.16">       };</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">       let foundAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l3.19"></a><span id="l3.19">       let foundIdentity = findIdentity(foundAccount);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">       if (!foundAccount || !foundIdentity) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/about-support/content/accounts.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/about-support/content/accounts.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,19 +4,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> /* globals CLASS_DATA_PRIVATE, CLASS_DATA_PUBLIC */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> &quot;use strict&quot;;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> );</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var { fixIterator } = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-);</span>
<a href="#l4.15"></a><span id="l4.15"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> // Platform-specific includes</span>
<a href="#l4.18"></a><span id="l4.18"> var AboutSupportPlatform;</span>
<a href="#l4.19"></a><span id="l4.19"> if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l4.20"></a><span id="l4.20">   let temp = ChromeUtils.import(&quot;resource:///modules/AboutSupportWin32.jsm&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">   AboutSupportPlatform = temp.AboutSupportPlatform;</span>
<a href="#l4.22"></a><span id="l4.22"> } else if (&quot;nsILocalFileMac&quot; in Ci) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -60,21 +57,20 @@ var gAuthMethodProperties = new Map([</span>
<a href="#l4.24"></a><span id="l4.24"> var AboutSupport = {</span>
<a href="#l4.25"></a><span id="l4.25">   /**</span>
<a href="#l4.26"></a><span id="l4.26">    * Gets details about SMTP servers for a given nsIMsgAccount.</span>
<a href="#l4.27"></a><span id="l4.27">    *</span>
<a href="#l4.28"></a><span id="l4.28">    * @returns An array of records, each record containing the name and other details</span>
<a href="#l4.29"></a><span id="l4.29">    *          about one SMTP server.</span>
<a href="#l4.30"></a><span id="l4.30">    */</span>
<a href="#l4.31"></a><span id="l4.31">   _getSMTPDetails(aAccount) {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    let identities = aAccount.identities;</span>
<a href="#l4.33"></a><span id="l4.33">     let defaultIdentity = aAccount.defaultIdentity;</span>
<a href="#l4.34"></a><span id="l4.34">     let smtpDetails = [];</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    for (let identity of aAccount.identities) {</span>
<a href="#l4.38"></a><span id="l4.38">       let isDefault = identity == defaultIdentity;</span>
<a href="#l4.39"></a><span id="l4.39">       let smtpServer = {};</span>
<a href="#l4.40"></a><span id="l4.40">       MailServices.smtp.getServerByIdentity(identity, smtpServer);</span>
<a href="#l4.41"></a><span id="l4.41">       smtpDetails.push({</span>
<a href="#l4.42"></a><span id="l4.42">         identityName: identity.identityName,</span>
<a href="#l4.43"></a><span id="l4.43">         name: smtpServer.value.displayname,</span>
<a href="#l4.44"></a><span id="l4.44">         authMethod: smtpServer.value.authMethod,</span>
<a href="#l4.45"></a><span id="l4.45">         socketType: smtpServer.value.socketType,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5056,21 +5056,18 @@ function toggleAttachmentReminder(aState</span>
<a href="#l5.4"></a><span id="l5.4">   manageAttachmentNotification(false);</span>
<a href="#l5.5"></a><span id="l5.5"> }</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> function FillIdentityList(menulist) {</span>
<a href="#l5.8"></a><span id="l5.8">   let accounts = allAccountsSorted(true);</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   let accountHadSeparator = false;</span>
<a href="#l5.11"></a><span id="l5.11">   let firstAccountWithIdentities = true;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  for (let acc = 0; acc &lt; accounts.length; acc++) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    let account = accounts[acc];</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-    let identities = toArray(</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-      fixIterator(account.identities, Ci.nsIMsgIdentity)</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    );</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  for (let account of accounts) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    let identities = account.identities;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">     if (identities.length == 0) {</span>
<a href="#l5.21"></a><span id="l5.21">       continue;</span>
<a href="#l5.22"></a><span id="l5.22">     }</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">     let needSeparator = identities.length &gt; 1;</span>
<a href="#l5.25"></a><span id="l5.25">     if (needSeparator || accountHadSeparator) {</span>
<a href="#l5.26"></a><span id="l5.26">       // Separate identities from this account from the previous</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-accounts.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-accounts.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -35,19 +35,17 @@ function convertAccount(account) {</span>
<a href="#l6.4"></a><span id="l6.4">   };</span>
<a href="#l6.5"></a><span id="l6.5">   let folders = traverse(account.incomingServer.rootFolder).subFolders;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   return {</span>
<a href="#l6.8"></a><span id="l6.8">     id: account.key,</span>
<a href="#l6.9"></a><span id="l6.9">     name: account.incomingServer.prettyName,</span>
<a href="#l6.10"></a><span id="l6.10">     type: account.incomingServer.type,</span>
<a href="#l6.11"></a><span id="l6.11">     folders,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    identities: Array.from(account.identities.enumerate(), identity =&gt;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-      convertMailIdentity(account, identity)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    ),</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    identities: account.identities.map(id =&gt; convertMailIdentity(account, id)),</span>
<a href="#l6.16"></a><span id="l6.16">   };</span>
<a href="#l6.17"></a><span id="l6.17"> }</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> this.accounts = class extends ExtensionAPI {</span>
<a href="#l6.20"></a><span id="l6.20">   getAPI(context) {</span>
<a href="#l6.21"></a><span id="l6.21">     return {</span>
<a href="#l6.22"></a><span id="l6.22">       accounts: {</span>
<a href="#l6.23"></a><span id="l6.23">         async list() {</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -67,18 +65,17 @@ this.accounts = class extends ExtensionA</span>
<a href="#l6.25"></a><span id="l6.25">           }</span>
<a href="#l6.26"></a><span id="l6.26">           return null;</span>
<a href="#l6.27"></a><span id="l6.27">         },</span>
<a href="#l6.28"></a><span id="l6.28">         async setDefaultIdentity(accountId, identityId) {</span>
<a href="#l6.29"></a><span id="l6.29">           let account = MailServices.accounts.getAccount(accountId);</span>
<a href="#l6.30"></a><span id="l6.30">           if (!account) {</span>
<a href="#l6.31"></a><span id="l6.31">             throw new ExtensionError(`Account not found: ${accountId}`);</span>
<a href="#l6.32"></a><span id="l6.32">           }</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-          for (let identity of account.identities.enumerate()) {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-            identity = identity.QueryInterface(Ci.nsIMsgIdentity);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+          for (let identity of account.identities) {</span>
<a href="#l6.36"></a><span id="l6.36">             if (identity.key == identityId) {</span>
<a href="#l6.37"></a><span id="l6.37">               account.defaultIdentity = identity;</span>
<a href="#l6.38"></a><span id="l6.38">               return;</span>
<a href="#l6.39"></a><span id="l6.39">             }</span>
<a href="#l6.40"></a><span id="l6.40">           }</span>
<a href="#l6.41"></a><span id="l6.41">           throw new ExtensionError(</span>
<a href="#l6.42"></a><span id="l6.42">             `Identity ${identityId} not found for ${accountId}`</span>
<a href="#l6.43"></a><span id="l6.43">           );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/configure.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/configure.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -144,18 +144,17 @@ function replaceKeyIdWithFpr() {</span>
<a href="#l7.4"></a><span id="l7.4">  * Change the default to PGP/MIME for all accounts, except nntp</span>
<a href="#l7.5"></a><span id="l7.5">  * (v1.8.x -&gt; v1.9)</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> function defaultPgpMime() {</span>
<a href="#l7.8"></a><span id="l7.8">   let changedSomething = false;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   for (let ac of MailServices.accounts.accounts) {</span>
<a href="#l7.11"></a><span id="l7.11">     if (ac.incomingServer.type.search(/(pop3|imap|movemail)/) &gt;= 0) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      for (let i = 0; i &lt; ac.identities.length; i++) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        let id = ac.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+      for (let id of ac.identities) {</span>
<a href="#l7.15"></a><span id="l7.15">         if (</span>
<a href="#l7.16"></a><span id="l7.16">           id.getBoolAttribute(&quot;enablePgp&quot;) &amp;&amp;</span>
<a href="#l7.17"></a><span id="l7.17">           !id.getBoolAttribute(&quot;pgpMimeMode&quot;)</span>
<a href="#l7.18"></a><span id="l7.18">         ) {</span>
<a href="#l7.19"></a><span id="l7.19">           changedSomething = true;</span>
<a href="#l7.20"></a><span id="l7.20">         }</span>
<a href="#l7.21"></a><span id="l7.21">         id.setBoolAttribute(&quot;pgpMimeMode&quot;, true);</span>
<a href="#l7.22"></a><span id="l7.22">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/funcs.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/funcs.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -413,18 +413,17 @@ var EnigmailFuncs = {</span>
<a href="#l8.4"></a><span id="l8.4">     return 0;</span>
<a href="#l8.5"></a><span id="l8.5">   },</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   /**</span>
<a href="#l8.8"></a><span id="l8.8">    * Get the nsIMsgAccount associated with a given nsIMsgIdentity</span>
<a href="#l8.9"></a><span id="l8.9">    */</span>
<a href="#l8.10"></a><span id="l8.10">   getAccountForIdentity(identity) {</span>
<a href="#l8.11"></a><span id="l8.11">     for (let ac of MailServices.accounts.accounts) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      for (let i = 0; i &lt; ac.identities.length; i++) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-        let id = ac.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+      for (let id of ac.identities) {</span>
<a href="#l8.15"></a><span id="l8.15">         if (id.key === identity.key) {</span>
<a href="#l8.16"></a><span id="l8.16">           return ac;</span>
<a href="#l8.17"></a><span id="l8.17">         }</span>
<a href="#l8.18"></a><span id="l8.18">       }</span>
<a href="#l8.19"></a><span id="l8.19">     }</span>
<a href="#l8.20"></a><span id="l8.20">     return null;</span>
<a href="#l8.21"></a><span id="l8.21">   },</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -445,17 +444,17 @@ var EnigmailFuncs = {</span>
<a href="#l8.24"></a><span id="l8.24">             break;</span>
<a href="#l8.25"></a><span id="l8.25">           }</span>
<a href="#l8.26"></a><span id="l8.26">         }</span>
<a href="#l8.27"></a><span id="l8.27">       }</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">       if (ac.defaultIdentity) {</span>
<a href="#l8.30"></a><span id="l8.30">         return ac.defaultIdentity;</span>
<a href="#l8.31"></a><span id="l8.31">       }</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-      return ac.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      return ac.identities[0];</span>
<a href="#l8.34"></a><span id="l8.34">     } catch (x) {</span>
<a href="#l8.35"></a><span id="l8.35">       return null;</span>
<a href="#l8.36"></a><span id="l8.36">     }</span>
<a href="#l8.37"></a><span id="l8.37">   },</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   /**</span>
<a href="#l8.40"></a><span id="l8.40">    * Strip extended email parts such as &quot;+xyz&quot; from &quot;abc+xyz@gmail.com&quot; for known domains</span>
<a href="#l8.41"></a><span id="l8.41">    * Currently supported domains: gmail.com, googlemail.com</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyUsability.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyUsability.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -99,18 +99,17 @@ var EnigmailKeyUsability = {</span>
<a href="#l9.4"></a><span id="l9.4">    * @return  Array of Strings - list of keyId and email addresses</span>
<a href="#l9.5"></a><span id="l9.5">    */</span>
<a href="#l9.6"></a><span id="l9.6">   getKeysSpecForIdentities() {</span>
<a href="#l9.7"></a><span id="l9.7">     EnigmailLog.DEBUG(&quot;keyUsability.jsm: getKeysSpecForIdentities()\n&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">     let keySpecList = [];</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">     for (let ac of MailServices.accounts.accounts) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-      for (let i = 0; i &lt; ac.identities.length; i++) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-        let id = ac.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      for (let id of ac.identities) {</span>
<a href="#l9.15"></a><span id="l9.15">         if (id.getBoolAttribute(&quot;enablePgp&quot;)) {</span>
<a href="#l9.16"></a><span id="l9.16">           if (id.getIntAttribute(&quot;pgpKeyMode&quot;) === 1) {</span>
<a href="#l9.17"></a><span id="l9.17">             keySpecList.push(id.getCharAttribute(&quot;pgpkeyId&quot;));</span>
<a href="#l9.18"></a><span id="l9.18">           } else {</span>
<a href="#l9.19"></a><span id="l9.19">             keySpecList.push(id.email);</span>
<a href="#l9.20"></a><span id="l9.20">           }</span>
<a href="#l9.21"></a><span id="l9.21">         }</span>
<a href="#l9.22"></a><span id="l9.22">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/stdlib/misc.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/stdlib/misc.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -36,19 +36,16 @@ var EXPORTED_SYMBOLS = [</span>
<a href="#l10.4"></a><span id="l10.4">   // Character set helpers</span>
<a href="#l10.5"></a><span id="l10.5">   &quot;systemCharset&quot;,</span>
<a href="#l10.6"></a><span id="l10.6">   // Platform-specific idioms</span>
<a href="#l10.7"></a><span id="l10.7">   &quot;isOSX&quot;,</span>
<a href="#l10.8"></a><span id="l10.8">   &quot;isWindows&quot;,</span>
<a href="#l10.9"></a><span id="l10.9">   &quot;isAccel&quot;,</span>
<a href="#l10.10"></a><span id="l10.10"> ];</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-const { fixIterator } = ChromeUtils.import(</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-);</span>
<a href="#l10.15"></a><span id="l10.15"> const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l10.16"></a><span id="l10.16">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> );</span>
<a href="#l10.18"></a><span id="l10.18"> const { EnigmailLog } = ChromeUtils.import(</span>
<a href="#l10.19"></a><span id="l10.19">   &quot;chrome://openpgp/content/modules/log.jsm&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> );</span>
<a href="#l10.21"></a><span id="l10.21"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l10.22"></a><span id="l10.22">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -185,20 +182,17 @@ function getIdentities(aSkipNntpIdentiti</span>
<a href="#l10.24"></a><span id="l10.24">   for (let account of MailServices.accounts.accounts) {</span>
<a href="#l10.25"></a><span id="l10.25">     let server = account.incomingServer;</span>
<a href="#l10.26"></a><span id="l10.26">     if (</span>
<a href="#l10.27"></a><span id="l10.27">       aSkipNntpIdentities &amp;&amp;</span>
<a href="#l10.28"></a><span id="l10.28">       (!server || (server.type != &quot;pop3&quot; &amp;&amp; server.type != &quot;imap&quot;))</span>
<a href="#l10.29"></a><span id="l10.29">     ) {</span>
<a href="#l10.30"></a><span id="l10.30">       continue;</span>
<a href="#l10.31"></a><span id="l10.31">     }</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    for (let currentIdentity of fixIterator(</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-      account.identities,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-      Ci.nsIMsgIdentity</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    )) {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+    for (let currentIdentity of account.identities) {</span>
<a href="#l10.37"></a><span id="l10.37">       // We're only interested in identities that have a real email.</span>
<a href="#l10.38"></a><span id="l10.38">       if (currentIdentity.email) {</span>
<a href="#l10.39"></a><span id="l10.39">         identities.push({</span>
<a href="#l10.40"></a><span id="l10.40">           isDefault:</span>
<a href="#l10.41"></a><span id="l10.41">             currentIdentity == MailServices.accounts.defaultAccount</span>
<a href="#l10.42"></a><span id="l10.42">               ? MailServices.accounts.defaultAccount.defaultIdentity</span>
<a href="#l10.43"></a><span id="l10.43">               : false,</span>
<a href="#l10.44"></a><span id="l10.44">           identity: currentIdentity,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -214,20 +214,17 @@ add_task(function test_send_enabled_pref</span>
<a href="#l11.4"></a><span id="l11.4">   let cwc = open_compose_new_mail();</span>
<a href="#l11.5"></a><span id="l11.5">   check_send_commands_state(cwc, true);</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   let identityPicker = cwc.e(&quot;msgIdentity&quot;);</span>
<a href="#l11.8"></a><span id="l11.8">   Assert.equal(identityPicker.selectedIndex, 0);</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   // Switch to the second identity that has no CC. Send should be disabled.</span>
<a href="#l11.11"></a><span id="l11.11">   Assert.ok(account.identities.length &gt;= 2);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  let identityWithoutCC = account.identities.queryElementAt(</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    1,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-    Ci.nsIMsgIdentity</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  );</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  let identityWithoutCC = account.identities[1];</span>
<a href="#l11.17"></a><span id="l11.17">   Assert.ok(!identityWithoutCC.doCc);</span>
<a href="#l11.18"></a><span id="l11.18">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l11.19"></a><span id="l11.19">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l11.20"></a><span id="l11.20">     { identitykey: identityWithoutCC.key },</span>
<a href="#l11.21"></a><span id="l11.21">   ]);</span>
<a href="#l11.22"></a><span id="l11.22">   check_send_commands_state(cwc, false);</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   // Check the first identity again.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/browser/multiple-identities/browser_displayNames.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/browser/multiple-identities/browser_displayNames.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -48,17 +48,17 @@ add_task(function setupModule(module) {</span>
<a href="#l12.4"></a><span id="l12.4">   for (let account of MailServices.accounts.accounts) {</span>
<a href="#l12.5"></a><span id="l12.5">     if (account != localAccount) {</span>
<a href="#l12.6"></a><span id="l12.6">       MailServices.accounts.removeAccount(account);</span>
<a href="#l12.7"></a><span id="l12.7">     }</span>
<a href="#l12.8"></a><span id="l12.8">   }</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   // 2) Delete all identities except for one</span>
<a href="#l12.11"></a><span id="l12.11">   for (let i = localAccount.identities.length - 1; i &gt;= 0; i--) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    let identity = localAccount.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    let identity = localAccount.identities[i];</span>
<a href="#l12.14"></a><span id="l12.14">     if (identity.email != myEmail) {</span>
<a href="#l12.15"></a><span id="l12.15">       localAccount.removeIdentity(identity);</span>
<a href="#l12.16"></a><span id="l12.16">     }</span>
<a href="#l12.17"></a><span id="l12.17">   }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   // 3) Create a second identity and hold onto it for later</span>
<a href="#l12.20"></a><span id="l12.20">   secondIdentity = MailServices.accounts.createIdentity();</span>
<a href="#l12.21"></a><span id="l12.21">   secondIdentity.email = &quot;nobody@nowhere.invalid&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -297,17 +297,17 @@ function AccountDataToPageData(accountDa</span>
<a href="#l13.4"></a><span id="l13.4">   setPageData(pageData, &quot;accname&quot;, &quot;userset&quot;, false);</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   var identity;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">   if (accountData.identity) {</span>
<a href="#l13.9"></a><span id="l13.9">     dump(&quot;This is an accountdata\n&quot;);</span>
<a href="#l13.10"></a><span id="l13.10">     identity = accountData.identity;</span>
<a href="#l13.11"></a><span id="l13.11">   } else if (accountData.identities) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    identity = accountData.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    identity = accountData.identities[0];</span>
<a href="#l13.14"></a><span id="l13.14">     dump(&quot;this is an account, id= &quot; + identity + &quot;\n&quot;);</span>
<a href="#l13.15"></a><span id="l13.15">   }</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17">   setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, identity.email || &quot;&quot;);</span>
<a href="#l13.18"></a><span id="l13.18">   setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, identity.fullName || &quot;&quot;);</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">   var smtp;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -515,19 +515,17 @@ function finishAccount(account, accountD</span>
<a href="#l13.23"></a><span id="l13.23">     }</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">     account.incomingServer.valid = true;</span>
<a href="#l13.26"></a><span id="l13.26">     // hack to cause an account loaded notification now the server is valid</span>
<a href="#l13.27"></a><span id="l13.27">     account.incomingServer = account.incomingServer; // eslint-disable-line no-self-assign</span>
<a href="#l13.28"></a><span id="l13.28">   }</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   // copy identity info</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  var destIdentity = account.identities.length</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    ? account.identities.queryElementAt(0, nsIMsgIdentity)</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    : null;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  var destIdentity = account.identities.length ? account.identities[0] : null;</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36">   if (destIdentity) {</span>
<a href="#l13.37"></a><span id="l13.37">     // does this account have an identity?</span>
<a href="#l13.38"></a><span id="l13.38">     if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l13.39"></a><span id="l13.39">       // fixup the email address if we have a default domain</span>
<a href="#l13.40"></a><span id="l13.40">       let emailArray = accountData.identity.email.split(&quot;@&quot;);</span>
<a href="#l13.41"></a><span id="l13.41">       if (emailArray.length &lt; 2 &amp;&amp; accountData.domain) {</span>
<a href="#l13.42"></a><span id="l13.42">         accountData.identity.email += &quot;@&quot; + accountData.domain;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -662,17 +660,17 @@ function setupCopiesAndFoldersServer(acc</span>
<a href="#l13.44"></a><span id="l13.44">   try {</span>
<a href="#l13.45"></a><span id="l13.45">     var server = account.incomingServer;</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">     // This function sets up the default send preferences. The send preferences</span>
<a href="#l13.48"></a><span id="l13.48">     // go on identities, so there is no need to continue without any identities.</span>
<a href="#l13.49"></a><span id="l13.49">     if (server.type == &quot;rss&quot; || account.identities.length == 0) {</span>
<a href="#l13.50"></a><span id="l13.50">       return false;</span>
<a href="#l13.51"></a><span id="l13.51">     }</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-    let identity = account.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    let identity = account.identities[0];</span>
<a href="#l13.54"></a><span id="l13.54">     // For this server, do we default the folder prefs to this server, or to the &quot;Local Folders&quot; server</span>
<a href="#l13.55"></a><span id="l13.55">     // If it's deferred, we use the local folders account.</span>
<a href="#l13.56"></a><span id="l13.56">     var defaultCopiesAndFoldersPrefsToServer =</span>
<a href="#l13.57"></a><span id="l13.57">       !accountIsDeferred &amp;&amp; server.defaultCopiesAndFoldersPrefsToServer;</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">     var copiesAndFoldersServer = null;</span>
<a href="#l13.60"></a><span id="l13.60">     if (defaultCopiesAndFoldersPrefsToServer) {</span>
<a href="#l13.61"></a><span id="l13.61">       copiesAndFoldersServer = server;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineat">@@ -795,20 +793,17 @@ function checkForInvalidAccounts() {</span>
<a href="#l13.63"></a><span id="l13.63">       &quot;We have an invalid account, &quot; +</span>
<a href="#l13.64"></a><span id="l13.64">         firstInvalidAccount +</span>
<a href="#l13.65"></a><span id="l13.65">         &quot;, let's use that!\n&quot;</span>
<a href="#l13.66"></a><span id="l13.66">     );</span>
<a href="#l13.67"></a><span id="l13.67">     gCurrentAccount = firstInvalidAccount;</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69">     var accountData = {};</span>
<a href="#l13.70"></a><span id="l13.70">     accountData.incomingServer = firstInvalidAccount.incomingServer;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-    accountData.identity = firstInvalidAccount.identities.queryElementAt(</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-      0,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-      nsIMsgIdentity</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    );</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    accountData.identity = firstInvalidAccount.identities[0];</span>
<a href="#l13.76"></a><span id="l13.76">     accountData.smtp = MailServices.smtp.defaultServer;</span>
<a href="#l13.77"></a><span id="l13.77">     AccountDataToPageData(accountData, pageData);</span>
<a href="#l13.78"></a><span id="l13.78"> </span>
<a href="#l13.79"></a><span id="l13.79">     gCurrentAccountData = accountData;</span>
<a href="#l13.80"></a><span id="l13.80"> </span>
<a href="#l13.81"></a><span id="l13.81">     setupWizardPanels();</span>
<a href="#l13.82"></a><span id="l13.82">     // Set the page index to identity page.</span>
<a href="#l13.83"></a><span id="l13.83">     document.querySelector(&quot;wizard&quot;).pageIndex = 1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -17,38 +17,33 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> var gAnyValidIdentity = false; // If there are no valid identities for any account</span>
<a href="#l14.6"></a><span id="l14.6"> // returns the first account with an invalid server or identity</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> var gNewAccountToLoad = null; // used to load new messages if we come from the mail3pane</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> function getInvalidAccounts(accounts) {</span>
<a href="#l14.11"></a><span id="l14.11">   let invalidAccounts = [];</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  let numIdentities = 0;</span>
<a href="#l14.13"></a><span id="l14.13">   for (let account of accounts) {</span>
<a href="#l14.14"></a><span id="l14.14">     try {</span>
<a href="#l14.15"></a><span id="l14.15">       if (!account.incomingServer.valid) {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-        invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+        invalidAccounts.push(account);</span>
<a href="#l14.18"></a><span id="l14.18">         // skip to the next account</span>
<a href="#l14.19"></a><span id="l14.19">         continue;</span>
<a href="#l14.20"></a><span id="l14.20">       }</span>
<a href="#l14.21"></a><span id="l14.21">     } catch (ex) {</span>
<a href="#l14.22"></a><span id="l14.22">       // this account is busted, just keep going</span>
<a href="#l14.23"></a><span id="l14.23">       continue;</span>
<a href="#l14.24"></a><span id="l14.24">     }</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    var identities = account.identities;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-    numIdentities = identities.length;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-    for (var j = 0; j &lt; numIdentities; j++) {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-      let identity = identities.queryElementAt(j, Ci.nsIMsgIdentity);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    for (let identity of account.identities) {</span>
<a href="#l14.32"></a><span id="l14.32">       if (identity.valid) {</span>
<a href="#l14.33"></a><span id="l14.33">         gAnyValidIdentity = true;</span>
<a href="#l14.34"></a><span id="l14.34">       } else {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-        invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+        invalidAccounts.push(account);</span>
<a href="#l14.37"></a><span id="l14.37">       }</span>
<a href="#l14.38"></a><span id="l14.38">     }</span>
<a href="#l14.39"></a><span id="l14.39">   }</span>
<a href="#l14.40"></a><span id="l14.40">   return invalidAccounts;</span>
<a href="#l14.41"></a><span id="l14.41"> }</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43"> function showMailIntegrationDialog() {</span>
<a href="#l14.44"></a><span id="l14.44">   const nsIShellService = Ci.nsIShellService;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -45,18 +45,17 @@ function onLoad() {</span>
<a href="#l15.4"></a><span id="l15.4">  */</span>
<a href="#l15.5"></a><span id="l15.5"> function refreshIdentityList(aSelectIndex) {</span>
<a href="#l15.6"></a><span id="l15.6">   // Remove all children.</span>
<a href="#l15.7"></a><span id="l15.7">   while (gIdentityListBox.hasChildNodes()) {</span>
<a href="#l15.8"></a><span id="l15.8">     gIdentityListBox.lastChild.remove();</span>
<a href="#l15.9"></a><span id="l15.9">   }</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   // Build the list from the identities array.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  let identities = gAccount.identities;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  for (let identity of gAccount.identities) {</span>
<a href="#l15.15"></a><span id="l15.15">     if (identity.valid) {</span>
<a href="#l15.16"></a><span id="l15.16">       let label = document.createXULElement(&quot;label&quot;);</span>
<a href="#l15.17"></a><span id="l15.17">       label.setAttribute(&quot;value&quot;, identity.identityName);</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">       let listitem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l15.20"></a><span id="l15.20">       listitem.appendChild(label);</span>
<a href="#l15.21"></a><span id="l15.21">       listitem.setAttribute(&quot;key&quot;, identity.key);</span>
<a href="#l15.22"></a><span id="l15.22">       gIdentityListBox.appendChild(listitem);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -100,25 +99,20 @@ function openIdentityEditor(identity) {</span>
<a href="#l15.24"></a><span id="l15.24">   }</span>
<a href="#l15.25"></a><span id="l15.25"> }</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27"> function getSelectedIdentity() {</span>
<a href="#l15.28"></a><span id="l15.28">   if (gIdentityListBox.selectedItems.length != 1) {</span>
<a href="#l15.29"></a><span id="l15.29">     return null;</span>
<a href="#l15.30"></a><span id="l15.30">   }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  var identityKey = gIdentityListBox.selectedItems[0].getAttribute(&quot;key&quot;);</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-  let identities = gAccount.identities;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-    if (identity.valid &amp;&amp; identity.key == identityKey) {</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-      return identity;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-    }</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  }</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-  return null; // no identity found</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  let identityKey = gIdentityListBox.selectedItems[0].getAttribute(&quot;key&quot;);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  return (</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+    gAccount.identities.find(id =&gt; id.valid &amp;&amp; id.key == identityKey) || null</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  );</span>
<a href="#l15.45"></a><span id="l15.45"> }</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47"> function onEdit(event) {</span>
<a href="#l15.48"></a><span id="l15.48">   var id = event.target.localName == &quot;listbox&quot; ? null : getSelectedIdentity();</span>
<a href="#l15.49"></a><span id="l15.49">   openIdentityEditor(id);</span>
<a href="#l15.50"></a><span id="l15.50"> }</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccount.idl</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccount.idl</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2,18 +2,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIMsgIdentity.idl&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-interface nsIArray;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-</span>
<a href="#l16.14"></a><span id="l16.14"> /**</span>
<a href="#l16.15"></a><span id="l16.15">  * An account consists of an incoming server and one or more</span>
<a href="#l16.16"></a><span id="l16.16">  * outgoing identities. An account is identified by a key,</span>
<a href="#l16.17"></a><span id="l16.17">  * which is the &lt;account&gt; string in the account preferences,</span>
<a href="#l16.18"></a><span id="l16.18">  * such as in mail.account.&lt;account&gt;.identities.</span>
<a href="#l16.19"></a><span id="l16.19">  */</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> [scriptable, uuid(84181351-4ec8-4ca8-8439-5c68cc591177)]</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -21,17 +19,17 @@ interface nsIMsgAccount : nsISupports {</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">   /// Internal key identifying itself</span>
<a href="#l16.25"></a><span id="l16.25">   attribute ACString key;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   /// Incoming server stuff</span>
<a href="#l16.28"></a><span id="l16.28">   attribute nsIMsgIncomingServer incomingServer;</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">   /// Outgoing identity list (array of nsIMsgIdentity's)</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  readonly attribute nsIArray identities;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  readonly attribute Array&lt;nsIMsgIdentity&gt; identities;</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   /// The default identity for this account.</span>
<a href="#l16.35"></a><span id="l16.35">   attribute nsIMsgIdentity defaultIdentity;</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">   /// Add a new identity to this account</span>
<a href="#l16.38"></a><span id="l16.38">   void addIdentity(in nsIMsgIdentity identity);</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">   /// Remove an identity from this account</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -152,42 +152,43 @@ nsMsgAccount::SetIncomingServer(nsIMsgIn</span>
<a href="#l17.4"></a><span id="l17.4">       mailSession-&gt;OnItemAdded(rootFolder, msgFolder);</span>
<a href="#l17.5"></a><span id="l17.5">       notifier-&gt;NotifyFolderAdded(msgFolder);</span>
<a href="#l17.6"></a><span id="l17.6">     }</span>
<a href="#l17.7"></a><span id="l17.7">   }</span>
<a href="#l17.8"></a><span id="l17.8">   return NS_OK;</span>
<a href="#l17.9"></a><span id="l17.9"> }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> NS_IMETHODIMP</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-nsMsgAccount::GetIdentities(nsIArray **_retval) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  NS_IF_ADDREF(*_retval = m_identities);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+nsMsgAccount::GetIdentities(nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; &amp;identities) {</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  NS_ENSURE_TRUE(m_identitiesValid, NS_ERROR_FAILURE);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  identities.Clear();</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  identities.AppendElements(m_identities);</span>
<a href="#l17.21"></a><span id="l17.21">   return NS_OK;</span>
<a href="#l17.22"></a><span id="l17.22"> }</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> /*</span>
<a href="#l17.25"></a><span id="l17.25">  * set up the m_identities array</span>
<a href="#l17.26"></a><span id="l17.26">  * do not call this more than once or we'll leak.</span>
<a href="#l17.27"></a><span id="l17.27">  */</span>
<a href="#l17.28"></a><span id="l17.28"> nsresult nsMsgAccount::createIdentities() {</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  NS_ENSURE_FALSE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  NS_ENSURE_FALSE(m_identitiesValid, NS_ERROR_FAILURE);</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   nsresult rv;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  m_identities = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  m_identities.Clear();</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   nsCString identityKey;</span>
<a href="#l17.38"></a><span id="l17.38">   rv = getPrefService();</span>
<a href="#l17.39"></a><span id="l17.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41">   m_prefs-&gt;GetCharPref(&quot;identities&quot;, identityKey);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-  if (identityKey.IsEmpty())  // not an error if no identities, but</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    return NS_OK;             // strtok will be unhappy</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+  if (identityKey.IsEmpty()) {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+    // not an error if no identities, but strtok will be unhappy.</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+    m_identitiesValid = true;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    return NS_OK;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+  }</span>
<a href="#l17.49"></a><span id="l17.49">   // get the server from the account manager</span>
<a href="#l17.50"></a><span id="l17.50">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l17.51"></a><span id="l17.51">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.52"></a><span id="l17.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54">   char *newStr = identityKey.BeginWriting();</span>
<a href="#l17.55"></a><span id="l17.55">   char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57" class="difflineat">@@ -198,76 +199,63 @@ nsresult nsMsgAccount::createIdentities(</span>
<a href="#l17.58"></a><span id="l17.58">   // iterate through id1,id2, etc</span>
<a href="#l17.59"></a><span id="l17.59">   while (token) {</span>
<a href="#l17.60"></a><span id="l17.60">     key = token;</span>
<a href="#l17.61"></a><span id="l17.61">     key.StripWhitespace();</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">     // create the account</span>
<a href="#l17.64"></a><span id="l17.64">     rv = accountManager-&gt;GetIdentity(key, getter_AddRefs(identity));</span>
<a href="#l17.65"></a><span id="l17.65">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-      // ignore error from addIdentityInternal() - if it fails, it fails.</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-      rv = addIdentityInternal(identity);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Couldn't create identity&quot;);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+      m_identities.AppendElement(identity);</span>
<a href="#l17.70"></a><span id="l17.70">     }</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72">     // advance to next key, if any</span>
<a href="#l17.73"></a><span id="l17.73">     token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l17.74"></a><span id="l17.74">   }</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  m_identitiesValid = true;</span>
<a href="#l17.77"></a><span id="l17.77">   return rv;</span>
<a href="#l17.78"></a><span id="l17.78"> }</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80"> /* attribute nsIMsgIdentity defaultIdentity; */</span>
<a href="#l17.81"></a><span id="l17.81"> NS_IMETHODIMP</span>
<a href="#l17.82"></a><span id="l17.82"> nsMsgAccount::GetDefaultIdentity(nsIMsgIdentity **aDefaultIdentity) {</span>
<a href="#l17.83"></a><span id="l17.83">   NS_ENSURE_ARG_POINTER(aDefaultIdentity);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-  NS_ENSURE_TRUE(m_identities, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  NS_ENSURE_TRUE(m_identitiesValid, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.86"></a><span id="l17.86"> </span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-  *aDefaultIdentity = nullptr;</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-  uint32_t count;</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-  nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  if (count == 0) return NS_OK;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(m_identities, 0, &amp;rv);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-  identity.forget(aDefaultIdentity);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  return rv;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  // Default identity is the first in the list.</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  if (m_identities.IsEmpty()) {</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+    *aDefaultIdentity = nullptr;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  } else {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+    NS_IF_ADDREF(*aDefaultIdentity = m_identities[0]);</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  }</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.103"></a><span id="l17.103"> }</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105"> NS_IMETHODIMP</span>
<a href="#l17.106"></a><span id="l17.106"> nsMsgAccount::SetDefaultIdentity(nsIMsgIdentity *aDefaultIdentity) {</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-  NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-  uint32_t position = 0;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  nsresult rv = m_identities-&gt;IndexOf(0, aDefaultIdentity, &amp;position);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  NS_ENSURE_TRUE(m_identitiesValid, NS_ERROR_FAILURE);</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-  rv = m_identities-&gt;RemoveElementAt(position);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  auto position = m_identities.IndexOf(aDefaultIdentity);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+  if (position == m_identities.NoIndex) {</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  }</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-  // The passed in identity is in the list, so we have at least one element.</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-  rv = m_identities-&gt;InsertElementAt(aDefaultIdentity, 0);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  // Move it to the front of the list.</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+  m_identities.RemoveElementAt(position);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+  m_identities.InsertElementAt(0, aDefaultIdentity);</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128">   return saveIdentitiesPref();</span>
<a href="#l17.129"></a><span id="l17.129"> }</span>
<a href="#l17.130"></a><span id="l17.130"> </span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-// add the identity to m_identities, but don't fiddle with the</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-// prefs. The assumption here is that the pref for this identity is</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-// already set.</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-nsresult nsMsgAccount::addIdentityInternal(nsIMsgIdentity *identity) {</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-  return m_identities-&gt;AppendElement(identity);</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-}</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-</span>
<a href="#l17.140"></a><span id="l17.140"> /* void addIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l17.141"></a><span id="l17.141"> NS_IMETHODIMP</span>
<a href="#l17.142"></a><span id="l17.142"> nsMsgAccount::AddIdentity(nsIMsgIdentity *identity) {</span>
<a href="#l17.143"></a><span id="l17.143">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  NS_ENSURE_TRUE(m_identitiesValid, NS_ERROR_FAILURE);</span>
<a href="#l17.145"></a><span id="l17.145"> </span>
<a href="#l17.146"></a><span id="l17.146">   // hack hack - need to add this to the list of identities.</span>
<a href="#l17.147"></a><span id="l17.147">   // for now just treat this as a Setxxx accessor</span>
<a href="#l17.148"></a><span id="l17.148">   // when this is actually implemented, don't refcount the default identity</span>
<a href="#l17.149"></a><span id="l17.149">   nsCString key;</span>
<a href="#l17.150"></a><span id="l17.150">   nsresult rv = identity-&gt;GetKey(key);</span>
<a href="#l17.151"></a><span id="l17.151"> </span>
<a href="#l17.152"></a><span id="l17.152">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineat">@@ -303,65 +291,53 @@ nsMsgAccount::AddIdentity(nsIMsgIdentity</span>
<a href="#l17.154"></a><span id="l17.154">         newIdentityList.Append(key);</span>
<a href="#l17.155"></a><span id="l17.155">       }</span>
<a href="#l17.156"></a><span id="l17.156">     }</span>
<a href="#l17.157"></a><span id="l17.157"> </span>
<a href="#l17.158"></a><span id="l17.158">     m_prefs-&gt;SetCharPref(&quot;identities&quot;, newIdentityList);</span>
<a href="#l17.159"></a><span id="l17.159">   }</span>
<a href="#l17.160"></a><span id="l17.160"> </span>
<a href="#l17.161"></a><span id="l17.161">   // now add it to the in-memory list</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-  return addIdentityInternal(identity);</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+  m_identities.AppendElement(identity);</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.165"></a><span id="l17.165"> }</span>
<a href="#l17.166"></a><span id="l17.166"> </span>
<a href="#l17.167"></a><span id="l17.167"> /* void removeIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l17.168"></a><span id="l17.168"> NS_IMETHODIMP</span>
<a href="#l17.169"></a><span id="l17.169"> nsMsgAccount::RemoveIdentity(nsIMsgIdentity *aIdentity) {</span>
<a href="#l17.170"></a><span id="l17.170">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-  NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-  uint32_t count = 0;</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-  m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-  // At least one identity must stay after the delete.</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-  NS_ENSURE_TRUE(count &gt; 1, NS_ERROR_FAILURE);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+  NS_ENSURE_TRUE(m_identitiesValid, NS_ERROR_FAILURE);</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-  uint32_t pos = 0;</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-  nsresult rv = m_identities-&gt;IndexOf(0, aIdentity, &amp;pos);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+  // At least one identity must stay after the delete.</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+  NS_ENSURE_TRUE(m_identities.Length() &gt; 1, NS_ERROR_FAILURE);</span>
<a href="#l17.184"></a><span id="l17.184"> </span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-  // remove our identity</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-  m_identities-&gt;RemoveElementAt(pos);</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+  if (!m_identities.RemoveElement(aIdentity)) {</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  }</span>
<a href="#l17.191"></a><span id="l17.191">   // clear out the actual pref values associated with the identity</span>
<a href="#l17.192"></a><span id="l17.192">   aIdentity-&gt;ClearAllValues();</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-</span>
<a href="#l17.194"></a><span id="l17.194">   return saveIdentitiesPref();</span>
<a href="#l17.195"></a><span id="l17.195"> }</span>
<a href="#l17.196"></a><span id="l17.196"> </span>
<a href="#l17.197"></a><span id="l17.197"> nsresult nsMsgAccount::saveIdentitiesPref() {</span>
<a href="#l17.198"></a><span id="l17.198">   nsAutoCString newIdentityList;</span>
<a href="#l17.199"></a><span id="l17.199"> </span>
<a href="#l17.200"></a><span id="l17.200">   // Iterate over the existing identities and build the pref value,</span>
<a href="#l17.201"></a><span id="l17.201">   // a string of identity keys: id1, id2, idX...</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-  uint32_t count;</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-  nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+  nsCString key;</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+  bool first = true;</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+  for (auto identity : m_identities) {</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+    identity-&gt;GetKey(key);</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  nsCString key;</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-  for (uint32_t index = 0; index &lt; count; index++) {</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; identity =</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-        do_QueryElementAt(m_identities, index, &amp;rv);</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-    if (identity) {</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-      identity-&gt;GetKey(key);</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-      if (!index) {</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-        newIdentityList = key;</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-      } else {</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-        newIdentityList.Append(',');</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-        newIdentityList.Append(key);</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-      }</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+    if (first) {</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+      newIdentityList = key;</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+      first = false;</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    } else {</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+      newIdentityList.Append(',');</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+      newIdentityList.Append(key);</span>
<a href="#l17.229"></a><span id="l17.229">     }</span>
<a href="#l17.230"></a><span id="l17.230">   }</span>
<a href="#l17.231"></a><span id="l17.231"> </span>
<a href="#l17.232"></a><span id="l17.232">   // Save the pref.</span>
<a href="#l17.233"></a><span id="l17.233">   m_prefs-&gt;SetCharPref(&quot;identities&quot;, newIdentityList);</span>
<a href="#l17.234"></a><span id="l17.234"> </span>
<a href="#l17.235"></a><span id="l17.235">   return NS_OK;</span>
<a href="#l17.236"></a><span id="l17.236"> }</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineat">@@ -370,17 +346,18 @@ NS_IMETHODIMP nsMsgAccount::GetKey(nsACS</span>
<a href="#l17.238"></a><span id="l17.238">   accountKey = m_accountKey;</span>
<a href="#l17.239"></a><span id="l17.239">   return NS_OK;</span>
<a href="#l17.240"></a><span id="l17.240"> }</span>
<a href="#l17.241"></a><span id="l17.241"> </span>
<a href="#l17.242"></a><span id="l17.242"> NS_IMETHODIMP</span>
<a href="#l17.243"></a><span id="l17.243"> nsMsgAccount::SetKey(const nsACString &amp;accountKey) {</span>
<a href="#l17.244"></a><span id="l17.244">   m_accountKey = accountKey;</span>
<a href="#l17.245"></a><span id="l17.245">   m_prefs = nullptr;</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-  m_identities = nullptr;</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+  m_identitiesValid = false;</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+  m_identities.Clear();</span>
<a href="#l17.249"></a><span id="l17.249">   return createIdentities();</span>
<a href="#l17.250"></a><span id="l17.250"> }</span>
<a href="#l17.251"></a><span id="l17.251"> </span>
<a href="#l17.252"></a><span id="l17.252"> NS_IMETHODIMP</span>
<a href="#l17.253"></a><span id="l17.253"> nsMsgAccount::ToString(nsAString &amp;aResult) {</span>
<a href="#l17.254"></a><span id="l17.254">   nsAutoString val;</span>
<a href="#l17.255"></a><span id="l17.255">   aResult.AssignLiteral(&quot;[nsIMsgAccount: &quot;);</span>
<a href="#l17.256"></a><span id="l17.256">   aResult.Append(NS_ConvertASCIItoUTF16(m_accountKey));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -17,19 +17,19 @@ class nsMsgAccount : public nsIMsgAccoun</span>
<a href="#l18.4"></a><span id="l18.4">   NS_DECL_NSIMSGACCOUNT</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">  private:</span>
<a href="#l18.7"></a><span id="l18.7">   virtual ~nsMsgAccount();</span>
<a href="#l18.8"></a><span id="l18.8">   nsCString m_accountKey;</span>
<a href="#l18.9"></a><span id="l18.9">   nsCOMPtr&lt;nsIPrefBranch&gt; m_prefs;</span>
<a href="#l18.10"></a><span id="l18.10">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_incomingServer;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; m_identities;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  bool m_identitiesValid;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  nsTArray&lt;nsCOMPtr&lt;nsIMsgIdentity&gt;&gt; m_identities;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16">   nsresult getPrefService();</span>
<a href="#l18.17"></a><span id="l18.17">   nsresult createIncomingServer();</span>
<a href="#l18.18"></a><span id="l18.18">   nsresult createIdentities();</span>
<a href="#l18.19"></a><span id="l18.19">   nsresult saveIdentitiesPref();</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  nsresult addIdentityInternal(nsIMsgIdentity* identity);</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   // Have we tried to get the server yet?</span>
<a href="#l18.23"></a><span id="l18.23">   bool mTriedToGetServer;</span>
<a href="#l18.24"></a><span id="l18.24"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -579,67 +579,57 @@ void nsMsgAccountManager::removeListener</span>
<a href="#l19.4"></a><span id="l19.4">     aFolder-&gt;RemoveFolderListener(iter.GetNext());</span>
<a href="#l19.5"></a><span id="l19.5">   }</span>
<a href="#l19.6"></a><span id="l19.6"> }</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> NS_IMETHODIMP</span>
<a href="#l19.9"></a><span id="l19.9"> nsMsgAccountManager::RemoveAccount(nsIMsgAccount *aAccount,</span>
<a href="#l19.10"></a><span id="l19.10">                                    bool aRemoveFiles = false) {</span>
<a href="#l19.11"></a><span id="l19.11">   NS_ENSURE_ARG_POINTER(aAccount);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  // Hold account in scope while we tidy up potentially-shared identities.</span>
<a href="#l19.13"></a><span id="l19.13">   nsresult rv = LoadAccounts();</span>
<a href="#l19.14"></a><span id="l19.14">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  bool accountRemoved = m_accounts.RemoveElement(aAccount);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  if (!accountRemoved) return NS_ERROR_INVALID_ARG;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+  if (!m_accounts.RemoveElement(aAccount)) {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  }</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22">   rv = OutputAccountsPref();</span>
<a href="#l19.23"></a><span id="l19.23">   // If we couldn't write out the pref, restore the account.</span>
<a href="#l19.24"></a><span id="l19.24">   if (NS_FAILED(rv)) {</span>
<a href="#l19.25"></a><span id="l19.25">     m_accounts.AppendElement(aAccount);</span>
<a href="#l19.26"></a><span id="l19.26">     return rv;</span>
<a href="#l19.27"></a><span id="l19.27">   }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">   // If it's the default, choose a new default account.</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  if (m_defaultAccount.get() == aAccount) AutosetDefaultAccount();</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  if (m_defaultAccount == aAccount) AutosetDefaultAccount();</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33">   // XXX - need to figure out if this is the last time this server is</span>
<a href="#l19.34"></a><span id="l19.34">   // being used, and only send notification then.</span>
<a href="#l19.35"></a><span id="l19.35">   // (and only remove from hashtable then too!)</span>
<a href="#l19.36"></a><span id="l19.36">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l19.37"></a><span id="l19.37">   rv = aAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l19.38"></a><span id="l19.38">   if (NS_SUCCEEDED(rv) &amp;&amp; server) RemoveIncomingServer(server, aRemoveFiles);</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; identityArray;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  rv = aAccount-&gt;GetIdentities(getter_AddRefs(identityArray));</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  rv = aAccount-&gt;GetIdentities(identities);</span>
<a href="#l19.44"></a><span id="l19.44">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-    uint32_t count = 0;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-    identityArray-&gt;GetLength(&amp;count);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-    uint32_t i;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-    for (i = 0; i &lt; count; i++) {</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; identity(</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-          do_QueryElementAt(identityArray, i, &amp;rv));</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+    for (auto identity : identities) {</span>
<a href="#l19.52"></a><span id="l19.52">       bool identityStillUsed = false;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-      // for each identity, see if any existing account still uses it,</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+      // for each identity, see if any remaining account still uses it,</span>
<a href="#l19.55"></a><span id="l19.55">       // and if not, clear it.</span>
<a href="#l19.56"></a><span id="l19.56">       // Note that we are also searching here accounts with missing servers from</span>
<a href="#l19.57"></a><span id="l19.57">       //  unloaded extension types.</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-        uint32_t index;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-        for (index = 0; index &lt; m_accounts.Length() &amp;&amp; !identityStillUsed;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-             index++) {</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-          nsCOMPtr&lt;nsIArray&gt; existingIdentitiesArray;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-          rv = m_accounts[index]-&gt;GetIdentities(</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-              getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-          uint32_t pos;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-          if (NS_SUCCEEDED(</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-                  existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos))) {</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-            identityStillUsed = true;</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-            break;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-          }</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+      for (auto account : m_accounts) {</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; existingIdentities;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+        account-&gt;GetIdentities(existingIdentities);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+        auto pos = existingIdentities.IndexOf(identity);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+        if (pos != existingIdentities.NoIndex) {</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+          identityStillUsed = true;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+          break;</span>
<a href="#l19.79"></a><span id="l19.79">         }</span>
<a href="#l19.80"></a><span id="l19.80">       }</span>
<a href="#l19.81"></a><span id="l19.81">       // clear out all identity information if no other account uses it.</span>
<a href="#l19.82"></a><span id="l19.82">       if (!identityStillUsed) identity-&gt;ClearAllValues();</span>
<a href="#l19.83"></a><span id="l19.83">     }</span>
<a href="#l19.84"></a><span id="l19.84">   }</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86">   // It is not a critical problem if this fails as the account was already</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineat">@@ -852,30 +842,22 @@ nsMsgAccountManager::GetAccounts(nsTArra</span>
<a href="#l19.88"></a><span id="l19.88"> NS_IMETHODIMP</span>
<a href="#l19.89"></a><span id="l19.89"> nsMsgAccountManager::GetAllIdentities(</span>
<a href="#l19.90"></a><span id="l19.90">     nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; &amp;result) {</span>
<a href="#l19.91"></a><span id="l19.91">   nsresult rv = LoadAccounts();</span>
<a href="#l19.92"></a><span id="l19.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94">   result.Clear();</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-</span>
<a href="#l19.98"></a><span id="l19.98">   for (auto account : m_accounts) {</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-    rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+    rv = account-&gt;GetIdentities(identities);</span>
<a href="#l19.102"></a><span id="l19.102">     if (NS_FAILED(rv)) continue;</span>
<a href="#l19.103"></a><span id="l19.103"> </span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-    uint32_t idCount;</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    rv = identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-    for (uint32_t j = 0; j &lt; idCount; ++j) {</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-      if (NS_FAILED(rv)) continue;</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+    for (auto identity : identities) {</span>
<a href="#l19.113"></a><span id="l19.113">       // Have we already got this identity?</span>
<a href="#l19.114"></a><span id="l19.114">       nsAutoCString key;</span>
<a href="#l19.115"></a><span id="l19.115">       rv = identity-&gt;GetKey(key);</span>
<a href="#l19.116"></a><span id="l19.116">       if (NS_FAILED(rv)) continue;</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118">       bool found = false;</span>
<a href="#l19.119"></a><span id="l19.119">       for (auto thisIdentity : result) {</span>
<a href="#l19.120"></a><span id="l19.120">         nsAutoCString thisKey;</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineat">@@ -1099,18 +1081,18 @@ nsresult nsMsgAccountManager::LoadAccoun</span>
<a href="#l19.122"></a><span id="l19.122">     unavailablePref.AppendLiteral(&quot;.timeFoundUnavailable&quot;);</span>
<a href="#l19.123"></a><span id="l19.123">     toLeavePref.AppendLiteral(&quot;.secondsToLeaveUnavailable&quot;);</span>
<a href="#l19.124"></a><span id="l19.124">     int32_t secondsToLeave = 0;</span>
<a href="#l19.125"></a><span id="l19.125">     int32_t timeUnavailable = 0;</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127">     m_prefs-&gt;GetIntPref(toLeavePref.get(), &amp;secondsToLeave);</span>
<a href="#l19.128"></a><span id="l19.128"> </span>
<a href="#l19.129"></a><span id="l19.129">     // force load of accounts (need to find a better way to do this)</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-    account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; unused;</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+    account-&gt;GetIdentities(unused);</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">     rv = account-&gt;CreateServer();</span>
<a href="#l19.136"></a><span id="l19.136">     bool deleteAccount = NS_FAILED(rv);</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138">     if (secondsToLeave) {    // we need to process timeUnavailable</span>
<a href="#l19.139"></a><span id="l19.139">       if (NS_SUCCEEDED(rv))  // clear the time if server is available</span>
<a href="#l19.140"></a><span id="l19.140">       {</span>
<a href="#l19.141"></a><span id="l19.141">         m_prefs-&gt;ClearUserPref(unavailablePref.get());</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineat">@@ -1893,29 +1875,20 @@ nsMsgAccountManager::GetIdentitiesForSer</span>
<a href="#l19.143"></a><span id="l19.143">   for (auto account : m_accounts) {</span>
<a href="#l19.144"></a><span id="l19.144">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l19.145"></a><span id="l19.145">     rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l19.146"></a><span id="l19.146">     if (NS_FAILED(rv) || !thisServer) continue;</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148">     nsAutoCString thisServerKey;</span>
<a href="#l19.149"></a><span id="l19.149">     rv = thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l19.150"></a><span id="l19.150">     if (serverKey.Equals(thisServerKey)) {</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-      nsCOMPtr&lt;nsIArray&gt; theseIdentities;</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-      rv = account-&gt;GetIdentities(getter_AddRefs(theseIdentities));</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-        uint32_t theseLength;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-        rv = theseIdentities-&gt;GetLength(&amp;theseLength);</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-          for (uint32_t j = 0; j &lt; theseLength; ++j) {</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-            nsCOMPtr&lt;nsIMsgIdentity&gt; id(</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-                do_QueryElementAt(theseIdentities, j, &amp;rv));</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-            if (NS_SUCCEEDED(rv)) identities.AppendElement(id);</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-          }</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-        }</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-      }</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; theseIdentities;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+      rv = account-&gt;GetIdentities(theseIdentities);</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+      identities.AppendElements(theseIdentities);</span>
<a href="#l19.168"></a><span id="l19.168">     }</span>
<a href="#l19.169"></a><span id="l19.169">   }</span>
<a href="#l19.170"></a><span id="l19.170">   return NS_OK;</span>
<a href="#l19.171"></a><span id="l19.171"> }</span>
<a href="#l19.172"></a><span id="l19.172"> </span>
<a href="#l19.173"></a><span id="l19.173"> NS_IMETHODIMP</span>
<a href="#l19.174"></a><span id="l19.174"> nsMsgAccountManager::GetServersForIdentity(</span>
<a href="#l19.175"></a><span id="l19.175">     nsIMsgIdentity *aIdentity,</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineat">@@ -1923,39 +1896,31 @@ nsMsgAccountManager::GetServersForIdenti</span>
<a href="#l19.177"></a><span id="l19.177">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l19.178"></a><span id="l19.178">   servers.Clear();</span>
<a href="#l19.179"></a><span id="l19.179"> </span>
<a href="#l19.180"></a><span id="l19.180">   nsresult rv;</span>
<a href="#l19.181"></a><span id="l19.181">   rv = LoadAccounts();</span>
<a href="#l19.182"></a><span id="l19.182">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.183"></a><span id="l19.183"> </span>
<a href="#l19.184"></a><span id="l19.184">   for (auto account : m_accounts) {</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-    if (NS_FAILED(account-&gt;GetIdentities(getter_AddRefs(identities)))) continue;</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-    uint32_t idCount = 0;</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-    if (NS_FAILED(identities-&gt;GetLength(&amp;idCount))) continue;</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-    uint32_t id;</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+    if (NS_FAILED(account-&gt;GetIdentities(identities))) continue;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+</span>
<a href="#l19.195"></a><span id="l19.195">     nsCString identityKey;</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-    rv = aIdentity-&gt;GetKey(identityKey);</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-    for (id = 0; id &lt; idCount; id++) {</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-          do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-        nsCString thisIdentityKey;</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-        rv = thisIdentity-&gt;GetKey(thisIdentityKey);</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey)) {</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-          rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-          if (thisServer &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-            servers.AppendElement(thisServer);</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-            break;</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-          }</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+    aIdentity-&gt;GetKey(identityKey);</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+    for (auto thisIdentity : identities) {</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+      nsCString thisIdentityKey;</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineplus">+      rv = thisIdentity-&gt;GetKey(thisIdentityKey);</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey)) {</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+        rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+        if (thisServer &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+          servers.AppendElement(thisServer);</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+          break;</span>
<a href="#l19.222"></a><span id="l19.222">         }</span>
<a href="#l19.223"></a><span id="l19.223">       }</span>
<a href="#l19.224"></a><span id="l19.224">     }</span>
<a href="#l19.225"></a><span id="l19.225">   }</span>
<a href="#l19.226"></a><span id="l19.226">   return NS_OK;</span>
<a href="#l19.227"></a><span id="l19.227"> }</span>
<a href="#l19.228"></a><span id="l19.228"> </span>
<a href="#l19.229"></a><span id="l19.229"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -371,25 +371,19 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l20.4"></a><span id="l20.4">       nsAutoCString deferredToAccountKey;</span>
<a href="#l20.5"></a><span id="l20.5">       if (loopServer)</span>
<a href="#l20.6"></a><span id="l20.6">         loopServer-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccountKey);</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">       // Add the emails for any account that defers to this one, or for the</span>
<a href="#l20.9"></a><span id="l20.9">       // account itself.</span>
<a href="#l20.10"></a><span id="l20.10">       if (accountKey.Equals(deferredToAccountKey) ||</span>
<a href="#l20.11"></a><span id="l20.11">           accountKey.Equals(loopAccountKey)) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-        loopAccount-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-        if (!identities) continue;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-        uint32_t identityCount = 0;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-        identities-&gt;GetLength(&amp;identityCount);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-        for (uint32_t j = 0; j &lt; identityCount; ++j) {</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIdentity&gt; identity(</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-              do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-          if (NS_FAILED(rv) || !identity) continue;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+        loopAccount-&gt;GetIdentities(identities);</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+        for (auto identity : identities) {</span>
<a href="#l20.24"></a><span id="l20.24">           nsAutoCString email;</span>
<a href="#l20.25"></a><span id="l20.25">           identity-&gt;GetEmail(email);</span>
<a href="#l20.26"></a><span id="l20.26">           if (!email.IsEmpty()) mEmails.AppendElement(email);</span>
<a href="#l20.27"></a><span id="l20.27">         }</span>
<a href="#l20.28"></a><span id="l20.28">       }</span>
<a href="#l20.29"></a><span id="l20.29">     }</span>
<a href="#l20.30"></a><span id="l20.30">   }</span>
<a href="#l20.31"></a><span id="l20.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -61,9 +61,18 @@ add_task(async function() {</span>
<a href="#l21.4"></a><span id="l21.4">   Assert.equal(mgr.getServersForIdentity(id2).length, 1);</span>
<a href="#l21.5"></a><span id="l21.5">   // id3 is shared.</span>
<a href="#l21.6"></a><span id="l21.6">   Assert.equal(mgr.getServersForIdentity(id3).length, 2);</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   // Does allFolders return the default folders we'd expect?</span>
<a href="#l21.9"></a><span id="l21.9">   // IMAP has Inbox only.</span>
<a href="#l21.10"></a><span id="l21.10">   // POP3 and local accounts both have Inbox and Trash.</span>
<a href="#l21.11"></a><span id="l21.11">   Assert.equal(mgr.allFolders.length, 1 + 2 + 2);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  // Let's ditch the IMAP account.</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  mgr.removeAccount(acc1);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+  Assert.equal(mgr.accounts.length, 2);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  Assert.equal(mgr.allServers.length, 2);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  // It should have taken the imap-specific identity with it.</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+  Assert.equal(mgr.allIdentities.length, 2);</span>
<a href="#l21.21"></a><span id="l21.21"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -2452,29 +2452,18 @@ QuotingOutputStreamListener::OnStopReque</span>
<a href="#l22.4"></a><span id="l22.4">         // Check all available identities if the pref was set.</span>
<a href="#l22.5"></a><span id="l22.5">         accountManager-&gt;GetAllIdentities(identities);</span>
<a href="#l22.6"></a><span id="l22.6">       } else if (!accountKey.IsEmpty()) {</span>
<a href="#l22.7"></a><span id="l22.7">         // Check headers to see which account the message came in from</span>
<a href="#l22.8"></a><span id="l22.8">         // (only works for pop3).</span>
<a href="#l22.9"></a><span id="l22.9">         nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l22.10"></a><span id="l22.10">         accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l22.11"></a><span id="l22.11">         if (account) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-          // TODO: Bug 1614846 - stopgap until nsIAccount.getIdentities() takes</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-          // nsTArray&lt;&gt;.</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-          nsCOMPtr&lt;nsIArray&gt; tmp;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-          rv = account-&gt;GetIdentities(getter_AddRefs(tmp));</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+          rv = account-&gt;GetIdentities(identities);</span>
<a href="#l22.17"></a><span id="l22.17">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-          uint32_t numElements;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-          rv = tmp-&gt;GetLength(&amp;numElements);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-          for (uint32_t i = 0; i &lt; numElements; i++) {</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-            nsCOMPtr&lt;nsIMsgIdentity&gt; ident = do_QueryElementAt(tmp, i, &amp;rv);</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-            identities.AppendElement(ident);</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-          }</span>
<a href="#l22.26"></a><span id="l22.26">         }</span>
<a href="#l22.27"></a><span id="l22.27">       } else {</span>
<a href="#l22.28"></a><span id="l22.28">         // Check identities only for the server of the folder that the message</span>
<a href="#l22.29"></a><span id="l22.29">         // is in.</span>
<a href="#l22.30"></a><span id="l22.30">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l22.31"></a><span id="l22.31">         rv = mOrigMsgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l22.32"></a><span id="l22.32"> </span>
<a href="#l22.33"></a><span id="l22.33">         if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -824,36 +824,31 @@ NS_IMETHODIMP nsMsgComposeService::Reply</span>
<a href="#l23.4"></a><span id="l23.4">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.5"></a><span id="l23.5">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.6"></a><span id="l23.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l23.9"></a><span id="l23.9">   rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l23.10"></a><span id="l23.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+  rv = account-&gt;GetIdentities(identities);</span>
<a href="#l23.16"></a><span id="l23.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18">   nsAutoCString recipients;</span>
<a href="#l23.19"></a><span id="l23.19">   aMsgHdr-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   nsAutoCString ccList;</span>
<a href="#l23.22"></a><span id="l23.22">   aMsgHdr-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">   // Go through the identities to see to whom this was addressed.</span>
<a href="#l23.25"></a><span id="l23.25">   // In case we get no match, this is likely a list/bulk/bcc/spam mail and we</span>
<a href="#l23.26"></a><span id="l23.26">   // shouldn't reply. RFC 3834 2.</span>
<a href="#l23.27"></a><span id="l23.27">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;  // identity to reply from</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-  uint32_t count = 0;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-  identities-&gt;GetLength(&amp;count);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; anIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  for (auto anIdentity : identities) {</span>
<a href="#l23.35"></a><span id="l23.35">     nsAutoCString identityEmail;</span>
<a href="#l23.36"></a><span id="l23.36">     anIdentity-&gt;GetEmail(identityEmail);</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">     if (recipients.Find(identityEmail, /* ignoreCase = */ true) != kNotFound ||</span>
<a href="#l23.39"></a><span id="l23.39">         ccList.Find(identityEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l23.40"></a><span id="l23.40">       identity = anIdentity;</span>
<a href="#l23.41"></a><span id="l23.41">       break;</span>
<a href="#l23.42"></a><span id="l23.42">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -524,17 +524,17 @@ SettingsImportHelper.prototype = {</span>
<a href="#l24.4"></a><span id="l24.4">       );</span>
<a href="#l24.5"></a><span id="l24.5">     }</span>
<a href="#l24.6"></a><span id="l24.6">   },</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8">   _checkAccount(expected, actual) {</span>
<a href="#l24.9"></a><span id="l24.9">     this._checkIncomingServer(expected.incomingServer, actual.incomingServer);</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11">     Assert.equal(1, actual.identities.length);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    let actualIdentity = actual.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    let actualIdentity = actual.identities[0];</span>
<a href="#l24.14"></a><span id="l24.14">     this._checkIdentity(expected.identity, actualIdentity);</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16">     if (expected.incomingServer.type != &quot;nntp&quot;) {</span>
<a href="#l24.17"></a><span id="l24.17">       let actualSmtpServer = MailServices.smtp.getServerByKey(</span>
<a href="#l24.18"></a><span id="l24.18">         actualIdentity.smtpServerKey</span>
<a href="#l24.19"></a><span id="l24.19">       );</span>
<a href="#l24.20"></a><span id="l24.20">       this._checkSmtpServer(expected.smtpServer, actualSmtpServer);</span>
<a href="#l24.21"></a><span id="l24.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/suite/mailnews/components/compose/content/MsgComposeCommands.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/suite/mailnews/components/compose/content/MsgComposeCommands.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.5"></a><span id="l25.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.8"></a><span id="l25.8"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l25.9"></a><span id="l25.9"> const {PluralForm} = ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l25.10"></a><span id="l25.10"> ChromeUtils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l25.11"></a><span id="l25.11"> const {allAccountsSorted} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-const {fixIterator, toArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13"> const {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> /**</span>
<a href="#l25.16"></a><span id="l25.16">  * interfaces</span>
<a href="#l25.17"></a><span id="l25.17">  */</span>
<a href="#l25.18"></a><span id="l25.18"> var nsIMsgCompDeliverMode = Ci.nsIMsgCompDeliverMode;</span>
<a href="#l25.19"></a><span id="l25.19"> var nsIMsgCompSendFormat = Ci.nsIMsgCompSendFormat;</span>
<a href="#l25.20"></a><span id="l25.20"> var nsIMsgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineat">@@ -1249,17 +1248,17 @@ function ComposeStartup(aParams)</span>
<a href="#l25.22"></a><span id="l25.22">   // An identity with no email is likely not valid.</span>
<a href="#l25.23"></a><span id="l25.23">   if (!params.identity || !params.identity.email) {</span>
<a href="#l25.24"></a><span id="l25.24">     let identities;</span>
<a href="#l25.25"></a><span id="l25.25">     // no pre selected identity, so use the default account</span>
<a href="#l25.26"></a><span id="l25.26">     let defaultAccount = gAccountManager.defaultAccount;</span>
<a href="#l25.27"></a><span id="l25.27">     if (defaultAccount)</span>
<a href="#l25.28"></a><span id="l25.28">       identities = defaultAccount.identities;</span>
<a href="#l25.29"></a><span id="l25.29">     if (identities &amp;&amp; identities.length &gt; 0) {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-      params.identity = identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+      params.identity = identities[0];</span>
<a href="#l25.32"></a><span id="l25.32">     } else {</span>
<a href="#l25.33"></a><span id="l25.33">       // Get the first identity we have in the list.</span>
<a href="#l25.34"></a><span id="l25.34">       let identitykey = identityList.getItemAtIndex(0).getAttribute(&quot;identitykey&quot;);</span>
<a href="#l25.35"></a><span id="l25.35">       params.identity = MailServices.accounts.getIdentity(identitykey);</span>
<a href="#l25.36"></a><span id="l25.36">     }</span>
<a href="#l25.37"></a><span id="l25.37">   }</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39">   identityList.selectedItem =</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineat">@@ -2184,18 +2183,17 @@ function ToggleAttachVCard(target)</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42"> function FillIdentityList(menulist)</span>
<a href="#l25.43"></a><span id="l25.43"> {</span>
<a href="#l25.44"></a><span id="l25.44">   var accounts = allAccountsSorted(true);</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   for (let acc = 0; acc &lt; accounts.length; acc++)</span>
<a href="#l25.47"></a><span id="l25.47">   {</span>
<a href="#l25.48"></a><span id="l25.48">     let account = accounts[acc];</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-    let identities = toArray(fixIterator(account.identities,</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-                                         Ci.nsIMsgIdentity));</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+    let identities = account.identities;</span>
<a href="#l25.52"></a><span id="l25.52"> </span>
<a href="#l25.53"></a><span id="l25.53">     if (identities.length == 0)</span>
<a href="#l25.54"></a><span id="l25.54">       continue;</span>
<a href="#l25.55"></a><span id="l25.55"> </span>
<a href="#l25.56"></a><span id="l25.56">     for (let i = 0; i &lt; identities.length; i++)</span>
<a href="#l25.57"></a><span id="l25.57">     {</span>
<a href="#l25.58"></a><span id="l25.58">       let identity = identities[i];</span>
<a href="#l25.59"></a><span id="l25.59">       let item = menulist.appendItem(identity.identityName,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

