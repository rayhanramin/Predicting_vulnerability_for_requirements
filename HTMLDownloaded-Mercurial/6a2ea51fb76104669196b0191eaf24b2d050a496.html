<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9052:6a2ea51fb76104669196b0191eaf24b2d050a496</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6a2ea51fb76104669196b0191eaf24b2d050a496" />
<meta property="og:url" content="/comm-central/rev/6a2ea51fb76104669196b0191eaf24b2d050a496" />
<meta property="og:description" content="Fix bug 586276 - Hooks / stubs mechanisms for Mozilla Lightning. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6a2ea51fb76104669196b0191eaf24b2d050a496 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6a2ea51fb76104669196b0191eaf24b2d050a496">shortlog</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6a2ea51fb76104669196b0191eaf24b2d050a496">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496">files</a> |
changeset |
<a href="/comm-central/raw-rev/6a2ea51fb76104669196b0191eaf24b2d050a496">raw</a>  | <a href="/comm-central/archive/6a2ea51fb76104669196b0191eaf24b2d050a496.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586276">bug 586276</a> - Hooks / stubs mechanisms for Mozilla Lightning. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#87;&#111;&#108;&#102;&#103;&#97;&#110;&#103;&#32;&#83;&#111;&#117;&#114;&#100;&#101;&#97;&#117;&#32;&#60;&#119;&#115;&#111;&#117;&#114;&#100;&#101;&#97;&#117;&#64;&#105;&#110;&#118;&#101;&#114;&#115;&#101;&#46;&#99;&#97;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 23 Dec 2011 14:46:55 +0100</td></tr>

<tr>
 <td>changeset 9052</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6a2ea51fb76104669196b0191eaf24b2d050a496">6a2ea51fb76104669196b0191eaf24b2d050a496</a></td>
</tr>



<tr>
<td>parent 9051</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a6e30fd92350bc335fc12335498110b11fbf65fc">a6e30fd92350bc335fc12335498110b11fbf65fc</a>
</td>
</tr>

<tr>
<td>child 9053</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c3df472badcdf84ed021cc789e44c1e60977283f">c3df472badcdf84ed021cc789e44c1e60977283f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6a2ea51fb76104669196b0191eaf24b2d050a496">6933</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Fri, 23 Dec 2011 13:49:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6a2ea51fb761 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6a2ea51fb76104669196b0191eaf24b2d050a496">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6a2ea51fb76104669196b0191eaf24b2d050a496&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&newProject=comm-central&newRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&newProject=comm-central&newRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&newProject=comm-central&newRevision=6a2ea51fb76104669196b0191eaf24b2d050a496&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586276">586276</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586276">bug 586276</a> - Hooks / stubs mechanisms for Mozilla Lightning. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">calendar/base/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">calendar/base/public/calICalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">calendar/base/public/calICalendarACLManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calICalendarACLManager.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">calendar/base/public/calIItemBase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/public/calIItemBase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">calendar/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">calendar/base/src/calDefaultACLManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">calendar/base/src/calDefaultACLManager.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calDefaultACLManager.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">calendar/lightning/content/lightning-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/lightning/content/lightning-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/6a2ea51fb76104669196b0191eaf24b2d050a496/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -30,16 +30,19 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var CalendarDeleteCommandEnabled = false;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+var CalendarNewItemsCommandEnabled = false;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15"> /**</span>
<a href="#l1.16"></a><span id="l1.16">  * Command controller to execute calendar specific commands</span>
<a href="#l1.17"></a><span id="l1.17">  * @see nsICommandController</span>
<a href="#l1.18"></a><span id="l1.18">  */</span>
<a href="#l1.19"></a><span id="l1.19"> var calendarController = {</span>
<a href="#l1.20"></a><span id="l1.20">     defaultController: null,</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     commands: {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -126,40 +129,42 @@ var calendarController = {</span>
<a href="#l1.24"></a><span id="l1.24">         }</span>
<a href="#l1.25"></a><span id="l1.25">         return false;</span>
<a href="#l1.26"></a><span id="l1.26">     },</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">     isCommandEnabled: function cC_isCommandEnabled(aCommand) {</span>
<a href="#l1.29"></a><span id="l1.29">         switch (aCommand) {</span>
<a href="#l1.30"></a><span id="l1.30">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l1.31"></a><span id="l1.31">             case &quot;calendar_new_event_context_command&quot;:</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                return this.writable &amp;&amp; this.calendars_support_events;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                return CalendarNewItemsCommandEnabled &amp;&amp; this.writable &amp;&amp; this.calendars_support_events;</span>
<a href="#l1.34"></a><span id="l1.34">             case &quot;calendar_modify_focused_item_command&quot;:</span>
<a href="#l1.35"></a><span id="l1.35">                 return this.item_selected;</span>
<a href="#l1.36"></a><span id="l1.36">             case &quot;calendar_modify_event_command&quot;:</span>
<a href="#l1.37"></a><span id="l1.37">                 return this.item_selected;</span>
<a href="#l1.38"></a><span id="l1.38">             case &quot;calendar_delete_focused_item_command&quot;:</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                return this.selected_items_writable;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                return CalendarDeleteCommandEnabled &amp;&amp; this.selected_items_writable;</span>
<a href="#l1.41"></a><span id="l1.41">             case &quot;calendar_delete_event_command&quot;:</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-                return this.selected_items_writable;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                return CalendarDeleteCommandEnabled &amp;&amp; this.selected_items_writable;</span>
<a href="#l1.44"></a><span id="l1.44">             case &quot;calendar_new_todo_command&quot;:</span>
<a href="#l1.45"></a><span id="l1.45">             case &quot;calendar_new_todo_context_command&quot;:</span>
<a href="#l1.46"></a><span id="l1.46">             case &quot;calendar_new_todo_todaypane_command&quot;:</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-                return this.writable &amp;&amp; this.calendars_support_tasks;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+                return CalendarNewItemsCommandEnabled &amp;&amp; this.writable &amp;&amp; this.calendars_support_tasks;</span>
<a href="#l1.49"></a><span id="l1.49">             case &quot;calendar_modify_todo_command&quot;:</span>
<a href="#l1.50"></a><span id="l1.50">             case &quot;calendar_modify_todo_todaypane_command&quot;:</span>
<a href="#l1.51"></a><span id="l1.51">                  return this.todo_items_selected;</span>
<a href="#l1.52"></a><span id="l1.52">                  // This code is temporarily commented out due to</span>
<a href="#l1.53"></a><span id="l1.53">                  // bug 469684 Unifinder-todo: raising of the context menu fires blur-event</span>
<a href="#l1.54"></a><span id="l1.54">                  // this.todo_tasktree_focused;</span>
<a href="#l1.55"></a><span id="l1.55">             case &quot;calendar_edit_calendar_command&quot;:</span>
<a href="#l1.56"></a><span id="l1.56">                 return this.isCalendarInForeground();</span>
<a href="#l1.57"></a><span id="l1.57">             case &quot;calendar_task_filter_command&quot;:</span>
<a href="#l1.58"></a><span id="l1.58">                 return true;</span>
<a href="#l1.59"></a><span id="l1.59">             case &quot;calendar_delete_todo_command&quot;:</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                if (!CalendarDeleteCommandEnabled)</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                    return false;</span>
<a href="#l1.62"></a><span id="l1.62">             case &quot;calendar_toggle_completed_command&quot;:</span>
<a href="#l1.63"></a><span id="l1.63">             case &quot;calendar_percentComplete-0_command&quot;:</span>
<a href="#l1.64"></a><span id="l1.64">             case &quot;calendar_percentComplete-25_command&quot;:</span>
<a href="#l1.65"></a><span id="l1.65">             case &quot;calendar_percentComplete-50_command&quot;:</span>
<a href="#l1.66"></a><span id="l1.66">             case &quot;calendar_percentComplete-75_command&quot;:</span>
<a href="#l1.67"></a><span id="l1.67">             case &quot;calendar_percentComplete-100_command&quot;:</span>
<a href="#l1.68"></a><span id="l1.68">             case &quot;calendar_priority-0_command&quot;:</span>
<a href="#l1.69"></a><span id="l1.69">             case &quot;calendar_priority-9_command&quot;:</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineat">@@ -456,21 +461,24 @@ var calendarController = {</span>
<a href="#l1.71"></a><span id="l1.71">     isInMode: function cC_isInMode(mode) {</span>
<a href="#l1.72"></a><span id="l1.72">         switch (mode) {</span>
<a href="#l1.73"></a><span id="l1.73">             case &quot;mail&quot;:</span>
<a href="#l1.74"></a><span id="l1.74">                 return !isCalendarInForeground();</span>
<a href="#l1.75"></a><span id="l1.75">             case &quot;calendar&quot;:</span>
<a href="#l1.76"></a><span id="l1.76">                 return isSunbird() || (gCurrentMode &amp;&amp; gCurrentMode == &quot;calendar&quot;);</span>
<a href="#l1.77"></a><span id="l1.77">             case &quot;task&quot;:</span>
<a href="#l1.78"></a><span id="l1.78">                 return !isSunbird() &amp;&amp; (gCurrentMode &amp;&amp; gCurrentMode == &quot;task&quot;);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-       }</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        }</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        return false;</span>
<a href="#l1.82"></a><span id="l1.82">     },</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84">     onSelectionChanged: function cC_onSelectionChanged(aEvent) {</span>
<a href="#l1.85"></a><span id="l1.85">         var selectedItems = aEvent.detail;</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+        calendarUpdateDeleteCommand(selectedItems);</span>
<a href="#l1.88"></a><span id="l1.88">         calendarController.item_selected = selectedItems &amp;&amp; (selectedItems.length &gt; 0);</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">         let selLength = (selectedItems === undefined ? 0 : selectedItems.length);</span>
<a href="#l1.91"></a><span id="l1.91">         let selected_events_readonly = 0;</span>
<a href="#l1.92"></a><span id="l1.92">         let selected_events_requires_network = 0;</span>
<a href="#l1.93"></a><span id="l1.93">         let selected_events_invitation = 0;</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">         if (selLength &gt; 0) {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineat">@@ -931,8 +939,52 @@ function getSelectedItems() {</span>
<a href="#l1.97"></a><span id="l1.97">  */</span>
<a href="#l1.98"></a><span id="l1.98"> function deleteSelectedItems() {</span>
<a href="#l1.99"></a><span id="l1.99">     if (calendarController.todo_tasktree_focused) {</span>
<a href="#l1.100"></a><span id="l1.100">         deleteToDoCommand();</span>
<a href="#l1.101"></a><span id="l1.101">     } else if (calendarController.isInMode(&quot;calendar&quot;)) {</span>
<a href="#l1.102"></a><span id="l1.102">         deleteSelectedEvents();</span>
<a href="#l1.103"></a><span id="l1.103">     }</span>
<a href="#l1.104"></a><span id="l1.104"> }</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+function calendarUpdateNewItemsCommand() {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    let oldValue = CalendarNewItemsCommandEnabled;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    let commands = [&quot;calendar_new_event_command&quot;,</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+                    &quot;calendar_new_event_context_command&quot;,</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+                    &quot;calendar_new_todo_command&quot;,</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+                    &quot;calendar_new_todo_context_command&quot;,</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+                    &quot;calendar_new_todo_todaypane_command&quot;];</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    CalendarNewItemsCommandEnabled = false;</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    let cal = getSelectedCalendar();</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    if (cal &amp;&amp; isCalendarWritable(cal) &amp;&amp; userCanAddItemsToCalendar(cal)) {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+        CalendarNewItemsCommandEnabled = true;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    }</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    if (CalendarNewItemsCommandEnabled != oldValue) {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+        for (let i = 0; i &lt; commands.length; i++) {</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+            goUpdateCommand(commands[i]);</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+        }</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+}</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+function calendarUpdateDeleteCommand(selectedItems) {</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    let oldValue = CalendarDeleteCommandEnabled;</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+    CalendarDeleteCommandEnabled = (selectedItems.length &gt; 0);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+    for each (let calendar in selectedItems) {</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+        if (!userCanDeleteItemsFromCalendar(calendar)) {</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+            CalendarDeleteCommandEnabled = false;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+        }</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    }</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+    if (CalendarDeleteCommandEnabled != oldValue) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+        let commands = [&quot;calendar_delete_event_command&quot;,</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+                        &quot;calendar_delete_todo_command&quot;,</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+                        &quot;calendar_delete_focused_item_command&quot;,</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+                        &quot;button_delete&quot;,</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+                        &quot;cmd_delete&quot;];</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+        for each (let command in commands) {</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+            goUpdateCommand(command);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+        }</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+    }</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -33,16 +33,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.5"></a><span id="l2.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.6"></a><span id="l2.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.7"></a><span id="l2.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> /**</span>
<a href="#l2.15"></a><span id="l2.15">  * Takes a job and makes sure the dispose function on it is called. If there is</span>
<a href="#l2.16"></a><span id="l2.16">  * no dispose function or the job is null, ignore it.</span>
<a href="#l2.17"></a><span id="l2.17">  *</span>
<a href="#l2.18"></a><span id="l2.18">  * @param job       The job to dispose.</span>
<a href="#l2.19"></a><span id="l2.19">  */</span>
<a href="#l2.20"></a><span id="l2.20"> function disposeJob(job) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -280,31 +281,53 @@ function openEventDialog(calendarItem, c</span>
<a href="#l2.22"></a><span id="l2.22">         isItemSupported = function isEventSupported(aCalendar) {</span>
<a href="#l2.23"></a><span id="l2.23">             return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l2.24"></a><span id="l2.24">         };</span>
<a href="#l2.25"></a><span id="l2.25">     }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">     // Filter out calendars that don't support the given calendar item</span>
<a href="#l2.28"></a><span id="l2.28">     calendars = calendars.filter(isItemSupported);</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    if (mode == &quot;new&quot; &amp;&amp; calendars.length &lt; 1 &amp;&amp;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        (!isCalendarWritable(calendar) || !isItemSupported(calendar))) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-        // There are no writable calendars or no calendar supports the given</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-        // item. Don't show the dialog.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-        disposeJob(job);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-        return;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    } else if (mode == &quot;new&quot; &amp;&amp;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-               (!isCalendarWritable(calendar) || !isItemSupported(calendar))) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-        // Pick the first calendar that supports the item and is writable</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-        calendar = calendars[0];</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-        if (calendarItem) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-            // XXX The dialog currently uses the items calendar as a first</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-            // choice. Since we are shortly before a release to keep regression</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-            // risk low, explicitly set the item's calendar here.</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-            calendarItem.calendar = calendars[0];</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    // Filter out calendar/items that we cannot write to/modify</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    if (mode == &quot;new&quot;) {</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        calendars = calendars.filter(userCanAddItemsToCalendar);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    } else { /* modify */</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+        function calendarCanModifyItems(aCalendar) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+            /* If the calendar is the item calendar, we check that the item</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+             * can be modified. If the calendar is NOT the item calendar, we</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+             * check that the user can remove items from that calendar and</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+             * add items to the current one.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+             */</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+            return (((calendarItem.calendar != aCalendar)</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                     &amp;&amp; userCanDeleteItemsFromCalendar(calendarItem.calendar)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+                     &amp;&amp; userCanAddItemsToCalendar(aCalendar))</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+                    || ((calendarItem.calendar == aCalendar)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+                        &amp;&amp; userCanModifyItem(calendarItem)));</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+        }</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+        calendars = calendars.filter(calendarCanModifyItems);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    }</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    if (mode == &quot;new&quot;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+        &amp;&amp; (!isCalendarWritable(calendar)</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            || !userCanAddItemsToCalendar(calendar)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+            || !isItemSupported(calendar))) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        if (calendars.length &lt; 1) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+            // There are no writable calendars or no calendar supports the given</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+            // item. Don't show the dialog.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+            disposeJob(job);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+            return;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+        } else  {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+            // Pick the first calendar that supports the item and is writable</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+            calendar = calendars[0];</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+            if (calendarItem) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+                // XXX The dialog currently uses the items calendar as a first</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+                // choice. Since we are shortly before a release to keep</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+                // regression risk low, explicitly set the item's calendar here.</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                calendarItem.calendar = calendars[0];</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+            }</span>
<a href="#l2.82"></a><span id="l2.82">         }</span>
<a href="#l2.83"></a><span id="l2.83">     }</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85">     // Setup the window arguments</span>
<a href="#l2.86"></a><span id="l2.86">     var args = new Object();</span>
<a href="#l2.87"></a><span id="l2.87">     args.calendarEvent = calendarItem;</span>
<a href="#l2.88"></a><span id="l2.88">     args.calendar = calendar;</span>
<a href="#l2.89"></a><span id="l2.89">     args.mode = mode;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineat">@@ -325,22 +348,26 @@ function openEventDialog(calendarItem, c</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">     // ask the provide if this item is an invitation. if this is the case</span>
<a href="#l2.93"></a><span id="l2.93">     // we'll open the summary dialog since the user is not allowed to change</span>
<a href="#l2.94"></a><span id="l2.94">     // the details of the item.</span>
<a href="#l2.95"></a><span id="l2.95">     var isInvitation = false;</span>
<a href="#l2.96"></a><span id="l2.96">     if (calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l2.97"></a><span id="l2.97">         isInvitation = calendar.isInvitation(calendarItem);</span>
<a href="#l2.98"></a><span id="l2.98">     }</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-</span>
<a href="#l2.100"></a><span id="l2.100">     // open the dialog modeless</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    var url = &quot;chrome://calendar/content/calendar-event-dialog.xul&quot;;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    if ((mode != &quot;new&quot; &amp;&amp; isInvitation) || !isCalendarWritable(calendar)) {</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+    let url;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+    if (isCalendarWritable(calendar)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+        &amp;&amp; (mode == &quot;new&quot;</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+            || (mode == &quot;modify&quot; &amp;&amp; !isInvitation &amp;&amp; userCanModifyItem((calendarItem))))) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+        url = &quot;chrome://calendar/content/calendar-event-dialog.xul&quot;;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    } else {</span>
<a href="#l2.109"></a><span id="l2.109">         url = &quot;chrome://calendar/content/calendar-summary-dialog.xul&quot;;</span>
<a href="#l2.110"></a><span id="l2.110">     }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+</span>
<a href="#l2.112"></a><span id="l2.112">     openDialog(url, &quot;_blank&quot;, &quot;chrome,titlebar,resizable&quot;, args);</span>
<a href="#l2.113"></a><span id="l2.113"> }</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115"> /**</span>
<a href="#l2.116"></a><span id="l2.116">  * Prompts the user how the passed item should be modified. If the item is an</span>
<a href="#l2.117"></a><span id="l2.117">  * exception or already a parent item, the item is returned without prompting.</span>
<a href="#l2.118"></a><span id="l2.118">  * If &quot;all occurrences&quot; is specified, the parent item is returned. If &quot;this</span>
<a href="#l2.119"></a><span id="l2.119">  * occurrence only&quot; is specified, then aItem is returned. If &quot;this and following</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -236,16 +236,22 @@ var compositeObserver = {</span>
<a href="#l3.4"></a><span id="l3.4">         // more than one calendar</span>
<a href="#l3.5"></a><span id="l3.5">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l3.6"></a><span id="l3.6">     },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     onCalendarRemoved: function cO_onCalendarRemoved(aCalendar) {</span>
<a href="#l3.9"></a><span id="l3.9">         // Update commands to disallow deleting the last calendar and only</span>
<a href="#l3.10"></a><span id="l3.10">         // allowing reload remote calendars when there are remote calendars.</span>
<a href="#l3.11"></a><span id="l3.11">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    },</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    onDefaultCalendarChanged: function cO_onDefaultCalendarChanged(aNewCalendar) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+        // A new default calendar may mean that the new calendar has different</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+        // ACLs. Make sure the commands are updated.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">     }</span>
<a href="#l3.19"></a><span id="l3.19"> };</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> /**</span>
<a href="#l3.22"></a><span id="l3.22">  * Opens the subscriptions dialog modally.</span>
<a href="#l3.23"></a><span id="l3.23">  */</span>
<a href="#l3.24"></a><span id="l3.24"> function openCalendarSubscriptionsDialog() {</span>
<a href="#l3.25"></a><span id="l3.25">     // the dialog will reset this to auto when it is done loading</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1718,18 +1718,20 @@</span>
<a href="#l4.4"></a><span id="l4.4">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l4.5"></a><span id="l4.5">         &lt;!-- &quot;start&quot;, &quot;end&quot;, &quot;middle&quot; --&gt;</span>
<a href="#l4.6"></a><span id="l4.6">         &lt;parameter name=&quot;aGrabbedElement&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">         &lt;!-- mouse screenX/screenY from the event --&gt;</span>
<a href="#l4.8"></a><span id="l4.8">         &lt;parameter name=&quot;aMouseX&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">         &lt;parameter name=&quot;aMouseY&quot;/&gt;</span>
<a href="#l4.10"></a><span id="l4.10">         &lt;parameter name=&quot;aSnapInt&quot;/&gt;</span>
<a href="#l4.11"></a><span id="l4.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          if (!isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-              aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+          if (!isCalendarWritable(aOccurrence.calendar)</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+              || !userCanModifyItem(aOccurrence)</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+              || (aOccurrence.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence))</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+              || aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l4.18"></a><span id="l4.18">               return;</span>
<a href="#l4.19"></a><span id="l4.19">           }</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">           //dump (&quot;startSweepingToModify\n&quot;);</span>
<a href="#l4.22"></a><span id="l4.22">           this.mDragState = {</span>
<a href="#l4.23"></a><span id="l4.23">               origColumn: this,</span>
<a href="#l4.24"></a><span id="l4.24">               dragOccurrence: aOccurrence,</span>
<a href="#l4.25"></a><span id="l4.25">               mouseOffset: 0,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -310,16 +310,18 @@ function appendCalendarItems(aItem, aCal</span>
<a href="#l5.4"></a><span id="l5.4">     let calendars = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l5.5"></a><span id="l5.5">     let indexToSelect = 0;</span>
<a href="#l5.6"></a><span id="l5.6">     let index = -1;</span>
<a href="#l5.7"></a><span id="l5.7">     for (let i = 0; i &lt; calendars.length; ++i) {</span>
<a href="#l5.8"></a><span id="l5.8">         let calendar = calendars[i];</span>
<a href="#l5.9"></a><span id="l5.9">         if (calendar.id == calendarToUse.id ||</span>
<a href="#l5.10"></a><span id="l5.10">             (calendar &amp;&amp;</span>
<a href="#l5.11"></a><span id="l5.11">              isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+             (userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+              (calendar == aItem.calendar &amp;&amp; userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l5.14"></a><span id="l5.14">              isItemSupported(aItem, calendar))) {</span>
<a href="#l5.15"></a><span id="l5.15">             let menuitem = addMenuItem(aCalendarMenuParent, calendar.name, calendar.name);</span>
<a href="#l5.16"></a><span id="l5.16">             menuitem.calendar = calendar;</span>
<a href="#l5.17"></a><span id="l5.17">             index++;</span>
<a href="#l5.18"></a><span id="l5.18">             if (aOnCommand) {</span>
<a href="#l5.19"></a><span id="l5.19">                 menuitem.setAttribute(&quot;oncommand&quot;, aOnCommand);</span>
<a href="#l5.20"></a><span id="l5.20">             }</span>
<a href="#l5.21"></a><span id="l5.21">             if (aCalendarMenuParent.localName == &quot;menupopup&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -656,16 +656,18 @@ var unifinderTreeView = {</span>
<a href="#l6.4"></a><span id="l6.4">             return;</span>
<a href="#l6.5"></a><span id="l6.5">         }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">         this.doingSelection = true;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">         // If no items were passed, get the selected items from the view.</span>
<a href="#l6.10"></a><span id="l6.10">         aItemArray = aItemArray || currentView().getSelectedItems({});</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+        calendarUpdateDeleteCommand(aItemArray);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14">         /**</span>
<a href="#l6.15"></a><span id="l6.15">          * The following is a brutal hack, caused by</span>
<a href="#l6.16"></a><span id="l6.16">          * http://lxr.mozilla.org/mozilla1.0/source/layout/xul/base/src/tree/src/nsTreeSelection.cpp#555</span>
<a href="#l6.17"></a><span id="l6.17">          * and described in bug 168211</span>
<a href="#l6.18"></a><span id="l6.18">          * http://bugzilla.mozilla.org/show_bug.cgi?id=168211</span>
<a href="#l6.19"></a><span id="l6.19">          * Do NOT remove anything in the next 3 lines, or the selection in the tree will not work.</span>
<a href="#l6.20"></a><span id="l6.20">          */</span>
<a href="#l6.21"></a><span id="l6.21">         this.treeElement.onselect = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -368,17 +368,19 @@</span>
<a href="#l7.4"></a><span id="l7.4">             onMouseOverItem(event);</span>
<a href="#l7.5"></a><span id="l7.5">         }</span>
<a href="#l7.6"></a><span id="l7.6">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.7"></a><span id="l7.7">       &lt;handler event=&quot;draggesture&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.8"></a><span id="l7.8">         if( event.target.localName == &quot;calendar-event-box&quot;) {</span>
<a href="#l7.9"></a><span id="l7.9">             return;</span>
<a href="#l7.10"></a><span id="l7.10">         }</span>
<a href="#l7.11"></a><span id="l7.11">         let item = this.occurrence;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        if (!isCalendarWritable(item.calendar)) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        if (!isCalendarWritable(item.calendar)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+            || !userCanModifyItem(item)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+            || (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item))) {</span>
<a href="#l7.16"></a><span id="l7.16">             return;</span>
<a href="#l7.17"></a><span id="l7.17">         }</span>
<a href="#l7.18"></a><span id="l7.18">         if (!this.selected)</span>
<a href="#l7.19"></a><span id="l7.19">             this.select(event);</span>
<a href="#l7.20"></a><span id="l7.20">         invokeEventDragSession(item, this);</span>
<a href="#l7.21"></a><span id="l7.21">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.22"></a><span id="l7.22">     &lt;/handlers&gt;</span>
<a href="#l7.23"></a><span id="l7.23">   &lt;/binding&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1920,16 +1920,22 @@ function attachmentLinkClicked(event) {</span>
<a href="#l8.4"></a><span id="l8.4">  * Update the dialog controls related related to the item's calendar.</span>
<a href="#l8.5"></a><span id="l8.5">  */</span>
<a href="#l8.6"></a><span id="l8.6"> function updateCalendar() {</span>
<a href="#l8.7"></a><span id="l8.7">     let item = window.calendarItem;</span>
<a href="#l8.8"></a><span id="l8.8">     let calendar = getCurrentCalendar();</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">     gIsReadOnly = calendar.readOnly;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    // We might have to change the organizer, let's see</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    if (window.organizer) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+      window.organizer.id = calendar.getProperty(&quot;organizerId&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+      window.organizer.commonName = calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    }</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18">     if (!canNotifyAttendees(calendar, item) &amp;&amp; calendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l8.19"></a><span id="l8.19">         enableElement(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l8.20"></a><span id="l8.20">     } else {</span>
<a href="#l8.21"></a><span id="l8.21">         disableElement(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l8.22"></a><span id="l8.22">     }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">     // update the accept button</span>
<a href="#l8.25"></a><span id="l8.25">     updateAccept();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineat">@@ -2222,17 +2228,17 @@ function updateToDoStatus(status, passed</span>
<a href="#l8.27"></a><span id="l8.27">           disableElement(&quot;percent-complete-textbox&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">           disableElement(&quot;percent-complete-label&quot;);</span>
<a href="#l8.29"></a><span id="l8.29">           break;</span>
<a href="#l8.30"></a><span id="l8.30">       case &quot;COMPLETED&quot;:</span>
<a href="#l8.31"></a><span id="l8.31">           document.getElementById(&quot;todo-status&quot;).selectedIndex = 3;</span>
<a href="#l8.32"></a><span id="l8.32">           enableElement(&quot;percent-complete-textbox&quot;);</span>
<a href="#l8.33"></a><span id="l8.33">           enableElement(&quot;percent-complete-label&quot;);</span>
<a href="#l8.34"></a><span id="l8.34">           // if there isn't a completedDate, set it to the previous value</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-          if (!completedDate) { </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+          if (!completedDate) {</span>
<a href="#l8.37"></a><span id="l8.37">               completedDate = oldCompletedDate;</span>
<a href="#l8.38"></a><span id="l8.38">           }</span>
<a href="#l8.39"></a><span id="l8.39">           break;</span>
<a href="#l8.40"></a><span id="l8.40">       case &quot;IN-PROCESS&quot;:</span>
<a href="#l8.41"></a><span id="l8.41">           document.getElementById(&quot;todo-status&quot;).selectedIndex = 2;</span>
<a href="#l8.42"></a><span id="l8.42">           disableElement(&quot;completed-date-picker&quot;);</span>
<a href="#l8.43"></a><span id="l8.43">           enableElement(&quot;percent-complete-textbox&quot;);</span>
<a href="#l8.44"></a><span id="l8.44">           enableElement(&quot;percent-complete-label&quot;);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineat">@@ -2288,16 +2294,29 @@ function saveItem() {</span>
<a href="#l8.46"></a><span id="l8.46">         let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l8.47"></a><span id="l8.47">         if (notifyCheckbox.disabled || document.getElementById(&quot;event-grid-attendee-row-2&quot;).collapsed) {</span>
<a href="#l8.48"></a><span id="l8.48">             item.deleteProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l8.49"></a><span id="l8.49">         } else {</span>
<a href="#l8.50"></a><span id="l8.50">             item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, notifyCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l8.51"></a><span id="l8.51">         }</span>
<a href="#l8.52"></a><span id="l8.52">     }</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    // We check if the organizerID is different from our</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    // calendar-user-address-set. The organzerID is the owner of the calendar.</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    // If it's different, that is because someone is acting on behalf of</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    // the organizer.</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    if (item.organizer &amp;&amp; item.calendar.aclEntry) {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+        let userAddresses = item.calendar.aclEntry.getUserAddresses({});</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+        if (userAddresses.length &gt; 0</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+            &amp;&amp; !cal.attendeeMatchesAddresses(item.organizer, userAddresses)) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+            let organizer = item.organizer.clone();</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+            organizer.setProperty(&quot;SENT-BY&quot;, userAddresses[0]);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+            item.organizer = organizer;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+        }</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    }</span>
<a href="#l8.67"></a><span id="l8.67">     return item;</span>
<a href="#l8.68"></a><span id="l8.68"> }</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70"> /**</span>
<a href="#l8.71"></a><span id="l8.71">  * Action to take when the user chooses to save. This can happen either by</span>
<a href="#l8.72"></a><span id="l8.72">  * saving directly or the user selecting to save after being prompted when</span>
<a href="#l8.73"></a><span id="l8.73">  * closing the dialog.</span>
<a href="#l8.74"></a><span id="l8.74">  *</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineat">@@ -2408,17 +2427,17 @@ function onCommandDeleteItem() {</span>
<a href="#l8.76"></a><span id="l8.76">             }</span>
<a href="#l8.77"></a><span id="l8.77">         };</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79">         if (window.calendarItem.parentItem.recurrenceInfo &amp;&amp; window.calendarItem.recurrenceId) {</span>
<a href="#l8.80"></a><span id="l8.80">             // if this is a single occurrence of a recurring item</span>
<a href="#l8.81"></a><span id="l8.81">             let newItem = window.calendarItem.parentItem.clone();</span>
<a href="#l8.82"></a><span id="l8.82">             newItem.recurrenceInfo.removeOccurrenceAt(window.calendarItem.recurrenceId);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-            window.opener.doTransaction(&quot;modify&quot;, newItem, newItem.calendar, </span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+            window.opener.doTransaction(&quot;modify&quot;, newItem, newItem.calendar,</span>
<a href="#l8.86"></a><span id="l8.86">                                         window.calendarItem.parentItem, deleteListener);</span>
<a href="#l8.87"></a><span id="l8.87">         } else {</span>
<a href="#l8.88"></a><span id="l8.88">             window.opener.doTransaction(&quot;delete&quot;, window.calendarItem, window.calendarItem.calendar,</span>
<a href="#l8.89"></a><span id="l8.89">                                         null, deleteListener);</span>
<a href="#l8.90"></a><span id="l8.90">         }</span>
<a href="#l8.91"></a><span id="l8.91">     } else {</span>
<a href="#l8.92"></a><span id="l8.92">         gConfirmCancel = false;</span>
<a href="#l8.93"></a><span id="l8.93">         document.documentElement.cancelDialog();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -69,27 +69,31 @@ function onLoad() {</span>
<a href="#l9.4"></a><span id="l9.4">             self.onAccept();</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">             let item = window.calendarItem;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">             // ...and close the window.</span>
<a href="#l9.9"></a><span id="l9.9">             window.close();</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">             return item;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        }</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+        };</span>
<a href="#l9.14"></a><span id="l9.14">     }</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16">     // set the dialog-id to enable the right window-icon to be loaded.</span>
<a href="#l9.17"></a><span id="l9.17">     if (cal.isEvent(item)) {</span>
<a href="#l9.18"></a><span id="l9.18">         setDialogId(document.documentElement, &quot;calendar-event-summary-dialog&quot;);</span>
<a href="#l9.19"></a><span id="l9.19">     } else if (cal.isToDo(item)) {</span>
<a href="#l9.20"></a><span id="l9.20">         setDialogId(document.documentElement, &quot;calendar-task-summary-dialog&quot;);</span>
<a href="#l9.21"></a><span id="l9.21">     }</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    window.readOnly = calendar.readOnly;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    window.readOnly = !(isCalendarWritable(calendar)</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+                        &amp;&amp; (userCanModifyItem(item)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+                            || (calInstanceOf(item.calendar, Components.interfaces.calISchedulingSupport)</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+                                &amp;&amp; item.calendar.isInvitation(item)</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+                                &amp;&amp; userCanRespondToInvitation(item))));</span>
<a href="#l9.29"></a><span id="l9.29">     if (!window.readOnly &amp;&amp; calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l9.30"></a><span id="l9.30">         var attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l9.31"></a><span id="l9.31">         if (attendee) {</span>
<a href="#l9.32"></a><span id="l9.32">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l9.33"></a><span id="l9.33">             if (!item.getAlarms({}).length &amp;&amp;</span>
<a href="#l9.34"></a><span id="l9.34">                 (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l9.35"></a><span id="l9.35">                 cal.alarms.setDefaultValues(item);</span>
<a href="#l9.36"></a><span id="l9.36">             }</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineat">@@ -186,18 +190,18 @@ function onLoad() {</span>
<a href="#l9.38"></a><span id="l9.38">     }</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">     window.focus();</span>
<a href="#l9.41"></a><span id="l9.41">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l9.42"></a><span id="l9.42"> }</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> /**</span>
<a href="#l9.45"></a><span id="l9.45">  * Saves any changed information to the item.</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">- * </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">- * @return      Returns true if the dialog </span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ *</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+ * @return      Returns true if the dialog</span>
<a href="#l9.50"></a><span id="l9.50">  */</span>
<a href="#l9.51"></a><span id="l9.51"> function onAccept() {</span>
<a href="#l9.52"></a><span id="l9.52">     dispose();</span>
<a href="#l9.53"></a><span id="l9.53">     if (window.readOnly) {</span>
<a href="#l9.54"></a><span id="l9.54">         return true;</span>
<a href="#l9.55"></a><span id="l9.55">     }</span>
<a href="#l9.56"></a><span id="l9.56">     var args = window.arguments[0];</span>
<a href="#l9.57"></a><span id="l9.57">     var oldItem = args.calendarEvent;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineat">@@ -263,33 +267,33 @@ function updateRepeatDetails() {</span>
<a href="#l9.59"></a><span id="l9.59">     // set recurrence info. bail out if there's more</span>
<a href="#l9.60"></a><span id="l9.60">     // than a single rule or something other than a rule.</span>
<a href="#l9.61"></a><span id="l9.61">     var recurrenceInfo = item.recurrenceInfo;</span>
<a href="#l9.62"></a><span id="l9.62">     if (!recurrenceInfo) {</span>
<a href="#l9.63"></a><span id="l9.63">         return;</span>
<a href="#l9.64"></a><span id="l9.64">     }</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">     document.getElementById(&quot;repeat-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+</span>
<a href="#l9.69"></a><span id="l9.69">     // First of all collapse the details text. If we fail to</span>
<a href="#l9.70"></a><span id="l9.70">     // create a details string, we simply don't show anything.</span>
<a href="#l9.71"></a><span id="l9.71">     // this could happen if the repeat rule is something exotic</span>
<a href="#l9.72"></a><span id="l9.72">     // we don't have any strings prepared for.</span>
<a href="#l9.73"></a><span id="l9.73">     var repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l9.74"></a><span id="l9.74">     repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    </span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+</span>
<a href="#l9.77"></a><span id="l9.77">     // Try to create a descriptive string from the rule(s).</span>
<a href="#l9.78"></a><span id="l9.78">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l9.79"></a><span id="l9.79">     var startDate =  item.startDate || item.entryDate;</span>
<a href="#l9.80"></a><span id="l9.80">     var endDate = item.endDate || item.dueDate;</span>
<a href="#l9.81"></a><span id="l9.81">     startDate = startDate ? startDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l9.82"></a><span id="l9.82">     endDate = endDate ? endDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l9.83"></a><span id="l9.83">     var detailsString = recurrenceRule2String(</span>
<a href="#l9.84"></a><span id="l9.84">         recurrenceInfo, startDate, endDate, startDate.isDate);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-        </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+</span>
<a href="#l9.87"></a><span id="l9.87">     // Now display the string...</span>
<a href="#l9.88"></a><span id="l9.88">     if (detailsString) {</span>
<a href="#l9.89"></a><span id="l9.89">         var lines = detailsString.split(&quot;\n&quot;);</span>
<a href="#l9.90"></a><span id="l9.90">         repeatDetails.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l9.91"></a><span id="l9.91">         while (repeatDetails.childNodes.length &gt; lines.length) {</span>
<a href="#l9.92"></a><span id="l9.92">             repeatDetails.removeChild(repeatDetails.lastChild);</span>
<a href="#l9.93"></a><span id="l9.93">         }</span>
<a href="#l9.94"></a><span id="l9.94">         var numChilds = repeatDetails.childNodes.length;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -176,24 +176,28 @@ cal.itip = {</span>
<a href="#l10.4"></a><span id="l10.4">         if (imipMethod &amp;&amp; imipMethod.length != 0 &amp;&amp; imipMethod.toLowerCase() != &quot;nomethod&quot;) {</span>
<a href="#l10.5"></a><span id="l10.5">             itipItem.receivedMethod = imipMethod.toUpperCase();</span>
<a href="#l10.6"></a><span id="l10.6">         } else { // There is no METHOD in the content-type header (spec violation).</span>
<a href="#l10.7"></a><span id="l10.7">                  // Fall back to using the one from the itipItem's ICS.</span>
<a href="#l10.8"></a><span id="l10.8">             imipMethod = itipItem.receivedMethod;</span>
<a href="#l10.9"></a><span id="l10.9">         }</span>
<a href="#l10.10"></a><span id="l10.10">         cal.LOG(&quot;iTIP method: &quot; + imipMethod);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        let writableCalendars = cal.getCalendarManager().getCalendars({}).filter(cal.itip.isSchedulingCalendar);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        function isWritableCalendar(aCalendar) {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+            /* TODO: missing ACL check for existing items (require callback API) */</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+            return (cal.itip.isSchedulingCalendar(aCalendar)</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                    &amp;&amp; cal.userCanAddItemsToCalendar(aCalendar));</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+        }</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+        let writableCalendars = cal.getCalendarManager().getCalendars({}).filter(isWritableCalendar);</span>
<a href="#l10.19"></a><span id="l10.19">         if (writableCalendars.length &gt; 0) {</span>
<a href="#l10.20"></a><span id="l10.20">             let compCal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l10.21"></a><span id="l10.21">                                     .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l10.22"></a><span id="l10.22">             writableCalendars.forEach(compCal.addCalendar, compCal);</span>
<a href="#l10.23"></a><span id="l10.23">             itipItem.targetCalendar = compCal;</span>
<a href="#l10.24"></a><span id="l10.24">         }</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-</span>
<a href="#l10.26"></a><span id="l10.26">     },</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">     /**</span>
<a href="#l10.29"></a><span id="l10.29">      * Scope: iTIP message receiver</span>
<a href="#l10.30"></a><span id="l10.30">      *</span>
<a href="#l10.31"></a><span id="l10.31">      * Gets the suggested text to be shown when an imip item has been processed.</span>
<a href="#l10.32"></a><span id="l10.32">      * This text is ready localized and can be displayed to the user.</span>
<a href="#l10.33"></a><span id="l10.33">      *</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineat">@@ -434,17 +438,17 @@ cal.itip = {</span>
<a href="#l10.35"></a><span id="l10.35">             case &quot;REFRESH&quot;:</span>
<a href="#l10.36"></a><span id="l10.36">             case &quot;REQUEST:UPDATE&quot;:</span>
<a href="#l10.37"></a><span id="l10.37">             case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l10.38"></a><span id="l10.38">             case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l10.39"></a><span id="l10.39">             case &quot;REPLY&quot;:</span>
<a href="#l10.40"></a><span id="l10.40">             case &quot;CANCEL&quot;:</span>
<a href="#l10.41"></a><span id="l10.41">                 needsCalendar = false;</span>
<a href="#l10.42"></a><span id="l10.42">                 break;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-            default: </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+            default:</span>
<a href="#l10.45"></a><span id="l10.45">                 needsCalendar = true;</span>
<a href="#l10.46"></a><span id="l10.46">                 break;</span>
<a href="#l10.47"></a><span id="l10.47">         }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">         if (needsCalendar) {</span>
<a href="#l10.50"></a><span id="l10.50">             let calendars = cal.getCalendarManager().getCalendars({}).filter(cal.itip.isSchedulingCalendar);</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52">             if (aItipItem.receivedMethod == &quot;REQUEST&quot;) {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineat">@@ -475,17 +479,17 @@ cal.itip = {</span>
<a href="#l10.54"></a><span id="l10.54">                 args.calendars = calendars;</span>
<a href="#l10.55"></a><span id="l10.55">                 args.onOk = function selectCalendar(aCal) { targetCalendar = aCal; };</span>
<a href="#l10.56"></a><span id="l10.56">                 args.promptText = cal.calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l10.57"></a><span id="l10.57">                 aWindow.openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l10.58"></a><span id="l10.58">                                    &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l10.59"></a><span id="l10.59">             }</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">             if (targetCalendar) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-              aItipItem.targetCalendar = targetCalendar;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+                aItipItem.targetCalendar = targetCalendar;</span>
<a href="#l10.64"></a><span id="l10.64">             }</span>
<a href="#l10.65"></a><span id="l10.65">         }</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">         return (!needsCalendar || targetCalendar != null);</span>
<a href="#l10.68"></a><span id="l10.68">     },</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">     /**</span>
<a href="#l10.71"></a><span id="l10.71">      * Scope: iTIP message receiver</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineat">@@ -583,16 +587,27 @@ cal.itip = {</span>
<a href="#l10.73"></a><span id="l10.73">         }</span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75">         let autoResponse = { value: false }; // controls confirm to send email only once</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">         let invitedAttendee = ((cal.calInstanceOf(aItem.calendar, Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l10.78"></a><span id="l10.78">                                 aItem.calendar.isInvitation(aItem))</span>
<a href="#l10.79"></a><span id="l10.79">                                ? aItem.calendar.getInvitedAttendee(aItem) : null);</span>
<a href="#l10.80"></a><span id="l10.80">         if (invitedAttendee) { // actually is an invitation copy, fix attendee list to send REPLY</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+            /* We check if the attendee id matches one of of the</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+             * userAddresses. If they aren't equal, it means that</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+             * someone is accepting invitations on behalf of an other user. */</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+            if (aItem.calendar.aclEntry) {</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+                let userAddresses = aItem.calendar.aclEntry.getUserAddresses({});</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+                if (userAddresses.length &gt; 0</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+                    &amp;&amp; !cal.attendeeMatchesAddresses(invitedAttendee, userAddresses)) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+                    invitedAttendee.setProperty(&quot;SENT-BY&quot;, userAddresses[0]);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+                }</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+            }</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+</span>
<a href="#l10.92"></a><span id="l10.92">             if (aItem.organizer) {</span>
<a href="#l10.93"></a><span id="l10.93">                 let origInvitedAttendee = (aOriginalItem &amp;&amp; aOriginalItem.getAttendeeById(invitedAttendee.id));</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95">                 if (aOpType == Components.interfaces.calIOperationListener.DELETE) {</span>
<a href="#l10.96"></a><span id="l10.96">                     // in case the attendee has just deleted the item, we want to send out a DECLINED REPLY:</span>
<a href="#l10.97"></a><span id="l10.97">                     origInvitedAttendee = invitedAttendee;</span>
<a href="#l10.98"></a><span id="l10.98">                     invitedAttendee = invitedAttendee.clone();</span>
<a href="#l10.99"></a><span id="l10.99">                     invitedAttendee.participationStatus = &quot;DECLINED&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -551,16 +551,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l11.4"></a><span id="l11.4">         return cal.doQueryInterface(this, cal.ProviderBase.prototype, aIID,</span>
<a href="#l11.5"></a><span id="l11.5">                                     [Components.interfaces.nsISupports,</span>
<a href="#l11.6"></a><span id="l11.6">                                      Components.interfaces.calICalendar,</span>
<a href="#l11.7"></a><span id="l11.7">                                      Components.interfaces.calISchedulingSupport]);</span>
<a href="#l11.8"></a><span id="l11.8">     },</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">     mID: null,</span>
<a href="#l11.11"></a><span id="l11.11">     mUri: null,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    mACLEntry: null,</span>
<a href="#l11.13"></a><span id="l11.13">     mObservers: null,</span>
<a href="#l11.14"></a><span id="l11.14">     mProperties: null,</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">     initProviderBase: function cPB_initProviderBase() {</span>
<a href="#l11.17"></a><span id="l11.17">         this.wrappedJSObject = this;</span>
<a href="#l11.18"></a><span id="l11.18">         this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l11.19"></a><span id="l11.19">         this.mProperties = {};</span>
<a href="#l11.20"></a><span id="l11.20">         this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -614,16 +615,31 @@ cal.ProviderBase.prototype = {</span>
<a href="#l11.22"></a><span id="l11.22">     // attribute AUTF8String name;</span>
<a href="#l11.23"></a><span id="l11.23">     get name() {</span>
<a href="#l11.24"></a><span id="l11.24">         return this.getProperty(&quot;name&quot;);</span>
<a href="#l11.25"></a><span id="l11.25">     },</span>
<a href="#l11.26"></a><span id="l11.26">     set name(aValue) {</span>
<a href="#l11.27"></a><span id="l11.27">         return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l11.28"></a><span id="l11.28">     },</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    // readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+    get aclManager() {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+        const defaultACLProviderClass = &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+        let providerClass = this.getProperty(&quot;aclManagerClass&quot;);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+        if (!providerClass || !Components.classes[providerClass]) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+            providerClass = defaultACLProviderClass;</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        }</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+        return Components.classes[providerClass].getService(Components.interfaces.calICalendarACLManager);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    },</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    // readonly attribute calICalendarACLEntry aclEntry;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    get aclEntry() {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+        return this.mACLEntry;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    },</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45">     // attribute calICalendar superCalendar;</span>
<a href="#l11.46"></a><span id="l11.46">     get superCalendar() {</span>
<a href="#l11.47"></a><span id="l11.47">         // If we have a superCalendar, check this calendar for a superCalendar.</span>
<a href="#l11.48"></a><span id="l11.48">         // This will make sure the topmost calendar is returned</span>
<a href="#l11.49"></a><span id="l11.49">         return (this.mSuperCalendar ? this.mSuperCalendar.superCalendar : this);</span>
<a href="#l11.50"></a><span id="l11.50">     },</span>
<a href="#l11.51"></a><span id="l11.51">     set superCalendar(val) {</span>
<a href="#l11.52"></a><span id="l11.52">         return (this.mSuperCalendar = val);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineat">@@ -828,28 +844,72 @@ cal.ProviderBase.prototype = {</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">     // void removeObserver( in calIObserver observer );</span>
<a href="#l11.56"></a><span id="l11.56">     removeObserver: function cPB_removeObserver(aObserver) {</span>
<a href="#l11.57"></a><span id="l11.57">         this.mObservers.remove(aObserver);</span>
<a href="#l11.58"></a><span id="l11.58">     },</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">     // calISchedulingSupport: Implementation corresponding to our iTIP/iMIP support</span>
<a href="#l11.61"></a><span id="l11.61">     isInvitation: function cPB_isInvitation(aItem) {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-        let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-        if (id) {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-            let org = aItem.organizer;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-            if (!org || (org.id.toLowerCase() == id.toLowerCase())) {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+        if (!this.mACLEntry || !this.mACLEntry.hasAccessControl) {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+            // No ACL support - fallback to the old method</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+            let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+            if (id) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+                let org = aItem.organizer;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+                if (!org || (org.id.toLowerCase() == id.toLowerCase())) {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+                    return false;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                }</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                return (aItem.getAttendeeById(id) != null);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+            }</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+            return false;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+        }</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+        let org = aItem.organizer;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+        if (!org) {</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+            // HACK</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+            // if we don't have an organizer, this is perhaps because it's an exception</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+            // to a recurring event. We check the parent item.</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+            if (aItem.parentItem) {</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+                org = aItem.parentItem.organizer;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+                if (!org) return false;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+            } else {</span>
<a href="#l11.88"></a><span id="l11.88">                 return false;</span>
<a href="#l11.89"></a><span id="l11.89">             }</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-            return (aItem.getAttendeeById(id) != null);</span>
<a href="#l11.91"></a><span id="l11.91">         }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+        // We check if :</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+        // - the organizer of the event is NOT within the owner's identities of this calendar</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+        // - if the one of the owner's identities of this calendar is in the attendees</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+        let ownerIdentities = this.mACLEntry.getOwnerIdentities({});</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+        for (let i = 0; i &lt; ownerIdentities.length; i++) {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+            let identity = &quot;mailto:&quot; + ownerIdentities[i].email.toLowerCase();</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+            if (org.id.toLowerCase() == identity)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+                return false;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+            if (aItem.getAttendeeById(identity) != null)</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+                return true;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+        }</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+</span>
<a href="#l11.106"></a><span id="l11.106">         return false;</span>
<a href="#l11.107"></a><span id="l11.107">     },</span>
<a href="#l11.108"></a><span id="l11.108"> </span>
<a href="#l11.109"></a><span id="l11.109">     getInvitedAttendee: function cPB_getInvitedAttendee(aItem) {</span>
<a href="#l11.110"></a><span id="l11.110">         let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-        return (id ? aItem.getAttendeeById(id) : null);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+        let attendee = (id ? aItem.getAttendeeById(id) : null);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+        if (!attendee &amp;&amp; this.mACLEntry &amp;&amp; this.mACLEntry.hasAccessControl) {</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+            let ownerIdentities = this.mACLEntry.getOwnerIdentities({});</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+            if (ownerIdentities.length &gt; 0) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+                let identity;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+                for (let i = 0; !attendee &amp;&amp; i &lt; ownerIdentities.length; i++) {</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+                    identity = &quot;mailto:&quot; + ownerIdentities[i].email.toLowerCase();</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+                    attendee = aItem.getAttendeeById(identity);</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+                }</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+            }</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+        }</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+        return attendee;</span>
<a href="#l11.126"></a><span id="l11.126">     },</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128">     canNotify: function cPB_canNotify(aMethod, aItem) {</span>
<a href="#l11.129"></a><span id="l11.129">         return false; // use outbound iTIP for all</span>
<a href="#l11.130"></a><span id="l11.130">     }</span>
<a href="#l11.131"></a><span id="l11.131"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/public/Makefile.in</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/public/Makefile.in</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -42,17 +42,19 @@ topsrcdir	= @top_srcdir@</span>
<a href="#l12.4"></a><span id="l12.4"> srcdir		= @srcdir@</span>
<a href="#l12.5"></a><span id="l12.5"> VPATH		= @srcdir@</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> MODULE		= calbase</span>
<a href="#l12.10"></a><span id="l12.10"> XPIDL_MODULE	= calbase</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-XPIDLSRCS = calIAlarm.idl \</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+XPIDLSRCS = calICalendarACLManager.idl \</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+            calIAlarm.idl \</span>
<a href="#l12.16"></a><span id="l12.16">             calIAlarmService.idl \</span>
<a href="#l12.17"></a><span id="l12.17">             calIAttachment.idl \</span>
<a href="#l12.18"></a><span id="l12.18">             calIAttendee.idl \</span>
<a href="#l12.19"></a><span id="l12.19">             calICalendar.idl \</span>
<a href="#l12.20"></a><span id="l12.20">             calICalendarManager.idl \</span>
<a href="#l12.21"></a><span id="l12.21">             calICalendarProvider.idl \</span>
<a href="#l12.22"></a><span id="l12.22">             calICalendarSearchProvider.idl \</span>
<a href="#l12.23"></a><span id="l12.23">             calICalendarView.idl \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/public/calICalendar.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/public/calICalendar.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -46,16 +46,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> // decls for stuff from other files</span>
<a href="#l13.6"></a><span id="l13.6"> interface nsIURI;</span>
<a href="#l13.7"></a><span id="l13.7"> interface calIItemBase;</span>
<a href="#l13.8"></a><span id="l13.8"> interface nsIVariant;</span>
<a href="#l13.9"></a><span id="l13.9"> interface nsISimpleEnumerator;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> // forward decls for this file</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+interface calICalendarACLManager;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+interface calICalendarACLEntry;</span>
<a href="#l13.14"></a><span id="l13.14"> interface calIObserver;</span>
<a href="#l13.15"></a><span id="l13.15"> interface calIOperationListener;</span>
<a href="#l13.16"></a><span id="l13.16"> interface calIRange;</span>
<a href="#l13.17"></a><span id="l13.17"> interface calIDateTime;</span>
<a href="#l13.18"></a><span id="l13.18"> interface calIOperation;</span>
<a href="#l13.19"></a><span id="l13.19"> interface calIStatusObserver;</span>
<a href="#l13.20"></a><span id="l13.20"> interface nsIDOMChromeWindow;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -83,17 +85,28 @@ interface calICalendar : nsISupports</span>
<a href="#l13.23"></a><span id="l13.23">    */</span>
<a href="#l13.24"></a><span id="l13.24">   readonly attribute AUTF8String type;</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   /**</span>
<a href="#l13.27"></a><span id="l13.27">    * If this calendar is provided by an extension, this attribute should return</span>
<a href="#l13.28"></a><span id="l13.28">    * the extension's id, otherwise null.</span>
<a href="#l13.29"></a><span id="l13.29">    */</span>
<a href="#l13.30"></a><span id="l13.30">   readonly attribute AString providerID;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  </span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  /**</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+   * Returns the acl manager for the calendar, based on the &quot;aclManagerClass&quot;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+   * property. If this property is not defined, the default manager is used</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+   */</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  /**</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+   * Returns the acl entry associated to the calendar.</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+   */</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  readonly attribute calICalendarACLEntry aclEntry;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44">   /**</span>
<a href="#l13.45"></a><span id="l13.45">    * Multiple calendar instances may be composited, logically acting as a</span>
<a href="#l13.46"></a><span id="l13.46">    * single calendar, e.g. for caching puorposing.</span>
<a href="#l13.47"></a><span id="l13.47">    * This attribute determines the topmost calendar that returned items should</span>
<a href="#l13.48"></a><span id="l13.48">    * belong to. If the current instance is the topmost calendar, then it should</span>
<a href="#l13.49"></a><span id="l13.49">    * be returned directly.</span>
<a href="#l13.50"></a><span id="l13.50">    *</span>
<a href="#l13.51"></a><span id="l13.51">    * @see calIItemBase::calendar</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/calendar/base/public/calICalendarACLManager.idl</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,121 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is Inverse Inc. code.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developers of the Original Code are</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ *   Wolfgang Sourdeau &lt;wsourdeau@inverse.ca&gt;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ *</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+interface nsIMsgIdentity;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+interface nsIURI;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+interface calICalendar;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+interface calIItemBase;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+interface calIOperationListener;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+interface calIItemACLEntry;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+/**</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ */</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+[scriptable, uuid(a64bd8a0-e9f0-4f64-928a-1c98861e4703)]</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+interface calICalendarACLManager : nsISupports</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+{</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    /* Gets the calICalendarACLEntry of the current user for the specified</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+       calendar. */</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    void getCalendarEntry(in calICalendar aCalendar,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+                          in calIOperationListener aListener);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    /* Gets the calIItemACLEntry of the current user for the specified</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+       calendar item. Depending on the implementation, each item can have</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+       different permissions based on specific attributes.</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+       (TODO: should be made asynchronous one day) */</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    calIItemACLEntry getItemEntry(in calIItemBase aItem);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+};</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+[scriptable, uuid(f3da7954-52a4-45a9-bd7d-96c518133d0c)]</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+interface calICalendarACLEntry : nsISupports</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+{</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    /* The calICalendarACLManager instance that generated this entry. */</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+    readonly attribute calICalendarACLManager aclManager;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    /* Whether the underlying calendar does have access control. */</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    readonly attribute boolean hasAccessControl;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+    /* Whether the user accessing the calendar is its owner. */</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    readonly attribute boolean userIsOwner;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    /* Whether the user accessing the calendar can add items to it. */</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+    readonly attribute boolean userCanAddItems;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    /* Whether the user accessing the calendar can remove items from it. */</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    readonly attribute boolean userCanDeleteItems;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    /* Returns the list of user ids matching the user accessing the</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+       calendar. */</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+    void getUserAddresses(out PRUint32 aCount,</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+                          [array, size_is(aCount), retval] out AUTF8String aAddresses);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    /* Returns the list of instantiated identities for the user accessing the</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+       calendar. */</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    void getUserIdentities(out PRUint32 aCount,</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+                           [array, size_is(aCount), retval] out nsIMsgIdentity aIdentities);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    /* Returns the list of instantiated identities for the user representing</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+       the calendar owner. */</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    void getOwnerIdentities(out PRUint32 aCount,</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+                            [array, size_is(aCount), retval] out nsIMsgIdentity aIdentities);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+    /* Helper method that forces a cleanup of any cache and a reload of the</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+       current entry.</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+       (TODO: should be made asynchronous one day) */</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+    void refresh();</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+};</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+[scriptable, uuid(4d0b7ced-8c57-4efa-87e7-8dd5b7481312)]</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+interface calIItemACLEntry : nsISupports</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+{</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+    /* The parent calICalendarACLEntry instance. */</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    readonly attribute calICalendarACLEntry calendarEntry;</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+    /* Whether the active user can fully modify the item. */</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    readonly attribute boolean userCanModify;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+    /* Whether the active user can respond to this item, if it is an invitation. */</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    readonly attribute boolean userCanRespond;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    /* Whether the active user can view all the item properties. */</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    readonly attribute boolean userCanViewAll;</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    /* Whether the active user can only see when this item occurs without</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+       knowing any details. */</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    readonly attribute boolean userCanViewDateAndTime;</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/public/calIItemBase.idl</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/public/calIItemBase.idl</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -39,16 +39,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> interface nsISimpleEnumerator;</span>
<a href="#l15.8"></a><span id="l15.8"> interface nsIVariant;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> interface nsIPropertyBag;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+interface calIItemACLEntry;</span>
<a href="#l15.13"></a><span id="l15.13"> interface calIAlarm;</span>
<a href="#l15.14"></a><span id="l15.14"> interface calIAttachment;</span>
<a href="#l15.15"></a><span id="l15.15"> interface calIAttendee;</span>
<a href="#l15.16"></a><span id="l15.16"> interface calICalendar;</span>
<a href="#l15.17"></a><span id="l15.17"> interface calIDateTime;</span>
<a href="#l15.18"></a><span id="l15.18"> interface calIDuration;</span>
<a href="#l15.19"></a><span id="l15.19"> interface calIIcalComponent;</span>
<a href="#l15.20"></a><span id="l15.20"> interface calIRecurrenceInfo;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -90,16 +91,21 @@ interface calIItemBase : nsISupports</span>
<a href="#l15.22"></a><span id="l15.22">    * this one, by testing both the id and recurrenceId property.  This</span>
<a href="#l15.23"></a><span id="l15.23">    *</span>
<a href="#l15.24"></a><span id="l15.24">    * @arg aItem     the item to compare against this one</span>
<a href="#l15.25"></a><span id="l15.25">    *</span>
<a href="#l15.26"></a><span id="l15.26">    * @return        true if both ids match, false otherwise</span>
<a href="#l15.27"></a><span id="l15.27">    */</span>
<a href="#l15.28"></a><span id="l15.28">   boolean hasSameIds(in calIItemBase aItem);</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  /**</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+   * Returns the acl entry associated to the item.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+   */</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  readonly attribute calIItemACLEntry aclEntry;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+</span>
<a href="#l15.35"></a><span id="l15.35">   //</span>
<a href="#l15.36"></a><span id="l15.36">   // the generation number of this item</span>
<a href="#l15.37"></a><span id="l15.37">   //</span>
<a href="#l15.38"></a><span id="l15.38">   attribute PRUint32 generation;</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40">   // the time when this item was created</span>
<a href="#l15.41"></a><span id="l15.41">   readonly attribute calIDateTime creationDate;</span>
<a href="#l15.42"></a><span id="l15.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/src/Makefile.in</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/src/Makefile.in</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -69,16 +69,18 @@ CPPSRCS = calDateTime.cpp \</span>
<a href="#l16.4"></a><span id="l16.4"> 	  calUtils.cpp \</span>
<a href="#l16.5"></a><span id="l16.5"> 	  $(NULL)</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> EXTRA_COMPONENTS = \</span>
<a href="#l16.8"></a><span id="l16.8">     calItemModule.manifest \</span>
<a href="#l16.9"></a><span id="l16.9">     calItemModule.js \</span>
<a href="#l16.10"></a><span id="l16.10">     calTimezoneService.manifest \</span>
<a href="#l16.11"></a><span id="l16.11">     calTimezoneService.js \</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    calDefaultACLManager.js \</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    calDefaultACLManager.manifest \</span>
<a href="#l16.14"></a><span id="l16.14">     $(NULL)</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> EXTRA_SCRIPTS = \</span>
<a href="#l16.17"></a><span id="l16.17">     calAlarm.js \</span>
<a href="#l16.18"></a><span id="l16.18">     calAlarmService.js \</span>
<a href="#l16.19"></a><span id="l16.19">     calAlarmMonitor.js \</span>
<a href="#l16.20"></a><span id="l16.20">     calAttachment.js \</span>
<a href="#l16.21"></a><span id="l16.21">     calAttendee.js \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -857,13 +857,13 @@ calCachedCalendar.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4">         functions.forEach(defineForwardFunction);</span>
<a href="#l17.5"></a><span id="l17.5">         getters.forEach(defineForwardGetter);</span>
<a href="#l17.6"></a><span id="l17.6">         gettersAndSetters.forEach(defineForwardGetterAndSetter);</span>
<a href="#l17.7"></a><span id="l17.7">     }</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">     defineForwards(calCachedCalendar.prototype, &quot;mUncachedCalendar&quot;,</span>
<a href="#l17.10"></a><span id="l17.10">                    [&quot;getProperty&quot;, &quot;setProperty&quot;, &quot;deleteProperty&quot;,</span>
<a href="#l17.11"></a><span id="l17.11">                     &quot;isInvitation&quot;, &quot;getInvitedAttendee&quot;, &quot;canNotify&quot;],</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-                   [&quot;type&quot;],</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+                   [&quot;type&quot;, &quot;aclManager&quot;, &quot;aclEntry&quot;],</span>
<a href="#l17.14"></a><span id="l17.14">                    [&quot;id&quot;, &quot;name&quot;, &quot;uri&quot;, &quot;readOnly&quot;]);</span>
<a href="#l17.15"></a><span id="l17.15">     defineForwards(calCachedCalendar.prototype, &quot;mCachedCalendar&quot;,</span>
<a href="#l17.16"></a><span id="l17.16">                    [&quot;getItem&quot;, &quot;getItems&quot;, &quot;startBatch&quot;, &quot;endBatch&quot;], [], []);</span>
<a href="#l17.17"></a><span id="l17.17"> })();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,147 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ *</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ *</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * License.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ *</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ * The Original Code is Inverse inc. code.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ *  Wolfgang Sourdeau  &lt;wsourdeau@inverse.ca&gt;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ * Portions created by the Initial Developer are</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ *  Copyright (C) 2008-2011 Inverse inc. All Rights Reserved.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ *</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ *</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ *</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+/* calDefaultACLManager */</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+function calDefaultACLManager() {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    this.mCalendarEntries = {};</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+}</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+calDefaultACLManager.prototype = {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+    mCalendarEntries: null,</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    /* nsISupports */</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+    classID: Components.ID(&quot;{7463258c-6ef3-40a2-89a9-bb349596e927}&quot;),</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarACLManager]),</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+    /* nsIClassInfo */</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+        classID: Components.ID(&quot;{7463258c-6ef3-40a2-89a9-bb349596e927}&quot;),</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;,</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+        classDescription: &quot;Default Calendar ACL Provider&quot;,</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+        interfaces: [Components.interfaces.calICalendarACLManager],</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+        flags: Components.interfaces.nsIClassInfo.SINGLETON,</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    }),</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+    /* calICalendarACLManager */</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    _getCalendarEntryCached: function cDACLM__getCalendarEntryCached(aCalendar) {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+        let calUri = aCalendar.uri.spec;</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+        if (!(calUri in this.mCalendarEntries)) {</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+            this.mCalendarEntries[calUri] = new calDefaultCalendarACLEntry(this);</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+        }</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+        return this.mCalendarEntries[calUri];</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    },</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    getCalendarEntry: function cDACLM_getCalendarEntry(aCalendar, aListener) {</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+        let entry = this._getCalendarEntryCached(aCalendar);</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+        aListener.onOperationComplete(aCalendar, Components.results.NS_OK,</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+                                      null,</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+                                      entry);</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+    },</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    getItemEntry: function cDACLM_getItemEntry(aItem) {</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+        let calEntry = this._getCalendarEntryCached(aItem.calendar);</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+        return new calDefaultItemACLEntry(calEntry);</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+    },</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+};</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+function calDefaultCalendarACLEntry(aMgr) {</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+    this.mACLManager = aMgr;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+}</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+calDefaultCalendarACLEntry.prototype = {</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+    mACLManager: null,</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+    /* nsISupports */</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarACLEntry]),</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+    /* calICalendarACLCalendarEntry */</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+    get aclManager() {</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+        return this.mACLManager;</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+    },</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+    hasAccessControl: false,</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+    userIsOwner: true,</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    userCanAddItems: true,</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+    userCanDeleteItems: true,</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+    _getIdentities: function calDefaultCalendarACLEntry_getUserAddresses(aCount) {</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+        let identities = [];</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+        cal.calIterateEmailIdentities(function (id, ac) { identities.push(id); });</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+        aCount.value = identities.length;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+        return identities;</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+    },</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+    getUserAddresses: function calDefaultCalendarACLEntry_getUserAddresses(aCount) {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+        let identities = this._getIdentities(aCount);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+        let addresses = [ id.email for each (id in identities) ];</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+        return addresses;</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+    },</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+    getUserIdentities: function calDefaultCalendarACLEntry_getUserIdentities(aCount) {</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+        return this._getIdentities(aCount)</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+    },</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+    getOwnerIdentities: function calDefaultCalendarACLEntry_getOwnerIdentities(aCount) {</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+        return this._getIdentities(aCount)</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+    },</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+    refresh: function calDefaultCalendarACLEntry_refresh() {</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+    }</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+};</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+function calDefaultItemACLEntry(aCalendarEntry) {</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+    this.calendarEntry = aCalendarEntry;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+};</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+calDefaultItemACLEntry.prototype = {</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+    /* nsISupports */</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIItemACLEntry]),</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+    /* calIItemACLEntry */</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+    calendarEntry: null,</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+    userCanModify: true,</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+    userCanRespond: true,</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+    userCanViewAll: true,</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    userCanViewDateAndTime: true,</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+};</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+/** Module Registration */</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([calDefaultACLManager]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.manifest</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+component {7463258c-6ef3-40a2-89a9-bb349596e927} calDefaultACLManager.js</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+contract @mozilla.org/calendar/acl-manager;1?type=default {7463258c-6ef3-40a2-89a9-bb349596e927}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -70,16 +70,18 @@ calItemBase.prototype = {</span>
<a href="#l20.4"></a><span id="l20.4">     mAlarms: null,</span>
<a href="#l20.5"></a><span id="l20.5">     mAlarmLastAck: null,</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     mAttendees: null,</span>
<a href="#l20.8"></a><span id="l20.8">     mAttachments: null,</span>
<a href="#l20.9"></a><span id="l20.9">     mRelations: null,</span>
<a href="#l20.10"></a><span id="l20.10">     mCategories: null,</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+    mACLEntry: null,</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+</span>
<a href="#l20.14"></a><span id="l20.14">     /**</span>
<a href="#l20.15"></a><span id="l20.15">      * Initialize the base item's attributes. Can be called from inheriting</span>
<a href="#l20.16"></a><span id="l20.16">      * objects in their constructor.</span>
<a href="#l20.17"></a><span id="l20.17">      */</span>
<a href="#l20.18"></a><span id="l20.18">     initItemBase: function cIB_initItemBase() {</span>
<a href="#l20.19"></a><span id="l20.19">         this.wrappedJSObject = this;</span>
<a href="#l20.20"></a><span id="l20.20">         this.mProperties = new calPropertyBag();</span>
<a href="#l20.21"></a><span id="l20.21">         this.mPropertyParams = {};</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -92,16 +94,32 @@ calItemBase.prototype = {</span>
<a href="#l20.23"></a><span id="l20.23">     QueryInterface: function cIB_QueryInterface(aIID) {</span>
<a href="#l20.24"></a><span id="l20.24">         return doQueryInterface(this, calItemBase.prototype, aIID,</span>
<a href="#l20.25"></a><span id="l20.25">                                 [Components.interfaces.calIItemBase]);</span>
<a href="#l20.26"></a><span id="l20.26">     },</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">     /**</span>
<a href="#l20.29"></a><span id="l20.29">      * @see calIItemBase</span>
<a href="#l20.30"></a><span id="l20.30">      */</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+    get aclEntry() {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+        let aclEntry = this.mACLEntry;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+        let aclManager = (this.calendar &amp;&amp; this.calendar.superCalendar.aclManager);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+        if (!aclEntry &amp;&amp; aclManager) {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+            this.mACLEntry = aclManager.getItemEntry(this);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+            aclEntry = this.mACLEntry;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+        }</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+        if (!aclEntry &amp;&amp; this.parentItem != this) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+            // No ACL entry on this item, check the parent</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+            aclEntry = this.parentItem.aclEntry;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+        }</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+        return aclEntry;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+    },</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48">     // readonly attribute AUTF8String hashId;</span>
<a href="#l20.49"></a><span id="l20.49">     get hashId() {</span>
<a href="#l20.50"></a><span id="l20.50">         if (this.mHashId === null) {</span>
<a href="#l20.51"></a><span id="l20.51">             var rid = this.recurrenceId;</span>
<a href="#l20.52"></a><span id="l20.52">             var calendar = this.calendar;</span>
<a href="#l20.53"></a><span id="l20.53">             // some unused delim character:</span>
<a href="#l20.54"></a><span id="l20.54">             this.mHashId = [encodeURIComponent(this.id),</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineat">@@ -260,16 +278,17 @@ calItemBase.prototype = {</span>
<a href="#l20.56"></a><span id="l20.56">      * Clones the base item's properties into the passed object, potentially</span>
<a href="#l20.57"></a><span id="l20.57">      * setting a new parent item.</span>
<a href="#l20.58"></a><span id="l20.58">      *</span>
<a href="#l20.59"></a><span id="l20.59">      * @param m     The item to clone this item into</span>
<a href="#l20.60"></a><span id="l20.60">      * @param aNewParent    (optional) The new parent item to set on m.</span>
<a href="#l20.61"></a><span id="l20.61">      */</span>
<a href="#l20.62"></a><span id="l20.62">     cloneItemBaseInto: function cIB_cloneItemBaseInto(m, aNewParent) {</span>
<a href="#l20.63"></a><span id="l20.63">         m.mImmutable = false;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+        m.mACLEntry = this.mACLEntry;</span>
<a href="#l20.65"></a><span id="l20.65">         m.mIsProxy = this.mIsProxy;</span>
<a href="#l20.66"></a><span id="l20.66">         m.mParentItem = (calTryWrappedJSObject(aNewParent) || this.mParentItem);</span>
<a href="#l20.67"></a><span id="l20.67">         m.mHashId = this.mHashId;</span>
<a href="#l20.68"></a><span id="l20.68">         m.mCalendar = this.mCalendar;</span>
<a href="#l20.69"></a><span id="l20.69">         if (this.mRecurrenceInfo) {</span>
<a href="#l20.70"></a><span id="l20.70">             m.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l20.71"></a><span id="l20.71">             m.mRecurrenceInfo.item = m;</span>
<a href="#l20.72"></a><span id="l20.72">         }</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineat">@@ -521,18 +540,17 @@ calItemBase.prototype = {</span>
<a href="#l20.74"></a><span id="l20.74">     //                   [array,size_is(count),retval] out calIAttendee attendees);</span>
<a href="#l20.75"></a><span id="l20.75">     getAttendees: function cIB_getAttendees(countObj) {</span>
<a href="#l20.76"></a><span id="l20.76">         if (!this.mAttendees &amp;&amp; this.mIsProxy) {</span>
<a href="#l20.77"></a><span id="l20.77">             this.mAttendees = this.mParentItem.getAttendees(countObj);</span>
<a href="#l20.78"></a><span id="l20.78">         }</span>
<a href="#l20.79"></a><span id="l20.79">         if (this.mAttendees) {</span>
<a href="#l20.80"></a><span id="l20.80">             countObj.value = this.mAttendees.length;</span>
<a href="#l20.81"></a><span id="l20.81">             return this.mAttendees.concat([]); // clone</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-        }</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-        else {</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+        } else {</span>
<a href="#l20.85"></a><span id="l20.85">             countObj.value = 0;</span>
<a href="#l20.86"></a><span id="l20.86">             return [];</span>
<a href="#l20.87"></a><span id="l20.87">         }</span>
<a href="#l20.88"></a><span id="l20.88">     },</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">     // calIAttendee getAttendeeById(in AUTF8String id);</span>
<a href="#l20.91"></a><span id="l20.91">     getAttendeeById: function cIB_getAttendeeById(id) {</span>
<a href="#l20.92"></a><span id="l20.92">         var attendees = this.getAttendees({});</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineat">@@ -1088,23 +1106,25 @@ makeMemberAttr(calItemBase, &quot;mProperties</span>
<a href="#l20.94"></a><span id="l20.94">  * @param dflt          The default value in case none is set</span>
<a href="#l20.95"></a><span id="l20.95">  * @param attr          The attribute name to be used</span>
<a href="#l20.96"></a><span id="l20.96">  * @param asProperty    If true, getProperty will be used to get/set the</span>
<a href="#l20.97"></a><span id="l20.97">  *                        member.</span>
<a href="#l20.98"></a><span id="l20.98">  */</span>
<a href="#l20.99"></a><span id="l20.99"> function makeMemberAttr(ctor, varname, dflt, attr, asProperty) {</span>
<a href="#l20.100"></a><span id="l20.100">     // XXX handle defaults!</span>
<a href="#l20.101"></a><span id="l20.101">     var getter = function () {</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-        if (asProperty)</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+        if (asProperty) {</span>
<a href="#l20.104"></a><span id="l20.104">             return this.getProperty(varname);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-        else</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+        } else {</span>
<a href="#l20.107"></a><span id="l20.107">             return (varname in this ? this[varname] : undefined);</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+        }</span>
<a href="#l20.109"></a><span id="l20.109">     };</span>
<a href="#l20.110"></a><span id="l20.110">     var setter = function (v) {</span>
<a href="#l20.111"></a><span id="l20.111">         this.modify();</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-        if (asProperty)</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+        if (asProperty) {</span>
<a href="#l20.114"></a><span id="l20.114">             return this.setProperty(varname, v);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-        else</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+        } else {</span>
<a href="#l20.117"></a><span id="l20.117">             return (this[varname] = v);</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+        }</span>
<a href="#l20.119"></a><span id="l20.119">     };</span>
<a href="#l20.120"></a><span id="l20.120">     ctor.prototype.__defineGetter__(attr, getter);</span>
<a href="#l20.121"></a><span id="l20.121">     ctor.prototype.__defineSetter__(attr, setter);</span>
<a href="#l20.122"></a><span id="l20.122"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -93,17 +93,17 @@ calTransactionManager.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5">     checkWritable: function cTM_checkWritable(transaction) {</span>
<a href="#l21.6"></a><span id="l21.6">         if (transaction) {</span>
<a href="#l21.7"></a><span id="l21.7">             transaction = transaction.wrappedJSObject;</span>
<a href="#l21.8"></a><span id="l21.8">             if (transaction) {</span>
<a href="#l21.9"></a><span id="l21.9">                 function checkItem(item) {</span>
<a href="#l21.10"></a><span id="l21.10">                     if (item) {</span>
<a href="#l21.11"></a><span id="l21.11">                         var calendar = item.calendar;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                        if (calendar &amp;&amp; !isCalendarWritable(calendar)) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                        if (calendar &amp;&amp; (!isCalendarWritable(calendar) || !userCanAddItemsToCalendar(calendar))) {</span>
<a href="#l21.14"></a><span id="l21.14">                             return false;</span>
<a href="#l21.15"></a><span id="l21.15">                         }</span>
<a href="#l21.16"></a><span id="l21.16">                     }</span>
<a href="#l21.17"></a><span id="l21.17">                     return true;</span>
<a href="#l21.18"></a><span id="l21.18">                 }</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">                 if (!checkItem(transaction.mItem) ||</span>
<a href="#l21.21"></a><span id="l21.21">                     !checkItem(transaction.mOldItem)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -295,16 +295,83 @@ function isCalendarWritable(aCalendar) {</span>
<a href="#l22.4"></a><span id="l22.4">     return (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l22.5"></a><span id="l22.5">             !aCalendar.readOnly &amp;&amp;</span>
<a href="#l22.6"></a><span id="l22.6">             (!getIOService().offline ||</span>
<a href="#l22.7"></a><span id="l22.7">              aCalendar.getProperty(&quot;cache.enabled&quot;) ||</span>
<a href="#l22.8"></a><span id="l22.8">              aCalendar.getProperty(&quot;requiresNetwork&quot;) === false));</span>
<a href="#l22.9"></a><span id="l22.9"> }</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> /**</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+ * Check if the specified calendar is writable from an ACL point of view.</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+ *</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+ * @param aCalendar     The calendar to check</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+ * @return              True if the calendar is writable</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+ */</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+function userCanAddItemsToCalendar(aCalendar) {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+    let aclEntry = aCalendar.aclEntry;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    return (!aclEntry || !aclEntry.hasAccessControl || aclEntry.userIsOwner || aclEntry.userCanAddItems);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+}</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+/**</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+ * Check if the user can delete items from the specified calendar, from an ACL point of view.</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+ *</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+ * @param aCalendar     The calendar to check</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+ * @return              True if the calendar is writable</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+ */</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+function userCanDeleteItemsFromCalendar(aCalendar) {</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+    let aclEntry = aCalendar.aclEntry;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+    return (!aclEntry || !aclEntry.hasAccessControl || aclEntry.userIsOwner || aclEntry.userCanDeleteItems);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+}</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+/**</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+ * Check if the user can fully modify the specified item, from an ACL point of view.</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+ * Note to be confused with the right to respond to an invitation, which is</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+ * handled instead by userCanRespondToInvitation.</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+ *</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+ * @param aItem         The calendar item to check</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+ * @return              True if the item is modifiable</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+ */</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+function userCanModifyItem(aItem) {</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    let aclEntry = aItem.aclEntry;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+    return (!aclEntry || !aclEntry.calendarEntry.hasAccessControl || aclEntry.calendarEntry.userIsOwner || aclEntry.userCanModify);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+}</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+/**</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+ * Check if the attendee object matches one of the addresses in the list. This</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+ * is useful to determine whether the current user acts as a delegate.</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+ *</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+ * @param aAttendee     The reference attendee object</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+ * @param addresses     The list of addresses</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+ * @return              True if there is a match</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+ */</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+function attendeeMatchesAddresses(anAttendee, addresses) {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+    let attId = anAttendee.id.toLowerCase();</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+    for each (let address in addresses) {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+        if (attId == address.toLowerCase()) {</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+            return true;</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+        }</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+    }</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+    return false;</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+}</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+/**</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+ * Check if the user can fully modify the specified item, from an ACL point of view.</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+ * Note to be confused with the right to respond to an invitation, which is</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+ * handled instead by userCanRespondToInvitation.</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+ *</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+ * @param aItem         The calendar item to check</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+ * @return              True if the item is modifiable</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+ */</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+function userCanRespondToInvitation(aItem) {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+    let aclEntry = aItem.aclEntry;</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+    return userCanModifyItem(aItem) || aclEntry.userCanRespond;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+}</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+/**</span>
<a href="#l22.79"></a><span id="l22.79">  * Opens the Create Calendar wizard</span>
<a href="#l22.80"></a><span id="l22.80">  *</span>
<a href="#l22.81"></a><span id="l22.81">  * @param aCallback  a function to be performed after calendar creation</span>
<a href="#l22.82"></a><span id="l22.82">  */</span>
<a href="#l22.83"></a><span id="l22.83"> function openCalendarWizard(aCallback) {</span>
<a href="#l22.84"></a><span id="l22.84">     openDialog(&quot;chrome://calendar/content/calendarCreation.xul&quot;, &quot;caEditServer&quot;,</span>
<a href="#l22.85"></a><span id="l22.85">                &quot;chrome,titlebar,modal,resizable&quot;, aCallback);</span>
<a href="#l22.86"></a><span id="l22.86"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/lightning/content/lightning-utils.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-utils.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -33,16 +33,17 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l23.5"></a><span id="l23.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l23.6"></a><span id="l23.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l23.7"></a><span id="l23.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.8"></a><span id="l23.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.9"></a><span id="l23.9">  *</span>
<a href="#l23.10"></a><span id="l23.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> /**</span>
<a href="#l23.16"></a><span id="l23.16">  * Gets the value of a string in a .properties file from the lightning bundle</span>
<a href="#l23.17"></a><span id="l23.17">  *</span>
<a href="#l23.18"></a><span id="l23.18">  * @param aBundleName  the name of the properties file.  It is assumed that the</span>
<a href="#l23.19"></a><span id="l23.19">  *                     file lives in chrome://lightning/locale/</span>
<a href="#l23.20"></a><span id="l23.20">  * @param aStringName  the name of the string within the properties file</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -77,20 +78,23 @@ function ltnInitMailIdentitiesRow() {</span>
<a href="#l23.22"></a><span id="l23.22">     // Remove all children from the email list to avoid duplicates if the list</span>
<a href="#l23.23"></a><span id="l23.23">     // has already been populated during a previous step in the calendar</span>
<a href="#l23.24"></a><span id="l23.24">     // creation wizard.</span>
<a href="#l23.25"></a><span id="l23.25">     while (menuPopup.lastChild) {</span>
<a href="#l23.26"></a><span id="l23.26">         menuPopup.removeChild(menuPopup.lastChild);</span>
<a href="#l23.27"></a><span id="l23.27">     }</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">     addMenuItem(menuPopup, ltnGetString(&quot;lightning&quot;, &quot;imipNoIdentity&quot;), &quot;none&quot;);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    var identities = getAccountManager().allIdentities;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    for (var i = 0; i &lt;  identities.Count(); ++i) {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-        var identity = identities.GetElementAt(i)</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-                                 .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    let identities;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    if (gCalendar &amp;&amp; gCalendar.aclEntry &amp;&amp; gCalendar.aclEntry.hasAccessControl) {</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+        identities = gCalendar.aclEntry.getOwnerIdentities({});</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+    } else {</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+        identities = cal.getAccountManager().allIdentities;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    }</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    for each (let identity in fixIterator(identities, Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l23.41"></a><span id="l23.41">         addMenuItem(menuPopup, identity.identityName, identity.key);</span>
<a href="#l23.42"></a><span id="l23.42">     }</span>
<a href="#l23.43"></a><span id="l23.43">     try {</span>
<a href="#l23.44"></a><span id="l23.44">         var sel = gCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l23.45"></a><span id="l23.45">         if (sel) {</span>
<a href="#l23.46"></a><span id="l23.46">             sel = sel.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l23.47"></a><span id="l23.47">         }</span>
<a href="#l23.48"></a><span id="l23.48">         menuListSelectItem(&quot;email-identity-menulist&quot;, sel ? sel.key : &quot;none&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -80,16 +80,17 @@ function calDavCalendar() {</span>
<a href="#l24.4"></a><span id="l24.4">     this.mFirstRefreshDone = false;</span>
<a href="#l24.5"></a><span id="l24.5">     this.mOfflineStorage = null;</span>
<a href="#l24.6"></a><span id="l24.6">     this.mQueuedQueries = [];</span>
<a href="#l24.7"></a><span id="l24.7">     this.mCtag = null;</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9">     // By default, support both events and todos.</span>
<a href="#l24.10"></a><span id="l24.10">     this.mGenerallySupportedItemTypes = [&quot;VEVENT&quot;, &quot;VTODO&quot;];</span>
<a href="#l24.11"></a><span id="l24.11">     this.mSupportedItemTypes = this.mGenerallySupportedItemTypes.slice(0);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+    this.mACLProperties = {};</span>
<a href="#l24.13"></a><span id="l24.13"> }</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> // some shorthand</span>
<a href="#l24.16"></a><span id="l24.16"> const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l24.17"></a><span id="l24.17"> const calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l24.18"></a><span id="l24.18"> const calIFreeBusyInterval = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l24.19"></a><span id="l24.19"> const calICalDavCalendar = Components.interfaces.calICalDavCalendar;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -444,16 +445,20 @@ calDavCalendar.prototype = {</span>
<a href="#l24.22"></a><span id="l24.22">             return this.mItemInfoCache[aItem.id].locationPath;</span>
<a href="#l24.23"></a><span id="l24.23">         } else {</span>
<a href="#l24.24"></a><span id="l24.24">             // New items just use id.ics</span>
<a href="#l24.25"></a><span id="l24.25">             return aItem.id + &quot;.ics&quot;;</span>
<a href="#l24.26"></a><span id="l24.26">         }</span>
<a href="#l24.27"></a><span id="l24.27">     },</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29">     getProperty: function caldav_getProperty(aName) {</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+        if (aName in this.mACLProperties) {</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+            return this.mACLProperties[aName];</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+        }</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+</span>
<a href="#l24.34"></a><span id="l24.34">         switch (aName) {</span>
<a href="#l24.35"></a><span id="l24.35">             case &quot;organizerId&quot;:</span>
<a href="#l24.36"></a><span id="l24.36">                 if (this.calendarUserAddress) {</span>
<a href="#l24.37"></a><span id="l24.37">                     return this.calendarUserAddress;</span>
<a href="#l24.38"></a><span id="l24.38">                 } // else use configured email identity</span>
<a href="#l24.39"></a><span id="l24.39">                 break;</span>
<a href="#l24.40"></a><span id="l24.40">             case &quot;organizerCN&quot;:</span>
<a href="#l24.41"></a><span id="l24.41">                 return null; // xxx todo</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineat">@@ -1240,17 +1245,47 @@ calDavCalendar.prototype = {</span>
<a href="#l24.43"></a><span id="l24.43">             if (!this.mCheckedServerInfo) {</span>
<a href="#l24.44"></a><span id="l24.44">                 this.mQueuedQueries.push(arguments);</span>
<a href="#l24.45"></a><span id="l24.45">             } else {</span>
<a href="#l24.46"></a><span id="l24.46">                 this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l24.47"></a><span id="l24.47">             }</span>
<a href="#l24.48"></a><span id="l24.48">         }</span>
<a href="#l24.49"></a><span id="l24.49">     },</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+    fillACLProperties: function caldav_fillACLProperties() {</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+        this.mACLProperties[&quot;organizerId&quot;] = this.calendarUserAddress;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+        if (this.mACLEntry &amp;&amp; this.mACLEntry.hasAccessControl) {</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+            let ownerIdentities = this.mACLEntry.getOwnerIdentities({});</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+            if (ownerIdentities.length &gt; 0) {</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+                let identity = ownerIdentities[0];</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+                this.mACLProperties[&quot;organizerId&quot;] = identity.email;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+                this.mACLProperties[&quot;organizerCN&quot;] = identity.fullName;</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+                this.mACLProperties[&quot;imip.identity&quot;] = identity;</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+            }</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+        }</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    },</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+</span>
<a href="#l24.64"></a><span id="l24.64">     safeRefresh: function caldav_safeRefresh(aChangeLogListener) {</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+        if (!this.mACLEntry) {</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+            let thisCalendar = this;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+            let opListener = {</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+                onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+                    ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+                },</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+                onOperationComplete: function(opCalendar, opStatus, opType, opId, opDetail) {</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+                    thisCalendar.mACLEntry = opDetail;</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+                    thisCalendar.fillACLProperties();</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+                    thisCalendar.safeRefresh(aChangeLogListener);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+                }</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+            };</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+            this.aclManager.getCalendarEntry(this, opListener);</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+            return;</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+        }</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+</span>
<a href="#l24.82"></a><span id="l24.82">         this.ensureTargetCalendar();</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84">         if (this.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l24.85"></a><span id="l24.85">             // the auth could have timed out and be in need of renegotiation</span>
<a href="#l24.86"></a><span id="l24.86">             // we can't risk several calendars doing this simultaneously so</span>
<a href="#l24.87"></a><span id="l24.87">             // we'll force the renegotiation in a sync query, using OPTIONS to keep</span>
<a href="#l24.88"></a><span id="l24.88">             // it quick</span>
<a href="#l24.89"></a><span id="l24.89">             let headchannel = cal.prepHttpChannel(this.makeUri(), null, null, this);</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineat">@@ -2036,16 +2071,21 @@ calDavCalendar.prototype = {</span>
<a href="#l24.91"></a><span id="l24.91">      */</span>
<a href="#l24.92"></a><span id="l24.92">     completeCheckServerInfo: function caldav_completeCheckServerInfo(aChangeLogListener, aError) {</span>
<a href="#l24.93"></a><span id="l24.93">         if (Components.isSuccessCode(aError)) {</span>
<a href="#l24.94"></a><span id="l24.94">             // &quot;undefined&quot; is a successcode, so all is good</span>
<a href="#l24.95"></a><span id="l24.95">             this.saveCalendarProperties();</span>
<a href="#l24.96"></a><span id="l24.96">             this.mCheckedServerInfo = true;</span>
<a href="#l24.97"></a><span id="l24.97">             this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l24.98"></a><span id="l24.98"> </span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+            // try to reread the ACLs</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+            if (this.mACLEntry) {</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+                this.mACLEntry.refresh();</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+            }</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+</span>
<a href="#l24.104"></a><span id="l24.104">             if (this.isCached) {</span>
<a href="#l24.105"></a><span id="l24.105">                 this.safeRefresh(aChangeLogListener);</span>
<a href="#l24.106"></a><span id="l24.106">             } else {</span>
<a href="#l24.107"></a><span id="l24.107">                 this.refresh();</span>
<a href="#l24.108"></a><span id="l24.108">             }</span>
<a href="#l24.109"></a><span id="l24.109">         } else {</span>
<a href="#l24.110"></a><span id="l24.110">             this.reportDavError(aError);</span>
<a href="#l24.111"></a><span id="l24.111">             if (this.isCached &amp;&amp; aChangeLogListener) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1031,18 +1031,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.4"></a><span id="l25.4">         let this_ = this;</span>
<a href="#l25.5"></a><span id="l25.5">         let opListener = {</span>
<a href="#l25.6"></a><span id="l25.6">             onGetResult: function (calendar, status, itemType, detail, count, items) {</span>
<a href="#l25.7"></a><span id="l25.7">             },</span>
<a href="#l25.8"></a><span id="l25.8">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag ) {</span>
<a href="#l25.9"></a><span id="l25.9">                 let newOfflineJournalFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l25.10"></a><span id="l25.10">                 if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD || oldOfflineJournalFlag == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l25.11"></a><span id="l25.11">                     // Do nothing since a flag of &quot;created&quot; or &quot;deleted&quot; exists</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-                }</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                else {</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+                } else {</span>
<a href="#l25.15"></a><span id="l25.15">                     this_.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l25.16"></a><span id="l25.16">                 }</span>
<a href="#l25.17"></a><span id="l25.17">                 this_.notifyOperationComplete(aListener,</span>
<a href="#l25.18"></a><span id="l25.18">                                               Components.results.NS_OK,</span>
<a href="#l25.19"></a><span id="l25.19">                                               Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l25.20"></a><span id="l25.20">                                               aItem.id,</span>
<a href="#l25.21"></a><span id="l25.21">                                               aItem);</span>
<a href="#l25.22"></a><span id="l25.22">             }</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineat">@@ -1057,18 +1056,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">             },</span>
<a href="#l25.26"></a><span id="l25.26">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l25.27"></a><span id="l25.27">                 var newOfflineJournalFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l25.28"></a><span id="l25.28">                 if (oldOfflineJournalFlag) {</span>
<a href="#l25.29"></a><span id="l25.29">                     // Delete item if flag is c</span>
<a href="#l25.30"></a><span id="l25.30">                     if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l25.31"></a><span id="l25.31">                         this_.deleteItemById(aItem.id);</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-                    }</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-                    else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+                    } else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l25.35"></a><span id="l25.35">                         this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l25.36"></a><span id="l25.36">                     }</span>
<a href="#l25.37"></a><span id="l25.37">                 } else {</span>
<a href="#l25.38"></a><span id="l25.38">                     this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l25.39"></a><span id="l25.39">                 }</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">                 this_.notifyOperationComplete(aListener,</span>
<a href="#l25.42"></a><span id="l25.42">                                              Components.results.NS_OK,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineat">@@ -1654,19 +1652,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.44"></a><span id="l25.44">     // select is executing but this no longer seems to be required.</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">     getAdditionalDataForItem: function cSC_getAdditionalDataForItem(item, flags) {</span>
<a href="#l25.47"></a><span id="l25.47">         // This is needed to keep the modification time intact.</span>
<a href="#l25.48"></a><span id="l25.48">         var savedLastModifiedTime = item.lastModifiedTime;</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50">         if (flags &amp; CAL_ITEM_FLAG.HAS_ATTENDEES) {</span>
<a href="#l25.51"></a><span id="l25.51">             var selectItem = null;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-            if (item.recurrenceId == null)</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+            if (item.recurrenceId == null) {</span>
<a href="#l25.54"></a><span id="l25.54">                 selectItem = this.mSelectAttendeesForItem;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-            else {</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+            } else {</span>
<a href="#l25.57"></a><span id="l25.57">                 selectItem = this.mSelectAttendeesForItemWithRecurrenceId;</span>
<a href="#l25.58"></a><span id="l25.58">                 this.setDateParamHelper(selectItem.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l25.59"></a><span id="l25.59">             }</span>
<a href="#l25.60"></a><span id="l25.60"> </span>
<a href="#l25.61"></a><span id="l25.61">             try {</span>
<a href="#l25.62"></a><span id="l25.62">                 this.prepareStatement(selectItem);</span>
<a href="#l25.63"></a><span id="l25.63">                 selectItem.params.item_id = item.id;</span>
<a href="#l25.64"></a><span id="l25.64">                 while (selectItem.step()) {</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineat">@@ -1683,19 +1681,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.66"></a><span id="l25.66">             } finally {</span>
<a href="#l25.67"></a><span id="l25.67">                 selectItem.reset();</span>
<a href="#l25.68"></a><span id="l25.68">             }</span>
<a href="#l25.69"></a><span id="l25.69">         }</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">         var row;</span>
<a href="#l25.72"></a><span id="l25.72">         if (flags &amp; CAL_ITEM_FLAG.HAS_PROPERTIES) {</span>
<a href="#l25.73"></a><span id="l25.73">             var selectItem = null;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-            if (item.recurrenceId == null)</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+            if (item.recurrenceId == null) {</span>
<a href="#l25.76"></a><span id="l25.76">                 selectItem = this.mSelectPropertiesForItem;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-            else {</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+            } else {</span>
<a href="#l25.79"></a><span id="l25.79">                 selectItem = this.mSelectPropertiesForItemWithRecurrenceId;</span>
<a href="#l25.80"></a><span id="l25.80">                 this.setDateParamHelper(selectItem.params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l25.81"></a><span id="l25.81">             }</span>
<a href="#l25.82"></a><span id="l25.82"> </span>
<a href="#l25.83"></a><span id="l25.83">             try {</span>
<a href="#l25.84"></a><span id="l25.84">                 this.prepareStatement(selectItem);</span>
<a href="#l25.85"></a><span id="l25.85">                 selectItem.params.item_id = item.id;</span>
<a href="#l25.86"></a><span id="l25.86">                 while (selectItem.step()) {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineat">@@ -1759,20 +1757,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.88"></a><span id="l25.88"> </span>
<a href="#l25.89"></a><span id="l25.89">                         ritem.type = row.recur_type;</span>
<a href="#l25.90"></a><span id="l25.90">                         if (row.count) {</span>
<a href="#l25.91"></a><span id="l25.91">                             try {</span>
<a href="#l25.92"></a><span id="l25.92">                                 ritem.count = row.count;</span>
<a href="#l25.93"></a><span id="l25.93">                             } catch (exc) {</span>
<a href="#l25.94"></a><span id="l25.94">                             }</span>
<a href="#l25.95"></a><span id="l25.95">                         } else {</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-                            if (row.end_date)</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+                            if (row.end_date) {</span>
<a href="#l25.98"></a><span id="l25.98">                                 ritem.untilDate = newDateTime(row.end_date, &quot;UTC&quot;);</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-                            else</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+                            } else {</span>
<a href="#l25.101"></a><span id="l25.101">                                 ritem.untilDate = null;</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+                            }</span>
<a href="#l25.103"></a><span id="l25.103">                         }</span>
<a href="#l25.104"></a><span id="l25.104">                         try {</span>
<a href="#l25.105"></a><span id="l25.105">                             ritem.interval = row.interval;</span>
<a href="#l25.106"></a><span id="l25.106">                         } catch (exc) {</span>
<a href="#l25.107"></a><span id="l25.107">                         }</span>
<a href="#l25.108"></a><span id="l25.108"> </span>
<a href="#l25.109"></a><span id="l25.109">                         var rtypes = [&quot;second&quot;,</span>
<a href="#l25.110"></a><span id="l25.110">                                       &quot;minute&quot;,</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineat">@@ -2306,20 +2305,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l25.112"></a><span id="l25.112">                             datestr += dateToText(getInUtcOrKeepFloating(rdates[j]));</span>
<a href="#l25.113"></a><span id="l25.113">                         }</span>
<a href="#l25.114"></a><span id="l25.114"> </span>
<a href="#l25.115"></a><span id="l25.115">                         ap.dates = datestr;</span>
<a href="#l25.116"></a><span id="l25.116"> </span>
<a href="#l25.117"></a><span id="l25.117">                     } else if (calInstanceOf(ritem, Components.interfaces.calIRecurrenceRule)) {</span>
<a href="#l25.118"></a><span id="l25.118">                         ap.recur_type = ritem.type;</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-                        if (ritem.isByCount)</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+                        if (ritem.isByCount) {</span>
<a href="#l25.122"></a><span id="l25.122">                             ap.count = ritem.count;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-                        else</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+                        } else {</span>
<a href="#l25.125"></a><span id="l25.125">                             ap.end_date = ritem.untilDate ? ritem.untilDate.nativeTime : null;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+                        }</span>
<a href="#l25.127"></a><span id="l25.127"> </span>
<a href="#l25.128"></a><span id="l25.128">                         ap.interval = ritem.interval;</span>
<a href="#l25.129"></a><span id="l25.129"> </span>
<a href="#l25.130"></a><span id="l25.130">                         var rtypes = [&quot;second&quot;,</span>
<a href="#l25.131"></a><span id="l25.131">                                       &quot;minute&quot;,</span>
<a href="#l25.132"></a><span id="l25.132">                                       &quot;hour&quot;,</span>
<a href="#l25.133"></a><span id="l25.133">                                       &quot;day&quot;,</span>
<a href="#l25.134"></a><span id="l25.134">                                       &quot;monthday&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

