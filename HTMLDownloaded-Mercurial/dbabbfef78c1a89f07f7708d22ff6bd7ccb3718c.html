<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24386:dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c" />
<meta property="og:url" content="/comm-central/rev/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/accountcreation (automatic changes). r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">shortlog</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">files</a> |
changeset |
<a href="/comm-central/raw-rev/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">raw</a>  | <a href="/comm-central/archive/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/accountcreation (automatic changes). r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 30 Jul 2018 02:38:00 +0200</td></tr>

<tr>
 <td>changeset 24386</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c</a></td>
</tr>



<tr>
<td>parent 24385</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/75492d81b44d54bbd780c367a8f292e0c82c9e30">75492d81b44d54bbd780c367a8f292e0c82c9e30</a>
</td>
</tr>

<tr>
<td>child 24387</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f536b94ef28519efeaa88c9f2cc6b879a69f5bb9">f536b94ef28519efeaa88c9f2cc6b879a69f5bb9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c">14681</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 30 Jul 2018 19:34:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f536b94ef285 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f536b94ef28519efeaa88c9f2cc6b879a69f5bb9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f536b94ef28519efeaa88c9f2cc6b879a69f5bb9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f536b94ef28519efeaa88c9f2cc6b879a69f5bb9&newProject=comm-central&newRevision=dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f536b94ef28519efeaa88c9f2cc6b879a69f5bb9&newProject=comm-central&newRevision=dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f536b94ef28519efeaa88c9f2cc6b879a69f5bb9&newProject=comm-central&newRevision=dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/accountcreation (automatic changes). r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">mail/components/accountcreation/content/MyBadCertHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/MyBadCertHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">mail/components/accountcreation/content/accountConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/accountConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">mail/components/accountcreation/content/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">mail/components/accountcreation/content/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">mail/components/accountcreation/content/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">mail/components/accountcreation/content/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">mail/components/accountcreation/content/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">mail/components/accountcreation/content/sanitizeDatatypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/sanitizeDatatypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">mail/components/accountcreation/content/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/util.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">mail/components/accountcreation/content/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/dbabbfef78c1a89f07f7708d22ff6bd7ccb3718c/mail/components/accountcreation/content/verifyConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -36,16 +36,17 @@ mail/extensions/**</span>
<a href="#l1.4"></a><span id="l1.4"> mail/installer/**</span>
<a href="#l1.5"></a><span id="l1.5"> mail/locales/**</span>
<a href="#l1.6"></a><span id="l1.6"> mail/test/**</span>
<a href="#l1.7"></a><span id="l1.7"> mail/themes/**</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> # mail/components exclusions</span>
<a href="#l1.10"></a><span id="l1.10"> mail/components/*</span>
<a href="#l1.11"></a><span id="l1.11"> !mail/components/about-support</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+!mail/components/accountcreation</span>
<a href="#l1.13"></a><span id="l1.13"> !mail/components/extensions</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> # calendar/ exclusions</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> # prefs files</span>
<a href="#l1.18"></a><span id="l1.18"> calendar/lightning/content/lightning.js</span>
<a href="#l1.19"></a><span id="l1.19"> calendar/locales/en-US/lightning-l10n.js</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/accountcreation/content/MyBadCertHandler.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/accountcreation/content/MyBadCertHandler.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,33 +4,32 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> /**</span>
<a href="#l2.7"></a><span id="l2.7">  * This class implements nsIBadCertListener.  It's job is to prevent &quot;bad cert&quot;</span>
<a href="#l2.8"></a><span id="l2.8">  * security dialogs from being shown to the user.  We call back to the</span>
<a href="#l2.9"></a><span id="l2.9">  * 'callback' object's method &quot;processCertError&quot; so that it can deal with it as</span>
<a href="#l2.10"></a><span id="l2.10">  * needed (in the case of autoconfig, setting up temporary overrides).</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function BadCertHandler(callback)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+function BadCertHandler(callback) {</span>
<a href="#l2.15"></a><span id="l2.15">   this._init(callback);</span>
<a href="#l2.16"></a><span id="l2.16"> }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> BadCertHandler.prototype =</span>
<a href="#l2.19"></a><span id="l2.19"> {</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  _init: function(callback) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  _init(callback) {</span>
<a href="#l2.22"></a><span id="l2.22">     this._callback = callback;</span>
<a href="#l2.23"></a><span id="l2.23">   },</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   // Suppress any certificate errors</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l2.28"></a><span id="l2.28">     return this._callback.processCertError(socketInfo, status, targetSite);</span>
<a href="#l2.29"></a><span id="l2.29">   },</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">   // nsIInterfaceRequestor</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  getInterface: function(iid) {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  getInterface(iid) {</span>
<a href="#l2.34"></a><span id="l2.34">     return this.QueryInterface(iid);</span>
<a href="#l2.35"></a><span id="l2.35">   },</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // nsISupports</span>
<a href="#l2.38"></a><span id="l2.38">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBadCertListener2&quot;,</span>
<a href="#l2.39"></a><span id="l2.39">                                           &quot;nsIInterfaceRequestor&quot;]),</span>
<a href="#l2.40"></a><span id="l2.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/accountcreation/content/accountConfig.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/accountcreation/content/accountConfig.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -15,153 +15,148 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * new object and returns that, and the caller can copy these</span>
<a href="#l3.5"></a><span id="l3.5">  * values into the object used by the UI.</span>
<a href="#l3.6"></a><span id="l3.6">  *</span>
<a href="#l3.7"></a><span id="l3.7">  * See also</span>
<a href="#l3.8"></a><span id="l3.8">  * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l3.9"></a><span id="l3.9">  * for values stored.</span>
<a href="#l3.10"></a><span id="l3.10">  */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function AccountConfig()</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+function AccountConfig() {</span>
<a href="#l3.15"></a><span id="l3.15">   this.incoming = this.createNewIncoming();</span>
<a href="#l3.16"></a><span id="l3.16">   this.incomingAlternatives = [];</span>
<a href="#l3.17"></a><span id="l3.17">   this.outgoing = this.createNewOutgoing();</span>
<a href="#l3.18"></a><span id="l3.18">   this.outgoingAlternatives = [];</span>
<a href="#l3.19"></a><span id="l3.19">   this.identity =</span>
<a href="#l3.20"></a><span id="l3.20">   {</span>
<a href="#l3.21"></a><span id="l3.21">     // displayed real name of user</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    realname : &quot;%REALNAME%&quot;,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    realname: &quot;%REALNAME%&quot;,</span>
<a href="#l3.24"></a><span id="l3.24">     // email address of user, as shown in From of outgoing mails</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    emailAddress : &quot;%EMAILADDRESS%&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    emailAddress: &quot;%EMAILADDRESS%&quot;,</span>
<a href="#l3.27"></a><span id="l3.27">   };</span>
<a href="#l3.28"></a><span id="l3.28">   this.inputFields = [];</span>
<a href="#l3.29"></a><span id="l3.29">   this.domains = [];</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-};</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+}</span>
<a href="#l3.32"></a><span id="l3.32"> AccountConfig.prototype =</span>
<a href="#l3.33"></a><span id="l3.33"> {</span>
<a href="#l3.34"></a><span id="l3.34">   // @see createNewIncoming()</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  incoming : null,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  incoming: null,</span>
<a href="#l3.37"></a><span id="l3.37">   // @see createNewOutgoing()</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  outgoing : null,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  outgoing: null,</span>
<a href="#l3.40"></a><span id="l3.40">   /**</span>
<a href="#l3.41"></a><span id="l3.41">    * Other servers which can be used instead of |incoming|,</span>
<a href="#l3.42"></a><span id="l3.42">    * in order of decreasing preference.</span>
<a href="#l3.43"></a><span id="l3.43">    * (|incoming| itself should not be included here.)</span>
<a href="#l3.44"></a><span id="l3.44">    * { Array of incoming/createNewIncoming() }</span>
<a href="#l3.45"></a><span id="l3.45">    */</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  incomingAlternatives : null,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  outgoingAlternatives : null,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  incomingAlternatives: null,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  outgoingAlternatives: null,</span>
<a href="#l3.50"></a><span id="l3.50">   // OAuth2 configuration, if needed.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  oauthSettings : null,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  oauthSettings: null,</span>
<a href="#l3.53"></a><span id="l3.53">   // just an internal string to refer to this. Do not show to user.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  id : null,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  id: null,</span>
<a href="#l3.56"></a><span id="l3.56">   // who created the config.</span>
<a href="#l3.57"></a><span id="l3.57">   // { one of kSource* }</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  source : 0,</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  displayName : null,</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  source: 0,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  displayName: null,</span>
<a href="#l3.62"></a><span id="l3.62">   // { Array of { varname (value without %), displayName, exampleValue } }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  inputFields : null,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  inputFields: null,</span>
<a href="#l3.65"></a><span id="l3.65">   // email address domains for which this config is applicable</span>
<a href="#l3.66"></a><span id="l3.66">   // { Array of Strings }</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  domains : null,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  domains: null,</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">   /**</span>
<a href="#l3.71"></a><span id="l3.71">    * Factory function for incoming and incomingAlternatives</span>
<a href="#l3.72"></a><span id="l3.72">    */</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  createNewIncoming : function()</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  {</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  createNewIncoming() {</span>
<a href="#l3.76"></a><span id="l3.76">     return {</span>
<a href="#l3.77"></a><span id="l3.77">       // { String-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot; }</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      type : null,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-      hostname : null,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      type: null,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+      hostname: null,</span>
<a href="#l3.82"></a><span id="l3.82">       // { Integer }</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-      port : null,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+      port: null,</span>
<a href="#l3.85"></a><span id="l3.85">       // May be a placeholder (starts and ends with %). { String }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-      username : null,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-      password : null,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      username: null,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+      password: null,</span>
<a href="#l3.90"></a><span id="l3.90">       // { enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always, 0 = not inited }</span>
<a href="#l3.91"></a><span id="l3.91">       // ('TLS when available' is insecure and not supported here)</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      socketType : 0,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+      socketType: 0,</span>
<a href="#l3.94"></a><span id="l3.94">       /**</span>
<a href="#l3.95"></a><span id="l3.95">        * true when the cert is invalid (and thus SSL useless), because it's</span>
<a href="#l3.96"></a><span id="l3.96">        * 1) not from an accepted CA (including self-signed certs)</span>
<a href="#l3.97"></a><span id="l3.97">        * 2) for a different hostname or</span>
<a href="#l3.98"></a><span id="l3.98">        * 3) expired.</span>
<a href="#l3.99"></a><span id="l3.99">        * May go back to false when user explicitly accepted the cert.</span>
<a href="#l3.100"></a><span id="l3.100">        */</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      badCert : false,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      badCert: false,</span>
<a href="#l3.103"></a><span id="l3.103">       /**</span>
<a href="#l3.104"></a><span id="l3.104">        * How to log in to the server: plaintext or encrypted pw, GSSAPI etc.</span>
<a href="#l3.105"></a><span id="l3.105">        * Defined by Ci.nsMsgAuthMethod</span>
<a href="#l3.106"></a><span id="l3.106">        * Same as server pref &quot;authMethod&quot;.</span>
<a href="#l3.107"></a><span id="l3.107">        */</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-      auth : 0,</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+      auth: 0,</span>
<a href="#l3.110"></a><span id="l3.110">       /**</span>
<a href="#l3.111"></a><span id="l3.111">        * Other auth methods that we think the server supports.</span>
<a href="#l3.112"></a><span id="l3.112">        * They are ordered by descreasing preference.</span>
<a href="#l3.113"></a><span id="l3.113">        * (|auth| itself is not included in |authAlternatives|)</span>
<a href="#l3.114"></a><span id="l3.114">        * {Array of Ci.nsMsgAuthMethod} (same as .auth)</span>
<a href="#l3.115"></a><span id="l3.115">        */</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-      authAlternatives : null,</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+      authAlternatives: null,</span>
<a href="#l3.118"></a><span id="l3.118">       // in minutes { Integer }</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-      checkInterval : 10,</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-      loginAtStartup : true,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+      checkInterval: 10,</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      loginAtStartup: true,</span>
<a href="#l3.123"></a><span id="l3.123">       // POP3 only:</span>
<a href="#l3.124"></a><span id="l3.124">       // Not yet implemented. { Boolean }</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-      useGlobalInbox : false,</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-      leaveMessagesOnServer : true,</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-      daysToLeaveMessagesOnServer : 14,</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-      deleteByAgeFromServer : true,</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+      useGlobalInbox: false,</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+      leaveMessagesOnServer: true,</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+      daysToLeaveMessagesOnServer: 14,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+      deleteByAgeFromServer: true,</span>
<a href="#l3.133"></a><span id="l3.133">       // When user hits delete, delete from local store and from server</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-      deleteOnServerWhenLocalDelete : true,</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-      downloadOnBiff : true,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+      deleteOnServerWhenLocalDelete: true,</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+      downloadOnBiff: true,</span>
<a href="#l3.138"></a><span id="l3.138">     };</span>
<a href="#l3.139"></a><span id="l3.139">   },</span>
<a href="#l3.140"></a><span id="l3.140">   /**</span>
<a href="#l3.141"></a><span id="l3.141">    * Factory function for outgoing and outgoingAlternatives</span>
<a href="#l3.142"></a><span id="l3.142">    */</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-  createNewOutgoing : function()</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-  {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  createNewOutgoing() {</span>
<a href="#l3.146"></a><span id="l3.146">     return {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-      type : &quot;smtp&quot;,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-      hostname : null,</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-      port : null, // see incoming</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-      username : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-      password : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      socketType : 0, // see incoming</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      badCert : false, // see incoming</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-      auth : 0, // see incoming</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-      authAlternatives : null, // see incoming</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-      addThisServer : true, // if we already have an SMTP server, add this</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+      type: &quot;smtp&quot;,</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+      hostname: null,</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+      port: null,     // see incoming</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+      username: null, // see incoming. may be null, if auth is 0.</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+      password: null, // see incoming. may be null, if auth is 0.</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+      socketType: 0,  // see incoming</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+      badCert: false, // see incoming</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+      auth: 0,        // see incoming</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+      authAlternatives: null, // see incoming</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+      addThisServer: true,    // if we already have an SMTP server, add this</span>
<a href="#l3.167"></a><span id="l3.167">       // if we already have an SMTP server, use it.</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-      useGlobalPreferredServer : false,</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+      useGlobalPreferredServer: false,</span>
<a href="#l3.170"></a><span id="l3.170">       // we should reuse an already configured SMTP server.</span>
<a href="#l3.171"></a><span id="l3.171">       // nsISmtpServer.key</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-      existingServerKey : null,</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+      existingServerKey: null,</span>
<a href="#l3.174"></a><span id="l3.174">       // user display value for existingServerKey</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-      existingServerLabel : null,</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+      existingServerLabel: null,</span>
<a href="#l3.177"></a><span id="l3.177">     };</span>
<a href="#l3.178"></a><span id="l3.178">   },</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180">   /**</span>
<a href="#l3.181"></a><span id="l3.181">    * Returns a deep copy of this object,</span>
<a href="#l3.182"></a><span id="l3.182">    * i.e. modifying the copy will not affect the original object.</span>
<a href="#l3.183"></a><span id="l3.183">    */</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  copy : function()</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  copy() {</span>
<a href="#l3.187"></a><span id="l3.187">     // Workaround: deepCopy() fails to preserve base obj (instanceof)</span>
<a href="#l3.188"></a><span id="l3.188">     var result = new AccountConfig();</span>
<a href="#l3.189"></a><span id="l3.189">     for (var prop in this)</span>
<a href="#l3.190"></a><span id="l3.190">       result[prop] = deepCopy(this[prop]);</span>
<a href="#l3.191"></a><span id="l3.191"> </span>
<a href="#l3.192"></a><span id="l3.192">     return result;</span>
<a href="#l3.193"></a><span id="l3.193">   },</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  isComplete : function()</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  isComplete() {</span>
<a href="#l3.197"></a><span id="l3.197">     return (!!this.incoming.hostname &amp;&amp; !!this.incoming.port &amp;&amp;</span>
<a href="#l3.198"></a><span id="l3.198">          !!this.incoming.socketType &amp;&amp; !!this.incoming.auth &amp;&amp;</span>
<a href="#l3.199"></a><span id="l3.199">          !!this.incoming.username &amp;&amp;</span>
<a href="#l3.200"></a><span id="l3.200">          (!!this.outgoing.existingServerKey ||</span>
<a href="#l3.201"></a><span id="l3.201">           (!!this.outgoing.hostname &amp;&amp; !!this.outgoing.port &amp;&amp;</span>
<a href="#l3.202"></a><span id="l3.202">            !!this.outgoing.socketType &amp;&amp; !!this.outgoing.auth &amp;&amp;</span>
<a href="#l3.203"></a><span id="l3.203">            !!this.outgoing.username)));</span>
<a href="#l3.204"></a><span id="l3.204">   },</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineat">@@ -204,18 +199,17 @@ AccountConfig.kSourceGuess = 3; // guess</span>
<a href="#l3.206"></a><span id="l3.206">  * Empty of incomplete email addresses will/may be rejected.</span>
<a href="#l3.207"></a><span id="l3.207">  *</span>
<a href="#l3.208"></a><span id="l3.208">  * @param realname {String}</span>
<a href="#l3.209"></a><span id="l3.209">  * Real name of user, as will appear in From of outgoing messages</span>
<a href="#l3.210"></a><span id="l3.210">  *</span>
<a href="#l3.211"></a><span id="l3.211">  * @param password {String}</span>
<a href="#l3.212"></a><span id="l3.212">  * The password for the incoming server and (if necessary) the outgoing server</span>
<a href="#l3.213"></a><span id="l3.213">  */</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-function replaceVariables(account, realname, emailfull, password)</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-{</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+function replaceVariables(account, realname, emailfull, password) {</span>
<a href="#l3.217"></a><span id="l3.217">   sanitize.nonemptystring(emailfull);</span>
<a href="#l3.218"></a><span id="l3.218">   let emailsplit = emailfull.split(&quot;@&quot;);</span>
<a href="#l3.219"></a><span id="l3.219">   assert(emailsplit.length == 2,</span>
<a href="#l3.220"></a><span id="l3.220">          &quot;email address not in expected format: must contain exactly one @&quot;);</span>
<a href="#l3.221"></a><span id="l3.221">   let emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l3.222"></a><span id="l3.222">   let emaildomain = sanitize.hostname(emailsplit[1]);</span>
<a href="#l3.223"></a><span id="l3.223">   sanitize.label(realname);</span>
<a href="#l3.224"></a><span id="l3.224">   sanitize.nonemptystring(realname);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineat">@@ -241,18 +235,17 @@ function replaceVariables(account, realn</span>
<a href="#l3.226"></a><span id="l3.226">         _replaceVariable(account.outgoing.hostname, otherVariables);</span>
<a href="#l3.227"></a><span id="l3.227">   account.identity.realname =</span>
<a href="#l3.228"></a><span id="l3.228">       _replaceVariable(account.identity.realname, otherVariables);</span>
<a href="#l3.229"></a><span id="l3.229">   account.identity.emailAddress =</span>
<a href="#l3.230"></a><span id="l3.230">       _replaceVariable(account.identity.emailAddress, otherVariables);</span>
<a href="#l3.231"></a><span id="l3.231">   account.displayName = _replaceVariable(account.displayName, otherVariables);</span>
<a href="#l3.232"></a><span id="l3.232"> }</span>
<a href="#l3.233"></a><span id="l3.233"> </span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-function _replaceVariable(variable, values)</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-{</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+function _replaceVariable(variable, values) {</span>
<a href="#l3.237"></a><span id="l3.237">   let str = variable;</span>
<a href="#l3.238"></a><span id="l3.238">   if (typeof(str) != &quot;string&quot;)</span>
<a href="#l3.239"></a><span id="l3.239">     return str;</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241">   for (let varname in values)</span>
<a href="#l3.242"></a><span id="l3.242">       str = str.replace(&quot;%&quot; + varname + &quot;%&quot;, values[varname]);</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244">   return str;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/accountcreation/content/createInBackend.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/accountcreation/content/createInBackend.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -10,18 +10,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * @param config {AccountConfig} The account to create</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * @return - the account created.</span>
<a href="#l4.7"></a><span id="l4.7">  */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function createAccountInBackend(config)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function createAccountInBackend(config) {</span>
<a href="#l4.15"></a><span id="l4.15">   // incoming server</span>
<a href="#l4.16"></a><span id="l4.16">   let inServer = MailServices.accounts.createIncomingServer(</span>
<a href="#l4.17"></a><span id="l4.17">       config.incoming.username,</span>
<a href="#l4.18"></a><span id="l4.18">       config.incoming.hostname,</span>
<a href="#l4.19"></a><span id="l4.19">       sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l4.20"></a><span id="l4.20">   inServer.port = config.incoming.port;</span>
<a href="#l4.21"></a><span id="l4.21">   inServer.authMethod = config.incoming.auth;</span>
<a href="#l4.22"></a><span id="l4.22">   inServer.password = config.incoming.password;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -35,29 +34,28 @@ function createAccountInBackend(config)</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   // SSL</span>
<a href="#l4.26"></a><span id="l4.26">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l4.27"></a><span id="l4.27">     inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l4.28"></a><span id="l4.28">   else if (config.incoming.socketType == 2) // SSL / TLS</span>
<a href="#l4.29"></a><span id="l4.29">     inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l4.30"></a><span id="l4.30">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l4.31"></a><span id="l4.31">     inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  //inServer.prettyName = config.displayName;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  // inServer.prettyName = config.displayName;</span>
<a href="#l4.34"></a><span id="l4.34">   inServer.prettyName = config.identity.emailAddress;</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">   inServer.doBiff = true;</span>
<a href="#l4.37"></a><span id="l4.37">   inServer.biffMinutes = config.incoming.checkInterval;</span>
<a href="#l4.38"></a><span id="l4.38">   const loginAtStartupPrefTemplate =</span>
<a href="#l4.39"></a><span id="l4.39">     &quot;mail.server.%serverkey%.login_at_startup&quot;;</span>
<a href="#l4.40"></a><span id="l4.40">   var loginAtStartupPref =</span>
<a href="#l4.41"></a><span id="l4.41">     loginAtStartupPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l4.42"></a><span id="l4.42">   Services.prefs.setBoolPref(loginAtStartupPref,</span>
<a href="#l4.43"></a><span id="l4.43">                              config.incoming.loginAtStartup);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  if (config.incoming.type == &quot;pop3&quot;)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  if (config.incoming.type == &quot;pop3&quot;) {</span>
<a href="#l4.47"></a><span id="l4.47">     const leaveOnServerPrefTemplate =</span>
<a href="#l4.48"></a><span id="l4.48">       &quot;mail.server.%serverkey%.leave_on_server&quot;;</span>
<a href="#l4.49"></a><span id="l4.49">     const daysToLeaveOnServerPrefTemplate =</span>
<a href="#l4.50"></a><span id="l4.50">       &quot;mail.server.%serverkey%.num_days_to_leave_on_server&quot;;</span>
<a href="#l4.51"></a><span id="l4.51">     const deleteFromServerPrefTemplate =</span>
<a href="#l4.52"></a><span id="l4.52">       &quot;mail.server.%serverkey%.delete_mail_left_on_server&quot;;</span>
<a href="#l4.53"></a><span id="l4.53">     const deleteByAgeFromServerPrefTemplate =</span>
<a href="#l4.54"></a><span id="l4.54">       &quot;mail.server.%serverkey%.delete_by_age_from_server&quot;;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineat">@@ -88,24 +86,22 @@ function createAccountInBackend(config)</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57">   let username = config.outgoing.auth &gt; 1 ? config.outgoing.username : null;</span>
<a href="#l4.58"></a><span id="l4.58">   let outServer = MailServices.smtp.findServer(username, config.outgoing.hostname);</span>
<a href="#l4.59"></a><span id="l4.59">   assert(config.outgoing.addThisServer ||</span>
<a href="#l4.60"></a><span id="l4.60">          config.outgoing.useGlobalPreferredServer ||</span>
<a href="#l4.61"></a><span id="l4.61">          config.outgoing.existingServerKey,</span>
<a href="#l4.62"></a><span id="l4.62">          &quot;No SMTP server: inconsistent flags&quot;);</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  if (config.outgoing.addThisServer &amp;&amp; !outServer)</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  if (config.outgoing.addThisServer &amp;&amp; !outServer) {</span>
<a href="#l4.67"></a><span id="l4.67">     outServer = MailServices.smtp.createServer();</span>
<a href="#l4.68"></a><span id="l4.68">     outServer.hostname = config.outgoing.hostname;</span>
<a href="#l4.69"></a><span id="l4.69">     outServer.port = config.outgoing.port;</span>
<a href="#l4.70"></a><span id="l4.70">     outServer.authMethod = config.outgoing.auth;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    if (config.outgoing.auth &gt; 1)</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    if (config.outgoing.auth &gt; 1) {</span>
<a href="#l4.74"></a><span id="l4.74">       outServer.username = username;</span>
<a href="#l4.75"></a><span id="l4.75">       outServer.password = config.incoming.password;</span>
<a href="#l4.76"></a><span id="l4.76">       if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l4.77"></a><span id="l4.77">         rememberPassword(outServer, config.incoming.password);</span>
<a href="#l4.78"></a><span id="l4.78">     }</span>
<a href="#l4.79"></a><span id="l4.79"> </span>
<a href="#l4.80"></a><span id="l4.80">     if (outServer.authMethod == Ci.nsMsgAuthMethod.OAuth2) {</span>
<a href="#l4.81"></a><span id="l4.81">       let pref = &quot;mail.smtpserver.&quot; + outServer.key + &quot;.&quot;;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineat">@@ -136,29 +132,26 @@ function createAccountInBackend(config)</span>
<a href="#l4.83"></a><span id="l4.83">   // identity</span>
<a href="#l4.84"></a><span id="l4.84">   // TODO accounts without identity?</span>
<a href="#l4.85"></a><span id="l4.85">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l4.86"></a><span id="l4.86">   identity.fullName = config.identity.realname;</span>
<a href="#l4.87"></a><span id="l4.87">   identity.email = config.identity.emailAddress;</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">   // for new accounts, default to replies being positioned above the quote</span>
<a href="#l4.90"></a><span id="l4.90">   // if a default account is defined already, take its settings instead</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  if (config.incoming.type == &quot;imap&quot; || config.incoming.type == &quot;pop3&quot;)</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  if (config.incoming.type == &quot;imap&quot; || config.incoming.type == &quot;pop3&quot;) {</span>
<a href="#l4.94"></a><span id="l4.94">     identity.replyOnTop = 1;</span>
<a href="#l4.95"></a><span id="l4.95">     // identity.sigBottom = false; // don't set this until Bug 218346 is fixed</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">     if (MailServices.accounts.accounts.length &amp;&amp;</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-        MailServices.accounts.defaultAccount)</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        MailServices.accounts.defaultAccount) {</span>
<a href="#l4.101"></a><span id="l4.101">       let defAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l4.102"></a><span id="l4.102">       let defIdentity = defAccount.defaultIdentity;</span>
<a href="#l4.103"></a><span id="l4.103">       if (defAccount.incomingServer.canBeDefaultServer &amp;&amp;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-          defIdentity &amp;&amp; defIdentity.valid)</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-      {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+          defIdentity &amp;&amp; defIdentity.valid) {</span>
<a href="#l4.107"></a><span id="l4.107">         identity.replyOnTop = defIdentity.replyOnTop;</span>
<a href="#l4.108"></a><span id="l4.108">         identity.sigBottom = defIdentity.sigBottom;</span>
<a href="#l4.109"></a><span id="l4.109">       }</span>
<a href="#l4.110"></a><span id="l4.110">     }</span>
<a href="#l4.111"></a><span id="l4.111">   }</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">   // due to accepted conventions, news accounts should default to plain text</span>
<a href="#l4.114"></a><span id="l4.114">   if (config.incoming.type == &quot;nntp&quot;)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineat">@@ -192,18 +185,17 @@ function createAccountInBackend(config)</span>
<a href="#l4.116"></a><span id="l4.116">   try {</span>
<a href="#l4.117"></a><span id="l4.117">     Services.prefs.savePrefFile(null);</span>
<a href="#l4.118"></a><span id="l4.118">   } catch (ex) {</span>
<a href="#l4.119"></a><span id="l4.119">     ddump(&quot;Could not write out prefs: &quot; + ex);</span>
<a href="#l4.120"></a><span id="l4.120">   }</span>
<a href="#l4.121"></a><span id="l4.121">   return account;</span>
<a href="#l4.122"></a><span id="l4.122"> }</span>
<a href="#l4.123"></a><span id="l4.123"> </span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-function setFolders(identity, server)</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-{</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+function setFolders(identity, server) {</span>
<a href="#l4.127"></a><span id="l4.127">   // TODO: support for local folders for global inbox (or use smart search</span>
<a href="#l4.128"></a><span id="l4.128">   // folder instead)</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">   var baseURI = server.serverURI + &quot;/&quot;;</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   // Names will be localized in UI, not in folder names on server/disk</span>
<a href="#l4.133"></a><span id="l4.133">   // TODO allow to override these names in the XML config file,</span>
<a href="#l4.134"></a><span id="l4.134">   // in case e.g. Google or AOL use different names?</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineat">@@ -216,18 +208,17 @@ function setFolders(identity, server)</span>
<a href="#l4.136"></a><span id="l4.136">   identity.stationeryFolder = baseURI + templatesName;</span>
<a href="#l4.137"></a><span id="l4.137">   identity.fccFolder = baseURI + fccName;</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139">   identity.fccFolderPickerMode = 0;</span>
<a href="#l4.140"></a><span id="l4.140">   identity.draftsFolderPickerMode = 0;</span>
<a href="#l4.141"></a><span id="l4.141">   identity.tmplFolderPickerMode = 0;</span>
<a href="#l4.142"></a><span id="l4.142"> }</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-function rememberPassword(server, password)</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-{</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+function rememberPassword(server, password) {</span>
<a href="#l4.147"></a><span id="l4.147">   if (server instanceof Ci.nsIMsgIncomingServer)</span>
<a href="#l4.148"></a><span id="l4.148">     var passwordURI = server.localStoreType + &quot;://&quot; + server.hostName;</span>
<a href="#l4.149"></a><span id="l4.149">   else if (server instanceof Ci.nsISmtpServer)</span>
<a href="#l4.150"></a><span id="l4.150">     var passwordURI = &quot;smtp://&quot; + server.hostname;</span>
<a href="#l4.151"></a><span id="l4.151">   else</span>
<a href="#l4.152"></a><span id="l4.152">     throw new NotReached(&quot;Server type not supported&quot;);</span>
<a href="#l4.153"></a><span id="l4.153"> </span>
<a href="#l4.154"></a><span id="l4.154">   let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineat">@@ -250,84 +241,76 @@ function rememberPassword(server, passwo</span>
<a href="#l4.156"></a><span id="l4.156">  * in the config.</span>
<a href="#l4.157"></a><span id="l4.157">  * (We also check the email address as username.)</span>
<a href="#l4.158"></a><span id="l4.158">  *</span>
<a href="#l4.159"></a><span id="l4.159">  * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l4.160"></a><span id="l4.160">  * @return {nsIMsgIncomingServer} If it already exists, the server</span>
<a href="#l4.161"></a><span id="l4.161">  *     object is returned.</span>
<a href="#l4.162"></a><span id="l4.162">  *     If it's a new server, |null| is returned.</span>
<a href="#l4.163"></a><span id="l4.163">  */</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-function checkIncomingServerAlreadyExists(config)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-{</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+function checkIncomingServerAlreadyExists(config) {</span>
<a href="#l4.167"></a><span id="l4.167">   assert(config instanceof AccountConfig);</span>
<a href="#l4.168"></a><span id="l4.168">   let incoming = config.incoming;</span>
<a href="#l4.169"></a><span id="l4.169">   let existing = MailServices.accounts.findRealServer(incoming.username,</span>
<a href="#l4.170"></a><span id="l4.170">         incoming.hostname,</span>
<a href="#l4.171"></a><span id="l4.171">         sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l4.172"></a><span id="l4.172">         incoming.port);</span>
<a href="#l4.173"></a><span id="l4.173"> </span>
<a href="#l4.174"></a><span id="l4.174">   // if username does not have an '@', also check the e-mail</span>
<a href="#l4.175"></a><span id="l4.175">   // address form of the name.</span>
<a href="#l4.176"></a><span id="l4.176">   if (!existing &amp;&amp; !incoming.username.includes(&quot;@&quot;))</span>
<a href="#l4.177"></a><span id="l4.177">     existing = MailServices.accounts.findRealServer(config.identity.emailAddress,</span>
<a href="#l4.178"></a><span id="l4.178">           incoming.hostname,</span>
<a href="#l4.179"></a><span id="l4.179">           sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l4.180"></a><span id="l4.180">           incoming.port);</span>
<a href="#l4.181"></a><span id="l4.181">   return existing;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-};</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+}</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185"> /**</span>
<a href="#l4.186"></a><span id="l4.186">  * Check whether the user's setup already has an outgoing server</span>
<a href="#l4.187"></a><span id="l4.187">  * which matches (hostname, port, username) the primary one</span>
<a href="#l4.188"></a><span id="l4.188">  * in the config.</span>
<a href="#l4.189"></a><span id="l4.189">  *</span>
<a href="#l4.190"></a><span id="l4.190">  * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l4.191"></a><span id="l4.191">  * @return {nsISmtpServer} If it already exists, the server</span>
<a href="#l4.192"></a><span id="l4.192">  *     object is returned.</span>
<a href="#l4.193"></a><span id="l4.193">  *     If it's a new server, |null| is returned.</span>
<a href="#l4.194"></a><span id="l4.194">  */</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-function checkOutgoingServerAlreadyExists(config)</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-{</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+function checkOutgoingServerAlreadyExists(config) {</span>
<a href="#l4.198"></a><span id="l4.198">   assert(config instanceof AccountConfig);</span>
<a href="#l4.199"></a><span id="l4.199">   let smtpServers = MailServices.smtp.servers;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  while (smtpServers.hasMoreElements())</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  while (smtpServers.hasMoreElements()) {</span>
<a href="#l4.203"></a><span id="l4.203">     let existingServer = smtpServers.getNext()</span>
<a href="#l4.204"></a><span id="l4.204">         .QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l4.205"></a><span id="l4.205">     // TODO check username with full email address, too, like for incoming</span>
<a href="#l4.206"></a><span id="l4.206">     if (existingServer.hostname == config.outgoing.hostname &amp;&amp;</span>
<a href="#l4.207"></a><span id="l4.207">         existingServer.port == config.outgoing.port &amp;&amp;</span>
<a href="#l4.208"></a><span id="l4.208">         existingServer.username == config.outgoing.username)</span>
<a href="#l4.209"></a><span id="l4.209">       return existingServer;</span>
<a href="#l4.210"></a><span id="l4.210">   }</span>
<a href="#l4.211"></a><span id="l4.211">   return null;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-};</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+}</span>
<a href="#l4.214"></a><span id="l4.214"> </span>
<a href="#l4.215"></a><span id="l4.215"> /**</span>
<a href="#l4.216"></a><span id="l4.216">  * Check if there already is a &quot;Local Folders&quot;. If not, create it.</span>
<a href="#l4.217"></a><span id="l4.217">  * Copied from AccountWizard.js with minor updates.</span>
<a href="#l4.218"></a><span id="l4.218">  */</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-function verifyLocalFoldersAccount(am)</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-{</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+function verifyLocalFoldersAccount(am) {</span>
<a href="#l4.222"></a><span id="l4.222">   let localMailServer;</span>
<a href="#l4.223"></a><span id="l4.223">   try {</span>
<a href="#l4.224"></a><span id="l4.224">     localMailServer = am.localFoldersServer;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-  }</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  catch (ex) {</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+  } catch (ex) {</span>
<a href="#l4.228"></a><span id="l4.228">     localMailServer = null;</span>
<a href="#l4.229"></a><span id="l4.229">   }</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231">   try {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-    if (!localMailServer)</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-    {</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    if (!localMailServer) {</span>
<a href="#l4.235"></a><span id="l4.235">       // creates a copy of the identity you pass in</span>
<a href="#l4.236"></a><span id="l4.236">       am.createLocalMailAccount();</span>
<a href="#l4.237"></a><span id="l4.237">       try {</span>
<a href="#l4.238"></a><span id="l4.238">         localMailServer = am.localFoldersServer;</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-      }</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      catch (ex) {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      } catch (ex) {</span>
<a href="#l4.242"></a><span id="l4.242">         ddump(&quot;Error! we should have found the local mail server &quot; +</span>
<a href="#l4.243"></a><span id="l4.243">               &quot;after we created it.&quot;);</span>
<a href="#l4.244"></a><span id="l4.244">       }</span>
<a href="#l4.245"></a><span id="l4.245">     }</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-  }</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-  catch (ex) { ddump(&quot;Error in verifyLocalFoldersAccount &quot; + ex); }</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  } catch (ex) { ddump(&quot;Error in verifyLocalFoldersAccount &quot; + ex); }</span>
<a href="#l4.249"></a><span id="l4.249"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -39,17 +39,17 @@ if (typeof gEmailWizardLogger == &quot;undefi</span>
<a href="#l5.4"></a><span id="l5.4">   ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l5.5"></a><span id="l5.5">   var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var gStringsBundle;</span>
<a href="#l5.9"></a><span id="l5.9"> var gMessengerBundle;</span>
<a href="#l5.10"></a><span id="l5.10"> var gBrandShortName;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-/*********************</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/** *******************</span>
<a href="#l5.14"></a><span id="l5.14"> TODO for bug 549045</span>
<a href="#l5.15"></a><span id="l5.15"> - autodetect protocol</span>
<a href="#l5.16"></a><span id="l5.16"> Polish</span>
<a href="#l5.17"></a><span id="l5.17"> - reformat code style to match</span>
<a href="#l5.18"></a><span id="l5.18"> &lt;https://developer.mozilla.org/En/Mozilla_Coding_Style_Guide#Control_Structures&gt;</span>
<a href="#l5.19"></a><span id="l5.19"> - bold status</span>
<a href="#l5.20"></a><span id="l5.20"> - remove status when user edited in manual edit</span>
<a href="#l5.21"></a><span id="l5.21"> - add and adapt test from bug 534588</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -70,74 +70,64 @@ Things to test (works for me):</span>
<a href="#l5.23"></a><span id="l5.23">     - when stopping [retest]: buttons proper?</span>
<a href="#l5.24"></a><span id="l5.24">   - enter nonsense domain. guess fails, (so automatically) manual,</span>
<a href="#l5.25"></a><span id="l5.25">     change domain to real one (not in DB), guess succeeds.</span>
<a href="#l5.26"></a><span id="l5.26">     former bug: goes to manual first shortly, then to result</span>
<a href="#l5.27"></a><span id="l5.27"> **********************/</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> // To debug, set mail.wizard.logging.dump (or .console)=&quot;All&quot; and kDebug = true</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-function e(elementID)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-{</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+function e(elementID) {</span>
<a href="#l5.34"></a><span id="l5.34">   return document.getElementById(elementID);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-};</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+}</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-function _hide(id)</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-{</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+function _hide(id) {</span>
<a href="#l5.41"></a><span id="l5.41">   e(id).hidden = true;</span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-function _show(id)</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-{</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+function _show(id) {</span>
<a href="#l5.47"></a><span id="l5.47">   e(id).hidden = false;</span>
<a href="#l5.48"></a><span id="l5.48"> }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-function _enable(id)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-{</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+function _enable(id) {</span>
<a href="#l5.53"></a><span id="l5.53">   e(id).disabled = false;</span>
<a href="#l5.54"></a><span id="l5.54"> }</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-function _disable(id)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-{</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+function _disable(id) {</span>
<a href="#l5.59"></a><span id="l5.59">   e(id).disabled = true;</span>
<a href="#l5.60"></a><span id="l5.60"> }</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-function setText(id, value)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-{</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+function setText(id, value) {</span>
<a href="#l5.65"></a><span id="l5.65">   var element = e(id);</span>
<a href="#l5.66"></a><span id="l5.66">   assert(element, &quot;setText() on non-existant element ID&quot;);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   if (element.localName == &quot;textbox&quot; || element.localName == &quot;label&quot;) {</span>
<a href="#l5.69"></a><span id="l5.69">     element.value = value;</span>
<a href="#l5.70"></a><span id="l5.70">   } else if (element.localName == &quot;description&quot;) {</span>
<a href="#l5.71"></a><span id="l5.71">     element.textContent = value;</span>
<a href="#l5.72"></a><span id="l5.72">   } else {</span>
<a href="#l5.73"></a><span id="l5.73">     throw new NotReached(&quot;XUL element type not supported&quot;);</span>
<a href="#l5.74"></a><span id="l5.74">   }</span>
<a href="#l5.75"></a><span id="l5.75"> }</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-{</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName) {</span>
<a href="#l5.80"></a><span id="l5.80">   e(elementID).label = gMessengerBundle.getString(stringName);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-};</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+}</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-function EmailConfigWizard()</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-{</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+function EmailConfigWizard() {</span>
<a href="#l5.87"></a><span id="l5.87">   this._init();</span>
<a href="#l5.88"></a><span id="l5.88"> }</span>
<a href="#l5.89"></a><span id="l5.89"> EmailConfigWizard.prototype =</span>
<a href="#l5.90"></a><span id="l5.90"> {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-  _init : function EmailConfigWizard__init()</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  {</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  _init: function EmailConfigWizard__init() {</span>
<a href="#l5.94"></a><span id="l5.94">     gEmailWizardLogger.info(&quot;Initializing setup wizard&quot;);</span>
<a href="#l5.95"></a><span id="l5.95">     this._abortable = null;</span>
<a href="#l5.96"></a><span id="l5.96">   },</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-  onLoad : function()</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  onLoad() {</span>
<a href="#l5.101"></a><span id="l5.101">     /**</span>
<a href="#l5.102"></a><span id="l5.102">      * this._currentConfig is the config we got either from the XML file or</span>
<a href="#l5.103"></a><span id="l5.103">      * from guessing or from the user. Unless it's from the user, it contains</span>
<a href="#l5.104"></a><span id="l5.104">      * placeholders like %EMAILLOCALPART% in username and other fields.</span>
<a href="#l5.105"></a><span id="l5.105">      *</span>
<a href="#l5.106"></a><span id="l5.106">      * The config here must retain these placeholders, to be able to</span>
<a href="#l5.107"></a><span id="l5.107">      * adapt when the user enters a different realname, or password or</span>
<a href="#l5.108"></a><span id="l5.108">      * email local part. (A change of the domain name will trigger a new</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineat">@@ -146,17 +136,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.110"></a><span id="l5.110">      * account or to show it to the user), you need to run replaceVariables().</span>
<a href="#l5.111"></a><span id="l5.111">      */</span>
<a href="#l5.112"></a><span id="l5.112">     this._currentConfig = null;</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">     let userFullname;</span>
<a href="#l5.115"></a><span id="l5.115">     try {</span>
<a href="#l5.116"></a><span id="l5.116">       let userInfo = Cc[&quot;@mozilla.org/userinfo;1&quot;].getService(Ci.nsIUserInfo);</span>
<a href="#l5.117"></a><span id="l5.117">       userFullname = userInfo.fullname;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-    } catch(e) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    } catch (e) {</span>
<a href="#l5.120"></a><span id="l5.120">       // nsIUserInfo may not be implemented on all platforms, and name might</span>
<a href="#l5.121"></a><span id="l5.121">       // not be available even if it is.</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">     this._domain = &quot;&quot;;</span>
<a href="#l5.125"></a><span id="l5.125">     this._email = &quot;&quot;;</span>
<a href="#l5.126"></a><span id="l5.126">     this._realname = (userFullname) ? userFullname : &quot;&quot;;</span>
<a href="#l5.127"></a><span id="l5.127">     e(&quot;realname&quot;).value = this._realname;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineat">@@ -261,26 +251,25 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.129"></a><span id="l5.129">    *    &quot;manual-edit-have-hostname&quot; : user entered a hostname for both servers</span>
<a href="#l5.130"></a><span id="l5.130">    *        that we can use</span>
<a href="#l5.131"></a><span id="l5.131">    *    &quot;manual-edit-testing&quot; : User pressed the [Re-test] button and</span>
<a href="#l5.132"></a><span id="l5.132">    *         we're currently detecting the &quot;Auto&quot; values</span>
<a href="#l5.133"></a><span id="l5.133">    *    &quot;manual-edit-complete&quot; : user entered (or we tested) all necessary</span>
<a href="#l5.134"></a><span id="l5.134">    *         values, and we're ready to create to account</span>
<a href="#l5.135"></a><span id="l5.135">    * Currently, this doesn't cover the warning dialogs etc.. It may later.</span>
<a href="#l5.136"></a><span id="l5.136">    */</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  switchToMode : function(modename)</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  switchToMode(modename) {</span>
<a href="#l5.140"></a><span id="l5.140">     if (modename == this._currentModename) {</span>
<a href="#l5.141"></a><span id="l5.141">       return;</span>
<a href="#l5.142"></a><span id="l5.142">     }</span>
<a href="#l5.143"></a><span id="l5.143">     this._currentModename = modename;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    gEmailWizardLogger.info(&quot;switching to UI mode &quot; + modename)</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    gEmailWizardLogger.info(&quot;switching to UI mode &quot; + modename);</span>
<a href="#l5.146"></a><span id="l5.146"> </span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-    //_show(&quot;initialSettings&quot;); always visible</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-    //_show(&quot;cancel_button&quot;); always visible</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    // _show(&quot;initialSettings&quot;); always visible</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+    // _show(&quot;cancel_button&quot;); always visible</span>
<a href="#l5.151"></a><span id="l5.151">     if (modename == &quot;start&quot;) {</span>
<a href="#l5.152"></a><span id="l5.152">       _hide(&quot;status_area&quot;);</span>
<a href="#l5.153"></a><span id="l5.153">       _hide(&quot;result_area&quot;);</span>
<a href="#l5.154"></a><span id="l5.154">       _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156">       _show(&quot;next_button&quot;);</span>
<a href="#l5.157"></a><span id="l5.157">       _disable(&quot;next_button&quot;); // will be enabled by code</span>
<a href="#l5.158"></a><span id="l5.158">       _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineat">@@ -385,90 +374,82 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.160"></a><span id="l5.160">       }</span>
<a href="#l5.161"></a><span id="l5.161">     }</span>
<a href="#l5.162"></a><span id="l5.162">     window.sizeToContent();</span>
<a href="#l5.163"></a><span id="l5.163">   },</span>
<a href="#l5.164"></a><span id="l5.164"> </span>
<a href="#l5.165"></a><span id="l5.165">   /**</span>
<a href="#l5.166"></a><span id="l5.166">    * Start from beginning with possibly new email address.</span>
<a href="#l5.167"></a><span id="l5.167">    */</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  onStartOver : function()</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-  {</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  onStartOver() {</span>
<a href="#l5.171"></a><span id="l5.171">     if (this._abortable) {</span>
<a href="#l5.172"></a><span id="l5.172">       this.onStop();</span>
<a href="#l5.173"></a><span id="l5.173">     }</span>
<a href="#l5.174"></a><span id="l5.174">     this.switchToMode(&quot;start&quot;);</span>
<a href="#l5.175"></a><span id="l5.175">   },</span>
<a href="#l5.176"></a><span id="l5.176"> </span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-  getConcreteConfig : function()</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  {</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+  getConcreteConfig() {</span>
<a href="#l5.180"></a><span id="l5.180">     var result = this._currentConfig.copy();</span>
<a href="#l5.181"></a><span id="l5.181">     replaceVariables(result, this._realname, this._email, this._password);</span>
<a href="#l5.182"></a><span id="l5.182">     result.rememberPassword = e(&quot;remember_password&quot;).checked &amp;&amp;</span>
<a href="#l5.183"></a><span id="l5.183">                               !!this._password;</span>
<a href="#l5.184"></a><span id="l5.184">     return result;</span>
<a href="#l5.185"></a><span id="l5.185">   },</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187">   /*</span>
<a href="#l5.188"></a><span id="l5.188">    * This checks if the email address is at least possibly valid, meaning it</span>
<a href="#l5.189"></a><span id="l5.189">    * has an '@' before the last char.</span>
<a href="#l5.190"></a><span id="l5.190">    */</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  validateEmailMinimally : function(emailAddr)</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-  {</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+  validateEmailMinimally(emailAddr) {</span>
<a href="#l5.194"></a><span id="l5.194">     let atPos = emailAddr.lastIndexOf(&quot;@&quot;);</span>
<a href="#l5.195"></a><span id="l5.195">     return atPos &gt; 0 &amp;&amp; atPos + 1 &lt; emailAddr.length;</span>
<a href="#l5.196"></a><span id="l5.196">   },</span>
<a href="#l5.197"></a><span id="l5.197"> </span>
<a href="#l5.198"></a><span id="l5.198">   /*</span>
<a href="#l5.199"></a><span id="l5.199">    * This checks if the email address is syntactically valid,</span>
<a href="#l5.200"></a><span id="l5.200">    * as far as we can determine. We try hard to make full checks.</span>
<a href="#l5.201"></a><span id="l5.201">    *</span>
<a href="#l5.202"></a><span id="l5.202">    * OTOH, we have a very small chance of false negatives,</span>
<a href="#l5.203"></a><span id="l5.203">    * because the RFC822 address spec is insanely complicated,</span>
<a href="#l5.204"></a><span id="l5.204">    * but rarely needed, so when this here fails, we show an error message,</span>
<a href="#l5.205"></a><span id="l5.205">    * but don't stop the user from continuing.</span>
<a href="#l5.206"></a><span id="l5.206">    * In contrast, if validateEmailMinimally() fails, we stop the user.</span>
<a href="#l5.207"></a><span id="l5.207">    */</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  validateEmail : function(emailAddr)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  {</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  validateEmail(emailAddr) {</span>
<a href="#l5.211"></a><span id="l5.211">     return emailRE.test(emailAddr);</span>
<a href="#l5.212"></a><span id="l5.212">   },</span>
<a href="#l5.213"></a><span id="l5.213"> </span>
<a href="#l5.214"></a><span id="l5.214">   /**</span>
<a href="#l5.215"></a><span id="l5.215">    * onInputEmail and onInputRealname are called on input = keypresses, and</span>
<a href="#l5.216"></a><span id="l5.216">    * enable/disable the next button based on whether there's a semi-proper</span>
<a href="#l5.217"></a><span id="l5.217">    * e-mail address and non-blank realname to start with.</span>
<a href="#l5.218"></a><span id="l5.218">    *</span>
<a href="#l5.219"></a><span id="l5.219">    * A change to the email address also automatically restarts the</span>
<a href="#l5.220"></a><span id="l5.220">    * whole process.</span>
<a href="#l5.221"></a><span id="l5.221">    */</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-  onInputEmail : function()</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-  {</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  onInputEmail() {</span>
<a href="#l5.225"></a><span id="l5.225">     this._email = e(&quot;email&quot;).value;</span>
<a href="#l5.226"></a><span id="l5.226">     this.onStartOver();</span>
<a href="#l5.227"></a><span id="l5.227">     this.checkStartDone();</span>
<a href="#l5.228"></a><span id="l5.228">   },</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-  onInputRealname : function()</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-  {</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+  onInputRealname() {</span>
<a href="#l5.232"></a><span id="l5.232">     this._realname = e(&quot;realname&quot;).value;</span>
<a href="#l5.233"></a><span id="l5.233">     this.checkStartDone();</span>
<a href="#l5.234"></a><span id="l5.234">   },</span>
<a href="#l5.235"></a><span id="l5.235"> </span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  onInputPassword : function()</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-  {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  onInputPassword() {</span>
<a href="#l5.239"></a><span id="l5.239">     this._password = e(&quot;password&quot;).value;</span>
<a href="#l5.240"></a><span id="l5.240">   },</span>
<a href="#l5.241"></a><span id="l5.241"> </span>
<a href="#l5.242"></a><span id="l5.242">   /**</span>
<a href="#l5.243"></a><span id="l5.243">    * This does very little other than to check that a name was entered at all</span>
<a href="#l5.244"></a><span id="l5.244">    * Since this is such an insignificant test we should be using a very light</span>
<a href="#l5.245"></a><span id="l5.245">    * or even jovial warning.</span>
<a href="#l5.246"></a><span id="l5.246">    */</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-  onBlurRealname : function()</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  {</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+  onBlurRealname() {</span>
<a href="#l5.250"></a><span id="l5.250">     let realnameEl = e(&quot;realname&quot;);</span>
<a href="#l5.251"></a><span id="l5.251">     if (this._realname) {</span>
<a href="#l5.252"></a><span id="l5.252">       this.clearError(&quot;nameerror&quot;);</span>
<a href="#l5.253"></a><span id="l5.253">       _show(&quot;nametext&quot;);</span>
<a href="#l5.254"></a><span id="l5.254">       realnameEl.removeAttribute(&quot;error&quot;);</span>
<a href="#l5.255"></a><span id="l5.255">     // bug 638790: don't show realname error until user enter an email address</span>
<a href="#l5.256"></a><span id="l5.256">     } else if (this.validateEmailMinimally(this._email)) {</span>
<a href="#l5.257"></a><span id="l5.257">       _hide(&quot;nametext&quot;);</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineat">@@ -477,18 +458,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.259"></a><span id="l5.259">     }</span>
<a href="#l5.260"></a><span id="l5.260">   },</span>
<a href="#l5.261"></a><span id="l5.261"> </span>
<a href="#l5.262"></a><span id="l5.262">   /**</span>
<a href="#l5.263"></a><span id="l5.263">    * This check is only done as an informative warning.</span>
<a href="#l5.264"></a><span id="l5.264">    * We don't want to block the person, if they've entered an email address</span>
<a href="#l5.265"></a><span id="l5.265">    * that doesn't conform to our regex.</span>
<a href="#l5.266"></a><span id="l5.266">    */</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-  onBlurEmail : function()</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-  {</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  onBlurEmail() {</span>
<a href="#l5.270"></a><span id="l5.270">     if (!this._email) {</span>
<a href="#l5.271"></a><span id="l5.271">       return;</span>
<a href="#l5.272"></a><span id="l5.272">     }</span>
<a href="#l5.273"></a><span id="l5.273">     var emailEl = e(&quot;email&quot;);</span>
<a href="#l5.274"></a><span id="l5.274">     if (this.validateEmail(this._email)) {</span>
<a href="#l5.275"></a><span id="l5.275">       this.clearError(&quot;emailerror&quot;);</span>
<a href="#l5.276"></a><span id="l5.276">       emailEl.removeAttribute(&quot;error&quot;);</span>
<a href="#l5.277"></a><span id="l5.277">       this.onBlurRealname();</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineat">@@ -498,66 +478,61 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.279"></a><span id="l5.279">     }</span>
<a href="#l5.280"></a><span id="l5.280">   },</span>
<a href="#l5.281"></a><span id="l5.281"> </span>
<a href="#l5.282"></a><span id="l5.282">   /**</span>
<a href="#l5.283"></a><span id="l5.283">    * If the user just tabbed through the password input without entering</span>
<a href="#l5.284"></a><span id="l5.284">    * anything, set the type back to text so we don't wind up showing the</span>
<a href="#l5.285"></a><span id="l5.285">    * emptytext as bullet characters.</span>
<a href="#l5.286"></a><span id="l5.286">    */</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  onBlurPassword : function()</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-  {</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+  onBlurPassword() {</span>
<a href="#l5.290"></a><span id="l5.290">     if (!this._password) {</span>
<a href="#l5.291"></a><span id="l5.291">       e(&quot;password&quot;).type = &quot;text&quot;;</span>
<a href="#l5.292"></a><span id="l5.292">     }</span>
<a href="#l5.293"></a><span id="l5.293">   },</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295">   /**</span>
<a href="#l5.296"></a><span id="l5.296">    * @see onBlurPassword()</span>
<a href="#l5.297"></a><span id="l5.297">    */</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-  onFocusPassword : function()</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-  {</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  onFocusPassword() {</span>
<a href="#l5.301"></a><span id="l5.301">     e(&quot;password&quot;).type = &quot;password&quot;;</span>
<a href="#l5.302"></a><span id="l5.302">   },</span>
<a href="#l5.303"></a><span id="l5.303"> </span>
<a href="#l5.304"></a><span id="l5.304">   /**</span>
<a href="#l5.305"></a><span id="l5.305">    * Check whether the user entered the minimum of information</span>
<a href="#l5.306"></a><span id="l5.306">    * needed to leave the &quot;start&quot; mode (entering of name, email, pw)</span>
<a href="#l5.307"></a><span id="l5.307">    * and is allowed to proceed to detection step.</span>
<a href="#l5.308"></a><span id="l5.308">    */</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-  checkStartDone : function()</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-  {</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+  checkStartDone() {</span>
<a href="#l5.312"></a><span id="l5.312">     if (this.validateEmailMinimally(this._email) &amp;&amp;</span>
<a href="#l5.313"></a><span id="l5.313">         this._realname) {</span>
<a href="#l5.314"></a><span id="l5.314">       this._domain = this._email.split(&quot;@&quot;)[1].toLowerCase();</span>
<a href="#l5.315"></a><span id="l5.315">       _enable(&quot;next_button&quot;);</span>
<a href="#l5.316"></a><span id="l5.316">     } else {</span>
<a href="#l5.317"></a><span id="l5.317">       _disable(&quot;next_button&quot;);</span>
<a href="#l5.318"></a><span id="l5.318">     }</span>
<a href="#l5.319"></a><span id="l5.319">   },</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321">   /**</span>
<a href="#l5.322"></a><span id="l5.322">    * When the [Continue] button is clicked, we move from the initial account</span>
<a href="#l5.323"></a><span id="l5.323">    * information stage to using that information to configure account details.</span>
<a href="#l5.324"></a><span id="l5.324">    */</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  onNext : function()</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-  {</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+  onNext() {</span>
<a href="#l5.328"></a><span id="l5.328">     this.findConfig(this._domain, this._email);</span>
<a href="#l5.329"></a><span id="l5.329">   },</span>
<a href="#l5.330"></a><span id="l5.330"> </span>
<a href="#l5.331"></a><span id="l5.331"> </span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-  /////////////////////////////////////////////////////////////////</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+  // ///////////////////////////////////////////////////////////////</span>
<a href="#l5.334"></a><span id="l5.334">   // Detection step</span>
<a href="#l5.335"></a><span id="l5.335"> </span>
<a href="#l5.336"></a><span id="l5.336">   /**</span>
<a href="#l5.337"></a><span id="l5.337">    * Try to find an account configuration for this email address.</span>
<a href="#l5.338"></a><span id="l5.338">    * This is the function which runs the autoconfig.</span>
<a href="#l5.339"></a><span id="l5.339">    */</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-  findConfig : function(domain, email)</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-  {</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+  findConfig(domain, email) {</span>
<a href="#l5.343"></a><span id="l5.343">     gEmailWizardLogger.info(&quot;findConfig()&quot;);</span>
<a href="#l5.344"></a><span id="l5.344">     if (this._abortable) {</span>
<a href="#l5.345"></a><span id="l5.345">       this.onStop();</span>
<a href="#l5.346"></a><span id="l5.346">     }</span>
<a href="#l5.347"></a><span id="l5.347">     this.switchToMode(&quot;find-config&quot;);</span>
<a href="#l5.348"></a><span id="l5.348">     this.startSpinner(&quot;looking_up_settings_disk&quot;);</span>
<a href="#l5.349"></a><span id="l5.349">     var self = this;</span>
<a href="#l5.350"></a><span id="l5.350">     this._abortable = fetchConfigFromDisk(domain,</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineat">@@ -625,25 +600,24 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.352"></a><span id="l5.352">               });</span>
<a href="#l5.353"></a><span id="l5.353">           });</span>
<a href="#l5.354"></a><span id="l5.354">       });</span>
<a href="#l5.355"></a><span id="l5.355">   },</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357">   /**</span>
<a href="#l5.358"></a><span id="l5.358">    * Just a continuation of findConfig()</span>
<a href="#l5.359"></a><span id="l5.359">    */</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-  _guessConfig : function(domain, initialConfig)</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-  {</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-    this.startSpinner(&quot;looking_up_settings_guess&quot;)</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+  _guessConfig(domain, initialConfig) {</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+    this.startSpinner(&quot;looking_up_settings_guess&quot;);</span>
<a href="#l5.365"></a><span id="l5.365">     var self = this;</span>
<a href="#l5.366"></a><span id="l5.366">     self._abortable = guessConfig(domain,</span>
<a href="#l5.367"></a><span id="l5.367">       function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l5.368"></a><span id="l5.368">       {</span>
<a href="#l5.369"></a><span id="l5.369">         gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-                                &quot; port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+                                &quot; port &quot; + port + &quot; type &quot; + type);</span>
<a href="#l5.372"></a><span id="l5.372">       },</span>
<a href="#l5.373"></a><span id="l5.373">       function(config) // success</span>
<a href="#l5.374"></a><span id="l5.374">       {</span>
<a href="#l5.375"></a><span id="l5.375">         self._abortable = null;</span>
<a href="#l5.376"></a><span id="l5.376">         self.foundConfig(config);</span>
<a href="#l5.377"></a><span id="l5.377">         self.stopSpinner(Services.io.offline ?</span>
<a href="#l5.378"></a><span id="l5.378">                          &quot;guessed_settings_offline&quot; : &quot;found_settings_guess&quot;);</span>
<a href="#l5.379"></a><span id="l5.379">         window.sizeToContent();</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineat">@@ -660,153 +634,141 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.381"></a><span id="l5.381">       },</span>
<a href="#l5.382"></a><span id="l5.382">       initialConfig, &quot;both&quot;);</span>
<a href="#l5.383"></a><span id="l5.383">   },</span>
<a href="#l5.384"></a><span id="l5.384"> </span>
<a href="#l5.385"></a><span id="l5.385">   /**</span>
<a href="#l5.386"></a><span id="l5.386">    * When findConfig() was successful, it calls this.</span>
<a href="#l5.387"></a><span id="l5.387">    * This displays the config to the user.</span>
<a href="#l5.388"></a><span id="l5.388">    */</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-  foundConfig : function(config)</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-  {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+  foundConfig(config) {</span>
<a href="#l5.392"></a><span id="l5.392">     gEmailWizardLogger.info(&quot;foundConfig()&quot;);</span>
<a href="#l5.393"></a><span id="l5.393">     assert(config instanceof AccountConfig,</span>
<a href="#l5.394"></a><span id="l5.394">         &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l5.395"></a><span id="l5.395"> </span>
<a href="#l5.396"></a><span id="l5.396">     this._haveValidConfigForDomain = this._email.split(&quot;@&quot;)[1];</span>
<a href="#l5.397"></a><span id="l5.397"> </span>
<a href="#l5.398"></a><span id="l5.398">     if (!this._realname || !this._email) {</span>
<a href="#l5.399"></a><span id="l5.399">       return;</span>
<a href="#l5.400"></a><span id="l5.400">     }</span>
<a href="#l5.401"></a><span id="l5.401">     this._foundConfig2(config);</span>
<a href="#l5.402"></a><span id="l5.402">   },</span>
<a href="#l5.403"></a><span id="l5.403"> </span>
<a href="#l5.404"></a><span id="l5.404">   // Continuation of foundConfig2() after custom fields.</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-  _foundConfig2 : function(config)</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-  {</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+  _foundConfig2(config) {</span>
<a href="#l5.408"></a><span id="l5.408">     this.displayConfigResult(config);</span>
<a href="#l5.409"></a><span id="l5.409">   },</span>
<a href="#l5.410"></a><span id="l5.410"> </span>
<a href="#l5.411"></a><span id="l5.411">   /**</span>
<a href="#l5.412"></a><span id="l5.412">    * [Stop] button click handler.</span>
<a href="#l5.413"></a><span id="l5.413">    * This allows the user to abort any longer operation, esp. network activity.</span>
<a href="#l5.414"></a><span id="l5.414">    * We currently have 3 such cases here:</span>
<a href="#l5.415"></a><span id="l5.415">    * 1. findConfig(), i.e. fetch config from DB, guessConfig etc.</span>
<a href="#l5.416"></a><span id="l5.416">    * 2. onHalfManualTest(), i.e. the [Retest] button in manual config.</span>
<a href="#l5.417"></a><span id="l5.417">    * 3. verifyConfig() - We can't stop this yet, so irrelevant here currently.</span>
<a href="#l5.418"></a><span id="l5.418">    * Given that these need slightly different actions, this function will be set</span>
<a href="#l5.419"></a><span id="l5.419">    * to a function (i.e. overwritten) by whoever enables the stop button.</span>
<a href="#l5.420"></a><span id="l5.420">    *</span>
<a href="#l5.421"></a><span id="l5.421">    * We also call this from the code when the user started a different action</span>
<a href="#l5.422"></a><span id="l5.422">    * without explicitly clicking [Stop] for the old one first.</span>
<a href="#l5.423"></a><span id="l5.423">    */</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-  onStop : function()</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-  {</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  onStop() {</span>
<a href="#l5.427"></a><span id="l5.427">     throw new NotReached(&quot;onStop should be overridden by now&quot;);</span>
<a href="#l5.428"></a><span id="l5.428">   },</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-  _onStopCommon : function()</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-  {</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+  _onStopCommon() {</span>
<a href="#l5.432"></a><span id="l5.432">     if (!this._abortable) {</span>
<a href="#l5.433"></a><span id="l5.433">       throw new NotReached(&quot;onStop called although there's nothing to stop&quot;);</span>
<a href="#l5.434"></a><span id="l5.434">     }</span>
<a href="#l5.435"></a><span id="l5.435">     gEmailWizardLogger.info(&quot;onStop cancelled _abortable&quot;);</span>
<a href="#l5.436"></a><span id="l5.436">     this._abortable.cancel(new UserCancelledException());</span>
<a href="#l5.437"></a><span id="l5.437">     this._abortable = null;</span>
<a href="#l5.438"></a><span id="l5.438">     this.stopSpinner();</span>
<a href="#l5.439"></a><span id="l5.439">   },</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-  onStopFindConfig : function()</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-  {</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+  onStopFindConfig() {</span>
<a href="#l5.443"></a><span id="l5.443">     this._onStopCommon();</span>
<a href="#l5.444"></a><span id="l5.444">     this.switchToMode(&quot;start&quot;);</span>
<a href="#l5.445"></a><span id="l5.445">     this.checkStartDone();</span>
<a href="#l5.446"></a><span id="l5.446">   },</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-  onStopHalfManualTesting : function()</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-  {</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+  onStopHalfManualTesting() {</span>
<a href="#l5.450"></a><span id="l5.450">     this._onStopCommon();</span>
<a href="#l5.451"></a><span id="l5.451">     this.validateManualEditComplete();</span>
<a href="#l5.452"></a><span id="l5.452">   },</span>
<a href="#l5.453"></a><span id="l5.453"> </span>
<a href="#l5.454"></a><span id="l5.454"> </span>
<a href="#l5.455"></a><span id="l5.455"> </span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-  ///////////////////////////////////////////////////////////////////</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+  // /////////////////////////////////////////////////////////////////</span>
<a href="#l5.458"></a><span id="l5.458">   // status area</span>
<a href="#l5.459"></a><span id="l5.459"> </span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-  startSpinner : function(actionStrName)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-  {</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+  startSpinner(actionStrName) {</span>
<a href="#l5.463"></a><span id="l5.463">     e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;loading&quot;);</span>
<a href="#l5.464"></a><span id="l5.464">     gEmailWizardLogger.warn(&quot;spinner start &quot; + actionStrName);</span>
<a href="#l5.465"></a><span id="l5.465">     this._showStatusTitle(actionStrName);</span>
<a href="#l5.466"></a><span id="l5.466">   },</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-  stopSpinner : function(actionStrName)</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-  {</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+  stopSpinner(actionStrName) {</span>
<a href="#l5.471"></a><span id="l5.471">     e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;result&quot;);</span>
<a href="#l5.472"></a><span id="l5.472">     _hide(&quot;stop_button&quot;);</span>
<a href="#l5.473"></a><span id="l5.473">     this._showStatusTitle(actionStrName);</span>
<a href="#l5.474"></a><span id="l5.474">     gEmailWizardLogger.warn(&quot;all spinner stop &quot; + actionStrName);</span>
<a href="#l5.475"></a><span id="l5.475">   },</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-  showErrorStatus : function(actionStrName)</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-  {</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+  showErrorStatus(actionStrName) {</span>
<a href="#l5.480"></a><span id="l5.480">     e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;error&quot;);</span>
<a href="#l5.481"></a><span id="l5.481">     gEmailWizardLogger.warn(&quot;status error &quot; + actionStrName);</span>
<a href="#l5.482"></a><span id="l5.482">     this._showStatusTitle(actionStrName);</span>
<a href="#l5.483"></a><span id="l5.483">   },</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-  _showStatusTitle : function(msgName)</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-  {</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+  _showStatusTitle(msgName) {</span>
<a href="#l5.488"></a><span id="l5.488">     let msg = &quot; &quot;; // assure height. Do via min-height in CSS, for 2 lines?</span>
<a href="#l5.489"></a><span id="l5.489">     try {</span>
<a href="#l5.490"></a><span id="l5.490">       if (msgName) {</span>
<a href="#l5.491"></a><span id="l5.491">         msg = gStringsBundle.getFormattedString(msgName, [gBrandShortName]);</span>
<a href="#l5.492"></a><span id="l5.492">       }</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-    } catch(ex) {</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+    } catch (ex) {</span>
<a href="#l5.495"></a><span id="l5.495">       gEmailWizardLogger.error(&quot;missing string for &quot; + msgName);</span>
<a href="#l5.496"></a><span id="l5.496">       msg = msgName + &quot; (missing string in translation!)&quot;;</span>
<a href="#l5.497"></a><span id="l5.497">     }</span>
<a href="#l5.498"></a><span id="l5.498"> </span>
<a href="#l5.499"></a><span id="l5.499">     e(&quot;status_msg&quot;).textContent = msg;</span>
<a href="#l5.500"></a><span id="l5.500">     gEmailWizardLogger.info(&quot;status msg: &quot; + msg);</span>
<a href="#l5.501"></a><span id="l5.501">   },</span>
<a href="#l5.502"></a><span id="l5.502"> </span>
<a href="#l5.503"></a><span id="l5.503"> </span>
<a href="#l5.504"></a><span id="l5.504"> </span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-  /////////////////////////////////////////////////////////////////</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+  // ///////////////////////////////////////////////////////////////</span>
<a href="#l5.507"></a><span id="l5.507">   // Result area</span>
<a href="#l5.508"></a><span id="l5.508"> </span>
<a href="#l5.509"></a><span id="l5.509">   /**</span>
<a href="#l5.510"></a><span id="l5.510">    * Displays a (probed) config to the user,</span>
<a href="#l5.511"></a><span id="l5.511">    * in the result config details area.</span>
<a href="#l5.512"></a><span id="l5.512">    *</span>
<a href="#l5.513"></a><span id="l5.513">    * @param config {AccountConfig} The config to present to user</span>
<a href="#l5.514"></a><span id="l5.514">    */</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-  displayConfigResult : function(config)</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-  {</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+  displayConfigResult(config) {</span>
<a href="#l5.518"></a><span id="l5.518">     assert(config instanceof AccountConfig);</span>
<a href="#l5.519"></a><span id="l5.519">     this._currentConfig = config;</span>
<a href="#l5.520"></a><span id="l5.520">     var configFilledIn = this.getConcreteConfig();</span>
<a href="#l5.521"></a><span id="l5.521"> </span>
<a href="#l5.522"></a><span id="l5.522">     var unknownString = gStringsBundle.getString(&quot;resultUnknown&quot;);</span>
<a href="#l5.523"></a><span id="l5.523"> </span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-    function _makeHostDisplayString(server, stringName)</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineminus">-    {</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+    function _makeHostDisplayString(server, stringName) {</span>
<a href="#l5.527"></a><span id="l5.527">       let type = gStringsBundle.getString(sanitize.translate(server.type,</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-          { imap : &quot;resultIMAP&quot;, pop3 : &quot;resultPOP3&quot;, smtp : &quot;resultSMTP&quot; }),</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+          { imap: &quot;resultIMAP&quot;, pop3: &quot;resultPOP3&quot;, smtp: &quot;resultSMTP&quot; }),</span>
<a href="#l5.530"></a><span id="l5.530">           unknownString);</span>
<a href="#l5.531"></a><span id="l5.531">       let host = server.hostname +</span>
<a href="#l5.532"></a><span id="l5.532">           (isStandardPort(server.port) ? &quot;&quot; : &quot;:&quot; + server.port);</span>
<a href="#l5.533"></a><span id="l5.533">       let ssl = gStringsBundle.getString(sanitize.translate(server.socketType,</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-          { 1 : &quot;resultNoEncryption&quot;, 2 : &quot;resultSSL&quot;, 3 : &quot;resultSTARTTLS&quot; }),</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+          { 1: &quot;resultNoEncryption&quot;, 2: &quot;resultSSL&quot;, 3: &quot;resultSTARTTLS&quot; }),</span>
<a href="#l5.536"></a><span id="l5.536">           unknownString);</span>
<a href="#l5.537"></a><span id="l5.537">       let certStatus = gStringsBundle.getString(server.badCert ?</span>
<a href="#l5.538"></a><span id="l5.538">           &quot;resultSSLCertWeak&quot; : &quot;resultSSLCertOK&quot;);</span>
<a href="#l5.539"></a><span id="l5.539">       // TODO: we should really also display authentication method here.</span>
<a href="#l5.540"></a><span id="l5.540">       return gStringsBundle.getFormattedString(stringName,</span>
<a href="#l5.541"></a><span id="l5.541">           [ type, host, ssl, certStatus ]);</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-    };</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+    }</span>
<a href="#l5.544"></a><span id="l5.544"> </span>
<a href="#l5.545"></a><span id="l5.545">     var incomingResult = unknownString;</span>
<a href="#l5.546"></a><span id="l5.546">     if (configFilledIn.incoming.hostname) {</span>
<a href="#l5.547"></a><span id="l5.547">       incomingResult = _makeHostDisplayString(configFilledIn.incoming,</span>
<a href="#l5.548"></a><span id="l5.548">           &quot;resultIncoming&quot;);</span>
<a href="#l5.549"></a><span id="l5.549">     }</span>
<a href="#l5.550"></a><span id="l5.550"> </span>
<a href="#l5.551"></a><span id="l5.551">     var outgoingResult = unknownString;</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineat">@@ -864,44 +826,42 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.553"></a><span id="l5.553">    * Handle the user switching between IMAP and POP3 settings using the</span>
<a href="#l5.554"></a><span id="l5.554">    * radio buttons.</span>
<a href="#l5.555"></a><span id="l5.555">    *</span>
<a href="#l5.556"></a><span id="l5.556">    * Note: This function must only be called by user action, not by setting</span>
<a href="#l5.557"></a><span id="l5.557">    *       the value or selectedItem or selectedIndex of the radiogroup!</span>
<a href="#l5.558"></a><span id="l5.558">    *       This is why we use the oncommand attribute of the radio elements</span>
<a href="#l5.559"></a><span id="l5.559">    *       instead of the onselect attribute of the radiogroup.</span>
<a href="#l5.560"></a><span id="l5.560">    */</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineminus">-  onResultIMAPOrPOP3 : function()</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-  {</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+  onResultIMAPOrPOP3() {</span>
<a href="#l5.564"></a><span id="l5.564">     var config = this._currentConfig;</span>
<a href="#l5.565"></a><span id="l5.565">     var radiogroup = e(&quot;result_imappop&quot;);</span>
<a href="#l5.566"></a><span id="l5.566">     // add current server as best alternative to start of array</span>
<a href="#l5.567"></a><span id="l5.567">     config.incomingAlternatives.unshift(config.incoming);</span>
<a href="#l5.568"></a><span id="l5.568">     // use selected server (stored as special property on the &lt;radio&gt; node)</span>
<a href="#l5.569"></a><span id="l5.569">     config.incoming = radiogroup.selectedItem.configIncoming;</span>
<a href="#l5.570"></a><span id="l5.570">     // remove newly selected server from list of alternatives</span>
<a href="#l5.571"></a><span id="l5.571">     config.incomingAlternatives = config.incomingAlternatives.filter(</span>
<a href="#l5.572"></a><span id="l5.572">         function(e) { return e != config.incoming; });</span>
<a href="#l5.573"></a><span id="l5.573">     this.displayConfigResult(config);</span>
<a href="#l5.574"></a><span id="l5.574">   },</span>
<a href="#l5.575"></a><span id="l5.575"> </span>
<a href="#l5.576"></a><span id="l5.576"> </span>
<a href="#l5.577"></a><span id="l5.577"> </span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-  /////////////////////////////////////////////////////////////////</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+  // ///////////////////////////////////////////////////////////////</span>
<a href="#l5.580"></a><span id="l5.580">   // Manual Edit area</span>
<a href="#l5.581"></a><span id="l5.581"> </span>
<a href="#l5.582"></a><span id="l5.582">   /**</span>
<a href="#l5.583"></a><span id="l5.583">    * Gets the values from the user in the manual edit area.</span>
<a href="#l5.584"></a><span id="l5.584">    *</span>
<a href="#l5.585"></a><span id="l5.585">    * Realname and password are not part of that area and still</span>
<a href="#l5.586"></a><span id="l5.586">    * placeholders, but hostname and username are concrete and</span>
<a href="#l5.587"></a><span id="l5.587">    * no placeholders anymore.</span>
<a href="#l5.588"></a><span id="l5.588">    */</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-  getUserConfig : function()</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-  {</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+  getUserConfig() {</span>
<a href="#l5.592"></a><span id="l5.592">     var config = this.getConcreteConfig();</span>
<a href="#l5.593"></a><span id="l5.593">     if (!config) {</span>
<a href="#l5.594"></a><span id="l5.594">       config = new AccountConfig();</span>
<a href="#l5.595"></a><span id="l5.595">     }</span>
<a href="#l5.596"></a><span id="l5.596">     config.source = AccountConfig.kSourceUser;</span>
<a href="#l5.597"></a><span id="l5.597"> </span>
<a href="#l5.598"></a><span id="l5.598">     // Incoming server</span>
<a href="#l5.599"></a><span id="l5.599">     try {</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineat">@@ -911,17 +871,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.601"></a><span id="l5.601">     } catch (e) { gEmailWizardLogger.warn(e); }</span>
<a href="#l5.602"></a><span id="l5.602">     try {</span>
<a href="#l5.603"></a><span id="l5.603">       config.incoming.port = sanitize.integerRange(e(&quot;incoming_port&quot;).value,</span>
<a href="#l5.604"></a><span id="l5.604">                                                    kMinPort, kMaxPort);</span>
<a href="#l5.605"></a><span id="l5.605">     } catch (e) {</span>
<a href="#l5.606"></a><span id="l5.606">       config.incoming.port = undefined; // incl. default &quot;Auto&quot;</span>
<a href="#l5.607"></a><span id="l5.607">     }</span>
<a href="#l5.608"></a><span id="l5.608">     config.incoming.type = sanitize.translate(e(&quot;incoming_protocol&quot;).value,</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-        { 1: &quot;imap&quot;, 2 : &quot;pop3&quot;, 0 : null });</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+        { 1: &quot;imap&quot;, 2: &quot;pop3&quot;, 0: null });</span>
<a href="#l5.611"></a><span id="l5.611">     config.incoming.socketType = sanitize.integer(e(&quot;incoming_ssl&quot;).value);</span>
<a href="#l5.612"></a><span id="l5.612">     config.incoming.auth = sanitize.integer(e(&quot;incoming_authMethod&quot;).value);</span>
<a href="#l5.613"></a><span id="l5.613">     config.incoming.username = e(&quot;incoming_username&quot;).value;</span>
<a href="#l5.614"></a><span id="l5.614"> </span>
<a href="#l5.615"></a><span id="l5.615">     // Outgoing server</span>
<a href="#l5.616"></a><span id="l5.616"> </span>
<a href="#l5.617"></a><span id="l5.617">     // Did the user select one of the already configured SMTP servers from the</span>
<a href="#l5.618"></a><span id="l5.618">     // drop-down list? If so, use it.</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineat">@@ -957,32 +917,30 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.620"></a><span id="l5.620">   },</span>
<a href="#l5.621"></a><span id="l5.621"> </span>
<a href="#l5.622"></a><span id="l5.622">   /**</span>
<a href="#l5.623"></a><span id="l5.623">    * [Manual Config] button click handler. This turns the config details area</span>
<a href="#l5.624"></a><span id="l5.624">    * into an editable form and makes the (Go) button appear. The edit button</span>
<a href="#l5.625"></a><span id="l5.625">    * should only be available after the config probing is completely finished,</span>
<a href="#l5.626"></a><span id="l5.626">    * replacing what was the (Stop) button.</span>
<a href="#l5.627"></a><span id="l5.627">    */</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-  onManualEdit : function()</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-  {</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+  onManualEdit() {</span>
<a href="#l5.631"></a><span id="l5.631">     if (this._abortable) {</span>
<a href="#l5.632"></a><span id="l5.632">       this.onStop();</span>
<a href="#l5.633"></a><span id="l5.633">     }</span>
<a href="#l5.634"></a><span id="l5.634">     this.editConfigDetails();</span>
<a href="#l5.635"></a><span id="l5.635">   },</span>
<a href="#l5.636"></a><span id="l5.636"> </span>
<a href="#l5.637"></a><span id="l5.637">   /**</span>
<a href="#l5.638"></a><span id="l5.638">    * Setting the config details form so it can be edited. We also disable</span>
<a href="#l5.639"></a><span id="l5.639">    * (and hide) the create button during this time because we don't know what</span>
<a href="#l5.640"></a><span id="l5.640">    * might have changed. The function called from the button that restarts</span>
<a href="#l5.641"></a><span id="l5.641">    * the config check should be enabling the config button as needed.</span>
<a href="#l5.642"></a><span id="l5.642">    */</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineminus">-  editConfigDetails : function()</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-  {</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+  editConfigDetails() {</span>
<a href="#l5.646"></a><span id="l5.646">     gEmailWizardLogger.info(&quot;manual edit&quot;);</span>
<a href="#l5.647"></a><span id="l5.647"> </span>
<a href="#l5.648"></a><span id="l5.648">     if (!this._currentConfig) {</span>
<a href="#l5.649"></a><span id="l5.649">       this._currentConfig = new AccountConfig();</span>
<a href="#l5.650"></a><span id="l5.650">       this._currentConfig.incoming.type = &quot;imap&quot;;</span>
<a href="#l5.651"></a><span id="l5.651">       this._currentConfig.incoming.username = &quot;%EMAILLOCALPART%&quot;;</span>
<a href="#l5.652"></a><span id="l5.652">       this._currentConfig.outgoing.username = &quot;%EMAILLOCALPART%&quot;;</span>
<a href="#l5.653"></a><span id="l5.653">       this._currentConfig.incoming.hostname = &quot;.%EMAILDOMAIN%&quot;;</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineat">@@ -999,23 +957,22 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.655"></a><span id="l5.655">     // so calling it explicitly again. Doesn't do harm, speed is irrelevant.</span>
<a href="#l5.656"></a><span id="l5.656">     this.validateManualEditComplete();</span>
<a href="#l5.657"></a><span id="l5.657">   },</span>
<a href="#l5.658"></a><span id="l5.658"> </span>
<a href="#l5.659"></a><span id="l5.659">   /**</span>
<a href="#l5.660"></a><span id="l5.660">    * Fills the manual edit textfields with the provided config.</span>
<a href="#l5.661"></a><span id="l5.661">    * @param config {AccountConfig} The config to present to user</span>
<a href="#l5.662"></a><span id="l5.662">    */</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-  _fillManualEditFields : function(config)</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-  {</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+  _fillManualEditFields(config) {</span>
<a href="#l5.666"></a><span id="l5.666">     assert(config instanceof AccountConfig);</span>
<a href="#l5.667"></a><span id="l5.667"> </span>
<a href="#l5.668"></a><span id="l5.668">     // incoming server</span>
<a href="#l5.669"></a><span id="l5.669">     e(&quot;incoming_protocol&quot;).value = sanitize.translate(config.incoming.type,</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineminus">-                                                { &quot;imap&quot; : 1, &quot;pop3&quot; : 2 }, 1);</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+                                                { &quot;imap&quot;: 1, &quot;pop3&quot;: 2 }, 1);</span>
<a href="#l5.672"></a><span id="l5.672">     e(&quot;incoming_hostname&quot;).value = config.incoming.hostname;</span>
<a href="#l5.673"></a><span id="l5.673">     e(&quot;incoming_ssl&quot;).value = sanitize.enum(config.incoming.socketType,</span>
<a href="#l5.674"></a><span id="l5.674">                                             [ 0, 1, 2, 3 ], 0);</span>
<a href="#l5.675"></a><span id="l5.675">     e(&quot;incoming_authMethod&quot;).value = sanitize.enum(config.incoming.auth,</span>
<a href="#l5.676"></a><span id="l5.676">                                                    [ 0, 3, 4, 5, 6, 10 ], 0);</span>
<a href="#l5.677"></a><span id="l5.677">     e(&quot;incoming_username&quot;).value = config.incoming.username;</span>
<a href="#l5.678"></a><span id="l5.678">     if (config.incoming.port) {</span>
<a href="#l5.679"></a><span id="l5.679">       e(&quot;incoming_port&quot;).value = config.incoming.port;</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineat">@@ -1082,18 +1039,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.681"></a><span id="l5.681">     this.onChangedOutgoingDropdown(); // show/hide outgoing port, SSL, ...</span>
<a href="#l5.682"></a><span id="l5.682">   },</span>
<a href="#l5.683"></a><span id="l5.683"> </span>
<a href="#l5.684"></a><span id="l5.684">   /**</span>
<a href="#l5.685"></a><span id="l5.685">    * Automatically fill port field in manual edit,</span>
<a href="#l5.686"></a><span id="l5.686">    * unless user entered a non-standard port.</span>
<a href="#l5.687"></a><span id="l5.687">    * @param config {AccountConfig}</span>
<a href="#l5.688"></a><span id="l5.688">    */</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineminus">-  adjustIncomingPortToSSLAndProtocol : function(config)</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineminus">-  {</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+  adjustIncomingPortToSSLAndProtocol(config) {</span>
<a href="#l5.692"></a><span id="l5.692">     var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l5.693"></a><span id="l5.693">     var incoming = config.incoming;</span>
<a href="#l5.694"></a><span id="l5.694">     // we could use getHostEntry() here, but that API is bad, so don't bother</span>
<a href="#l5.695"></a><span id="l5.695">     var newInPort = undefined;</span>
<a href="#l5.696"></a><span id="l5.696">     if (!incoming.port || isStandardPort(incoming.port)) {</span>
<a href="#l5.697"></a><span id="l5.697">       if (incoming.type == &quot;imap&quot;) {</span>
<a href="#l5.698"></a><span id="l5.698">         if (incoming.socketType == 1 || incoming.socketType == 3) {</span>
<a href="#l5.699"></a><span id="l5.699">           newInPort = 143;</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineat">@@ -1116,18 +1072,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.701"></a><span id="l5.701">       e(&quot;incoming_port&quot;).value = newInPort;</span>
<a href="#l5.702"></a><span id="l5.702">       e(&quot;incoming_authMethod&quot;).value = 0; // auto</span>
<a href="#l5.703"></a><span id="l5.703">     }</span>
<a href="#l5.704"></a><span id="l5.704">   },</span>
<a href="#l5.705"></a><span id="l5.705"> </span>
<a href="#l5.706"></a><span id="l5.706">   /**</span>
<a href="#l5.707"></a><span id="l5.707">    * @see adjustIncomingPortToSSLAndProtocol()</span>
<a href="#l5.708"></a><span id="l5.708">    */</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineminus">-  adjustOutgoingPortToSSLAndProtocol : function(config)</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-  {</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+  adjustOutgoingPortToSSLAndProtocol(config) {</span>
<a href="#l5.712"></a><span id="l5.712">     var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l5.713"></a><span id="l5.713">     var outgoing = config.outgoing;</span>
<a href="#l5.714"></a><span id="l5.714">     var newOutPort = undefined;</span>
<a href="#l5.715"></a><span id="l5.715">     if (!outgoing.port || isStandardPort(outgoing.port)) {</span>
<a href="#l5.716"></a><span id="l5.716">       if (outgoing.socketType == 1 || outgoing.socketType == 3) {</span>
<a href="#l5.717"></a><span id="l5.717">         // standard port is 587 *or* 25, so set to auto</span>
<a href="#l5.718"></a><span id="l5.718">         // unless user or config already entered one of these two ports.</span>
<a href="#l5.719"></a><span id="l5.719">         if (outgoing.port != 25 &amp;&amp; outgoing.port != 587) {</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineat">@@ -1145,18 +1100,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.721"></a><span id="l5.721">     }</span>
<a href="#l5.722"></a><span id="l5.722">   },</span>
<a href="#l5.723"></a><span id="l5.723"> </span>
<a href="#l5.724"></a><span id="l5.724">   /**</span>
<a href="#l5.725"></a><span id="l5.725">    * If the user changed the port manually, adjust the SSL value,</span>
<a href="#l5.726"></a><span id="l5.726">    * (only) if the new port is impossible with the old SSL value.</span>
<a href="#l5.727"></a><span id="l5.727">    * @param config {AccountConfig}</span>
<a href="#l5.728"></a><span id="l5.728">    */</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-  adjustIncomingSSLToPort : function(config)</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineminus">-  {</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+  adjustIncomingSSLToPort(config) {</span>
<a href="#l5.732"></a><span id="l5.732">     var incoming = config.incoming;</span>
<a href="#l5.733"></a><span id="l5.733">     var newInSocketType = undefined;</span>
<a href="#l5.734"></a><span id="l5.734">     if (!incoming.port || // auto</span>
<a href="#l5.735"></a><span id="l5.735">         !isStandardPort(incoming.port)) {</span>
<a href="#l5.736"></a><span id="l5.736">       return;</span>
<a href="#l5.737"></a><span id="l5.737">     }</span>
<a href="#l5.738"></a><span id="l5.738">     if (incoming.type == &quot;imap&quot;) {</span>
<a href="#l5.739"></a><span id="l5.739">       // normal SSL impossible</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineat">@@ -1179,18 +1133,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.741"></a><span id="l5.741">       e(&quot;incoming_ssl&quot;).value = newInSocketType;</span>
<a href="#l5.742"></a><span id="l5.742">       e(&quot;incoming_authMethod&quot;).value = 0; // auto</span>
<a href="#l5.743"></a><span id="l5.743">     }</span>
<a href="#l5.744"></a><span id="l5.744">   },</span>
<a href="#l5.745"></a><span id="l5.745"> </span>
<a href="#l5.746"></a><span id="l5.746">   /**</span>
<a href="#l5.747"></a><span id="l5.747">    * @see adjustIncomingSSLToPort()</span>
<a href="#l5.748"></a><span id="l5.748">    */</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-  adjustOutgoingSSLToPort : function(config)</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineminus">-  {</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+  adjustOutgoingSSLToPort(config) {</span>
<a href="#l5.752"></a><span id="l5.752">     var outgoing = config.outgoing;</span>
<a href="#l5.753"></a><span id="l5.753">     var newOutSocketType = undefined;</span>
<a href="#l5.754"></a><span id="l5.754">     if (!outgoing.port || // auto</span>
<a href="#l5.755"></a><span id="l5.755">         !isStandardPort(outgoing.port)) {</span>
<a href="#l5.756"></a><span id="l5.756">       return;</span>
<a href="#l5.757"></a><span id="l5.757">     }</span>
<a href="#l5.758"></a><span id="l5.758">     // normal SSL impossible</span>
<a href="#l5.759"></a><span id="l5.759">     if ((outgoing.port == 587 || outgoing.port == 25) &amp;&amp;</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineat">@@ -1206,113 +1159,100 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.761"></a><span id="l5.761">     }</span>
<a href="#l5.762"></a><span id="l5.762">   },</span>
<a href="#l5.763"></a><span id="l5.763"> </span>
<a href="#l5.764"></a><span id="l5.764">   /**</span>
<a href="#l5.765"></a><span id="l5.765">    * Sets the prefilled values of the port fields.</span>
<a href="#l5.766"></a><span id="l5.766">    * Filled statically with the standard ports for the given protocol,</span>
<a href="#l5.767"></a><span id="l5.767">    * plus &quot;Auto&quot;.</span>
<a href="#l5.768"></a><span id="l5.768">    */</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-  fillPortDropdown : function(protocolType)</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-  {</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+  fillPortDropdown(protocolType) {</span>
<a href="#l5.772"></a><span id="l5.772">     var menu = e(protocolType == &quot;smtp&quot; ? &quot;outgoing_port&quot; : &quot;incoming_port&quot;);</span>
<a href="#l5.773"></a><span id="l5.773"> </span>
<a href="#l5.774"></a><span id="l5.774">     // menulist.removeAllItems() is nice, but nicely clears the user value, too</span>
<a href="#l5.775"></a><span id="l5.775">     var popup = menu.menupopup;</span>
<a href="#l5.776"></a><span id="l5.776">     while (popup.hasChildNodes())</span>
<a href="#l5.777"></a><span id="l5.777">       popup.lastChild.remove();</span>
<a href="#l5.778"></a><span id="l5.778"> </span>
<a href="#l5.779"></a><span id="l5.779">     // add standard ports</span>
<a href="#l5.780"></a><span id="l5.780">     var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l5.781"></a><span id="l5.781">     menu.appendItem(autoPort, autoPort, &quot;&quot;); // label,value,descr</span>
<a href="#l5.782"></a><span id="l5.782">     for (let port of getStandardPorts(protocolType)) {</span>
<a href="#l5.783"></a><span id="l5.783">       menu.appendItem(port, port, &quot;&quot;); // label,value,descr</span>
<a href="#l5.784"></a><span id="l5.784">     }</span>
<a href="#l5.785"></a><span id="l5.785">   },</span>
<a href="#l5.786"></a><span id="l5.786"> </span>
<a href="#l5.787"></a><span id="l5.787" class="difflineminus">-  onChangedProtocolIncoming : function()</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-  {</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+  onChangedProtocolIncoming() {</span>
<a href="#l5.790"></a><span id="l5.790">     var config = this.getUserConfig();</span>
<a href="#l5.791"></a><span id="l5.791">     this.adjustIncomingPortToSSLAndProtocol(config);</span>
<a href="#l5.792"></a><span id="l5.792">     this.fillPortDropdown(config.incoming.type);</span>
<a href="#l5.793"></a><span id="l5.793">     this.onChangedManualEdit();</span>
<a href="#l5.794"></a><span id="l5.794">   },</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-  onChangedPortIncoming : function()</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-  {</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+  onChangedPortIncoming() {</span>
<a href="#l5.798"></a><span id="l5.798">     gEmailWizardLogger.info(&quot;incoming port changed&quot;);</span>
<a href="#l5.799"></a><span id="l5.799">     this.adjustIncomingSSLToPort(this.getUserConfig());</span>
<a href="#l5.800"></a><span id="l5.800">     this.onChangedManualEdit();</span>
<a href="#l5.801"></a><span id="l5.801">   },</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineminus">-  onChangedPortOutgoing : function()</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineminus">-  {</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+  onChangedPortOutgoing() {</span>
<a href="#l5.805"></a><span id="l5.805">     gEmailWizardLogger.info(&quot;outgoing port changed&quot;);</span>
<a href="#l5.806"></a><span id="l5.806">     this.adjustOutgoingSSLToPort(this.getUserConfig());</span>
<a href="#l5.807"></a><span id="l5.807">     this.onChangedManualEdit();</span>
<a href="#l5.808"></a><span id="l5.808">   },</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineminus">-  onChangedSSLIncoming : function()</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineminus">-  {</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+  onChangedSSLIncoming() {</span>
<a href="#l5.812"></a><span id="l5.812">     this.adjustIncomingPortToSSLAndProtocol(this.getUserConfig());</span>
<a href="#l5.813"></a><span id="l5.813">     this.onChangedManualEdit();</span>
<a href="#l5.814"></a><span id="l5.814">   },</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-  onChangedSSLOutgoing : function()</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineminus">-  {</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+  onChangedSSLOutgoing() {</span>
<a href="#l5.818"></a><span id="l5.818">     this.adjustOutgoingPortToSSLAndProtocol(this.getUserConfig());</span>
<a href="#l5.819"></a><span id="l5.819">     this.onChangedManualEdit();</span>
<a href="#l5.820"></a><span id="l5.820">   },</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineminus">-  onChangedInAuth : function()</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineminus">-  {</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+  onChangedInAuth() {</span>
<a href="#l5.824"></a><span id="l5.824">     this.onChangedManualEdit();</span>
<a href="#l5.825"></a><span id="l5.825">   },</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-  onChangedOutAuth : function(aSelectedAuth)</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-  {</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+  onChangedOutAuth(aSelectedAuth) {</span>
<a href="#l5.829"></a><span id="l5.829">     if (aSelectedAuth) {</span>
<a href="#l5.830"></a><span id="l5.830">       e(&quot;outgoing_label&quot;).hidden = e(&quot;outgoing_username&quot;).hidden =</span>
<a href="#l5.831"></a><span id="l5.831">                                    (aSelectedAuth.id == &quot;out-authMethod-no&quot;);</span>
<a href="#l5.832"></a><span id="l5.832">     }</span>
<a href="#l5.833"></a><span id="l5.833">     this.onChangedManualEdit();</span>
<a href="#l5.834"></a><span id="l5.834">   },</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineminus">-  onInputInUsername : function()</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineminus">-  {</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+  onInputInUsername() {</span>
<a href="#l5.838"></a><span id="l5.838">     if (this.sameInOutUsernames)</span>
<a href="#l5.839"></a><span id="l5.839">       e(&quot;outgoing_username&quot;).value = e(&quot;incoming_username&quot;).value;</span>
<a href="#l5.840"></a><span id="l5.840">     this.onChangedManualEdit();</span>
<a href="#l5.841"></a><span id="l5.841">   },</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineminus">-  onInputOutUsername : function()</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-  {</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+  onInputOutUsername() {</span>
<a href="#l5.845"></a><span id="l5.845">     this.sameInOutUsernames = false;</span>
<a href="#l5.846"></a><span id="l5.846">     this.onChangedManualEdit();</span>
<a href="#l5.847"></a><span id="l5.847">   },</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineminus">-  onInputHostname : function()</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineminus">-  {</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+  onInputHostname() {</span>
<a href="#l5.851"></a><span id="l5.851">     this.onChangedManualEdit();</span>
<a href="#l5.852"></a><span id="l5.852">   },</span>
<a href="#l5.853"></a><span id="l5.853"> </span>
<a href="#l5.854"></a><span id="l5.854">   /**</span>
<a href="#l5.855"></a><span id="l5.855">    * Sets the label of the first entry of the dropdown which represents</span>
<a href="#l5.856"></a><span id="l5.856">    * the new outgoing server.</span>
<a href="#l5.857"></a><span id="l5.857">    */</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-  onOpenOutgoingDropdown : function()</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-  {</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineplus">+  onOpenOutgoingDropdown() {</span>
<a href="#l5.861"></a><span id="l5.861">     var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l5.862"></a><span id="l5.862">     // If the menulist is not editable, there is nothing to update</span>
<a href="#l5.863"></a><span id="l5.863">     // and menulist.inputField does not even exist.</span>
<a href="#l5.864"></a><span id="l5.864">     if (!menulist.editable)</span>
<a href="#l5.865"></a><span id="l5.865">       return;</span>
<a href="#l5.866"></a><span id="l5.866"> </span>
<a href="#l5.867"></a><span id="l5.867">     var menuitem = menulist.getItemAtIndex(0);</span>
<a href="#l5.868"></a><span id="l5.868">     assert(!menuitem.serverKey, &quot;I wanted the special item for the new host&quot;);</span>
<a href="#l5.869"></a><span id="l5.869">     menuitem.label = menulist.inputField.value;</span>
<a href="#l5.870"></a><span id="l5.870">   },</span>
<a href="#l5.871"></a><span id="l5.871"> </span>
<a href="#l5.872"></a><span id="l5.872">   /**</span>
<a href="#l5.873"></a><span id="l5.873">    * User selected an existing SMTP server (or deselected it).</span>
<a href="#l5.874"></a><span id="l5.874">    * This changes only the UI. The values are read in getUserConfig().</span>
<a href="#l5.875"></a><span id="l5.875">    */</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-  onChangedOutgoingDropdown : function()</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-  {</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+  onChangedOutgoingDropdown() {</span>
<a href="#l5.879"></a><span id="l5.879">     var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l5.880"></a><span id="l5.880">     var menuitem = menulist.selectedItem;</span>
<a href="#l5.881"></a><span id="l5.881">     if (menuitem &amp;&amp; menuitem.serverKey) {</span>
<a href="#l5.882"></a><span id="l5.882">       // an existing server has been selected from the dropdown</span>
<a href="#l5.883"></a><span id="l5.883">       menulist.editable = false;</span>
<a href="#l5.884"></a><span id="l5.884">       _hide(&quot;outgoing_port&quot;);</span>
<a href="#l5.885"></a><span id="l5.885">       _hide(&quot;outgoing_ssl&quot;);</span>
<a href="#l5.886"></a><span id="l5.886">       _hide(&quot;outgoing_authMethod&quot;);</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineat">@@ -1322,18 +1262,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.888"></a><span id="l5.888">       _show(&quot;outgoing_port&quot;);</span>
<a href="#l5.889"></a><span id="l5.889">       _show(&quot;outgoing_ssl&quot;);</span>
<a href="#l5.890"></a><span id="l5.890">       _show(&quot;outgoing_authMethod&quot;);</span>
<a href="#l5.891"></a><span id="l5.891">     }</span>
<a href="#l5.892"></a><span id="l5.892"> </span>
<a href="#l5.893"></a><span id="l5.893">     this.onChangedManualEdit();</span>
<a href="#l5.894"></a><span id="l5.894">   },</span>
<a href="#l5.895"></a><span id="l5.895"> </span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-  onChangedManualEdit : function()</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-  {</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+  onChangedManualEdit() {</span>
<a href="#l5.899"></a><span id="l5.899">     if (this._abortable) {</span>
<a href="#l5.900"></a><span id="l5.900">       this.onStop();</span>
<a href="#l5.901"></a><span id="l5.901">     }</span>
<a href="#l5.902"></a><span id="l5.902">     this.validateManualEditComplete();</span>
<a href="#l5.903"></a><span id="l5.903">   },</span>
<a href="#l5.904"></a><span id="l5.904"> </span>
<a href="#l5.905"></a><span id="l5.905">   /**</span>
<a href="#l5.906"></a><span id="l5.906">    * This enables the buttons which allow the user to proceed</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineat">@@ -1345,18 +1284,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.908"></a><span id="l5.908">    * which allows to press [Re-test], which starts the detection</span>
<a href="#l5.909"></a><span id="l5.909">    * of the other values.</span>
<a href="#l5.910"></a><span id="l5.910">    * Once the user has entered (or we detected) all values, he may</span>
<a href="#l5.911"></a><span id="l5.911">    * do [Create Account] (tests login and if successful creates the account)</span>
<a href="#l5.912"></a><span id="l5.912">    * or [Advanced Setup] (goes to Account Manager). Esp. in the latter case,</span>
<a href="#l5.913"></a><span id="l5.913">    * we will not second-guess his setup and just to as told, so here we make</span>
<a href="#l5.914"></a><span id="l5.914">    * sure that he at least entered all values.</span>
<a href="#l5.915"></a><span id="l5.915">    */</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-  validateManualEditComplete : function()</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-  {</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineplus">+  validateManualEditComplete() {</span>
<a href="#l5.919"></a><span id="l5.919">     // getUserConfig() is expensive, but still OK, not a problem</span>
<a href="#l5.920"></a><span id="l5.920">     var manualConfig = this.getUserConfig();</span>
<a href="#l5.921"></a><span id="l5.921">     this._currentConfig = manualConfig;</span>
<a href="#l5.922"></a><span id="l5.922">     if (manualConfig.isComplete()) {</span>
<a href="#l5.923"></a><span id="l5.923">       this.switchToMode(&quot;manual-edit-complete&quot;);</span>
<a href="#l5.924"></a><span id="l5.924">     } else if (!!manualConfig.incoming.hostname &amp;&amp;</span>
<a href="#l5.925"></a><span id="l5.925">                !!manualConfig.outgoing.hostname) {</span>
<a href="#l5.926"></a><span id="l5.926">       this.switchToMode(&quot;manual-edit-have-hostname&quot;);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineat">@@ -1364,39 +1302,37 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.928"></a><span id="l5.928">       this.switchToMode(&quot;manual-edit&quot;);</span>
<a href="#l5.929"></a><span id="l5.929">     }</span>
<a href="#l5.930"></a><span id="l5.930">   },</span>
<a href="#l5.931"></a><span id="l5.931"> </span>
<a href="#l5.932"></a><span id="l5.932">   /**</span>
<a href="#l5.933"></a><span id="l5.933">    * [Switch to provisioner] button click handler. Always active, allows</span>
<a href="#l5.934"></a><span id="l5.934">    * one to switch to the account provisioner screen.</span>
<a href="#l5.935"></a><span id="l5.935">    */</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineminus">-  onSwitchToProvisioner : function ()</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-  {</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+  onSwitchToProvisioner() {</span>
<a href="#l5.939"></a><span id="l5.939">     // We have to close this window first, otherwise msgNewMailAccount</span>
<a href="#l5.940"></a><span id="l5.940">     // in accountUtils.js will think that this window still</span>
<a href="#l5.941"></a><span id="l5.941">     // exists when it's called from the account provisioner window.</span>
<a href="#l5.942"></a><span id="l5.942">     // This is because the account provisioner window is modal,</span>
<a href="#l5.943"></a><span id="l5.943">     // and therefore blocks.  Therefore, we override the _okCallback</span>
<a href="#l5.944"></a><span id="l5.944">     // with a function that spawns the account provisioner, and then</span>
<a href="#l5.945"></a><span id="l5.945">     // close the window.</span>
<a href="#l5.946"></a><span id="l5.946">     this._okCallback = function() {</span>
<a href="#l5.947"></a><span id="l5.947">       NewMailAccountProvisioner(window.arguments[0].msgWindow, window.arguments[0].extraData);</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineminus">-    }</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+    };</span>
<a href="#l5.950"></a><span id="l5.950">     window.close();</span>
<a href="#l5.951"></a><span id="l5.951">   },</span>
<a href="#l5.952"></a><span id="l5.952"> </span>
<a href="#l5.953"></a><span id="l5.953">   /**</span>
<a href="#l5.954"></a><span id="l5.954">    * [Advanced Setup...] button click handler</span>
<a href="#l5.955"></a><span id="l5.955">    * Only active in manual edit mode, and goes straight into</span>
<a href="#l5.956"></a><span id="l5.956">    * Account Settings (pref UI) dialog. Requires a backend account,</span>
<a href="#l5.957"></a><span id="l5.957">    * which requires proper hostname, port and protocol.</span>
<a href="#l5.958"></a><span id="l5.958">    */</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineminus">-  onAdvancedSetup : function()</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineminus">-  {</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+  onAdvancedSetup() {</span>
<a href="#l5.962"></a><span id="l5.962">     assert(this._currentConfig instanceof AccountConfig);</span>
<a href="#l5.963"></a><span id="l5.963">     let configFilledIn = this.getConcreteConfig();</span>
<a href="#l5.964"></a><span id="l5.964"> </span>
<a href="#l5.965"></a><span id="l5.965">     if (checkIncomingServerAlreadyExists(configFilledIn)) {</span>
<a href="#l5.966"></a><span id="l5.966">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l5.967"></a><span id="l5.967">                   gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l5.968"></a><span id="l5.968">       return;</span>
<a href="#l5.969"></a><span id="l5.969">     }</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineat">@@ -1422,29 +1358,28 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.971"></a><span id="l5.971">    * Restarts the config guessing process after a person editing the server</span>
<a href="#l5.972"></a><span id="l5.972">    * fields.</span>
<a href="#l5.973"></a><span id="l5.973">    * It's called &quot;half-manual&quot;, because we take the user-entered values</span>
<a href="#l5.974"></a><span id="l5.974">    * as given and will not second-guess them, to respect the user wishes.</span>
<a href="#l5.975"></a><span id="l5.975">    * (Yes, Sir! Will do as told!)</span>
<a href="#l5.976"></a><span id="l5.976">    * The values that the user left empty or on &quot;Auto&quot; will be guessed/probed</span>
<a href="#l5.977"></a><span id="l5.977">    * here. We will also check that the user-provided values work.</span>
<a href="#l5.978"></a><span id="l5.978">    */</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineminus">-  onHalfManualTest : function()</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineminus">-  {</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+  onHalfManualTest() {</span>
<a href="#l5.982"></a><span id="l5.982">     var newConfig = this.getUserConfig();</span>
<a href="#l5.983"></a><span id="l5.983">     gEmailWizardLogger.info(debugObject(newConfig, &quot;manualConfigToTest&quot;));</span>
<a href="#l5.984"></a><span id="l5.984">     this.startSpinner(&quot;looking_up_settings_halfmanual&quot;);</span>
<a href="#l5.985"></a><span id="l5.985">     this.switchToMode(&quot;manual-edit-testing&quot;);</span>
<a href="#l5.986"></a><span id="l5.986">     // if (this._userPickedOutgoingServer) TODO</span>
<a href="#l5.987"></a><span id="l5.987">     var self = this;</span>
<a href="#l5.988"></a><span id="l5.988">     this._abortable = guessConfig(this._domain,</span>
<a href="#l5.989"></a><span id="l5.989">       function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l5.990"></a><span id="l5.990">       {</span>
<a href="#l5.991"></a><span id="l5.991">         gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineminus">-                                &quot; port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineplus">+                                &quot; port &quot; + port + &quot; type &quot; + type);</span>
<a href="#l5.994"></a><span id="l5.994">       },</span>
<a href="#l5.995"></a><span id="l5.995">       function(config) // success</span>
<a href="#l5.996"></a><span id="l5.996">       {</span>
<a href="#l5.997"></a><span id="l5.997">         self._abortable = null;</span>
<a href="#l5.998"></a><span id="l5.998">         self._fillManualEditFields(config);</span>
<a href="#l5.999"></a><span id="l5.999">         self.switchToMode(&quot;manual-edit-complete&quot;);</span>
<a href="#l5.1000"></a><span id="l5.1000">         self.stopSpinner(&quot;found_settings_halfmanual&quot;);</span>
<a href="#l5.1001"></a><span id="l5.1001">       },</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineat">@@ -1459,53 +1394,49 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.1003"></a><span id="l5.1003">         self.switchToMode(&quot;manual-edit-have-hostname&quot;);</span>
<a href="#l5.1004"></a><span id="l5.1004">       },</span>
<a href="#l5.1005"></a><span id="l5.1005">       newConfig,</span>
<a href="#l5.1006"></a><span id="l5.1006">       newConfig.outgoing.existingServerKey ? &quot;incoming&quot; : &quot;both&quot;);</span>
<a href="#l5.1007"></a><span id="l5.1007">   },</span>
<a href="#l5.1008"></a><span id="l5.1008"> </span>
<a href="#l5.1009"></a><span id="l5.1009"> </span>
<a href="#l5.1010"></a><span id="l5.1010"> </span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineminus">-  /////////////////////////////////////////////////////////////////</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineplus">+  // ///////////////////////////////////////////////////////////////</span>
<a href="#l5.1013"></a><span id="l5.1013">   // UI helper functions</span>
<a href="#l5.1014"></a><span id="l5.1014"> </span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-  _prefillConfig : function(initialConfig)</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineminus">-  {</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+  _prefillConfig(initialConfig) {</span>
<a href="#l5.1018"></a><span id="l5.1018">     var emailsplit = this._email.split(&quot;@&quot;);</span>
<a href="#l5.1019"></a><span id="l5.1019">     assert(emailsplit.length &gt; 1);</span>
<a href="#l5.1020"></a><span id="l5.1020">     var emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l5.1021"></a><span id="l5.1021">     initialConfig.incoming.username = emaillocal;</span>
<a href="#l5.1022"></a><span id="l5.1022">     initialConfig.outgoing.username = emaillocal;</span>
<a href="#l5.1023"></a><span id="l5.1023">     return initialConfig;</span>
<a href="#l5.1024"></a><span id="l5.1024">   },</span>
<a href="#l5.1025"></a><span id="l5.1025"> </span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-  clearError : function(which)</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-  {</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineplus">+  clearError(which) {</span>
<a href="#l5.1029"></a><span id="l5.1029">     _hide(which);</span>
<a href="#l5.1030"></a><span id="l5.1030">     _hide(which + &quot;icon&quot;);</span>
<a href="#l5.1031"></a><span id="l5.1031">     e(which).textContent = &quot;&quot;;</span>
<a href="#l5.1032"></a><span id="l5.1032">   },</span>
<a href="#l5.1033"></a><span id="l5.1033"> </span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineminus">-  setError : function(which, msg_name)</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-  {</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineplus">+  setError(which, msg_name) {</span>
<a href="#l5.1037"></a><span id="l5.1037">     try {</span>
<a href="#l5.1038"></a><span id="l5.1038">       _show(which);</span>
<a href="#l5.1039"></a><span id="l5.1039">       _show(which + &quot;icon&quot;);</span>
<a href="#l5.1040"></a><span id="l5.1040">       e(which).textContent = gStringsBundle.getString(msg_name);</span>
<a href="#l5.1041"></a><span id="l5.1041">       window.sizeToContent();</span>
<a href="#l5.1042"></a><span id="l5.1042">     } catch (ex) { alertPrompt(&quot;missing error string&quot;, msg_name); }</span>
<a href="#l5.1043"></a><span id="l5.1043">   },</span>
<a href="#l5.1044"></a><span id="l5.1044"> </span>
<a href="#l5.1045"></a><span id="l5.1045"> </span>
<a href="#l5.1046"></a><span id="l5.1046"> </span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineminus">-  /////////////////////////////////////////////////////////////////</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineplus">+  // ///////////////////////////////////////////////////////////////</span>
<a href="#l5.1049"></a><span id="l5.1049">   // Finish &amp; dialog close functions</span>
<a href="#l5.1050"></a><span id="l5.1050"> </span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineminus">-  onKeyDown : function(event)</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-  {</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+  onKeyDown(event) {</span>
<a href="#l5.1054"></a><span id="l5.1054">     let key = event.keyCode;</span>
<a href="#l5.1055"></a><span id="l5.1055">     if (key == 27) { // Escape key</span>
<a href="#l5.1056"></a><span id="l5.1056">       this.onCancel();</span>
<a href="#l5.1057"></a><span id="l5.1057">       return true;</span>
<a href="#l5.1058"></a><span id="l5.1058">     }</span>
<a href="#l5.1059"></a><span id="l5.1059">     if (key == 13) { // OK key</span>
<a href="#l5.1060"></a><span id="l5.1060">       let buttons = [</span>
<a href="#l5.1061"></a><span id="l5.1061">         { id: &quot;next_button&quot;, action: makeCallback(this, this.onNext) },</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineat">@@ -1520,37 +1451,34 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.1063"></a><span id="l5.1063">         }</span>
<a href="#l5.1064"></a><span id="l5.1064">         button.action();</span>
<a href="#l5.1065"></a><span id="l5.1065">         return true;</span>
<a href="#l5.1066"></a><span id="l5.1066">       }</span>
<a href="#l5.1067"></a><span id="l5.1067">     }</span>
<a href="#l5.1068"></a><span id="l5.1068">     return false;</span>
<a href="#l5.1069"></a><span id="l5.1069">   },</span>
<a href="#l5.1070"></a><span id="l5.1070"> </span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineminus">-  onCancel : function()</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineminus">-  {</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineplus">+  onCancel() {</span>
<a href="#l5.1074"></a><span id="l5.1074">     window.close();</span>
<a href="#l5.1075"></a><span id="l5.1075">     // The window onclose handler will call onWizardShutdown for us.</span>
<a href="#l5.1076"></a><span id="l5.1076">   },</span>
<a href="#l5.1077"></a><span id="l5.1077"> </span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineminus">-  onWizardShutdown : function()</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineminus">-  {</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineplus">+  onWizardShutdown() {</span>
<a href="#l5.1081"></a><span id="l5.1081">     if (this._abortable) {</span>
<a href="#l5.1082"></a><span id="l5.1082">       this._abortable.cancel(new UserCancelledException());</span>
<a href="#l5.1083"></a><span id="l5.1083">     }</span>
<a href="#l5.1084"></a><span id="l5.1084"> </span>
<a href="#l5.1085"></a><span id="l5.1085">     if (this._okCallback) {</span>
<a href="#l5.1086"></a><span id="l5.1086">       this._okCallback();</span>
<a href="#l5.1087"></a><span id="l5.1087">     }</span>
<a href="#l5.1088"></a><span id="l5.1088">     gEmailWizardLogger.info(&quot;Shutting down email config dialog&quot;);</span>
<a href="#l5.1089"></a><span id="l5.1089">   },</span>
<a href="#l5.1090"></a><span id="l5.1090"> </span>
<a href="#l5.1091"></a><span id="l5.1091"> </span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineminus">-  onCreate : function()</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineminus">-  {</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineplus">+  onCreate() {</span>
<a href="#l5.1095"></a><span id="l5.1095">     try {</span>
<a href="#l5.1096"></a><span id="l5.1096">       gEmailWizardLogger.info(&quot;Create button clicked&quot;);</span>
<a href="#l5.1097"></a><span id="l5.1097"> </span>
<a href="#l5.1098"></a><span id="l5.1098">       var configFilledIn = this.getConcreteConfig();</span>
<a href="#l5.1099"></a><span id="l5.1099">       var self = this;</span>
<a href="#l5.1100"></a><span id="l5.1100">       // If the dialog is not needed, it will go straight to OK callback</span>
<a href="#l5.1101"></a><span id="l5.1101">       gSecurityWarningDialog.open(this._currentConfig, configFilledIn, true,</span>
<a href="#l5.1102"></a><span id="l5.1102">         function() // on OK</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineat">@@ -1561,18 +1489,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.1104"></a><span id="l5.1104">     } catch (ex) {</span>
<a href="#l5.1105"></a><span id="l5.1105">       gEmailWizardLogger.error(&quot;Error creating account.  ex=&quot; + ex +</span>
<a href="#l5.1106"></a><span id="l5.1106">                                &quot;, stack=&quot; + ex.stack);</span>
<a href="#l5.1107"></a><span id="l5.1107">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;), ex);</span>
<a href="#l5.1108"></a><span id="l5.1108">     }</span>
<a href="#l5.1109"></a><span id="l5.1109">   },</span>
<a href="#l5.1110"></a><span id="l5.1110"> </span>
<a href="#l5.1111"></a><span id="l5.1111">   // called by onCreate()</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineminus">-  validateAndFinish : function()</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineminus">-  {</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineplus">+  validateAndFinish() {</span>
<a href="#l5.1115"></a><span id="l5.1115">     var configFilledIn = this.getConcreteConfig();</span>
<a href="#l5.1116"></a><span id="l5.1116"> </span>
<a href="#l5.1117"></a><span id="l5.1117">     if (checkIncomingServerAlreadyExists(configFilledIn)) {</span>
<a href="#l5.1118"></a><span id="l5.1118">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l5.1119"></a><span id="l5.1119">                   gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l5.1120"></a><span id="l5.1120">       return;</span>
<a href="#l5.1121"></a><span id="l5.1121">     }</span>
<a href="#l5.1122"></a><span id="l5.1122"> </span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineat">@@ -1596,17 +1523,17 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.1124"></a><span id="l5.1124">     // logic function defined in verifyConfig.js</span>
<a href="#l5.1125"></a><span id="l5.1125">     verifyConfig(</span>
<a href="#l5.1126"></a><span id="l5.1126">       configFilledIn,</span>
<a href="#l5.1127"></a><span id="l5.1127">       // guess login config?</span>
<a href="#l5.1128"></a><span id="l5.1128">       configFilledIn.source != AccountConfig.kSourceXML,</span>
<a href="#l5.1129"></a><span id="l5.1129">       // TODO Instead, the following line would be correct, but I cannot use it,</span>
<a href="#l5.1130"></a><span id="l5.1130">       // because some other code doesn't adhere to the expectations/specs.</span>
<a href="#l5.1131"></a><span id="l5.1131">       // Find out what it was and fix it.</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineminus">-      //concreteConfig.source == AccountConfig.kSourceGuess,</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineplus">+      // concreteConfig.source == AccountConfig.kSourceGuess,</span>
<a href="#l5.1134"></a><span id="l5.1134">       this._parentMsgWindow,</span>
<a href="#l5.1135"></a><span id="l5.1135">       function(successfulConfig) // success</span>
<a href="#l5.1136"></a><span id="l5.1136">       {</span>
<a href="#l5.1137"></a><span id="l5.1137">         self.stopSpinner(successfulConfig.incoming.password ?</span>
<a href="#l5.1138"></a><span id="l5.1138">                          &quot;password_ok&quot; : null);</span>
<a href="#l5.1139"></a><span id="l5.1139"> </span>
<a href="#l5.1140"></a><span id="l5.1140">         // the auth might have changed, so we</span>
<a href="#l5.1141"></a><span id="l5.1141">         // should back-port it to the current config.</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineat">@@ -1632,73 +1559,68 @@ EmailConfigWizard.prototype =</span>
<a href="#l5.1143"></a><span id="l5.1143">         // give user something to proceed after fixing</span>
<a href="#l5.1144"></a><span id="l5.1144">         _enable(&quot;create_button&quot;);</span>
<a href="#l5.1145"></a><span id="l5.1145">         // hidden in non-manual mode, so it's fine to enable</span>
<a href="#l5.1146"></a><span id="l5.1146">         _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l5.1147"></a><span id="l5.1147">         _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l5.1148"></a><span id="l5.1148">       });</span>
<a href="#l5.1149"></a><span id="l5.1149">   },</span>
<a href="#l5.1150"></a><span id="l5.1150"> </span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineminus">-  finish : function()</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineminus">-  {</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineplus">+  finish() {</span>
<a href="#l5.1154"></a><span id="l5.1154">     gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l5.1155"></a><span id="l5.1155">     createAccountInBackend(this.getConcreteConfig());</span>
<a href="#l5.1156"></a><span id="l5.1156">     window.close();</span>
<a href="#l5.1157"></a><span id="l5.1157">   },</span>
<a href="#l5.1158"></a><span id="l5.1158"> };</span>
<a href="#l5.1159"></a><span id="l5.1159"> </span>
<a href="#l5.1160"></a><span id="l5.1160"> var gEmailConfigWizard = new EmailConfigWizard();</span>
<a href="#l5.1161"></a><span id="l5.1161"> </span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineminus">-function serverMatches(a, b)</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineminus">-{</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineplus">+function serverMatches(a, b) {</span>
<a href="#l5.1165"></a><span id="l5.1165">   return a.type == b.type &amp;&amp;</span>
<a href="#l5.1166"></a><span id="l5.1166">          a.hostname == b.hostname &amp;&amp;</span>
<a href="#l5.1167"></a><span id="l5.1167">          a.port == b.port &amp;&amp;</span>
<a href="#l5.1168"></a><span id="l5.1168">          a.socketType == b.socketType &amp;&amp;</span>
<a href="#l5.1169"></a><span id="l5.1169">          a.auth == b.auth;</span>
<a href="#l5.1170"></a><span id="l5.1170"> }</span>
<a href="#l5.1171"></a><span id="l5.1171"> </span>
<a href="#l5.1172"></a><span id="l5.1172"> var _gStandardPorts = {};</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineminus">-_gStandardPorts[&quot;imap&quot;] = [ 143, 993 ];</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineminus">-_gStandardPorts[&quot;pop3&quot;] = [ 110, 995 ];</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineminus">-_gStandardPorts[&quot;smtp&quot;] = [ 587, 25, 465 ]; // order matters</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineminus">-var _gAllStandardPorts = _gStandardPorts[&quot;smtp&quot;]</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineminus">-    .concat(_gStandardPorts[&quot;imap&quot;]).concat(_gStandardPorts[&quot;pop3&quot;]);</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineplus">+_gStandardPorts.imap = [ 143, 993 ];</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineplus">+_gStandardPorts.pop3 = [ 110, 995 ];</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+_gStandardPorts.smtp = [ 587, 25, 465 ]; // order matters</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+var _gAllStandardPorts = _gStandardPorts.smtp</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+    .concat(_gStandardPorts.imap).concat(_gStandardPorts.pop3);</span>
<a href="#l5.1183"></a><span id="l5.1183"> </span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineminus">-function isStandardPort(port)</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineminus">-{</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+function isStandardPort(port) {</span>
<a href="#l5.1187"></a><span id="l5.1187">   return _gAllStandardPorts.indexOf(port) != -1;</span>
<a href="#l5.1188"></a><span id="l5.1188"> }</span>
<a href="#l5.1189"></a><span id="l5.1189"> </span>
<a href="#l5.1190"></a><span id="l5.1190" class="difflineminus">-function getStandardPorts(protocolType)</span>
<a href="#l5.1191"></a><span id="l5.1191" class="difflineminus">-{</span>
<a href="#l5.1192"></a><span id="l5.1192" class="difflineplus">+function getStandardPorts(protocolType) {</span>
<a href="#l5.1193"></a><span id="l5.1193">   return _gStandardPorts[protocolType];</span>
<a href="#l5.1194"></a><span id="l5.1194"> }</span>
<a href="#l5.1195"></a><span id="l5.1195"> </span>
<a href="#l5.1196"></a><span id="l5.1196"> </span>
<a href="#l5.1197"></a><span id="l5.1197"> /**</span>
<a href="#l5.1198"></a><span id="l5.1198">  * Warning dialog, warning user about lack of, or inappropriate, encryption.</span>
<a href="#l5.1199"></a><span id="l5.1199">  *</span>
<a href="#l5.1200"></a><span id="l5.1200">  * This is effectively a separate dialog, but implemented as part of</span>
<a href="#l5.1201"></a><span id="l5.1201">  * this dialog. It works by hiding the main dialog part and unhiding</span>
<a href="#l5.1202"></a><span id="l5.1202">  * the this part, and vice versa, and resizing the dialog.</span>
<a href="#l5.1203"></a><span id="l5.1203">  */</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineminus">-function SecurityWarningDialog()</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineminus">-{</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+function SecurityWarningDialog() {</span>
<a href="#l5.1207"></a><span id="l5.1207">   this._acknowledged = new Array();</span>
<a href="#l5.1208"></a><span id="l5.1208"> }</span>
<a href="#l5.1209"></a><span id="l5.1209"> SecurityWarningDialog.prototype =</span>
<a href="#l5.1210"></a><span id="l5.1210"> {</span>
<a href="#l5.1211"></a><span id="l5.1211">   /**</span>
<a href="#l5.1212"></a><span id="l5.1212">    * {Array of {(incoming or outgoing) server part of {AccountConfig}}</span>
<a href="#l5.1213"></a><span id="l5.1213">    * A list of the servers for which we already showed this dialog and the</span>
<a href="#l5.1214"></a><span id="l5.1214">    * user approved the configs. For those, we won't show the warning again.</span>
<a href="#l5.1215"></a><span id="l5.1215">    * (Make sure to store a copy in case the underlying object is changed.)</span>
<a href="#l5.1216"></a><span id="l5.1216">    */</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineminus">-  _acknowledged : null,</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineplus">+  _acknowledged: null,</span>
<a href="#l5.1219"></a><span id="l5.1219"> </span>
<a href="#l5.1220"></a><span id="l5.1220">   _inSecurityBad:  0x0001,</span>
<a href="#l5.1221"></a><span id="l5.1221">   _inCertBad:      0x0010,</span>
<a href="#l5.1222"></a><span id="l5.1222">   _outSecurityBad: 0x0100,</span>
<a href="#l5.1223"></a><span id="l5.1223">   _outCertBad:     0x1000,</span>
<a href="#l5.1224"></a><span id="l5.1224"> </span>
<a href="#l5.1225"></a><span id="l5.1225">   /**</span>
<a href="#l5.1226"></a><span id="l5.1226">    * Checks whether we need to warn about this config.</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineat">@@ -1715,18 +1637,17 @@ SecurityWarningDialog.prototype =</span>
<a href="#l5.1228"></a><span id="l5.1228">    * (Given that this dialog object is static/global and persistent,</span>
<a href="#l5.1229"></a><span id="l5.1229">    * we can store that approval state here in this object.)</span>
<a href="#l5.1230"></a><span id="l5.1230">    *</span>
<a href="#l5.1231"></a><span id="l5.1231">    * @param configSchema @see open()</span>
<a href="#l5.1232"></a><span id="l5.1232">    * @param configFilledIn @see open()</span>
<a href="#l5.1233"></a><span id="l5.1233">    * @returns {Boolean}   true when the dialog should be shown</span>
<a href="#l5.1234"></a><span id="l5.1234">    *      (call open()). if false, the dialog can and should be skipped.</span>
<a href="#l5.1235"></a><span id="l5.1235">    */</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineminus">-  needed : function(configSchema, configFilledIn)</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineminus">-  {</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineplus">+  needed(configSchema, configFilledIn) {</span>
<a href="#l5.1239"></a><span id="l5.1239">     assert(configSchema instanceof AccountConfig);</span>
<a href="#l5.1240"></a><span id="l5.1240">     assert(configFilledIn instanceof AccountConfig);</span>
<a href="#l5.1241"></a><span id="l5.1241">     assert(configSchema.isComplete());</span>
<a href="#l5.1242"></a><span id="l5.1242">     assert(configFilledIn.isComplete());</span>
<a href="#l5.1243"></a><span id="l5.1243"> </span>
<a href="#l5.1244"></a><span id="l5.1244">     var incomingBad = ((configFilledIn.incoming.socketType &gt; 1) ? 0 : this._inSecurityBad) |</span>
<a href="#l5.1245"></a><span id="l5.1245">                       ((configFilledIn.incoming.badCert) ? this._inCertBad : 0);</span>
<a href="#l5.1246"></a><span id="l5.1246">     var outgoingBad = 0;</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineat">@@ -1767,29 +1688,28 @@ SecurityWarningDialog.prototype =</span>
<a href="#l5.1248"></a><span id="l5.1248">    * @param onlyIfNeeded {Boolean}   If there is nothing to warn about,</span>
<a href="#l5.1249"></a><span id="l5.1249">    *     call okCallback() immediately (and sync).</span>
<a href="#l5.1250"></a><span id="l5.1250">    * @param okCallback {function(config {AccountConfig})}</span>
<a href="#l5.1251"></a><span id="l5.1251">    *      Called when the user clicked OK and approved the config including</span>
<a href="#l5.1252"></a><span id="l5.1252">    *      the warnings. |config| is without placeholders replaced.</span>
<a href="#l5.1253"></a><span id="l5.1253">    * @param cancalCallback {function()}</span>
<a href="#l5.1254"></a><span id="l5.1254">    *      Called when the user decided to heed the warnings and not approve.</span>
<a href="#l5.1255"></a><span id="l5.1255">    */</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineminus">-  open : function(configSchema, configFilledIn, onlyIfNeeded,</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineminus">-                  okCallback, cancelCallback)</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineminus">-  {</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+  open(configSchema, configFilledIn, onlyIfNeeded,</span>
<a href="#l5.1260"></a><span id="l5.1260" class="difflineplus">+                  okCallback, cancelCallback) {</span>
<a href="#l5.1261"></a><span id="l5.1261">     assert(typeof(okCallback) == &quot;function&quot;);</span>
<a href="#l5.1262"></a><span id="l5.1262">     assert(typeof(cancelCallback) == &quot;function&quot;);</span>
<a href="#l5.1263"></a><span id="l5.1263">     // needed() also checks the parameters</span>
<a href="#l5.1264"></a><span id="l5.1264">     var needed = this.needed(configSchema, configFilledIn);</span>
<a href="#l5.1265"></a><span id="l5.1265">     if ((needed == 0) &amp;&amp; onlyIfNeeded) {</span>
<a href="#l5.1266"></a><span id="l5.1266">       okCallback();</span>
<a href="#l5.1267"></a><span id="l5.1267">       return;</span>
<a href="#l5.1268"></a><span id="l5.1268">     }</span>
<a href="#l5.1269"></a><span id="l5.1269"> </span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineminus">-    assert(needed &gt; 0 , &quot;security dialog opened needlessly&quot;);</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineplus">+    assert(needed &gt; 0, &quot;security dialog opened needlessly&quot;);</span>
<a href="#l5.1272"></a><span id="l5.1272">     this._currentConfigFilledIn = configFilledIn;</span>
<a href="#l5.1273"></a><span id="l5.1273">     this._okCallback = okCallback;</span>
<a href="#l5.1274"></a><span id="l5.1274">     this._cancelCallback = cancelCallback;</span>
<a href="#l5.1275"></a><span id="l5.1275">     var incoming = configFilledIn.incoming;</span>
<a href="#l5.1276"></a><span id="l5.1276">     var outgoing = configFilledIn.outgoing;</span>
<a href="#l5.1277"></a><span id="l5.1277"> </span>
<a href="#l5.1278"></a><span id="l5.1278">     _hide(&quot;mastervbox&quot;);</span>
<a href="#l5.1279"></a><span id="l5.1279">     _show(&quot;warningbox&quot;);</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineat">@@ -1834,62 +1754,58 @@ SecurityWarningDialog.prototype =</span>
<a href="#l5.1281"></a><span id="l5.1281">     }</span>
<a href="#l5.1282"></a><span id="l5.1282">     _show(&quot;acknowledge_warning&quot;);</span>
<a href="#l5.1283"></a><span id="l5.1283">     assert(!e(&quot;incoming_box&quot;).hidden || !e(&quot;outgoing_box&quot;).hidden,</span>
<a href="#l5.1284"></a><span id="l5.1284">            &quot;warning dialog shown for unknown reason&quot;);</span>
<a href="#l5.1285"></a><span id="l5.1285"> </span>
<a href="#l5.1286"></a><span id="l5.1286">     window.sizeToContent();</span>
<a href="#l5.1287"></a><span id="l5.1287">   },</span>
<a href="#l5.1288"></a><span id="l5.1288"> </span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineminus">-  toggleDetails : function (id)</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineminus">-  {</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+  toggleDetails(id) {</span>
<a href="#l5.1292"></a><span id="l5.1292">     let details = e(id + &quot;_details&quot;);</span>
<a href="#l5.1293"></a><span id="l5.1293">     let tech = e(id + &quot;_technical&quot;);</span>
<a href="#l5.1294"></a><span id="l5.1294">     if (details.getAttribute(&quot;collapsed&quot;)) {</span>
<a href="#l5.1295"></a><span id="l5.1295">       details.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l5.1296"></a><span id="l5.1296">       tech.setAttribute(&quot;expanded&quot;, true);</span>
<a href="#l5.1297"></a><span id="l5.1297">     } else {</span>
<a href="#l5.1298"></a><span id="l5.1298">       details.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l5.1299"></a><span id="l5.1299">       tech.removeAttribute(&quot;expanded&quot;);</span>
<a href="#l5.1300"></a><span id="l5.1300">     }</span>
<a href="#l5.1301"></a><span id="l5.1301">   },</span>
<a href="#l5.1302"></a><span id="l5.1302"> </span>
<a href="#l5.1303"></a><span id="l5.1303">   /**</span>
<a href="#l5.1304"></a><span id="l5.1304">    * user checked checkbox that he understood it and wishes</span>
<a href="#l5.1305"></a><span id="l5.1305">    * to ignore the warning.</span>
<a href="#l5.1306"></a><span id="l5.1306">    */</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineminus">-  toggleAcknowledge : function()</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineminus">-  {</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+  toggleAcknowledge() {</span>
<a href="#l5.1310"></a><span id="l5.1310">     if (e(&quot;acknowledge_warning&quot;).checked) {</span>
<a href="#l5.1311"></a><span id="l5.1311">       _enable(&quot;iknow&quot;);</span>
<a href="#l5.1312"></a><span id="l5.1312">     } else {</span>
<a href="#l5.1313"></a><span id="l5.1313">       _disable(&quot;iknow&quot;);</span>
<a href="#l5.1314"></a><span id="l5.1314">     }</span>
<a href="#l5.1315"></a><span id="l5.1315">   },</span>
<a href="#l5.1316"></a><span id="l5.1316"> </span>
<a href="#l5.1317"></a><span id="l5.1317">   /**</span>
<a href="#l5.1318"></a><span id="l5.1318">    * [Cancel] button pressed. Get me out of here!</span>
<a href="#l5.1319"></a><span id="l5.1319">    */</span>
<a href="#l5.1320"></a><span id="l5.1320" class="difflineminus">-  onCancel : function()</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineminus">-  {</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineplus">+  onCancel() {</span>
<a href="#l5.1323"></a><span id="l5.1323">     _hide(&quot;warningbox&quot;);</span>
<a href="#l5.1324"></a><span id="l5.1324">     _show(&quot;mastervbox&quot;);</span>
<a href="#l5.1325"></a><span id="l5.1325">     window.sizeToContent();</span>
<a href="#l5.1326"></a><span id="l5.1326"> </span>
<a href="#l5.1327"></a><span id="l5.1327">     this._cancelCallback();</span>
<a href="#l5.1328"></a><span id="l5.1328">   },</span>
<a href="#l5.1329"></a><span id="l5.1329"> </span>
<a href="#l5.1330"></a><span id="l5.1330">   /**</span>
<a href="#l5.1331"></a><span id="l5.1331">    * [OK] button pressed.</span>
<a href="#l5.1332"></a><span id="l5.1332">    * Implies that the user toggled the acknowledge checkbox,</span>
<a href="#l5.1333"></a><span id="l5.1333">    * i.e. approved the config and ignored the warnings,</span>
<a href="#l5.1334"></a><span id="l5.1334">    * otherwise the button would have been disabled.</span>
<a href="#l5.1335"></a><span id="l5.1335">    */</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineminus">-  onOK : function()</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineminus">-  {</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineplus">+  onOK() {</span>
<a href="#l5.1339"></a><span id="l5.1339">     assert(e(&quot;acknowledge_warning&quot;).checked);</span>
<a href="#l5.1340"></a><span id="l5.1340"> </span>
<a href="#l5.1341"></a><span id="l5.1341">     var overrideOK = this.showCertOverrideDialog(this._currentConfigFilledIn);</span>
<a href="#l5.1342"></a><span id="l5.1342">     if (!overrideOK) {</span>
<a href="#l5.1343"></a><span id="l5.1343">       this.onCancel();</span>
<a href="#l5.1344"></a><span id="l5.1344">       return;</span>
<a href="#l5.1345"></a><span id="l5.1345">     }</span>
<a href="#l5.1346"></a><span id="l5.1346"> </span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineat">@@ -1915,46 +1831,45 @@ SecurityWarningDialog.prototype =</span>
<a href="#l5.1348"></a><span id="l5.1348">    *</span>
<a href="#l5.1349"></a><span id="l5.1349">    * @param config {AccountConfig} concrete</span>
<a href="#l5.1350"></a><span id="l5.1350">    * @returns true, if all certs are fine or the user accepted them.</span>
<a href="#l5.1351"></a><span id="l5.1351">    *     false, if the user cancelled.</span>
<a href="#l5.1352"></a><span id="l5.1352">    *</span>
<a href="#l5.1353"></a><span id="l5.1353">    * static function</span>
<a href="#l5.1354"></a><span id="l5.1354">    * sync function: blocks until the dialog is closed.</span>
<a href="#l5.1355"></a><span id="l5.1355">    */</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineminus">-  showCertOverrideDialog : function(config)</span>
<a href="#l5.1357"></a><span id="l5.1357" class="difflineminus">-  {</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineplus">+  showCertOverrideDialog(config) {</span>
<a href="#l5.1359"></a><span id="l5.1359">     if (config.incoming.socketType &gt; 1 &amp;&amp; // SSL or STARTTLS</span>
<a href="#l5.1360"></a><span id="l5.1360">         config.incoming.badCert) {</span>
<a href="#l5.1361"></a><span id="l5.1361">       var params = {</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineminus">-        exceptionAdded : false,</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineminus">-        prefetchCert : true,</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineminus">-        location : config.incoming.targetSite,</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineplus">+        exceptionAdded: false,</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineplus">+        prefetchCert: true,</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineplus">+        location: config.incoming.targetSite,</span>
<a href="#l5.1368"></a><span id="l5.1368">       };</span>
<a href="#l5.1369"></a><span id="l5.1369">       window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineminus">-                        &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineplus">+                        &quot;&quot;, &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l5.1372"></a><span id="l5.1372">       if (params.exceptionAdded) { // set by dialog</span>
<a href="#l5.1373"></a><span id="l5.1373">         config.incoming.badCert = false;</span>
<a href="#l5.1374"></a><span id="l5.1374">       } else {</span>
<a href="#l5.1375"></a><span id="l5.1375">         return false;</span>
<a href="#l5.1376"></a><span id="l5.1376">       }</span>
<a href="#l5.1377"></a><span id="l5.1377">     }</span>
<a href="#l5.1378"></a><span id="l5.1378">     if (!config.outgoing.existingServerKey) {</span>
<a href="#l5.1379"></a><span id="l5.1379">       if (config.outgoing.socketType &gt; 1 &amp;&amp; // SSL or STARTTLS</span>
<a href="#l5.1380"></a><span id="l5.1380">           config.outgoing.badCert) {</span>
<a href="#l5.1381"></a><span id="l5.1381">         var params = {</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineminus">-          exceptionAdded : false,</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineminus">-          prefetchCert : true,</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineminus">-          location : config.outgoing.targetSite,</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineplus">+          exceptionAdded: false,</span>
<a href="#l5.1386"></a><span id="l5.1386" class="difflineplus">+          prefetchCert: true,</span>
<a href="#l5.1387"></a><span id="l5.1387" class="difflineplus">+          location: config.outgoing.targetSite,</span>
<a href="#l5.1388"></a><span id="l5.1388">         };</span>
<a href="#l5.1389"></a><span id="l5.1389">         window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l5.1390"></a><span id="l5.1390" class="difflineminus">-                          &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l5.1391"></a><span id="l5.1391" class="difflineplus">+                          &quot;&quot;, &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l5.1392"></a><span id="l5.1392">         if (params.exceptionAdded) { // set by dialog</span>
<a href="#l5.1393"></a><span id="l5.1393">           config.outgoing.badCert = false;</span>
<a href="#l5.1394"></a><span id="l5.1394">         } else {</span>
<a href="#l5.1395"></a><span id="l5.1395">           return false;</span>
<a href="#l5.1396"></a><span id="l5.1396">         }</span>
<a href="#l5.1397"></a><span id="l5.1397">       }</span>
<a href="#l5.1398"></a><span id="l5.1398">     }</span>
<a href="#l5.1399"></a><span id="l5.1399">     return true;</span>
<a href="#l5.1400"></a><span id="l5.1400">   },</span>
<a href="#l5.1401"></a><span id="l5.1401" class="difflineminus">-}</span>
<a href="#l5.1402"></a><span id="l5.1402" class="difflineplus">+};</span>
<a href="#l5.1403"></a><span id="l5.1403"> var gSecurityWarningDialog = new SecurityWarningDialog();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -8,20 +8,18 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * application install directory's &quot;isp&quot; subdirectory.</span>
<a href="#l6.5"></a><span id="l6.5">  * Params @see fetchConfigFromISP()</span>
<a href="#l6.6"></a><span id="l6.6">  */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> ChromeUtils.import(&quot;resource:///modules/JXON.js&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-function fetchConfigFromDisk(domain, successCallback, errorCallback)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  return new TimeoutAbortable(runAsync(function()</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+function fetchConfigFromDisk(domain, successCallback, errorCallback) {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  return new TimeoutAbortable(runAsync(function() {</span>
<a href="#l6.18"></a><span id="l6.18">     try {</span>
<a href="#l6.19"></a><span id="l6.19">       // &lt;TB installdir&gt;/isp/example.com.xml</span>
<a href="#l6.20"></a><span id="l6.20">       var configLocation = Services.dirsvc.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l6.21"></a><span id="l6.21">       configLocation.append(&quot;isp&quot;);</span>
<a href="#l6.22"></a><span id="l6.22">       configLocation.append(sanitize.hostname(domain) + &quot;.xml&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">       if (!configLocation.exists() || !configLocation.isReadable()) {</span>
<a href="#l6.25"></a><span id="l6.25">         errorCallback(&quot;local file not found&quot;);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -52,18 +50,17 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l6.27"></a><span id="l6.27">  * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l6.28"></a><span id="l6.28">  *         will be called when we could not retrieve a configuration,</span>
<a href="#l6.29"></a><span id="l6.29">  *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l6.30"></a><span id="l6.30">  *         for this domain at this location),</span>
<a href="#l6.31"></a><span id="l6.31">  *         so do not unconditionally show this to the user.</span>
<a href="#l6.32"></a><span id="l6.32">  *         The first parameter will be an exception object or error string.</span>
<a href="#l6.33"></a><span id="l6.33">  */</span>
<a href="#l6.34"></a><span id="l6.34"> function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                            errorCallback)</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-{</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+                            errorCallback) {</span>
<a href="#l6.38"></a><span id="l6.38">   if (!Services.prefs.getBoolPref(</span>
<a href="#l6.39"></a><span id="l6.39">       &quot;mailnews.auto_config.fetchFromISP.enabled&quot;)) {</span>
<a href="#l6.40"></a><span id="l6.40">     errorCallback(&quot;ISP fetch disabled per user preference&quot;);</span>
<a href="#l6.41"></a><span id="l6.41">     return;</span>
<a href="#l6.42"></a><span id="l6.42">   }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">   let url1 = &quot;http://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l6.45"></a><span id="l6.45">              &quot;/mail/config-v1.1.xml&quot;;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineat">@@ -73,38 +70,34 @@ function fetchConfigFromISP(domain, emai</span>
<a href="#l6.47"></a><span id="l6.47">   let sucAbortable = new SuccessiveAbortable();</span>
<a href="#l6.48"></a><span id="l6.48">   var time = Date.now();</span>
<a href="#l6.49"></a><span id="l6.49">   var urlArgs = { emailaddress: emailAddress };</span>
<a href="#l6.50"></a><span id="l6.50">   if (!Services.prefs.getBoolPref(</span>
<a href="#l6.51"></a><span id="l6.51">       &quot;mailnews.auto_config.fetchFromISP.sendEmailAddress&quot;)) {</span>
<a href="#l6.52"></a><span id="l6.52">     delete urlArgs.emailaddress;</span>
<a href="#l6.53"></a><span id="l6.53">   }</span>
<a href="#l6.54"></a><span id="l6.54">   let fetch1 = new FetchHTTP(url1, urlArgs, false,</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    function(result)</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    function(result) {</span>
<a href="#l6.58"></a><span id="l6.58">       successCallback(readFromXML(result));</span>
<a href="#l6.59"></a><span id="l6.59">     },</span>
<a href="#l6.60"></a><span id="l6.60">     function(e1) // fetch1 failed</span>
<a href="#l6.61"></a><span id="l6.61">     {</span>
<a href="#l6.62"></a><span id="l6.62">       ddump(&quot;fetchisp 1 &lt;&quot; + url1 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l6.63"></a><span id="l6.63">           &quot;ms and failed with &quot; + e1);</span>
<a href="#l6.64"></a><span id="l6.64">       time = Date.now();</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-      if (e1 instanceof CancelledException)</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-      {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+      if (e1 instanceof CancelledException) {</span>
<a href="#l6.68"></a><span id="l6.68">         errorCallback(e1);</span>
<a href="#l6.69"></a><span id="l6.69">         return;</span>
<a href="#l6.70"></a><span id="l6.70">       }</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">       let fetch2 = new FetchHTTP(url2, urlArgs, false,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-        function(result)</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-        {</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+        function(result) {</span>
<a href="#l6.76"></a><span id="l6.76">           successCallback(readFromXML(result));</span>
<a href="#l6.77"></a><span id="l6.77">         },</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-        function(e2)</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-        {</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+        function(e2) {</span>
<a href="#l6.81"></a><span id="l6.81">           ddump(&quot;fetchisp 2 &lt;&quot; + url2 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l6.82"></a><span id="l6.82">               &quot;ms and failed with &quot; + e2);</span>
<a href="#l6.83"></a><span id="l6.83">           // return the error for the primary call,</span>
<a href="#l6.84"></a><span id="l6.84">           // unless the fetch was cancelled</span>
<a href="#l6.85"></a><span id="l6.85">           errorCallback(e2 instanceof CancelledException ? e2 : e1);</span>
<a href="#l6.86"></a><span id="l6.86">         });</span>
<a href="#l6.87"></a><span id="l6.87">       sucAbortable.current = fetch2;</span>
<a href="#l6.88"></a><span id="l6.88">       fetch2.start();</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineat">@@ -115,33 +108,31 @@ function fetchConfigFromISP(domain, emai</span>
<a href="#l6.90"></a><span id="l6.90"> }</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92"> /**</span>
<a href="#l6.93"></a><span id="l6.93">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l6.94"></a><span id="l6.94">  * Mozilla servers.</span>
<a href="#l6.95"></a><span id="l6.95">  * Params @see fetchConfigFromISP()</span>
<a href="#l6.96"></a><span id="l6.96">  */</span>
<a href="#l6.97"></a><span id="l6.97"> </span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-function fetchConfigFromDB(domain, successCallback, errorCallback)</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-{</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+function fetchConfigFromDB(domain, successCallback, errorCallback) {</span>
<a href="#l6.101"></a><span id="l6.101">   let url = Services.prefs.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l6.102"></a><span id="l6.102">   domain = sanitize.hostname(domain);</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l6.105"></a><span id="l6.105">   if (!url.includes(&quot;{{domain}}&quot;))</span>
<a href="#l6.106"></a><span id="l6.106">     url = url + domain;</span>
<a href="#l6.107"></a><span id="l6.107">   else</span>
<a href="#l6.108"></a><span id="l6.108">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l6.109"></a><span id="l6.109">   url = url.replace(&quot;{{accounts}}&quot;, MailServices.accounts.accounts.length);</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">   if (!url.length)</span>
<a href="#l6.112"></a><span id="l6.112">     return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l6.113"></a><span id="l6.113">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-                            function(result)</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-                            {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+                            function(result) {</span>
<a href="#l6.117"></a><span id="l6.117">                               successCallback(readFromXML(result));</span>
<a href="#l6.118"></a><span id="l6.118">                             },</span>
<a href="#l6.119"></a><span id="l6.119">                             errorCallback);</span>
<a href="#l6.120"></a><span id="l6.120">   fetch.start();</span>
<a href="#l6.121"></a><span id="l6.121">   return fetch;</span>
<a href="#l6.122"></a><span id="l6.122"> }</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124"> /**</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineat">@@ -160,30 +151,28 @@ function fetchConfigFromDB(domain, succe</span>
<a href="#l6.126"></a><span id="l6.126">  *   conclusional jump we make here.) and alternative domains</span>
<a href="#l6.127"></a><span id="l6.127">  *   (e.g. yahoo.de -&gt; yahoo.com).</span>
<a href="#l6.128"></a><span id="l6.128">  * - We make a look up for the base domain. E.g. if MX is</span>
<a href="#l6.129"></a><span id="l6.129">  *   mx1.incoming.servers.hoster.com, we look up hoster.com.</span>
<a href="#l6.130"></a><span id="l6.130">  *   Thanks to Services.eTLD, we also get bbc.co.uk right.</span>
<a href="#l6.131"></a><span id="l6.131">  *</span>
<a href="#l6.132"></a><span id="l6.132">  * Params @see fetchConfigFromISP()</span>
<a href="#l6.133"></a><span id="l6.133">  */</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-function fetchConfigForMX(domain, successCallback, errorCallback)</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-{</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+function fetchConfigForMX(domain, successCallback, errorCallback) {</span>
<a href="#l6.137"></a><span id="l6.137">   domain = sanitize.hostname(domain);</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139">   var sucAbortable = new SuccessiveAbortable();</span>
<a href="#l6.140"></a><span id="l6.140">   var time = Date.now();</span>
<a href="#l6.141"></a><span id="l6.141">   sucAbortable.current = getMX(domain,</span>
<a href="#l6.142"></a><span id="l6.142">     function(mxHostname) // success</span>
<a href="#l6.143"></a><span id="l6.143">     {</span>
<a href="#l6.144"></a><span id="l6.144">       ddump(&quot;getmx took &quot; + (Date.now() - time) + &quot;ms&quot;);</span>
<a href="#l6.145"></a><span id="l6.145">       let sld = Services.eTLD.getBaseDomainFromHost(mxHostname);</span>
<a href="#l6.146"></a><span id="l6.146">       ddump(&quot;base domain &quot; + sld + &quot; for &quot; + mxHostname);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-      if (sld == domain)</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-      {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+      if (sld == domain) {</span>
<a href="#l6.150"></a><span id="l6.150">         errorCallback(&quot;MX lookup would be no different from domain&quot;);</span>
<a href="#l6.151"></a><span id="l6.151">         return;</span>
<a href="#l6.152"></a><span id="l6.152">       }</span>
<a href="#l6.153"></a><span id="l6.153">       sucAbortable.current = fetchConfigFromDB(sld, successCallback,</span>
<a href="#l6.154"></a><span id="l6.154">                                                errorCallback);</span>
<a href="#l6.155"></a><span id="l6.155">     },</span>
<a href="#l6.156"></a><span id="l6.156">     errorCallback);</span>
<a href="#l6.157"></a><span id="l6.157">   return sucAbortable;</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineat">@@ -206,36 +195,33 @@ function fetchConfigForMX(domain, succes</span>
<a href="#l6.159"></a><span id="l6.159">  *</span>
<a href="#l6.160"></a><span id="l6.160">  * @param domain @see fetchConfigFromISP()</span>
<a href="#l6.161"></a><span id="l6.161">  * @param successCallback {function(hostname {String})</span>
<a href="#l6.162"></a><span id="l6.162">  *   Called when we found an MX for the domain.</span>
<a href="#l6.163"></a><span id="l6.163">  *   For |hostname|, see description above.</span>
<a href="#l6.164"></a><span id="l6.164">  * @param errorCallback @see fetchConfigFromISP()</span>
<a href="#l6.165"></a><span id="l6.165">  * @returns @see fetchConfigFromISP()</span>
<a href="#l6.166"></a><span id="l6.166">  */</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-function getMX(domain, successCallback, errorCallback)</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-{</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+function getMX(domain, successCallback, errorCallback) {</span>
<a href="#l6.170"></a><span id="l6.170">   domain = sanitize.hostname(domain);</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172">   let url = Services.prefs.getCharPref(&quot;mailnews.mx_service_url&quot;);</span>
<a href="#l6.173"></a><span id="l6.173">   if (!url)</span>
<a href="#l6.174"></a><span id="l6.174">     errorCallback(&quot;no URL for MX service configured&quot;);</span>
<a href="#l6.175"></a><span id="l6.175">   url += domain;</span>
<a href="#l6.176"></a><span id="l6.176"> </span>
<a href="#l6.177"></a><span id="l6.177">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    function(result)</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    function(result) {</span>
<a href="#l6.181"></a><span id="l6.181">       // result is plain text, with one line per server.</span>
<a href="#l6.182"></a><span id="l6.182">       // So just take the first line</span>
<a href="#l6.183"></a><span id="l6.183">       ddump(&quot;MX query result: \n&quot; + result + &quot;(end)&quot;);</span>
<a href="#l6.184"></a><span id="l6.184">       assert(typeof(result) == &quot;string&quot;);</span>
<a href="#l6.185"></a><span id="l6.185">       let first = result.split(&quot;\n&quot;)[0];</span>
<a href="#l6.186"></a><span id="l6.186">       first.toLowerCase().replace(/[^a-z0-9\-_\.]*/g, &quot;&quot;);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-      if (first.length == 0)</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-      {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+      if (first.length == 0) {</span>
<a href="#l6.190"></a><span id="l6.190">         errorCallback(&quot;no MX found&quot;);</span>
<a href="#l6.191"></a><span id="l6.191">         return;</span>
<a href="#l6.192"></a><span id="l6.192">       }</span>
<a href="#l6.193"></a><span id="l6.193">       successCallback(first);</span>
<a href="#l6.194"></a><span id="l6.194">     },</span>
<a href="#l6.195"></a><span id="l6.195">     errorCallback);</span>
<a href="#l6.196"></a><span id="l6.196">   fetch.start();</span>
<a href="#l6.197"></a><span id="l6.197">   return fetch;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/accountcreation/content/fetchhttp.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/accountcreation/content/fetchhttp.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -64,204 +64,181 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l7.4"></a><span id="l7.4">  *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l7.5"></a><span id="l7.5">  *   This cannot be used together with |uploadBody|.</span>
<a href="#l7.6"></a><span id="l7.6">  * @param uploadbody {Object}   Arbitrary object, which to use as</span>
<a href="#l7.7"></a><span id="l7.7">  *   body of the HTTP request. Will also set the mimetype accordingly.</span>
<a href="#l7.8"></a><span id="l7.8">  *   Only supported object types, currently only E4X is supported</span>
<a href="#l7.9"></a><span id="l7.9">  *   (sending XML).</span>
<a href="#l7.10"></a><span id="l7.10">  *   Usually, you have nothing to upload, so just pass |null|.</span>
<a href="#l7.11"></a><span id="l7.11">  */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function FetchHTTP(url, urlArgs, post, successCallback, errorCallback)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+function FetchHTTP(url, urlArgs, post, successCallback, errorCallback) {</span>
<a href="#l7.15"></a><span id="l7.15">   assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: successCallback&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: errorCallback&quot;);</span>
<a href="#l7.17"></a><span id="l7.17">   this._url = sanitize.string(url);</span>
<a href="#l7.18"></a><span id="l7.18">   if (!urlArgs)</span>
<a href="#l7.19"></a><span id="l7.19">     urlArgs = {};</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   this._urlArgs = urlArgs;</span>
<a href="#l7.22"></a><span id="l7.22">   this._post = sanitize.boolean(post);</span>
<a href="#l7.23"></a><span id="l7.23">   this._successCallback = successCallback;</span>
<a href="#l7.24"></a><span id="l7.24">   this._errorCallback = errorCallback;</span>
<a href="#l7.25"></a><span id="l7.25"> }</span>
<a href="#l7.26"></a><span id="l7.26"> FetchHTTP.prototype =</span>
<a href="#l7.27"></a><span id="l7.27"> {</span>
<a href="#l7.28"></a><span id="l7.28">   __proto__: Abortable.prototype,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-  _url : null, // URL as passed to ctor, without arguments</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  _urlArgs : null,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  _post : null,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  _successCallback : null,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  _errorCallback : null,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  _request : null, // the XMLHttpRequest object</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  result : null,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  _url: null, // URL as passed to ctor, without arguments</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  _urlArgs: null,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  _post: null,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  _successCallback: null,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  _errorCallback: null,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  _request: null, // the XMLHttpRequest object</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  result: null,</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  start : function()</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  start() {</span>
<a href="#l7.47"></a><span id="l7.47">     var url = this._url;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-    for (var name in this._urlArgs)</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    for (var name in this._urlArgs) {</span>
<a href="#l7.51"></a><span id="l7.51">       url += (!url.includes(&quot;?&quot;) ? &quot;?&quot; : &quot;&amp;&quot;) +</span>
<a href="#l7.52"></a><span id="l7.52">               name + &quot;=&quot; + encodeURIComponent(this._urlArgs[name]);</span>
<a href="#l7.53"></a><span id="l7.53">     }</span>
<a href="#l7.54"></a><span id="l7.54">     this._request = new XMLHttpRequest();</span>
<a href="#l7.55"></a><span id="l7.55">     let request = this._request;</span>
<a href="#l7.56"></a><span id="l7.56">     request.open(this._post ? &quot;POST&quot; : &quot;GET&quot;, url);</span>
<a href="#l7.57"></a><span id="l7.57">     request.channel.loadGroup = null;</span>
<a href="#l7.58"></a><span id="l7.58">     // needs bug 407190 patch v4 (or higher) - uncomment if that lands.</span>
<a href="#l7.59"></a><span id="l7.59">     // try {</span>
<a href="#l7.60"></a><span id="l7.60">     //    var channel = request.channel.QueryInterface(Ci.nsIHttpChannel2);</span>
<a href="#l7.61"></a><span id="l7.61">     //    channel.connectTimeout = 5;</span>
<a href="#l7.62"></a><span id="l7.62">     //    channel.requestTimeout = 5;</span>
<a href="#l7.63"></a><span id="l7.63">     //    } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">     var me = this;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    request.onload = function() { me._response(true); }</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    request.onerror = function() { me._response(false); }</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    request.onload = function() { me._response(true); };</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    request.onerror = function() { me._response(false); };</span>
<a href="#l7.70"></a><span id="l7.70">     request.send(null);</span>
<a href="#l7.71"></a><span id="l7.71">   },</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  _response : function(success, exStored)</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    try</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  _response(success, exStored) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    try {</span>
<a href="#l7.78"></a><span id="l7.78">     var errorCode = null;</span>
<a href="#l7.79"></a><span id="l7.79">     var errorStr = null;</span>
<a href="#l7.80"></a><span id="l7.80"> </span>
<a href="#l7.81"></a><span id="l7.81">     if (success &amp;&amp; this._request.status &gt;= 200 &amp;&amp;</span>
<a href="#l7.82"></a><span id="l7.82">         this._request.status &lt; 300) // HTTP level success</span>
<a href="#l7.83"></a><span id="l7.83">     {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-      try</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-      {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+      try {</span>
<a href="#l7.87"></a><span id="l7.87">         // response</span>
<a href="#l7.88"></a><span id="l7.88">         var mimetype = this._request.getResponseHeader(&quot;Content-Type&quot;);</span>
<a href="#l7.89"></a><span id="l7.89">         if (!mimetype)</span>
<a href="#l7.90"></a><span id="l7.90">           mimetype = &quot;&quot;;</span>
<a href="#l7.91"></a><span id="l7.91">         mimetype = mimetype.split(&quot;;&quot;)[0];</span>
<a href="#l7.92"></a><span id="l7.92">         if (mimetype == &quot;text/xml&quot; ||</span>
<a href="#l7.93"></a><span id="l7.93">             mimetype == &quot;application/xml&quot; ||</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-            mimetype == &quot;text/rdf&quot;)</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-        {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+            mimetype == &quot;text/rdf&quot;) {</span>
<a href="#l7.97"></a><span id="l7.97">           this.result = JXON.build(this._request.responseXML);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-        }</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-        else</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-        {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-          //ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+        } else {</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+          // ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l7.104"></a><span id="l7.104">           this.result = this._request.responseText;</span>
<a href="#l7.105"></a><span id="l7.105">         }</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-        //ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-      }</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-      catch (e)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-      {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        // ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.112"></a><span id="l7.112">         success = false;</span>
<a href="#l7.113"></a><span id="l7.113">         errorStr = getStringBundle(</span>
<a href="#l7.114"></a><span id="l7.114">                    &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l7.115"></a><span id="l7.115">                    .GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l7.116"></a><span id="l7.116">         errorCode = -4;</span>
<a href="#l7.117"></a><span id="l7.117">       }</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    }</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    else</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+    } else {</span>
<a href="#l7.122"></a><span id="l7.122">       success = false;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-      try</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-      {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      try {</span>
<a href="#l7.126"></a><span id="l7.126">         errorCode = this._request.status;</span>
<a href="#l7.127"></a><span id="l7.127">         errorStr = this._request.statusText;</span>
<a href="#l7.128"></a><span id="l7.128">       } catch (e) {</span>
<a href="#l7.129"></a><span id="l7.129">         // If we can't resolve the hostname in DNS etc., .statusText throws</span>
<a href="#l7.130"></a><span id="l7.130">         errorCode = -2;</span>
<a href="#l7.131"></a><span id="l7.131">         errorStr = getStringBundle(</span>
<a href="#l7.132"></a><span id="l7.132">                    &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l7.133"></a><span id="l7.133">                    .GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l7.134"></a><span id="l7.134">         ddump(errorStr);</span>
<a href="#l7.135"></a><span id="l7.135">       }</span>
<a href="#l7.136"></a><span id="l7.136">     }</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138">     // Callbacks</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    if (success)</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    {</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    if (success) {</span>
<a href="#l7.142"></a><span id="l7.142">       try {</span>
<a href="#l7.143"></a><span id="l7.143">         this._successCallback(this.result);</span>
<a href="#l7.144"></a><span id="l7.144">       } catch (e) {</span>
<a href="#l7.145"></a><span id="l7.145">         logException(e);</span>
<a href="#l7.146"></a><span id="l7.146">         this._error(e);</span>
<a href="#l7.147"></a><span id="l7.147">       }</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-    }</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-    else if (exStored)</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+    } else if (exStored)</span>
<a href="#l7.151"></a><span id="l7.151">       this._error(exStored);</span>
<a href="#l7.152"></a><span id="l7.152">     else</span>
<a href="#l7.153"></a><span id="l7.153">       this._error(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    if (this._finishedCallback)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-    {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    if (this._finishedCallback) {</span>
<a href="#l7.158"></a><span id="l7.158">       try {</span>
<a href="#l7.159"></a><span id="l7.159">         this._finishedCallback(this);</span>
<a href="#l7.160"></a><span id="l7.160">       } catch (e) {</span>
<a href="#l7.161"></a><span id="l7.161">         logException(e);</span>
<a href="#l7.162"></a><span id="l7.162">         this._error(e);</span>
<a href="#l7.163"></a><span id="l7.163">       }</span>
<a href="#l7.164"></a><span id="l7.164">     }</span>
<a href="#l7.165"></a><span id="l7.165"> </span>
<a href="#l7.166"></a><span id="l7.166">     } catch (e) {</span>
<a href="#l7.167"></a><span id="l7.167">       // error in our fetchhttp._response() code</span>
<a href="#l7.168"></a><span id="l7.168">       logException(e);</span>
<a href="#l7.169"></a><span id="l7.169">       this._error(e);</span>
<a href="#l7.170"></a><span id="l7.170">     }</span>
<a href="#l7.171"></a><span id="l7.171">   },</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-  _error : function(e)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  _error(e) {</span>
<a href="#l7.175"></a><span id="l7.175">     try {</span>
<a href="#l7.176"></a><span id="l7.176">       this._errorCallback(e);</span>
<a href="#l7.177"></a><span id="l7.177">     } catch (e) {</span>
<a href="#l7.178"></a><span id="l7.178">       // error in errorCallback, too!</span>
<a href="#l7.179"></a><span id="l7.179">       logException(e);</span>
<a href="#l7.180"></a><span id="l7.180">       alertPrompt(&quot;Error in errorCallback for fetchhttp&quot;, e);</span>
<a href="#l7.181"></a><span id="l7.181">     }</span>
<a href="#l7.182"></a><span id="l7.182">   },</span>
<a href="#l7.183"></a><span id="l7.183">   /**</span>
<a href="#l7.184"></a><span id="l7.184">    * Call this between start() and finishedCallback fired.</span>
<a href="#l7.185"></a><span id="l7.185">    */</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-  cancel : function(ex)</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  cancel(ex) {</span>
<a href="#l7.189"></a><span id="l7.189">     assert(!this.result, &quot;Call already returned&quot;);</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191">     this._request.abort();</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193">     // Need to manually call error handler</span>
<a href="#l7.194"></a><span id="l7.194">     // &lt;https://bugzilla.mozilla.org/show_bug.cgi?id=218236#c11&gt;</span>
<a href="#l7.195"></a><span id="l7.195">     this._response(false, ex ? ex : new UserCancelledException());</span>
<a href="#l7.196"></a><span id="l7.196">   },</span>
<a href="#l7.197"></a><span id="l7.197">   /**</span>
<a href="#l7.198"></a><span id="l7.198">    * Allows caller or lib to be notified when the call is done.</span>
<a href="#l7.199"></a><span id="l7.199">    * This is useful to enable and disable a Cancel button in the UI,</span>
<a href="#l7.200"></a><span id="l7.200">    * which allows to cancel the network request.</span>
<a href="#l7.201"></a><span id="l7.201">    */</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-  setFinishedCallback : function(finishedCallback)</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  setFinishedCallback(finishedCallback) {</span>
<a href="#l7.205"></a><span id="l7.205">     this._finishedCallback = finishedCallback;</span>
<a href="#l7.206"></a><span id="l7.206">   }</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-}</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+};</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-function CancelledException(msg)</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-{</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+function CancelledException(msg) {</span>
<a href="#l7.213"></a><span id="l7.213">   Exception.call(this, msg);</span>
<a href="#l7.214"></a><span id="l7.214"> }</span>
<a href="#l7.215"></a><span id="l7.215"> CancelledException.prototype = Object.create(Exception.prototype);</span>
<a href="#l7.216"></a><span id="l7.216"> CancelledException.prototype.constructor = CancelledException;</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-function UserCancelledException(msg)</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-{</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+function UserCancelledException(msg) {</span>
<a href="#l7.221"></a><span id="l7.221">   // The user knows they cancelled so I don't see a need</span>
<a href="#l7.222"></a><span id="l7.222">   // for a message to that effect.</span>
<a href="#l7.223"></a><span id="l7.223">   if (!msg)</span>
<a href="#l7.224"></a><span id="l7.224">     msg = &quot;User cancelled&quot;;</span>
<a href="#l7.225"></a><span id="l7.225">   CancelledException.call(this, msg);</span>
<a href="#l7.226"></a><span id="l7.226"> }</span>
<a href="#l7.227"></a><span id="l7.227"> UserCancelledException.prototype = Object.create(CancelledException.prototype);</span>
<a href="#l7.228"></a><span id="l7.228"> UserCancelledException.prototype.constructor = UserCancelledException;</span>
<a href="#l7.229"></a><span id="l7.229"> </span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-function ServerException(msg, code, uri)</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-{</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+function ServerException(msg, code, uri) {</span>
<a href="#l7.233"></a><span id="l7.233">   Exception.call(this, msg);</span>
<a href="#l7.234"></a><span id="l7.234">   this.code = code;</span>
<a href="#l7.235"></a><span id="l7.235">   this.uri = uri;</span>
<a href="#l7.236"></a><span id="l7.236"> }</span>
<a href="#l7.237"></a><span id="l7.237"> ServerException.prototype = Object.create(Exception.prototype);</span>
<a href="#l7.238"></a><span id="l7.238"> ServerException.prototype.constructor = ServerException;</span>
<a href="#l7.239"></a><span id="l7.239"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -49,18 +49,17 @@ var outgoingDone = false;</span>
<a href="#l8.4"></a><span id="l8.4">  * @param resultConfig {AccountConfig} (optional)</span>
<a href="#l8.5"></a><span id="l8.5">  *   A config which may be partially filled in. If so, it will be used as base</span>
<a href="#l8.6"></a><span id="l8.6">  *   for the guess.</span>
<a href="#l8.7"></a><span id="l8.7">  * @param which {String-enum} (optional)  &quot;incoming&quot;, &quot;outgoing&quot;, or &quot;both&quot;.</span>
<a href="#l8.8"></a><span id="l8.8">  *   Default &quot;both&quot;. Whether to guess only the incoming or outgoing server.</span>
<a href="#l8.9"></a><span id="l8.9">  * @result {Abortable} Allows you to cancel the guess</span>
<a href="#l8.10"></a><span id="l8.10">  */</span>
<a href="#l8.11"></a><span id="l8.11"> function guessConfig(domain, progressCallback, successCallback, errorCallback,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                     resultConfig, which)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                     resultConfig, which) {</span>
<a href="#l8.15"></a><span id="l8.15">   assert(typeof(progressCallback) == &quot;function&quot;, &quot;need progressCallback&quot;);</span>
<a href="#l8.16"></a><span id="l8.16">   assert(typeof(successCallback) == &quot;function&quot;, &quot;need successCallback&quot;);</span>
<a href="#l8.17"></a><span id="l8.17">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;need errorCallback&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">   // Servers that we know enough that they support OAuth2 do not need guessing.</span>
<a href="#l8.20"></a><span id="l8.20">   if (resultConfig.incoming.auth == Ci.nsMsgAuthMethod.OAuth2) {</span>
<a href="#l8.21"></a><span id="l8.21">     successCallback(resultConfig);</span>
<a href="#l8.22"></a><span id="l8.22">     return null;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -79,18 +78,17 @@ function guessConfig(domain, progressCal</span>
<a href="#l8.24"></a><span id="l8.24">   var incomingHostDetector = null;</span>
<a href="#l8.25"></a><span id="l8.25">   var outgoingHostDetector = null;</span>
<a href="#l8.26"></a><span id="l8.26">   var incomingEx = null; // if incoming had error, store ex here</span>
<a href="#l8.27"></a><span id="l8.27">   var outgoingEx = null; // if incoming had error, store ex here</span>
<a href="#l8.28"></a><span id="l8.28">   var incomingDone = (which == &quot;outgoing&quot;);</span>
<a href="#l8.29"></a><span id="l8.29">   var outgoingDone = (which == &quot;incoming&quot;);</span>
<a href="#l8.30"></a><span id="l8.30">   // If we're offline, we're going to pick the most common settings.</span>
<a href="#l8.31"></a><span id="l8.31">   // (Not the &quot;best&quot; settings, but common).</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  if (Services.io.offline)</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  if (Services.io.offline) {</span>
<a href="#l8.35"></a><span id="l8.35">     resultConfig.source = AccountConfig.kSourceUser;</span>
<a href="#l8.36"></a><span id="l8.36">     resultConfig.incoming.hostname = &quot;mail.&quot; + domain;</span>
<a href="#l8.37"></a><span id="l8.37">     resultConfig.incoming.username = resultConfig.identity.emailAddress;</span>
<a href="#l8.38"></a><span id="l8.38">     resultConfig.outgoing.username = resultConfig.identity.emailAddress;</span>
<a href="#l8.39"></a><span id="l8.39">     resultConfig.incoming.type = &quot;imap&quot;;</span>
<a href="#l8.40"></a><span id="l8.40">     resultConfig.incoming.port = 143;</span>
<a href="#l8.41"></a><span id="l8.41">     resultConfig.incoming.socketType = 3; // starttls</span>
<a href="#l8.42"></a><span id="l8.42">     resultConfig.incoming.auth = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineat">@@ -104,187 +102,169 @@ function guessConfig(domain, progressCal</span>
<a href="#l8.44"></a><span id="l8.44">       type: &quot;pop3&quot;,</span>
<a href="#l8.45"></a><span id="l8.45">       port: 110,</span>
<a href="#l8.46"></a><span id="l8.46">       socketType: 3,</span>
<a href="#l8.47"></a><span id="l8.47">       auth: Ci.nsMsgAuthMethod.passwordCleartext</span>
<a href="#l8.48"></a><span id="l8.48">     });</span>
<a href="#l8.49"></a><span id="l8.49">     successCallback(resultConfig);</span>
<a href="#l8.50"></a><span id="l8.50">     return null;</span>
<a href="#l8.51"></a><span id="l8.51">   }</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  var progress = function(thisTry)</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  var progress = function(thisTry) {</span>
<a href="#l8.55"></a><span id="l8.55">     progressCallback(protocolToString(thisTry.protocol), thisTry.hostname,</span>
<a href="#l8.56"></a><span id="l8.56">                      thisTry.port, sslConvertToSocketType(thisTry.ssl), false,</span>
<a href="#l8.57"></a><span id="l8.57">                      resultConfig);</span>
<a href="#l8.58"></a><span id="l8.58">   };</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  var updateConfig = function(config)</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  var updateConfig = function(config) {</span>
<a href="#l8.63"></a><span id="l8.63">     resultConfig = config;</span>
<a href="#l8.64"></a><span id="l8.64">   };</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-  var errorInCallback = function(e)</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-  {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  var errorInCallback = function(e) {</span>
<a href="#l8.69"></a><span id="l8.69">     // The caller's errorCallback threw.</span>
<a href="#l8.70"></a><span id="l8.70">     // hopefully shouldn't happen for users.</span>
<a href="#l8.71"></a><span id="l8.71">     alertPrompt(&quot;Error in errorCallback for guessConfig()&quot;, e);</span>
<a href="#l8.72"></a><span id="l8.72">   };</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  var checkDone = function()</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-  {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    if (incomingEx)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  var checkDone = function() {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    if (incomingEx) {</span>
<a href="#l8.80"></a><span id="l8.80">       try {</span>
<a href="#l8.81"></a><span id="l8.81">         errorCallback(incomingEx, resultConfig);</span>
<a href="#l8.82"></a><span id="l8.82">       } catch (e) { errorInCallback(e); }</span>
<a href="#l8.83"></a><span id="l8.83">       return;</span>
<a href="#l8.84"></a><span id="l8.84">     }</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    if (outgoingEx)</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-    {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    if (outgoingEx) {</span>
<a href="#l8.88"></a><span id="l8.88">       try {</span>
<a href="#l8.89"></a><span id="l8.89">         errorCallback(outgoingEx, resultConfig);</span>
<a href="#l8.90"></a><span id="l8.90">       } catch (e) { errorInCallback(e); }</span>
<a href="#l8.91"></a><span id="l8.91">       return;</span>
<a href="#l8.92"></a><span id="l8.92">     }</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    if (incomingDone &amp;&amp; outgoingDone)</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    if (incomingDone &amp;&amp; outgoingDone) {</span>
<a href="#l8.96"></a><span id="l8.96">       try {</span>
<a href="#l8.97"></a><span id="l8.97">         successCallback(resultConfig);</span>
<a href="#l8.98"></a><span id="l8.98">       } catch (e) {</span>
<a href="#l8.99"></a><span id="l8.99">         try {</span>
<a href="#l8.100"></a><span id="l8.100">           errorCallback(e);</span>
<a href="#l8.101"></a><span id="l8.101">         } catch (e) { errorInCallback(e); }</span>
<a href="#l8.102"></a><span id="l8.102">       }</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-      return;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+</span>
<a href="#l8.105"></a><span id="l8.105">     }</span>
<a href="#l8.106"></a><span id="l8.106">   };</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">   var logger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-  var HostTryToAccountServer = function(thisTry, server)</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  {</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  var HostTryToAccountServer = function(thisTry, server) {</span>
<a href="#l8.112"></a><span id="l8.112">     server.type = protocolToString(thisTry.protocol);</span>
<a href="#l8.113"></a><span id="l8.113">     server.hostname = thisTry.hostname;</span>
<a href="#l8.114"></a><span id="l8.114">     server.port = thisTry.port;</span>
<a href="#l8.115"></a><span id="l8.115">     server.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l8.116"></a><span id="l8.116">     server.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l8.117"></a><span id="l8.117">     server.authAlternatives = thisTry.authMethods;</span>
<a href="#l8.118"></a><span id="l8.118">     // TODO</span>
<a href="#l8.119"></a><span id="l8.119">     // cert is also bad when targetSite is set. (Same below for incoming.)</span>
<a href="#l8.120"></a><span id="l8.120">     // Fix SSLErrorHandler and security warning dialog in emailWizard.js.</span>
<a href="#l8.121"></a><span id="l8.121">     server.badCert = thisTry.selfSignedCert;</span>
<a href="#l8.122"></a><span id="l8.122">     server.targetSite = thisTry.targetSite;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    logger.info(&quot;CHOOSING &quot; + server.type + &quot; &quot;+ server.hostname + &quot;:&quot; +</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    logger.info(&quot;CHOOSING &quot; + server.type + &quot; &quot; + server.hostname + &quot;:&quot; +</span>
<a href="#l8.125"></a><span id="l8.125">           server.port + &quot;, auth method &quot; + server.auth + &quot; &quot; +</span>
<a href="#l8.126"></a><span id="l8.126">           server.authAlternatives.join(&quot;,&quot;) + &quot;, SSL &quot; + server.socketType +</span>
<a href="#l8.127"></a><span id="l8.127">           (server.badCert ? &quot; (bad cert!)&quot; : &quot;&quot;));</span>
<a href="#l8.128"></a><span id="l8.128">   };</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  var outgoingSuccess = function(thisTry, alternativeTries)</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  var outgoingSuccess = function(thisTry, alternativeTries) {</span>
<a href="#l8.133"></a><span id="l8.133">     assert(thisTry.protocol == SMTP, &quot;I only know SMTP for outgoing&quot;);</span>
<a href="#l8.134"></a><span id="l8.134">     // Ensure there are no previously saved outgoing errors, if we've got</span>
<a href="#l8.135"></a><span id="l8.135">     // success here.</span>
<a href="#l8.136"></a><span id="l8.136">     outgoingEx = null;</span>
<a href="#l8.137"></a><span id="l8.137">     HostTryToAccountServer(thisTry, resultConfig.outgoing);</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    for (let alternativeTry of alternativeTries)</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-    {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    for (let alternativeTry of alternativeTries) {</span>
<a href="#l8.142"></a><span id="l8.142">       // resultConfig.createNewOutgoing(); misses username etc., so copy</span>
<a href="#l8.143"></a><span id="l8.143">       let altServer = deepCopy(resultConfig.outgoing);</span>
<a href="#l8.144"></a><span id="l8.144">       HostTryToAccountServer(alternativeTry, altServer);</span>
<a href="#l8.145"></a><span id="l8.145">       assert(resultConfig.outgoingAlternatives);</span>
<a href="#l8.146"></a><span id="l8.146">       resultConfig.outgoingAlternatives.push(altServer);</span>
<a href="#l8.147"></a><span id="l8.147">     }</span>
<a href="#l8.148"></a><span id="l8.148"> </span>
<a href="#l8.149"></a><span id="l8.149">     progressCallback(resultConfig.outgoing.type,</span>
<a href="#l8.150"></a><span id="l8.150">         resultConfig.outgoing.hostname, resultConfig.outgoing.port,</span>
<a href="#l8.151"></a><span id="l8.151">         resultConfig.outgoing.socketType, true, resultConfig);</span>
<a href="#l8.152"></a><span id="l8.152">     outgoingDone = true;</span>
<a href="#l8.153"></a><span id="l8.153">     checkDone();</span>
<a href="#l8.154"></a><span id="l8.154">   };</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-  var incomingSuccess = function(thisTry, alternativeTries)</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  var incomingSuccess = function(thisTry, alternativeTries) {</span>
<a href="#l8.159"></a><span id="l8.159">     // Ensure there are no previously saved incoming errors, if we've got</span>
<a href="#l8.160"></a><span id="l8.160">     // success here.</span>
<a href="#l8.161"></a><span id="l8.161">     incomingEx = null;</span>
<a href="#l8.162"></a><span id="l8.162">     HostTryToAccountServer(thisTry, resultConfig.incoming);</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-    for (let alternativeTry of alternativeTries)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    {</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+    for (let alternativeTry of alternativeTries) {</span>
<a href="#l8.167"></a><span id="l8.167">       // resultConfig.createNewIncoming(); misses username etc., so copy</span>
<a href="#l8.168"></a><span id="l8.168">       let altServer = deepCopy(resultConfig.incoming);</span>
<a href="#l8.169"></a><span id="l8.169">       HostTryToAccountServer(alternativeTry, altServer);</span>
<a href="#l8.170"></a><span id="l8.170">       assert(resultConfig.incomingAlternatives);</span>
<a href="#l8.171"></a><span id="l8.171">       resultConfig.incomingAlternatives.push(altServer);</span>
<a href="#l8.172"></a><span id="l8.172">     }</span>
<a href="#l8.173"></a><span id="l8.173"> </span>
<a href="#l8.174"></a><span id="l8.174">     progressCallback(resultConfig.incoming.type,</span>
<a href="#l8.175"></a><span id="l8.175">         resultConfig.incoming.hostname, resultConfig.incoming.port,</span>
<a href="#l8.176"></a><span id="l8.176">         resultConfig.incoming.socketType, true, resultConfig);</span>
<a href="#l8.177"></a><span id="l8.177">     incomingDone = true;</span>
<a href="#l8.178"></a><span id="l8.178">     checkDone();</span>
<a href="#l8.179"></a><span id="l8.179">   };</span>
<a href="#l8.180"></a><span id="l8.180"> </span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-  var incomingError = function(ex)</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-  {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+  var incomingError = function(ex) {</span>
<a href="#l8.184"></a><span id="l8.184">     incomingEx = ex;</span>
<a href="#l8.185"></a><span id="l8.185">     checkDone();</span>
<a href="#l8.186"></a><span id="l8.186">     incomingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l8.187"></a><span id="l8.187">     outgoingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l8.188"></a><span id="l8.188">   };</span>
<a href="#l8.189"></a><span id="l8.189"> </span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-  var outgoingError = function(ex)</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-  {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+  var outgoingError = function(ex) {</span>
<a href="#l8.193"></a><span id="l8.193">     outgoingEx = ex;</span>
<a href="#l8.194"></a><span id="l8.194">     checkDone();</span>
<a href="#l8.195"></a><span id="l8.195">     incomingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l8.196"></a><span id="l8.196">     outgoingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l8.197"></a><span id="l8.197">   };</span>
<a href="#l8.198"></a><span id="l8.198"> </span>
<a href="#l8.199"></a><span id="l8.199">   incomingHostDetector = new IncomingHostDetector(progress, incomingSuccess,</span>
<a href="#l8.200"></a><span id="l8.200">                                                   incomingError);</span>
<a href="#l8.201"></a><span id="l8.201">   outgoingHostDetector = new OutgoingHostDetector(progress, outgoingSuccess,</span>
<a href="#l8.202"></a><span id="l8.202">                                                   outgoingError);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-  if (which == &quot;incoming&quot; || which == &quot;both&quot;)</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-  {</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+  if (which == &quot;incoming&quot; || which == &quot;both&quot;) {</span>
<a href="#l8.206"></a><span id="l8.206">     incomingHostDetector.start(resultConfig.incoming.hostname ?</span>
<a href="#l8.207"></a><span id="l8.207">             resultConfig.incoming.hostname : domain,</span>
<a href="#l8.208"></a><span id="l8.208">         !!resultConfig.incoming.hostname, resultConfig.incoming.type,</span>
<a href="#l8.209"></a><span id="l8.209">         resultConfig.incoming.port, resultConfig.incoming.socketType);</span>
<a href="#l8.210"></a><span id="l8.210">   }</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-  if (which == &quot;outgoing&quot; || which == &quot;both&quot;)</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-  {</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  if (which == &quot;outgoing&quot; || which == &quot;both&quot;) {</span>
<a href="#l8.214"></a><span id="l8.214">     outgoingHostDetector.start(resultConfig.outgoing.hostname ?</span>
<a href="#l8.215"></a><span id="l8.215">             resultConfig.outgoing.hostname : domain,</span>
<a href="#l8.216"></a><span id="l8.216">         !!resultConfig.outgoing.hostname, &quot;smtp&quot;,</span>
<a href="#l8.217"></a><span id="l8.217">         resultConfig.outgoing.port, resultConfig.outgoing.socketType);</span>
<a href="#l8.218"></a><span id="l8.218">   }</span>
<a href="#l8.219"></a><span id="l8.219"> </span>
<a href="#l8.220"></a><span id="l8.220">   return new GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l8.221"></a><span id="l8.221">                             updateConfig);</span>
<a href="#l8.222"></a><span id="l8.222"> }</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224"> function GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-                        updateConfig)</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-{</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+                        updateConfig) {</span>
<a href="#l8.228"></a><span id="l8.228">   Abortable.call(this);</span>
<a href="#l8.229"></a><span id="l8.229">   this._incomingHostDetector = incomingHostDetector;</span>
<a href="#l8.230"></a><span id="l8.230">   this._outgoingHostDetector = outgoingHostDetector;</span>
<a href="#l8.231"></a><span id="l8.231">   this._updateConfig = updateConfig;</span>
<a href="#l8.232"></a><span id="l8.232"> }</span>
<a href="#l8.233"></a><span id="l8.233"> GuessAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l8.234"></a><span id="l8.234"> GuessAbortable.prototype.constructor = GuessAbortable;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-GuessAbortable.prototype.cancel = function(ex)</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-{</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+GuessAbortable.prototype.cancel = function(ex) {</span>
<a href="#l8.238"></a><span id="l8.238">   this._incomingHostDetector.cancel(ex);</span>
<a href="#l8.239"></a><span id="l8.239">   this._outgoingHostDetector.cancel(ex);</span>
<a href="#l8.240"></a><span id="l8.240"> };</span>
<a href="#l8.241"></a><span id="l8.241"> </span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-//////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+// ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.244"></a><span id="l8.244"> // Implementation</span>
<a href="#l8.245"></a><span id="l8.245"> //</span>
<a href="#l8.246"></a><span id="l8.246"> // Objects, functions and constants that follow are not to be used outside</span>
<a href="#l8.247"></a><span id="l8.247"> // this file.</span>
<a href="#l8.248"></a><span id="l8.248"> </span>
<a href="#l8.249"></a><span id="l8.249"> var kNotTried = 0;</span>
<a href="#l8.250"></a><span id="l8.250"> var kOngoing = 1;</span>
<a href="#l8.251"></a><span id="l8.251"> var kFailed = 2;</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineat">@@ -293,92 +273,87 @@ var kSuccess = 3;</span>
<a href="#l8.253"></a><span id="l8.253"> /**</span>
<a href="#l8.254"></a><span id="l8.254">  * Internal object holding one server that we should try or did try.</span>
<a href="#l8.255"></a><span id="l8.255">  * Used as |thisTry|.</span>
<a href="#l8.256"></a><span id="l8.256">  *</span>
<a href="#l8.257"></a><span id="l8.257">  * Note: The consts it uses for protocol and ssl are defined towards the end</span>
<a href="#l8.258"></a><span id="l8.258">  * of this file and not the same as those used in AccountConfig (type,</span>
<a href="#l8.259"></a><span id="l8.259">  * socketType). (fix this)</span>
<a href="#l8.260"></a><span id="l8.260">  */</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-function HostTry()</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-{</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+function HostTry() {</span>
<a href="#l8.264"></a><span id="l8.264"> }</span>
<a href="#l8.265"></a><span id="l8.265"> HostTry.prototype =</span>
<a href="#l8.266"></a><span id="l8.266"> {</span>
<a href="#l8.267"></a><span id="l8.267">   // IMAP, POP or SMTP</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-  protocol : UNKNOWN,</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  protocol: UNKNOWN,</span>
<a href="#l8.270"></a><span id="l8.270">   // {String}</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-  hostname : undefined,</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+  hostname: undefined,</span>
<a href="#l8.273"></a><span id="l8.273">   // {Integer}</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-  port : undefined,</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+  port: undefined,</span>
<a href="#l8.276"></a><span id="l8.276">   // NONE, SSL or TLS</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-  ssl : UNKNOWN,</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  ssl: UNKNOWN,</span>
<a href="#l8.279"></a><span id="l8.279">   // {String} what to send to server</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-  commands : null,</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+  commands: null,</span>
<a href="#l8.282"></a><span id="l8.282">   // {Integer-enum} kNotTried, kOngoing, kFailed or kSuccess</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-  status : kNotTried,</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+  status: kNotTried,</span>
<a href="#l8.285"></a><span id="l8.285">   // {Abortable} allows to cancel the socket comm</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-  abortable : null,</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+  abortable: null,</span>
<a href="#l8.288"></a><span id="l8.288"> </span>
<a href="#l8.289"></a><span id="l8.289">   // {Array of {Integer-enum}} @see _advertisesAuthMethods() result</span>
<a href="#l8.290"></a><span id="l8.290">   // Info about the server, from the protocol and SSL chat</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-  authMethods : null,</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+  authMethods: null,</span>
<a href="#l8.293"></a><span id="l8.293">   // {String} Whether the SSL cert is not from a proper CA</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-  selfSignedCert : false,</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  selfSignedCert: false,</span>
<a href="#l8.296"></a><span id="l8.296">   // {String} Which host the SSL cert is made for, if not hostname.</span>
<a href="#l8.297"></a><span id="l8.297">   // If set, this is an SSL error.</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-  targetSite : null,</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  targetSite: null,</span>
<a href="#l8.300"></a><span id="l8.300"> };</span>
<a href="#l8.301"></a><span id="l8.301"> </span>
<a href="#l8.302"></a><span id="l8.302"> /**</span>
<a href="#l8.303"></a><span id="l8.303">  * When the success or errorCallbacks are called to abort the other requests</span>
<a href="#l8.304"></a><span id="l8.304">  * which happened in parallel, this ex is used as param for cancel(), so that</span>
<a href="#l8.305"></a><span id="l8.305">  * the cancel doesn't trigger another callback.</span>
<a href="#l8.306"></a><span id="l8.306">  */</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-function CancelOthersException()</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-{</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+function CancelOthersException() {</span>
<a href="#l8.310"></a><span id="l8.310">   CancelledException.call(this, &quot;we're done, cancelling the other probes&quot;);</span>
<a href="#l8.311"></a><span id="l8.311"> }</span>
<a href="#l8.312"></a><span id="l8.312"> CancelOthersException.prototype = Object.create(CancelledException.prototype);</span>
<a href="#l8.313"></a><span id="l8.313"> CancelOthersException.prototype.constructor = CancelOthersException;</span>
<a href="#l8.314"></a><span id="l8.314"> </span>
<a href="#l8.315"></a><span id="l8.315"> /**</span>
<a href="#l8.316"></a><span id="l8.316">  * @param successCallback {function(result {HostTry}, alts {Array of HostTry})}</span>
<a href="#l8.317"></a><span id="l8.317">  *    Called when the config is OK</span>
<a href="#l8.318"></a><span id="l8.318">  *    |result| is the most preferred server.</span>
<a href="#l8.319"></a><span id="l8.319">  *    |alts| currently exists only for |IncomingHostDetector| and contains</span>
<a href="#l8.320"></a><span id="l8.320">  *    some servers of the other type (POP3 instead of IMAP), if available.</span>
<a href="#l8.321"></a><span id="l8.321">  * @param errorCallback {function(ex)} Called when we could not find a config</span>
<a href="#l8.322"></a><span id="l8.322">  * @param progressCallback { function(server {HostTry}) } Called when we tried</span>
<a href="#l8.323"></a><span id="l8.323">  *    (will try?) a new hostname and port</span>
<a href="#l8.324"></a><span id="l8.324">  */</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-function HostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-{</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+function HostDetector(progressCallback, successCallback, errorCallback) {</span>
<a href="#l8.328"></a><span id="l8.328">   this.mSuccessCallback = successCallback;</span>
<a href="#l8.329"></a><span id="l8.329">   this.mProgressCallback = progressCallback;</span>
<a href="#l8.330"></a><span id="l8.330">   this.mErrorCallback = errorCallback;</span>
<a href="#l8.331"></a><span id="l8.331">   this._cancel = false;</span>
<a href="#l8.332"></a><span id="l8.332">   // {Array of {HostTry}}, ordered by decreasing preference</span>
<a href="#l8.333"></a><span id="l8.333">   this._hostsToTry = new Array();</span>
<a href="#l8.334"></a><span id="l8.334"> </span>
<a href="#l8.335"></a><span id="l8.335">   // init logging</span>
<a href="#l8.336"></a><span id="l8.336">   this._log = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l8.337"></a><span id="l8.337">   this._log.info(&quot;created host detector&quot;);</span>
<a href="#l8.338"></a><span id="l8.338"> }</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340"> HostDetector.prototype =</span>
<a href="#l8.341"></a><span id="l8.341"> {</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-  cancel : function(ex)</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-  {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+  cancel(ex) {</span>
<a href="#l8.345"></a><span id="l8.345">     this._cancel = true;</span>
<a href="#l8.346"></a><span id="l8.346">     // We have to actively stop the network calls, as they may result in</span>
<a href="#l8.347"></a><span id="l8.347">     // callbacks e.g. to the cert handler. If the dialog is gone by the time</span>
<a href="#l8.348"></a><span id="l8.348">     // this happens, the javascript stack is horked.</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-    for (let i = 0; i &lt; this._hostsToTry.length; i++)</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-    {</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+    for (let i = 0; i &lt; this._hostsToTry.length; i++) {</span>
<a href="#l8.352"></a><span id="l8.352">       let thisTry = this._hostsToTry[i]; // {HostTry}</span>
<a href="#l8.353"></a><span id="l8.353">       if (thisTry.abortable)</span>
<a href="#l8.354"></a><span id="l8.354">         thisTry.abortable.cancel(ex);</span>
<a href="#l8.355"></a><span id="l8.355">       thisTry.status = kFailed; // or don't set? Maybe we want to continue.</span>
<a href="#l8.356"></a><span id="l8.356">     }</span>
<a href="#l8.357"></a><span id="l8.357">     if (ex instanceof CancelOthersException)</span>
<a href="#l8.358"></a><span id="l8.358">       return;</span>
<a href="#l8.359"></a><span id="l8.359">     if (!ex)</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineat">@@ -395,23 +370,22 @@ HostDetector.prototype =</span>
<a href="#l8.361"></a><span id="l8.361">    * @param hostIsPrecise {Boolean} (default false)  use only this hostname,</span>
<a href="#l8.362"></a><span id="l8.362">    *     do not guess hostnames.</span>
<a href="#l8.363"></a><span id="l8.363">    * @param type {String-enum}@see AccountConfig type</span>
<a href="#l8.364"></a><span id="l8.364">    *     (Optional. default, 0, undefined, null = guess it)</span>
<a href="#l8.365"></a><span id="l8.365">    * @param port {Integer} (Optional. default, 0, undefined, null = guess it)</span>
<a href="#l8.366"></a><span id="l8.366">    * @param socketType {Integer-enum}@see AccountConfig socketType</span>
<a href="#l8.367"></a><span id="l8.367">    *     (Optional. default, 0, undefined, null = guess it)</span>
<a href="#l8.368"></a><span id="l8.368">    */</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-  start : function(domain, hostIsPrecise, type, port, socketType)</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-  {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+  start(domain, hostIsPrecise, type, port, socketType) {</span>
<a href="#l8.372"></a><span id="l8.372">     domain = domain.replace(/\s*/g, &quot;&quot;); // Remove whitespace</span>
<a href="#l8.373"></a><span id="l8.373">     if (!hostIsPrecise)</span>
<a href="#l8.374"></a><span id="l8.374">       hostIsPrecise = false;</span>
<a href="#l8.375"></a><span id="l8.375">     var protocol = sanitize.translate(type,</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-        { &quot;imap&quot; : IMAP, &quot;pop3&quot; : POP, &quot;smtp&quot; : SMTP }, UNKNOWN);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+        { &quot;imap&quot;: IMAP, &quot;pop3&quot;: POP, &quot;smtp&quot;: SMTP }, UNKNOWN);</span>
<a href="#l8.378"></a><span id="l8.378">     if (!port)</span>
<a href="#l8.379"></a><span id="l8.379">       port = UNKNOWN;</span>
<a href="#l8.380"></a><span id="l8.380">     var ssl = ConvertSocketTypeToSSL(socketType);</span>
<a href="#l8.381"></a><span id="l8.381">     this._cancel = false;</span>
<a href="#l8.382"></a><span id="l8.382">     this._log.info(&quot;doing auto detect for protocol &quot; + protocol +</span>
<a href="#l8.383"></a><span id="l8.383">         &quot;, domain &quot; + domain + &quot;, (exactly: &quot; + hostIsPrecise +</span>
<a href="#l8.384"></a><span id="l8.384">         &quot;), port &quot; + port + &quot;, ssl &quot; + ssl);</span>
<a href="#l8.385"></a><span id="l8.385"> </span>
<a href="#l8.386"></a><span id="l8.386" class="difflineat">@@ -420,49 +394,45 @@ HostDetector.prototype =</span>
<a href="#l8.387"></a><span id="l8.387">     var hostnamesToTry = [];</span>
<a href="#l8.388"></a><span id="l8.388">     // if hostIsPrecise is true, it's because that's what the user input</span>
<a href="#l8.389"></a><span id="l8.389">     // explicitly, and we'll just try it, nothing else.</span>
<a href="#l8.390"></a><span id="l8.390">     if (hostIsPrecise)</span>
<a href="#l8.391"></a><span id="l8.391">       hostnamesToTry.push(domain);</span>
<a href="#l8.392"></a><span id="l8.392">     else</span>
<a href="#l8.393"></a><span id="l8.393">       hostnamesToTry = this._hostnamesToTry(protocol, domain);</span>
<a href="#l8.394"></a><span id="l8.394"> </span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-    for (let i = 0; i &lt; hostnamesToTry.length; i++)</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-    {</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+    for (let i = 0; i &lt; hostnamesToTry.length; i++) {</span>
<a href="#l8.398"></a><span id="l8.398">       let hostname = hostnamesToTry[i];</span>
<a href="#l8.399"></a><span id="l8.399">       let hostEntries = this._portsToTry(hostname, protocol, ssl, port);</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-      for (let j = 0; j &lt; hostEntries.length; j++)</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-      {</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+      for (let j = 0; j &lt; hostEntries.length; j++) {</span>
<a href="#l8.403"></a><span id="l8.403">         let hostTry = hostEntries[j]; // from getHostEntry()</span>
<a href="#l8.404"></a><span id="l8.404">         hostTry.hostname = hostname;</span>
<a href="#l8.405"></a><span id="l8.405">         hostTry.status = kNotTried;</span>
<a href="#l8.406"></a><span id="l8.406">         this._hostsToTry.push(hostTry);</span>
<a href="#l8.407"></a><span id="l8.407">       }</span>
<a href="#l8.408"></a><span id="l8.408">     }</span>
<a href="#l8.409"></a><span id="l8.409"> </span>
<a href="#l8.410"></a><span id="l8.410">     this._hostsToTry = sortTriesByPreference(this._hostsToTry);</span>
<a href="#l8.411"></a><span id="l8.411">     this._tryAll();</span>
<a href="#l8.412"></a><span id="l8.412">   },</span>
<a href="#l8.413"></a><span id="l8.413"> </span>
<a href="#l8.414"></a><span id="l8.414">   // We make all host/port combinations run in parallel, store their</span>
<a href="#l8.415"></a><span id="l8.415">   // results in an array, and as soon as one finishes successfully and all</span>
<a href="#l8.416"></a><span id="l8.416">   // higher-priority ones have failed, we abort all lower-priority ones.</span>
<a href="#l8.417"></a><span id="l8.417"> </span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-  _tryAll : function()</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-  {</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+  _tryAll() {</span>
<a href="#l8.421"></a><span id="l8.421">     if (this._cancel)</span>
<a href="#l8.422"></a><span id="l8.422">       return;</span>
<a href="#l8.423"></a><span id="l8.423">     var me = this;</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-    for (let i = 0; i &lt; this._hostsToTry.length; i++)</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-    {</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+    for (let i = 0; i &lt; this._hostsToTry.length; i++) {</span>
<a href="#l8.427"></a><span id="l8.427">       let thisTry = this._hostsToTry[i]; // {HostTry}</span>
<a href="#l8.428"></a><span id="l8.428">       if (thisTry.status != kNotTried)</span>
<a href="#l8.429"></a><span id="l8.429">         continue;</span>
<a href="#l8.430"></a><span id="l8.430">       this._log.info(&quot;poking at &quot; + thisTry.hostname + &quot; port &quot; +</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-          thisTry.port + &quot; ssl &quot;+ thisTry.ssl + &quot; protocol &quot; +</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+          thisTry.port + &quot; ssl &quot; + thisTry.ssl + &quot; protocol &quot; +</span>
<a href="#l8.433"></a><span id="l8.433">           protocolToString(thisTry.protocol));</span>
<a href="#l8.434"></a><span id="l8.434">       if (i == 0) // showing 50 servers at once is pointless</span>
<a href="#l8.435"></a><span id="l8.435">         this.mProgressCallback(thisTry);</span>
<a href="#l8.436"></a><span id="l8.436"> </span>
<a href="#l8.437"></a><span id="l8.437">       thisTry.abortable = SocketUtil(</span>
<a href="#l8.438"></a><span id="l8.438">           thisTry.hostname, thisTry.port, thisTry.ssl,</span>
<a href="#l8.439"></a><span id="l8.439">           thisTry.commands, TIMEOUT,</span>
<a href="#l8.440"></a><span id="l8.440">           new SSLErrorHandler(thisTry, this._log),</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineat">@@ -486,50 +456,44 @@ HostDetector.prototype =</span>
<a href="#l8.442"></a><span id="l8.442">     }</span>
<a href="#l8.443"></a><span id="l8.443">   },</span>
<a href="#l8.444"></a><span id="l8.444"> </span>
<a href="#l8.445"></a><span id="l8.445">   /**</span>
<a href="#l8.446"></a><span id="l8.446">    * @param thisTry {HostTry}</span>
<a href="#l8.447"></a><span id="l8.447">    * @param wiredata {Array of {String}} what the server returned</span>
<a href="#l8.448"></a><span id="l8.448">    *     in response to our protocol chat</span>
<a href="#l8.449"></a><span id="l8.449">    */</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-  _processResult : function(thisTry, wiredata)</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-  {</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-    if (thisTry._gotCertError)</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-    {</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-      if (thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_MISMATCH)</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-      {</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+  _processResult(thisTry, wiredata) {</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+    if (thisTry._gotCertError) {</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+      if (thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_MISMATCH) {</span>
<a href="#l8.459"></a><span id="l8.459">         thisTry._gotCertError = 0;</span>
<a href="#l8.460"></a><span id="l8.460">         thisTry.status = kFailed;</span>
<a href="#l8.461"></a><span id="l8.461">         return;</span>
<a href="#l8.462"></a><span id="l8.462">       }</span>
<a href="#l8.463"></a><span id="l8.463"> </span>
<a href="#l8.464"></a><span id="l8.464">       if (thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_UNTRUSTED ||</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-          thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_TIME)</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-      {</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+          thisTry._gotCertError == Ci.nsICertOverrideService.ERROR_TIME) {</span>
<a href="#l8.468"></a><span id="l8.468">         this._log.info(&quot;TRYING AGAIN, hopefully with exception recorded&quot;);</span>
<a href="#l8.469"></a><span id="l8.469">         thisTry._gotCertError = 0;</span>
<a href="#l8.470"></a><span id="l8.470">         thisTry.selfSignedCert = true; // _next_ run gets this exception</span>
<a href="#l8.471"></a><span id="l8.471">         thisTry.status = kNotTried; // try again (with exception)</span>
<a href="#l8.472"></a><span id="l8.472">         this._tryAll();</span>
<a href="#l8.473"></a><span id="l8.473">         return;</span>
<a href="#l8.474"></a><span id="l8.474">       }</span>
<a href="#l8.475"></a><span id="l8.475">     }</span>
<a href="#l8.476"></a><span id="l8.476"> </span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-    if (wiredata == null || wiredata === undefined)</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    {</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+    if (wiredata == null || wiredata === undefined) {</span>
<a href="#l8.480"></a><span id="l8.480">       this._log.info(&quot;no data&quot;);</span>
<a href="#l8.481"></a><span id="l8.481">       thisTry.status = kFailed;</span>
<a href="#l8.482"></a><span id="l8.482">       return;</span>
<a href="#l8.483"></a><span id="l8.483">     }</span>
<a href="#l8.484"></a><span id="l8.484">     this._log.info(&quot;wiredata: &quot; + wiredata.join(&quot;&quot;));</span>
<a href="#l8.485"></a><span id="l8.485">     thisTry.authMethods =</span>
<a href="#l8.486"></a><span id="l8.486">         this._advertisesAuthMethods(thisTry.protocol, wiredata);</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-    if (thisTry.ssl == TLS &amp;&amp; !this._hasTLS(thisTry, wiredata))</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-    {</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+    if (thisTry.ssl == TLS &amp;&amp; !this._hasTLS(thisTry, wiredata)) {</span>
<a href="#l8.490"></a><span id="l8.490">       this._log.info(&quot;STARTTLS wanted, but not offered&quot;);</span>
<a href="#l8.491"></a><span id="l8.491">       thisTry.status = kFailed;</span>
<a href="#l8.492"></a><span id="l8.492">       return;</span>
<a href="#l8.493"></a><span id="l8.493">     }</span>
<a href="#l8.494"></a><span id="l8.494">     this._log.info(&quot;success with &quot; + thisTry.hostname + &quot;:&quot; +</span>
<a href="#l8.495"></a><span id="l8.495">         thisTry.port + &quot; &quot; + protocolToString(thisTry.protocol) +</span>
<a href="#l8.496"></a><span id="l8.496">         &quot; ssl &quot; + thisTry.ssl +</span>
<a href="#l8.497"></a><span id="l8.497">         (thisTry.selfSignedCert ? &quot; (selfSignedCert)&quot; : &quot;&quot;));</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineat">@@ -542,50 +506,42 @@ HostDetector.prototype =</span>
<a href="#l8.499"></a><span id="l8.499">       // isn't covered by that temporariness.</span>
<a href="#l8.500"></a><span id="l8.500">       this._log.info(&quot;clearing validity override for &quot; + thisTry.hostname);</span>
<a href="#l8.501"></a><span id="l8.501">       Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l8.502"></a><span id="l8.502">         .getService(Ci.nsICertOverrideService)</span>
<a href="#l8.503"></a><span id="l8.503">         .clearValidityOverride(thisTry.hostname, thisTry.port);</span>
<a href="#l8.504"></a><span id="l8.504">     }</span>
<a href="#l8.505"></a><span id="l8.505">   },</span>
<a href="#l8.506"></a><span id="l8.506"> </span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-  _checkFinished : function()</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-  {</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+  _checkFinished() {</span>
<a href="#l8.510"></a><span id="l8.510">     var successfulTry = null;</span>
<a href="#l8.511"></a><span id="l8.511">     var successfulTryAlternative = null; // POP3</span>
<a href="#l8.512"></a><span id="l8.512">     var unfinishedBusiness = false;</span>
<a href="#l8.513"></a><span id="l8.513">     // this._hostsToTry is ordered by decreasing preference</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-    for (let i = 0; i &lt; this._hostsToTry.length; i++)</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-    {</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+    for (let i = 0; i &lt; this._hostsToTry.length; i++) {</span>
<a href="#l8.517"></a><span id="l8.517">       let thisTry = this._hostsToTry[i];</span>
<a href="#l8.518"></a><span id="l8.518">       if (thisTry.status == kNotTried || thisTry.status == kOngoing)</span>
<a href="#l8.519"></a><span id="l8.519">         unfinishedBusiness = true;</span>
<a href="#l8.520"></a><span id="l8.520">       // thisTry is good, and all higher preference tries failed, so use this</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-      else if (thisTry.status == kSuccess &amp;&amp; !unfinishedBusiness)</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-      {</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-        if (!successfulTry)</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-        {</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+      else if (thisTry.status == kSuccess &amp;&amp; !unfinishedBusiness) {</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+        if (!successfulTry) {</span>
<a href="#l8.527"></a><span id="l8.527">           successfulTry = thisTry;</span>
<a href="#l8.528"></a><span id="l8.528">           if (successfulTry.protocol == SMTP)</span>
<a href="#l8.529"></a><span id="l8.529">             break;</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-        }</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-        else if (successfulTry.protocol != thisTry.protocol)</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-        {</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+        } else if (successfulTry.protocol != thisTry.protocol) {</span>
<a href="#l8.534"></a><span id="l8.534">           successfulTryAlternative = thisTry;</span>
<a href="#l8.535"></a><span id="l8.535">           break;</span>
<a href="#l8.536"></a><span id="l8.536">         }</span>
<a href="#l8.537"></a><span id="l8.537">       }</span>
<a href="#l8.538"></a><span id="l8.538">     }</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-    if (successfulTry &amp;&amp; (successfulTryAlternative || !unfinishedBusiness))</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-    {</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    if (successfulTry &amp;&amp; (successfulTryAlternative || !unfinishedBusiness)) {</span>
<a href="#l8.542"></a><span id="l8.542">       this.mSuccessCallback(successfulTry,</span>
<a href="#l8.543"></a><span id="l8.543">           successfulTryAlternative ? [ successfulTryAlternative ] : []);</span>
<a href="#l8.544"></a><span id="l8.544">       this.cancel(new CancelOthersException());</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-    }</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-    else if (!unfinishedBusiness) // all failed</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+    } else if (!unfinishedBusiness) // all failed</span>
<a href="#l8.548"></a><span id="l8.548">     {</span>
<a href="#l8.549"></a><span id="l8.549">       this._log.info(&quot;ran out of options&quot;);</span>
<a href="#l8.550"></a><span id="l8.550">       var errorMsg = getStringBundle(</span>
<a href="#l8.551"></a><span id="l8.551">           &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l8.552"></a><span id="l8.552">           .GetStringFromName(&quot;cannot_find_server.error&quot;);</span>
<a href="#l8.553"></a><span id="l8.553">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l8.554"></a><span id="l8.554">       // no need to cancel, all failed</span>
<a href="#l8.555"></a><span id="l8.555">     }</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineat">@@ -600,18 +556,17 @@ HostDetector.prototype =</span>
<a href="#l8.557"></a><span id="l8.557">    * @param protocol {Integer-enum} IMAP, POP or SMTP</span>
<a href="#l8.558"></a><span id="l8.558">    * @param capaResponse {Array of {String}} on the wire data</span>
<a href="#l8.559"></a><span id="l8.559">    *     that the server returned. May be the full exchange or just capa.</span>
<a href="#l8.560"></a><span id="l8.560">    * @returns {Array of {Integer-enum} values for AccountConfig.incoming.auth</span>
<a href="#l8.561"></a><span id="l8.561">    *     (or outgoing), in decreasing order of preference.</span>
<a href="#l8.562"></a><span id="l8.562">    *     E.g. [ 5, 4 ] for a server that supports only Kerberos and</span>
<a href="#l8.563"></a><span id="l8.563">    *     encrypted passwords.</span>
<a href="#l8.564"></a><span id="l8.564">    */</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-  _advertisesAuthMethods : function(protocol, capaResponse)</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-  {</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+  _advertisesAuthMethods(protocol, capaResponse) {</span>
<a href="#l8.568"></a><span id="l8.568">     // for imap, capabilities include e.g.:</span>
<a href="#l8.569"></a><span id="l8.569">     // &quot;AUTH=CRAM-MD5&quot;, &quot;AUTH=NTLM&quot;, &quot;AUTH=GSSAPI&quot;, &quot;AUTH=MSN&quot;</span>
<a href="#l8.570"></a><span id="l8.570">     // for pop3, the auth mechanisms are returned in capa as the following:</span>
<a href="#l8.571"></a><span id="l8.571">     // &quot;CRAM-MD5&quot;, &quot;NTLM&quot;, &quot;MSN&quot;, &quot;GSSAPI&quot;</span>
<a href="#l8.572"></a><span id="l8.572">     // For smtp, EHLO will return AUTH and then a list of the</span>
<a href="#l8.573"></a><span id="l8.573">     // mechanism(s) supported, e.g.,</span>
<a href="#l8.574"></a><span id="l8.574">     // AUTH LOGIN NTLM MSN CRAM-MD5 GSSAPI</span>
<a href="#l8.575"></a><span id="l8.575">     var result = new Array();</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineat">@@ -632,216 +587,201 @@ HostDetector.prototype =</span>
<a href="#l8.577"></a><span id="l8.577">       result.push(Ci.nsMsgAuthMethod.passwordEncrypted);</span>
<a href="#l8.578"></a><span id="l8.578">     if (new RegExp(prefix + &quot;(NTLM|MSN)&quot;).test(line))</span>
<a href="#l8.579"></a><span id="l8.579">       result.push(Ci.nsMsgAuthMethod.NTLM);</span>
<a href="#l8.580"></a><span id="l8.580">     if (protocol != IMAP || !line.includes(&quot;LOGINDISABLED&quot;))</span>
<a href="#l8.581"></a><span id="l8.581">       result.push(Ci.nsMsgAuthMethod.passwordCleartext);</span>
<a href="#l8.582"></a><span id="l8.582">     return result;</span>
<a href="#l8.583"></a><span id="l8.583">   },</span>
<a href="#l8.584"></a><span id="l8.584"> </span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-  _hasTLS : function(thisTry, wiredata)</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-  {</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+  _hasTLS(thisTry, wiredata) {</span>
<a href="#l8.588"></a><span id="l8.588">     var capa = thisTry.protocol == POP ? &quot;STLS&quot; : &quot;STARTTLS&quot;;</span>
<a href="#l8.589"></a><span id="l8.589">     return thisTry.ssl == TLS &amp;&amp;</span>
<a href="#l8.590"></a><span id="l8.590">         wiredata.join(&quot;&quot;).toUpperCase().includes(capa);</span>
<a href="#l8.591"></a><span id="l8.591">   },</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-}</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+};</span>
<a href="#l8.594"></a><span id="l8.594"> </span>
<a href="#l8.595"></a><span id="l8.595"> /**</span>
<a href="#l8.596"></a><span id="l8.596">  * @param authMethods @see return value of _advertisesAuthMethods()</span>
<a href="#l8.597"></a><span id="l8.597">  *    Note: the returned auth method will be removed from the array.</span>
<a href="#l8.598"></a><span id="l8.598">  * @return one of them, the preferred one</span>
<a href="#l8.599"></a><span id="l8.599">  * Note: this might be Kerberos, which might not actually work,</span>
<a href="#l8.600"></a><span id="l8.600">  * so you might need to try the others, too.</span>
<a href="#l8.601"></a><span id="l8.601">  */</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-function chooseBestAuthMethod(authMethods)</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-{</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+function chooseBestAuthMethod(authMethods) {</span>
<a href="#l8.605"></a><span id="l8.605">   if (!authMethods || !authMethods.length)</span>
<a href="#l8.606"></a><span id="l8.606">     return Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l8.607"></a><span id="l8.607">   return authMethods.shift(); // take first (= most preferred)</span>
<a href="#l8.608"></a><span id="l8.608"> }</span>
<a href="#l8.609"></a><span id="l8.609"> </span>
<a href="#l8.610"></a><span id="l8.610"> </span>
<a href="#l8.611"></a><span id="l8.611"> function IncomingHostDetector(</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-  progressCallback, successCallback, errorCallback)</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-{</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+  progressCallback, successCallback, errorCallback) {</span>
<a href="#l8.615"></a><span id="l8.615">   HostDetector.call(this, progressCallback, successCallback, errorCallback);</span>
<a href="#l8.616"></a><span id="l8.616"> }</span>
<a href="#l8.617"></a><span id="l8.617"> IncomingHostDetector.prototype =</span>
<a href="#l8.618"></a><span id="l8.618"> {</span>
<a href="#l8.619"></a><span id="l8.619">   __proto__: HostDetector.prototype,</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-  _hostnamesToTry : function(protocol, domain)</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-  {</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+  _hostnamesToTry(protocol, domain) {</span>
<a href="#l8.623"></a><span id="l8.623">     var hostnamesToTry = [];</span>
<a href="#l8.624"></a><span id="l8.624">     if (protocol != POP)</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-      hostnamesToTry.push(&quot;imap.&quot; +  domain);</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-    if (protocol != IMAP)</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-    {</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-      hostnamesToTry.push(&quot;pop3.&quot; +  domain);</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-      hostnamesToTry.push(&quot;pop.&quot; +  domain);</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+      hostnamesToTry.push(&quot;imap.&quot; + domain);</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+    if (protocol != IMAP) {</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+      hostnamesToTry.push(&quot;pop3.&quot; + domain);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+      hostnamesToTry.push(&quot;pop.&quot; + domain);</span>
<a href="#l8.634"></a><span id="l8.634">     }</span>
<a href="#l8.635"></a><span id="l8.635">     hostnamesToTry.push(&quot;mail.&quot; + domain);</span>
<a href="#l8.636"></a><span id="l8.636">     hostnamesToTry.push(domain);</span>
<a href="#l8.637"></a><span id="l8.637">     return hostnamesToTry;</span>
<a href="#l8.638"></a><span id="l8.638">   },</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-  _portsToTry : getIncomingTryOrder,</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-}</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+  _portsToTry: getIncomingTryOrder,</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+};</span>
<a href="#l8.643"></a><span id="l8.643"> </span>
<a href="#l8.644"></a><span id="l8.644"> function OutgoingHostDetector(</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-  progressCallback, successCallback, errorCallback)</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-{</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+  progressCallback, successCallback, errorCallback) {</span>
<a href="#l8.648"></a><span id="l8.648">   HostDetector.call(this, progressCallback, successCallback, errorCallback);</span>
<a href="#l8.649"></a><span id="l8.649"> }</span>
<a href="#l8.650"></a><span id="l8.650"> OutgoingHostDetector.prototype =</span>
<a href="#l8.651"></a><span id="l8.651"> {</span>
<a href="#l8.652"></a><span id="l8.652">   __proto__: HostDetector.prototype,</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-  _hostnamesToTry : function(protocol, domain)</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-  {</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+  _hostnamesToTry(protocol, domain) {</span>
<a href="#l8.656"></a><span id="l8.656">     var hostnamesToTry = [];</span>
<a href="#l8.657"></a><span id="l8.657">     hostnamesToTry.push(&quot;smtp.&quot; + domain);</span>
<a href="#l8.658"></a><span id="l8.658">     hostnamesToTry.push(&quot;mail.&quot; + domain);</span>
<a href="#l8.659"></a><span id="l8.659">     hostnamesToTry.push(domain);</span>
<a href="#l8.660"></a><span id="l8.660">     return hostnamesToTry;</span>
<a href="#l8.661"></a><span id="l8.661">   },</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-  _portsToTry : getOutgoingTryOrder,</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-}</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+  _portsToTry: getOutgoingTryOrder,</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+};</span>
<a href="#l8.666"></a><span id="l8.666"> </span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-//////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+// ////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.669"></a><span id="l8.669"> // Encode protocol ports and order of preference</span>
<a href="#l8.670"></a><span id="l8.670"> </span>
<a href="#l8.671"></a><span id="l8.671"> // Protocol Types</span>
<a href="#l8.672"></a><span id="l8.672"> var UNKNOWN = -1;</span>
<a href="#l8.673"></a><span id="l8.673"> var IMAP = 0;</span>
<a href="#l8.674"></a><span id="l8.674"> var POP = 1;</span>
<a href="#l8.675"></a><span id="l8.675"> var SMTP = 2;</span>
<a href="#l8.676"></a><span id="l8.676"> // Security Types</span>
<a href="#l8.677"></a><span id="l8.677"> var NONE = 0; // no encryption</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-//1 would be &quot;TLS if available&quot;</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+// 1 would be &quot;TLS if available&quot;</span>
<a href="#l8.680"></a><span id="l8.680"> var TLS = 2; // STARTTLS</span>
<a href="#l8.681"></a><span id="l8.681"> var SSL = 3; // SSL / TLS</span>
<a href="#l8.682"></a><span id="l8.682"> </span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-var IMAP_PORTS = {}</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+var IMAP_PORTS = {};</span>
<a href="#l8.685"></a><span id="l8.685"> IMAP_PORTS[NONE] = 143;</span>
<a href="#l8.686"></a><span id="l8.686"> IMAP_PORTS[TLS] = 143;</span>
<a href="#l8.687"></a><span id="l8.687"> IMAP_PORTS[SSL] = 993;</span>
<a href="#l8.688"></a><span id="l8.688"> </span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-var POP_PORTS = {}</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+var POP_PORTS = {};</span>
<a href="#l8.691"></a><span id="l8.691"> POP_PORTS[NONE] = 110;</span>
<a href="#l8.692"></a><span id="l8.692"> POP_PORTS[TLS] = 110;</span>
<a href="#l8.693"></a><span id="l8.693"> POP_PORTS[SSL] = 995;</span>
<a href="#l8.694"></a><span id="l8.694"> </span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-var SMTP_PORTS = {}</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+var SMTP_PORTS = {};</span>
<a href="#l8.697"></a><span id="l8.697"> SMTP_PORTS[NONE] = 587;</span>
<a href="#l8.698"></a><span id="l8.698"> SMTP_PORTS[TLS] = 587;</span>
<a href="#l8.699"></a><span id="l8.699"> SMTP_PORTS[SSL] = 465;</span>
<a href="#l8.700"></a><span id="l8.700"> </span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-var CMDS = {}</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+var CMDS = {};</span>
<a href="#l8.703"></a><span id="l8.703"> CMDS[IMAP] = [&quot;1 CAPABILITY\r\n&quot;, &quot;2 LOGOUT\r\n&quot;];</span>
<a href="#l8.704"></a><span id="l8.704"> CMDS[POP] = [&quot;CAPA\r\n&quot;, &quot;QUIT\r\n&quot;];</span>
<a href="#l8.705"></a><span id="l8.705"> CMDS[SMTP] = [&quot;EHLO we-guess.mozilla.org\r\n&quot;, &quot;QUIT\r\n&quot;];</span>
<a href="#l8.706"></a><span id="l8.706"> </span>
<a href="#l8.707"></a><span id="l8.707"> /**</span>
<a href="#l8.708"></a><span id="l8.708">  * Sort by preference of SSL, IMAP etc.</span>
<a href="#l8.709"></a><span id="l8.709">  * @param tries {Array of {HostTry}}</span>
<a href="#l8.710"></a><span id="l8.710">  * @returns {Array of {HostTry}}</span>
<a href="#l8.711"></a><span id="l8.711">  */</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-function sortTriesByPreference(tries)</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-{</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-  return tries.sort(function __sortByPreference(a, b)</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-  {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+function sortTriesByPreference(tries) {</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+  return tries.sort(function __sortByPreference(a, b) {</span>
<a href="#l8.718"></a><span id="l8.718">     // -1 = a is better; 1 = b is better; 0 = equal</span>
<a href="#l8.719"></a><span id="l8.719">     // Prefer SSL/TLS above all else</span>
<a href="#l8.720"></a><span id="l8.720">     if (a.ssl != NONE &amp;&amp; b.ssl == NONE)</span>
<a href="#l8.721"></a><span id="l8.721">       return -1;</span>
<a href="#l8.722"></a><span id="l8.722">     if (b.ssl != NONE &amp;&amp; a.ssl == NONE)</span>
<a href="#l8.723"></a><span id="l8.723">       return 1;</span>
<a href="#l8.724"></a><span id="l8.724">     // Prefer IMAP over POP</span>
<a href="#l8.725"></a><span id="l8.725">     if (a.protocol == IMAP &amp;&amp; b.protocol == POP)</span>
<a href="#l8.726"></a><span id="l8.726">       return -1;</span>
<a href="#l8.727"></a><span id="l8.727">     if (b.protocol == IMAP &amp;&amp; a.protocol == POP)</span>
<a href="#l8.728"></a><span id="l8.728">       return 1;</span>
<a href="#l8.729"></a><span id="l8.729">     // For hostnames, leave existing sorting, as in _hostnamesToTry()</span>
<a href="#l8.730"></a><span id="l8.730">     // For ports, leave existing sorting, as in getOutgoingTryOrder()</span>
<a href="#l8.731"></a><span id="l8.731">     return 0;</span>
<a href="#l8.732"></a><span id="l8.732">   });</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-};</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+}</span>
<a href="#l8.735"></a><span id="l8.735"> </span>
<a href="#l8.736"></a><span id="l8.736"> // TODO prefer SSL over STARTTLS,</span>
<a href="#l8.737"></a><span id="l8.737"> // either in sortTriesByPreference or in getIncomingTryOrder() (and outgoing)</span>
<a href="#l8.738"></a><span id="l8.738"> </span>
<a href="#l8.739"></a><span id="l8.739"> /**</span>
<a href="#l8.740"></a><span id="l8.740">  * @returns {Array of {HostTry}}</span>
<a href="#l8.741"></a><span id="l8.741">  */</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-function getIncomingTryOrder(host, protocol, ssl, port)</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-{</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+function getIncomingTryOrder(host, protocol, ssl, port) {</span>
<a href="#l8.745"></a><span id="l8.745">   var lowerCaseHost = host.toLowerCase();</span>
<a href="#l8.746"></a><span id="l8.746"> </span>
<a href="#l8.747"></a><span id="l8.747">   if (protocol == UNKNOWN &amp;&amp;</span>
<a href="#l8.748"></a><span id="l8.748">       (lowerCaseHost.startsWith(&quot;pop.&quot;) || lowerCaseHost.startsWith(&quot;pop3.&quot;)))</span>
<a href="#l8.749"></a><span id="l8.749">     protocol = POP;</span>
<a href="#l8.750"></a><span id="l8.750">   else if (protocol == UNKNOWN &amp;&amp; lowerCaseHost.startsWith(&quot;imap.&quot;))</span>
<a href="#l8.751"></a><span id="l8.751">     protocol = IMAP;</span>
<a href="#l8.752"></a><span id="l8.752"> </span>
<a href="#l8.753"></a><span id="l8.753">   if (protocol != UNKNOWN) {</span>
<a href="#l8.754"></a><span id="l8.754">     if (ssl == UNKNOWN)</span>
<a href="#l8.755"></a><span id="l8.755">       return [getHostEntry(protocol, TLS, port),</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-              //getHostEntry(protocol, SSL, port),</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+              // getHostEntry(protocol, SSL, port),</span>
<a href="#l8.758"></a><span id="l8.758">               getHostEntry(protocol, NONE, port)];</span>
<a href="#l8.759"></a><span id="l8.759">     return [getHostEntry(protocol, ssl, port)];</span>
<a href="#l8.760"></a><span id="l8.760">   }</span>
<a href="#l8.761"></a><span id="l8.761">   if (ssl == UNKNOWN)</span>
<a href="#l8.762"></a><span id="l8.762">     return [getHostEntry(IMAP, TLS, port),</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-            //getHostEntry(IMAP, SSL, port),</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+            // getHostEntry(IMAP, SSL, port),</span>
<a href="#l8.765"></a><span id="l8.765">             getHostEntry(POP, TLS, port),</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-            //getHostEntry(POP, SSL, port),</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+            // getHostEntry(POP, SSL, port),</span>
<a href="#l8.768"></a><span id="l8.768">             getHostEntry(IMAP, NONE, port),</span>
<a href="#l8.769"></a><span id="l8.769">             getHostEntry(POP, NONE, port)];</span>
<a href="#l8.770"></a><span id="l8.770">   return [getHostEntry(IMAP, ssl, port),</span>
<a href="#l8.771"></a><span id="l8.771">           getHostEntry(POP, ssl, port)];</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-};</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+}</span>
<a href="#l8.774"></a><span id="l8.774"> </span>
<a href="#l8.775"></a><span id="l8.775"> /**</span>
<a href="#l8.776"></a><span id="l8.776">  * @returns {Array of {HostTry}}</span>
<a href="#l8.777"></a><span id="l8.777">  */</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-function getOutgoingTryOrder(host, protocol, ssl, port)</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-{</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+function getOutgoingTryOrder(host, protocol, ssl, port) {</span>
<a href="#l8.781"></a><span id="l8.781">   assert(protocol == SMTP, &quot;need SMTP as protocol for outgoing&quot;);</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-  if (ssl == UNKNOWN)</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-  {</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+  if (ssl == UNKNOWN) {</span>
<a href="#l8.785"></a><span id="l8.785">     if (port == UNKNOWN)</span>
<a href="#l8.786"></a><span id="l8.786">       // neither SSL nor port known</span>
<a href="#l8.787"></a><span id="l8.787">       return [getHostEntry(SMTP, TLS, UNKNOWN),</span>
<a href="#l8.788"></a><span id="l8.788">               getHostEntry(SMTP, TLS, 25),</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-              //getHostEntry(SMTP, SSL, UNKNOWN),</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+              // getHostEntry(SMTP, SSL, UNKNOWN),</span>
<a href="#l8.791"></a><span id="l8.791">               getHostEntry(SMTP, NONE, UNKNOWN),</span>
<a href="#l8.792"></a><span id="l8.792">               getHostEntry(SMTP, NONE, 25)];</span>
<a href="#l8.793"></a><span id="l8.793">     // port known, SSL not</span>
<a href="#l8.794"></a><span id="l8.794">     return [getHostEntry(SMTP, TLS, port),</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-            //getHostEntry(SMTP, SSL, port),</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+            // getHostEntry(SMTP, SSL, port),</span>
<a href="#l8.797"></a><span id="l8.797">             getHostEntry(SMTP, NONE, port)];</span>
<a href="#l8.798"></a><span id="l8.798">   }</span>
<a href="#l8.799"></a><span id="l8.799">   // SSL known, port not</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-  if (port == UNKNOWN)</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-  {</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+  if (port == UNKNOWN) {</span>
<a href="#l8.803"></a><span id="l8.803">     if (ssl == SSL)</span>
<a href="#l8.804"></a><span id="l8.804">       return [getHostEntry(SMTP, SSL, UNKNOWN)];</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    else // TLS or NONE</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-      return [getHostEntry(SMTP, ssl, UNKNOWN),</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+    return [getHostEntry(SMTP, ssl, UNKNOWN),</span>
<a href="#l8.808"></a><span id="l8.808">               getHostEntry(SMTP, ssl, 25)];</span>
<a href="#l8.809"></a><span id="l8.809">   }</span>
<a href="#l8.810"></a><span id="l8.810">   // SSL and port known</span>
<a href="#l8.811"></a><span id="l8.811">   return [getHostEntry(SMTP, ssl, port)];</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-};</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+}</span>
<a href="#l8.814"></a><span id="l8.814"> </span>
<a href="#l8.815"></a><span id="l8.815"> /**</span>
<a href="#l8.816"></a><span id="l8.816">  * @returns {HostTry} with proper default port and commands,</span>
<a href="#l8.817"></a><span id="l8.817">  *     but without hostname.</span>
<a href="#l8.818"></a><span id="l8.818">  */</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-function getHostEntry(protocol, ssl, port)</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-{</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineplus">+function getHostEntry(protocol, ssl, port) {</span>
<a href="#l8.822"></a><span id="l8.822">   if (!port || port == UNKNOWN) {</span>
<a href="#l8.823"></a><span id="l8.823">     switch (protocol) {</span>
<a href="#l8.824"></a><span id="l8.824">       case POP:</span>
<a href="#l8.825"></a><span id="l8.825">         port = POP_PORTS[ssl];</span>
<a href="#l8.826"></a><span id="l8.826">         break;</span>
<a href="#l8.827"></a><span id="l8.827">       case IMAP:</span>
<a href="#l8.828"></a><span id="l8.828">         port = IMAP_PORTS[ssl];</span>
<a href="#l8.829"></a><span id="l8.829">         break;</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineat">@@ -854,82 +794,77 @@ function getHostEntry(protocol, ssl, por</span>
<a href="#l8.831"></a><span id="l8.831">   }</span>
<a href="#l8.832"></a><span id="l8.832"> </span>
<a href="#l8.833"></a><span id="l8.833">   var r = new HostTry();</span>
<a href="#l8.834"></a><span id="l8.834">   r.protocol = protocol;</span>
<a href="#l8.835"></a><span id="l8.835">   r.ssl = ssl;</span>
<a href="#l8.836"></a><span id="l8.836">   r.port = port;</span>
<a href="#l8.837"></a><span id="l8.837">   r.commands = CMDS[protocol];</span>
<a href="#l8.838"></a><span id="l8.838">   return r;</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-};</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+}</span>
<a href="#l8.841"></a><span id="l8.841"> </span>
<a href="#l8.842"></a><span id="l8.842"> </span>
<a href="#l8.843"></a><span id="l8.843"> // Convert consts from those used here to those from AccountConfig</span>
<a href="#l8.844"></a><span id="l8.844"> // TODO adjust consts to match AccountConfig</span>
<a href="#l8.845"></a><span id="l8.845"> </span>
<a href="#l8.846"></a><span id="l8.846"> // here -&gt; AccountConfig</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-function sslConvertToSocketType(ssl)</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-{</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+function sslConvertToSocketType(ssl) {</span>
<a href="#l8.850"></a><span id="l8.850">   if (ssl == NONE)</span>
<a href="#l8.851"></a><span id="l8.851">     return 1;</span>
<a href="#l8.852"></a><span id="l8.852">   if (ssl == SSL)</span>
<a href="#l8.853"></a><span id="l8.853">     return 2;</span>
<a href="#l8.854"></a><span id="l8.854">   if (ssl == TLS)</span>
<a href="#l8.855"></a><span id="l8.855">     return 3;</span>
<a href="#l8.856"></a><span id="l8.856">   throw new NotReached(&quot;unexpected SSL type&quot;);</span>
<a href="#l8.857"></a><span id="l8.857"> }</span>
<a href="#l8.858"></a><span id="l8.858"> </span>
<a href="#l8.859"></a><span id="l8.859"> // AccountConfig -&gt; here</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-function ConvertSocketTypeToSSL(socketType)</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-{</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+function ConvertSocketTypeToSSL(socketType) {</span>
<a href="#l8.863"></a><span id="l8.863">   if (socketType == 1)</span>
<a href="#l8.864"></a><span id="l8.864">     return NONE;</span>
<a href="#l8.865"></a><span id="l8.865">   if (socketType == 2)</span>
<a href="#l8.866"></a><span id="l8.866">     return SSL;</span>
<a href="#l8.867"></a><span id="l8.867">   if (socketType == 3)</span>
<a href="#l8.868"></a><span id="l8.868">     return TLS;</span>
<a href="#l8.869"></a><span id="l8.869">   return UNKNOWN;</span>
<a href="#l8.870"></a><span id="l8.870"> }</span>
<a href="#l8.871"></a><span id="l8.871"> </span>
<a href="#l8.872"></a><span id="l8.872"> // here -&gt; AccountConfig</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-function protocolToString(type)</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-{</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+function protocolToString(type) {</span>
<a href="#l8.876"></a><span id="l8.876">   if (type == IMAP)</span>
<a href="#l8.877"></a><span id="l8.877">     return &quot;imap&quot;;</span>
<a href="#l8.878"></a><span id="l8.878">   if (type == POP)</span>
<a href="#l8.879"></a><span id="l8.879">     return &quot;pop3&quot;;</span>
<a href="#l8.880"></a><span id="l8.880">   if (type == SMTP)</span>
<a href="#l8.881"></a><span id="l8.881">     return &quot;smtp&quot;;</span>
<a href="#l8.882"></a><span id="l8.882">   throw new NotReached(&quot;unexpected protocol&quot;);</span>
<a href="#l8.883"></a><span id="l8.883"> }</span>
<a href="#l8.884"></a><span id="l8.884"> </span>
<a href="#l8.885"></a><span id="l8.885"> </span>
<a href="#l8.886"></a><span id="l8.886"> </span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-/////////////////////////////////////////////////////////</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineplus">+// ///////////////////////////////////////////////////////</span>
<a href="#l8.889"></a><span id="l8.889"> // SSL cert error handler</span>
<a href="#l8.890"></a><span id="l8.890"> </span>
<a href="#l8.891"></a><span id="l8.891"> /**</span>
<a href="#l8.892"></a><span id="l8.892">  * Called by MyBadCertHandler.js, which called by PSM</span>
<a href="#l8.893"></a><span id="l8.893">  * to tell us about SSL certificate errors.</span>
<a href="#l8.894"></a><span id="l8.894">  * @param thisTry {HostTry}</span>
<a href="#l8.895"></a><span id="l8.895">  * @param logger {Log4Moz logger}</span>
<a href="#l8.896"></a><span id="l8.896">  */</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-function SSLErrorHandler(thisTry, logger)</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-{</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+function SSLErrorHandler(thisTry, logger) {</span>
<a href="#l8.900"></a><span id="l8.900">   this._try = thisTry;</span>
<a href="#l8.901"></a><span id="l8.901">   this._log = logger;</span>
<a href="#l8.902"></a><span id="l8.902">   // _ gotCertError will be set to an error code (one of those defined in</span>
<a href="#l8.903"></a><span id="l8.903">   // nsICertOverrideService)</span>
<a href="#l8.904"></a><span id="l8.904">   this._gotCertError = 0;</span>
<a href="#l8.905"></a><span id="l8.905"> }</span>
<a href="#l8.906"></a><span id="l8.906"> SSLErrorHandler.prototype =</span>
<a href="#l8.907"></a><span id="l8.907"> {</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-  processCertError : function(socketInfo, status, targetSite)</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-  {</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-    this._log.error(&quot;Got Cert error for &quot;+ targetSite);</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+  processCertError(socketInfo, status, targetSite) {</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+    this._log.error(&quot;Got Cert error for &quot; + targetSite);</span>
<a href="#l8.913"></a><span id="l8.913"> </span>
<a href="#l8.914"></a><span id="l8.914">     if (!status)</span>
<a href="#l8.915"></a><span id="l8.915">       return true;</span>
<a href="#l8.916"></a><span id="l8.916"> </span>
<a href="#l8.917"></a><span id="l8.917">     let cert = status.QueryInterface(Ci.nsISSLStatus).serverCert;</span>
<a href="#l8.918"></a><span id="l8.918">     let flags = 0;</span>
<a href="#l8.919"></a><span id="l8.919"> </span>
<a href="#l8.920"></a><span id="l8.920">     let parts = targetSite.split(&quot;:&quot;);</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineat">@@ -960,26 +895,23 @@ SSLErrorHandler.prototype =</span>
<a href="#l8.922"></a><span id="l8.922">      * What makes it dangerous is that we (!) propose the server to the user,</span>
<a href="#l8.923"></a><span id="l8.923">      * and he cannot judge whether imap.gmailservers.com is correct or not,</span>
<a href="#l8.924"></a><span id="l8.924">      * and he will likely approve it.</span>
<a href="#l8.925"></a><span id="l8.925">      */</span>
<a href="#l8.926"></a><span id="l8.926"> </span>
<a href="#l8.927"></a><span id="l8.927">     if (status.isDomainMismatch) {</span>
<a href="#l8.928"></a><span id="l8.928">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_MISMATCH;</span>
<a href="#l8.929"></a><span id="l8.929">       flags |= Ci.nsICertOverrideService.ERROR_MISMATCH;</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-    }</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-    else if (status.isUntrusted) { // e.g. self-signed</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+    } else if (status.isUntrusted) { // e.g. self-signed</span>
<a href="#l8.933"></a><span id="l8.933">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l8.934"></a><span id="l8.934">       flags |= Ci.nsICertOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-    }</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-    else if (status.isNotValidAtThisTime) {</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+    } else if (status.isNotValidAtThisTime) {</span>
<a href="#l8.938"></a><span id="l8.938">       this._try._gotCertError = Ci.nsICertOverrideService.ERROR_TIME;</span>
<a href="#l8.939"></a><span id="l8.939">       flags |= Ci.nsICertOverrideService.ERROR_TIME;</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-    }</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-    else {</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineplus">+    } else {</span>
<a href="#l8.943"></a><span id="l8.943">       this._try._gotCertError = -1; // other</span>
<a href="#l8.944"></a><span id="l8.944">     }</span>
<a href="#l8.945"></a><span id="l8.945"> </span>
<a href="#l8.946"></a><span id="l8.946">     /* We will add a temporary cert exception here, so that</span>
<a href="#l8.947"></a><span id="l8.947">      * we can continue and connect and try.</span>
<a href="#l8.948"></a><span id="l8.948">      * But we will remove it again as soon as we close the</span>
<a href="#l8.949"></a><span id="l8.949">      * connection, in _processResult().</span>
<a href="#l8.950"></a><span id="l8.950">      * _gotCertError will serve as the marker that we</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineat">@@ -994,21 +926,21 @@ SSLErrorHandler.prototype =</span>
<a href="#l8.952"></a><span id="l8.952">     Cc[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l8.953"></a><span id="l8.953">       .getService(Ci.nsICertOverrideService)</span>
<a href="#l8.954"></a><span id="l8.954">       .rememberValidityOverride(host, port, cert, flags,</span>
<a href="#l8.955"></a><span id="l8.955">         true); // temporary override</span>
<a href="#l8.956"></a><span id="l8.956">     this._log.warn(&quot;!! Overrode bad cert temporarily &quot; + host + &quot; &quot; + port +</span>
<a href="#l8.957"></a><span id="l8.957">                    &quot; flags=&quot; + flags + &quot;\n&quot;);</span>
<a href="#l8.958"></a><span id="l8.958">     return true;</span>
<a href="#l8.959"></a><span id="l8.959">   },</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-}</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+};</span>
<a href="#l8.962"></a><span id="l8.962"> </span>
<a href="#l8.963"></a><span id="l8.963"> </span>
<a href="#l8.964"></a><span id="l8.964"> </span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-//////////////////////////////////////////////////////////////////</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineplus">+// ////////////////////////////////////////////////////////////////</span>
<a href="#l8.967"></a><span id="l8.967"> // Socket Util</span>
<a href="#l8.968"></a><span id="l8.968"> </span>
<a href="#l8.969"></a><span id="l8.969"> </span>
<a href="#l8.970"></a><span id="l8.970"> /**</span>
<a href="#l8.971"></a><span id="l8.971">  * @param hostname {String} The DNS hostname to connect to.</span>
<a href="#l8.972"></a><span id="l8.972">  * @param port {Integer} The numberic port to connect to on the host.</span>
<a href="#l8.973"></a><span id="l8.973">  * @param ssl {Integer} SSL, TLS or NONE</span>
<a href="#l8.974"></a><span id="l8.974">  * @param commands {Array of String}: protocol commands</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineat">@@ -1016,34 +948,31 @@ SSLErrorHandler.prototype =</span>
<a href="#l8.976"></a><span id="l8.976">  * @param timeout {Integer} seconds to wait for a server response, then cancel.</span>
<a href="#l8.977"></a><span id="l8.977">  * @param sslErrorHandler {SSLErrorHandler}</span>
<a href="#l8.978"></a><span id="l8.978">  * @param resultCallback {function(wiredata)} This function will</span>
<a href="#l8.979"></a><span id="l8.979">  *            be called with the result string array from the server</span>
<a href="#l8.980"></a><span id="l8.980">  *            or null if no communication occurred.</span>
<a href="#l8.981"></a><span id="l8.981">  * @param errorCallback {function(e)}</span>
<a href="#l8.982"></a><span id="l8.982">  */</span>
<a href="#l8.983"></a><span id="l8.983"> function SocketUtil(hostname, port, ssl, commands, timeout,</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-                    sslErrorHandler, resultCallback, errorCallback)</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-{</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+                    sslErrorHandler, resultCallback, errorCallback) {</span>
<a href="#l8.987"></a><span id="l8.987">   assert(commands &amp;&amp; commands.length, &quot;need commands&quot;);</span>
<a href="#l8.988"></a><span id="l8.988"> </span>
<a href="#l8.989"></a><span id="l8.989">   var index = 0; // commands[index] is next to send to server</span>
<a href="#l8.990"></a><span id="l8.990">   var initialized = false;</span>
<a href="#l8.991"></a><span id="l8.991">   var aborted = false;</span>
<a href="#l8.992"></a><span id="l8.992"> </span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-  function _error(e)</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-  {</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineplus">+  function _error(e) {</span>
<a href="#l8.996"></a><span id="l8.996">     if (aborted)</span>
<a href="#l8.997"></a><span id="l8.997">       return;</span>
<a href="#l8.998"></a><span id="l8.998">     aborted = true;</span>
<a href="#l8.999"></a><span id="l8.999">     errorCallback(e);</span>
<a href="#l8.1000"></a><span id="l8.1000">   }</span>
<a href="#l8.1001"></a><span id="l8.1001"> </span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-  function timeoutFunc()</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-  {</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+  function timeoutFunc() {</span>
<a href="#l8.1005"></a><span id="l8.1005">     if (!initialized)</span>
<a href="#l8.1006"></a><span id="l8.1006">       _error(&quot;timeout&quot;);</span>
<a href="#l8.1007"></a><span id="l8.1007">   }</span>
<a href="#l8.1008"></a><span id="l8.1008"> </span>
<a href="#l8.1009"></a><span id="l8.1009">   // In case DNS takes too long or does not resolve or another blocking</span>
<a href="#l8.1010"></a><span id="l8.1010">   // issue occurs before the timeout can be set on the socket, this</span>
<a href="#l8.1011"></a><span id="l8.1011">   // ensures that the listener callback will be fired in a timely manner.</span>
<a href="#l8.1012"></a><span id="l8.1012">   // XXX There might to be some clean up needed after the timeout is fired</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineat">@@ -1071,46 +1000,40 @@ function SocketUtil(hostname, port, ssl,</span>
<a href="#l8.1014"></a><span id="l8.1014">   var outstream = transport.openOutputStream(0, 0, 0);</span>
<a href="#l8.1015"></a><span id="l8.1015">   var stream = transport.openInputStream(0, 0, 0);</span>
<a href="#l8.1016"></a><span id="l8.1016">   var instream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l8.1017"></a><span id="l8.1017">       .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l8.1018"></a><span id="l8.1018">   instream.init(stream);</span>
<a href="#l8.1019"></a><span id="l8.1019"> </span>
<a href="#l8.1020"></a><span id="l8.1020">   var dataListener =</span>
<a href="#l8.1021"></a><span id="l8.1021">   {</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-    data : new Array(),</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-    onStartRequest: function(request, context)</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-    {</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineplus">+    data: new Array(),</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineplus">+    onStartRequest(request, context) {</span>
<a href="#l8.1027"></a><span id="l8.1027">       try {</span>
<a href="#l8.1028"></a><span id="l8.1028">         initialized = true;</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-        if (!aborted)</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-        {</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineplus">+        if (!aborted) {</span>
<a href="#l8.1032"></a><span id="l8.1032">           // Send the first request</span>
<a href="#l8.1033"></a><span id="l8.1033">           let outputData = commands[index++];</span>
<a href="#l8.1034"></a><span id="l8.1034">           outstream.write(outputData, outputData.length);</span>
<a href="#l8.1035"></a><span id="l8.1035">         }</span>
<a href="#l8.1036"></a><span id="l8.1036">       } catch (e) { _error(e); }</span>
<a href="#l8.1037"></a><span id="l8.1037">     },</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-    onStopRequest: function(request, context, status)</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-    {</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+    onStopRequest(request, context, status) {</span>
<a href="#l8.1041"></a><span id="l8.1041">       try {</span>
<a href="#l8.1042"></a><span id="l8.1042">         instream.close();</span>
<a href="#l8.1043"></a><span id="l8.1043">         outstream.close();</span>
<a href="#l8.1044"></a><span id="l8.1044">         resultCallback(this.data.length ? this.data : null);</span>
<a href="#l8.1045"></a><span id="l8.1045">       } catch (e) { _error(e); }</span>
<a href="#l8.1046"></a><span id="l8.1046">     },</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-    onDataAvailable: function(request, context, inputStream, offset, count)</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-    {</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineplus">+    onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l8.1050"></a><span id="l8.1050">       try {</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineminus">-        if (!aborted)</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-        {</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineplus">+        if (!aborted) {</span>
<a href="#l8.1054"></a><span id="l8.1054">           let inputData = instream.read(count);</span>
<a href="#l8.1055"></a><span id="l8.1055">           this.data.push(inputData);</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-          if (index &lt; commands.length)</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-          {</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+          if (index &lt; commands.length) {</span>
<a href="#l8.1059"></a><span id="l8.1059">             // Send the next request to the server.</span>
<a href="#l8.1060"></a><span id="l8.1060">             let outputData = commands[index++];</span>
<a href="#l8.1061"></a><span id="l8.1061">             outstream.write(outputData, outputData.length);</span>
<a href="#l8.1062"></a><span id="l8.1062">           }</span>
<a href="#l8.1063"></a><span id="l8.1063">         }</span>
<a href="#l8.1064"></a><span id="l8.1064">       } catch (e) { _error(e); }</span>
<a href="#l8.1065"></a><span id="l8.1065">     }</span>
<a href="#l8.1066"></a><span id="l8.1066">   };</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineat">@@ -1121,25 +1044,23 @@ function SocketUtil(hostname, port, ssl,</span>
<a href="#l8.1068"></a><span id="l8.1068"> </span>
<a href="#l8.1069"></a><span id="l8.1069">     pump.init(stream, 0, 0, false);</span>
<a href="#l8.1070"></a><span id="l8.1070">     pump.asyncRead(dataListener, null);</span>
<a href="#l8.1071"></a><span id="l8.1071">     return new SocketAbortable(transport);</span>
<a href="#l8.1072"></a><span id="l8.1072">   } catch (e) { _error(e); }</span>
<a href="#l8.1073"></a><span id="l8.1073">   return null;</span>
<a href="#l8.1074"></a><span id="l8.1074"> }</span>
<a href="#l8.1075"></a><span id="l8.1075"> </span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-function SocketAbortable(transport)</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-{</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+function SocketAbortable(transport) {</span>
<a href="#l8.1079"></a><span id="l8.1079">   Abortable.call(this);</span>
<a href="#l8.1080"></a><span id="l8.1080">   assert(transport instanceof Ci.nsITransport, &quot;need transport&quot;);</span>
<a href="#l8.1081"></a><span id="l8.1081">   this._transport = transport;</span>
<a href="#l8.1082"></a><span id="l8.1082"> }</span>
<a href="#l8.1083"></a><span id="l8.1083"> SocketAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l8.1084"></a><span id="l8.1084"> SocketAbortable.prototype.constructor = UserCancelledException;</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-SocketAbortable.prototype.cancel = function(ex)</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-{</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineplus">+SocketAbortable.prototype.cancel = function(ex) {</span>
<a href="#l8.1088"></a><span id="l8.1088">   try {</span>
<a href="#l8.1089"></a><span id="l8.1089">     this._transport.close(Cr.NS_ERROR_ABORT);</span>
<a href="#l8.1090"></a><span id="l8.1090">   } catch (e) {</span>
<a href="#l8.1091"></a><span id="l8.1091">     ddump(&quot;canceling socket failed: &quot; + e);</span>
<a href="#l8.1092"></a><span id="l8.1092">   }</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineminus">-}</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineplus">+};</span>
<a href="#l8.1095"></a><span id="l8.1095"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/accountcreation/content/readFromXML.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/accountcreation/content/readFromXML.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -14,43 +14,40 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * The XML format is documented at</span>
<a href="#l9.5"></a><span id="l9.5">  * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l9.6"></a><span id="l9.6">  *</span>
<a href="#l9.7"></a><span id="l9.7">  * @param clientConfigXML {JXON}  The &lt;clientConfig&gt; node.</span>
<a href="#l9.8"></a><span id="l9.8">  * @return AccountConfig   object filled with the data from XML</span>
<a href="#l9.9"></a><span id="l9.9">  */</span>
<a href="#l9.10"></a><span id="l9.10"> ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-function readFromXML(clientConfigXML)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+function readFromXML(clientConfigXML) {</span>
<a href="#l9.15"></a><span id="l9.15">   function array_or_undef(value) {</span>
<a href="#l9.16"></a><span id="l9.16">     return value === undefined ? [] : value;</span>
<a href="#l9.17"></a><span id="l9.17">   }</span>
<a href="#l9.18"></a><span id="l9.18">   var exception;</span>
<a href="#l9.19"></a><span id="l9.19">   if (typeof(clientConfigXML) != &quot;object&quot; ||</span>
<a href="#l9.20"></a><span id="l9.20">       !(&quot;clientConfig&quot; in clientConfigXML) ||</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-      !(&quot;emailProvider&quot; in clientConfigXML.clientConfig))</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+      !(&quot;emailProvider&quot; in clientConfigXML.clientConfig)) {</span>
<a href="#l9.24"></a><span id="l9.24">     dump(&quot;client config xml = &quot; + JSON.stringify(clientConfigXML) + &quot;\n&quot;);</span>
<a href="#l9.25"></a><span id="l9.25">     var stringBundle = getStringBundle(</span>
<a href="#l9.26"></a><span id="l9.26">         &quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l9.27"></a><span id="l9.27">     throw stringBundle.GetStringFromName(&quot;no_emailProvider.error&quot;);</span>
<a href="#l9.28"></a><span id="l9.28">   }</span>
<a href="#l9.29"></a><span id="l9.29">   var xml = clientConfigXML.clientConfig.emailProvider;</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">   var d = new AccountConfig();</span>
<a href="#l9.32"></a><span id="l9.32">   d.source = AccountConfig.kSourceXML;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   d.id = sanitize.hostname(xml[&quot;@id&quot;]);</span>
<a href="#l9.35"></a><span id="l9.35">   d.displayName = d.id;</span>
<a href="#l9.36"></a><span id="l9.36">   try {</span>
<a href="#l9.37"></a><span id="l9.37">     d.displayName = sanitize.label(xml.displayName);</span>
<a href="#l9.38"></a><span id="l9.38">   } catch (e) { logException(e); }</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  for (var domain of xml.$domain)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  for (var domain of xml.$domain) {</span>
<a href="#l9.42"></a><span id="l9.42">     try {</span>
<a href="#l9.43"></a><span id="l9.43">       d.domains.push(sanitize.hostname(domain));</span>
<a href="#l9.44"></a><span id="l9.44">     } catch (e) { logException(e); exception = e; }</span>
<a href="#l9.45"></a><span id="l9.45">   }</span>
<a href="#l9.46"></a><span id="l9.46">   if (d.domains.length == 0)</span>
<a href="#l9.47"></a><span id="l9.47">     throw exception ? exception : &quot;need proper &lt;domain&gt; in XML&quot;;</span>
<a href="#l9.48"></a><span id="l9.48">   exception = null;</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineat">@@ -66,51 +63,48 @@ function readFromXML(clientConfigXML)</span>
<a href="#l9.51"></a><span id="l9.51">       // We need a username even for Kerberos, need it even internally.</span>
<a href="#l9.52"></a><span id="l9.52">       iO.username = sanitize.string(iX.username); // may be a %VARIABLE%</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">       if (&quot;password&quot; in iX) {</span>
<a href="#l9.55"></a><span id="l9.55">         d.rememberPassword = true;</span>
<a href="#l9.56"></a><span id="l9.56">         iO.password = sanitize.string(iX.password);</span>
<a href="#l9.57"></a><span id="l9.57">       }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-      for (let iXsocketType of array_or_undef(iX.$socketType))</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-      {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      for (let iXsocketType of array_or_undef(iX.$socketType)) {</span>
<a href="#l9.62"></a><span id="l9.62">         try {</span>
<a href="#l9.63"></a><span id="l9.63">           iO.socketType = sanitize.translate(iXsocketType,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-              { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+              { plain: 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.66"></a><span id="l9.66">           break; // take first that we support</span>
<a href="#l9.67"></a><span id="l9.67">         } catch (e) { exception = e; }</span>
<a href="#l9.68"></a><span id="l9.68">       }</span>
<a href="#l9.69"></a><span id="l9.69">       if (!iO.socketType)</span>
<a href="#l9.70"></a><span id="l9.70">         throw exception ? exception : &quot;need proper &lt;socketType&gt; in XML&quot;;</span>
<a href="#l9.71"></a><span id="l9.71">       exception = null;</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-      for (let iXauth of array_or_undef(iX.$authentication))</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-      {</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+      for (let iXauth of array_or_undef(iX.$authentication)) {</span>
<a href="#l9.76"></a><span id="l9.76">         try {</span>
<a href="#l9.77"></a><span id="l9.77">           iO.auth = sanitize.translate(iXauth,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-              { &quot;password-cleartext&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+              { &quot;password-cleartext&quot;: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.80"></a><span id="l9.80">                 // @deprecated TODO remove</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-                &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+                &quot;plain&quot;: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+                &quot;password-encrypted&quot;: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.85"></a><span id="l9.85">                 // @deprecated TODO remove</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-                &quot;GSSAPI&quot; : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-                &quot;NTLM&quot; : Ci.nsMsgAuthMethod.NTLM,</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-                &quot;OAuth2&quot; : Ci.nsMsgAuthMethod.OAuth2 });</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+                &quot;secure&quot;: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+                &quot;GSSAPI&quot;: Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                &quot;NTLM&quot;: Ci.nsMsgAuthMethod.NTLM,</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+                &quot;OAuth2&quot;: Ci.nsMsgAuthMethod.OAuth2 });</span>
<a href="#l9.94"></a><span id="l9.94">           break; // take first that we support</span>
<a href="#l9.95"></a><span id="l9.95">         } catch (e) { exception = e; }</span>
<a href="#l9.96"></a><span id="l9.96">       }</span>
<a href="#l9.97"></a><span id="l9.97">       if (!iO.auth)</span>
<a href="#l9.98"></a><span id="l9.98">         throw exception ? exception : &quot;need proper &lt;authentication&gt; in XML&quot;;</span>
<a href="#l9.99"></a><span id="l9.99">       exception = null;</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101">       // defaults are in accountConfig.js</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-      if (iO.type == &quot;pop3&quot; &amp;&amp; &quot;pop3&quot; in iX)</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-      {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+      if (iO.type == &quot;pop3&quot; &amp;&amp; &quot;pop3&quot; in iX) {</span>
<a href="#l9.105"></a><span id="l9.105">         try {</span>
<a href="#l9.106"></a><span id="l9.106">           if (&quot;leaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l9.107"></a><span id="l9.107">             iO.leaveMessagesOnServer =</span>
<a href="#l9.108"></a><span id="l9.108">                 sanitize.boolean(iX.pop3.leaveMessagesOnServer);</span>
<a href="#l9.109"></a><span id="l9.109">           if (&quot;daysToLeaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l9.110"></a><span id="l9.110">             iO.daysToLeaveMessagesOnServer =</span>
<a href="#l9.111"></a><span id="l9.111">                 sanitize.integer(iX.pop3.daysToLeaveMessagesOnServer);</span>
<a href="#l9.112"></a><span id="l9.112">         } catch (e) { logException(e); }</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineat">@@ -132,56 +126,53 @@ function readFromXML(clientConfigXML)</span>
<a href="#l9.114"></a><span id="l9.114">     throw exception ? exception : &quot;Need proper &lt;incomingServer&gt; in XML file&quot;;</span>
<a href="#l9.115"></a><span id="l9.115">   exception = null;</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117">   // outgoing server</span>
<a href="#l9.118"></a><span id="l9.118">   for (let oX of array_or_undef(xml.$outgoingServer)) // input (XML)</span>
<a href="#l9.119"></a><span id="l9.119">   {</span>
<a href="#l9.120"></a><span id="l9.120">     let oO = d.createNewOutgoing(); // output (object)</span>
<a href="#l9.121"></a><span id="l9.121">     try {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-      if (oX[&quot;@type&quot;] != &quot;smtp&quot;)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-      {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+      if (oX[&quot;@type&quot;] != &quot;smtp&quot;) {</span>
<a href="#l9.125"></a><span id="l9.125">         var stringBundle = getStringBundle(</span>
<a href="#l9.126"></a><span id="l9.126">             &quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l9.127"></a><span id="l9.127">         throw stringBundle.GetStringFromName(&quot;outgoing_not_smtp.error&quot;);</span>
<a href="#l9.128"></a><span id="l9.128">       }</span>
<a href="#l9.129"></a><span id="l9.129">       oO.hostname = sanitize.hostname(oX.hostname);</span>
<a href="#l9.130"></a><span id="l9.130">       oO.port = sanitize.integerRange(oX.port, kMinPort, kMaxPort);</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-      for (let oXsocketType of array_or_undef(oX.$socketType))</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-      {</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+      for (let oXsocketType of array_or_undef(oX.$socketType)) {</span>
<a href="#l9.135"></a><span id="l9.135">         try {</span>
<a href="#l9.136"></a><span id="l9.136">           oO.socketType = sanitize.translate(oXsocketType,</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-              { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+              { plain: 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.139"></a><span id="l9.139">           break; // take first that we support</span>
<a href="#l9.140"></a><span id="l9.140">         } catch (e) { exception = e; }</span>
<a href="#l9.141"></a><span id="l9.141">       }</span>
<a href="#l9.142"></a><span id="l9.142">       if (!oO.socketType)</span>
<a href="#l9.143"></a><span id="l9.143">         throw exception ? exception : &quot;need proper &lt;socketType&gt; in XML&quot;;</span>
<a href="#l9.144"></a><span id="l9.144">       exception = null;</span>
<a href="#l9.145"></a><span id="l9.145"> </span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-      for (let oXauth of array_or_undef(oX.$authentication))</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-      {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+      for (let oXauth of array_or_undef(oX.$authentication)) {</span>
<a href="#l9.149"></a><span id="l9.149">         try {</span>
<a href="#l9.150"></a><span id="l9.150">           oO.auth = sanitize.translate(oXauth,</span>
<a href="#l9.151"></a><span id="l9.151">               { // open relay</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-                &quot;none&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+                &quot;none&quot;: Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.154"></a><span id="l9.154">                 // inside ISP or corp network</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-                &quot;client-IP-address&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+                &quot;client-IP-address&quot;: Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.157"></a><span id="l9.157">                 // hope for the best</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-                &quot;smtp-after-pop&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-                &quot;password-cleartext&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+                &quot;smtp-after-pop&quot;: Ci.nsMsgAuthMethod.none,</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+                &quot;password-cleartext&quot;: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.162"></a><span id="l9.162">                 // @deprecated TODO remove</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-                &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+                &quot;plain&quot;: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+                &quot;password-encrypted&quot;: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.167"></a><span id="l9.167">                 // @deprecated TODO remove</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-                &quot;GSSAPI&quot; : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-                &quot;NTLM&quot; : Ci.nsMsgAuthMethod.NTLM,</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-                &quot;OAuth2&quot; : Ci.nsMsgAuthMethod.OAuth2,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+                &quot;secure&quot;: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+                &quot;GSSAPI&quot;: Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+                &quot;NTLM&quot;: Ci.nsMsgAuthMethod.NTLM,</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+                &quot;OAuth2&quot;: Ci.nsMsgAuthMethod.OAuth2,</span>
<a href="#l9.176"></a><span id="l9.176">               });</span>
<a href="#l9.177"></a><span id="l9.177"> </span>
<a href="#l9.178"></a><span id="l9.178">           break; // take first that we support</span>
<a href="#l9.179"></a><span id="l9.179">         } catch (e) { exception = e; }</span>
<a href="#l9.180"></a><span id="l9.180">       }</span>
<a href="#l9.181"></a><span id="l9.181">       if (!oO.auth)</span>
<a href="#l9.182"></a><span id="l9.182">         throw exception ? exception : &quot;need proper &lt;authentication&gt; in XML&quot;;</span>
<a href="#l9.183"></a><span id="l9.183">       exception = null;</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineat">@@ -215,24 +206,23 @@ function readFromXML(clientConfigXML)</span>
<a href="#l9.185"></a><span id="l9.185">     } catch (e) { logException(e); exception = e; }</span>
<a href="#l9.186"></a><span id="l9.186">   }</span>
<a href="#l9.187"></a><span id="l9.187">   if (!d.outgoing.hostname)</span>
<a href="#l9.188"></a><span id="l9.188">     // throw exception for last server</span>
<a href="#l9.189"></a><span id="l9.189">     throw exception ? exception : &quot;Need proper &lt;outgoingServer&gt; in XML file&quot;;</span>
<a href="#l9.190"></a><span id="l9.190">   exception = null;</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192">   d.inputFields = new Array();</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-  for (let inputField of array_or_undef(xml.$inputField))</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-  {</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+  for (let inputField of array_or_undef(xml.$inputField)) {</span>
<a href="#l9.196"></a><span id="l9.196">     try {</span>
<a href="#l9.197"></a><span id="l9.197">       var fieldset =</span>
<a href="#l9.198"></a><span id="l9.198">       {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-        varname : sanitize.alphanumdash(inputField[&quot;@key&quot;]).toUpperCase(),</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-        displayName : sanitize.label(inputField[&quot;@label&quot;]),</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-        exampleValue : sanitize.label(inputField.value)</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+        varname: sanitize.alphanumdash(inputField[&quot;@key&quot;]).toUpperCase(),</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+        displayName: sanitize.label(inputField[&quot;@label&quot;]),</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+        exampleValue: sanitize.label(inputField.value)</span>
<a href="#l9.205"></a><span id="l9.205">       };</span>
<a href="#l9.206"></a><span id="l9.206">       d.inputFields.push(fieldset);</span>
<a href="#l9.207"></a><span id="l9.207">     } catch (e) { logException(e); } // for now, don't throw,</span>
<a href="#l9.208"></a><span id="l9.208">         // because we don't support custom fields yet anyways.</span>
<a href="#l9.209"></a><span id="l9.209">   }</span>
<a href="#l9.210"></a><span id="l9.210"> </span>
<a href="#l9.211"></a><span id="l9.211">   return d;</span>
<a href="#l9.212"></a><span id="l9.212"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/accountcreation/content/sanitizeDatatypes.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/accountcreation/content/sanitizeDatatypes.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -15,89 +15,82 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * the expected datatype in JS types. If the value is not as expected,</span>
<a href="#l10.5"></a><span id="l10.5">  * they throw exceptions.</span>
<a href="#l10.6"></a><span id="l10.6">  */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> var sanitize =</span>
<a href="#l10.11"></a><span id="l10.11"> {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  integer : function(unchecked)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  integer(unchecked) {</span>
<a href="#l10.15"></a><span id="l10.15">     if (typeof(unchecked) == &quot;number&quot; &amp;&amp; !isNaN(unchecked))</span>
<a href="#l10.16"></a><span id="l10.16">       return unchecked;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">     var r = parseInt(unchecked);</span>
<a href="#l10.19"></a><span id="l10.19">     if (isNaN(r))</span>
<a href="#l10.20"></a><span id="l10.20">       throw new MalformedException(&quot;no_number.error&quot;, unchecked);</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">     return r;</span>
<a href="#l10.23"></a><span id="l10.23">   },</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-  integerRange : function(unchecked, min, max)</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  integerRange(unchecked, min, max) {</span>
<a href="#l10.28"></a><span id="l10.28">     var int = this.integer(unchecked);</span>
<a href="#l10.29"></a><span id="l10.29">     if (int &lt; min)</span>
<a href="#l10.30"></a><span id="l10.30">       throw new MalformedException(&quot;number_too_small.error&quot;, unchecked);</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">     if (int &gt; max)</span>
<a href="#l10.33"></a><span id="l10.33">       throw new MalformedException(&quot;number_too_large.error&quot;, unchecked);</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">     return int;</span>
<a href="#l10.36"></a><span id="l10.36">   },</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  boolean : function(unchecked)</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  boolean(unchecked) {</span>
<a href="#l10.41"></a><span id="l10.41">     if (typeof(unchecked) == &quot;boolean&quot;)</span>
<a href="#l10.42"></a><span id="l10.42">       return unchecked;</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44">     if (unchecked == &quot;true&quot;)</span>
<a href="#l10.45"></a><span id="l10.45">       return true;</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47">     if (unchecked == &quot;false&quot;)</span>
<a href="#l10.48"></a><span id="l10.48">       return false;</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50">     throw new MalformedException(&quot;boolean.error&quot;, unchecked);</span>
<a href="#l10.51"></a><span id="l10.51">   },</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  string : function(unchecked)</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  string(unchecked) {</span>
<a href="#l10.56"></a><span id="l10.56">     return String(unchecked);</span>
<a href="#l10.57"></a><span id="l10.57">   },</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  nonemptystring : function(unchecked)</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  nonemptystring(unchecked) {</span>
<a href="#l10.62"></a><span id="l10.62">     if (!unchecked)</span>
<a href="#l10.63"></a><span id="l10.63">       throw new MalformedException(&quot;string_empty.error&quot;, unchecked);</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">     return this.string(unchecked);</span>
<a href="#l10.66"></a><span id="l10.66">   },</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">   /**</span>
<a href="#l10.69"></a><span id="l10.69">    * Allow only letters, numbers, &quot;-&quot; and &quot;_&quot;.</span>
<a href="#l10.70"></a><span id="l10.70">    *</span>
<a href="#l10.71"></a><span id="l10.71">    * Empty strings not allowed (good idea?).</span>
<a href="#l10.72"></a><span id="l10.72">    */</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  alphanumdash : function(unchecked)</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  alphanumdash(unchecked) {</span>
<a href="#l10.76"></a><span id="l10.76">     var str = this.nonemptystring(unchecked);</span>
<a href="#l10.77"></a><span id="l10.77">     if (!/^[a-zA-Z0-9\-\_]*$/.test(str))</span>
<a href="#l10.78"></a><span id="l10.78">       throw new MalformedException(&quot;alphanumdash.error&quot;, unchecked);</span>
<a href="#l10.79"></a><span id="l10.79"> </span>
<a href="#l10.80"></a><span id="l10.80">     return str;</span>
<a href="#l10.81"></a><span id="l10.81">   },</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">   /**</span>
<a href="#l10.84"></a><span id="l10.84">    * DNS hostnames like foo.bar.example.com</span>
<a href="#l10.85"></a><span id="l10.85">    * Allow only letters, numbers, &quot;-&quot; and &quot;.&quot;</span>
<a href="#l10.86"></a><span id="l10.86">    * Empty strings not allowed.</span>
<a href="#l10.87"></a><span id="l10.87">    * Currently does not support IDN (international domain names).</span>
<a href="#l10.88"></a><span id="l10.88">    */</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  hostname : function(unchecked)</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  hostname(unchecked) {</span>
<a href="#l10.92"></a><span id="l10.92">     let str = cleanUpHostName(this.nonemptystring(unchecked));</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">     // Allow placeholders. TODO move to a new hostnameOrPlaceholder()</span>
<a href="#l10.95"></a><span id="l10.95">     // The regex is &quot;anything, followed by one or more (placeholders than</span>
<a href="#l10.96"></a><span id="l10.96">     // anything)&quot;.  This doesn't catch the non-placeholder case, but that's</span>
<a href="#l10.97"></a><span id="l10.97">     // handled down below.</span>
<a href="#l10.98"></a><span id="l10.98">     if (/^[a-zA-Z0-9\-\.]*(%[A-Z0-9]+%[a-zA-Z0-9\-\.]*)+$/.test(str))</span>
<a href="#l10.99"></a><span id="l10.99">       return str;</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineat">@@ -105,18 +98,17 @@ var sanitize =</span>
<a href="#l10.101"></a><span id="l10.101">     if (!isLegalHostNameOrIP(str))</span>
<a href="#l10.102"></a><span id="l10.102">       throw new MalformedException(&quot;hostname_syntax.error&quot;, unchecked);</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104">     return str.toLowerCase();</span>
<a href="#l10.105"></a><span id="l10.105">   },</span>
<a href="#l10.106"></a><span id="l10.106">   /**</span>
<a href="#l10.107"></a><span id="l10.107">    * A non-chrome URL that's safe to request.</span>
<a href="#l10.108"></a><span id="l10.108">    */</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-  url : function (unchecked)</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-  {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  url(unchecked) {</span>
<a href="#l10.112"></a><span id="l10.112">     var str =  this.string(unchecked);</span>
<a href="#l10.113"></a><span id="l10.113">     if (!str.startsWith(&quot;http&quot;) &amp;&amp; !str.startsWith(&quot;https&quot;))</span>
<a href="#l10.114"></a><span id="l10.114">       throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116">     var uri;</span>
<a href="#l10.117"></a><span id="l10.117">     try {</span>
<a href="#l10.118"></a><span id="l10.118">       uri = Services.io.newURI(str);</span>
<a href="#l10.119"></a><span id="l10.119">       uri = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineat">@@ -128,36 +120,33 @@ var sanitize =</span>
<a href="#l10.121"></a><span id="l10.121">       throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l10.122"></a><span id="l10.122"> </span>
<a href="#l10.123"></a><span id="l10.123">     return uri.spec;</span>
<a href="#l10.124"></a><span id="l10.124">   },</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126">   /**</span>
<a href="#l10.127"></a><span id="l10.127">    * A value which should be shown to the user in the UI as label</span>
<a href="#l10.128"></a><span id="l10.128">    */</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  label : function(unchecked)</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-  {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  label(unchecked) {</span>
<a href="#l10.132"></a><span id="l10.132">     return this.string(unchecked);</span>
<a href="#l10.133"></a><span id="l10.133">   },</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">   /**</span>
<a href="#l10.136"></a><span id="l10.136">    * Allows only certain values as input, otherwise throw.</span>
<a href="#l10.137"></a><span id="l10.137">    *</span>
<a href="#l10.138"></a><span id="l10.138">    * @param unchecked {Any} The value to check</span>
<a href="#l10.139"></a><span id="l10.139">    * @param allowedValues {Array} List of values that |unchecked| may have.</span>
<a href="#l10.140"></a><span id="l10.140">    * @param defaultValue {Any} (Optional) If |unchecked| does not match</span>
<a href="#l10.141"></a><span id="l10.141">    *       anything in |mapping|, a |defaultValue| can be returned instead of</span>
<a href="#l10.142"></a><span id="l10.142">    *       throwing an exception. The latter is the default and happens when</span>
<a href="#l10.143"></a><span id="l10.143">    *       no |defaultValue| is passed.</span>
<a href="#l10.144"></a><span id="l10.144">    * @throws MalformedException</span>
<a href="#l10.145"></a><span id="l10.145">    */</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-  enum : function(unchecked, allowedValues, defaultValue)</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-  {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-    for (let allowedValue of allowedValues)</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-    {</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  enum(unchecked, allowedValues, defaultValue) {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    for (let allowedValue of allowedValues) {</span>
<a href="#l10.152"></a><span id="l10.152">       if (allowedValue == unchecked)</span>
<a href="#l10.153"></a><span id="l10.153">         return allowedValue;</span>
<a href="#l10.154"></a><span id="l10.154">     }</span>
<a href="#l10.155"></a><span id="l10.155">     // value is bad</span>
<a href="#l10.156"></a><span id="l10.156">     if (typeof(defaultValue) == &quot;undefined&quot;)</span>
<a href="#l10.157"></a><span id="l10.157">       throw new MalformedException(&quot;allowed_value.error&quot;, unchecked);</span>
<a href="#l10.158"></a><span id="l10.158">     return defaultValue;</span>
<a href="#l10.159"></a><span id="l10.159">   },</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineat">@@ -174,32 +163,29 @@ var sanitize =</span>
<a href="#l10.161"></a><span id="l10.161">    *       would be: { foo: 1, bar : 2 }.</span>
<a href="#l10.162"></a><span id="l10.162">    *       Use quotes when you need freaky characters: &quot;baz-&quot; : 3.</span>
<a href="#l10.163"></a><span id="l10.163">    * @param defaultValue {Any} (Optional) If |unchecked| does not match</span>
<a href="#l10.164"></a><span id="l10.164">    *       anything in |mapping|, a |defaultValue| can be returned instead of</span>
<a href="#l10.165"></a><span id="l10.165">    *       throwing an exception. The latter is the default and happens when</span>
<a href="#l10.166"></a><span id="l10.166">    *       no |defaultValue| is passed.</span>
<a href="#l10.167"></a><span id="l10.167">    * @throws MalformedException</span>
<a href="#l10.168"></a><span id="l10.168">    */</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-  translate : function(unchecked, mapping, defaultValue)</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-  {</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-    for (var inputValue in mapping)</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-    {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  translate(unchecked, mapping, defaultValue) {</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+    for (var inputValue in mapping) {</span>
<a href="#l10.175"></a><span id="l10.175">       if (inputValue == unchecked)</span>
<a href="#l10.176"></a><span id="l10.176">         return mapping[inputValue];</span>
<a href="#l10.177"></a><span id="l10.177">     }</span>
<a href="#l10.178"></a><span id="l10.178">     // value is bad</span>
<a href="#l10.179"></a><span id="l10.179">     if (typeof(defaultValue) == &quot;undefined&quot;)</span>
<a href="#l10.180"></a><span id="l10.180">       throw new MalformedException(&quot;allowed_value.error&quot;, unchecked);</span>
<a href="#l10.181"></a><span id="l10.181">     return defaultValue;</span>
<a href="#l10.182"></a><span id="l10.182">   }</span>
<a href="#l10.183"></a><span id="l10.183"> };</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-function MalformedException(msgID, uncheckedBadValue)</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-{</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+function MalformedException(msgID, uncheckedBadValue) {</span>
<a href="#l10.188"></a><span id="l10.188">   var stringBundle = getStringBundle(</span>
<a href="#l10.189"></a><span id="l10.189">       &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;);</span>
<a href="#l10.190"></a><span id="l10.190">   var msg = stringBundle.GetStringFromName(msgID);</span>
<a href="#l10.191"></a><span id="l10.191">   if (kDebug)</span>
<a href="#l10.192"></a><span id="l10.192">     msg += &quot; (bad value: &quot; + new String(uncheckedBadValue) + &quot;)&quot;;</span>
<a href="#l10.193"></a><span id="l10.193">   Exception.call(this, msg);</span>
<a href="#l10.194"></a><span id="l10.194"> }</span>
<a href="#l10.195"></a><span id="l10.195"> MalformedException.prototype = Object.create(Exception.prototype);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/accountcreation/content/util.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/accountcreation/content/util.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4,60 +4,55 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.5"></a><span id="l11.5"> /**</span>
<a href="#l11.6"></a><span id="l11.6">  * Some common, generic functions</span>
<a href="#l11.7"></a><span id="l11.7">  */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-function assert(test, errorMsg)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+function assert(test, errorMsg) {</span>
<a href="#l11.15"></a><span id="l11.15">   if (!test)</span>
<a href="#l11.16"></a><span id="l11.16">     throw new NotReached(errorMsg ? errorMsg :</span>
<a href="#l11.17"></a><span id="l11.17">           &quot;Programming bug. Assertion failed, see log.&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> }</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-function makeCallback(obj, func)</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+function makeCallback(obj, func) {</span>
<a href="#l11.23"></a><span id="l11.23">   return func.bind(obj);</span>
<a href="#l11.24"></a><span id="l11.24"> }</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> /**</span>
<a href="#l11.28"></a><span id="l11.28">  * Runs the given function sometime later</span>
<a href="#l11.29"></a><span id="l11.29">  *</span>
<a href="#l11.30"></a><span id="l11.30">  * Currently implemented using setTimeout(), but</span>
<a href="#l11.31"></a><span id="l11.31">  * can later be replaced with an nsITimer impl,</span>
<a href="#l11.32"></a><span id="l11.32">  * when code wants to use it in a module.</span>
<a href="#l11.33"></a><span id="l11.33">  */</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-function runAsync(func)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-{</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+function runAsync(func) {</span>
<a href="#l11.37"></a><span id="l11.37">   setTimeout(func, 0);</span>
<a href="#l11.38"></a><span id="l11.38"> }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> /**</span>
<a href="#l11.42"></a><span id="l11.42">  * @param uriStr {String}</span>
<a href="#l11.43"></a><span id="l11.43">  * @result {nsIURI}</span>
<a href="#l11.44"></a><span id="l11.44">  */</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-function makeNSIURI(uriStr)</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-{</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+function makeNSIURI(uriStr) {</span>
<a href="#l11.48"></a><span id="l11.48">   return Services.io.newURI(uriStr);</span>
<a href="#l11.49"></a><span id="l11.49"> }</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52"> /**</span>
<a href="#l11.53"></a><span id="l11.53">  * Reads UTF8 data from a URL.</span>
<a href="#l11.54"></a><span id="l11.54">  *</span>
<a href="#l11.55"></a><span id="l11.55">  * @param uri {nsIURI}   what you want to read</span>
<a href="#l11.56"></a><span id="l11.56">  * @return {Array of String}   the contents of the file, one string per line</span>
<a href="#l11.57"></a><span id="l11.57">  */</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-function readURLasUTF8(uri)</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-{</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+function readURLasUTF8(uri) {</span>
<a href="#l11.61"></a><span id="l11.61">   assert(uri instanceof Ci.nsIURI, &quot;uri must be an nsIURI&quot;);</span>
<a href="#l11.62"></a><span id="l11.62">   try {</span>
<a href="#l11.63"></a><span id="l11.63">     let chan = Services.io.newChannelFromURI2(uri,</span>
<a href="#l11.64"></a><span id="l11.64">                                               null,</span>
<a href="#l11.65"></a><span id="l11.65">                                               Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l11.66"></a><span id="l11.66">                                               null,</span>
<a href="#l11.67"></a><span id="l11.67">                                               Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l11.68"></a><span id="l11.68">                                               Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineat">@@ -90,204 +85,184 @@ function readURLasUTF8(uri)</span>
<a href="#l11.70"></a><span id="l11.70">  * it into lines, and returns an array with one string per line</span>
<a href="#l11.71"></a><span id="l11.71">  *</span>
<a href="#l11.72"></a><span id="l11.72">  * Linebreaks are not contained in the result,,</span>
<a href="#l11.73"></a><span id="l11.73">  * and all of \r\n, (Windows) \r (Mac) and \n (Unix) counts as linebreak.</span>
<a href="#l11.74"></a><span id="l11.74">  *</span>
<a href="#l11.75"></a><span id="l11.75">  * @param content {String} one long string with the whole file</span>
<a href="#l11.76"></a><span id="l11.76">  * @return {Array of String} one string per line (no linebreaks)</span>
<a href="#l11.77"></a><span id="l11.77">  */</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-function splitLines(content)</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-{</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+function splitLines(content) {</span>
<a href="#l11.81"></a><span id="l11.81">   content = content.replace(&quot;\r\n&quot;, &quot;\n&quot;);</span>
<a href="#l11.82"></a><span id="l11.82">   content = content.replace(&quot;\r&quot;, &quot;\n&quot;);</span>
<a href="#l11.83"></a><span id="l11.83">   return content.split(&quot;\n&quot;);</span>
<a href="#l11.84"></a><span id="l11.84"> }</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86"> /**</span>
<a href="#l11.87"></a><span id="l11.87">  * @param bundleURI {String}   chrome URL to properties file</span>
<a href="#l11.88"></a><span id="l11.88">  * @return nsIStringBundle</span>
<a href="#l11.89"></a><span id="l11.89">  */</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-function getStringBundle(bundleURI)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-{</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+function getStringBundle(bundleURI) {</span>
<a href="#l11.93"></a><span id="l11.93">   try {</span>
<a href="#l11.94"></a><span id="l11.94">     return Services.strings.createBundle(bundleURI);</span>
<a href="#l11.95"></a><span id="l11.95">   } catch (e) {</span>
<a href="#l11.96"></a><span id="l11.96">     throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI +</span>
<a href="#l11.97"></a><span id="l11.97">                         &quot;&gt;. Error: &quot; + e);</span>
<a href="#l11.98"></a><span id="l11.98">   }</span>
<a href="#l11.99"></a><span id="l11.99"> }</span>
<a href="#l11.100"></a><span id="l11.100"> </span>
<a href="#l11.101"></a><span id="l11.101"> </span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-function Exception(msg)</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-{</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+function Exception(msg) {</span>
<a href="#l11.105"></a><span id="l11.105">   this._message = msg;</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107">   // get stack</span>
<a href="#l11.108"></a><span id="l11.108">   try {</span>
<a href="#l11.109"></a><span id="l11.109">     not.found.here += 1; // force a native exception ...</span>
<a href="#l11.110"></a><span id="l11.110">   } catch (e) {</span>
<a href="#l11.111"></a><span id="l11.111">     this.stack = e.stack; // ... to get the current stack</span>
<a href="#l11.112"></a><span id="l11.112">   }</span>
<a href="#l11.113"></a><span id="l11.113"> }</span>
<a href="#l11.114"></a><span id="l11.114"> Exception.prototype =</span>
<a href="#l11.115"></a><span id="l11.115"> {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  get message()</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-  {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+  get message() {</span>
<a href="#l11.119"></a><span id="l11.119">     return this._message;</span>
<a href="#l11.120"></a><span id="l11.120">   },</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-  toString : function()</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  {</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  toString() {</span>
<a href="#l11.124"></a><span id="l11.124">     return this._message;</span>
<a href="#l11.125"></a><span id="l11.125">   }</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-}</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+};</span>
<a href="#l11.128"></a><span id="l11.128"> </span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-function NotReached(msg)</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-{</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+function NotReached(msg) {</span>
<a href="#l11.132"></a><span id="l11.132">   Exception.call(this, msg); // call super constructor</span>
<a href="#l11.133"></a><span id="l11.133">   logException(this);</span>
<a href="#l11.134"></a><span id="l11.134"> }</span>
<a href="#l11.135"></a><span id="l11.135"> // Make NotReached extend Exception.</span>
<a href="#l11.136"></a><span id="l11.136"> NotReached.prototype = Object.create(Exception.prototype);</span>
<a href="#l11.137"></a><span id="l11.137"> NotReached.prototype.constructor = NotReached;</span>
<a href="#l11.138"></a><span id="l11.138"> </span>
<a href="#l11.139"></a><span id="l11.139"> /**</span>
<a href="#l11.140"></a><span id="l11.140">  * A handle for an async function which you can cancel.</span>
<a href="#l11.141"></a><span id="l11.141">  * The async function will return an object of this type (a subtype)</span>
<a href="#l11.142"></a><span id="l11.142">  * and you can call cancel() when you feel like killing the function.</span>
<a href="#l11.143"></a><span id="l11.143">  */</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-function Abortable()</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-{</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+function Abortable() {</span>
<a href="#l11.147"></a><span id="l11.147"> }</span>
<a href="#l11.148"></a><span id="l11.148"> Abortable.prototype =</span>
<a href="#l11.149"></a><span id="l11.149"> {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  cancel : function()</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-  {</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+  cancel() {</span>
<a href="#l11.153"></a><span id="l11.153">   }</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-}</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+};</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157"> /**</span>
<a href="#l11.158"></a><span id="l11.158">  * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.159"></a><span id="l11.159">  * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.160"></a><span id="l11.160">  * @param setTimeoutID {Integer}  Return value of setTimeout()</span>
<a href="#l11.161"></a><span id="l11.161">  */</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-function TimeoutAbortable(setTimeoutID)</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-{</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+function TimeoutAbortable(setTimeoutID) {</span>
<a href="#l11.165"></a><span id="l11.165">   Abortable.call(this, setTimeoutID); // call super constructor</span>
<a href="#l11.166"></a><span id="l11.166">   this._id = setTimeoutID;</span>
<a href="#l11.167"></a><span id="l11.167"> }</span>
<a href="#l11.168"></a><span id="l11.168"> TimeoutAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l11.169"></a><span id="l11.169"> TimeoutAbortable.prototype.constructor = TimeoutAbortable;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-TimeoutAbortable.prototype.cancel = function() { clearTimeout(this._id); }</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+TimeoutAbortable.prototype.cancel = function() { clearTimeout(this._id); };</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173"> /**</span>
<a href="#l11.174"></a><span id="l11.174">  * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.175"></a><span id="l11.175">  * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.176"></a><span id="l11.176">  * @param setIntervalID {Integer}  Return value of setInterval()</span>
<a href="#l11.177"></a><span id="l11.177">  */</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-function IntervalAbortable(setIntervalID)</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-{</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+function IntervalAbortable(setIntervalID) {</span>
<a href="#l11.181"></a><span id="l11.181">   Abortable.call(this, setIntervalID); // call super constructor</span>
<a href="#l11.182"></a><span id="l11.182">   this._id = setIntervalID;</span>
<a href="#l11.183"></a><span id="l11.183"> }</span>
<a href="#l11.184"></a><span id="l11.184"> IntervalAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l11.185"></a><span id="l11.185"> IntervalAbortable.prototype.constructor = IntervalAbortable;</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-IntervalAbortable.prototype.cancel = function() { clearInterval(this._id); }</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+IntervalAbortable.prototype.cancel = function() { clearInterval(this._id); };</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189"> // Allows you to make several network calls, but return</span>
<a href="#l11.190"></a><span id="l11.190"> // only one Abortable object.</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-function SuccessiveAbortable()</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-{</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+function SuccessiveAbortable() {</span>
<a href="#l11.194"></a><span id="l11.194">   Abortable.call(this); // call super constructor</span>
<a href="#l11.195"></a><span id="l11.195">   this._current = null;</span>
<a href="#l11.196"></a><span id="l11.196"> }</span>
<a href="#l11.197"></a><span id="l11.197"> SuccessiveAbortable.prototype = {</span>
<a href="#l11.198"></a><span id="l11.198">   __proto__: Abortable.prototype,</span>
<a href="#l11.199"></a><span id="l11.199">   get current() { return this._current; },</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-  set current(abortable)</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-  {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+  set current(abortable) {</span>
<a href="#l11.203"></a><span id="l11.203">     assert(abortable instanceof Abortable || abortable == null,</span>
<a href="#l11.204"></a><span id="l11.204">         &quot;need an Abortable object (or null)&quot;);</span>
<a href="#l11.205"></a><span id="l11.205">     this._current = abortable;</span>
<a href="#l11.206"></a><span id="l11.206">   },</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-  cancel: function()</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-  {</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  cancel() {</span>
<a href="#l11.210"></a><span id="l11.210">     if (this._current)</span>
<a href="#l11.211"></a><span id="l11.211">       this._current.cancel();</span>
<a href="#l11.212"></a><span id="l11.212">   }</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-}</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+};</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-function deepCopy(org)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-{</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+function deepCopy(org) {</span>
<a href="#l11.219"></a><span id="l11.219">   if (typeof(org) == &quot;undefined&quot;)</span>
<a href="#l11.220"></a><span id="l11.220">     return undefined;</span>
<a href="#l11.221"></a><span id="l11.221">   if (org == null)</span>
<a href="#l11.222"></a><span id="l11.222">     return null;</span>
<a href="#l11.223"></a><span id="l11.223">   if (typeof(org) == &quot;string&quot;)</span>
<a href="#l11.224"></a><span id="l11.224">     return org;</span>
<a href="#l11.225"></a><span id="l11.225">   if (typeof(org) == &quot;number&quot;)</span>
<a href="#l11.226"></a><span id="l11.226">     return org;</span>
<a href="#l11.227"></a><span id="l11.227">   if (typeof(org) == &quot;boolean&quot;)</span>
<a href="#l11.228"></a><span id="l11.228">     return org == true;</span>
<a href="#l11.229"></a><span id="l11.229">   if (typeof(org) == &quot;function&quot;)</span>
<a href="#l11.230"></a><span id="l11.230">     return org;</span>
<a href="#l11.231"></a><span id="l11.231">   if (typeof(org) != &quot;object&quot;)</span>
<a href="#l11.232"></a><span id="l11.232">     throw &quot;can't copy objects of type &quot; + typeof(org) + &quot; yet&quot;;</span>
<a href="#l11.233"></a><span id="l11.233"> </span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-  //TODO still instanceof org != instanceof copy</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-  //var result = new org.constructor();</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+  // TODO still instanceof org != instanceof copy</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  // var result = new org.constructor();</span>
<a href="#l11.238"></a><span id="l11.238">   var result = new Object();</span>
<a href="#l11.239"></a><span id="l11.239">   if (typeof(org.length) != &quot;undefined&quot;)</span>
<a href="#l11.240"></a><span id="l11.240">     var result = new Array();</span>
<a href="#l11.241"></a><span id="l11.241">   for (var prop in org)</span>
<a href="#l11.242"></a><span id="l11.242">     result[prop] = deepCopy(org[prop]);</span>
<a href="#l11.243"></a><span id="l11.243">   return result;</span>
<a href="#l11.244"></a><span id="l11.244"> }</span>
<a href="#l11.245"></a><span id="l11.245"> </span>
<a href="#l11.246"></a><span id="l11.246"> if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l11.247"></a><span id="l11.247">   ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l11.248"></a><span id="l11.248">   var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l11.249"></a><span id="l11.249"> }</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-function ddump(text)</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-{</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+function ddump(text) {</span>
<a href="#l11.253"></a><span id="l11.253">   gEmailWizardLogger.info(text);</span>
<a href="#l11.254"></a><span id="l11.254"> }</span>
<a href="#l11.255"></a><span id="l11.255"> </span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-function debugObject(obj, name, maxDepth, curDepth)</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-{</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+function debugObject(obj, name, maxDepth, curDepth) {</span>
<a href="#l11.259"></a><span id="l11.259">   if (curDepth == undefined)</span>
<a href="#l11.260"></a><span id="l11.260">     curDepth = 0;</span>
<a href="#l11.261"></a><span id="l11.261">   if (maxDepth != undefined &amp;&amp; curDepth &gt; maxDepth)</span>
<a href="#l11.262"></a><span id="l11.262">     return &quot;&quot;;</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264">   var result = &quot;&quot;;</span>
<a href="#l11.265"></a><span id="l11.265">   var i = 0;</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-  for (let prop in obj)</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-  {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  for (let prop in obj) {</span>
<a href="#l11.269"></a><span id="l11.269">     i++;</span>
<a href="#l11.270"></a><span id="l11.270">     try {</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-      if (typeof(obj[prop]) == &quot;object&quot;)</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-      {</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+      if (typeof(obj[prop]) == &quot;object&quot;) {</span>
<a href="#l11.274"></a><span id="l11.274">         if (obj[prop] &amp;&amp; obj[prop].length != undefined)</span>
<a href="#l11.275"></a><span id="l11.275">           result += name + &quot;.&quot; + prop + &quot;=[probably array, length &quot; +</span>
<a href="#l11.276"></a><span id="l11.276">                 obj[prop].length + &quot;]\n&quot;;</span>
<a href="#l11.277"></a><span id="l11.277">         else</span>
<a href="#l11.278"></a><span id="l11.278">           result += name + &quot;.&quot; + prop + &quot;=[&quot; + typeof(obj[prop]) + &quot;]\n&quot;;</span>
<a href="#l11.279"></a><span id="l11.279">         result += debugObject(obj[prop], name + &quot;.&quot; + prop,</span>
<a href="#l11.280"></a><span id="l11.280">                               maxDepth, curDepth + 1);</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-      }</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-      else if (typeof(obj[prop]) == &quot;function&quot;)</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+      } else if (typeof(obj[prop]) == &quot;function&quot;)</span>
<a href="#l11.284"></a><span id="l11.284">         result += name + &quot;.&quot; + prop + &quot;=[function]\n&quot;;</span>
<a href="#l11.285"></a><span id="l11.285">       else</span>
<a href="#l11.286"></a><span id="l11.286">         result += name + &quot;.&quot; + prop + &quot;=&quot; + obj[prop] + &quot;\n&quot;;</span>
<a href="#l11.287"></a><span id="l11.287">     } catch (e) {</span>
<a href="#l11.288"></a><span id="l11.288">       result += name + &quot;.&quot; + prop + &quot;-&gt; Exception(&quot; + e + &quot;)\n&quot;;</span>
<a href="#l11.289"></a><span id="l11.289">     }</span>
<a href="#l11.290"></a><span id="l11.290">   }</span>
<a href="#l11.291"></a><span id="l11.291">   if (!i)</span>
<a href="#l11.292"></a><span id="l11.292">     result += name + &quot; is empty\n&quot;;</span>
<a href="#l11.293"></a><span id="l11.293">   return result;</span>
<a href="#l11.294"></a><span id="l11.294"> }</span>
<a href="#l11.295"></a><span id="l11.295"> </span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-function alertPrompt(alertTitle, alertMsg)</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-{</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+function alertPrompt(alertTitle, alertMsg) {</span>
<a href="#l11.299"></a><span id="l11.299">   Services.prompt.alert(window, alertTitle, alertMsg);</span>
<a href="#l11.300"></a><span id="l11.300"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -32,18 +32,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l12.5"></a><span id="l12.5"> ChromeUtils.import(&quot;resource:///modules/OAuth2Providers.jsm&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l12.8"></a><span id="l12.8">   ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.9"></a><span id="l12.9">   var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-function verifyConfig(config, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+function verifyConfig(config, alter, msgWindow, successCallback, errorCallback) {</span>
<a href="#l12.15"></a><span id="l12.15">   ddump(debugObject(config, &quot;config&quot;, 3));</span>
<a href="#l12.16"></a><span id="l12.16">   assert(config instanceof AccountConfig,</span>
<a href="#l12.17"></a><span id="l12.17">          &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l12.18"></a><span id="l12.18">   assert(typeof(alter) == &quot;boolean&quot;);</span>
<a href="#l12.19"></a><span id="l12.19">   assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l12.20"></a><span id="l12.20">   assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">   if (MailServices.accounts.findRealServer(config.incoming.username,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -103,131 +102,118 @@ function verifyConfig(config, alter, msg</span>
<a href="#l12.24"></a><span id="l12.24">       verifyLogon(config, inServer, alter, msgWindow,</span>
<a href="#l12.25"></a><span id="l12.25">                   successCallback, errorCallback);</span>
<a href="#l12.26"></a><span id="l12.26">     else {</span>
<a href="#l12.27"></a><span id="l12.27">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l12.28"></a><span id="l12.28">       MailServices.accounts.removeIncomingServer(inServer, true);</span>
<a href="#l12.29"></a><span id="l12.29">       successCallback(config);</span>
<a href="#l12.30"></a><span id="l12.30">     }</span>
<a href="#l12.31"></a><span id="l12.31">     return;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  catch (e) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  } catch (e) {</span>
<a href="#l12.35"></a><span id="l12.35">     gEmailWizardLogger.error(&quot;ERROR: verify logon shouldn't have failed&quot;);</span>
<a href="#l12.36"></a><span id="l12.36">   }</span>
<a href="#l12.37"></a><span id="l12.37">   // Avoid pref pollution, clear out server prefs.</span>
<a href="#l12.38"></a><span id="l12.38">   MailServices.accounts.removeIncomingServer(inServer, true);</span>
<a href="#l12.39"></a><span id="l12.39">   errorCallback(e);</span>
<a href="#l12.40"></a><span id="l12.40"> }</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42"> function verifyLogon(config, inServer, alter, msgWindow, successCallback,</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                     errorCallback)</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-{</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+                     errorCallback) {</span>
<a href="#l12.46"></a><span id="l12.46">   gEmailWizardLogger.info(&quot;verifyLogon for server at &quot; + inServer.hostName);</span>
<a href="#l12.47"></a><span id="l12.47">   // hack - save away the old callbacks.</span>
<a href="#l12.48"></a><span id="l12.48">   let saveCallbacks = msgWindow.notificationCallbacks;</span>
<a href="#l12.49"></a><span id="l12.49">   // set our own callbacks - this works because verifyLogon will</span>
<a href="#l12.50"></a><span id="l12.50">   // synchronously create the transport and use the notification callbacks.</span>
<a href="#l12.51"></a><span id="l12.51">   let listener = new urlListener(config, inServer, alter, msgWindow,</span>
<a href="#l12.52"></a><span id="l12.52">                                  successCallback, errorCallback);</span>
<a href="#l12.53"></a><span id="l12.53">   // our listener listens both for the url and cert errors.</span>
<a href="#l12.54"></a><span id="l12.54">   msgWindow.notificationCallbacks = listener;</span>
<a href="#l12.55"></a><span id="l12.55">   // try to work around bug where backend is clearing password.</span>
<a href="#l12.56"></a><span id="l12.56">   try {</span>
<a href="#l12.57"></a><span id="l12.57">     inServer.password = config.incoming.password;</span>
<a href="#l12.58"></a><span id="l12.58">     let uri = inServer.verifyLogon(listener, msgWindow);</span>
<a href="#l12.59"></a><span id="l12.59">     // clear msgWindow so url won't prompt for passwords.</span>
<a href="#l12.60"></a><span id="l12.60">     uri.QueryInterface(Ci.nsIMsgMailNewsUrl).msgWindow = null;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  }</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-  catch (e) { gEmailWizardLogger.error(&quot;verifyLogon failed: &quot; + e); throw e;}</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-  finally {</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  } catch (e) { gEmailWizardLogger.error(&quot;verifyLogon failed: &quot; + e); throw e; } finally {</span>
<a href="#l12.65"></a><span id="l12.65">     // restore them</span>
<a href="#l12.66"></a><span id="l12.66">     msgWindow.notificationCallbacks = saveCallbacks;</span>
<a href="#l12.67"></a><span id="l12.67">   }</span>
<a href="#l12.68"></a><span id="l12.68"> }</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70"> /**</span>
<a href="#l12.71"></a><span id="l12.71">  * The url listener also implements nsIBadCertListener2.  Its job is to prevent</span>
<a href="#l12.72"></a><span id="l12.72">  * &quot;bad cert&quot; security dialogs from being shown to the user.  Currently it puts</span>
<a href="#l12.73"></a><span id="l12.73">  * up the cert override dialog, though we'd like to give the user more detailed</span>
<a href="#l12.74"></a><span id="l12.74">  * information in the future.</span>
<a href="#l12.75"></a><span id="l12.75">  */</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77"> function urlListener(config, server, alter, msgWindow, successCallback,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-                     errorCallback)</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-{</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+                     errorCallback) {</span>
<a href="#l12.81"></a><span id="l12.81">   this.mConfig = config;</span>
<a href="#l12.82"></a><span id="l12.82">   this.mServer = server;</span>
<a href="#l12.83"></a><span id="l12.83">   this.mAlter = alter;</span>
<a href="#l12.84"></a><span id="l12.84">   this.mSuccessCallback = successCallback;</span>
<a href="#l12.85"></a><span id="l12.85">   this.mErrorCallback = errorCallback;</span>
<a href="#l12.86"></a><span id="l12.86">   this.mMsgWindow = msgWindow;</span>
<a href="#l12.87"></a><span id="l12.87">   this.mCertError = false;</span>
<a href="#l12.88"></a><span id="l12.88">   this._log = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.89"></a><span id="l12.89"> }</span>
<a href="#l12.90"></a><span id="l12.90"> urlListener.prototype =</span>
<a href="#l12.91"></a><span id="l12.91"> {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-  OnStartRunningUrl: function(aUrl)</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  {</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l12.95"></a><span id="l12.95">     this._log.info(&quot;Starting to test username&quot;);</span>
<a href="#l12.96"></a><span id="l12.96">     this._log.info(&quot;  username=&quot; + (this.mConfig.incoming.username !=</span>
<a href="#l12.97"></a><span id="l12.97">                           this.mConfig.identity.emailAddress) +</span>
<a href="#l12.98"></a><span id="l12.98">                           &quot;, have savedUsername=&quot; +</span>
<a href="#l12.99"></a><span id="l12.99">                           (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l12.100"></a><span id="l12.100">     this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l12.101"></a><span id="l12.101">   },</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  {</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l12.106"></a><span id="l12.106">     this._log.info(&quot;Finished verifyConfig resulted in &quot; + aExitCode);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    if (Components.isSuccessCode(aExitCode))</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-    {</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+    if (Components.isSuccessCode(aExitCode)) {</span>
<a href="#l12.110"></a><span id="l12.110">       this._cleanup();</span>
<a href="#l12.111"></a><span id="l12.111">       this.mSuccessCallback(this.mConfig);</span>
<a href="#l12.112"></a><span id="l12.112">     }</span>
<a href="#l12.113"></a><span id="l12.113">     // Logon failed, and we aren't supposed to try other variations.</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-    else if (!this.mAlter)</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    {</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+    else if (!this.mAlter) {</span>
<a href="#l12.117"></a><span id="l12.117">       this._cleanup();</span>
<a href="#l12.118"></a><span id="l12.118">       var errorMsg = getStringBundle(</span>
<a href="#l12.119"></a><span id="l12.119">           &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l12.120"></a><span id="l12.120">           .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.121"></a><span id="l12.121">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.122"></a><span id="l12.122">     }</span>
<a href="#l12.123"></a><span id="l12.123">     // Try other variations, unless there's a cert error, in which</span>
<a href="#l12.124"></a><span id="l12.124">     // case we'll see what the user chooses.</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-    else if (!this.mCertError)</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-    {</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-      this.tryNextLogon()</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+    else if (!this.mCertError) {</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+      this.tryNextLogon();</span>
<a href="#l12.130"></a><span id="l12.130">     }</span>
<a href="#l12.131"></a><span id="l12.131">   },</span>
<a href="#l12.132"></a><span id="l12.132"> </span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-  tryNextLogon: function()</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-  {</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  tryNextLogon() {</span>
<a href="#l12.136"></a><span id="l12.136">     this._log.info(&quot;tryNextLogon()&quot;);</span>
<a href="#l12.137"></a><span id="l12.137">     this._log.info(&quot;  username=&quot; + (this.mConfig.incoming.username !=</span>
<a href="#l12.138"></a><span id="l12.138">                           this.mConfig.identity.emailAddress) +</span>
<a href="#l12.139"></a><span id="l12.139">                           &quot;, have savedUsername=&quot; +</span>
<a href="#l12.140"></a><span id="l12.140">                           (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l12.141"></a><span id="l12.141">     this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l12.142"></a><span id="l12.142">     // check if we tried full email address as username</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-    if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress)</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-    {</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+    if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress) {</span>
<a href="#l12.146"></a><span id="l12.146">       this._log.info(&quot;  Changing username to email address.&quot;);</span>
<a href="#l12.147"></a><span id="l12.147">       this.mConfig.usernameSaved = this.mConfig.incoming.username;</span>
<a href="#l12.148"></a><span id="l12.148">       this.mConfig.incoming.username = this.mConfig.identity.emailAddress;</span>
<a href="#l12.149"></a><span id="l12.149">       this.mConfig.outgoing.username = this.mConfig.identity.emailAddress;</span>
<a href="#l12.150"></a><span id="l12.150">       this.mServer.username = this.mConfig.incoming.username;</span>
<a href="#l12.151"></a><span id="l12.151">       this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l12.152"></a><span id="l12.152">       verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l12.153"></a><span id="l12.153">                   this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l12.154"></a><span id="l12.154">       return;</span>
<a href="#l12.155"></a><span id="l12.155">     }</span>
<a href="#l12.156"></a><span id="l12.156"> </span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-    if (this.mConfig.usernameSaved)</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-    {</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+    if (this.mConfig.usernameSaved) {</span>
<a href="#l12.160"></a><span id="l12.160">       this._log.info(&quot;  Re-setting username.&quot;);</span>
<a href="#l12.161"></a><span id="l12.161">       // If we tried the full email address as the username, then let's go</span>
<a href="#l12.162"></a><span id="l12.162">       // back to trying just the username before trying the other cases.</span>
<a href="#l12.163"></a><span id="l12.163">       this.mConfig.incoming.username = this.mConfig.usernameSaved;</span>
<a href="#l12.164"></a><span id="l12.164">       this.mConfig.outgoing.username = this.mConfig.usernameSaved;</span>
<a href="#l12.165"></a><span id="l12.165">       this.mConfig.usernameSaved = null;</span>
<a href="#l12.166"></a><span id="l12.166">       this.mServer.username = this.mConfig.incoming.username;</span>
<a href="#l12.167"></a><span id="l12.167">       this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineat">@@ -272,70 +258,68 @@ urlListener.prototype =</span>
<a href="#l12.169"></a><span id="l12.169"> </span>
<a href="#l12.170"></a><span id="l12.170">     // Tried all variations we can. Give up.</span>
<a href="#l12.171"></a><span id="l12.171">     this._log.info(&quot;Giving up.&quot;);</span>
<a href="#l12.172"></a><span id="l12.172">     this._cleanup();</span>
<a href="#l12.173"></a><span id="l12.173">     let errorMsg = getStringBundle(</span>
<a href="#l12.174"></a><span id="l12.174">         &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l12.175"></a><span id="l12.175">         .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.176"></a><span id="l12.176">     this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-    return;</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+</span>
<a href="#l12.179"></a><span id="l12.179">   },</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-  _cleanup : function()</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-  {</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+  _cleanup() {</span>
<a href="#l12.184"></a><span id="l12.184">     try {</span>
<a href="#l12.185"></a><span id="l12.185">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l12.186"></a><span id="l12.186">       if (this.mServer) {</span>
<a href="#l12.187"></a><span id="l12.187">         MailServices.accounts.removeIncomingServer(this.mServer, true);</span>
<a href="#l12.188"></a><span id="l12.188">         this.mServer = null;</span>
<a href="#l12.189"></a><span id="l12.189">       }</span>
<a href="#l12.190"></a><span id="l12.190">     } catch (e) { this._log.error(e); }</span>
<a href="#l12.191"></a><span id="l12.191">   },</span>
<a href="#l12.192"></a><span id="l12.192"> </span>
<a href="#l12.193"></a><span id="l12.193">   // Suppress any certificate errors</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-  notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l12.196"></a><span id="l12.196">     this.mCertError = true;</span>
<a href="#l12.197"></a><span id="l12.197">     this._log.error(&quot;cert error&quot;);</span>
<a href="#l12.198"></a><span id="l12.198">     let self = this;</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-    setTimeout(function () {</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+    setTimeout(function() {</span>
<a href="#l12.201"></a><span id="l12.201">       try {</span>
<a href="#l12.202"></a><span id="l12.202">         self.informUserOfCertError(socketInfo, status, targetSite);</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-      } catch (e)  { logException(e); }</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+      } catch (e) { logException(e); }</span>
<a href="#l12.205"></a><span id="l12.205">     }, 0);</span>
<a href="#l12.206"></a><span id="l12.206">     return true;</span>
<a href="#l12.207"></a><span id="l12.207">   },</span>
<a href="#l12.208"></a><span id="l12.208"> </span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-  informUserOfCertError : function(socketInfo, status, targetSite) {</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  informUserOfCertError(socketInfo, status, targetSite) {</span>
<a href="#l12.211"></a><span id="l12.211">     var params = {</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-      exceptionAdded : false,</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-      sslStatus : status,</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-      prefetchCert : true,</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-      location : targetSite,</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+      exceptionAdded: false,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+      sslStatus: status,</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      prefetchCert: true,</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+      location: targetSite,</span>
<a href="#l12.220"></a><span id="l12.220">     };</span>
<a href="#l12.221"></a><span id="l12.221">     window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-                      &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+                      &quot;&quot;, &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l12.224"></a><span id="l12.224">     this._log.info(&quot;cert exception dialog closed&quot;);</span>
<a href="#l12.225"></a><span id="l12.225">     this._log.info(&quot;cert exceptionAdded = &quot; + params.exceptionAdded);</span>
<a href="#l12.226"></a><span id="l12.226">     if (!params.exceptionAdded) {</span>
<a href="#l12.227"></a><span id="l12.227">       this._cleanup();</span>
<a href="#l12.228"></a><span id="l12.228">       let errorMsg = getStringBundle(</span>
<a href="#l12.229"></a><span id="l12.229">           &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l12.230"></a><span id="l12.230">           .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.231"></a><span id="l12.231">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-    }</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-    else {</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    } else {</span>
<a href="#l12.235"></a><span id="l12.235">       // Retry the logon now that we've added the cert exception.</span>
<a href="#l12.236"></a><span id="l12.236">       verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l12.237"></a><span id="l12.237">                   this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l12.238"></a><span id="l12.238">     }</span>
<a href="#l12.239"></a><span id="l12.239">   },</span>
<a href="#l12.240"></a><span id="l12.240"> </span>
<a href="#l12.241"></a><span id="l12.241">   // nsIInterfaceRequestor</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-  getInterface: function(iid) {</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+  getInterface(iid) {</span>
<a href="#l12.244"></a><span id="l12.244">     return this.QueryInterface(iid);</span>
<a href="#l12.245"></a><span id="l12.245">   },</span>
<a href="#l12.246"></a><span id="l12.246"> </span>
<a href="#l12.247"></a><span id="l12.247">   // nsISupports</span>
<a href="#l12.248"></a><span id="l12.248">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBadCertListener2&quot;,</span>
<a href="#l12.249"></a><span id="l12.249">                                           &quot;nsIInterfaceRequestor&quot;,</span>
<a href="#l12.250"></a><span id="l12.250">                                           &quot;nsIUrlListener&quot;]),</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-}</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

