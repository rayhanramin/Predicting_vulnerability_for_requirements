<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26839:ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3" />
<meta property="og:url" content="/comm-central/rev/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3" />
<meta property="og:description" content="Bug 1557501 - C-C part: Adapt to array changes in nsIPrefBranch. r=jorgk,bz" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">shortlog</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">files</a> |
changeset |
<a href="/comm-central/raw-rev/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">raw</a>  | <a href="/comm-central/archive/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1557501">Bug 1557501</a> - C-C part: Adapt to array changes in nsIPrefBranch. r=jorgk,bz
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#111;&#114;&#105;&#115;&#32;&#90;&#98;&#97;&#114;&#115;&#107;&#121;&#32;&#60;&#98;&#122;&#98;&#97;&#114;&#115;&#107;&#121;&#64;&#109;&#105;&#116;&#46;&#101;&#100;&#117;&#62;&#32;&#97;&#110;&#100;&#32;&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 07 Jun 2019 18:29:13 +0200</td></tr>

<tr>
 <td>changeset 26839</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3</a></td>
</tr>



<tr>
<td>parent 26838</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e24c0dd786996801f0a36f4787043aa2b18b30c3">e24c0dd786996801f0a36f4787043aa2b18b30c3</a>
</td>
</tr>

<tr>
<td>child 26840</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d00844c4eba4bd98a20376942673520047193337">d00844c4eba4bd98a20376942673520047193337</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">16020</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 07 Jun 2019 16:36:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ffde4bb2fe1b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&newProject=comm-central&newRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&newProject=comm-central&newRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&newProject=comm-central&newRevision=ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28bz%29&revcount=50">bz</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1557501">1557501</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1557501">Bug 1557501</a> - C-C part: Adapt to array changes in nsIPrefBranch. r=jorgk,bz</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">editor/ui/composer/content/publishprefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/editor/ui/composer/content/publishprefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">mail/components/cloudfile/cloudFileAccounts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/cloudfile/cloudFileAccounts.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">mailnews/addrbook/src/nsAbLDAPAttributeMap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">mailnews/base/src/nsMsgTagService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/base/src/nsMsgTagService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">suite/components/profile/nsNetscapeProfileMigratorBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">file</a> |
<a href="/comm-central/annotate/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">annotate</a> |
<a href="/comm-central/diff/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">diff</a> |
<a href="/comm-central/comparison/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">comparison</a> |
<a href="/comm-central/log/ffde4bb2fe1bbca3a4b9ecd027032c1b90f0c5d3/suite/components/profile/nsNetscapeProfileMigratorBase.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/editor/ui/composer/content/publishprefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/editor/ui/composer/content/publishprefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -245,28 +245,27 @@ function GetPublishData_internal(publish</span>
<a href="#l1.4"></a><span id="l1.4">     publishData.savePassword = true;</span>
<a href="#l1.5"></a><span id="l1.5">   }</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   // Build history list of directories</span>
<a href="#l1.8"></a><span id="l1.8">   // Always supply the root dir</span>
<a href="#l1.9"></a><span id="l1.9">   publishData.dirList = [&quot;&quot;];</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   // Get the rest from prefs</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  var dirCount = {value:0};</span>
<a href="#l1.13"></a><span id="l1.13">   var dirPrefs;</span>
<a href="#l1.14"></a><span id="l1.14">   try {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    dirPrefs = publishBranch.getChildList(prefPrefix+&quot;dir.&quot;, dirCount);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    dirPrefs = publishBranch.getChildList(prefPrefix+&quot;dir.&quot;);</span>
<a href="#l1.17"></a><span id="l1.17">   } catch (e) {}</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  if (dirPrefs &amp;&amp; dirCount.value &gt; 0)</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+  if (dirPrefs &amp;&amp; dirPrefs.length &gt; 0)</span>
<a href="#l1.21"></a><span id="l1.21">   {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    if (dirCount.value &gt; 1)</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    if (dirPrefs.length &gt; 1)</span>
<a href="#l1.24"></a><span id="l1.24">       dirPrefs.sort();</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    for (var j = 0; j &lt; dirCount.value; j++)</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    for (var j = 0; j &lt; dirPrefs.length; j++)</span>
<a href="#l1.28"></a><span id="l1.28">     {</span>
<a href="#l1.29"></a><span id="l1.29">       var dirName = GetPublishStringPref(publishBranch, dirPrefs[j]);</span>
<a href="#l1.30"></a><span id="l1.30">       if (dirName)</span>
<a href="#l1.31"></a><span id="l1.31">         publishData.dirList[j+1] = dirName;</span>
<a href="#l1.32"></a><span id="l1.32">     }</span>
<a href="#l1.33"></a><span id="l1.33">   }</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">   return publishData;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineat">@@ -322,36 +321,35 @@ function SavePublishDataToPrefs(publishD</span>
<a href="#l1.37"></a><span id="l1.37">   var publishBranch = GetPublishPrefsBranch();</span>
<a href="#l1.38"></a><span id="l1.38">   if (!publishBranch)</span>
<a href="#l1.39"></a><span id="l1.39">     return false;</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41">   // Create name from URL if no site name is provided</span>
<a href="#l1.42"></a><span id="l1.42">   if (!publishData.siteName)</span>
<a href="#l1.43"></a><span id="l1.43">     publishData.siteName = CreateSiteNameFromUrl(publishData.publishUrl, publishData);</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  var siteCount = {value:0};</span>
<a href="#l1.46"></a><span id="l1.46">   var siteNamePrefs;</span>
<a href="#l1.47"></a><span id="l1.47">   try {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    siteNamePrefs = publishBranch.getChildList(&quot;site_name.&quot;, siteCount);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    siteNamePrefs = publishBranch.getChildList(&quot;site_name.&quot;);</span>
<a href="#l1.50"></a><span id="l1.50">   } catch (e) {}</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  if (!siteNamePrefs || siteCount.value == 0)</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  if (!siteNamePrefs || siteNamePrefs.length == 0)</span>
<a href="#l1.54"></a><span id="l1.54">   {</span>
<a href="#l1.55"></a><span id="l1.55">     // We currently have no site prefs, so create them</span>
<a href="#l1.56"></a><span id="l1.56">     var siteData = [publishData];</span>
<a href="#l1.57"></a><span id="l1.57">     return SavePublishSiteDataToPrefs(siteData, publishData.siteName);</span>
<a href="#l1.58"></a><span id="l1.58">   }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60">   // Use &quot;previous&quot; name if available in case it was changed</span>
<a href="#l1.61"></a><span id="l1.61">   var previousSiteName =  (&quot;previousSiteName&quot; in publishData &amp;&amp; publishData.previousSiteName) ?</span>
<a href="#l1.62"></a><span id="l1.62">                             publishData.previousSiteName : publishData.siteName;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">   // Find site number of existing site or fall through at next available one</span>
<a href="#l1.65"></a><span id="l1.65">   // (Number is arbitrary; needed to construct unique &quot;site_name.x&quot; pref string)</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  for (var i = 0; i &lt; siteCount.value; i++)</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  for (var i = 0; i &lt; siteNamePrefs.length; i++)</span>
<a href="#l1.68"></a><span id="l1.68">   {</span>
<a href="#l1.69"></a><span id="l1.69">     var siteName = GetPublishStringPref(publishBranch, &quot;site_name.&quot;+i);</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71">     if (siteName == previousSiteName)</span>
<a href="#l1.72"></a><span id="l1.72">     {</span>
<a href="#l1.73"></a><span id="l1.73">       // Delete prefs for an existing site</span>
<a href="#l1.74"></a><span id="l1.74">       try {</span>
<a href="#l1.75"></a><span id="l1.75">         publishBranch.deleteBranch(&quot;site_data.&quot; + siteName + &quot;.&quot;);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineat">@@ -554,38 +552,37 @@ function GetPublishPrefsBranch()</span>
<a href="#l1.77"></a><span id="l1.77"> }</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79"> function GetSiteNameList(doSort, defaultFirst)</span>
<a href="#l1.80"></a><span id="l1.80"> {</span>
<a href="#l1.81"></a><span id="l1.81">   var publishBranch = GetPublishPrefsBranch();</span>
<a href="#l1.82"></a><span id="l1.82">   if (!publishBranch)</span>
<a href="#l1.83"></a><span id="l1.83">     return null;</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  var siteCountObj = {value:0};</span>
<a href="#l1.86"></a><span id="l1.86">   var siteNamePrefs;</span>
<a href="#l1.87"></a><span id="l1.87">   try {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    siteNamePrefs = publishBranch.getChildList(&quot;site_name.&quot;, siteCountObj);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    siteNamePrefs = publishBranch.getChildList(&quot;site_name.&quot;);</span>
<a href="#l1.90"></a><span id="l1.90">   } catch (e) {}</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-  if (!siteNamePrefs || siteCountObj.value == 0)</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  if (!siteNamePrefs || siteNamePrefs.length == 0)</span>
<a href="#l1.94"></a><span id="l1.94">     return null;</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">   // Array of site names</span>
<a href="#l1.97"></a><span id="l1.97">   var siteNameList = [];</span>
<a href="#l1.98"></a><span id="l1.98">   var index = 0;</span>
<a href="#l1.99"></a><span id="l1.99">   var defaultName = &quot;&quot;;</span>
<a href="#l1.100"></a><span id="l1.100">   if (defaultFirst)</span>
<a href="#l1.101"></a><span id="l1.101">   {</span>
<a href="#l1.102"></a><span id="l1.102">     defaultName = GetPublishStringPref(publishBranch, &quot;default_site&quot;);</span>
<a href="#l1.103"></a><span id="l1.103">     // This always sorts to top -- replace with real string below</span>
<a href="#l1.104"></a><span id="l1.104">     siteNameList[0] = &quot;&quot;;</span>
<a href="#l1.105"></a><span id="l1.105">     index++;</span>
<a href="#l1.106"></a><span id="l1.106">   }</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  for (var i = 0; i &lt; siteCountObj.value; i++)</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+  for (var i = 0; i &lt; siteNamePrefs.length; i++)</span>
<a href="#l1.110"></a><span id="l1.110">   {</span>
<a href="#l1.111"></a><span id="l1.111">     var siteName = GetPublishStringPref(publishBranch, siteNamePrefs[i]);</span>
<a href="#l1.112"></a><span id="l1.112">     // Skip if siteName pref is empty or is default name</span>
<a href="#l1.113"></a><span id="l1.113">     if (siteName &amp;&amp; siteName != defaultName)</span>
<a href="#l1.114"></a><span id="l1.114">     {</span>
<a href="#l1.115"></a><span id="l1.115">       siteNameList[index] = siteName;</span>
<a href="#l1.116"></a><span id="l1.116">       index++;</span>
<a href="#l1.117"></a><span id="l1.117">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -27,17 +27,17 @@ var cloudFileAccounts = new class extend</span>
<a href="#l2.4"></a><span id="l2.4">     this._providers = new Map();</span>
<a href="#l2.5"></a><span id="l2.5">     this._accounts = new Map();</span>
<a href="#l2.6"></a><span id="l2.6">     this._highestOrdinal = 0;</span>
<a href="#l2.7"></a><span id="l2.7">   }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   get _accountKeys() {</span>
<a href="#l2.10"></a><span id="l2.10">     let accountKeySet = new Set();</span>
<a href="#l2.11"></a><span id="l2.11">     let branch = Services.prefs.getBranch(ACCOUNT_ROOT);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let children = branch.getChildList(&quot;&quot;, {});</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let children = branch.getChildList(&quot;&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">     for (let child of children) {</span>
<a href="#l2.15"></a><span id="l2.15">       let subbranch = child.substr(0, child.indexOf(&quot;.&quot;));</span>
<a href="#l2.16"></a><span id="l2.16">       accountKeySet.add(subbranch);</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">       let match = /^account(\d+)$/.exec(subbranch);</span>
<a href="#l2.19"></a><span id="l2.19">       if (match) {</span>
<a href="#l2.20"></a><span id="l2.20">         let ordinal = parseInt(match[1], 10);</span>
<a href="#l2.21"></a><span id="l2.21">         this._highestOrdinal = Math.max(this._highestOrdinal, ordinal);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -589,50 +589,49 @@ nsresult nsSeamonkeyProfileMigrator::Cop</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> void nsSeamonkeyProfileMigrator::ReadBranch(const char* branchName,</span>
<a href="#l3.6"></a><span id="l3.6">                                             nsIPrefService* aPrefService,</span>
<a href="#l3.7"></a><span id="l3.7">                                             PBStructArray&amp; aPrefs) {</span>
<a href="#l3.8"></a><span id="l3.8">   // Enumerate the branch</span>
<a href="#l3.9"></a><span id="l3.9">   nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l3.10"></a><span id="l3.10">   aPrefService-&gt;GetBranch(branchName, getter_AddRefs(branch));</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  uint32_t count;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  char** prefs = nullptr;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  nsresult rv = branch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;prefs);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  nsTArray&lt;nsCString&gt; prefs;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  nsresult rv = branch-&gt;GetChildList(&quot;&quot;, prefs);</span>
<a href="#l3.17"></a><span id="l3.17">   if (NS_FAILED(rv)) return;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  for (auto&amp; pref : prefs) {</span>
<a href="#l3.21"></a><span id="l3.21">     // Save each pref's value into an array</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    char* currPref = prefs[i];</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    char* currPref = moz_xstrdup(pref.get());</span>
<a href="#l3.24"></a><span id="l3.24">     int32_t type;</span>
<a href="#l3.25"></a><span id="l3.25">     branch-&gt;GetPrefType(currPref, &amp;type);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    PrefBranchStruct* pref = new PrefBranchStruct;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    pref-&gt;prefName = currPref;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    pref-&gt;type = type;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+    PrefBranchStruct* prefBranch = new PrefBranchStruct;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    prefBranch-&gt;prefName = currPref;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    prefBranch-&gt;type = type;</span>
<a href="#l3.32"></a><span id="l3.32">     switch (type) {</span>
<a href="#l3.33"></a><span id="l3.33">       case nsIPrefBranch::PREF_STRING: {</span>
<a href="#l3.34"></a><span id="l3.34">         nsCString str;</span>
<a href="#l3.35"></a><span id="l3.35">         rv = branch-&gt;GetCharPref(currPref, str);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-        pref-&gt;stringValue = moz_xstrdup(str.get());</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        prefBranch-&gt;stringValue = moz_xstrdup(str.get());</span>
<a href="#l3.38"></a><span id="l3.38">         break;</span>
<a href="#l3.39"></a><span id="l3.39">       }</span>
<a href="#l3.40"></a><span id="l3.40">       case nsIPrefBranch::PREF_BOOL:</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-        rv = branch-&gt;GetBoolPref(currPref, &amp;pref-&gt;boolValue);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+        rv = branch-&gt;GetBoolPref(currPref, &amp;prefBranch-&gt;boolValue);</span>
<a href="#l3.43"></a><span id="l3.43">         break;</span>
<a href="#l3.44"></a><span id="l3.44">       case nsIPrefBranch::PREF_INT:</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-        rv = branch-&gt;GetIntPref(currPref, &amp;pref-&gt;intValue);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+        rv = branch-&gt;GetIntPref(currPref, &amp;prefBranch-&gt;intValue);</span>
<a href="#l3.47"></a><span id="l3.47">         break;</span>
<a href="#l3.48"></a><span id="l3.48">       default:</span>
<a href="#l3.49"></a><span id="l3.49">         NS_WARNING(</span>
<a href="#l3.50"></a><span id="l3.50">             &quot;Invalid Pref Type in &quot;</span>
<a href="#l3.51"></a><span id="l3.51">             &quot;nsNetscapeProfileMigratorBase::ReadBranch\n&quot;);</span>
<a href="#l3.52"></a><span id="l3.52">         break;</span>
<a href="#l3.53"></a><span id="l3.53">     }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    if (NS_SUCCEEDED(rv)) aPrefs.AppendElement(pref);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    if (NS_SUCCEEDED(rv)) aPrefs.AppendElement(prefBranch);</span>
<a href="#l3.57"></a><span id="l3.57">   }</span>
<a href="#l3.58"></a><span id="l3.58"> }</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60"> void nsSeamonkeyProfileMigrator::WriteBranch(const char* branchName,</span>
<a href="#l3.61"></a><span id="l3.61">                                              nsIPrefService* aPrefService,</span>
<a href="#l3.62"></a><span id="l3.62">                                              PBStructArray&amp; aPrefs) {</span>
<a href="#l3.63"></a><span id="l3.63">   // Enumerate the branch</span>
<a href="#l3.64"></a><span id="l3.64">   nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -108,18 +108,17 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">     return props;</span>
<a href="#l4.5"></a><span id="l4.5">   },</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   setFromPrefs(aPrefBranchName) {</span>
<a href="#l4.8"></a><span id="l4.8">     // get the right pref branch</span>
<a href="#l4.9"></a><span id="l4.9">     let branch = Services.prefs.getBranch(aPrefBranchName + &quot;.&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     // get the list of children</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    var childCount = {};</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    var children = branch.getChildList(&quot;&quot;, childCount);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    var children = branch.getChildList(&quot;&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">     // do the actual sets</span>
<a href="#l4.17"></a><span id="l4.17">     for (var child of children) {</span>
<a href="#l4.18"></a><span id="l4.18">       this.setAttributeList(child, branch.getCharPref(child), true);</span>
<a href="#l4.19"></a><span id="l4.19">     }</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">     // ensure that everything is kosher</span>
<a href="#l4.22"></a><span id="l4.22">     this.checkState();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -74,42 +74,37 @@ NS_IMETHODIMP nsAbMDBDirectory::Init(con</span>
<a href="#l5.4"></a><span id="l5.4">         do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.5"></a><span id="l5.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l5.8"></a><span id="l5.8">     rv = prefService-&gt;GetBranch(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">                                 getter_AddRefs(prefBranch));</span>
<a href="#l5.10"></a><span id="l5.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    char **childArray;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    uint32_t childCount, i;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    nsTArray&lt;nsCString&gt; childArray;</span>
<a href="#l5.15"></a><span id="l5.15">     int32_t dotOffset;</span>
<a href="#l5.16"></a><span id="l5.16">     nsCString childValue;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    nsDependentCString child;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    rv = prefBranch-&gt;GetChildList(&quot;&quot;, &amp;childCount, &amp;childArray);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+    rv = prefBranch-&gt;GetChildList(&quot;&quot;, childArray);</span>
<a href="#l5.21"></a><span id="l5.21">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    for (i = 0; i &lt; childCount; ++i) {</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-      child.Assign(childArray[i]);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    for (auto &amp;child : childArray) {</span>
<a href="#l5.27"></a><span id="l5.27">       if (StringEndsWith(child, NS_LITERAL_CSTRING(&quot;.filename&quot;))) {</span>
<a href="#l5.28"></a><span id="l5.28">         if (NS_SUCCEEDED(prefBranch-&gt;GetCharPref(child.get(), childValue))) {</span>
<a href="#l5.29"></a><span id="l5.29">           if (childValue == filename) {</span>
<a href="#l5.30"></a><span id="l5.30">             dotOffset = child.RFindChar('.');</span>
<a href="#l5.31"></a><span id="l5.31">             if (dotOffset != -1) {</span>
<a href="#l5.32"></a><span id="l5.32">               nsAutoCString prefName(StringHead(child, dotOffset));</span>
<a href="#l5.33"></a><span id="l5.33">               m_DirPrefId.AssignLiteral(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;);</span>
<a href="#l5.34"></a><span id="l5.34">               m_DirPrefId.Append(prefName);</span>
<a href="#l5.35"></a><span id="l5.35">             }</span>
<a href="#l5.36"></a><span id="l5.36">           }</span>
<a href="#l5.37"></a><span id="l5.37">         }</span>
<a href="#l5.38"></a><span id="l5.38">       }</span>
<a href="#l5.39"></a><span id="l5.39">     }</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(childCount, childArray);</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     NS_ASSERTION(!m_DirPrefId.IsEmpty(),</span>
<a href="#l5.43"></a><span id="l5.43">                  &quot;Error, Could not set m_DirPrefId in nsAbMDBDirectory::Init&quot;);</span>
<a href="#l5.44"></a><span id="l5.44">   }</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46">   return nsAbDirProperty::Init(aUri);</span>
<a href="#l5.47"></a><span id="l5.47"> }</span>
<a href="#l5.48"></a><span id="l5.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -629,84 +629,91 @@ static void DIR_DeleteServerList(nsTArra</span>
<a href="#l6.4"></a><span id="l6.4">     delete wholeList;</span>
<a href="#l6.5"></a><span id="l6.5">   }</span>
<a href="#l6.6"></a><span id="l6.6"> }</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> /*****************************************************************************</span>
<a href="#l6.9"></a><span id="l6.9">  * Functions for managing JavaScript prefs for the DIR_Servers</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-static int comparePrefArrayMembers(const void *aElement1, const void *aElement2,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                   void *aData) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  const char *element1 = *static_cast&lt;const char *const *&gt;(aElement1);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  const char *element2 = *static_cast&lt;const char *const *&gt;(aElement2);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  const uint32_t offset = *((const uint32_t *)aData);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+class MOZ_STACK_CLASS PrefArrayMemberComparator {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ public:</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  explicit PrefArrayMemberComparator(uint32_t aOffset) : mOffset(aOffset) {}</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  // begin the comparison at |offset| chars into the string -</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  // begin the comparison at |mOffset| chars into the string -</span>
<a href="#l6.23"></a><span id="l6.23">   // this avoids comparing the &quot;ldap_2.servers.&quot; portion of every element,</span>
<a href="#l6.24"></a><span id="l6.24">   // which will always remain the same.</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  return strcmp(element1 + offset, element2 + offset);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-}</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  bool Equals(const nsCString &amp;aFirst, const nsCString &amp;aSecond) const {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    return Substring(aFirst, mOffset) == Substring(aSecond, mOffset);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  }</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-static nsresult dir_GetChildList(const nsCString &amp;aBranch, uint32_t *aCount,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-                                 char ***aChildList) {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  bool LessThan(const nsCString &amp;aFirst, const nsCString &amp;aSecond) const {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    return Substring(aFirst, mOffset) &lt; Substring(aSecond, mOffset);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  }</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ private:</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  uint32_t mOffset;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+};</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+static nsresult dir_GetChildList(const nsCString &amp;aBranch,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                                 nsTArray&lt;nsCString&gt; &amp;aChildList) {</span>
<a href="#l6.43"></a><span id="l6.43">   uint32_t branchLen = aBranch.Length();</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l6.46"></a><span id="l6.46">   if (!prefBranch) {</span>
<a href="#l6.47"></a><span id="l6.47">     return NS_ERROR_FAILURE;</span>
<a href="#l6.48"></a><span id="l6.48">   }</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  nsresult rv = prefBranch-&gt;GetChildList(aBranch.get(), aCount, aChildList);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  nsresult rv = prefBranch-&gt;GetChildList(aBranch.get(), aChildList);</span>
<a href="#l6.52"></a><span id="l6.52">   if (NS_FAILED(rv)) {</span>
<a href="#l6.53"></a><span id="l6.53">     return rv;</span>
<a href="#l6.54"></a><span id="l6.54">   }</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   // traverse the list, and truncate all the descendant strings to just</span>
<a href="#l6.57"></a><span id="l6.57">   // one branch level below the root branch.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  for (uint32_t i = *aCount; i--;) {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  for (auto &amp;child : aChildList) {</span>
<a href="#l6.60"></a><span id="l6.60">     // The prefname we passed to GetChildList was of the form</span>
<a href="#l6.61"></a><span id="l6.61">     // &quot;ldap_2.servers.&quot; and we are returned the descendants</span>
<a href="#l6.62"></a><span id="l6.62">     // in the form of &quot;ldap_2.servers.servername.foo&quot;</span>
<a href="#l6.63"></a><span id="l6.63">     // But we want the prefbranch of the servername, so</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-    // write a NUL character in to terminate the string early.</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    char *endToken = strchr((*aChildList)[i] + branchLen, '.');</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    if (endToken) *endToken = '\0';</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    // terminate the string at the first '.' after our branchname.</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    int32_t dotPos = child.FindChar('.', branchLen);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+    if (dotPos != kNotFound) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+      child.Truncate(dotPos);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    }</span>
<a href="#l6.72"></a><span id="l6.72">   }</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  if (*aCount &gt; 1) {</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  if (aChildList.Length() &lt; 1) {</span>
<a href="#l6.76"></a><span id="l6.76">     // sort the list, in preparation for duplicate entry removal</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    NS_QuickSort(*aChildList, *aCount, sizeof(char *), comparePrefArrayMembers,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-                 &amp;branchLen);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+    PrefArrayMemberComparator comparator(branchLen);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    aChildList.Sort(comparator);</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82">     // traverse the list and remove duplicate entries.</span>
<a href="#l6.83"></a><span id="l6.83">     // we use two positions in the list; the current entry and the next</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    // entry; and perform a bunch of in-place ptr moves. so |cur| points</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    // entry; and perform a bunch of in-place moves. so |cur| points</span>
<a href="#l6.86"></a><span id="l6.86">     // to the last unique entry, and |next| points to some (possibly much</span>
<a href="#l6.87"></a><span id="l6.87">     // later) entry to test, at any given point. we know we have &gt;= 2</span>
<a href="#l6.88"></a><span id="l6.88">     // elements in the list here, so we just init the two counters sensibly</span>
<a href="#l6.89"></a><span id="l6.89">     // to begin with.</span>
<a href="#l6.90"></a><span id="l6.90">     uint32_t cur = 0;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    for (uint32_t next = 1; next &lt; *aCount; ++next) {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    for (uint32_t next = 1; next &lt; aChildList.Length(); ++next) {</span>
<a href="#l6.93"></a><span id="l6.93">       // check if the elements are equal or unique</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-      if (!comparePrefArrayMembers(&amp;((*aChildList)[cur]),</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-                                   &amp;((*aChildList)[next]), &amp;branchLen)) {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-        // equal - just free &amp; increment the next element ptr</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+      if (comparator.Equals(aChildList[cur], aChildList[next])) {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+        // equal - just increment the next element ptr</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-        free((*aChildList)[next]);</span>
<a href="#l6.101"></a><span id="l6.101">       } else {</span>
<a href="#l6.102"></a><span id="l6.102">         // cur &amp; next are unique, so we need to shift the element.</span>
<a href="#l6.103"></a><span id="l6.103">         // ++cur will point to the next free location in the</span>
<a href="#l6.104"></a><span id="l6.104">         // reduced array (it's okay if that's == next)</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-        (*aChildList)[++cur] = (*aChildList)[next];</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+        aChildList[++cur] = aChildList[next];</span>
<a href="#l6.107"></a><span id="l6.107">       }</span>
<a href="#l6.108"></a><span id="l6.108">     }</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110">     // update the unique element count</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    *aCount = cur + 1;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    aChildList.SetLength(cur + 1);</span>
<a href="#l6.113"></a><span id="l6.113">   }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115">   return NS_OK;</span>
<a href="#l6.116"></a><span id="l6.116"> }</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118"> static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l6.119"></a><span id="l6.119">                                const char *defaultValue) {</span>
<a href="#l6.120"></a><span id="l6.120">   nsresult rv;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineat">@@ -949,43 +956,41 @@ static char *dir_CreateServerPrefName(DI</span>
<a href="#l6.122"></a><span id="l6.122">   if (!leafName || !*leafName) {</span>
<a href="#l6.123"></a><span id="l6.123">     // we need to handle this in case the description has no alphanumeric chars</span>
<a href="#l6.124"></a><span id="l6.124">     // it's very common for cjk users</span>
<a href="#l6.125"></a><span id="l6.125">     leafName = strdup(&quot;_nonascii&quot;);</span>
<a href="#l6.126"></a><span id="l6.126">   }</span>
<a href="#l6.127"></a><span id="l6.127"> </span>
<a href="#l6.128"></a><span id="l6.128">   if (leafName) {</span>
<a href="#l6.129"></a><span id="l6.129">     int32_t uniqueIDCnt = 0;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-    char **children = nullptr;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+    nsTArray&lt;nsCString&gt; children;</span>
<a href="#l6.132"></a><span id="l6.132">     /* we need to verify that this pref string name is unique */</span>
<a href="#l6.133"></a><span id="l6.133">     prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s&quot;, leafName);</span>
<a href="#l6.134"></a><span id="l6.134">     isUnique = false;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    uint32_t prefCount;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    nsresult rv =</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-        dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-                         &amp;prefCount, &amp;children);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    nsresult rv = dir_GetChildList(</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+        NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;), children);</span>
<a href="#l6.141"></a><span id="l6.141">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.142"></a><span id="l6.142">       while (!isUnique &amp;&amp; prefName) {</span>
<a href="#l6.143"></a><span id="l6.143">         isUnique = true; /* now flip the logic and assume we are unique until we</span>
<a href="#l6.144"></a><span id="l6.144">                             find a match */</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-        for (uint32_t i = 0; i &lt; prefCount &amp;&amp; isUnique; ++i) {</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-          if (!PL_strcasecmp(children[i],</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-                             prefName)) /* are they the same branch? */</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+        for (auto &amp;child : children) {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+          if (child.EqualsIgnoreCase(</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+                  prefName)) { /* are they the same branch? */</span>
<a href="#l6.151"></a><span id="l6.151">             isUnique = false;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+            break;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+          }</span>
<a href="#l6.154"></a><span id="l6.154">         }</span>
<a href="#l6.155"></a><span id="l6.155">         if (!isUnique) /* then try generating a new pref name and try again */</span>
<a href="#l6.156"></a><span id="l6.156">         {</span>
<a href="#l6.157"></a><span id="l6.157">           PR_smprintf_free(prefName);</span>
<a href="#l6.158"></a><span id="l6.158">           prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s_%d&quot;, leafName,</span>
<a href="#l6.159"></a><span id="l6.159">                                  ++uniqueIDCnt);</span>
<a href="#l6.160"></a><span id="l6.160">         }</span>
<a href="#l6.161"></a><span id="l6.161">       } /* if we have a list of pref Names */</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-      NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, children);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    } /* while we don't have a unique name */</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    }   /* while we don't have a unique name */</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">     // fallback to &quot;user_directory_N&quot; form if we failed to verify</span>
<a href="#l6.168"></a><span id="l6.168">     if (!isUnique &amp;&amp; prefName) {</span>
<a href="#l6.169"></a><span id="l6.169">       PR_smprintf_free(prefName);</span>
<a href="#l6.170"></a><span id="l6.170">       prefName = nullptr;</span>
<a href="#l6.171"></a><span id="l6.171">     }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173">     PR_Free(leafName);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineat">@@ -1043,36 +1048,35 @@ static void DIR_GetPrefsForOneServer(DIR</span>
<a href="#l6.175"></a><span id="l6.175"> static nsresult dir_GetPrefs(nsTArray&lt;DIR_Server *&gt; **list) {</span>
<a href="#l6.176"></a><span id="l6.176">   nsresult rv;</span>
<a href="#l6.177"></a><span id="l6.177">   nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.178"></a><span id="l6.178">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.179"></a><span id="l6.179"> </span>
<a href="#l6.180"></a><span id="l6.180">   (*list) = new nsTArray&lt;DIR_Server *&gt;();</span>
<a href="#l6.181"></a><span id="l6.181">   if (!(*list)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  char **children;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  uint32_t prefCount;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  nsTArray&lt;nsCString&gt; children;</span>
<a href="#l6.186"></a><span id="l6.186"> </span>
<a href="#l6.187"></a><span id="l6.187">   rv = dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-                        &amp;prefCount, &amp;children);</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+                        children);</span>
<a href="#l6.190"></a><span id="l6.190">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192">   /* TBD: Temporary code to read broken &quot;ldap&quot; preferences tree.</span>
<a href="#l6.193"></a><span id="l6.193">    *      Remove line with if statement after M10.</span>
<a href="#l6.194"></a><span id="l6.194">    */</span>
<a href="#l6.195"></a><span id="l6.195">   if (dir_UserId == 0)</span>
<a href="#l6.196"></a><span id="l6.196">     pPref-&gt;GetIntPref(PREF_LDAP_GLOBAL_TREE_NAME &quot;.user_id&quot;, &amp;dir_UserId);</span>
<a href="#l6.197"></a><span id="l6.197"> </span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  for (uint32_t i = 0; i &lt; prefCount; ++i) {</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  for (auto &amp;child : children) {</span>
<a href="#l6.200"></a><span id="l6.200">     DIR_Server *server;</span>
<a href="#l6.201"></a><span id="l6.201"> </span>
<a href="#l6.202"></a><span id="l6.202">     server = (DIR_Server *)PR_Calloc(1, sizeof(DIR_Server));</span>
<a href="#l6.203"></a><span id="l6.203">     if (server) {</span>
<a href="#l6.204"></a><span id="l6.204">       DIR_InitServer(server);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-      server-&gt;prefName = strdup(children[i]);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+      server-&gt;prefName = strdup(child.get());</span>
<a href="#l6.207"></a><span id="l6.207">       DIR_GetPrefsForOneServer(server);</span>
<a href="#l6.208"></a><span id="l6.208">       if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp;</span>
<a href="#l6.209"></a><span id="l6.209">           ((server-&gt;dirType == PABDirectory ||</span>
<a href="#l6.210"></a><span id="l6.210">             server-&gt;dirType == MAPIDirectory ||</span>
<a href="#l6.211"></a><span id="l6.211">             server-&gt;dirType ==</span>
<a href="#l6.212"></a><span id="l6.212">                 FixedQueryLDAPDirectory ||  // this one might go away</span>
<a href="#l6.213"></a><span id="l6.213">             server-&gt;dirType == LDAPDirectory))) {</span>
<a href="#l6.214"></a><span id="l6.214">         if (!dir_IsServerDeleted(server)) {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineat">@@ -1080,18 +1084,16 @@ static nsresult dir_GetPrefs(nsTArray&lt;DI</span>
<a href="#l6.216"></a><span id="l6.216">         } else</span>
<a href="#l6.217"></a><span id="l6.217">           DIR_DeleteServer(server);</span>
<a href="#l6.218"></a><span id="l6.218">       } else {</span>
<a href="#l6.219"></a><span id="l6.219">         DIR_DeleteServer(server);</span>
<a href="#l6.220"></a><span id="l6.220">       }</span>
<a href="#l6.221"></a><span id="l6.221">     }</span>
<a href="#l6.222"></a><span id="l6.222">   }</span>
<a href="#l6.223"></a><span id="l6.223"> </span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, children);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-</span>
<a href="#l6.226"></a><span id="l6.226">   return NS_OK;</span>
<a href="#l6.227"></a><span id="l6.227"> }</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229"> // I don't think we care about locked positions, etc.</span>
<a href="#l6.230"></a><span id="l6.230"> void DIR_SortServersByPosition(nsTArray&lt;DIR_Server *&gt; *serverList) {</span>
<a href="#l6.231"></a><span id="l6.231">   int i, j;</span>
<a href="#l6.232"></a><span id="l6.232">   DIR_Server *server;</span>
<a href="#l6.233"></a><span id="l6.233"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -250,37 +250,33 @@ void nsMsgAccountManager::getUniqueAccou</span>
<a href="#l7.4"></a><span id="l7.4">     rv = prefBranch-&gt;GetIntPref(&quot;mail.account.lastKey&quot;, &amp;lastKey);</span>
<a href="#l7.5"></a><span id="l7.5">     if (NS_FAILED(rv) || lastKey == 0) {</span>
<a href="#l7.6"></a><span id="l7.6">       // If lastKey pref does not contain a valid value, loop over existing</span>
<a href="#l7.7"></a><span id="l7.7">       // pref names mail.account.* .</span>
<a href="#l7.8"></a><span id="l7.8">       nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchAccount;</span>
<a href="#l7.9"></a><span id="l7.9">       rv = prefservice-&gt;GetBranch(&quot;mail.account.&quot;,</span>
<a href="#l7.10"></a><span id="l7.10">                                   getter_AddRefs(prefBranchAccount));</span>
<a href="#l7.11"></a><span id="l7.11">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        uint32_t prefCount;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        char **prefList;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-        rv = prefBranchAccount-&gt;GetChildList(&quot;&quot;, &amp;prefCount, &amp;prefList);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        nsTArray&lt;nsCString&gt; prefList;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+        rv = prefBranchAccount-&gt;GetChildList(&quot;&quot;, prefList);</span>
<a href="#l7.17"></a><span id="l7.17">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.18"></a><span id="l7.18">           // Pref names are of the format accountX.</span>
<a href="#l7.19"></a><span id="l7.19">           // Find the maximum value of 'X' used so far.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-          for (uint32_t i = 0; i &lt; prefCount; i++) {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-            nsCString prefName;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-            prefName.Assign(prefList[i]);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+          for (auto &amp;prefName : prefList) {</span>
<a href="#l7.24"></a><span id="l7.24">             if (StringBeginsWith(prefName,</span>
<a href="#l7.25"></a><span id="l7.25">                                  NS_LITERAL_CSTRING(ACCOUNT_PREFIX))) {</span>
<a href="#l7.26"></a><span id="l7.26">               int32_t dotPos = prefName.FindChar('.');</span>
<a href="#l7.27"></a><span id="l7.27">               if (dotPos != kNotFound) {</span>
<a href="#l7.28"></a><span id="l7.28">                 nsCString keyString(Substring(prefName, strlen(ACCOUNT_PREFIX),</span>
<a href="#l7.29"></a><span id="l7.29">                                               dotPos - strlen(ACCOUNT_PREFIX)));</span>
<a href="#l7.30"></a><span id="l7.30">                 int32_t thisKey = keyString.ToInteger(&amp;rv);</span>
<a href="#l7.31"></a><span id="l7.31">                 if (NS_SUCCEEDED(rv)) lastKey = std::max(lastKey, thisKey);</span>
<a href="#l7.32"></a><span id="l7.32">               }</span>
<a href="#l7.33"></a><span id="l7.33">             }</span>
<a href="#l7.34"></a><span id="l7.34">           }</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-          NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l7.36"></a><span id="l7.36">         }</span>
<a href="#l7.37"></a><span id="l7.37">       }</span>
<a href="#l7.38"></a><span id="l7.38">     }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">     // Use next available key and store the value in the pref.</span>
<a href="#l7.41"></a><span id="l7.41">     aResult.Assign(ACCOUNT_PREFIX);</span>
<a href="#l7.42"></a><span id="l7.42">     aResult.AppendInt(++lastKey);</span>
<a href="#l7.43"></a><span id="l7.43">     rv = prefBranch-&gt;SetIntPref(&quot;mail.account.lastKey&quot;, lastKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -24,22 +24,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #define TAG_PREF_SUFFIX_COLOR &quot;.color&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #define TAG_PREF_SUFFIX_ORDINAL &quot;.ordinal&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #define TAG_CMP_LESSER -1</span>
<a href="#l8.7"></a><span id="l8.7"> #define TAG_CMP_EQUAL 0</span>
<a href="#l8.8"></a><span id="l8.8"> #define TAG_CMP_GREATER 1</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> static bool gMigratingKeys = false;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-// comparison functions for nsQuickSort</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-static int CompareMsgTagKeys(const void *aTagPref1, const void *aTagPref2) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  return strcmp(*static_cast&lt;const char *const *&gt;(aTagPref1),</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-                *static_cast&lt;const char *const *&gt;(aTagPref2));</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-}</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-</span>
<a href="#l8.18"></a><span id="l8.18"> static int CompareMsgTags(const void *aTagPref1, const void *aTagPref2) {</span>
<a href="#l8.19"></a><span id="l8.19">   // Sort nsMsgTag objects by ascending order, using their ordinal or key.</span>
<a href="#l8.20"></a><span id="l8.20">   // The &quot;smallest&quot; value will be first in the sorted array,</span>
<a href="#l8.21"></a><span id="l8.21">   // thus being the most important element.</span>
<a href="#l8.22"></a><span id="l8.22">   nsMsgTag *element1 = *(nsMsgTag **)aTagPref1;</span>
<a href="#l8.23"></a><span id="l8.23">   nsMsgTag *element2 = *(nsMsgTag **)aTagPref2;</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   // if we have only one element, it wins</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineat">@@ -126,36 +120,36 @@ NS_IMETHODIMP nsMsgTagService::SetTagFor</span>
<a href="#l8.27"></a><span id="l8.27">   ToLowerCase(prefName);</span>
<a href="#l8.28"></a><span id="l8.28">   prefName.AppendLiteral(TAG_PREF_SUFFIX_TAG);</span>
<a href="#l8.29"></a><span id="l8.29">   return SetUnicharPref(prefName.get(), tag);</span>
<a href="#l8.30"></a><span id="l8.30"> }</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> /* void getKeyForTag (in wstring tag); */</span>
<a href="#l8.33"></a><span id="l8.33"> NS_IMETHODIMP nsMsgTagService::GetKeyForTag(const nsAString &amp;aTag,</span>
<a href="#l8.34"></a><span id="l8.34">                                             nsACString &amp;aKey) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  uint32_t count;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  char **prefList;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  nsresult rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;prefList);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  nsTArray&lt;nsCString&gt; prefList;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  nsresult rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, prefList);</span>
<a href="#l8.40"></a><span id="l8.40">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.41"></a><span id="l8.41">   // traverse the list, and look for a pref with the desired tag value.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  for (uint32_t i = count; i--;) {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  // XXXbz is there a good reason to reverse the list here, or did the</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  // old code do it just to be clever and save some characters in the</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  // for loop header?</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  for (auto &amp;prefName : mozilla::Reversed(prefList)) {</span>
<a href="#l8.47"></a><span id="l8.47">     // We are returned the tag prefs in the form &quot;&lt;key&gt;.&lt;tag_data_type&gt;&quot;, but</span>
<a href="#l8.48"></a><span id="l8.48">     // since we only want the tags, just check that the string ends with &quot;tag&quot;.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    nsDependentCString prefName(prefList[i]);</span>
<a href="#l8.50"></a><span id="l8.50">     if (StringEndsWith(prefName, NS_LITERAL_CSTRING(TAG_PREF_SUFFIX_TAG))) {</span>
<a href="#l8.51"></a><span id="l8.51">       nsAutoString curTag;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-      GetUnicharPref(prefList[i], curTag);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      GetUnicharPref(prefName.get(), curTag);</span>
<a href="#l8.54"></a><span id="l8.54">       if (aTag.Equals(curTag)) {</span>
<a href="#l8.55"></a><span id="l8.55">         aKey = Substring(prefName, 0,</span>
<a href="#l8.56"></a><span id="l8.56">                          prefName.Length() - STRLEN(TAG_PREF_SUFFIX_TAG));</span>
<a href="#l8.57"></a><span id="l8.57">         break;</span>
<a href="#l8.58"></a><span id="l8.58">       }</span>
<a href="#l8.59"></a><span id="l8.59">     }</span>
<a href="#l8.60"></a><span id="l8.60">   }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, prefList);</span>
<a href="#l8.62"></a><span id="l8.62">   ToLowerCase(aKey);</span>
<a href="#l8.63"></a><span id="l8.63">   return NS_OK;</span>
<a href="#l8.64"></a><span id="l8.64"> }</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> /* ACString getTopKey (in ACString keylist); */</span>
<a href="#l8.67"></a><span id="l8.67"> NS_IMETHODIMP nsMsgTagService::GetTopKey(const nsACString &amp;keyList,</span>
<a href="#l8.68"></a><span id="l8.68">                                          nsACString &amp;_retval) {</span>
<a href="#l8.69"></a><span id="l8.69">   _retval.Truncate();</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineat">@@ -339,67 +333,63 @@ NS_IMETHODIMP nsMsgTagService::GetAllTag</span>
<a href="#l8.71"></a><span id="l8.71">   NS_ENSURE_ARG_POINTER(aTagArray);</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73">   // preset harmless default values</span>
<a href="#l8.74"></a><span id="l8.74">   *aCount = 0;</span>
<a href="#l8.75"></a><span id="l8.75">   *aTagArray = nullptr;</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">   // get the actual tag definitions</span>
<a href="#l8.78"></a><span id="l8.78">   nsresult rv;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  uint32_t prefCount;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  char **prefList;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-  rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, &amp;prefCount, &amp;prefList);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  nsTArray&lt;nsCString&gt; prefList;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  rv = m_tagPrefBranch-&gt;GetChildList(&quot;&quot;, prefList);</span>
<a href="#l8.84"></a><span id="l8.84">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.85"></a><span id="l8.85">   // sort them by key for ease of processing</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  qsort(prefList, prefCount, sizeof(char *), CompareMsgTagKeys);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  prefList.Sort();</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">   // build an array of nsIMsgTag elements from the orderered list</span>
<a href="#l8.90"></a><span id="l8.90">   // it's at max the same size as the preflist, but usually only about half</span>
<a href="#l8.91"></a><span id="l8.91">   nsIMsgTag **tagArray =</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-      (nsIMsgTag **)moz_xmalloc(sizeof(nsIMsgTag *) * prefCount);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+      (nsIMsgTag **)moz_xmalloc(sizeof(nsIMsgTag *) * prefList.Length());</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">   if (!tagArray) {</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l8.97"></a><span id="l8.97">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.98"></a><span id="l8.98">   }</span>
<a href="#l8.99"></a><span id="l8.99">   uint32_t currentTagIndex = 0;</span>
<a href="#l8.100"></a><span id="l8.100">   nsMsgTag *newMsgTag;</span>
<a href="#l8.101"></a><span id="l8.101">   nsString tag;</span>
<a href="#l8.102"></a><span id="l8.102">   nsCString lastKey, color, ordinal;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  for (uint32_t i = prefCount; i--;) {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  for (auto &amp;pref : mozilla::Reversed(prefList)) {</span>
<a href="#l8.105"></a><span id="l8.105">     // extract just the key from &lt;key&gt;.&lt;info=tag|color|ordinal&gt;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    char *info = strrchr(prefList[i], '.');</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    if (info) {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-      nsAutoCString key(Substring(prefList[i], info));</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    int32_t dotLoc = pref.RFindChar('.');</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    if (dotLoc != kNotFound) {</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      auto &amp;key = Substring(pref, 0, dotLoc);</span>
<a href="#l8.112"></a><span id="l8.112">       if (key != lastKey) {</span>
<a href="#l8.113"></a><span id="l8.113">         if (!key.IsEmpty()) {</span>
<a href="#l8.114"></a><span id="l8.114">           // .tag MUST exist (but may be empty)</span>
<a href="#l8.115"></a><span id="l8.115">           rv = GetTagForKey(key, tag);</span>
<a href="#l8.116"></a><span id="l8.116">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.117"></a><span id="l8.117">             // .color MAY exist</span>
<a href="#l8.118"></a><span id="l8.118">             color.Truncate();</span>
<a href="#l8.119"></a><span id="l8.119">             GetColorForKey(key, color);</span>
<a href="#l8.120"></a><span id="l8.120">             // .ordinal MAY exist</span>
<a href="#l8.121"></a><span id="l8.121">             rv = GetOrdinalForKey(key, ordinal);</span>
<a href="#l8.122"></a><span id="l8.122">             if (NS_FAILED(rv)) ordinal.Truncate();</span>
<a href="#l8.123"></a><span id="l8.123">             // store the tag info in our array</span>
<a href="#l8.124"></a><span id="l8.124">             newMsgTag = new nsMsgTag(key, tag, color, ordinal);</span>
<a href="#l8.125"></a><span id="l8.125">             if (!newMsgTag) {</span>
<a href="#l8.126"></a><span id="l8.126">               NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(currentTagIndex, tagArray);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-              NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l8.128"></a><span id="l8.128">               return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.129"></a><span id="l8.129">             }</span>
<a href="#l8.130"></a><span id="l8.130">             NS_ADDREF(tagArray[currentTagIndex++] = newMsgTag);</span>
<a href="#l8.131"></a><span id="l8.131">           }</span>
<a href="#l8.132"></a><span id="l8.132">         }</span>
<a href="#l8.133"></a><span id="l8.133">         lastKey = key;</span>
<a href="#l8.134"></a><span id="l8.134">       }</span>
<a href="#l8.135"></a><span id="l8.135">     }</span>
<a href="#l8.136"></a><span id="l8.136">   }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139">   // sort the non-null entries by ordinal</span>
<a href="#l8.140"></a><span id="l8.140">   qsort(tagArray, currentTagIndex, sizeof(nsMsgTag *), CompareMsgTags);</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142">   // All done, now return the values (the idl's size_is(count) parameter</span>
<a href="#l8.143"></a><span id="l8.143">   // ensures that the array is cut accordingly).</span>
<a href="#l8.144"></a><span id="l8.144">   *aCount = currentTagIndex;</span>
<a href="#l8.145"></a><span id="l8.145">   *aTagArray = tagArray;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -272,48 +272,46 @@ Tokenizer::Tokenizer()</span>
<a href="#l9.4"></a><span id="l9.4">    *</span>
<a href="#l9.5"></a><span id="l9.5">    * Header names in the preference should be all lower case</span>
<a href="#l9.6"></a><span id="l9.6">    *</span>
<a href="#l9.7"></a><span id="l9.7">    * Extensions may also set the maximum length of a token (default is</span>
<a href="#l9.8"></a><span id="l9.8">    * kMaxLengthForToken) by setting the int preference:</span>
<a href="#l9.9"></a><span id="l9.9">    *   &quot;mailnews.bayesian_spam_filter.maxlengthfortoken&quot;</span>
<a href="#l9.10"></a><span id="l9.10">    */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  char** headers;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  uint32_t count;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  nsTArray&lt;nsCString&gt; headers;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16">   // get customized maximum token length</span>
<a href="#l9.17"></a><span id="l9.17">   int32_t maxLengthForToken;</span>
<a href="#l9.18"></a><span id="l9.18">   rv = prefBranch-&gt;GetIntPref(&quot;maxlengthfortoken&quot;, &amp;maxLengthForToken);</span>
<a href="#l9.19"></a><span id="l9.19">   mMaxLengthForToken =</span>
<a href="#l9.20"></a><span id="l9.20">       NS_SUCCEEDED(rv) ? uint32_t(maxLengthForToken) : kMaxLengthForToken;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">   rv = prefs-&gt;GetBranch(&quot;mailnews.bayesian_spam_filter.tokenizeheader.&quot;,</span>
<a href="#l9.23"></a><span id="l9.23">                         getter_AddRefs(prefBranch));</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = prefBranch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;headers);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = prefBranch-&gt;GetChildList(&quot;&quot;, headers);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.28"></a><span id="l9.28">     mCustomHeaderTokenization = true;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    for (auto&amp; header : headers) {</span>
<a href="#l9.31"></a><span id="l9.31">       nsCString value;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-      prefBranch-&gt;GetCharPref(headers[i], value);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+      prefBranch-&gt;GetCharPref(header.get(), value);</span>
<a href="#l9.34"></a><span id="l9.34">       if (value.EqualsLiteral(&quot;false&quot;)) {</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-        mDisabledHeaders.AppendElement(headers[i]);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+        mDisabledHeaders.AppendElement(header);</span>
<a href="#l9.37"></a><span id="l9.37">         continue;</span>
<a href="#l9.38"></a><span id="l9.38">       }</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-      mEnabledHeaders.AppendElement(headers[i]);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      mEnabledHeaders.AppendElement(header);</span>
<a href="#l9.41"></a><span id="l9.41">       if (value.EqualsLiteral(&quot;standard&quot;))</span>
<a href="#l9.42"></a><span id="l9.42">         value.SetIsVoid(true);  // Void means use default delimiter</span>
<a href="#l9.43"></a><span id="l9.43">       else if (value.EqualsLiteral(&quot;full&quot;))</span>
<a href="#l9.44"></a><span id="l9.44">         value.Truncate();  // Empty means add full header</span>
<a href="#l9.45"></a><span id="l9.45">       else</span>
<a href="#l9.46"></a><span id="l9.46">         UnescapeCString(value);</span>
<a href="#l9.47"></a><span id="l9.47">       mEnabledHeadersDelimiters.AppendElement(value);</span>
<a href="#l9.48"></a><span id="l9.48">     }</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-    NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, headers);</span>
<a href="#l9.50"></a><span id="l9.50">   }</span>
<a href="#l9.51"></a><span id="l9.51"> }</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> Tokenizer::~Tokenizer() {}</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55"> inline Token* Tokenizer::get(const char* word) {</span>
<a href="#l9.56"></a><span id="l9.56">   return static_cast&lt;Token*&gt;(TokenHash::get(word));</span>
<a href="#l9.57"></a><span id="l9.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/components/profile/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/components/profile/nsNetscapeProfileMigratorBase.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -512,32 +512,32 @@ void</span>
<a href="#l10.4"></a><span id="l10.4"> nsNetscapeProfileMigratorBase::ReadBranch(const char * branchName,</span>
<a href="#l10.5"></a><span id="l10.5">                                           nsIPrefService* aPrefService,</span>
<a href="#l10.6"></a><span id="l10.6">                                           PBStructArray &amp;aPrefs)</span>
<a href="#l10.7"></a><span id="l10.7"> {</span>
<a href="#l10.8"></a><span id="l10.8">   // Enumerate the branch</span>
<a href="#l10.9"></a><span id="l10.9">   nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l10.10"></a><span id="l10.10">   aPrefService-&gt;GetBranch(branchName, getter_AddRefs(branch));</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  uint32_t count;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  char** prefs = nullptr;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  nsTArray&lt;nsCString&gt; prefs;</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  nsresult rv = branch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;prefs);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  nsresult rv = branch-&gt;GetChildList(&quot;&quot;, prefs);</span>
<a href="#l10.18"></a><span id="l10.18">   if (NS_FAILED(rv))</span>
<a href="#l10.19"></a><span id="l10.19">     return;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  for (auto&amp; pref : prefs) {</span>
<a href="#l10.23"></a><span id="l10.23">     // Save each pref's value into an array</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    char* currPref = prefs[i];</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    char* currPref = moz_xstrdup(pref.get());</span>
<a href="#l10.26"></a><span id="l10.26">     int32_t type;</span>
<a href="#l10.27"></a><span id="l10.27">     branch-&gt;GetPrefType(currPref, &amp;type);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">     PrefBranchStruct* pref = new PrefBranchStruct;</span>
<a href="#l10.30"></a><span id="l10.30">     if (!pref) {</span>
<a href="#l10.31"></a><span id="l10.31">       NS_WARNING(&quot;Could not create new PrefBranchStruct&quot;);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+      free(currPref);</span>
<a href="#l10.33"></a><span id="l10.33">       return;</span>
<a href="#l10.34"></a><span id="l10.34">     }</span>
<a href="#l10.35"></a><span id="l10.35">     pref-&gt;prefName = currPref;</span>
<a href="#l10.36"></a><span id="l10.36">     pref-&gt;type = type;</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38">     switch (type) {</span>
<a href="#l10.39"></a><span id="l10.39">     case nsIPrefBranch::PREF_STRING: {</span>
<a href="#l10.40"></a><span id="l10.40">       nsCString str;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

