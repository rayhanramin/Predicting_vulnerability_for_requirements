<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24494:eddeeab5cd43946438025ab16dbe46248f844ab0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ eddeeab5cd43946438025ab16dbe46248f844ab0" />
<meta property="og:url" content="/comm-central/rev/eddeeab5cd43946438025ab16dbe46248f844ab0" />
<meta property="og:description" content="Bug 1460871 - Add request number for each ldap lookup to avoid adding results from older queries. r=jorgk DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / eddeeab5cd43946438025ab16dbe46248f844ab0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/eddeeab5cd43946438025ab16dbe46248f844ab0">shortlog</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/eddeeab5cd43946438025ab16dbe46248f844ab0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0">files</a> |
changeset |
<a href="/comm-central/raw-rev/eddeeab5cd43946438025ab16dbe46248f844ab0">raw</a>  | <a href="/comm-central/archive/eddeeab5cd43946438025ab16dbe46248f844ab0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1460871">Bug 1460871</a> - Add request number for each ldap lookup to avoid adding results from older queries. r=jorgk DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#97;&#110;&#32;&#72;&#111;&#114;&#97;&#107;&#32;&#60;&#106;&#104;&#111;&#114;&#97;&#107;&#64;&#114;&#101;&#100;&#104;&#97;&#116;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 03 Aug 2018 18:28:16 +0200</td></tr>

<tr>
 <td>changeset 24494</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/eddeeab5cd43946438025ab16dbe46248f844ab0">eddeeab5cd43946438025ab16dbe46248f844ab0</a></td>
</tr>



<tr>
<td>parent 24493</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5d37f39381a374dcd8c39b258c944ac199c0d60c">5d37f39381a374dcd8c39b258c944ac199c0d60c</a>
</td>
</tr>

<tr>
<td>child 24495</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/87fcfb8fc1d48d7c45fbc10e4e23d27ed8b88287">87fcfb8fc1d48d7c45fbc10e4e23d27ed8b88287</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=eddeeab5cd43946438025ab16dbe46248f844ab0">14743</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 16 Aug 2018 09:21:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@eddeeab5cd43 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eddeeab5cd43946438025ab16dbe46248f844ab0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eddeeab5cd43946438025ab16dbe46248f844ab0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&newProject=comm-central&newRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&newProject=comm-central&newRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&newProject=comm-central&newRevision=eddeeab5cd43946438025ab16dbe46248f844ab0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1460871">1460871</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1460871">Bug 1460871</a> - Add request number for each ldap lookup to avoid adding results from older queries. r=jorgk DONTBUILD

The waiting until the query ends and ignoring results could lead to ignoring results from subsequent
lookup. I've removed the code which waited for the all results and replaced it by request number.
Every LDAP operation now has the request number set during creating and its value is compared to the
current request number (static variable). If they don't match the result is ignored in
nsAbQueryLDAPMessageListener::OnLDAPMessage.

MozReview-Commit-ID: 9ShVyHmCNS7</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">ldap/xpcom/public/nsILDAPOperation.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/public/nsILDAPOperation.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">ldap/xpcom/src/nsLDAPOperation.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">ldap/xpcom/src/nsLDAPOperation.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/ldap/xpcom/src/nsLDAPOperation.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">mailnews/addrbook/src/nsAbLDAPListenerBase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">file</a> |
<a href="/comm-central/annotate/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">annotate</a> |
<a href="/comm-central/diff/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">diff</a> |
<a href="/comm-central/comparison/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">comparison</a> |
<a href="/comm-central/log/eddeeab5cd43946438025ab16dbe46248f844ab0/mailnews/addrbook/src/nsAbLDAPListenerBase.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/public/nsILDAPOperation.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/public/nsILDAPOperation.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,16 +47,20 @@ interface nsILDAPOperation : nsISupports</span>
<a href="#l1.4"></a><span id="l1.4">      * @exception NS_ERROR_ILLEGAL_VALUE        a NULL pointer was passed in</span>
<a href="#l1.5"></a><span id="l1.5">      */</span>
<a href="#l1.6"></a><span id="l1.6">     readonly attribute long messageID;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">     /**</span>
<a href="#l1.9"></a><span id="l1.9">      * private parameter (anything caller desires)</span>
<a href="#l1.10"></a><span id="l1.10">      */</span>
<a href="#l1.11"></a><span id="l1.11">     attribute nsISupports closure;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    /**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+     * number of the request for compare that the request is still valid.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+     */</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    attribute unsigned long requestNum;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">     /**</span>
<a href="#l1.18"></a><span id="l1.18">      * No time and/or size limit specified</span>
<a href="#l1.19"></a><span id="l1.19">      */</span>
<a href="#l1.20"></a><span id="l1.20">     const long NO_LIMIT = 0;</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     /**</span>
<a href="#l1.23"></a><span id="l1.23">      * If specified, these arrays of nsILDAPControls are passed into the LDAP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -395,16 +395,29 @@ convertControlArray(nsIArray *aXpcomArra</span>
<a href="#l2.4"></a><span id="l2.4">         }</span>
<a href="#l2.5"></a><span id="l2.5">         ++i;</span>
<a href="#l2.6"></a><span id="l2.6">     }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     *aArray = controls;</span>
<a href="#l2.9"></a><span id="l2.9">     return NS_OK;</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  /* attribute unsigned long requestNum; */</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+NS_IMETHODIMP nsLDAPOperation::GetRequestNum(uint32_t *aRequestNum)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+{</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    *aRequestNum = mRequestNum;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+}</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+NS_IMETHODIMP nsLDAPOperation::SetRequestNum(uint32_t aRequestNum)</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+{</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    mRequestNum = aRequestNum;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+}</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25"> NS_IMETHODIMP</span>
<a href="#l2.26"></a><span id="l2.26"> nsLDAPOperation::SearchExt(const nsACString&amp; aBaseDn, int32_t aScope,</span>
<a href="#l2.27"></a><span id="l2.27">                            const nsACString&amp; aFilter,</span>
<a href="#l2.28"></a><span id="l2.28">                            const nsACString &amp;aAttributes,</span>
<a href="#l2.29"></a><span id="l2.29">                            PRIntervalTime aTimeOut, int32_t aSizeLimit)</span>
<a href="#l2.30"></a><span id="l2.30"> {</span>
<a href="#l2.31"></a><span id="l2.31">     if (!mMessageListener) {</span>
<a href="#l2.32"></a><span id="l2.32">         NS_ERROR(&quot;nsLDAPOperation::SearchExt(): mMessageListener not set&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPOperation.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPOperation.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -32,16 +32,19 @@ class nsLDAPOperation : public nsILDAPOp</span>
<a href="#l3.4"></a><span id="l3.4">     //</span>
<a href="#l3.5"></a><span id="l3.5">     nsLDAPOperation();</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">     /**</span>
<a href="#l3.8"></a><span id="l3.8">      * used to break cycles</span>
<a href="#l3.9"></a><span id="l3.9">      */</span>
<a href="#l3.10"></a><span id="l3.10">     void Clear();</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    // Stores the request number for later check of the operation is still valid</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    uint32_t mRequestNum;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15">   private:</span>
<a href="#l3.16"></a><span id="l3.16">     virtual ~nsLDAPOperation();</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     /**</span>
<a href="#l3.19"></a><span id="l3.19">      * wrapper for ldap_add_ext()</span>
<a href="#l3.20"></a><span id="l3.20">      *</span>
<a href="#l3.21"></a><span id="l3.21">      * XXX should move to idl, once LDAPControls have an IDL representation</span>
<a href="#l3.22"></a><span id="l3.22">      */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -18,16 +18,18 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsCategoryManagerUtils.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsAbLDAPListenerBase.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> using namespace mozilla;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+extern mozilla::LazyLogModule gLDAPLogModule;  // defined in nsLDAPService.cpp</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> // nsAbLDAPListenerBase inherits nsILDAPMessageListener</span>
<a href="#l4.15"></a><span id="l4.15"> class nsAbQueryLDAPMessageListener : public nsAbLDAPListenerBase</span>
<a href="#l4.16"></a><span id="l4.16"> {</span>
<a href="#l4.17"></a><span id="l4.17"> public:</span>
<a href="#l4.18"></a><span id="l4.18">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   // Note that the directoryUrl is the details of the ldap directory</span>
<a href="#l4.21"></a><span id="l4.21">   // without any search params or return attributes specified. The searchUrl</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -62,17 +64,16 @@ protected:</span>
<a href="#l4.23"></a><span id="l4.23">   nsCOMPtr&lt;nsILDAPURL&gt; mSearchUrl;</span>
<a href="#l4.24"></a><span id="l4.24">   nsIAbDirectoryQueryResultListener *mResultListener;</span>
<a href="#l4.25"></a><span id="l4.25">   int32_t mContextID;</span>
<a href="#l4.26"></a><span id="l4.26">   nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; mQueryArguments;</span>
<a href="#l4.27"></a><span id="l4.27">   int32_t mResultLimit;</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   bool mFinished;</span>
<a href="#l4.30"></a><span id="l4.30">   bool mCanceled;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  bool mWaitingForPrevQueryToFinish;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33">   nsCOMPtr&lt;nsIMutableArray&gt; mServerSearchControls;</span>
<a href="#l4.34"></a><span id="l4.34">   nsCOMPtr&lt;nsIMutableArray&gt; mClientSearchControls;</span>
<a href="#l4.35"></a><span id="l4.35"> };</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> NS_IMPL_ISUPPORTS(nsAbQueryLDAPMessageListener, nsILDAPMessageListener)</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineat">@@ -90,17 +91,16 @@ nsAbQueryLDAPMessageListener::nsAbQueryL</span>
<a href="#l4.41"></a><span id="l4.41">         const int32_t timeOut) :</span>
<a href="#l4.42"></a><span id="l4.42">   nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l4.43"></a><span id="l4.43">   mSearchUrl(searchUrl),</span>
<a href="#l4.44"></a><span id="l4.44">   mResultListener(resultListener),</span>
<a href="#l4.45"></a><span id="l4.45">   mQueryArguments(queryArguments),</span>
<a href="#l4.46"></a><span id="l4.46">   mResultLimit(resultLimit),</span>
<a href="#l4.47"></a><span id="l4.47">   mFinished(false),</span>
<a href="#l4.48"></a><span id="l4.48">   mCanceled(false),</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  mWaitingForPrevQueryToFinish(false),</span>
<a href="#l4.50"></a><span id="l4.50">   mServerSearchControls(serverSearchControls),</span>
<a href="#l4.51"></a><span id="l4.51">   mClientSearchControls(clientSearchControls)</span>
<a href="#l4.52"></a><span id="l4.52"> {</span>
<a href="#l4.53"></a><span id="l4.53">   mSaslMechanism.Assign(mechanism);</span>
<a href="#l4.54"></a><span id="l4.54"> }</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56"> nsAbQueryLDAPMessageListener::~nsAbQueryLDAPMessageListener ()</span>
<a href="#l4.57"></a><span id="l4.57"> {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -112,37 +112,44 @@ nsresult nsAbQueryLDAPMessageListener::C</span>
<a href="#l4.59"></a><span id="l4.59">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">     MutexAutoLock lock(mLock);</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">     if (mFinished || mCanceled)</span>
<a href="#l4.64"></a><span id="l4.64">         return NS_OK;</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66">     mCanceled = true;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    if (!mFinished)</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-      mWaitingForPrevQueryToFinish = true;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-</span>
<a href="#l4.70"></a><span id="l4.70">     return NS_OK;</span>
<a href="#l4.71"></a><span id="l4.71"> }</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73"> NS_IMETHODIMP nsAbQueryLDAPMessageListener::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l4.74"></a><span id="l4.74"> {</span>
<a href="#l4.75"></a><span id="l4.75">   nsresult rv = Initiate();</span>
<a href="#l4.76"></a><span id="l4.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78">   int32_t messageType;</span>
<a href="#l4.79"></a><span id="l4.79">   rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  uint32_t requestNum;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  mOperation-&gt;GetRequestNum(&amp;requestNum);</span>
<a href="#l4.82"></a><span id="l4.82">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84">   bool cancelOperation = false;</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">   // Enter lock</span>
<a href="#l4.87"></a><span id="l4.87">   {</span>
<a href="#l4.88"></a><span id="l4.88">     MutexAutoLock lock (mLock);</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    if (requestNum != sCurrentRequestNum) {</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+           (&quot;nsAbQueryLDAPMessageListener::OnLDAPMessage: Ignoring message with &quot;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+            &quot;request num %&quot; PRIx32 &quot;, current request num is %&quot; PRIx32 &quot;.&quot;,</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+            requestNum, sCurrentRequestNum));</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+      return NS_OK;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    }</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+</span>
<a href="#l4.98"></a><span id="l4.98">     if (mFinished)</span>
<a href="#l4.99"></a><span id="l4.99">       return NS_OK;</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101">     if (messageType == nsILDAPMessage::RES_SEARCH_RESULT)</span>
<a href="#l4.102"></a><span id="l4.102">       mFinished = true;</span>
<a href="#l4.103"></a><span id="l4.103">     else if (mCanceled)</span>
<a href="#l4.104"></a><span id="l4.104">     {</span>
<a href="#l4.105"></a><span id="l4.105">       mFinished = true;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineat">@@ -162,21 +169,20 @@ NS_IMETHODIMP nsAbQueryLDAPMessageListen</span>
<a href="#l4.107"></a><span id="l4.107">       rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l4.108"></a><span id="l4.108">       if (NS_FAILED(rv))</span>
<a href="#l4.109"></a><span id="l4.109">         // We know the bind failed and hence the message has an error, so we</span>
<a href="#l4.110"></a><span id="l4.110">         // can just call SearchResult with the message and that'll sort it out</span>
<a href="#l4.111"></a><span id="l4.111">         // for us.</span>
<a href="#l4.112"></a><span id="l4.112">         rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l4.113"></a><span id="l4.113">       break;</span>
<a href="#l4.114"></a><span id="l4.114">     case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-      if (!mFinished &amp;&amp; !mWaitingForPrevQueryToFinish)</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      if (!mFinished)</span>
<a href="#l4.117"></a><span id="l4.117">         rv = OnLDAPMessageSearchEntry(aMessage);</span>
<a href="#l4.118"></a><span id="l4.118">       break;</span>
<a href="#l4.119"></a><span id="l4.119">     case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-      mWaitingForPrevQueryToFinish = false;</span>
<a href="#l4.121"></a><span id="l4.121">       rv = OnLDAPMessageSearchResult(aMessage);</span>
<a href="#l4.122"></a><span id="l4.122">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.123"></a><span id="l4.123">       break;</span>
<a href="#l4.124"></a><span id="l4.124">     default:</span>
<a href="#l4.125"></a><span id="l4.125">       break;</span>
<a href="#l4.126"></a><span id="l4.126">     }</span>
<a href="#l4.127"></a><span id="l4.127">   }</span>
<a href="#l4.128"></a><span id="l4.128">   else</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineat">@@ -203,16 +209,18 @@ nsresult nsAbQueryLDAPMessageListener::D</span>
<a href="#l4.130"></a><span id="l4.130">   mCanceled = mFinished = false;</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   mOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l4.133"></a><span id="l4.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.134"></a><span id="l4.134"> </span>
<a href="#l4.135"></a><span id="l4.135">   rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l4.136"></a><span id="l4.136">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  mOperation-&gt;SetRequestNum(++sCurrentRequestNum);</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+</span>
<a href="#l4.140"></a><span id="l4.140">   nsAutoCString dn;</span>
<a href="#l4.141"></a><span id="l4.141">   rv = mSearchUrl-&gt;GetDn(dn);</span>
<a href="#l4.142"></a><span id="l4.142">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144">   int32_t scope;</span>
<a href="#l4.145"></a><span id="l4.145">   rv = mSearchUrl-&gt;GetScope(&amp;scope);</span>
<a href="#l4.146"></a><span id="l4.146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.147"></a><span id="l4.147"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,16 +15,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsILoginInfo.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsMemory.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> using namespace mozilla;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+uint32_t nsAbLDAPListenerBase::sCurrentRequestNum = 0;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14"> nsAbLDAPListenerBase::nsAbLDAPListenerBase(nsILDAPURL* url,</span>
<a href="#l5.15"></a><span id="l5.15">                                            nsILDAPConnection* connection,</span>
<a href="#l5.16"></a><span id="l5.16">                                            const nsACString &amp;login,</span>
<a href="#l5.17"></a><span id="l5.17">                                            const int32_t timeOut) :</span>
<a href="#l5.18"></a><span id="l5.18">   mDirectoryUrl(url), mConnection(connection), mLogin(login),</span>
<a href="#l5.19"></a><span id="l5.19">   mTimeOut(timeOut), mBound(false), mInitialized(false),</span>
<a href="#l5.20"></a><span id="l5.20">   mLock(&quot;nsAbLDAPListenerBase.mLock&quot;)</span>
<a href="#l5.21"></a><span id="l5.21"> {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -244,16 +246,17 @@ NS_IMETHODIMP nsAbLDAPListenerBase::OnLD</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   rv = mOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l5.25"></a><span id="l5.25">   if (NS_FAILED(rv))</span>
<a href="#l5.26"></a><span id="l5.26">   {</span>
<a href="#l5.27"></a><span id="l5.27">     NS_ERROR(&quot;nsAbLDAPMessageBase::OnLDAPInit(): failed to Initialise operation&quot;);</span>
<a href="#l5.28"></a><span id="l5.28">     InitFailed();</span>
<a href="#l5.29"></a><span id="l5.29">     return rv;</span>
<a href="#l5.30"></a><span id="l5.30">   }</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  mOperation-&gt;SetRequestNum(++sCurrentRequestNum);</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   // Try non-password mechanisms first</span>
<a href="#l5.34"></a><span id="l5.34">   if (mSaslMechanism.EqualsLiteral(&quot;GSSAPI&quot;))</span>
<a href="#l5.35"></a><span id="l5.35">   {</span>
<a href="#l5.36"></a><span id="l5.36">     nsAutoCString service;</span>
<a href="#l5.37"></a><span id="l5.37">     rv = mDirectoryUrl-&gt;GetAsciiHost(service);</span>
<a href="#l5.38"></a><span id="l5.38">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.39"></a><span id="l5.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -42,13 +42,14 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   nsCOMPtr&lt;nsILDAPURL&gt; mDirectoryUrl;</span>
<a href="#l6.5"></a><span id="l6.5">   nsCOMPtr&lt;nsILDAPOperation&gt; mOperation;        // current ldap op</span>
<a href="#l6.6"></a><span id="l6.6">   nsILDAPConnection* mConnection;</span>
<a href="#l6.7"></a><span id="l6.7">   nsCString mLogin;</span>
<a href="#l6.8"></a><span id="l6.8">   nsCString mSaslMechanism;</span>
<a href="#l6.9"></a><span id="l6.9">   int32_t mTimeOut;</span>
<a href="#l6.10"></a><span id="l6.10">   bool mBound;</span>
<a href="#l6.11"></a><span id="l6.11">   bool mInitialized;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  static uint32_t sCurrentRequestNum;</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14">   mozilla::Mutex mLock;</span>
<a href="#l6.15"></a><span id="l6.15"> };</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

