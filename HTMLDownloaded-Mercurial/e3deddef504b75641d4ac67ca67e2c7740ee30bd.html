<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 13253:e3deddef504b75641d4ac67ca67e2c7740ee30bd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e3deddef504b75641d4ac67ca67e2c7740ee30bd" />
<meta property="og:url" content="/comm-central/rev/e3deddef504b75641d4ac67ca67e2c7740ee30bd" />
<meta property="og:description" content="Bug 934316 - Fix some bad folderpane scrolling perf for feed folders, remove transition code. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e3deddef504b75641d4ac67ca67e2c7740ee30bd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e3deddef504b75641d4ac67ca67e2c7740ee30bd">shortlog</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e3deddef504b75641d4ac67ca67e2c7740ee30bd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd">files</a> |
changeset |
<a href="/comm-central/raw-rev/e3deddef504b75641d4ac67ca67e2c7740ee30bd">raw</a>  | <a href="/comm-central/archive/e3deddef504b75641d4ac67ca67e2c7740ee30bd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=934316">Bug 934316</a> - Fix some bad folderpane scrolling perf for feed folders, remove transition code. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</td></tr>
<tr><td></td><td class="date age">Tue, 05 Nov 2013 14:51:31 -0700</td></tr>

<tr>
 <td>changeset 13253</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e3deddef504b75641d4ac67ca67e2c7740ee30bd">e3deddef504b75641d4ac67ca67e2c7740ee30bd</a></td>
</tr>



<tr>
<td>parent 13252</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d4659a7cf923e736c2bea20ccdee08dbe9899069">d4659a7cf923e736c2bea20ccdee08dbe9899069</a>
</td>
</tr>

<tr>
<td>child 13254</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9e1457436952ffe3ad7fe2e2021a62a371bc2338">9e1457436952ffe3ad7fe2e2021a62a371bc2338</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e3deddef504b75641d4ac67ca67e2c7740ee30bd">9634</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 06 Nov 2013 13:41:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e3deddef504b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e3deddef504b75641d4ac67ca67e2c7740ee30bd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e3deddef504b75641d4ac67ca67e2c7740ee30bd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3deddef504b75641d4ac67ca67e2c7740ee30bd&newProject=comm-central&newRevision=d4659a7cf923e736c2bea20ccdee08dbe9899069&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3deddef504b75641d4ac67ca67e2c7740ee30bd&newProject=comm-central&newRevision=d4659a7cf923e736c2bea20ccdee08dbe9899069&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e3deddef504b75641d4ac67ca67e2c7740ee30bd&newProject=comm-central&newRevision=d4659a7cf923e736c2bea20ccdee08dbe9899069&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=934316">934316</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=934316">Bug 934316</a> - Fix some bad folderpane scrolling perf for feed folders, remove transition code. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">mailnews/extensions/newsblog/content/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/content/utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">mailnews/local/public/nsINewsBlogFeedDownloader.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/public/nsINewsBlogFeedDownloader.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">mailnews/local/src/nsRssIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">file</a> |
<a href="/comm-central/annotate/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">comparison</a> |
<a href="/comm-central/log/e3deddef504b75641d4ac67ca67e2c7740ee30bd/mailnews/local/src/nsRssIncomingServer.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -300,17 +300,17 @@ Feed.prototype =</span>
<a href="#l1.4"></a><span id="l1.4">                                         true);</span>
<a href="#l1.5"></a><span id="l1.5">     if (old_lastmodified)</span>
<a href="#l1.6"></a><span id="l1.6">       ds.Change(this.resource, FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l1.7"></a><span id="l1.7">                 old_lastmodified, aLastModified);</span>
<a href="#l1.8"></a><span id="l1.8">     else</span>
<a href="#l1.9"></a><span id="l1.9">       ds.Assert(this.resource, FeedUtils.DC_LASTMODIFIED, aLastModified, true);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     // Do we need to flush every time this property changes?</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    ds.Flush();</span>
<a href="#l1.14"></a><span id="l1.14">   },</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   get quickMode ()</span>
<a href="#l1.17"></a><span id="l1.17">   {</span>
<a href="#l1.18"></a><span id="l1.18">     let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l1.19"></a><span id="l1.19">     let quickMode = ds.GetTarget(this.resource, FeedUtils.FZ_QUICKMODE, true);</span>
<a href="#l1.20"></a><span id="l1.20">     if (quickMode)</span>
<a href="#l1.21"></a><span id="l1.21">     {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -530,17 +530,17 @@ Feed.prototype =</span>
<a href="#l1.23"></a><span id="l1.23">     FeedCache.removeFeed(aFeed.url);</span>
<a href="#l1.24"></a><span id="l1.24">     aFeed.removeInvalidItems(false);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     if (aCode == FeedUtils.kNewsBlogSuccess &amp;&amp; aFeed.mLastModified)</span>
<a href="#l1.27"></a><span id="l1.27">       aFeed.lastModified = aFeed.mLastModified;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">     // Flush any feed item changes to disk.</span>
<a href="#l1.30"></a><span id="l1.30">     let ds = FeedUtils.getItemsDS(aFeed.server);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    ds.Flush();</span>
<a href="#l1.33"></a><span id="l1.33">     FeedUtils.log.debug(&quot;Feed.cleanupParsingState: items stored - &quot; + this.itemsStored);</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">     if (aFeed.downloadCallback)</span>
<a href="#l1.36"></a><span id="l1.36">       aFeed.downloadCallback.downloaded(aFeed, aCode);</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">     // Force the xml http request to go away.  This helps reduce some nasty</span>
<a href="#l1.39"></a><span id="l1.39">     // assertions on shut down.</span>
<a href="#l1.40"></a><span id="l1.40">     this.request = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1093,16 +1093,18 @@ var FeedSubscriptions = {</span>
<a href="#l2.4"></a><span id="l2.4">   addFeed: function(aFeedLocation, aFolder, aParse, aParams, aMode)</span>
<a href="#l2.5"></a><span id="l2.5">   {</span>
<a href="#l2.6"></a><span id="l2.6">     let message;</span>
<a href="#l2.7"></a><span id="l2.7">     let parse = aParse == null ? true : aParse;</span>
<a href="#l2.8"></a><span id="l2.8">     let mode = aMode == null ? this.kSubscribeMode : aMode;</span>
<a href="#l2.9"></a><span id="l2.9">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l2.10"></a><span id="l2.10">     let quickMode = aParams &amp;&amp; (&quot;quickMode&quot; in aParams) ?</span>
<a href="#l2.11"></a><span id="l2.11">         aParams.quickMode : document.getElementById(&quot;quickMode&quot;).checked;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    let name = aParams &amp;&amp; (&quot;name&quot; in aParams) ?</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        aParams.name : document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">     if (aFeedLocation)</span>
<a href="#l2.16"></a><span id="l2.16">       locationValue.value = aFeedLocation;</span>
<a href="#l2.17"></a><span id="l2.17">     let feedLocation = locationValue.value.trim();</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">     if (!feedLocation)</span>
<a href="#l2.20"></a><span id="l2.20">     {</span>
<a href="#l2.21"></a><span id="l2.21">       message = locationValue.getAttribute(&quot;placeholder&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1135,17 +1137,16 @@ var FeedSubscriptions = {</span>
<a href="#l2.23"></a><span id="l2.23">     if (FeedUtils.feedAlreadyExists(feedLocation, addFolder.server))</span>
<a href="#l2.24"></a><span id="l2.24">     {</span>
<a href="#l2.25"></a><span id="l2.25">       message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l2.26"></a><span id="l2.26">                   &quot;subscribe-feedAlreadySubscribed&quot;);</span>
<a href="#l2.27"></a><span id="l2.27">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l2.28"></a><span id="l2.28">       return false;</span>
<a href="#l2.29"></a><span id="l2.29">     }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    let name = document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l2.32"></a><span id="l2.32">     let folderURI = addFolder.isServer ? null : addFolder.URI;</span>
<a href="#l2.33"></a><span id="l2.33">     let feedProperties = { feedName     : name,</span>
<a href="#l2.34"></a><span id="l2.34">                            feedLocation : feedLocation,</span>
<a href="#l2.35"></a><span id="l2.35">                            folderURI    : folderURI,</span>
<a href="#l2.36"></a><span id="l2.36">                            server       : addFolder.server,</span>
<a href="#l2.37"></a><span id="l2.37">                            quickMode    : quickMode };</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">     let feed = this.storeFeed(feedProperties);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -1263,17 +1264,17 @@ var FeedSubscriptions = {</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">       if (newParentIndex != this.mView.kRowIndexUndefined)</span>
<a href="#l2.43"></a><span id="l2.43">         this.moveCopyFeed(seln.currentIndex, newParentIndex, &quot;move&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">     }</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     if (!updated)</span>
<a href="#l2.47"></a><span id="l2.47">       return;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    ds.Flush();</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedUpdated&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l2.54"></a><span id="l2.54">   },</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> /**</span>
<a href="#l2.57"></a><span id="l2.57">  * Moves or copies a feed to another folder or account.</span>
<a href="#l2.58"></a><span id="l2.58">  * </span>
<a href="#l2.59"></a><span id="l2.59" class="difflineat">@@ -1309,30 +1310,29 @@ var FeedSubscriptions = {</span>
<a href="#l2.60"></a><span id="l2.60">       if (newFolder.isServer || !moveFeed)</span>
<a href="#l2.61"></a><span id="l2.61">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l2.62"></a><span id="l2.62">         // not copy, to folder in the same account.</span>
<a href="#l2.63"></a><span id="l2.63">         return;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">       // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l2.66"></a><span id="l2.66">       ds.Change(resource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l2.67"></a><span id="l2.67">                 currentParentResource, newParentResource);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-      ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-      // Update the feed url attributes on the databases for each folder:</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      // Remove our feed url property from the current folder.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-      FeedUtils.updateFolderFeedUrl(currentFolder, currentItem.url, true);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-      // Add our feed url property to the new folder.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-      FeedUtils.updateFolderFeedUrl(newFolder, currentItem.url, false);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      ds.Flush();</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+      // Sync the feedUrl property for each folder.</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+      FeedUtils.syncFeedUrlWithFeedsDS(currentFolder);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+      FeedUtils.syncFeedUrlWithFeedsDS(newFolder);</span>
<a href="#l2.78"></a><span id="l2.78">     }</span>
<a href="#l2.79"></a><span id="l2.79">     else</span>
<a href="#l2.80"></a><span id="l2.80">     {</span>
<a href="#l2.81"></a><span id="l2.81">       // Moving/copying to a new account.  If dropping on the account folder,</span>
<a href="#l2.82"></a><span id="l2.82">       // a new subfolder is created if necessary.</span>
<a href="#l2.83"></a><span id="l2.83">       accountMoveCopy = true;</span>
<a href="#l2.84"></a><span id="l2.84">       let mode = moveFeed ? this.kMoveMode : this.kCopyMode;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      let params = {quickMode: currentItem.quickMode};</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+      let params = {quickMode: currentItem.quickMode,</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                    name:      currentItem.name};</span>
<a href="#l2.88"></a><span id="l2.88">       // Subscribe to the new folder first.  If it already exists in the</span>
<a href="#l2.89"></a><span id="l2.89">       // account or on error, return.</span>
<a href="#l2.90"></a><span id="l2.90">       if (!this.addFeed(currentItem.url, newFolder, false, params, mode))</span>
<a href="#l2.91"></a><span id="l2.91">         return;</span>
<a href="#l2.92"></a><span id="l2.92">       // Unsubscribe the feed from the old folder, if add to the new folder</span>
<a href="#l2.93"></a><span id="l2.93">       // is successfull, and doing a move.</span>
<a href="#l2.94"></a><span id="l2.94">       if (moveFeed)</span>
<a href="#l2.95"></a><span id="l2.95">         FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(currentItem.url),</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineat">@@ -1434,23 +1434,18 @@ var FeedSubscriptions = {</span>
<a href="#l2.97"></a><span id="l2.97">       window.focus();</span>
<a href="#l2.98"></a><span id="l2.98">       // Feed is null if our attempt to parse the feed failed.</span>
<a href="#l2.99"></a><span id="l2.99">       let message = &quot;&quot;;</span>
<a href="#l2.100"></a><span id="l2.100">       let win = FeedSubscriptions;</span>
<a href="#l2.101"></a><span id="l2.101">       if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l2.102"></a><span id="l2.102">       {</span>
<a href="#l2.103"></a><span id="l2.103">         win.updateStatusItem(&quot;progressMeter&quot;, 100);</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-        // If we get here we should always have a folder by now, either in</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-        // feed.folder or FeedItems created the folder for us.</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-        // Add feed adds the feed to the subscriptions db and flushes the</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-        // datasource.</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-        FeedUtils.addFeed(feed.url, feed.name, feed.folder); </span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+        // Add the feed to the databases.</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+        FeedUtils.addFeed(feed);</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115">         // Now add the feed to our view.  If adding, the current selection will</span>
<a href="#l2.116"></a><span id="l2.116">         // be a folder; if updating it will be a feed.  No need to rebuild the</span>
<a href="#l2.117"></a><span id="l2.117">         // entire view, that is too jarring.</span>
<a href="#l2.118"></a><span id="l2.118">         let curIndex = win.mView.selection.currentIndex;</span>
<a href="#l2.119"></a><span id="l2.119">         let curItem = win.mView.getItemAtIndex(curIndex);</span>
<a href="#l2.120"></a><span id="l2.120">         if (curItem)</span>
<a href="#l2.121"></a><span id="l2.121">         {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineat">@@ -1782,17 +1777,18 @@ var FeedSubscriptions = {</span>
<a href="#l2.123"></a><span id="l2.123">                           aMove + &quot;:&quot; + aSrcFolder.name + &quot;:&quot; + aDestFolder.name);</span>
<a href="#l2.124"></a><span id="l2.124">       let feedWindow = this.feedWindow;</span>
<a href="#l2.125"></a><span id="l2.125">       let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l2.126"></a><span id="l2.126">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l2.127"></a><span id="l2.127">       let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l2.128"></a><span id="l2.128">       let indexInView = feedWindow.mView.getItemInViewIndex(aSrcFolder);</span>
<a href="#l2.129"></a><span id="l2.129">       let destIndexInView = feedWindow.mView.getItemInViewIndex(aDestFolder);</span>
<a href="#l2.130"></a><span id="l2.130">       let open = indexInView != null || destIndexInView != null;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-      let parentIndex = feedWindow.mView.getItemInViewIndex(aDestFolder.parent);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+      let parentIndex = feedWindow.mView.getItemInViewIndex(aDestFolder.parent ||</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+                                                            aDestFolder);</span>
<a href="#l2.134"></a><span id="l2.134">       let select =</span>
<a href="#l2.135"></a><span id="l2.135">         indexInView == curSelIndex ||</span>
<a href="#l2.136"></a><span id="l2.136">         feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">       if (aMove)</span>
<a href="#l2.139"></a><span id="l2.139">       {</span>
<a href="#l2.140"></a><span id="l2.140">         this.folderDeleted(aSrcFolder);</span>
<a href="#l2.141"></a><span id="l2.141">         if (aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -2289,21 +2285,18 @@ var FeedSubscriptions = {</span>
<a href="#l2.143"></a><span id="l2.143">             FeedUtils.log.info(&quot;importOPMLOutlines: skipping, error creating folder - '&quot; +</span>
<a href="#l2.144"></a><span id="l2.144">                                feed.folderName + &quot;' from outlineName - '&quot; +</span>
<a href="#l2.145"></a><span id="l2.145">                                outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l2.146"></a><span id="l2.146">                                aParentFolder.filePath.path);</span>
<a href="#l2.147"></a><span id="l2.147">             badTag = true;</span>
<a href="#l2.148"></a><span id="l2.148">             break;</span>
<a href="#l2.149"></a><span id="l2.149">           }</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-          FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-          // addFeed() adds the feed to the datasource, it also flushes the</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-          // subscription datasource.</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-          FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+          // Add the feed to the databases.</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+          FeedUtils.addFeed(feed);</span>
<a href="#l2.158"></a><span id="l2.158">           // Feed correctly added.</span>
<a href="#l2.159"></a><span id="l2.159">           feedsAdded++;</span>
<a href="#l2.160"></a><span id="l2.160">           lastFolder = feed.folder;</span>
<a href="#l2.161"></a><span id="l2.161">         }</span>
<a href="#l2.162"></a><span id="l2.162">         else</span>
<a href="#l2.163"></a><span id="l2.163">         {</span>
<a href="#l2.164"></a><span id="l2.164">           // A folder outline. If a folder exists in the account structure at</span>
<a href="#l2.165"></a><span id="l2.165">           // the same level as in the opml structure, feeds are placed into the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -176,49 +176,52 @@ var FeedUtils = {</span>
<a href="#l3.4"></a><span id="l3.4">  */</span>
<a href="#l3.5"></a><span id="l3.5">   feedAlreadyExists: function(aUrl, aServer) {</span>
<a href="#l3.6"></a><span id="l3.6">     let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l3.7"></a><span id="l3.7">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.8"></a><span id="l3.8">     return feeds.IndexOf(this.rdf.GetResource(aUrl)) != -1;</span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * Add a feed record to the feeds.rdf database.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">- * </span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">- * @param  string aUrl              - feed url.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- * @param  string aTitle            - feed title.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">- * @param  nsIMsgFolder aDestFolder - owning folder.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * Add a feed record to the feeds.rdf database and update the folder's feedUrl</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * property.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * @param  object aFeed - our feed object</span>
<a href="#l3.21"></a><span id="l3.21">  */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  addFeed: function(aUrl, aTitle, aDestFolder) {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    let ds = this.getSubscriptionsDS(aDestFolder.server);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  addFeed: function(aFeed) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    let ds = this.getSubscriptionsDS(aFeed.folder.server);</span>
<a href="#l3.26"></a><span id="l3.26">     let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     // Generate a unique ID for the feed.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    let id = aUrl;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    let id = aFeed.url;</span>
<a href="#l3.31"></a><span id="l3.31">     let i = 1;</span>
<a href="#l3.32"></a><span id="l3.32">     while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-      id = aUrl + i;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+      id = aFeed.url + i;</span>
<a href="#l3.35"></a><span id="l3.35">     if (id == 1000)</span>
<a href="#l3.36"></a><span id="l3.36">       throw new Error(&quot;FeedUtils.addFeed: couldn't generate a unique ID &quot; +</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                      &quot;for feed &quot; + aUrl);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+                      &quot;for feed &quot; + aFeed.url);</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">     // Add the feed to the list.</span>
<a href="#l3.41"></a><span id="l3.41">     id = this.rdf.GetResource(id);</span>
<a href="#l3.42"></a><span id="l3.42">     feeds.AppendElement(id);</span>
<a href="#l3.43"></a><span id="l3.43">     ds.Assert(id, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    ds.Assert(id, this.DC_IDENTIFIER, this.rdf.GetLiteral(aUrl), true);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    if (aTitle)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      ds.Assert(id, this.DC_TITLE, this.rdf.GetLiteral(aTitle), true);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-    ds.Assert(id, this.FZ_DESTFOLDER, aDestFolder, true);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    ds.Assert(id, this.DC_IDENTIFIER, this.rdf.GetLiteral(aFeed.url), true);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    if (aFeed.title)</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      ds.Assert(id, this.DC_TITLE, this.rdf.GetLiteral(aFeed.title), true);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    ds.Assert(id, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    ds.Flush();</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    // Sync the feedUrl property for the folder.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    this.syncFeedUrlWithFeedsDS(aFeed.folder);</span>
<a href="#l3.57"></a><span id="l3.57">   },</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59"> /**</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">- * Delete a feed record from the feeds.rdf database.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">- * </span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ * feedUrl property.</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+ *</span>
<a href="#l3.65"></a><span id="l3.65">  * @param  nsIRDFResource aId           - feed url as rdf resource.</span>
<a href="#l3.66"></a><span id="l3.66">  * @param  nsIMsgIncomingServer aServer - folder's account server.</span>
<a href="#l3.67"></a><span id="l3.67">  * @param  nsIMsgFolder aParentFolder   - owning folder.</span>
<a href="#l3.68"></a><span id="l3.68">  */</span>
<a href="#l3.69"></a><span id="l3.69">   deleteFeed: function(aId, aServer, aParentFolder) {</span>
<a href="#l3.70"></a><span id="l3.70">     let feed = new Feed(aId, aServer);</span>
<a href="#l3.71"></a><span id="l3.71">     let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73" class="difflineat">@@ -227,203 +230,187 @@ var FeedUtils = {</span>
<a href="#l3.74"></a><span id="l3.74">       // Remove the feed from the subscriptions ds.</span>
<a href="#l3.75"></a><span id="l3.75">       let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l3.76"></a><span id="l3.76">       let index = feeds.IndexOf(aId);</span>
<a href="#l3.77"></a><span id="l3.77">       if (index != -1)</span>
<a href="#l3.78"></a><span id="l3.78">         feeds.RemoveElementAt(index, false);</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80">       // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l3.81"></a><span id="l3.81">       this.removeAssertions(ds, aId);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-      ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+      ds.Flush();</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">       // Remove all assertions about items in the feed from the items database.</span>
<a href="#l3.86"></a><span id="l3.86">       let itemds = this.getItemsDS(aServer);</span>
<a href="#l3.87"></a><span id="l3.87">       feed.invalidateItems();</span>
<a href="#l3.88"></a><span id="l3.88">       feed.removeInvalidItems(true);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      itemds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  </span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      // Finally, make sure to remove the url from the folder's feedUrl</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      // property.  The correct folder is passed in by the Subscribe dialog or</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-      // a folder pane folder delete.  The correct current folder cannot be</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-      // currently determined from the feed's destFolder in the db, as it is not</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      // synced with folder pane moves.  Do this at the very end.</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      let feedUrl = aId.ValueUTF8;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      this.updateFolderFeedUrl(aParentFolder, feedUrl, true);</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      itemds.Flush();</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+      // Sync the feedUrl property for the folder.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+      this.syncFeedUrlWithFeedsDS(aParentFolder);</span>
<a href="#l3.102"></a><span id="l3.102">     }</span>
<a href="#l3.103"></a><span id="l3.103">   },</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105"> /**</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">- * Get the list of feed urls for a folder.  For legacy reasons, we try</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">- * 1) getStringProperty on the folder;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">- * 2) getCharProperty on the folder's msgDatabase.dBFolderInfo;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">- * 3) directly from the feeds.rdf subscriptions database, as identified by</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">- *    the destFolder tag (currently not synced on folder moves in folder pane).</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">- * </span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">- * If folder move/renames are fixed, remove msgDatabase accesses and get the</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">- * list directly from the feeds db.</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">- * </span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+ * Get the list of feed urls for a folder, as identified by the FZ_DESTFOLDER</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+ * tag, directly from the primary feeds.rdf subscriptions database.</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+ *</span>
<a href="#l3.118"></a><span id="l3.118">  * @param  nsIMsgFolder - the folder.</span>
<a href="#l3.119"></a><span id="l3.119">  * @return array of urls, or null if none.</span>
<a href="#l3.120"></a><span id="l3.120">  */</span>
<a href="#l3.121"></a><span id="l3.121">   getFeedUrlsInFolder: function(aFolder) {</span>
<a href="#l3.122"></a><span id="l3.122">     if (aFolder.isServer || aFolder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l3.123"></a><span id="l3.123">         !aFolder.filePath.exists())</span>
<a href="#l3.124"></a><span id="l3.124">       // There are never any feedUrls in the account folder or trash folder or</span>
<a href="#l3.125"></a><span id="l3.125">       // in a ghost folder (nonexistant on disk yet found in aFolder.subFolders).</span>
<a href="#l3.126"></a><span id="l3.126">       return null;</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128">     let feedUrlArray = [];</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    let feedurls = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    if (feedurls)</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      return this.splitFeedUrls(feedurls);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    // Go to msgDatabase for the property, make sure to handle errors.</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    // NOTE: the rest of the following code is a migration of the feedUrl</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-    // property for pre Tb15 subscriptions.  At some point it can/should be</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    // removed.</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-    let msgDb;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    try {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-      msgDb = aFolder.msgDatabase;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    }</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    if (msgDb &amp;&amp; msgDb.dBFolderInfo) {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-      // Clean up the feedUrl string.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-      feedurls = this.splitFeedUrls(msgDb.dBFolderInfo.getCharProperty(&quot;feedUrl&quot;));</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-      feedurls.forEach(</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-        function(url) {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-          if (url &amp;&amp; feedUrlArray.indexOf(url) == -1)</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-            feedUrlArray.push(url);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-        });</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      feedurls = feedUrlArray.join(this.kFeedUrlDelimiter);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      if (feedurls) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-        // Do a onetime per folder re-sync of the feeds db here based on the</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-        // urls in the feedUrl property.</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-        let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-        let resource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-        feedUrlArray.forEach(</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-          function(url) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-            try {</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-              let id = this.rdf.GetResource(url);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-              // Get the node for the current folder URI.</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-              let node = ds.GetTarget(id, this.FZ_DESTFOLDER, true);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-              if (node)</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-              {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-                ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-                this.log.debug(&quot;getFeedUrlsInFolder: sync update folder:url - &quot; +</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-                               aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-              }</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-              else</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-              {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-                this.addFeed(url, null, aFolder);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-                this.log.debug(&quot;getFeedUrlsInFolder: sync add folder:url - &quot; +</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-                               aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-              }</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-            }</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-            catch (ex) {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-              this.log.debug(&quot;getFeedUrlsInFolder: error - &quot; + ex);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-              this.log.debug(&quot;getFeedUrlsInFolder: sync failed for folder:url - &quot; +</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-                             aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-            }</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-        }, this);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-        ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  </span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-        // Set property on folder so we don't come here ever again.</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-        aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-        aFolder.msgDatabase = null;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-  </span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-        return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-      }</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    }</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    else {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-      // Forcing a reparse with listener here is the last resort.  Not implemented</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-      // as it may be unnecessary once feedUrl is property set on folder and not</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-      // msgDatabase, and if eventually feedUrls are derived from the feeds db</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-      // directly.</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    }</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-  </span>
<a href="#l3.199"></a><span id="l3.199">     // Get the list from the feeds database.</span>
<a href="#l3.200"></a><span id="l3.200">     try {</span>
<a href="#l3.201"></a><span id="l3.201">       let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l3.202"></a><span id="l3.202">       let enumerator = ds.GetSources(this.FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l3.203"></a><span id="l3.203">       while (enumerator.hasMoreElements())</span>
<a href="#l3.204"></a><span id="l3.204">       {</span>
<a href="#l3.205"></a><span id="l3.205">         let containerArc = enumerator.getNext();</span>
<a href="#l3.206"></a><span id="l3.206">         let uri = containerArc.QueryInterface(Ci.nsIRDFResource).Value;</span>
<a href="#l3.207"></a><span id="l3.207">         feedUrlArray.push(uri);</span>
<a href="#l3.208"></a><span id="l3.208">       }</span>
<a href="#l3.209"></a><span id="l3.209">     }</span>
<a href="#l3.210"></a><span id="l3.210">     catch(ex)</span>
<a href="#l3.211"></a><span id="l3.211">     {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-      this.log.debug(&quot;getFeedUrlsInFolder: feeds db error - &quot; + ex);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      this.log.debug(&quot;getFeedUrlsInFolder: feeds db error for folder - &quot; +</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-                     aFolder.filePath.path);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error - &quot; + ex);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error for account - &quot; +</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+                     aFolder.server.serverURI + &quot; : &quot; + aFolder.server.prettyName);</span>
<a href="#l3.218"></a><span id="l3.218">     }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  </span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    feedurls = feedUrlArray.join(this.kFeedUrlDelimiter);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    if (feedurls)</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    {</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-      aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-      this.log.debug(&quot;getFeedUrlsInFolder: got urls from db, folder:feedUrl - &quot; +</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-                     aFolder.filePath.path + &quot; : &quot; + feedurls);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    }</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    else</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-      this.log.trace(&quot;getFeedUrlsInFolder: no urls from db, folder - &quot; +</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-                     aFolder.filePath.path);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-  </span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+</span>
<a href="#l3.232"></a><span id="l3.232">     return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l3.233"></a><span id="l3.233">   },</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235"> /**</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">- * Add or remove urls from feedUrl folder property.  Property is used for</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">- * access to a folder's feeds in Subscribe dialog and when doing downloadFeed</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">- * on a folder.  Ensure no dupes.</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">- * </span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">- * @param  nsIMsgFolder - the folder.</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">- * @param  string       - the feed's url.</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">- * @param  boolean      - true if removing the url.</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+ * Update the feeds.rdf database with the new folder's location on name changes</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+ * on rename and move/copy. Note that for nested folders to also be reflected</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+ * correctly, the feedUrl property *must* be derived from the individual</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+ * folder's db, and not from panacea (ie using getStringProperty, which contains</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+ * the old name at the time of the notification).</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+ *</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+ * @param  nsIMsgFolder aFolder      - the folder, new if rename or move/copy</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+ * @param  nsIMsgFolder aOrigFolder  - original folder, if move/copy</span>
<a href="#l3.251"></a><span id="l3.251">  */</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-  updateFolderFeedUrl: function(aFolder, aFeedUrl, aRemoveUrl) {</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    if (!aFolder || !aFeedUrl)</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-      return;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  updateFolderChangeInFeedsDS: function(aFolder, aOrigFolder) {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+    let sourceFolder = aFolder;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    if (aOrigFolder &amp;&amp; aFolder.server != aOrigFolder.server)</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+      // Copied from another account, get the feed urls from that account's</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+      // feeds.rdf db.</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+      sourceFolder = aOrigFolder;</span>
<a href="#l3.261"></a><span id="l3.261"> </span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    let curFeedUrls = this.splitFeedUrls(aFolder.getStringProperty(&quot;feedUrl&quot;));</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-    let index = curFeedUrls.indexOf(aFeedUrl);</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+    this.log.debug(&quot;updateFolderChangeInFeedsDS: aFolder      - &quot; +</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+                   aFolder.filePath.path);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+    this.log.debug(&quot;updateFolderChangeInFeedsDS: sourceFolder - &quot; +</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+                   sourceFolder.filePath.path);</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-    if (aRemoveUrl)</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+    let feedUrl = sourceFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+    let feedUrlArray = feedUrl ? this.splitFeedUrls(feedUrl) : null;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    if (!feedUrlArray)</span>
<a href="#l3.274"></a><span id="l3.274">     {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-      if (index == -1)</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-        return;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-      curFeedUrls.splice(index, 1);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    }</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    else {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-      if (index != -1)</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-        return;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-      curFeedUrls.push(aFeedUrl);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+      this.log.debug(&quot;updateFolderChangeInFeedsDS: no feedUrls in this folder&quot;);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+      return;</span>
<a href="#l3.285"></a><span id="l3.285">     }</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-    let newFeedUrls = curFeedUrls.join(this.kFeedUrlDelimiter);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    aFolder.setStringProperty(&quot;feedUrl&quot;, newFeedUrls);</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    let id, resource, node;</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+    let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+    for (let feedUrl of feedUrlArray)</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+    {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+      if (!feedUrl)</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+        continue;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+      this.log.debug(&quot;updateFolderChangeInFeedsDS: feedUrl - &quot; + feedUrl);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+      id = this.rdf.GetResource(feedUrl);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+      // If move to trash, unsubscribe.</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+      if (this.isInTrash(aFolder))</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+      {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+        this.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+      }</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+      else</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+      {</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+        resource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+        // Get the node for the current folder URI.</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+        node = ds.GetTarget(id, this.FZ_DESTFOLDER, true);</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+        if (node)</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+        {</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+          ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+        }</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+        else</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+        {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+          // If adding a new feed it's a cross account action; get the title</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+          // and quickMode from its original datasource, otherwise use the new</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+          // folder's name and default server quickMode.</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+          let dsSrc = FeedUtils.getSubscriptionsDS(sourceFolder.server);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+          let feedTitle = dsSrc.GetTarget(id, this.DC_TITLE, true);</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+          feedTitle = feedTitle ? feedTitle.QueryInterface(Ci.nsIRDFLiteral).Value :</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+                      resource.name;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+          let quickMode = dsSrc.GetTarget(id, this.FZ_QUICKMODE, true);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+          quickMode = quickMode.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+          quickMode = quickMode == &quot;true&quot; ? true :</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+                      quickMode == &quot;false&quot; ? false :</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+                      aFeed.folder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+          let feed = new Feed(id, aFolder.server);</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+          feed.folder = aFolder;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+          feed.title = feedTitle;</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+          feed.quickMode = quickMode;</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+          this.addFeed(feed);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+        }</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+      }</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+    }</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+    ds.Flush();</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+  },</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+/**</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+ * Sync folder's feedUrl property with the folder's urls in the feeds.rdf</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+ * primary database. This secondary location is required for keeping the</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+ * primary feeds.rdf db synced with folder pathname changes.</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+ *</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+ * @param  nsIMsgFolder aFolder - the folder with the feed subscriptions</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+ */</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+  syncFeedUrlWithFeedsDS: function(aFolder) {</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+    if (!aFolder || this.isInTrash(aFolder))</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+      return null;</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+    let feedUrlArray = this.getFeedUrlsInFolder(aFolder);</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+    let feedUrls = feedUrlArray ? feedUrlArray.join(this.kFeedUrlDelimiter) : &quot;&quot;;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+    let feedUrl = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+    if ((feedUrls &amp;&amp; feedUrl != feedUrls) || (!feedUrls &amp;&amp; feedUrl))</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+    {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+      aFolder.setStringProperty(&quot;feedUrl&quot;, feedUrls);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+      this.log.debug(&quot;syncFeedUrlWithFeedsDS: synced feedUrl for folder - &quot; +</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+                     aFolder.filePath.path);</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+      this.log.debug(&quot;syncFeedUrlWithFeedsDS: setStringProperty - &quot; + feedUrls);</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+      this.log.debug(&quot;syncFeedUrlWithFeedsDS: getCharProperty   - &quot; +</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+                     aFolder.msgDatabase.dBFolderInfo.getCharProperty(&quot;feedUrl&quot;));</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+    }</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+    return feedUrlArray;</span>
<a href="#l3.363"></a><span id="l3.363">   },</span>
<a href="#l3.364"></a><span id="l3.364"> </span>
<a href="#l3.365"></a><span id="l3.365"> /**</span>
<a href="#l3.366"></a><span id="l3.366">  * Return array of folder's feed urls.  Handle bad delimiter choice.</span>
<a href="#l3.367"></a><span id="l3.367">  *</span>
<a href="#l3.368"></a><span id="l3.368">  * @param  string aUrlString - the folder's feedUrl string property.</span>
<a href="#l3.369"></a><span id="l3.369">  * @return array             - array of urls or empty array if no property.</span>
<a href="#l3.370"></a><span id="l3.370">  */</span>
<a href="#l3.371"></a><span id="l3.371">   splitFeedUrls: function(aUrlString) {</span>
<a href="#l3.372"></a><span id="l3.372">     let urlStr = aUrlString.replace(this.kFeedUrlDelimiter + &quot;http://&quot;,</span>
<a href="#l3.373"></a><span id="l3.373">                                     &quot;\x01http://&quot;, &quot;g&quot;)</span>
<a href="#l3.374"></a><span id="l3.374">                            .replace(this.kFeedUrlDelimiter + &quot;https://&quot;,</span>
<a href="#l3.375"></a><span id="l3.375">                                     &quot;\x01https://&quot;, &quot;g&quot;)</span>
<a href="#l3.376"></a><span id="l3.376">                            .replace(this.kFeedUrlDelimiter + &quot;file://&quot;,</span>
<a href="#l3.377"></a><span id="l3.377">                                     &quot;\x01file://&quot;, &quot;g&quot;);</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-    return urlStr.split(&quot;\x01&quot;);</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+    return urlStr ? urlStr.split(&quot;\x01&quot;) : [];</span>
<a href="#l3.380"></a><span id="l3.380">   },</span>
<a href="#l3.381"></a><span id="l3.381"> </span>
<a href="#l3.382"></a><span id="l3.382"> /**</span>
<a href="#l3.383"></a><span id="l3.383">  * When subscribing to feeds by dnd on, or adding a url to, the account</span>
<a href="#l3.384"></a><span id="l3.384">  * folder (only), or creating folder structure via opml import, a subfolder is</span>
<a href="#l3.385"></a><span id="l3.385">  * autocreated and thus the derived/given name must be sanitized to prevent</span>
<a href="#l3.386"></a><span id="l3.386">  * filesystem errors. Hashing invalid chars based on OS rather than filesystem</span>
<a href="#l3.387"></a><span id="l3.387">  * is not strictly correct.</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineat">@@ -436,20 +423,22 @@ var FeedUtils = {</span>
<a href="#l3.389"></a><span id="l3.389">  * @return string                     - sanitized unique name</span>
<a href="#l3.390"></a><span id="l3.390">  */</span>
<a href="#l3.391"></a><span id="l3.391">   getSanitizedFolderName: function(aParentFolder, aProposedName, aDefaultName, aUnique) {</span>
<a href="#l3.392"></a><span id="l3.392">     // Clean up the name for the strictest fs (fat) and to ensure portability.</span>
<a href="#l3.393"></a><span id="l3.393">     // 1) Replace line breaks and tabs '\n\r\t' with a space.</span>
<a href="#l3.394"></a><span id="l3.394">     // 2) Remove nonprintable ascii.</span>
<a href="#l3.395"></a><span id="l3.395">     // 3) Remove invalid win chars '* | \ / : &lt; &gt; ? &quot;'.</span>
<a href="#l3.396"></a><span id="l3.396">     // 4) Remove all '.' as starting/ending with one is trouble on osx/win.</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+    // 5) No leading/trailing spaces.</span>
<a href="#l3.398"></a><span id="l3.398">     let folderName = aProposedName.replace(/[\n\r\t]+/g, &quot; &quot;)</span>
<a href="#l3.399"></a><span id="l3.399">                                   .replace(/[\x00-\x1F]+/g, &quot;&quot;)</span>
<a href="#l3.400"></a><span id="l3.400">                                   .replace(/[*|\\\/:&lt;&gt;?&quot;]+/g, &quot;&quot;)</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-                                  .replace(/[\.]+/g, &quot;&quot;);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+                                  .replace(/[\.]+/g, &quot;&quot;)</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+                                  .trim();</span>
<a href="#l3.404"></a><span id="l3.404"> </span>
<a href="#l3.405"></a><span id="l3.405">     // Prefix with __ if name is:</span>
<a href="#l3.406"></a><span id="l3.406">     // 1) a reserved win filename.</span>
<a href="#l3.407"></a><span id="l3.407">     // 2) an undeletable/unrenameable special folder name (bug 259184).</span>
<a href="#l3.408"></a><span id="l3.408">     if (folderName.toUpperCase().match(/COM\d|LPT\d|CON|PRN|AUX|NUL|CLOCK\$/) ||</span>
<a href="#l3.409"></a><span id="l3.409">         folderName.toUpperCase().match(/INBOX|OUTBOX|UNSENT MESSAGES|TRASH/))</span>
<a href="#l3.410"></a><span id="l3.410">       folderName = &quot;__&quot; + folderName;</span>
<a href="#l3.411"></a><span id="l3.411"> </span>
<a href="#l3.412"></a><span id="l3.412" class="difflineat">@@ -467,30 +456,35 @@ var FeedUtils = {</span>
<a href="#l3.413"></a><span id="l3.413">     {</span>
<a href="#l3.414"></a><span id="l3.414">       folderName = folderNameBase + &quot;-&quot; + i++;</span>
<a href="#l3.415"></a><span id="l3.415">     }</span>
<a href="#l3.416"></a><span id="l3.416"> </span>
<a href="#l3.417"></a><span id="l3.417">     return folderName;</span>
<a href="#l3.418"></a><span id="l3.418">   },</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420">   getSubscriptionsDS: function(aServer) {</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI][&quot;FeedsDS&quot;])</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+      return this[aServer.serverURI][&quot;FeedsDS&quot;];</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+</span>
<a href="#l3.424"></a><span id="l3.424">     let file = this.getSubscriptionsFile(aServer);</span>
<a href="#l3.425"></a><span id="l3.425">     let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l3.426"></a><span id="l3.426">                           QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l3.427"></a><span id="l3.427">                           getURLSpecFromFile(file);</span>
<a href="#l3.428"></a><span id="l3.428"> </span>
<a href="#l3.429"></a><span id="l3.429">     // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l3.430"></a><span id="l3.430">     // once we've already done it once.</span>
<a href="#l3.431"></a><span id="l3.431">     let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l3.432"></a><span id="l3.432"> </span>
<a href="#l3.433"></a><span id="l3.433">     if (!ds)</span>
<a href="#l3.434"></a><span id="l3.434">       throw new Error(&quot;FeedUtils.getSubscriptionsDS: can't get feed &quot; +</span>
<a href="#l3.435"></a><span id="l3.435">                       &quot;subscriptions data source - &quot; + url);</span>
<a href="#l3.436"></a><span id="l3.436"> </span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-    return ds;</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+    this[aServer.serverURI] = {};</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+    return this[aServer.serverURI][&quot;FeedsDS&quot;] =</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+             ds.QueryInterface(Ci.nsIRDFRemoteDataSource);</span>
<a href="#l3.441"></a><span id="l3.441">   },</span>
<a href="#l3.442"></a><span id="l3.442"> </span>
<a href="#l3.443"></a><span id="l3.443">   getSubscriptionsList: function(aDataSource) {</span>
<a href="#l3.444"></a><span id="l3.444">     let list = aDataSource.GetTarget(this.FZ_ROOT, this.FZ_FEEDS, true);</span>
<a href="#l3.445"></a><span id="l3.445">     list = list.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l3.446"></a><span id="l3.446">     list = this.rdfContainerUtils.MakeSeq(aDataSource, list);</span>
<a href="#l3.447"></a><span id="l3.447">     return list;</span>
<a href="#l3.448"></a><span id="l3.448">   },</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineat">@@ -514,33 +508,38 @@ var FeedUtils = {</span>
<a href="#l3.450"></a><span id="l3.450">     '    &lt;fz:feeds&gt;\n' +</span>
<a href="#l3.451"></a><span id="l3.451">     '      &lt;RDF:Seq&gt;\n' +</span>
<a href="#l3.452"></a><span id="l3.452">     '      &lt;/RDF:Seq&gt;\n' +</span>
<a href="#l3.453"></a><span id="l3.453">     '    &lt;/fz:feeds&gt;\n' +</span>
<a href="#l3.454"></a><span id="l3.454">     '  &lt;/RDF:Description&gt;\n' +</span>
<a href="#l3.455"></a><span id="l3.455">     '&lt;/RDF:RDF&gt;\n',</span>
<a href="#l3.456"></a><span id="l3.456"> </span>
<a href="#l3.457"></a><span id="l3.457">   getItemsDS: function(aServer) {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+    if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI][&quot;FeedItemsDS&quot;])</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+      return this[aServer.serverURI][&quot;FeedItemsDS&quot;];</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+</span>
<a href="#l3.461"></a><span id="l3.461">     let file = this.getItemsFile(aServer);</span>
<a href="#l3.462"></a><span id="l3.462">     let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l3.463"></a><span id="l3.463">                           QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l3.464"></a><span id="l3.464">                           getURLSpecFromFile(file);</span>
<a href="#l3.465"></a><span id="l3.465"> </span>
<a href="#l3.466"></a><span id="l3.466">     // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l3.467"></a><span id="l3.467">     // once we've already done it once.</span>
<a href="#l3.468"></a><span id="l3.468">     let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l3.469"></a><span id="l3.469">     if (!ds)</span>
<a href="#l3.470"></a><span id="l3.470">       throw new Error(&quot;FeedUtils.getItemsDS: can't get feed items &quot; +</span>
<a href="#l3.471"></a><span id="l3.471">                       &quot;data source - &quot; + url);</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473">     // Note that it this point the datasource may not be loaded yet.</span>
<a href="#l3.474"></a><span id="l3.474">     // You have to QueryInterface it to nsIRDFRemoteDataSource and check</span>
<a href="#l3.475"></a><span id="l3.475">     // its &quot;loaded&quot; property to be sure.  You can also attach an observer</span>
<a href="#l3.476"></a><span id="l3.476">     // which will get notified when the load is complete.</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-    return ds;</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+    this[aServer.serverURI] = {};</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+    return this[aServer.serverURI][&quot;FeedItemsDS&quot;] =</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+             ds.QueryInterface(Ci.nsIRDFRemoteDataSource);</span>
<a href="#l3.481"></a><span id="l3.481">   },</span>
<a href="#l3.482"></a><span id="l3.482"> </span>
<a href="#l3.483"></a><span id="l3.483">   getItemsFile: function(aServer) {</span>
<a href="#l3.484"></a><span id="l3.484">     aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l3.485"></a><span id="l3.485">     let file = aServer.feedItemsDataSourcePath;</span>
<a href="#l3.486"></a><span id="l3.486"> </span>
<a href="#l3.487"></a><span id="l3.487">     // If the file doesn't exist, create it.</span>
<a href="#l3.488"></a><span id="l3.488">     if (!file.exists())</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineat">@@ -757,23 +756,18 @@ var FeedUtils = {</span>
<a href="#l3.490"></a><span id="l3.490">       FeedUtils.log.debug(&quot;downloaded: &quot;+</span>
<a href="#l3.491"></a><span id="l3.491">                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l3.492"></a><span id="l3.492">                           &quot;errorCode:feedName:folder - &quot; +</span>
<a href="#l3.493"></a><span id="l3.493">                           aErrorCode + &quot; : &quot; + feed.name + &quot; : &quot; + location);</span>
<a href="#l3.494"></a><span id="l3.494">       if (this.mSubscribeMode)</span>
<a href="#l3.495"></a><span id="l3.495">       {</span>
<a href="#l3.496"></a><span id="l3.496">         if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l3.497"></a><span id="l3.497">         {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-          // If we get here we should always have a folder by now, either in</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-          // feed.folder or FeedItems created the folder for us.</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-          FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-          // Add feed just adds the feed to the subscription UI and flushes the</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-          // datasource.</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-          FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+          // Add the feed to the databases.</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+          FeedUtils.addFeed(feed);</span>
<a href="#l3.507"></a><span id="l3.507"> </span>
<a href="#l3.508"></a><span id="l3.508">           // Nice touch: select the folder that now contains the newly subscribed</span>
<a href="#l3.509"></a><span id="l3.509">           // feed.  This is particularly nice if we just finished subscribing</span>
<a href="#l3.510"></a><span id="l3.510">           // to a feed URL that the operating system gave us.</span>
<a href="#l3.511"></a><span id="l3.511">           this.mMsgWindow.windowCommands.selectFolder(feed.folder.URI);</span>
<a href="#l3.512"></a><span id="l3.512"> </span>
<a href="#l3.513"></a><span id="l3.513">           // Check for an existing feed subscriptions window and update it.</span>
<a href="#l3.514"></a><span id="l3.514">           let subscriptionsWindow =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -23,30 +23,26 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.4"></a><span id="l4.4">     // new feeds.</span>
<a href="#l4.5"></a><span id="l4.5">     if (FeedUtils.progressNotifier.mSubscribeMode)</span>
<a href="#l4.6"></a><span id="l4.6">     {</span>
<a href="#l4.7"></a><span id="l4.7">       FeedUtils.log.warn(&quot;downloadFeed: Aborting RSS New Mail Check. &quot; +</span>
<a href="#l4.8"></a><span id="l4.8">                          &quot;Feed subscription in progress\n&quot;);</span>
<a href="#l4.9"></a><span id="l4.9">       return;</span>
<a href="#l4.10"></a><span id="l4.10">     }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let allFolders = Cc[&quot;@mozilla.org/array;1&quot;].</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                     createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    let allFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.15"></a><span id="l4.15">     if (!aFolder.isServer) {</span>
<a href="#l4.16"></a><span id="l4.16">       // Add the base folder; it does not get returned by ListDescendants. Do not</span>
<a href="#l4.17"></a><span id="l4.17">       // add the account folder as it doesn't have the feedUrl property or even</span>
<a href="#l4.18"></a><span id="l4.18">       // a msgDatabase necessarily.</span>
<a href="#l4.19"></a><span id="l4.19">       allFolders.appendElement(aFolder, false);</span>
<a href="#l4.20"></a><span id="l4.20">     }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     aFolder.ListDescendants(allFolders);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-    let trashFolder =</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-        aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27">     function feeder() {</span>
<a href="#l4.28"></a><span id="l4.28">       let folder;</span>
<a href="#l4.29"></a><span id="l4.29">       let numFolders = allFolders.length;</span>
<a href="#l4.30"></a><span id="l4.30">       for (let i = 0; i &lt; numFolders; i++) {</span>
<a href="#l4.31"></a><span id="l4.31">         folder = allFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l4.32"></a><span id="l4.32">         FeedUtils.log.debug(&quot;downloadFeed: START x/# foldername:uri - &quot; +</span>
<a href="#l4.33"></a><span id="l4.33">                             (i+1) + &quot;/&quot; + numFolders + &quot; &quot; +</span>
<a href="#l4.34"></a><span id="l4.34">                             folder.name + &quot;:&quot; + folder.URI);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineat">@@ -69,22 +65,20 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.36"></a><span id="l4.36">             // Ignore error returns.</span>
<a href="#l4.37"></a><span id="l4.37">             folder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l4.38"></a><span id="l4.38">                    getDatabaseWithReparse(null, null);</span>
<a href="#l4.39"></a><span id="l4.39">           }</span>
<a href="#l4.40"></a><span id="l4.40">           catch (ex) {}</span>
<a href="#l4.41"></a><span id="l4.41">           continue;</span>
<a href="#l4.42"></a><span id="l4.42">         }</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        let feedUrlArray = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+        let feedUrlArray = FeedUtils.syncFeedUrlWithFeedsDS(folder);</span>
<a href="#l4.46"></a><span id="l4.46">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-        // database.  All folders in Trash are now unsubscribed, so perhaps</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-        // we may not want to check that here each biff each folder.</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-        if (!feedUrlArray ||</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-            (aFolder.isServer &amp;&amp; trashFolder &amp;&amp; trashFolder.isAncestorOf(folder)))</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+        // database.  All folders in Trash are skipped.</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+        if (!feedUrlArray)</span>
<a href="#l4.53"></a><span id="l4.53">           continue;</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">         FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot; +</span>
<a href="#l4.56"></a><span id="l4.56">                             folder.name + &quot;:&quot; + feedUrlArray);</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">         FeedUtils.progressNotifier.init(aMsgWindow, false);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">         // We need to kick off a download for each feed.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineat">@@ -212,64 +206,48 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.62"></a><span id="l4.62">     if (!aFolder.isServer)</span>
<a href="#l4.63"></a><span id="l4.63">       feed.folder = aFolder;</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     FeedUtils.progressNotifier.init(aMsgWindow, true);</span>
<a href="#l4.66"></a><span id="l4.66">     FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l4.67"></a><span id="l4.67">     feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l4.68"></a><span id="l4.68">   },</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  updateSubscriptionsDS: function(aFolder, aUnsubscribe)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  updateSubscriptionsDS: function(aFolder, aOrigFolder)</span>
<a href="#l4.72"></a><span id="l4.72">   {</span>
<a href="#l4.73"></a><span id="l4.73">     if (!gExternalScriptsLoaded)</span>
<a href="#l4.74"></a><span id="l4.74">       loadScripts();</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-    FeedUtils.log.debug(&quot;updateSubscriptionsDS: folder changed, name:unsubscribe - &quot; +</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-                        aFolder.filePath.path + &quot;:&quot; + aUnsubscribe);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    FeedUtils.log.debug(&quot;updateSubscriptionsDS: folder changed, aFolder - &quot; +</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+                        aFolder.filePath.path);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    FeedUtils.log.debug(&quot;updateSubscriptionsDS: &quot; + (aOrigFolder ?</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+                        &quot;move/copy, aOrigFolder  - &quot; + aOrigFolder.filePath.path :</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+                        &quot;rename&quot;));</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-    // An rss folder was just changed, get the folder's feedUrls and update</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-    // our feed data source.</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-    if (!feedUrlArray)</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-      // No feedUrls in this folder.</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    if ((aOrigFolder &amp;&amp; FeedUtils.isInTrash(aOrigFolder)) ||</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+        (!aOrigFolder &amp;&amp; FeedUtils.isInTrash(aFolder)))</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      // Move within trash, or rename in trash; no subscriptions already.</span>
<a href="#l4.92"></a><span id="l4.92">       return;</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    let newFeedUrl, id, resource, node;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(aFolder.server);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    let trashFolder =</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-        aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    for (let url in feedUrlArray)</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-      newFeedUrl = feedUrlArray[url];</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-      if (newFeedUrl)</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-      {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-        FeedUtils.log.debug(&quot;updateSubscriptionsDS: processing url - &quot; +</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-                            newFeedUrl);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    let newFolder = aFolder;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    if (aOrigFolder)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      // A folder was moved, get the new folder. Don't process the entire parent!</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      newFolder = aFolder.getChildNamed(aOrigFolder.name);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    FeedUtils.updateFolderChangeInFeedsDS(newFolder, aOrigFolder);</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-        id = FeedUtils.rdf.GetResource(newFeedUrl);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-        // If explicit delete or move to trash, unsubscribe.</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-        if (aUnsubscribe ||</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-            (trashFolder &amp;&amp; trashFolder.isAncestorOf(aFolder)))</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-        {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-          FeedUtils.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-        }</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-        else</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-        {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-          resource = FeedUtils.rdf.GetResource(aFolder.URI);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-          // Get the node for the current folder URI.</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-          node = ds.GetTarget(id, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-          if (node)</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-            ds.Change(id, FeedUtils.FZ_DESTFOLDER, node, resource);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-          else</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-            FeedUtils.addFeed(newFeedUrl, resource.name, resource);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-        }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-      }</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-    } // for each feed url in the folder property</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    // There may be subfolders, but we only get a single notification; iterate</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    // over all descendent folders of the folder whose location has changed.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    let subFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    newFolder.ListDescendants(subFolders);</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    for (let i = 0; i &lt; subFolders.length; i++)</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    {</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+      let subFolder = subFolders.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+      FeedUtils.updateFolderChangeInFeedsDS(subFolder, aOrigFolder);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    }</span>
<a href="#l4.142"></a><span id="l4.142">   },</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144">   QueryInterface: function(aIID)</span>
<a href="#l4.145"></a><span id="l4.145">   {</span>
<a href="#l4.146"></a><span id="l4.146">     if (aIID.equals(Components.interfaces.nsINewsBlogFeedDownloader) ||</span>
<a href="#l4.147"></a><span id="l4.147">         aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l4.148"></a><span id="l4.148">       return this;</span>
<a href="#l4.149"></a><span id="l4.149"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/local/public/nsINewsBlogFeedDownloader.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/local/public/nsINewsBlogFeedDownloader.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,25 +3,30 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> interface nsIMsgFolder;</span>
<a href="#l5.9"></a><span id="l5.9"> interface nsIUrlListener;</span>
<a href="#l5.10"></a><span id="l5.10"> interface nsIMsgWindow;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(c1c47796-c8b0-4d12-97aa-c93883ea1c97)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(6839c636-41c2-11e3-b346-00269e4fddc1)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsINewsBlogFeedDownloader : nsISupports</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16">   void downloadFeed(in string aUrl, in nsIMsgFolder aFolder,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                     in boolean aQuickMode, in wstring aTitle,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-          in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                    in boolean aQuickMode, in wstring aTitle,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+                    in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  /* A convient method to subscribe to feeds without going through the subscribe UI</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-     used by drag and drop */</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  void subscribeToFeed(in string aUrl, in nsIMsgFolder aFolder, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  /**</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+   * A convient method to subscribe to feeds without going through the Subscribe</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+   * dialog; used by drag and drop and commandline.</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+   */</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  void subscribeToFeed(in string aUrl, in nsIMsgFolder aFolder,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+                       in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  /* called when the RSS Incoming Server detects a change to an RSS folder. For instance, the user just</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-     deleted an RSS folder and we need to update the subscriptions data source. Or the user renamed an RSS folder...</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  */</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  void updateSubscriptionsDS(in nsIMsgFolder aFolder, in boolean aUnsubscribe);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  /**</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * Called when the RSS Incoming Server detects a change to an RSS folder name,</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   * such as delete (move to trash), move/copy, or rename. We then need to update</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * the feeds.rdf subscriptions data source.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   */</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  void updateSubscriptionsDS(in nsIMsgFolder aFolder, in nsIMsgFolder aOrigFolder);</span>
<a href="#l5.42"></a><span id="l5.42"> };</span>
<a href="#l5.43"></a><span id="l5.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -188,80 +188,63 @@ NS_IMETHODIMP nsRssIncomingServer::MsgsM</span>
<a href="#l6.4"></a><span id="l6.4"> NS_IMETHODIMP nsRssIncomingServer::MsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l6.5"></a><span id="l6.5">                                                  nsIMsgDBHdr *aNewHdr)</span>
<a href="#l6.6"></a><span id="l6.6"> {</span>
<a href="#l6.7"></a><span id="l6.7">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> NS_IMETHODIMP nsRssIncomingServer::FolderAdded(nsIMsgFolder *aFolder)</span>
<a href="#l6.11"></a><span id="l6.11"> {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  return FolderChanged(aFolder, false);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  // Nothing to do. Not necessary for new folder adds, as a new folder never</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  // has a subscription.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.16"></a><span id="l6.16"> }</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> NS_IMETHODIMP nsRssIncomingServer::FolderDeleted(nsIMsgFolder *aFolder)</span>
<a href="#l6.19"></a><span id="l6.19"> {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  return FolderChanged(aFolder, true);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  // Not necessary for folder deletes, which are move to Trash and handled by</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  // movecopy. Virtual folder or trash folder deletes send a folderdeleted,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  // but these should have no subscriptions already.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.25"></a><span id="l6.25"> }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> NS_IMETHODIMP nsRssIncomingServer::FolderMoveCopyCompleted(bool aMove, nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDestFolder)</span>
<a href="#l6.28"></a><span id="l6.28"> {</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  return FolderChanged(aDestFolder, false);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  return FolderChanged(aDestFolder, aSrcFolder);</span>
<a href="#l6.31"></a><span id="l6.31"> }</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> NS_IMETHODIMP nsRssIncomingServer::FolderRenamed(nsIMsgFolder *aOrigFolder, nsIMsgFolder *aNewFolder)</span>
<a href="#l6.34"></a><span id="l6.34"> {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  return FolderChanged(aNewFolder, false);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  return FolderChanged(aNewFolder, nullptr);</span>
<a href="#l6.37"></a><span id="l6.37"> }</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39"> NS_IMETHODIMP nsRssIncomingServer::ItemEvent(nsISupports *aItem, const nsACString &amp;aEvent, nsISupports *aData)</span>
<a href="#l6.40"></a><span id="l6.40"> {</span>
<a href="#l6.41"></a><span id="l6.41">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.42"></a><span id="l6.42"> }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-nsresult nsRssIncomingServer::FolderChanged(nsIMsgFolder *aFolder, bool aUnsubscribe)</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+nsresult nsRssIncomingServer::FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder)</span>
<a href="#l6.46"></a><span id="l6.46"> {</span>
<a href="#l6.47"></a><span id="l6.47">   if (!aFolder)</span>
<a href="#l6.48"></a><span id="l6.48">     return NS_OK;</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.51"></a><span id="l6.51">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l6.52"></a><span id="l6.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">   nsCString type;</span>
<a href="#l6.55"></a><span id="l6.55">   rv = server-&gt;GetType(type);</span>
<a href="#l6.56"></a><span id="l6.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  if (type.EqualsLiteral(&quot;rss&quot;))</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  {</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    nsCOMPtr &lt;nsINewsBlogFeedDownloader&gt; rssDownloader = do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    rssDownloader-&gt;UpdateSubscriptionsDS(aFolder, aUnsubscribe);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  if (!type.EqualsLiteral(&quot;rss&quot;))</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+    return rv;</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    if (!aUnsubscribe)</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-      // If the user was moving a set of nested folders, we only</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-      // get a single notification, so we need to iterate over all of the</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-      // descedent folders of the folder whose location has changed.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-      nsCOMPtr&lt;nsIArray&gt; allDescendents;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-      rv = aFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-      uint32_t cnt = 0;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-      allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; rssFolder;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-      for (uint32_t index = 0; index &lt; cnt; index++)</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-        rssFolder = do_QueryElementAt(allDescendents, index, &amp;rv);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; rssFolder)</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-          rssDownloader-&gt;UpdateSubscriptionsDS(rssFolder, aUnsubscribe);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-      }</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    }</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  }</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  nsCOMPtr &lt;nsINewsBlogFeedDownloader&gt; rssDownloader = do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  rssDownloader-&gt;UpdateSubscriptionsDS(aFolder, aOrigFolder);</span>
<a href="#l6.91"></a><span id="l6.91">   return rv;</span>
<a href="#l6.92"></a><span id="l6.92"> }</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94"> NS_IMETHODIMP</span>
<a href="#l6.95"></a><span id="l6.95"> nsRssIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l6.96"></a><span id="l6.96"> {</span>
<a href="#l6.97"></a><span id="l6.97">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l6.98"></a><span id="l6.98">   *aSortOrder = 400000000;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -23,22 +23,21 @@ public:</span>
<a href="#l7.4"></a><span id="l7.4">     NS_DECL_NSIRSSINCOMINGSERVER</span>
<a href="#l7.5"></a><span id="l7.5">     NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l7.6"></a><span id="l7.6">     NS_DECL_NSIMSGFOLDERLISTENER</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">     NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) MOZ_OVERRIDE;</span>
<a href="#l7.9"></a><span id="l7.9">     NS_IMETHOD GetSupportsDiskSpace(bool *aSupportsDiskSpace) MOZ_OVERRIDE;</span>
<a href="#l7.10"></a><span id="l7.10">     NS_IMETHOD GetAccountManagerChrome(nsAString&amp; aResult) MOZ_OVERRIDE;</span>
<a href="#l7.11"></a><span id="l7.11">     NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) MOZ_OVERRIDE;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-						) MOZ_OVERRIDE;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) MOZ_OVERRIDE;</span>
<a href="#l7.15"></a><span id="l7.15">     NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) MOZ_OVERRIDE;</span>
<a href="#l7.16"></a><span id="l7.16">     NS_IMETHOD GetSortOrder(int32_t* aSortOrder) MOZ_OVERRIDE;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">     nsRssIncomingServer();</span>
<a href="#l7.19"></a><span id="l7.19">     virtual ~nsRssIncomingServer();</span>
<a href="#l7.20"></a><span id="l7.20"> protected:</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-    nsresult FolderChanged(nsIMsgFolder *aFolder, bool aUnsubscribe);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    nsresult FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder);</span>
<a href="#l7.23"></a><span id="l7.23">     nsresult FillInDataSourcePath(const nsAString&amp; aDataSourceName, nsIFile ** aLocation);</span>
<a href="#l7.24"></a><span id="l7.24">     static nsrefcnt gInstanceCount;</span>
<a href="#l7.25"></a><span id="l7.25"> };</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> #endif /* __nsRssIncomingServer_h */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

