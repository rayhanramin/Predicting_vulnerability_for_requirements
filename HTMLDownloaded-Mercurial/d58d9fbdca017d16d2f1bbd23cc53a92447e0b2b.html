<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27855:d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b" />
<meta property="og:url" content="/comm-central/rev/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b" />
<meta property="og:description" content="Bug 1584614 - Remove source code for the Provider for Google Calendar. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">shortlog</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">files</a> |
changeset |
<a href="/comm-central/raw-rev/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">raw</a>  | <a href="/comm-central/archive/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584614">Bug 1584614</a> - Remove source code for the Provider for Google Calendar. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 06 Oct 2019 21:51:19 +0200</td></tr>

<tr>
 <td>changeset 27855</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b</a></td>
</tr>



<tr>
<td>parent 27854</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6b88366d415ec0bf89ff6125e683a4a61347ee0f">6b88366d415ec0bf89ff6125e683a4a61347ee0f</a>
</td>
</tr>

<tr>
<td>child 27856</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e7476e934b191ffac787208323191c9c034049ce">e7476e934b191ffac787208323191c9c034049ce</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b">16518</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 06 Oct 2019 21:57:35 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e7476e934b19 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e7476e934b191ffac787208323191c9c034049ce">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e7476e934b191ffac787208323191c9c034049ce&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7476e934b191ffac787208323191c9c034049ce&newProject=comm-central&newRevision=d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7476e934b191ffac787208323191c9c034049ce&newProject=comm-central&newRevision=d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7476e934b191ffac787208323191c9c034049ce&newProject=comm-central&newRevision=d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584614">1584614</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584614">Bug 1584614</a> - Remove source code for the Provider for Google Calendar. r=darktrojan</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">calendar/base/modules/utils/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/modules/utils/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">calendar/base/themes/common/widgets/calendar-widgets.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/base/themes/common/widgets/calendar-widgets.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties">calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd">calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">calendar/locales/filter.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/filter.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">calendar/locales/l10n.toml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/locales/l10n.toml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/Makefile.in">calendar/providers/gdata/Makefile.in</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/Makefile.in">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/Makefile.in">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.manifest">calendar/providers/gdata/components/calGoogleCalendar.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.manifest">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.manifest">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/components/calGoogleCalendar.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.css">calendar/providers/gdata/content/browserRequest.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.css">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.css">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.js">calendar/providers/gdata/content/browserRequest.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.xul">calendar/providers/gdata/content/browserRequest.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/browserRequest.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gcal.png">calendar/providers/gdata/content/gcal.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gcal.png">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gcal.png">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gcal.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-bindings.css">calendar/providers/gdata/content/gdata-bindings.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-bindings.css">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-bindings.css">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-bindings.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.js">calendar/providers/gdata/content/gdata-calendar-creation.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.xul">calendar/providers/gdata/content/gdata-calendar-creation.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-creation.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.js">calendar/providers/gdata/content/gdata-calendar-properties.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.xul">calendar/providers/gdata/content/gdata-calendar-properties.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-calendar-properties.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.css">calendar/providers/gdata/content/gdata-event-dialog-reminder.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.css">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.css">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">calendar/providers/gdata/content/gdata-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">calendar/providers/gdata/content/gdata-event-dialog-reminder.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.js">calendar/providers/gdata/content/gdata-event-dialog.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.xul">calendar/providers/gdata/content/gdata-event-dialog.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-event-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.js">calendar/providers/gdata/content/gdata-lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.xul">calendar/providers/gdata/content/gdata-lightning-item-iframe.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-iframe.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul">calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-overlay.xul">calendar/providers/gdata/content/gdata-migration-overlay.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-overlay.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-overlay.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-overlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-wizard.xul">calendar/providers/gdata/content/gdata-migration-wizard.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-wizard.xul">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-wizard.xul">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration-wizard.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration.js">calendar/providers/gdata/content/gdata-migration.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/gdata-migration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/reminder-action-sms.svg">calendar/providers/gdata/content/reminder-action-sms.svg</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/reminder-action-sms.svg">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/reminder-action-sms.svg">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/content/reminder-action-sms.svg">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/defaults/preferences.js">calendar/providers/gdata/defaults/preferences.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/defaults/preferences.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/defaults/preferences.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/defaults/preferences.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/jar.mn">calendar/providers/gdata/jar.mn</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/jar.mn">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/jar.mn">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/manifest.json">calendar/providers/gdata/manifest.json</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/manifest.json">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/manifest.json">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/OAuth2.jsm">calendar/providers/gdata/modules/OAuth2.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/OAuth2.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/OAuth2.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/OAuth2.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataLogging.jsm">calendar/providers/gdata/modules/gdataLogging.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataLogging.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataLogging.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataLogging.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/timezoneMap.jsm">calendar/providers/gdata/modules/timezoneMap.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/timezoneMap.jsm">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/timezoneMap.jsm">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/modules/timezoneMap.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/moz.build">calendar/providers/gdata/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/moz.build">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/moz.build">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/providers/gdata/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">calendar/test/unit/xpcshell-libical.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/calendar/test/unit/xpcshell-libical.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">mail/app.mozbuild</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/app.mozbuild">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">mail/testsuite-targets.mk</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/mail/testsuite-targets.mk">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">taskcluster/ci/test/tests.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/ci/test/tests.yml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">file</a> |
<a href="/comm-central/annotate/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">annotate</a> |
<a href="/comm-central/diff/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">diff</a> |
<a href="/comm-central/comparison/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">comparison</a> |
<a href="/comm-central/log/d58d9fbdca017d16d2f1bbd23cc53a92447e0b2b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -371,18 +371,16 @@ var calprovider = {</span>
<a href="#l1.4"></a><span id="l1.4">       }</span>
<a href="#l1.5"></a><span id="l1.5">       calprovider.getCalendarDirectory.mDir = dir;</span>
<a href="#l1.6"></a><span id="l1.6">     }</span>
<a href="#l1.7"></a><span id="l1.7">     return calprovider.getCalendarDirectory.mDir.clone();</span>
<a href="#l1.8"></a><span id="l1.8">   },</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   /**</span>
<a href="#l1.11"></a><span id="l1.11">    * Base prototype to be used implementing a provider.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-   *</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-   * @see e.g. providers/gdata</span>
<a href="#l1.14"></a><span id="l1.14">    */</span>
<a href="#l1.15"></a><span id="l1.15">   BaseClass: class {</span>
<a href="#l1.16"></a><span id="l1.16">     /**</span>
<a href="#l1.17"></a><span id="l1.17">      * The transient properties that are not pesisted to storage</span>
<a href="#l1.18"></a><span id="l1.18">      */</span>
<a href="#l1.19"></a><span id="l1.19">     static get mTransientProperties() {</span>
<a href="#l1.20"></a><span id="l1.20">       return {</span>
<a href="#l1.21"></a><span id="l1.21">         &quot;cache.uncachedCalendar&quot;: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/themes/common/widgets/calendar-widgets.css</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/themes/common/widgets/calendar-widgets.css</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -116,22 +116,21 @@ checkbox.treenode-checkbox &gt; .checkbox-l</span>
<a href="#l2.4"></a><span id="l2.4">   cursor:default;</span>
<a href="#l2.5"></a><span id="l2.5"> }</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> .categories-textbox {</span>
<a href="#l2.8"></a><span id="l2.8">   -moz-appearance: textfield;</span>
<a href="#l2.9"></a><span id="l2.9"> }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> /*</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * Note that #calendar-list is used for 3 separate lists that look similar,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Note that #calendar-list is used for 2 separate lists that look similar,</span>
<a href="#l2.14"></a><span id="l2.14">  * but are otherwise independent:</span>
<a href="#l2.15"></a><span id="l2.15">  *</span>
<a href="#l2.16"></a><span id="l2.16">  * - calendar-providerUninstall-dialog.xul</span>
<a href="#l2.17"></a><span id="l2.17">  * - messenger-overlay-sidebar.xul</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">- * - gdata-calendar-creation.xul</span>
<a href="#l2.19"></a><span id="l2.19">  *</span>
<a href="#l2.20"></a><span id="l2.20">  * Please be careful when changing the following CSS.</span>
<a href="#l2.21"></a><span id="l2.21">  */</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> #calendar-list-inner-pane &gt; #calendar-list {</span>
<a href="#l2.24"></a><span id="l2.24">   -moz-appearance: none;</span>
<a href="#l2.25"></a><span id="l2.25">   margin: 0;</span>
<a href="#l2.26"></a><span id="l2.26">   border-style: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/providers/gdata/amo.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-# The addon name and short description are localized in gdata.properties</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-# This is the addon description. The en-US version will sometimes have</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-# additional news items at the end of the description. If you notice this and</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-# would like them translated, please email the author directly.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-# params: %1$S - See amo.faqlocation</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-#         %2$S - See amo.website</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-# NOTE: This is a multiline string, be sure to end lines with \n\ to make sure</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-# it stays that way.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-amo.description=This extension allows Lightning to read and write events and tasks to a Google Calendar.\n\</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-\n\</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-Please read &lt;a href=&quot;%1$S&quot;&gt;the FAQ&lt;/a&gt; for more details and before filing a bug. Also, be sure to visit the &lt;a href=&quot;%2$S&quot;&gt;discussion forums&lt;/a&gt;, maybe your bug already has a solution!\n\</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-\n\</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-To search for and submit bugs, visit http://bugzilla.mozilla.org/ \n\</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-Product: Calendar\n\</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-Component: Provider: GData</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-# You can change this if you have localized the FAQ on wiki.mozilla.org</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-amo.faqlocation=http://wiki.mozilla.org/Calendar:GDATA_Provider</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-# You can change this if you would like to provide localized support.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-amo.email=</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-amo.website=http://groups.google.com/group/provider-for-google-calendar</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.dtd</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-&lt;!ENTITY gdata-provider.label &quot;Google Calendar&quot;&gt;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-&lt;!ENTITY gdata.privacy.default.label &quot;Google Default&quot;&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-&lt;!ENTITY gdata.privacy.default.accesskey &quot;D&quot;&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-&lt;!ENTITY gdata.migration.title &quot;Migrate read-only calendars&quot;&gt;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-&lt;!ENTITY gdata.migration.description &quot;The Provider for Google Calendar has detected that you have existing calendars that are only capable of accessing Google Calendar in read-only mode. If you would like to upgrade any of these calendars, please select them below&quot;&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-&lt;!ENTITY gdata.migration.upgrade.label &quot;Upgrade&quot;&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-&lt;!ENTITY gdata.migration.upgrade.accesskey &quot;U&quot;&gt;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-&lt;!ENTITY gdata.migration.showagain.label &quot;Always check &quot;&gt;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-&lt;!ENTITY gdata.reminder.default &quot;Default Reminder&quot;&gt;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-&lt;!ENTITY gdata.reminder.action.sms.label &quot;Send a Text Message&quot;&gt;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-&lt;!ENTITY gdata.wizard.session.description &quot;Please pick an existing session or enter your email address to create a new session. You only need one session per account.&quot;&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-&lt;!ENTITY gdata.wizard.calendars.description &quot;Please select the calendars and task lists you would like to subscribe to.&quot;&gt;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-&lt;!ENTITY gdata.wizard.nextstep.description &quot;Please advance to the next step to set up your calendars.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/providers/gdata/gdata.properties</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,60 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-# If you wish to be mentioned as a translator, please make sure your name and</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-# email is in the licence block as a contributor. Multiple names are fine too.</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-# extension information.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-# When localizing, please keep in mind that these strings had to be approved by</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-# the Google Brand Features Team. Be sure to make clear that this extension is</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-# *FOR* Google Calendar and not *BY* Google. Also, it was explicitly stated,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-# that the phrase &quot;Google Calendar&quot; should be localized just as it is on the</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-# localized versions of the Google Calendar UI.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-# Extension Manager strings</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.description=Allows bidirectional access to Google Calendar</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name=Provider for Google Calendar</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-calendarsHeader=Calendars</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-taskListsHeader=Task Lists</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-# LOCALIZATION NOTE (busyTitle):</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-# Events with only free/busy access don't have a title, they will use this</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-# title instead. The calendar name is used as a parameter, since its often</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-# named after the person whose calendar you are viewing.</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-# %1$S = The calendar name</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-busyTitle=Busy (%1$S)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-# LOCALIZATION NOTE (quotaExceeded):</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-# This is shown when the request quota has been exceeded.</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-# %1$S = The session id (what the user enters as an email</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-#                        in the new calendar dialog)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-quotaExceeded=The quota for %1$S has been exceeded, please try again later.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-providerOutdated=This version of the provider has expired, please update to the latest version.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-reminderOutOfRange=Google Calendar only allows reminders up to 4 weeks before the event starts.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-# LOCALIZATION NOTE (syncProgressEvent):</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-# %1$S = The name of the calendar that is being synchronized</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-# %2$S = The number of events that have been synchronzed</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-# %3$S = The total number of events in the synchronization run</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-syncProgressEvent=Synchronizing %1$S event %2$S of %3$S</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-# LOCALIZATION NOTE (syncProgressTask):</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-# %1$S = The name of the calendar that is being synchronized</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-# %2$S = The number of tasks that have been synchronzed</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-# %3$S = The total number of tasks in the synchronization run</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-syncProgressTask=Synchronizing %1$S task %2$S of %3$S</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-# LOCALIZATION NOTE (syncStatus):</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-# %1$S = The name of the calendar that is being synchronized</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-syncStatus=Synchronizing Calendar %1$S</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-# LOCALIZATION NOTE (requestWindowDescription):</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-# %1$S - The session id (email) used for authentication</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-requestWindowDescription=The Provider for Google Calendar would like to access your account %1$S to retrieve events and tasks. Credentials and calendaring data is only transferred between your computer and Google, no third party sites are involved.</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-# LOCALIZATION NOTE (requestWindowTitle)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-# %1$S - The session id (email) used for authentication</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-requestWindowTitle=Sign in to your account %1$S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/locales/filter.py</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/locales/filter.py</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -15,14 +15,10 @@ def test(mod, path, entity = None):</span>
<a href="#l6.4"></a><span id="l6.4">   if path == &quot;chrome/calendar/calendar-event-dialog.properties&quot;:</span>
<a href="#l6.5"></a><span id="l6.5">     return not re.match(r&quot;.*Nounclass[1-9]&quot;, entity)</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   # most extraction related strings are not required</span>
<a href="#l6.8"></a><span id="l6.8">   if path == &quot;chrome/calendar/calendar-extract.properties&quot;:</span>
<a href="#l6.9"></a><span id="l6.9">     if not re.match(r&quot;from.today&quot;, entity):</span>
<a href="#l6.10"></a><span id="l6.10">       return &quot;report&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  # Provider for Google Calendar AMO strings do not have to be translated</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  if path == &quot;chrome/calendar/providers/gdata/amo.properties&quot;:</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    return &quot;report&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-</span>
<a href="#l6.16"></a><span id="l6.16">   # Everything else should be taken into account</span>
<a href="#l6.17"></a><span id="l6.17">   return True</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/locales/l10n.toml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/locales/l10n.toml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -77,14 +77,8 @@ locales = [</span>
<a href="#l7.4"></a><span id="l7.4">     key = &quot;re:.*Nounclass[1-9].*&quot;</span>
<a href="#l7.5"></a><span id="l7.5">     action = &quot;ignore&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> # most extraction related strings are not required</span>
<a href="#l7.8"></a><span id="l7.8"> [[filters]]</span>
<a href="#l7.9"></a><span id="l7.9">     path = &quot;{l}calendar/chrome/calendar/calendar-extract.properties&quot;</span>
<a href="#l7.10"></a><span id="l7.10">     key = &quot;re:.*from\\.today.*&quot;</span>
<a href="#l7.11"></a><span id="l7.11">     action = &quot;warning&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-# Provider for Google Calendar AMO strings do not have to be translated</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-[[filters]]</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    path = &quot;{l}calendar/chrome/calendar/providers/gdata/amo.properties&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    key = &quot;re:.&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-    action = &quot;warning&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/calendar/providers/gdata/Makefile.in</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-XPI_PKGNAME = gdata-provider</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-final_parent = $(ABS_DIST)/bin/extensions</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-ifdef MOZ_ARTIFACT_BUILDS</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-final_dest = $(final_parent)/{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-tools::</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-	$(RM) -r $(final_dest)</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-	$(NSINSTALL) -D $(final_dest)</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-	$(call copy_dir,$(FINAL_TARGET),$(final_dest))</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-else</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-	$(NSINSTALL) -D $(final_parent)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-	ln -s $(ABS_DIST)/xpi-stage/gdata-provider $(final_dest)</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-endif</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-endif # MOZ_ARTIFACT_BUILDS</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-stage-package:</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-ifdef MOZ_ARTIFACT_BUILDS</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-	$(PYTHON) -u $(MOZILLA_DIR)/build/upload.py $(DIST)/xpi-stage/$(XPI_PKGNAME).xpi</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-else</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-	$(PYTHON) -u $(MOZILLA_DIR)/build/upload.py $(final_parent)/$(XPI_PKGNAME).xpi</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,926 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-}</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-var { stringException } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-var { calGoogleRequest, getCorrectedDate, API_BASE } = ChromeUtils.import(</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-var { getGoogleSessionManager } = ChromeUtils.import(</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataSession.jsm&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-var {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  ItemToJSON,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  JSONToItem,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  ItemSaver,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  checkResolveConflict,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  getGoogleId,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-  getItemMetadata,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  saveItemMetadata,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  deleteItemMetadata,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  migrateItemMetadata,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  JSONToAlarm,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-} = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-var cIOL = Ci.calIOperationListener;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-var MIN_REFRESH_INTERVAL = 30;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-/**</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">- * calGoogleCalendar</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">- * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">- * Provider.</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">- *</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">- * @class</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">- * @constructor</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">- */</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-function calGoogleCalendar() {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  this.initProviderBase();</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  this.mThrottle = Object.create(null);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-}</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-var calGoogleCalendarClassID = Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-var calGoogleCalendarInterfaces = [Ci.calICalendar, Ci.calISchedulingSupport, Ci.calIChangeLog];</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-calGoogleCalendar.prototype = {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  classID: calGoogleCalendarClassID,</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  QueryInterface: cal.generateQI(calGoogleCalendarInterfaces),</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  classInfo: cal.generateCI({</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    classID: calGoogleCalendarClassID,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    interfaces: calGoogleCalendarInterfaces,</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  }),</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  /* Used to reset the local cache between releases */</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  CACHE_DB_VERSION: 3,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  /* Member Variables */</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  mCalendarName: null,</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  mThrottle: null,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  mThrottleLimits: {</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    calendarList: 3600 * 1000,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    events: 30 * 1000,</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-    tasks: 30 * 1000,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  },</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  /* Public Members */</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  session: null,</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  /**</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-   * Make sure a session is available.</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-   */</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-  ensureSession: function() {</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    if (!this.session) {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-      // Now actually set up the session</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-      let sessionMgr = getGoogleSessionManager();</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-      this.session = sessionMgr.getSessionByCalendar(this, true);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-      // Aside from setting up the session, bump the refresh interval to</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-      // a higher value if its below the minimal refresh interval to</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-      // avoid exceeding quota.</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-      let interval = this.getProperty(&quot;refreshInterval&quot;);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-      if (interval &lt; MIN_REFRESH_INTERVAL &amp;&amp; interval != 0) {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-        cal.LOG(</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-          &quot;[calGoogleCalendar] Sorry, auto-refresh intervals under &quot; +</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-            MIN_REFRESH_INTERVAL +</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-            &quot; minutes would cause the quota to be reached too fast.&quot;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-        );</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-        this.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-      }</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    }</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  },</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  ensureWritable: function() {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    // Check if calendar is readonly</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    if (this.readOnly) {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-      throw new Components.Exception(&quot;&quot;, Ci.calIErrors.CAL_IS_READONLY);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    }</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  },</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  get isDefaultCalendar() {</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    return this.mCalendarName ? !this.mCalendarName.endsWith(&quot;@group.calendar.google.com&quot;) : false;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  },</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-  /*</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-   * implement calICalendar</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-   */</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-  get type() {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    return &quot;gdata&quot;;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-  },</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  get providerID() {</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    return &quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;;</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  },</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  get canRefresh() {</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-    return true;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  },</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-  get id() {</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-    return this.mID;</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-  },</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-  set id(val) {</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-    let setter = this.__proto__.__proto__.__lookupSetter__(&quot;id&quot;);</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-    val = setter.call(this, val);</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-    if (this.id &amp;&amp; this.uri) {</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-      this.ensureSession();</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-    }</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-    return val;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  },</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-  get uri() {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-    return this.mUri;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-  },</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-  set uri(aUri) {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-    const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-    this.mUri = aUri;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-    if (aUri &amp;&amp; aUri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-      // new format:  googleapi://session-id/?calendar=calhash@group.calendar.google.com&amp;tasks=taskhash</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-      let [fullUser, path] = aUri.pathQueryRef.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-      let keyvalues = path</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-        .substr(1)</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-        .split(&quot;&amp;&quot;)</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-        .filter(Boolean);</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-      let pairs = keyvalues.map(keyvalue =&gt; keyvalue.split(&quot;=&quot;, 2).map(decodeURIComponent));</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-      let parameters = new Map(pairs);</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-      if (parameters.size == 0) {</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-        this.mCalendarName = fullUser;</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-        this.mTasklistName = this.isDefaultCalendar ? &quot;@default&quot; : null;</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-      } else {</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-        this.mCalendarName = parameters.get(&quot;calendar&quot;);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-        this.mTasklistName = parameters.get(&quot;tasks&quot;);</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-      }</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-      // Users that installed 1.0 had an issue where secondary calendars</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-      // were migrated to their own session. This code fixes that and</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-      // should be removed once 1.0.1 has been out for a while.</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-      let googleUser = Services.prefs.getStringPref(</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-        &quot;calendar.google.calPrefs.&quot; + fullUser + &quot;.googleUser&quot;,</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-        null</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-      );</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-      if (googleUser &amp;&amp; googleUser != fullUser) {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-        let newUri = &quot;googleapi://&quot; + googleUser + &quot;/&quot; + path;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Migrating url format from &quot; + aUri.spec + &quot; to &quot; + newUri);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-        this.setProperty(&quot;uri&quot;, newUri);</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-        this.mUri = Services.io.newURI(newUri);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-      }</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-      // Unit tests will use a local uri, if the magic parameter is passed.</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-      let port = parameters.get(&quot;testport&quot;);</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-      if (port) {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Redirecting request to test port &quot; + port);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-        API_BASE.EVENTS = &quot;http://localhost:&quot; + port + &quot;/calendar/v3/&quot;;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-        API_BASE.TASKS = &quot;http://localhost:&quot; + port + &quot;/tasks/v1/&quot;;</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-      }</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-    } else if (aUri &amp;&amp; protocols.some(scheme =&gt; aUri.schemeIs(scheme))) {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-      // Parse google url, catch private cookies, public calendars,</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-      // basic and full types, bogus ics file extensions, invalid hostnames</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-      let re = new RegExp(</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-        &quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-          &quot;([^/]+)/(public|private|free-busy)-?([^/]+)?/&quot; +</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-          &quot;(full|basic)(.ics)?$&quot;</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-      );</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-      let matches = aUri.pathQueryRef.match(re);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-      if (matches) {</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-        this.mCalendarName = decodeURIComponent(matches[2]);</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-        let googleUser = Services.prefs.getStringPref(</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-          &quot;calendar.google.calPrefs.&quot; + this.mCalendarName + &quot;.googleUser&quot;,</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-          null</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-        );</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-        let newUri =</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-          &quot;googleapi://&quot; + (googleUser || this.mCalendarName) + &quot;/?calendar=&quot; + matches[2];</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-        // Use the default task list, but only if this is the primary account.</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-        if (googleUser &amp;&amp; googleUser == this.mCalendarName) {</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-          this.mTasklistName = &quot;@default&quot;;</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-          newUri += &quot;&amp;tasks=%40default&quot;;</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-        }</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Migrating url format from &quot; + aUri.spec + &quot; to &quot; + newUri);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-        this.setProperty(&quot;uri&quot;, newUri);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-        this.mUri = Services.io.newURI(newUri);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-      }</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-    }</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-    if (this.id &amp;&amp; this.uri) {</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-      this.ensureSession();</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-    }</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-    return this.mUri;</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-  },</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-  createEventsURI: function(...extraParts) {</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-    let eventsURI = null;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-    if (this.mCalendarName) {</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-      let encodedName = encodeURIComponent(this.mCalendarName);</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-      let parts = [&quot;calendars&quot;, encodedName].concat(extraParts.filter(Boolean));</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-      eventsURI = API_BASE.EVENTS + parts.join(&quot;/&quot;);</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-    }</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-    return eventsURI;</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-  },</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-  createUsersURI: function(...extraParts) {</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-    let parts = [&quot;users&quot;, &quot;me&quot;].concat(extraParts).map(encodeURIComponent);</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-    return API_BASE.EVENTS + parts.join(&quot;/&quot;);</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-  },</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-  createTasksURI: function(...extraParts) {</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-    let tasksURI = null;</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-    if (this.mTasklistName) {</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-      let encodedName = encodeURIComponent(this.mTasklistName);</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-      let parts = [&quot;lists&quot;, encodedName].concat(extraParts.filter(Boolean));</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-      tasksURI = API_BASE.TASKS + parts.join(&quot;/&quot;);</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-    }</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-    return tasksURI;</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-  },</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-  getUpdatedMin: function(aWhich) {</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-    let updatedMin = null;</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-    let lastUpdated = this.getProperty(&quot;lastUpdated.&quot; + aWhich);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    if (lastUpdated) {</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-      updatedMin = cal.createDateTime(lastUpdated);</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-      let lastWeek = cal.dtz.now();</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-      lastWeek.day -= 7;</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-      if (updatedMin.compare(lastWeek) &lt;= 0) {</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-        cal.LOG(</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-          &quot;[calGoogleCalendar] Last updated time for &quot; + aWhich + &quot; is very old, doing full sync&quot;</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-        );</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-        this.resetLog();</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-        updatedMin = null;</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-      }</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-    }</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-    return updatedMin ? getCorrectedDate(updatedMin) : null;</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-  },</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-  checkThrottle: function(type) {</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-    let shouldRequest = true;</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-    let now = new Date().getTime();</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-    if (type in this.mThrottle) {</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-      let then = this.mThrottle[type];</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-      if (now - then &lt; this.mThrottleLimits[type]) {</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-        shouldRequest = false;</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-      }</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-    }</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-    if (shouldRequest) {</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-      this.mThrottle[type] = now;</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-    } else {</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Skipping &quot; + type + &quot; request to reduce requests&quot;);</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-    }</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-    return shouldRequest;</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-  },</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-    switch (aName) {</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-      case &quot;googleCalendarName&quot;:</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-        return this.mCalendarName;</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-      case &quot;isDefaultCalendar&quot;:</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-        return this.isDefaultCalendar;</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-      // Capabilities</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-      case &quot;cache.enabled&quot;:</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-      case &quot;cache.always&quot;:</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-        return true;</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-      case &quot;capabilities.timezones.floating.supported&quot;:</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-      case &quot;capabilities.attachments.supported&quot;:</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-      case &quot;capabilities.priority.supported&quot;:</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-        return false;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-      case &quot;capabilities.privacy.values&quot;:</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-        return [&quot;DEFAULT&quot;, &quot;PUBLIC&quot;, &quot;PRIVATE&quot;];</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-      case &quot;capabilities.alarms.maxCount&quot;:</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-        return 5;</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-      case &quot;capabilities.alarms.actionValues&quot;: {</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-        let actionValues = [&quot;DISPLAY&quot;, &quot;EMAIL&quot;];</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;calendar.google.enableSMSReminders&quot;, false)) {</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-          actionValues.push(&quot;SMS&quot;);</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-        }</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-        return actionValues;</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-      }</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-      case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-        return !!this.mTasklistName;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-      case &quot;capabilities.events.supported&quot;:</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-        return !!this.mCalendarName;</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-      case &quot;readOnly&quot;: {</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-        // If this calendar displays events, make it readonly if we are</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-        // not the owner or have write access.</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-        let accessRole = this.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-        let isReader = accessRole == &quot;freeBusyReader&quot; || accessRole == &quot;reader&quot;;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-        if (this.mCalendarName &amp;&amp; isReader) {</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-          return true;</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-        }</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-        // Otherwise fall through</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-        break;</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-      }</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-      case &quot;organizerId&quot;:</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-        return &quot;mailto:&quot; + this.mCalendarName;</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-      case &quot;itip.transport&quot;:</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-        if (</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-          !this.isDefaultCalendar ||</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-          !Services.prefs.getBoolPref(&quot;calendar.google.enableEmailInvitations&quot;, false)</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-        ) {</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-          // If we explicitly return null here, then these calendars</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-          // will not be included in the list of calendars to accept</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-          // invitations to and imip will effectively be disabled.</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-          return null;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-        }</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-        break;</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-      case &quot;imip.identity.disabled&quot;:</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-        // Disabling this hides the picker for identities in the new</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-        // calendar wizard and calendar properties dialog. This should</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-        // be done for all secondary calendars as they cannot accept</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-        // invitations and if email invitations are generally disabled.</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-        if (</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-          !this.isDefaultCalendar ||</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-          !Services.prefs.getBoolPref(&quot;calendar.google.enableEmailInvitations&quot;, false)</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-        ) {</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-          return true;</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-        }</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-        break;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-    }</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-    return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-  },</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-    switch (aName) {</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-      case &quot;refreshInterval&quot;:</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-        if (aValue &lt; MIN_REFRESH_INTERVAL &amp;&amp; aValue != 0) {</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-          cal.LOG(</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-            &quot;[calGoogleCalendar] Sorry, auto-refresh intervals under &quot; +</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-              MIN_REFRESH_INTERVAL +</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-              &quot; minutes would cause the quota &quot; +</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-              &quot;to be reached too fast.&quot;</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-          );</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineminus">-          this.superCalendar.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-          return undefined;</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-        }</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-        break;</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-    }</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-    return this.__proto__.__proto__.setProperty.apply(this, arguments);</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-  },</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-    return this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-  },</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-  adoptItem: function(aItem, aListener) {</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-    function stackContains(part, max = 8) {</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-      let stack = Components.stack.caller;</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-      while (stack &amp;&amp; --max) {</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-        if (stack.filename &amp;&amp; stack.filename.endsWith(part)) {</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-          return true;</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-        }</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-        stack = stack.caller;</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-      }</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-      return false;</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-    }</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-    // Now this sucks...both invitations and the offline cache send over</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-    // items with the id set, but we have no way to figure out which is</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-    // happening just by inspecting the item. Adding offline items should</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-    // not be an import, but invitations should.</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-    let isImport = aItem.id &amp;&amp; (aItem.id == &quot;xpcshell-import&quot; || stackContains(&quot;calItipUtils.jsm&quot;));</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-    let request = new calGoogleRequest();</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-    (async () =&gt; {</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-      let itemData = ItemToJSON(aItem, this.offlineStorage, isImport);</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-      // Add the calendar to the item, for later use.</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-      aItem.calendar = this.superCalendar;</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-      request.type = request.ADD;</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-      request.calendar = this;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-      if (cal.item.isEvent(aItem)) {</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-        if (isImport) {</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-          cal.LOG(&quot;[calGoogleCalendar] Adding invitation event &quot; + aItem.title);</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-          request.uri = this.createEventsURI(&quot;events&quot;, &quot;import&quot;);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-        } else {</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-          cal.LOG(&quot;[calGoogleCalendar] Adding regular event &quot; + aItem.title);</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-          request.uri = this.createEventsURI(&quot;events&quot;);</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-        }</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;calendar.google.sendEventNotifications&quot;, false)) {</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-          request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-        }</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-      } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Adding task &quot; + aItem.title);</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-        request.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-        // Tasks sent with an id will cause a bad request</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-        delete itemData.id;</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-      }</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineminus">-      if (!request.uri) {</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-        throw Components.Exception(&quot;Item type not supported&quot;, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-      }</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-      request.setUploadData(&quot;application/json; charset=UTF-8&quot;, JSON.stringify(itemData));</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-      let data = await this.session.asyncItemRequest(request);</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-      // All we need to do now is parse the item and complete the</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-      // operation. The cache layer will take care of adding the item</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-      // to the storage.</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-      let metaData = Object.create(null);</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-      let item = JSONToItem(data, this, this.defaultReminders || [], null, metaData);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-      // Make sure to update the etag and id</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-      saveItemMetadata(this.offlineStorage, item.hashId, metaData);</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-      if (aItem.id &amp;&amp; item.id != aItem.id) {</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-        // Looks like the id changed, probably because its an offline</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-        // item. This really sucks for us now, because the cache will</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-        // reset the wrong item. As a hack, delete the item with its</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-        // original id and complete the adoptItem call with the new</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-        // item. This will add the new item to the calendar.</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-        let pcal = cal.async.promisifyCalendar(this.offlineStorage);</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-        await pcal.deleteItem(aItem);</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-      }</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-      return item;</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-    })().then(</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-      item =&gt; {</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Adding &quot; + item.title + &quot; succeeded&quot;);</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-        this.observers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-        this.notifyOperationComplete(aListener, Cr.NS_OK, cIOL.ADD, item.id, item);</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-      },</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-      e =&gt; {</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-        let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-        cal.ERROR(</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-          &quot;[calGoogleCalendar] Adding Item &quot; + aItem.title + &quot; failed:&quot; + code + &quot;: &quot; + e.message</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-        );</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-        this.notifyPureOperationComplete(aListener, code, cIOL.ADD, aItem.id, e.message);</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-      }</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-    );</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-    return request;</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-  },</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-    cal.LOG(</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-      &quot;[calGoogleCalendar] Modifying item &quot; +</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-        aNewItem.title +</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-        &quot; (&quot; +</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-        (aNewItem.recurrenceId ? aNewItem.recurrenceId.icalString : &quot;master item&quot;) +</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-        &quot;)&quot;</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-    );</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-    // Set up the request</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-    let request = new calGoogleRequest();</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-    (async () =&gt; {</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-      request.type = request.MODIFY;</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-      request.calendar = this;</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-      if (cal.item.isEvent(aNewItem)) {</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-        let googleId = getGoogleId(aNewItem, this.offlineStorage);</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-        request.uri = this.createEventsURI(&quot;events&quot;, googleId);</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-        // Updating invitations often causes a forbidden error because</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-        // some parts are not writable. Using PATCH ignores anything</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-        // that isn't allowed.</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-        if (cal.itip.isInvitation(aNewItem)) {</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-          request.type = request.PATCH;</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-        }</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;calendar.google.sendEventNotifications&quot;, false)) {</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-          request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-        }</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-      } else if (cal.item.isToDo(aNewItem)) {</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-        request.uri = this.createTasksURI(&quot;tasks&quot;, aNewItem.id);</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-      }</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineminus">-</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-      if (!request.uri) {</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-        throw Components.Exception(&quot;Item type not supported&quot;, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-      }</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-      request.setUploadData(</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-        &quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-        JSON.stringify(ItemToJSON(aNewItem, this.offlineStorage))</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-      );</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-      // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-      let refItem = aOldItem || aNewItem;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-      let meta =</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-        getItemMetadata(this.offlineStorage, refItem) ||</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-        getItemMetadata(this.offlineStorage, refItem.parentItem);</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineminus">-      if (meta &amp;&amp; meta.etag) {</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-        request.addRequestHeader(&quot;If-Match&quot;, meta.etag);</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-      } else {</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-        cal.ERROR(&quot;[calGoogleCalendar] Missing ETag for &quot; + refItem.hashId);</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-      }</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-      let data;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-      try {</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-        data = await this.session.asyncItemRequest(request);</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-      } catch (e) {</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-        if (</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-          e.result == calGoogleRequest.CONFLICT_MODIFY ||</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-          e.result == calGoogleRequest.CONFLICT_DELETED</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineminus">-        ) {</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineminus">-          data = await checkResolveConflict(request, this, aNewItem);</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-        } else {</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-          throw e;</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-        }</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-      }</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineminus">-</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineminus">-      // All we need to do now is parse the item and complete the</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-      // operation. The cache layer will take care of adding the item</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-      // to the storage cache.</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-      let metaData = Object.create(null);</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-      let item = JSONToItem(data, this, this.defaultReminders || [], aNewItem.clone(), metaData);</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-      // Make sure to update the etag. Do so before switching to the</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-      // parent item, as google saves its own etags for changed</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-      // instances.</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-      migrateItemMetadata(this.offlineStorage, aOldItem, item, metaData);</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-      if (item.recurrenceId) {</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-        // If we only modified an exception item, then we need to</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-        // set the parent item and modify the exception.</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-        let modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-        if (item.status == &quot;CANCELLED&quot;) {</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-          // Canceled means the occurrence is an EXDATE.</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-          modifiedItem.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-        } else {</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-          // Not canceled means the occurrence was modified.</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-          modifiedItem.recurrenceInfo.modifyException(item, true);</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineminus">-        }</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineminus">-        item = modifiedItem;</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-      }</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineminus">-</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-      return item;</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-    })().then(</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineminus">-      item =&gt; {</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Modifying &quot; + aNewItem.title + &quot; succeeded&quot;);</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineminus">-        this.observers.notify(&quot;onModifyItem&quot;, [item, aOldItem]);</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineminus">-        this.notifyOperationComplete(aListener, Cr.NS_OK, cIOL.MODIFY, item.id, item);</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineminus">-      },</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-      e =&gt; {</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-        let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-        if (code != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-          cal.ERROR(</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-            &quot;[calGoogleCalendar] Modifying item &quot; +</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineminus">-              aNewItem.title +</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineminus">-              &quot; failed:&quot; +</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-              code +</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-              &quot;: &quot; +</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-              e.message</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-          );</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-        }</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-        this.notifyPureOperationComplete(aListener, code, cIOL.MODIFY, aNewItem.id, e.message);</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-      }</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-    );</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-    return request;</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-  },</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-  deleteItem: function(aItem, aListener) {</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-    cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-    let request = new calGoogleRequest();</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-    (async () =&gt; {</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-      request.type = request.DELETE;</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-      request.calendar = this;</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-      if (cal.item.isEvent(aItem)) {</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineminus">-        request.uri = this.createEventsURI(&quot;events&quot;, getGoogleId(aItem, this.offlineStorage));</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;calendar.google.sendEventNotifications&quot;, false)) {</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-          request.addQueryParameter(&quot;sendNotifications&quot;, &quot;true&quot;);</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-        }</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-      } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-        request.uri = this.createTasksURI(&quot;tasks&quot;, aItem.id);</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-      }</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-      if (!request.uri) {</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-        throw Components.Exception(&quot;Item type not supported&quot;, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-      }</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-      // Set up etag from storage so we don't overwrite any foreign changes</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-      let meta =</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-        getItemMetadata(this.offlineStorage, aItem) ||</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-        getItemMetadata(this.offlineStorage, aItem.parentItem);</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-      if (meta &amp;&amp; meta.etag) {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineminus">-        request.addRequestHeader(&quot;If-Match&quot;, meta.etag);</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-      } else {</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-        cal.ERROR(&quot;[calGoogleCalendar] Missing ETag for &quot; + aItem.hashId);</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineminus">-      }</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-      try {</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-        await this.session.asyncItemRequest(request);</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-      } catch (e) {</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-        if (</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineminus">-          e.result == calGoogleRequest.CONFLICT_MODIFY ||</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineminus">-          e.result == calGoogleRequest.CONFLICT_DELETED</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineminus">-        ) {</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-          await checkResolveConflict(request, this, aItem);</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-        } else {</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-          throw e;</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-        }</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineminus">-      }</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-      deleteItemMetadata(this.offlineStorage, aItem);</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-      return aItem;</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineminus">-    })().then(</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-      item =&gt; {</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Deleting &quot; + aItem.title + &quot; succeeded&quot;);</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-        this.observers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineminus">-        this.notifyOperationComplete(aListener, Cr.NS_OK, cIOL.DELETE, item.id, item);</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-      },</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-      e =&gt; {</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-        let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-        if (code != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-          cal.ERROR(</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-            &quot;[calGoogleCalendar] Deleting item &quot; +</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-              aItem.title +</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-              &quot; failed:&quot; +</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-              code +</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineminus">-              &quot;: &quot; +</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-              e.message</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-          );</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-        }</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-        this.notifyPureOperationComplete(aListener, code, cIOL.DELETE, aItem.id, e.message);</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-      }</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-    );</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-    return request;</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  },</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-  getItem: function(aId, aListener) {</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-    this.mOfflineStorage.getItem(...arguments);</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineminus">-  },</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-  getItems: function(aFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineminus">-    this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineminus">-  },</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-  refresh: function() {</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineminus">-    this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineminus">-  },</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineminus">-</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-  migrateStorageCache: function() {</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-    let cacheVersion = this.getProperty(&quot;cache.version&quot;);</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-    if (!cacheVersion || cacheVersion &gt;= this.CACHE_DB_VERSION) {</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineminus">-      // Either up to date or first run, make sure property set right.</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineminus">-      this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-      return Promise.resolve(false);</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-    }</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-    let needsReset = false;</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-    cal.LOG(</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-      &quot;[calGoogleCalendar] Migrating cache from &quot; +</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-        cacheVersion +</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-        &quot; to &quot; +</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineminus">-        this.CACHE_DB_VERSION +</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineminus">-        &quot; for &quot; +</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineminus">-        this.name</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-    );</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-    if (cacheVersion &lt; 2) {</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-      // The initial version 1.0 had some issues that required resetting</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineminus">-      // the cache.</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-      needsReset = true;</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-    }</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-    if (cacheVersion &lt; 3) {</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-      // There was an issue with ids from the birthday calendar, we need</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineminus">-      // to reset just this calendar. See bug 1169062.</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineminus">-      let birthdayCalendar = &quot;#contacts@group.v.calendar.google.com&quot;;</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineminus">-      if (this.mCalendarName &amp;&amp; this.mCalendarName == birthdayCalendar) {</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineminus">-        needsReset = true;</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineminus">-      }</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-    }</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineminus">-</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineminus">-    // Migration all done. Reset if requested.</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineminus">-    if (needsReset) {</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-      return this.resetSync().then(() =&gt; {</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineminus">-        this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineminus">-        return needsReset;</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-      });</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-    } else {</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-      this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-      return Promise.resolve(needsReset);</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-    }</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineminus">-  },</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineminus">-</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineminus">-  /**</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineminus">-   * Implement calIChangeLog</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-   */</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineminus">-  get offlineStorage() {</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-    return this.mOfflineStorage;</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineminus">-  },</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineminus">-  set offlineStorage(val) {</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineminus">-    this.mOfflineStorage = val;</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineminus">-    this.migrateStorageCache();</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineminus">-    return val;</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-  },</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-  resetLog: function() {</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineminus">-    this.resetSync().then(() =&gt; {</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineminus">-      this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineminus">-    });</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineminus">-  },</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineminus">-</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-  resetSync: function() {</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l9.740"></a><span id="l9.740" class="difflineminus">-      this.setProperty(&quot;syncToken.events&quot;, &quot;&quot;);</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineminus">-      this.setProperty(&quot;lastUpdated.tasks&quot;, &quot;&quot;);</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-      this.mThrottle = Object.create(null);</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-      let listener = {</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-        onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineminus">-          if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineminus">-            resolve();</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineminus">-          } else {</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-            reject(aDetail);</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-          }</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-        },</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineminus">-      };</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineminus">-      this.mOfflineStorage</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineminus">-        .QueryInterface(Ci.calICalendarProvider)</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineminus">-        .deleteCalendar(this.mOfflineStorage, listener);</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-    });</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-  },</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineminus">-</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineminus">-  replayChangesOn: function(aListener) {</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-    // Figure out if the user is idle, no need to synchronize if so.</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineminus">-    let idleTime = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(Ci.nsIIdleService).idleTime;</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineminus">-    let maxIdleTime = Services.prefs.getIntPref(&quot;calendar.google.idleTime&quot;, 300) * 1000;</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineminus">-</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineminus">-    if (maxIdleTime != 0 &amp;&amp; idleTime &gt; maxIdleTime) {</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Skipping refresh since user is idle&quot;);</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineminus">-      aListener.onResult({ status: Cr.NS_OK }, null);</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineminus">-      return Promise.resolve();</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-    }</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-    // Now that we've determined we are not idle we can continue with the sync.</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineminus">-    let maxResults = Services.prefs.getIntPref(&quot;calendar.google.maxResultsPerRequest&quot;, null);</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-    // We are going to be making potentially lots of changes to the offline</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-    // storage, start a batch operation.</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineminus">-    this.mOfflineStorage.startBatch();</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineminus">-</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineminus">-    // Update the calendar settings</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-    let calendarPromise = Promise.resolve();</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-    if (this.mCalendarName &amp;&amp; this.checkThrottle(&quot;calendarList&quot;)) {</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-      let calendarRequest = new calGoogleRequest();</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-      calendarRequest.calendar = this;</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineminus">-      calendarRequest.type = calendarRequest.GET;</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineminus">-      calendarRequest.uri = this.createUsersURI(&quot;calendarList&quot;, this.mCalendarName);</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineminus">-      calendarPromise = this.session.asyncItemRequest(calendarRequest).then(aData =&gt; {</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineminus">-        if (aData.defaultReminders) {</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-          this.defaultReminders = aData.defaultReminders.map(reminder =&gt;</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-            JSONToAlarm(reminder, true)</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineminus">-          );</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineminus">-        } else {</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineminus">-          this.defaultReminders = [];</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineminus">-        }</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineminus">-</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineminus">-        let settings = [</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineminus">-          &quot;accessRole&quot;,</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineminus">-          &quot;backgroundColor&quot;,</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-          &quot;description&quot;,</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-          &quot;foregroundColor&quot;,</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineminus">-          &quot;location&quot;,</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineminus">-          &quot;primary&quot;,</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-          &quot;summary&quot;,</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-          &quot;summaryOverride&quot;,</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineminus">-          &quot;timeZone&quot;,</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineminus">-        ];</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineminus">-</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineminus">-        for (let k of settings) {</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineminus">-          this.setProperty(&quot;settings.&quot; + k, aData[k]);</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineminus">-        }</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-        this.setProperty(&quot;settings.defaultReminders&quot;, JSON.stringify(aData.defaultReminders));</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-      });</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-    }</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineminus">-    // Set up a request for the events</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-    let eventsRequest = new calGoogleRequest();</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineminus">-    let eventsPromise = Promise.resolve();</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineminus">-    eventsRequest.calendar = this;</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-    eventsRequest.type = eventsRequest.GET;</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineminus">-    eventsRequest.uri = this.createEventsURI(&quot;events&quot;);</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineminus">-    eventsRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-    let syncToken = this.getProperty(&quot;syncToken.events&quot;);</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-    if (syncToken) {</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineminus">-      eventsRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-      eventsRequest.addQueryParameter(&quot;syncToken&quot;, syncToken);</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-    }</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineminus">-    if (eventsRequest.uri &amp;&amp; this.checkThrottle(&quot;events&quot;)) {</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-      let saver = new ItemSaver(this);</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineminus">-      eventsPromise = this.session.asyncPaginatedRequest(</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineminus">-        eventsRequest,</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-        null,</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-        aData =&gt; {</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-          // On each request...</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-          return saver.parseItemStream(aData);</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineminus">-        },</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineminus">-        aData =&gt; {</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineminus">-          // On last request...</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineminus">-          return saver.complete().then(() =&gt; {</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-            if (aData.nextSyncToken) {</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-              cal.LOG(</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineminus">-                &quot;[calGoogleCalendar] New sync token for &quot; +</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineminus">-                  this.name +</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineminus">-                  &quot;(events) is now: &quot; +</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-                  aData.nextSyncToken</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineminus">-              );</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineminus">-              this.setProperty(&quot;syncToken.events&quot;, aData.nextSyncToken);</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineminus">-            }</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineminus">-          });</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineminus">-        }</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineminus">-      );</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineminus">-    }</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineminus">-    // Set up a request for tasks</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineminus">-    let tasksRequest = new calGoogleRequest();</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineminus">-    let tasksPromise = Promise.resolve();</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineminus">-    tasksRequest.calendar = this;</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineminus">-    tasksRequest.type = tasksRequest.GET;</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineminus">-    tasksRequest.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineminus">-    tasksRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineminus">-    let lastUpdated = this.getUpdatedMin(&quot;tasks&quot;);</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineminus">-    if (lastUpdated) {</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineminus">-      tasksRequest.addQueryParameter(&quot;updatedMin&quot;, cal.dtz.toRFC3339(lastUpdated));</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineminus">-      tasksRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-    }</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-    if (tasksRequest.uri &amp;&amp; this.checkThrottle(&quot;tasks&quot;)) {</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineminus">-      let saver = new ItemSaver(this);</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineminus">-      let newLastUpdated = null;</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineminus">-      tasksPromise = this.session.asyncPaginatedRequest(</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineminus">-        tasksRequest,</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineminus">-        aData =&gt; {</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineminus">-          // On the first request...</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-          newLastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-        },</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineminus">-        aData =&gt; {</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineminus">-          // On each request...</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineminus">-          return saver.parseItemStream(aData);</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineminus">-        },</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineminus">-        aData =&gt; {</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineminus">-          // On last request...</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineminus">-          return saver.complete().then(() =&gt; {</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-            cal.LOG(</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-              &quot;[calGoogleCalendar] Last sync date for &quot; +</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineminus">-                this.name +</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineminus">-                &quot;(tasks) is now: &quot; +</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineminus">-                tasksRequest.requestDate.toString()</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-            );</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineminus">-            this.setProperty(&quot;newLastUpdated.tasks&quot;, newLastUpdated);</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineminus">-          });</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineminus">-        }</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineminus">-      );</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineminus">-    }</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineminus">-</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineminus">-    return Promise.all([calendarPromise, eventsPromise, tasksPromise]).then(</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineminus">-      () =&gt; {</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineminus">-        this.mOfflineStorage.endBatch();</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineminus">-        aListener.onResult({ status: Cr.NS_OK }, null);</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-      },</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineminus">-      e =&gt; {</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineminus">-        this.mOfflineStorage.endBatch();</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineminus">-        let code = e.result || Cr.NS_ERROR_FAILURE;</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineminus">-        if (code == calGoogleRequest.RESOURCE_GONE) {</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineminus">-          cal.LOG(</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineminus">-            &quot;[calGoogleCalendar] Server did not accept &quot; +</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-              &quot;incremental update, resetting calendar and &quot; +</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineminus">-              &quot;starting over.&quot;</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineminus">-          );</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineminus">-          this.resetSync().then(</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineminus">-            () =&gt; {</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineminus">-              this.replayChangesOn(aListener);</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineminus">-            },</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineminus">-            err =&gt; {</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineminus">-              cal.ERROR(&quot;[calGoogleCalendar] Error resetting calendar:\n&quot; + stringException(err));</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineminus">-              aListener.onResult({ status: err.result }, err.message);</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineminus">-            }</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineminus">-          );</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineminus">-        } else {</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineminus">-          cal.LOG(&quot;[calGoogleCalendar] Error syncing:\n&quot; + code + &quot;:&quot; + stringException(e));</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineminus">-          aListener.onResult({ status: code }, e.message);</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineminus">-        }</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineminus">-      }</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineminus">-    );</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineminus">-  },</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineminus">-</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineminus">-  /**</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineminus">-   * Implement calISchedulingSupport. Most is taken care of by the base</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineminus">-   * provider, but we want to advertise that we will always take care of</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-   * notifications.</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineminus">-   */</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-  canNotify: function(aMethod, aItem) {</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineminus">-    return true;</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineminus">-  },</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineminus">-};</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineminus">-</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([calGoogleCalendar]); /* exported NSGetFactory */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.manifest</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-component {d1a6e988-4b4d-45a5-ba46-43e501ea96e3} calGoogleCalendar.js</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-contract @mozilla.org/calendar/calendar;1?type=gdata {d1a6e988-4b4d-45a5-ba46-43e501ea96e3}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/calendar/providers/gdata/content/browserRequest.css</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,52 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-#security-button {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-  width: 20px;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-  margin-top: -1px;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  margin-right: 5px;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  background-repeat: no-repeat;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-}</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#security-button[level=&quot;high&quot;] {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  background-image: url(&quot;chrome://messenger/skin/icons/secure.png&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-}</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-#security-button[level=&quot;broken&quot;] {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  background-image: url(&quot;chrome://messenger/skin/icons/insecure.png&quot;);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-}</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-#security-button[loading=&quot;true&quot;] {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  background-image: url(&quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  background-position: 4px 3px;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-}</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-@media (min-resolution: 2dppx) {</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  #security-button[loading=&quot;true&quot;] {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    background-image: url(&quot;chrome://global/skin/icons/loading@2x.png&quot;);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  }</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-}</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-#header {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    border-bottom: 1px solid rgb(105, 105, 105);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    overflow: hidden;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-}</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-#dialogMessage {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-    margin: 1em 1em 2em;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-}</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-#addressbox {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    font-weight: bold;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-    font-size: medium;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-    -moz-appearance: textfield;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    overflow: hidden;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    margin: 5px 5px;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    font-weight: normal;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-}</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-#headerMessage {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  margin-top: 3px;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  margin-bottom: 3px;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,101 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  const { interfaces: Ci } = Components;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-}</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-/* exported cancelRequest, loadRequestedUrl, reportUserClosed */</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-var wpl = Ci.nsIWebProgressListener;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-var reporterListener = {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  _isBusy: false,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  get securityButton() {</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    delete this.securityButton;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-    return (this.securityButton = document.getElementById(&quot;security-button&quot;));</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  },</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  QueryInterface: cal.generateQI([Ci.nsIWebProgressListener, Ci.nsISupportsWeakReference]),</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {},</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  onProgressChange: function(</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    aWebProgress,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    aRequest,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    aCurSelfProgress,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-    aMaxSelfProgress,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    aCurTotalProgress,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-    aMaxTotalProgress</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  ) {},</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation) {</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-    document.getElementById(&quot;headerMessage&quot;).textContent = aLocation.spec;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  },</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, aState) {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-    const wpl_security_bits = wpl.STATE_IS_SECURE | wpl.STATE_IS_BROKEN | wpl.STATE_IS_INSECURE;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-    let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-    let level;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    switch (aState &amp; wpl_security_bits) {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-      case wpl.STATE_IS_SECURE:</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-        level = &quot;high&quot;;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-        break;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-      case wpl.STATE_IS_BROKEN:</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-        level = &quot;broken&quot;;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-        break;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-    }</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-    if (level) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-      this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-      this.securityButton.hidden = false;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-    } else {</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-      this.securityButton.hidden = true;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-      this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-    }</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    this.securityButton.setAttribute(&quot;tooltiptext&quot;, browser.securityUI.tooltipText);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  },</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-};</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-function cancelRequest() {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  reportUserClosed();</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  window.close();</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-}</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-function reportUserClosed() {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  request.cancelled();</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-}</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-function loadRequestedUrl() {</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-  document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-  if (request.iconURI != &quot;&quot;) {</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-    document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  }</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  browser.addProgressListener(reporterListener, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-  let url = request.url;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  if (url != &quot;&quot;) {</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-    browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-    document.getElementById(&quot;headerMessage&quot;).textContent = url;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-  }</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-  let dialogMessage = document.getElementById(&quot;dialogMessage&quot;);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-  if (request.description) {</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-    dialogMessage.textContent = request.description;</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-  } else {</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    dialogMessage.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  }</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  request.loaded(window, browser.webProgress);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/calendar/providers/gdata/content/browserRequest.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,35 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-&lt;!--# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-    # License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-    # You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">- --&gt;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://gdata-provider/skin/browserRequest.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-&lt;!DOCTYPE window&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-&lt;window id=&quot;browserRequest&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-        buttons=&quot;,&quot;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-        onload=&quot;loadRequestedUrl()&quot;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-        onclose=&quot;reportUserClosed()&quot;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-        title=&quot;&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-        width=&quot;800&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-        height=&quot;500&quot;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-        orient=&quot;vertical&quot;&gt;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/browserRequest.js&quot;/&gt;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  &lt;keyset id=&quot;mainKeyset&quot;&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-    &lt;key id=&quot;key_close&quot; key=&quot;w&quot; modifiers=&quot;accel&quot; oncommand=&quot;cancelRequest()&quot;/&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    &lt;key id=&quot;key_close2&quot;  keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;cancelRequest()&quot;/&gt;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  &lt;/keyset&gt;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  &lt;vbox id=&quot;header&quot;&gt;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    &lt;description id=&quot;dialogMessage&quot;/&gt;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    &lt;hbox id=&quot;addressbox&quot; flex=&quot;1&quot; disabled=&quot;true&quot;&gt;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-      &lt;image id=&quot;security-button&quot; src=&quot;chrome://messenger/skin/icons/mailicon32.png&quot;/&gt;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-      &lt;description id=&quot;headerMessage&quot;/&gt;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  &lt;/vbox&gt;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  &lt;browser type=&quot;content&quot; src=&quot;about:blank&quot; id=&quot;requestFrame&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2">index 02ccfa8db28d18c68a746eca42ad94d2a8317a6b..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l14.3"></a><span id="l14.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-bindings.css</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,23 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-#calendar-list richlistitem[loading=&quot;true&quot;] {</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-  -moz-box-flex: 1;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-  background: url(&quot;chrome://global/skin/icons/loading.png&quot;) center 33% / 16px no-repeat;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-}</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-@media (min-resolution: 1.1dppx) {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-  #calendar-list richlistitem[loading=&quot;true&quot;] {</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    background-image: url(&quot;chrome://global/skin/icons/loading@2x.png&quot;);</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  }</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-}</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-#calendar-list richlistitem[selected] {</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  color: unset;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-  background-color: unset;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-}</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-#calendar-list .header-label {</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  font-weight: bold;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,330 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-/* import-globals-from ../../../lightning/content/lightning-calendar-creation.js */</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-  const { utils: Cu } = Components;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-}</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-var { getGoogleSessionManager } = ChromeUtils.import(</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataSession.jsm&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-var { monkeyPatch } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-(function() {</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-  function pageorder(anchor, ...pages) {</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-    let wizard = document.documentElement;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-    let page = wizard.getPageById(anchor);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-    for (let id of pages) {</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-      page.next = id;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-      page = wizard.getPageById(id);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-    }</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-  }</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  function trycatch(func) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-    return function() {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-      try {</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-        return func.apply(this, arguments);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-      } catch (e) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-        throw e;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-      }</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-    };</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-  }</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  let previousUriValue = null;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  function selectProvider(type) {</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-    let isGdata = type == &quot;gdata&quot;;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-    let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-    curi.parentNode.style.visibility = isGdata ? &quot;hidden&quot; : &quot;visible&quot;;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-    document.getElementById(&quot;cache&quot;).parentNode.style.visibility = isGdata ? &quot;hidden&quot; : &quot;visible&quot;;</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-    // Move the next step description to the right place</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-    let locationRows = document.querySelector(</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-      &quot;#calendar-wizard &gt; [pageid='locationPage'] &gt; grid &gt; rows&quot;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    );</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-    let nextStepDescr = document.getElementById(&quot;gdata-nextstep-description&quot;);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-    locationRows.appendChild(nextStepDescr);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    if (isGdata) {</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-      pageorder(&quot;locationPage&quot;, &quot;gdata-session&quot;, &quot;gdata-calendars&quot;, &quot;finishPage&quot;);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-      previousUriValue = curi.value;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-      curi.value = &quot;googleapi://unknown&quot;;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-      nextStepDescr.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-    } else {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-      nextStepDescr.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-      pageorder(&quot;locationPage&quot;, &quot;customizePage&quot;, &quot;finishPage&quot;);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-      if (previousUriValue !== null) {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-        curi.value = previousUriValue;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-        previousUriValue = null;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-      }</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-    }</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-    checkRequired();</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-  this.gdataSelectProvider = selectProvider;</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-  if (typeof tmpCalendarCreation == &quot;undefined&quot;) {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-    monkeyPatch(window, &quot;onSelectProvider&quot;, (protofunc, type) =&gt; {</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-      selectProvider(type);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-      return protofunc(type);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-    });</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  } else {</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-    // The exchange provider overwrites the select handler, which causes</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-    // our provider to fail. The exchange provider overwrites the select</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    // handler, which causes our provider to fail. Given the exchange</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    // provider is currently not maintained and we want them to work</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-    // together, here is a workaround.</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-    // eslint-disable-next-line no-undef</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-    monkeyPatch(tmpCalendarCreation, &quot;doRadioExchangeCalendar&quot;, (protofunc, target) =&gt; {</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-      // We need to run our function first, otherwise resetting the</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-      // pageorder will overwrite what the exchange provider does.</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-      selectProvider(target.value);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-      let rv = protofunc(target);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-      // But then again, when switching to the gdata provider, the</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-      // exchange provider overwrites the uri we set.</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-      if (target.value == &quot;gdata&quot;) {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-        let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-        curi.value = &quot;googleapi://unknown&quot;;</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-        checkRequired();</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-      }</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-      return rv;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-    });</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-  }</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  monkeyPatch(window, &quot;prepareCreateCalendar&quot;, protofunc =&gt; {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-    let type = document.getElementById(&quot;calendar-format&quot;).selectedItem.value;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-    return type == &quot;gdata&quot; ? true : protofunc();</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-  });</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-  monkeyPatch(window, &quot;checkRequired&quot;, protofunc =&gt; {</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-    let wizard = document.documentElement;</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-    let currentPageId = wizard.currentPage &amp;&amp; wizard.currentPage.pageid;</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-    if (currentPageId == &quot;gdata-session&quot;) {</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-      let sessionGroup = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-      let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-      let sessionNameIsValid = document.getAnonymousElementByAttribute(</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-        sessionName,</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-        &quot;anonid&quot;,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-        &quot;input&quot;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-      ).validity.valid;</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-      // TODO for some reason the validity doesn't work on windows. Here is a hack:</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-      // eslint-disable-next-line no-useless-escape</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-      sessionNameIsValid = !!sessionName.value.match(/^[^\/]+@[^\/]+\.[^\/]+$/);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-      wizard.canAdvance = sessionGroup.value || (sessionName.value &amp;&amp; sessionNameIsValid);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-    } else if (currentPageId == &quot;gdata-calendars&quot;) {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-      let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-      wizard.canAdvance = !!calendarList.querySelector(</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-        &quot;.calendar-selected[checked]:not([readonly])&quot;</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-      );</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-    } else {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-      protofunc();</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-    }</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-  });</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-  this.gdataSessionShow = trycatch(() =&gt; {</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-    let sessionMgr = getGoogleSessionManager();</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-    let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-    let newSessionItem = document.getElementById(&quot;session-new&quot;);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-    let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-    let sessions = new Set(</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-      calendars.map(calendar =&gt; {</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-        return sessionMgr.getSessionByCalendar(calendar, true);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-      })</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-    );</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-    while (sessionContainer.firstChild.id != &quot;session-new&quot;) {</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-      sessionContainer.firstChild.remove();</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-    }</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-    // forEach is needed for backwards compatibility.</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    sessions.forEach(session =&gt; {</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-      if (!session) {</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-        return;</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-      }</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-      let radio = document.createXULElement(&quot;radio&quot;);</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-      radio.setAttribute(&quot;value&quot;, session.id);</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-      radio.setAttribute(&quot;label&quot;, session.id);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-      sessionContainer.insertBefore(radio, newSessionItem);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-      radio.gdataSession = session;</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-    });</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-    sessionContainer.value = sessionContainer.firstChild.value;</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-    if (sessionContainer.value == &quot;&quot;) {</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-      let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-      sessionName.focus();</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    }</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-  });</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-  this.gdataCalendarsShow = trycatch(() =&gt; {</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-    let calMgr = cal.getCalendarManager();</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-    let sessionMgr = getGoogleSessionManager();</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-    let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-    let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-    while (calendarList.lastElementChild) {</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-      calendarList.lastElementChild.remove();</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    }</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-    let loadingItem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-    loadingItem.setAttribute(&quot;loading&quot;, &quot;true&quot;);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-    calendarList.appendChild(loadingItem);</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-    let session = sessionContainer.selectedItem.gdataSession;</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-    if (!session) {</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-      let newSessionItem = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-      session = sessionMgr.getSessionById(newSessionItem.value, true);</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-    }</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-    Promise.all([session.getTasksList(), session.getCalendarList()]).then(</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-      ([tasksLists, calendars]) =&gt; {</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-        let existing = new Set();</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-        let sessionPrefix = &quot;googleapi://&quot; + session.id;</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineminus">-        for (let calendar of calMgr.getCalendars({})) {</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-          let spec = calendar.uri.spec;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-          if (calendar.type == &quot;gdata&quot; &amp;&amp; spec.substr(0, sessionPrefix.length) == sessionPrefix) {</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-            let match;</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineminus">-            if ((match = spec.match(/calendar=([^&amp;]*)/))) {</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-              existing.add(decodeURIComponent(match[0]));</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-            }</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-            if ((match = spec.match(/tasks=([^&amp;]*)/))) {</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-              existing.add(decodeURIComponent(match[0]));</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-            }</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-          }</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-        }</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-        let taskcals = tasksLists.map(tasklist =&gt; {</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-          let uri = &quot;googleapi://&quot; + session.id + &quot;/?tasks=&quot; + encodeURIComponent(tasklist.id);</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-          let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri));</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-          calendar.id = cal.getUUID();</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-          calendar.setProperty(&quot;color&quot;, cal.view.hashColor(tasklist.title));</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-          calendar.name = tasklist.title;</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-          if (existing.has(&quot;tasks=&quot; + tasklist.id)) {</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-            calendar.readOnly = true;</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-          }</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-          return calendar;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-        });</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-        let calcals = calendars.map(calendarEntry =&gt; {</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-          let uri =</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-            &quot;googleapi://&quot; + session.id + &quot;/?calendar=&quot; + encodeURIComponent(calendarEntry.id);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-          let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri));</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-          calendar.name = calendarEntry.summary;</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-          calendar.id = cal.getUUID();</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-          calendar.setProperty(&quot;color&quot;, calendarEntry.backgroundColor);</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-          if (existing.has(&quot;calendar=&quot; + calendarEntry.id)) {</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-            calendar.readOnly = true;</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-          }</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-          return calendar;</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">-        });</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-        loadingItem.remove();</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-        let strings = Services.strings.createBundle(</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-          &quot;chrome://gdata-provider/locale/gdata.properties&quot;</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-        );</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-        let header = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-        let headerLabel = document.createXULElement(&quot;label&quot;);</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-        headerLabel.classList.add(&quot;header-label&quot;);</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-        headerLabel.value = strings.GetStringFromName(&quot;calendarsHeader&quot;);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-        header.appendChild(headerLabel);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-        calendarList.appendChild(header);</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-        for (let calendar of calcals) {</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-          addCalendarItem(calendar);</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-        }</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-        header = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-        headerLabel = document.createXULElement(&quot;label&quot;);</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-        headerLabel.classList.add(&quot;header-label&quot;);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-        headerLabel.value = strings.GetStringFromName(&quot;taskListsHeader&quot;);</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-        header.appendChild(headerLabel);</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-        calendarList.appendChild(header);</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-        for (let calendar of taskcals) {</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-          addCalendarItem(calendar);</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-        }</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-        function addCalendarItem(calendar) {</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-          let item = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-          item.calendar = calendar;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-          item.setAttribute(&quot;calendar-id&quot;, calendar.id);</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-          let checkbox = document.createXULElement(&quot;checkbox&quot;);</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-          checkbox.classList.add(&quot;calendar-selected&quot;);</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-          if (calendar.readOnly) {</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-            checkbox.checked = true;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-            checkbox.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-          }</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-          item.appendChild(checkbox);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-          let image = document.createXULElement(&quot;image&quot;);</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-          image.classList.add(&quot;calendar-color&quot;);</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-          item.appendChild(image);</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-          image.style.backgroundColor = calendar.getProperty(&quot;color&quot;);</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-          let label = document.createXULElement(&quot;label&quot;);</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-          label.classList.add(&quot;calendar-name&quot;);</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-          label.value = calendar.name;</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-          item.appendChild(label);</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-          calendarList.appendChild(item);</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-        }</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineminus">-      },</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-      e =&gt; {</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-      }</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineminus">-    );</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-  });</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-  this.gdataCalendarsAdvance = trycatch(() =&gt; {</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-    let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-    let calMgr = cal.getCalendarManager();</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-    for (let item of calendarList.children) {</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-      let checkbox = item.querySelector(&quot;.calendar-selected[checked]:not([readonly])&quot;);</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineminus">-      if (checkbox) {</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineminus">-        calMgr.registerCalendar(item.calendar);</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineminus">-      }</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineminus">-    }</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineminus">-  });</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">-</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">-  this.gdataFocusNewSession = trycatch(() =&gt; {</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineminus">-    let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineminus">-    sessionContainer.value = &quot;&quot;;</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineminus">-  });</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineminus">-</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineminus">-  document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-    // Older versions of Lightning don't set the onselect attribute at all.</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineminus">-    let calendarFormat = document.getElementById(&quot;calendar-format&quot;);</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineminus">-    if (!calendarFormat.hasAttribute(&quot;onselect&quot;)) {</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineminus">-      calendarFormat.setAttribute(&quot;onselect&quot;, &quot;gdataSelectProvider(this.value)&quot;);</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineminus">-    }</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineminus">-</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineminus">-    if (document.getElementById(&quot;gdata-session&quot;).pageIndex == -1) {</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-      let wizard = document.documentElement;</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineminus">-      wizard._initPages();</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineminus">-    }</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-  });</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-  let gdataSessionPage = document.getElementById(&quot;gdata-session&quot;);</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineminus">-  gdataSessionPage.addEventListener(&quot;pageshow&quot;, () =&gt; {</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineminus">-    this.gdataSessionShow();</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineminus">-    checkRequired();</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineminus">-  });</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineminus">-  let gdataCalendarsPage = document.getElementById(&quot;gdata-calendars&quot;);</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineminus">-  gdataCalendarsPage.addEventListener(&quot;pageshow&quot;, () =&gt; {</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineminus">-    this.gdataCalendarsShow();</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineminus">-    checkRequired();</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineminus">-  });</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineminus">-  gdataCalendarsPage.addEventListener(&quot;pageadvanced&quot;, this.gdataCalendarsAdvance);</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-}.call(window));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-creation.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,53 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-&lt;!DOCTYPE overlay [</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-  &lt;!ENTITY % gdata SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt; %gdata;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  &lt;!ENTITY % calendarCreation SYSTEM &quot;chrome://calendar/locale/calendarCreation.dtd&quot; &gt; %calendarCreation;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-]&gt;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://calendar-common/skin/widgets/calendar-widgets.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://gdata-provider/skin/gdata-bindings.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://messenger/skin/input-fields.css&quot;?&gt;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-&lt;overlay id=&quot;gdataCalendarCreation&quot;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-  &lt;script src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-  &lt;script src=&quot;chrome://global/content/editMenuOverlay.js&quot;/&gt;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-calendar-creation.js&quot;/&gt;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-  &lt;radiogroup id=&quot;calendar-format&quot;&gt;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    &lt;radio value=&quot;gdata&quot; label=&quot;&amp;gdata-provider.label;&quot;/&gt;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  &lt;/radiogroup&gt;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-  &lt;wizard id=&quot;calendar-wizard&quot;&gt;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-    &lt;description id=&quot;gdata-nextstep-description&quot; hidden=&quot;true&quot;&gt;&amp;gdata.wizard.nextstep.description;&lt;/description&gt;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    &lt;wizardpage id=&quot;gdata-session&quot;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                pageid=&quot;gdata-session&quot;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-                description=&quot;&amp;wizard.description;&quot;&gt;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-      &lt;description&gt;&amp;gdata.wizard.session.description;&lt;/description&gt;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-      &lt;radiogroup id=&quot;gdata-session-group&quot; onselect=&quot;checkRequired()&quot;&gt;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-        &lt;hbox id=&quot;session-new&quot; class=&quot;input-container&quot;&gt;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-          &lt;radio value=&quot;&quot;/&gt;</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-          &lt;html:input id=&quot;gdata-session-name&quot;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-                      type=&quot;email&quot;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-                      onfocus=&quot;gdataFocusNewSession()&quot;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-                      oninput=&quot;gdataFocusNewSession(); checkRequired();&quot;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-                      class=&quot;input-inline&quot;/&gt;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-      &lt;/radiogroup&gt;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-    &lt;/wizardpage&gt;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    &lt;wizardpage id=&quot;gdata-calendars&quot;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-                pageid=&quot;gdata-calendars&quot;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-                description=&quot;&amp;wizard.description;&quot;&gt;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-      &lt;description&gt;&amp;gdata.wizard.calendars.description;&lt;/description&gt;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-      &lt;richlistbox id=&quot;calendar-list&quot;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-                   flex=&quot;1&quot;</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-                   onclick=&quot;checkRequired();&quot;/&gt;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-    &lt;/wizardpage&gt;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  &lt;/wizard&gt;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-properties.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,43 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-/* import-globals-from ../../../lightning/content/lightning-calendar-properties.js */</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-var { monkeyPatch } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-window.addEventListener(&quot;load&quot;, () =&gt; {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  if (document.getElementById(&quot;calendar-uri&quot;).value) {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-    // Calendar's load function needs to be called first, and that seems to have happened.</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-    gdataOnLoad();</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  } else {</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-    // onLoad has not yet been called, so we can piggyback on that function.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-    monkeyPatch(window, &quot;onLoad&quot;, (protofunc, ...args) =&gt; {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-      let rv = protofunc(...args);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-      gdataOnLoad();</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-      return rv;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-    });</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-  }</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-});</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-function gdataOnLoad() {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-  if (gCalendar.type == &quot;gdata&quot;) {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-    let accessRole = gCalendar.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-    let isReader = accessRole == &quot;freeBusyReader&quot; || accessRole == &quot;reader&quot;;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-    let isEventsCalendar = gCalendar.getProperty(&quot;capabilities.events.supported&quot;);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    let isDisabled = gCalendar.getProperty(&quot;disabled&quot;);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    // Disable setting read-only if the calendar is readonly anyway</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    document.getElementById(&quot;read-only&quot;).disabled = isDisabled || (isEventsCalendar &amp;&amp; isReader);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    // Don't allow setting refresh interval to less than 30 minutes</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-    let refInterval = document.getElementById(&quot;calendar-refreshInterval-menupopup&quot;);</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    Array.from(refInterval.childNodes)</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-      .filter(node =&gt; {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-        let nodeval = parseInt(node.getAttribute(&quot;value&quot;), 10);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-        return nodeval &lt; 30 &amp;&amp; nodeval != 0;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-      })</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-      .forEach(node =&gt; {</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-        refInterval.removeChild(node);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-      });</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-  }</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-properties.xul</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-&lt;overlay id=&quot;gdata-calendar-properties&quot;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-calendar-properties.js&quot;/&gt;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog-reminder.css</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,7 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-.reminder-icon[value=&quot;SMS&quot;] {</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-  list-style-image: url(chrome://gdata-provider/skin/reminder-action-sms.svg);</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog-reminder.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,109 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-/* global MozElements */</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-/* import-globals-from ../../../base/content/dialogs/calendar-event-dialog-reminder.js */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-(function() {</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  const FOUR_WEEKS_BEFORE = -2419200;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  const { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  const { monkeyPatch, getProviderString } = ChromeUtils.import(</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    &quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  );</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-  const { XPCOMUtils } = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-  XPCOMUtils.defineLazyGetter(this, &quot;notificationbox&quot;, () =&gt; {</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    return new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-      element.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-      document.getElementById(&quot;reminder-notifications&quot;).append(element);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-    });</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-  });</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-  // NOTE: This function exits early if its not a gdata calendar</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  let item = window.arguments[0].item;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  let calendar = window.arguments[0].calendar;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  if (calendar.type != &quot;gdata&quot;) {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    return;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  }</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  let label = getProviderString(&quot;reminderOutOfRange&quot;);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  function checkReminderRange(reminder) {</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-    let offset = cal.alarms.calculateAlarmOffset(item, reminder);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-    let seconds = offset.inSeconds;</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-    return seconds &lt; 1 &amp;&amp; seconds &gt;= FOUR_WEEKS_BEFORE;</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  }</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  function checkAllReminders() {</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-    let listbox = document.getElementById(&quot;reminder-listbox&quot;);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-    let validated = true;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-    for (let node of listbox.childNodes) {</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-      validated = validated &amp;&amp; checkReminderRange(node.reminder);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-      if (!validated) {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-        break;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-      }</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-    }</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-    let acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-    acceptButton.disabled = !validated;</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-    if (validated) {</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-      this.notificationbox.removeAllNotifications();</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-    } else {</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-      let notification = this.notificationbox.appendNotification(</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-        label,</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-        &quot;reminderNotification&quot;,</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-        null,</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-        this.notificationbox.PRIORITY_CRITICAL_HIGH</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-      );</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-      let closeButton = notification.messageDetails.nextSibling;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-      closeButton.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-    }</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-  }</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  /**</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-   * Hides the &quot;after the event starts&quot; reminder relations, these are not</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-   * supported by Google.</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-   */</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-  function hideReminderRelations() {</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-    document.getElementById(&quot;reminder-after-start-menuitem&quot;).hidden = true;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-    document.getElementById(&quot;reminder-after-end-menuitem&quot;).hidden = true;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-  }</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  /**</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-   * SMS Reminders are only supported for Google Apps for Work, Education,</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-   * and Government. hide the menuitem if SMS reminders are not supported</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-   */</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  function hideSMSReminders() {</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;calendar.google.enableSMSReminders&quot;, false)) {</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-      document.getElementById(&quot;reminder-action-SMS&quot;).hidden = true;</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-    }</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-  }</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-  monkeyPatch(window, &quot;updateReminder&quot;, function(protofunc, event) {</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-    let rv = protofunc.apply(this, Array.from(arguments).slice(1));</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-    if (</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-      event.explicitOriginalTarget.localName == &quot;listitem&quot; ||</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-      event.explicitOriginalTarget.id == &quot;reminder-remove-button&quot; ||</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-      !document.commandDispatcher.focusedElement</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-    ) {</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-      // Same hack from the original dialog</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-      return undefined;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-    }</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-    checkAllReminders();</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-    return rv;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-  });</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-  monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc, ...args) {</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-    let rv = protofunc.apply(this, args);</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-    checkAllReminders();</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-    hideReminderRelations();</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-    hideSMSReminders();</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-    return rv;</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-  });</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog-reminder.xul</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://messenger/content/notification.css&quot;?&gt;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://gdata-provider/skin/gdata-event-dialog-reminder.css&quot;?&gt;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-&lt;overlay id=&quot;gdata-event-dialog-reminder-overlay&quot;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-event-dialog-reminder.js&quot;/&gt;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  &lt;menupopup id=&quot;reminder-actions-menupopup&quot;&gt;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-    &lt;menuitem id=&quot;reminder-action-SMS&quot;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-              class=&quot;reminder-icon menuitem-iconic&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-              value=&quot;SMS&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-              insertafter=&quot;reminder-action-EMAIL reminder-action-DISPLAY&quot;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-              provider=&quot;gdata&quot;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-              label=&quot;&amp;gdata.reminder.action.sms.label;&quot;/&gt;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  &lt;/menupopup&gt;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,42 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">-</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-window.addEventListener(&quot;message&quot;, aEvent =&gt; {</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-  if (aEvent.origin !== &quot;chrome://lightning&quot;) {</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-    return;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  }</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-  switch (aEvent.data.command) {</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-    case &quot;gdataIsTask&quot;: {</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-      let disableForTaskIds = [</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-        &quot;options-attachments-menu&quot;,</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-        &quot;options-attendees-menuitem&quot;,</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-        &quot;options-privacy-menu&quot;,</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-        &quot;options-priority-menu&quot;,</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-        &quot;options-freebusy-menu&quot;,</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-        &quot;button-attendees&quot;,</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-        &quot;button-privacy&quot;,</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-        &quot;button-url&quot;,</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-      ];</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-      for (let id of disableForTaskIds) {</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-        let node = document.getElementById(id);</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-        if (node) {</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-          node.disabled = aEvent.data.isGoogleTask;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-        }</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-      }</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    }</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-  }</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-});</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-const gdataStatusPrivacyHbox = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-gdataStatusPrivacyHbox.setAttribute(&quot;id&quot;, &quot;gdata-status-privacy-default-box&quot;);</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-gdataStatusPrivacyHbox.setAttribute(&quot;privacy&quot;, &quot;DEFAULT&quot;);</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-gdataStatusPrivacyHbox.setAttribute(&quot;provider&quot;, &quot;gdata&quot;);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-const statusPrivacy = document.getElementById(&quot;status-privacy&quot;);</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-statusPrivacy.insertBefore(</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  gdataStatusPrivacyHbox,</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-  document.getElementById(&quot;status-privacy-public-box&quot;)</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog.xul</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,25 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">-</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-&lt;overlay id=&quot;gdata-calendar-event-dialog&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-event-dialog.js&quot;/&gt;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-  &lt;!-- Privacy items --&gt;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-  &lt;menupopup id=&quot;options-privacy-menupopup&quot;&gt;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-    &lt;menuitem id=&quot;gdata-options-privacy-default-menuitem&quot;</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-              insertbefore=&quot;options-privacy-public-menuitem,options-privacy-private-menuitem&quot;</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-              label=&quot;&amp;gdata.privacy.default.label;&quot;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-              accesskey=&quot;&amp;gdata.privacy.default.accesskey;&quot;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-              type=&quot;radio&quot;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-              privacy=&quot;DEFAULT&quot;</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-              provider=&quot;gdata&quot;</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-              oncommand=&quot;editPrivacy(this)&quot;/&gt;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-  &lt;/menupopup&gt;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-  &lt;hbox id=&quot;status-privacy&quot; class=&quot;statusbarpanel&quot; /&gt;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-lightning-item-iframe.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,207 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-/* import-globals-from ../../../lightning/content/lightning-item-iframe.js */</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-/* import-globals-from ../../../base/content/dialogs/calendar-dialog-utils.js */</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var { monkeyPatch } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-(function() {</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-  monkeyPatch(window, &quot;updateCalendar&quot;, function(protofunc, ...args) {</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-    let rv = protofunc.apply(this, args);</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-    let calendar = getCurrentCalendar();</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-    let isGoogleCalendar = calendar.type == &quot;gdata&quot;;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-    let isTask = cal.item.isToDo(window.calendarItem);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-    let isEvent = cal.item.isEvent(window.calendarItem);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-    let isGoogleTask = isGoogleCalendar &amp;&amp; isTask;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-    let isGoogleEvent = isGoogleCalendar &amp;&amp; isEvent;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-    sendMessage({ command: &quot;gdataIsTask&quot;, isGoogleTask: isGoogleTask });</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-    let xulHideForTaskIds = [</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-      &quot;timezone-endtime&quot;,</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-      &quot;link-image-bottom&quot;,</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-      &quot;event-grid-tab-attendees&quot;,</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-      &quot;event-grid-tabpanel-attendees&quot;,</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-      &quot;todo-status-none-menuitem&quot;,</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-      &quot;todo-status-inprogress-menuitem&quot;,</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-      &quot;todo-status-canceled-menuitem&quot;,</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-      &quot;percent-complete-textbox&quot;,</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-      &quot;percent-complete-label&quot;,</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-    ];</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-    for (let id of xulHideForTaskIds) {</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-      let node = document.getElementById(id);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-      if (node) {</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-        node.hidden = isGoogleTask;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-      }</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-    }</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-    let hideForTaskIds = [</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-      &quot;event-grid-location-row&quot;,</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-      &quot;event-grid-startdate-row&quot;,</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-      &quot;event-grid-recurrence-row&quot;,</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-      &quot;event-grid-alarm-row&quot;,</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-    ];</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-    for (let id of hideForTaskIds) {</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-      document.getElementById(id).toggleAttribute(&quot;hidden&quot;, isGoogleTask);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-    }</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-    let duedate = document.getElementById(&quot;todo-duedate&quot;);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-    let duetime =</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-      duedate._timepicker || // From Lightning 6.9 onwards</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-      document.getAnonymousElementByAttribute(duedate, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-    duetime.style.display = isGoogleTask ? &quot;none&quot; : &quot;&quot;;</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-    if (gEndTime) {</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-      if (isGoogleTask) {</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-        let floating = cal.dtz.floating;</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-        if (gEndTimezone != floating) {</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-          gOldEndTimezone = gEndTimezone;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-        }</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-        gEndTimezone = cal.dtz.floating;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-        gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-        gEndTime.isDate = true;</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-      } else {</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-        if (gOldEndTimezone) {</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-          gEndTimezone = gOldEndTimezone;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-        }</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-        gEndTime.isDate = false;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-        gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-      }</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-      updateDateTime();</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-    }</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-    let elements = document.getElementsByAttribute(&quot;provider&quot;, &quot;gdata&quot;);</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    for (let elem of elements) {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-      elem.style.display = isGoogleCalendar ? &quot;&quot; : &quot;none&quot;;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-    }</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-    let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-    let hasDefaultReminders = isGoogleEvent &amp;&amp; calendar.getProperty(&quot;settings.defaultReminders&quot;);</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-    if (isGoogleCalendar &amp;&amp; !hasDefaultReminders &amp;&amp; reminderList.value == &quot;default&quot;) {</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-      reminderList.value = &quot;none&quot;;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-    }</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-    document.getElementById(&quot;gdata-reminder-default-menuitem&quot;).style.display = hasDefaultReminders</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-      ? &quot;&quot;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-      : &quot;none&quot;;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-    // Remove categories for Google Tasks</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-    let categoriesLabel = document.getElementById(&quot;item-categories-label&quot;);</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-    let calendarLabel = document.getElementById(&quot;item-calendar-label&quot;);</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-    if (!categoriesLabel.origLabel) {</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-      categoriesLabel.origLabel = categoriesLabel.value;</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-    }</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-    document</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-      .getElementById(&quot;event-grid-category-color-row&quot;)</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-      .toggleAttribute(&quot;hidden&quot;, isGoogleTask);</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-    if (isGoogleTask) {</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-      categoriesLabel.value = calendarLabel.value;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-    } else {</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-      categoriesLabel.value = categoriesLabel.origLabel;</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-    }</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-    return rv;</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-  });</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  monkeyPatch(window, &quot;updateCategoryMenulist&quot;, function(protofunc, ...args) {</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-    let rv;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-    let calendar = getCurrentCalendar();</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-    if (calendar.type == &quot;gdata&quot; &amp;&amp; cal.item.isToDo(window.calendarItem)) {</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-      let unwrappedCal = calendar.getProperty(&quot;cache.uncachedCalendar&quot;).wrappedJSObject;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-      unwrappedCal.mProperties[&quot;capabilities.categories.maxCount&quot;] = 0;</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-      rv = protofunc.apply(this, args);</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-      delete unwrappedCal.mProperties[&quot;capabilities.categories.maxCount&quot;];</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-    } else {</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-      rv = protofunc.apply(this, args);</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-    }</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-    return rv;</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-  });</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-  monkeyPatch(window, &quot;updateReminderDetails&quot;, function(protofunc, ...args) {</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-    let rv = protofunc.apply(this, args);</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-    let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-    if (reminderList.value == &quot;default&quot;) {</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-      removeChildren(&quot;reminder-icon-box&quot;);</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-    }</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-    return rv;</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-  });</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-  monkeyPatch(window, &quot;saveReminder&quot;, function(protofunc, item, ...args) {</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-    let calendar = getCurrentCalendar();</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-    let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineminus">-    if (calendar.type == &quot;gdata&quot; &amp;&amp; reminderList.value == &quot;default&quot;) {</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-      item.clearAlarms();</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-      let unwrappedCal = item.calendar.getProperty(&quot;cache.uncachedCalendar&quot;).wrappedJSObject;</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-      let defaultReminders = unwrappedCal.defaultReminders;</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-      defaultReminders.forEach(item.addAlarm, item);</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-      if (!defaultReminders.length) {</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-        item.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-      }</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineminus">-      return null;</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineminus">-    } else {</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-      item.deleteProperty(&quot;X-DEFAULT-ALARM&quot;);</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineminus">-      return protofunc.call(this, item, ...args);</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-    }</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineminus">-  });</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineminus">-</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-  monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc, reminders, ...args) {</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-    let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-    // Set up the default reminders item</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-    let defaultItem = document.getElementById(&quot;gdata-reminder-default-menuitem&quot;);</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineminus">-    let calendar = getCurrentCalendar().getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineminus">-    let unwrappedCal = calendar &amp;&amp; calendar.wrappedJSObject;</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-    let defaultReminders = unwrappedCal.defaultReminders</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-      ? unwrappedCal.defaultReminders.concat([])</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-      : [];</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-    defaultItem.reminders = defaultReminders;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-    let rv = null;</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-    let usesDefault;</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-    if (reminders.length) {</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-      usesDefault = reminders.every(reminder =&gt; reminder.hasProperty(&quot;X-DEFAULT-ALARM&quot;));</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineminus">-    } else {</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineminus">-      usesDefault = window.calendarItem.getProperty(&quot;X-DEFAULT-ALARM&quot;) == &quot;TRUE&quot;;</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-    }</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-    if (calendar.type == &quot;gdata&quot; &amp;&amp; (window.mode == &quot;new&quot; || usesDefault)) {</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-      // If all reminders are default reminders, then select the menuitem.</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-      reminderList.value = &quot;default&quot;;</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-      // remember the selected index</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-      gLastAlarmSelection = reminderList.selectedIndex;</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineminus">-    } else {</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineminus">-      rv = protofunc.call(this, reminders, ...args);</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineminus">-    }</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineminus">-    return rv;</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineminus">-  });</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-  monkeyPatch(window, &quot;editReminder&quot;, function(protofunc, ...args) {</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-    let rv = protofunc.apply(this, args);</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineminus">-</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineminus">-    // Now that the custom reminders were changed, we need to remove the</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineminus">-    // default alarm status, otherwise the wrong alarm will be set.</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineminus">-    let customItem = document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-    if (customItem.reminders) {</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-      for (let reminder of customItem.reminders) {</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-        reminder.deleteProperty(&quot;X-DEFAULT-ALARM&quot;);</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineminus">-      }</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineminus">-    }</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineminus">-</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-    return rv;</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineminus">-  });</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineminus">-})();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-lightning-item-iframe.xul</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-&lt;overlay id=&quot;gdata-lightning-item-iframe&quot;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-lightning-item-iframe.js&quot;/&gt;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-  &lt;menupopup id=&quot;item-alarm-menupopup&quot;&gt;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-    &lt;menuitem id=&quot;gdata-reminder-default-menuitem&quot;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-              insertbefore=&quot;reminder-none-separator&quot;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-              label=&quot;&amp;gdata.reminder.default;&quot;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-              provider=&quot;gdata&quot;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-              value=&quot;default&quot;/&gt;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-  &lt;/menupopup&gt;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-lightning-item-toolbar.xul</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-&lt;!DOCTYPE overlay SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-&lt;overlay id=&quot;gdata-lightning-item-toolbar&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-  &lt;menupopup id=&quot;event-privacy-menupopup&quot;&gt;</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-    &lt;menuitem id=&quot;gdata-event-privacy-default-menuitem&quot;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-              name=&quot;event-privacy-group&quot;</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-              insertbefore=&quot;event-privacy-public-menuitem,event-privacy-private-menuitem&quot;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-              label=&quot;&amp;gdata.privacy.default.label;&quot;</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-              type=&quot;radio&quot;</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-              provider=&quot;gdata&quot;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-              privacy=&quot;DEFAULT&quot;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-              oncommand=&quot;editPrivacy(this)&quot;/&gt;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  &lt;/menupopup&gt;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration-overlay.xul</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-&lt;overlay id=&quot;gdata-migration-overlay&quot;</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-migration.js&quot;/&gt;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration-wizard.xul</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,26 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">-</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-&lt;!DOCTYPE dialog SYSTEM &quot;chrome://gdata-provider/locale/gdata.dtd&quot;&gt;</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/global.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-&lt;dialog id=&quot;gdata-migration-wizard&quot;</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-        title=&quot;&amp;gdata.migration.title;&quot;</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-        windowtype=&quot;Calendar:GData:MigrationDialog&quot;</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-        buttons=&quot;accept,cancel&quot;</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-        acceptLabel=&quot;&amp;gdata.migration.upgrade.label;&quot;</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-        acceptKey=&quot;&amp;gdata.migration.upgrade.accesskey;&quot;</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-        width=&quot;300&quot;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-        height=&quot;300&quot;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-  &lt;script src=&quot;chrome://gdata-provider/content/gdata-migration.js&quot;/&gt;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-  &lt;script src=&quot;chrome://calendar/content/calendar-views-utils.js&quot;/&gt;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-  &lt;script src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-  &lt;description&gt;&amp;gdata.migration.description;&lt;/description&gt;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-  &lt;vbox id=&quot;calendars-listbox&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-  &lt;checkbox id=&quot;showagain-checkbox&quot; label=&quot;&amp;gdata.migration.showagain.label;&quot;/&gt;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,120 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">-</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">-/* import-globals-from ../../../base/content/calendar-ui-utils.js */</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-/**</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">- * Migrate the calendar selected in the wizard from ics to gdata.</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">- */</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-if (document.documentElement.id == &quot;gdata-migration-wizard&quot;) {</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-  document.addEventListener(&quot;dialogaccept&quot;, () =&gt; {</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-    let listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-    let calmgr = cal.getCalendarManager();</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-    for (let i = 0; i &lt; listbox.childNodes.length; i++) {</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-      let item = listbox.childNodes[i];</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-      if (item.checked) {</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-        // Migrate the calendar to a gdata calendar</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-        let newCal = calmgr.createCalendar(&quot;gdata&quot;, item.calendar.uri);</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-        calmgr.removeCalendar(item.calendar);</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-        // Copy some properties to the new calendar</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-        newCal.name = item.calendar.name;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-        newCal.setProperty(&quot;color&quot;, item.calendar.getProperty(&quot;color&quot;));</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-        newCal.setProperty(&quot;disabled&quot;, item.calendar.getProperty(&quot;disabled&quot;));</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-        newCal.setProperty(&quot;cache.enabled&quot;, item.calendar.getProperty(&quot;cache.enabled&quot;));</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-        newCal.setProperty(&quot;suppressAlarms&quot;, item.calendar.getProperty(&quot;suppressAlarms&quot;));</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-        newCal.setProperty(</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-          &quot;calendar-main-in-composite&quot;,</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-          item.calendar.getProperty(&quot;calendar-main-in-composite&quot;)</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-        );</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-        newCal.setProperty(</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-          &quot;calendar-main-default&quot;,</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-          item.calendar.getProperty(&quot;calendar-main-default&quot;)</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-        );</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-        calmgr.registerCalendar(newCal);</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-      }</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-    }</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-    // Only bring up the dialog on the next startup if the user wants us to.</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-    Services.prefs.setBoolPref(</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-      &quot;calendar.google.migrate&quot;,</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-      document.getElementById(&quot;showagain-checkbox&quot;).checked</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-    );</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-  });</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-}</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-/**</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">- * Get all calendars that are ics and point to a google calendar</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">- *</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">- * @return An array of calendars that are migratable</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">- */</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-function getMigratableCalendars() {</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-  function isMigratable(calendar) {</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-    let re = new RegExp(</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-      &quot;^http[s]?://(www|calendar)\\.google\\.com/calendar/ical/&quot; +</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-        &quot;[^/]+/(private(-[^/]+)?|public)/&quot; +</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-        &quot;(full|full-noattendees|composite|&quot; +</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-        &quot;attendees-only|free-busy|basic)(\\.ics)?$&quot;</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-    );</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-    return calendar.type == &quot;ics&quot; &amp;&amp; calendar.uri.spec.match(re);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-  }</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-  return cal</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-    .getCalendarManager()</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-    .getCalendars({})</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    .filter(isMigratable);</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-}</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-/**</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">- * Load Handler for both the wizard and the Thunderbird main window.</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">- */</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-function gdata_migration_loader() {</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-  if (document.documentElement.id == &quot;gdata-migration-wizard&quot;) {</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-    // This is the migration wizard, load the calendars needed.</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-    let listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-    for (let calendar of sortCalendarArray(getMigratableCalendars())) {</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-      let item = document.createXULElement(&quot;checkbox&quot;);</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-      item.setAttribute(&quot;label&quot;, calendar.name);</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-      item.setAttribute(&quot;value&quot;, calendar.id);</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-      item.calendar = calendar;</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-      listbox.appendChild(item);</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-    }</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-    // Set up the &quot;always check&quot; field</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-    document.getElementById(&quot;showagain-checkbox&quot;).checked = Services.prefs.getBoolPref(</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-      &quot;calendar.google.migrate&quot;,</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-      true</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-    );</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-  } else if (</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-    Services.prefs.getBoolPref(&quot;calendar.google.migrate&quot;, true) &amp;&amp;</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-    getMigratableCalendars().length &gt; 0</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-  ) {</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-    // This is not the migration wizard, so it must be a main window. Check</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-    // if the migration wizard needs to be shown and calendars are worth</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-    // migrating.</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-    // Do this after load, so the calendar window appears before the</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-    // wizard is opened.</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-    // XXX Waiting a second gives the views enough time to display</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-    // right, at least on my system. The viewloaded event is quite</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-    // view specific, so there is no good non-hacked way to do this.</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-    setTimeout(() =&gt; {</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-      window.openDialog(</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-        &quot;chrome://gdata-provider/content/gdata-migration-wizard.xul&quot;,</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-        &quot;GdataMigrationWizard&quot;,</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-        &quot;chrome,titlebar,modal,alwaysRaised&quot;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-      );</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-    }, 1000);</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-  }</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-}</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-// Add a Load handler to check for migratable calendars in the main window, or</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-// to load the migration wizard if this is the migration wizard</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-window.addEventListener(&quot;load&quot;, gdata_migration_loader, { capture: false, once: true });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- a/calendar/providers/gdata/content/reminder-action-sms.svg</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ /dev/null</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">-&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; fill=&quot;context-fill&quot; fill-opacity=&quot;context-fill-opacity&quot; viewBox=&quot;0 0 16 16&quot;&gt;</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-  &lt;path d=&quot;M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM9 15H7v-1h2zm3-2.5a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5z&quot;/&gt;</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-&lt;/svg&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/calendar/providers/gdata/defaults/preferences.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,26 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">-</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">-/* extension description */</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-pref(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.description&quot;,</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-     &quot;chrome://gdata-provider/locale/gdata.properties&quot;);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-pref(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;,</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-     &quot;chrome://gdata-provider/locale/gdata.properties&quot;);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-/* other default prefs */</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-pref(&quot;calendar.google.useHTTPMethodOverride&quot;, true);</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-pref(&quot;calendar.google.alarmClosest&quot;, true);</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-pref(&quot;calendar.google.migrate&quot;, true);</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-pref(&quot;calendar.google.maxResultsPerRequest&quot;, 1000);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-pref(&quot;calendar.google.idleTime&quot;, 300);</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-pref(&quot;calendar.google.enableSMSReminders&quot;, false);</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-/**</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">- * Invitations and notifications.</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">- * Note that if enableEmailInvitations is enabled it is a good idea to disable</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">- * attendees or at least sending event notifications.</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">- */</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-pref(&quot;calendar.google.sendEventNotifications&quot;, true);</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-pref(&quot;calendar.google.enableAttendees&quot;, true);</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-pref(&quot;calendar.google.enableEmailInvitations&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/calendar/providers/gdata/jar.mn</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,48 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-#filter substitution</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-gdata-provider.jar:</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-% content gdata-provider %content/</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-% resource gdata-provider .</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-% overlay chrome://calendar/content/calendar-event-dialog.xul chrome://gdata-provider/content/gdata-event-dialog.xul</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-% overlay chrome://calendar/content/calendar-event-dialog-reminder.xul chrome://gdata-provider/content/gdata-event-dialog-reminder.xul</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-% overlay chrome://calendar/content/calendar-properties-dialog.xul chrome://gdata-provider/content/gdata-calendar-properties.xul</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-% overlay chrome://calendar/content/calendarCreation.xul chrome://gdata-provider/content/gdata-calendar-creation.xul</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-% overlay chrome://lightning/content/lightning-item-iframe.xul chrome://gdata-provider/content/gdata-lightning-item-iframe.xul</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-% overlay chrome://lightning/content/lightning-item-toolbar.xul chrome://gdata-provider/content/gdata-lightning-item-toolbar.xul</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-% overlay chrome://messenger/content/messenger.xul chrome://gdata-provider/content/gdata-migration-overlay.xul</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-% overlay chrome://messenger/content/messenger.xul chrome://gdata-provider/content/gdata-event-dialog.xul</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-% style chrome://calendar/content/calendar-event-dialog.xul chrome://gdata-provider/skin/gdata-event-dialog-reminder.css</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-% style chrome://messenger/content/messenger.xul chrome://gdata-provider/skin/gdata-event-dialog-reminder.css</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-    content/browserRequest.js                    (content/browserRequest.js)</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-    content/browserRequest.xul                   (content/browserRequest.xul)</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-    content/gcal.png                             (content/gcal.png)</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-    content/gdata-calendar-creation.js           (content/gdata-calendar-creation.js)</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-    content/gdata-calendar-creation.xul          (content/gdata-calendar-creation.xul)</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-    content/gdata-calendar-properties.js         (content/gdata-calendar-properties.js)</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-    content/gdata-calendar-properties.xul        (content/gdata-calendar-properties.xul)</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-    content/gdata-event-dialog-reminder.js       (content/gdata-event-dialog-reminder.js)</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-    content/gdata-event-dialog-reminder.xul      (content/gdata-event-dialog-reminder.xul)</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-    content/gdata-event-dialog.js                (content/gdata-event-dialog.js)</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-    content/gdata-event-dialog.xul               (content/gdata-event-dialog.xul)</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-    content/gdata-lightning-item-iframe.js       (content/gdata-lightning-item-iframe.js)</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-    content/gdata-lightning-item-iframe.xul      (content/gdata-lightning-item-iframe.xul)</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-    content/gdata-lightning-item-toolbar.xul     (content/gdata-lightning-item-toolbar.xul)</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-    content/gdata-migration-overlay.xul          (content/gdata-migration-overlay.xul)</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-    content/gdata-migration-wizard.xul           (content/gdata-migration-wizard.xul)</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-    content/gdata-migration.js                   (content/gdata-migration.js)</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-% skin gdata-provider classic/1.0 %skin/</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-    skin/browserRequest.css                      (content/browserRequest.css)</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-    skin/gdata-bindings.css                      (content/gdata-bindings.css)</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-    skin/gdata-event-dialog-reminder.css         (content/gdata-event-dialog-reminder.css)</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-    skin/reminder-action-sms.svg                 (content/reminder-action-sms.svg)</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-gdata-provider-@AB_CD@.jar:</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-relativesrcdir comm/calendar/locales:</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-% locale gdata-provider @AB_CD@ %</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-    gdata.dtd                                    (%chrome/calendar/providers/gdata/gdata.dtd)</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-    gdata.properties                             (%chrome/calendar/providers/gdata/gdata.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">deleted file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- a/calendar/providers/gdata/manifest.json</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ /dev/null</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -1,24 +0,0 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">-#</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-#filter substitution</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-{</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-  &quot;manifest_version&quot;: 2,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  &quot;name&quot;: &quot;Provider for Google Calendar&quot;,</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-  &quot;description&quot;: &quot;Allows bidirectional access to Google Calendar&quot;,</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-  &quot;version&quot;: &quot;@THUNDERBIRD_VERSION_DISPLAY@&quot;,</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  &quot;author&quot;: &quot;Philipp Kewisch&quot;,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-  &quot;homepage_url&quot;: &quot;https://addons.mozilla.org/thunderbird/addon/4631&quot;,</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-  &quot;legacy&quot;: true,</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-  &quot;applications&quot;: {</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-    &quot;gecko&quot;: {</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-      &quot;id&quot;: &quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;,</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-      &quot;strict_min_version&quot;: &quot;@MOZ_APP_VERSION@&quot;,</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-      &quot;strict_max_version&quot;: &quot;@MOZ_APP_MAXVERSION@&quot;</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-    }</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-  },</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-  &quot;icons&quot;: {</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-    &quot;256&quot;: &quot;chrome/gdata-provider/content/gcal.png&quot;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-  }</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">deleted file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- a/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ /dev/null</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -1,262 +0,0 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineminus">-</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineminus">-/**</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">- * Provides OAuth 2.0 authentication</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineminus">- */</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;]; /* exported OAuth2 */</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-  const { interfaces: Ci, results: Cr } = Components;</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-}</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-var { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-var { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-function parseURLData(aData) {</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-  let result = {};</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-  aData</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-    .split(/[?#]/, 2)[1]</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-    .split(&quot;&amp;&quot;)</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-    .forEach(aParam =&gt; {</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-      let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-      result[key] = value;</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-    });</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-  return result;</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-}</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-function OAuth2(aBaseURI, aScope, aAppKey, aAppSecret) {</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-  this.authURI = aBaseURI + &quot;oauth2/auth&quot;;</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-  this.tokenURI = aBaseURI + &quot;oauth2/token&quot;;</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-  this.consumerKey = aAppKey;</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-  this.consumerSecret = aAppSecret;</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-  this.scope = aScope;</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-  this.extraAuthParams = [];</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-  this.log = Log4Moz.getConfiguredLogger(&quot;TBOAuth&quot;);</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-}</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-OAuth2.CODE_AUTHORIZATION = &quot;authorization_code&quot;;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-OAuth2.CODE_REFRESH = &quot;refresh_token&quot;;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-OAuth2.prototype = {</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-  responseType: &quot;code&quot;,</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-  consumerKey: null,</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-  consumerSecret: null,</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-  completionURI: &quot;http://localhost&quot;,</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-  requestWindowURI: &quot;chrome://messenger/content/browserRequest.xul&quot;,</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-  requestWindowFeatures: &quot;chrome,private,centerscreen,width=980,height=750&quot;,</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-  requestWindowTitle: &quot;&quot;,</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-  requestWindowDescription: &quot;&quot;,</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-  scope: null,</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-  accessToken: null,</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-  refreshToken: null,</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineminus">-  tokenExpires: 0,</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-  connecting: false,</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineminus">-  connect: function(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-    if (this.connecting) {</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-      return;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineminus">-    }</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineminus">-</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineminus">-    this.connectSuccessCallback = aSuccess;</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-    this.connectFailureCallback = aFailure;</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineminus">-    if (!aRefresh &amp;&amp; this.accessToken) {</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-      aSuccess();</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineminus">-    } else if (this.refreshToken) {</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineminus">-      this.connecting = true;</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineminus">-      this.requestAccessToken(this.refreshToken, OAuth2.CODE_REFRESH);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineminus">-    } else {</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineminus">-      if (!aWithUI) {</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineminus">-        aFailure('{ &quot;error&quot;: &quot;auth_noui&quot; }');</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineminus">-        return;</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineminus">-      }</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineminus">-      this.connecting = true;</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineminus">-      this.requestAuthorization();</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineminus">-    }</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineminus">-  },</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineminus">-</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineminus">-  requestAuthorization: function() {</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineminus">-    let params = [</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineminus">-      [&quot;response_type&quot;, this.responseType],</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-      [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-      [&quot;redirect_uri&quot;, this.completionURI],</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineminus">-    ];</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineminus">-    // The scope can be optional.</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-    if (this.scope) {</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-      params.push([&quot;scope&quot;, this.scope]);</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineminus">-    }</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineminus">-</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-    // Add extra parameters, if they exist</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineminus">-    Array.prototype.push.apply(params, this.extraAuthParams);</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineminus">-</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineminus">-    // Now map the parameters to a string</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineminus">-    params = params.map(([k, v]) =&gt; k + &quot;=&quot; + encodeURIComponent(v)).join(&quot;&amp;&quot;);</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineminus">-</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineminus">-    this._browserRequest = {</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-      account: this,</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineminus">-      url: this.authURI + &quot;?&quot; + params,</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-      description: this.requestWindowDescription,</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineminus">-      _active: true,</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineminus">-      iconURI: &quot;&quot;,</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-      cancelled: function() {</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineminus">-        if (!this._active) {</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineminus">-          return;</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineminus">-        }</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineminus">-</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineminus">-        this.account.finishAuthorizationRequest();</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineminus">-        this.account.onAuthorizationFailed(Cr.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineminus">-      },</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineminus">-</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-      loaded: function(aWindow, aWebProgress) {</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-        if (!this._active) {</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-          return;</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineminus">-        }</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineminus">-</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineminus">-        this._listener = {</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineminus">-          window: aWindow,</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineminus">-          webProgress: aWebProgress,</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineminus">-          _parent: this.account,</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-          QueryInterface: cal.generateQI([Ci.nsIWebProgressListener, Ci.nsISupportsWeakReference]),</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-          _cleanUp: function() {</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-            this.webProgress.removeProgressListener(this);</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-            this.window.close();</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineminus">-            delete this.window;</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineminus">-          },</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineminus">-</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineminus">-          _checkForRedirect: function(aURL) {</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineminus">-            if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-              return;</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineminus">-            }</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineminus">-</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineminus">-            this._parent.finishAuthorizationRequest();</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineminus">-            this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineminus">-          },</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineminus">-</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-          onStateChange: function(aChangedWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-            const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-            if (aStateFlags &amp; wpl.STATE_STOP) {</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-              try {</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineminus">-                let httpchannel = aRequest.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineminus">-</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineminus">-                let responseCategory = Math.floor(httpchannel.responseStatus / 100);</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineminus">-</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineminus">-                if (responseCategory != 2 &amp;&amp; responseCategory != 3) {</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineminus">-                  this._parent.finishAuthorizationRequest();</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineminus">-                  this._parent.onAuthorizationFailed(</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineminus">-                    null,</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineminus">-                    '{ &quot;error&quot;: &quot;http_' + httpchannel.responseStatus + '&quot; }'</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineminus">-                  );</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineminus">-                }</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineminus">-              } catch (e) {</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineminus">-                // Throw the case where it's a http channel.</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineminus">-                if (e.result != Cr.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineminus">-                  throw e;</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineminus">-                }</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineminus">-              }</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineminus">-            }</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineminus">-</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineminus">-            if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-              this._checkForRedirect(aRequest.name);</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineminus">-            }</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineminus">-          },</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineminus">-          onLocationChange: function(aChangedWebProgress, aRequest, aLocation) {</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineminus">-            this._checkForRedirect(aLocation.spec);</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineminus">-          },</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineminus">-          onProgressChange: function() {},</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineminus">-          onStatusChange: function() {},</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineminus">-          onSecurityChange: function() {},</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineminus">-        };</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineminus">-        aWebProgress.addProgressListener(this._listener, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineminus">-        aWindow.document.title = this.account.requestWindowTitle;</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineminus">-      },</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineminus">-    };</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineminus">-</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-    this.wrappedJSObject = this._browserRequest;</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-    Services.ww.openWindow(null, this.requestWindowURI, null, this.requestWindowFeatures, this);</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineminus">-  },</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineminus">-  finishAuthorizationRequest: function() {</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineminus">-    if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineminus">-      return;</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineminus">-    }</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineminus">-</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineminus">-    this._browserRequest._active = false;</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineminus">-    if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineminus">-      this._browserRequest._listener._cleanUp();</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineminus">-    }</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineminus">-    delete this._browserRequest;</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineminus">-  },</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineminus">-</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineminus">-  onAuthorizationReceived: function(aData) {</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineminus">-    this.log.info(&quot;authorization received&quot; + aData);</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineminus">-    let results = parseURLData(aData);</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineminus">-    if (this.responseType == &quot;code&quot;) {</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineminus">-      this.requestAccessToken(results.code, OAuth2.CODE_AUTHORIZATION);</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineminus">-    } else if (this.responseType == &quot;token&quot;) {</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineminus">-      this.onAccessTokenReceived(JSON.stringify(results));</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineminus">-    }</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineminus">-  },</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineminus">-</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineminus">-  onAuthorizationFailed: function(aError, aData) {</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineminus">-    this.connecting = false;</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineminus">-    this.connectFailureCallback(aData);</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineminus">-  },</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineminus">-</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineminus">-  requestAccessToken: function(aCode, aType) {</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineminus">-    let params = [</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineminus">-      [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineminus">-      [&quot;client_secret&quot;, this.consumerSecret],</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineminus">-      [&quot;grant_type&quot;, aType],</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineminus">-    ];</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineminus">-</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineminus">-    if (aType == OAuth2.CODE_AUTHORIZATION) {</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineminus">-      params.push([&quot;code&quot;, aCode]);</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineminus">-      params.push([&quot;redirect_uri&quot;, this.completionURI]);</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineminus">-    } else if (aType == OAuth2.CODE_REFRESH) {</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineminus">-      params.push([&quot;refresh_token&quot;, aCode]);</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineminus">-    }</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineminus">-</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineminus">-    let options = {</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-      postData: params,</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineminus">-      onLoad: this.onAccessTokenReceived.bind(this),</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineminus">-      onError: this.onAccessTokenFailed.bind(this),</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineminus">-    };</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-    httpRequest(this.tokenURI, options);</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-  },</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineminus">-</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineminus">-  onAccessTokenFailed: function(aError, aData) {</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-    if (aError != &quot;offline&quot;) {</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineminus">-      this.refreshToken = null;</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineminus">-    }</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineminus">-    this.connecting = false;</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineminus">-    this.connectFailureCallback(aData);</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineminus">-  },</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineminus">-</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineminus">-  onAccessTokenReceived: function(aData) {</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineminus">-    let result = JSON.parse(aData);</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineminus">-</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineminus">-    this.accessToken = result.access_token;</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineminus">-    if (&quot;refresh_token&quot; in result) {</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineminus">-      this.refreshToken = result.refresh_token;</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineminus">-    }</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineminus">-    if (&quot;expires_in&quot; in result) {</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineminus">-      this.tokenExpires = new Date().getTime() + result.expires_in * 1000;</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineminus">-    } else {</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineminus">-      this.tokenExpires = Number.MAX_VALUE;</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineminus">-    }</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineminus">-    this.tokenType = result.token_type;</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineminus">-</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineminus">-    this.connecting = false;</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineminus">-    this.connectSuccessCallback();</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineminus">-  },</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">deleted file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ /dev/null</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -1,179 +0,0 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineminus">-</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;LOGitem&quot;, &quot;LOGverbose&quot;, &quot;LOGinterval&quot;, &quot;stringException&quot;];</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">-</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-  const { interfaces: Ci } = Components;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-}</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-function LOGverbose(aStr) {</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;calendar.debug.log.verbose&quot;, false)) {</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-    cal.LOG(aStr);</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineminus">-  }</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-}</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-function stringException(e) {</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-  if (&quot;fileName&quot; in e &amp;&amp; &quot;lineNumber&quot; in e) {</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-    return &quot; (&quot; + e.fileName + &quot;:&quot; + e.lineNumber + &quot;):&quot; + e;</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineminus">-  } else {</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-    return e.toString();</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-  }</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-}</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-/**</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">- * LOGitem</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">- * Custom logging functions</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">- */</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-function LOGitem(item) {</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-  if (!item) {</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-    return;</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-  }</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-  let attendees = item.getAttendees({});</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-  let attendeeString = &quot;&quot;;</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-  for (let a of attendees) {</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-    attendeeString += &quot;\n&quot; + LOGattendee(a);</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-  }</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-  let rstr = &quot;\n&quot;;</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-  if (item.recurrenceInfo) {</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-    let ritems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-    for (let ritem of ritems) {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-      rstr += &quot;\t\t&quot; + ritem.icalProperty.icalString;</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-    }</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-    rstr += &quot;\tExceptions:\n&quot;;</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-    let exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-    for (let exc of exids) {</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-      rstr += &quot;\t\t&quot; + exc + &quot;\n&quot;;</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-    }</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-  }</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-  let astr = &quot;\n&quot;;</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-  let alarms = item.getAlarms({});</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-  for (let alarm of alarms) {</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-    astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-  }</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-  LOGverbose(</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-    &quot;[calGoogleCalendar] Logging calIEvent:&quot; +</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-      &quot;\n\tid:&quot; +</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-      item.id +</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-      &quot;\n\tcreated:&quot; +</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-      item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-      &quot;\n\tupdated:&quot; +</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-      item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-      &quot;\n\ttitle:&quot; +</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-      item.title +</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-      &quot;\n\tdescription:&quot; +</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-      item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-      &quot;\n\ttransparency:&quot; +</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineminus">-      item.getProperty(&quot;TRANSP&quot;) +</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineminus">-      &quot;\n\tstatus:&quot; +</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineminus">-      item.status +</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-      &quot;\n\tstartTime:&quot; +</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-      (item.startDate &amp;&amp; item.startDate.toString()) +</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-      &quot;\n\tendTime:&quot; +</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-      (item.endDate &amp;&amp; item.endDate.toString()) +</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineminus">-      &quot;\n\tlocation:&quot; +</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-      item.getProperty(&quot;LOCATION&quot;) +</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-      &quot;\n\tprivacy:&quot; +</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineminus">-      item.privacy +</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-      &quot;\n\tsequence:&quot; +</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-      item.getProperty(&quot;SEQUENCE&quot;) +</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineminus">-      &quot;\n\talarmLastAck:&quot; +</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-      item.alarmLastAck +</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-      &quot;\n\tsnoozeTime:&quot; +</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-      item.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;) +</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-      &quot;\n\tisOccurrence: &quot; +</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-      (item.recurrenceId != null) +</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-      &quot;\n\tOrganizer: &quot; +</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-      LOGattendee(item.organizer) +</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-      &quot;\n\tAttendees: &quot; +</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-      attendeeString +</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-      &quot;\n\trecurrence: &quot; +</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineminus">-      (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;) +</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-      &quot;\n\talarms: &quot; +</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineminus">-      (astr.length &gt; 1 ? &quot;yes: &quot; + astr : &quot;no&quot;)</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineminus">-  );</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineminus">-}</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineminus">-</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineminus">-function LOGattendee(aAttendee, asString) {</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineminus">-  return (</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-    aAttendee &amp;&amp;</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-    &quot;\n\t\tID: &quot; +</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineminus">-      aAttendee.id +</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineminus">-      &quot;\n\t\t\tName: &quot; +</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineminus">-      aAttendee.commonName +</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineminus">-      &quot;\n\t\t\tRsvp: &quot; +</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineminus">-      aAttendee.rsvp +</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-      &quot;\n\t\t\tIs Organizer: &quot; +</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-      (aAttendee.isOrganizer ? &quot;yes&quot; : &quot;no&quot;) +</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineminus">-      &quot;\n\t\t\tRole: &quot; +</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-      aAttendee.role +</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineminus">-      &quot;\n\t\t\tStatus: &quot; +</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-      aAttendee.participationStatus</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-  );</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineminus">-}</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineminus">-</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineminus">-function LOGalarm(aAlarm) {</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-  if (!aAlarm) {</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineminus">-  }</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineminus">-</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineminus">-  let xpropstr = &quot;&quot;;</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineminus">-  for (let [name, value] of aAlarm.properties) {</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-    xpropstr += &quot;\n\t\t\t&quot; + name + &quot;:&quot; + value;</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-  }</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineminus">-</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-  return (</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-    &quot;\n\t\tAction: &quot; +</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-    aAlarm.action +</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-    &quot;\n\t\tOffset: &quot; +</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-    (aAlarm.offset &amp;&amp; aAlarm.offset.toString()) +</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-    &quot;\n\t\talarmDate: &quot; +</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-    (aAlarm.alarmDate &amp;&amp; aAlarm.alarmDate.toString()) +</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineminus">-    &quot;\n\t\trelated: &quot; +</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineminus">-    aAlarm.related +</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineminus">-    &quot;\n\t\trepeat: &quot; +</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineminus">-    aAlarm.repeat +</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineminus">-    &quot;\n\t\trepeatOffset: &quot; +</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-    (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-    &quot;\n\t\trepeatDate: &quot; +</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineminus">-    (aAlarm.repeatDate &amp;&amp; aAlarm.repeatDate.toString()) +</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineminus">-    &quot;\n\t\tdescription: &quot; +</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineminus">-    aAlarm.description +</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineminus">-    &quot;\n\t\tsummary: &quot; +</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-    aAlarm.summary +</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineminus">-    &quot;\n\t\tproperties: &quot; +</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineminus">-    (xpropstr.length &gt; 0 ? &quot;yes:&quot; + xpropstr : &quot;no&quot;)</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineminus">-  );</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineminus">-}</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineminus">-</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineminus">-function LOGinterval(aInterval) {</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-  const fbtypes = Ci.calIFreeBusyInterval;</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineminus">-  let type;</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineminus">-  if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-    type = &quot;FREE&quot;;</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineminus">-  } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-    type = &quot;BUSY&quot;;</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-  } else {</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineminus">-    type = aInterval.freeBusyType + &quot; (UNKNOWN)&quot;;</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineminus">-  }</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineminus">-  cal.LOG(</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineminus">-    &quot;[calGoogleCalendar] Interval from &quot; +</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineminus">-      aInterval.interval.start +</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineminus">-      &quot; to &quot; +</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineminus">-      aInterval.interval.end +</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineminus">-      &quot; is &quot; +</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineminus">-      type</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineminus">-  );</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">deleted file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ /dev/null</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -1,557 +0,0 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineminus">-</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-}</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-var { PromiseUtils } = ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-var API_BASE = {</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-  EVENTS: &quot;https://www.googleapis.com/calendar/v3/&quot;,</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-  TASKS: &quot;https://www.googleapis.com/tasks/v1/&quot;,</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-};</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;calGoogleRequest&quot;, &quot;getCorrectedDate&quot;, &quot;API_BASE&quot;];</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-/**</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">- * Gets the date and time that Google's http server last sent us. Note the</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">- * passed argument is modified. This might not be the exact server time (i.e it</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">- * may be off by network latency), but it does give a good guess when syncing.</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">- *</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">- * @param aDate     The date to modify.</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">- */</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-function getCorrectedDate(aDate) {</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-  if (getCorrectedDate.mClockSkew) {</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-    aDate.second += getCorrectedDate.mClockSkew;</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-  }</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-  return aDate;</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-}</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-/**</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">- * calGoogleRequest</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">- * This class represents a HTTP request sent to Google</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">- *</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">- * @constructor</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">- * @class</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">- */</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-function calGoogleRequest() {</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-  this.mQueryParameters = new Map();</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-  this.mRequestHeaders = new Map();</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-}</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-calGoogleRequest.ADD = &quot;POST&quot;;</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-calGoogleRequest.MODIFY = &quot;PUT&quot;;</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-calGoogleRequest.DELETE = &quot;DELETE&quot;;</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-calGoogleRequest.GET = &quot;GET&quot;;</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineminus">-calGoogleRequest.PATCH = &quot;PATCH&quot;;</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineminus">-</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-var GDATA_ERROR_BASE = Ci.calIErrors.ERROR_BASE + 0x400;</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-calGoogleRequest.LOGIN_FAILED = GDATA_ERROR_BASE + 1;</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineminus">-calGoogleRequest.CONFLICT_DELETED = GDATA_ERROR_BASE + 2;</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineminus">-calGoogleRequest.CONFLICT_MODIFY = GDATA_ERROR_BASE + 3;</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineminus">-calGoogleRequest.NOT_MODIFIED = GDATA_ERROR_BASE + 4;</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-calGoogleRequest.QUOTA_FAILURE = GDATA_ERROR_BASE + 5;</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineminus">-calGoogleRequest.TOKEN_FAILURE = GDATA_ERROR_BASE + 6;</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-calGoogleRequest.RESOURCE_GONE = GDATA_ERROR_BASE + 7;</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">-</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-calGoogleRequest.prototype = {</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-  /* Members */</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-  mUploadContent: null,</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineminus">-  mUploadData: null,</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineminus">-  mSession: null,</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">-  mQueryParameters: null,</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">-  mType: null,</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-  mLoader: null,</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">-  mDeferred: null,</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-  mStatus: Cr.NS_OK,</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">-</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">-  /* Constants */</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-  ADD: calGoogleRequest.ADD,</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">-  MODIFY: calGoogleRequest.MODIFY,</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  DELETE: calGoogleRequest.DELETE,</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-  GET: calGoogleRequest.GET,</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-  PATCH: calGoogleRequest.PATCH,</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-  /* Simple Attributes */</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-  method: &quot;GET&quot;,</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-  id: null,</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">-  uri: null,</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">-  calendar: null,</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">-  reauthenticate: true,</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineminus">-  requestDate: null,</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-  QueryInterface: cal.generateQI([</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-    Ci.calIOperation,</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineminus">-    Ci.nsIStreamLoaderObserver,</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineminus">-    Ci.nsIInterfaceRequestor,</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-    Ci.nsIChannelEventSink,</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-  ]),</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-  /**</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-   * Implement calIOperation</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-   */</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-  get isPending() {</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-    return this.mLoader &amp;&amp; this.mLoader.request != null;</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-  },</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineminus">-</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineminus">-  get status() {</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-    if (this.isPending) {</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-      return this.mLoader.request.status;</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-    } else {</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-      return this.mStatus;</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-    }</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-  },</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineminus">-  cancel: function(aStatus) {</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineminus">-    if (this.isPending) {</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineminus">-      if (this.mLoader) {</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-        this.mLoader.request.cancel(aStatus);</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-      }</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-      this.mStatus = aStatus;</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-    }</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  },</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-  /**</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-   * attribute type</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-   * The type of this request. Must be one of</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-   * GET, ADD, MODIFY, DELETE</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineminus">-   */</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-  get type() {</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-    return this.method;</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-  },</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineminus">-</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineminus">-  set type(val) {</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineminus">-    let valid = [this.GET, this.ADD, this.MODIFY, this.PATCH, this.DELETE];</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineminus">-    if (!valid.includes(val)) {</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineminus">-      throw new Components.Exception(&quot;Invalid request type: &quot; + val, Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineminus">-    }</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineminus">-    return (this.method = val);</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-  },</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-  /**</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineminus">-   * setUploadData</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineminus">-   * The HTTP body data for a POST or PUT request.</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-   *</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-   * @param aContentType The Content type of the Data.</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-   * @param aData        The Data to upload.</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineminus">-   */</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineminus">-  setUploadData: function(aContentType, aData) {</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineminus">-    this.mUploadContent = aContentType;</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineminus">-    this.mUploadData = aData;</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineminus">-  },</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineminus">-  addQueryParameter: function(aKey, aValue) {</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineminus">-    if (aValue) {</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineminus">-      this.mQueryParameters.set(aKey, aValue);</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineminus">-    } else {</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineminus">-      this.mQueryParameters.delete(aKey);</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineminus">-    }</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineminus">-  },</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineminus">-</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineminus">-  addRequestHeader: function(aKey, aValue) {</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineminus">-    if (aValue) {</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineminus">-      this.mRequestHeaders.set(aKey, aValue);</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineminus">-    } else {</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineminus">-      this.mRequestHeaders.delete(aKey);</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineminus">-    }</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineminus">-  },</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineminus">-</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineminus">-  /**</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineminus">-   * commit</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineminus">-   * Starts the request process. This can be called multiple times if the</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-   * request should be repeated</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineminus">-   *</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineminus">-   * @param aSession  The session object this request should be made with.</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineminus">-   *                  This parameter is optional.</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineminus">-   */</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineminus">-  commit: function(aSession) {</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineminus">-    if (!this.mDeferred) {</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineminus">-      this.mDeferred = PromiseUtils.defer();</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineminus">-    }</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineminus">-    let promise = this.mDeferred.promise;</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineminus">-</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineminus">-    try {</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineminus">-      // Set the session to request with</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineminus">-      if (aSession) {</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineminus">-        this.mSession = aSession;</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineminus">-      }</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineminus">-      // create the channel</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineminus">-      let uristring = this.uri;</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineminus">-      if (this.mQueryParameters.size &gt; 0) {</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineminus">-        let params = [];</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineminus">-</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineminus">-        // Using forEach is needed for backwards compatibility</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineminus">-        this.mQueryParameters.forEach((val, key) =&gt; {</span>
<a href="#l37.197"></a><span id="l37.197" class="difflineminus">-          params.push(key + &quot;=&quot; + encodeURIComponent(val));</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineminus">-        });</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineminus">-        uristring += &quot;?&quot; + params.join(&quot;&amp;&quot;);</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineminus">-      }</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineminus">-      let uri = Services.io.newURI(uristring);</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineminus">-      let channel;</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineminus">-      if (&quot;newChannelFromURI2&quot; in Services.io) {</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineminus">-        // Before mozilla67, Lightning 6.8 and below.</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineminus">-        channel = Services.io.newChannelFromURI2(</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineminus">-          uri,</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineminus">-          null,</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineminus">-          Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineminus">-          null,</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineminus">-          Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineminus">-          Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-        );</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-      } else {</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineminus">-        // mozilla67 and later, Lightning 6.9.</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineminus">-        channel = Services.io.newChannelFromURI(</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineminus">-          uri,</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineminus">-          null,</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineminus">-          Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineminus">-          null,</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineminus">-          Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineminus">-          Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineminus">-        );</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-      }</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineminus">-      cal.LOG(&quot;[calGoogleRequest] Requesting &quot; + this.method + &quot; &quot; + channel.URI.spec);</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineminus">-</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineminus">-      this.prepareChannel(channel);</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineminus">-</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-      channel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-      channel.redirectionLimit = 3;</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineminus">-</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineminus">-      this.mLoader = cal.provider.createStreamLoader();</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineminus">-      channel.notificationCallbacks = this;</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineminus">-      cal.provider.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineminus">-    } catch (e) {</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineminus">-      // Let the response function handle the error that happens here</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineminus">-      this.fail(e.result, e.message);</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineminus">-    }</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineminus">-    return promise;</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineminus">-  },</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineminus">-</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-  /**</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineminus">-   * fail</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineminus">-   * Call this request's listener with the given code and Message</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineminus">-   *</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineminus">-   * @param aCode     The Error code to fail with.</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineminus">-   * @param aMessage  The Error message. If this is null, an error Message</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineminus">-   *                  from calGoogleRequest will be used.</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineminus">-   */</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-  fail: function(aCode, aMessage) {</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineminus">-    let ex = new Components.Exception(aMessage, aCode);</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineminus">-    this.mLoader = null;</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-    this.mStatus = aCode;</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-    this.mDeferred.reject(ex);</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineminus">-    this.mDeferred = null;</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-  },</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineminus">-</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineminus">-  /**</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineminus">-   * succeed</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineminus">-   * Call this request's listener with a Success Code and the given Result.</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineminus">-   *</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineminus">-   * @param aResult   The result Text of this request.</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineminus">-   */</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineminus">-  succeed: function(aResult) {</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineminus">-    this.mLoader = null;</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineminus">-    this.mStatus = Cr.NS_OK;</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineminus">-    this.mDeferred.resolve(aResult);</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineminus">-    this.mDeferred = null;</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineminus">-  },</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineminus">-</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineminus">-  /**</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineminus">-   * prepareChannel</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineminus">-   * Prepares the passed channel to match this objects properties</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineminus">-   *</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineminus">-   * @param aChannel    The Channel to be prepared.</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineminus">-   */</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineminus">-  prepareChannel: function(aChannel) {</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineminus">-    // No caching</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineminus">-    aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineminus">-</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineminus">-    // Set upload Data</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineminus">-    if (this.mUploadData) {</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineminus">-      let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].createInstance(</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineminus">-        Ci.nsIScriptableUnicodeConverter</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineminus">-      );</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-      converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineminus">-</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-      let stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-      aChannel = aChannel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineminus">-      aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineminus">-</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineminus">-      cal.LOG(</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-        &quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineminus">-          this.mUploadContent +</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineminus">-          &quot;):\n&quot; +</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineminus">-          this.mUploadData</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineminus">-      );</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineminus">-    }</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineminus">-</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineminus">-    aChannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineminus">-</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineminus">-    // Depending on the preference, we will use X-HTTP-Method-Override to</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineminus">-    // get around some proxies. This will default to true.</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineminus">-    if (</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineminus">-      Services.prefs.getBoolPref(&quot;calendar.google.useHTTPMethodOverride&quot;, true) &amp;&amp;</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineminus">-      (this.method == &quot;PUT&quot; || this.method == &quot;DELETE&quot;)</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineminus">-    ) {</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineminus">-      aChannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineminus">-      aChannel.setRequestHeader(&quot;X-HTTP-Method-Override&quot;, this.method, false);</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineminus">-      if (this.method == &quot;DELETE&quot;) {</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-        // DELETE has no body, set an empty one so that Google accepts</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineminus">-        // the request.</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineminus">-        aChannel.setRequestHeader(&quot;Content-Type&quot;, &quot;application/atom+xml; charset=UTF-8&quot;, false);</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineminus">-        aChannel.setRequestHeader(&quot;Content-Length&quot;, 0, false);</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineminus">-      }</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineminus">-    } else {</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineminus">-      aChannel.requestMethod = this.method;</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineminus">-    }</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineminus">-</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineminus">-    if (this.mRequestHeaders.size) {</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Sending request headers: &quot; + this.mRequestHeaders.toSource());</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineminus">-    }</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineminus">-</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineminus">-    // Using forEach is needed for backwards compatibility</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineminus">-    this.mRequestHeaders.forEach((val, key) =&gt; {</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineminus">-      aChannel.setRequestHeader(key, val, false);</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineminus">-    });</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineminus">-</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineminus">-    // Add Authorization</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineminus">-    let token = this.mSession.accessToken;</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineminus">-    if (token) {</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineminus">-      aChannel.setRequestHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + token, false);</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineminus">-    } else {</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineminus">-      cal.WARN(&quot;[calGoogleCalendar] Missing access token for &quot; + aChannel.URI.spec);</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineminus">-    }</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineminus">-  },</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineminus">-</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-  /**</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineminus">-   * @see nsIInterfaceRequestor</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineminus">-   * @see calProviderUtils.jsm</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineminus">-   */</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineminus">-  getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineminus">-</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-  /**</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineminus">-   * @see nsIChannelEventSink</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineminus">-   */</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineminus">-  asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineminus">-    // all we need to do to the new channel is the basic preparation</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineminus">-    this.prepareChannel(aNewChannel);</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineminus">-    aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineminus">-  },</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineminus">-</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineminus">-  /**</span>
<a href="#l37.354"></a><span id="l37.354" class="difflineminus">-   * @see nsIStreamLoaderObserver</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineminus">-   */</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-  onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-    if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineminus">-      this.fail(aStatus, aResult);</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineminus">-      return;</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineminus">-    }</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineminus">-</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineminus">-    let httpChannel = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineminus">-</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineminus">-    // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineminus">-    let result = new TextDecoder(httpChannel.contentCharset || &quot;utf-8&quot;).decode(</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineminus">-      Uint8Array.from(aResult)</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineminus">-    );</span>
<a href="#l37.368"></a><span id="l37.368" class="difflineminus">-    if (result === null) {</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineminus">-      this.fail(Cr.NS_ERROR_FAILURE, &quot;Could not convert bytestream to Unicode&quot;);</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineminus">-      return;</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineminus">-    }</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineminus">-</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineminus">-    let objData;</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineminus">-    try {</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineminus">-      if (result.length) {</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-        objData = JSON.parse(result);</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineminus">-      } else {</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineminus">-        objData = { status: &quot;No Content&quot; };</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineminus">-      }</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineminus">-    } catch (e) {</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineminus">-      cal.ERROR(&quot;[calGoogleCalendar] Could not parse API response as JSON: &quot; + result);</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineminus">-      this.fail(Cr.NS_ERROR_FAILURE, result);</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineminus">-    }</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineminus">-</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineminus">-    // Calculate Google Clock Skew</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineminus">-    let serverDate = new Date(httpChannel.getResponseHeader(&quot;Date&quot;));</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineminus">-    let curDate = new Date();</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineminus">-</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineminus">-    // The utility function getCorrectedDate in calGoogleUtils.js receives</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineminus">-    // its clock skew seconds from here. The clock skew is updated on each</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineminus">-    // request and is therefore quite accurate. As this calculation doesn't</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineminus">-    // take latency into account it might overlap 1-2 seconds, but better</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineminus">-    // one event too much than one event too little.</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineminus">-    getCorrectedDate.mClockSkew = Math.floor((curDate.getTime() - serverDate.getTime()) / 1000);</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineminus">-    if (getCorrectedDate.mClockSkew != 0) {</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineminus">-      cal.LOG(&quot;[calGoogleRequest] Clock skew is &quot; + getCorrectedDate.mClockSkew + &quot; seconds&quot;);</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineminus">-    }</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineminus">-</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineminus">-    // Remember when this request happened</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineminus">-    this.requestDate = cal.createDateTime();</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineminus">-    this.requestDate.nativeTime = serverDate.getTime() * 1000;</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineminus">-</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineminus">-    cal.LOG(</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineminus">-      &quot;[calGoogleCalendar] Request &quot; +</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineminus">-        this.method +</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineminus">-        &quot; &quot; +</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineminus">-        httpChannel.URI.spec +</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineminus">-        &quot; responded with HTTP &quot; +</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineminus">-        httpChannel.responseStatus</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineminus">-    );</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineminus">-</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineminus">-    // Handle all (documented) error codes</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineminus">-    switch (httpChannel.responseStatus) {</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-      case 200: /* No error. */</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineminus">-      case 201: /* Creation of a resource was successful. */</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineminus">-      case 204 /* No content */:</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineminus">-        // Everything worked out, we are done</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineminus">-        if (this.calendar) {</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineminus">-          this.calendar.setProperty(&quot;currentStatus&quot;, 0);</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineminus">-        }</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineminus">-        this.succeed(objData);</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineminus">-        break;</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineminus">-      case 304 /* Not modified */:</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineminus">-        this.fail(calGoogleRequest.NOT_MODIFIED, objData);</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineminus">-        break;</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineminus">-      case 401: /* Authorization required. */</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineminus">-      case 403: {</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineminus">-        /* Unsupported standard parameter, or authentication or</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineminus">-                         Authorization failed. */</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineminus">-        let reason =</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineminus">-          objData &amp;&amp;</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineminus">-          objData.error &amp;&amp;</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineminus">-          objData.error.errors &amp;&amp;</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineminus">-          objData.error.errors[0] &amp;&amp;</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineminus">-          objData.error.errors[0].reason;</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineminus">-        cal.LOG(</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineminus">-          &quot;[calGoogleCalendar] Login failed for &quot; +</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineminus">-            this.mSession.id +</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineminus">-            &quot; HTTP Status: &quot; +</span>
<a href="#l37.440"></a><span id="l37.440" class="difflineminus">-            httpChannel.responseStatus +</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineminus">-            &quot; Reason: &quot; +</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineminus">-            (reason || result)</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineminus">-        );</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineminus">-        switch (reason) {</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineminus">-          case &quot;invalid_client&quot;:</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineminus">-            this.mSession.notifyOutdated();</span>
<a href="#l37.447"></a><span id="l37.447" class="difflineminus">-            if (this.calendar) {</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineminus">-              this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineminus">-              this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.TOKEN_FAILURE);</span>
<a href="#l37.450"></a><span id="l37.450" class="difflineminus">-            }</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineminus">-            this.fail(calGoogleRequest.TOKEN_FAILURE, reason);</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineminus">-            break;</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineminus">-          case &quot;unauthorized_client&quot;:</span>
<a href="#l37.454"></a><span id="l37.454" class="difflineminus">-            // This often happens when the client makes a request</span>
<a href="#l37.455"></a><span id="l37.455" class="difflineminus">-            // authorized with an old api token. Retry the request</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineminus">-            // once.</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineminus">-            this.mSession.invalidate();</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineminus">-            if (this.reauthenticate) {</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineminus">-              cal.LOG(</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineminus">-                &quot;[calGoogleRequest] The access token is not authorized, trying to refresh token.&quot;</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineminus">-              );</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineminus">-              this.reauthenticate = false;</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineminus">-              this.mSession.asyncItemRequest(this);</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineminus">-            } else {</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineminus">-              cal.LOG(</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineminus">-                &quot;[calGoogleRequest] Even refreshed token is not authorized, looks like the client is outdated&quot;</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineminus">-              );</span>
<a href="#l37.468"></a><span id="l37.468" class="difflineminus">-              this.mSession.notifyOutdated();</span>
<a href="#l37.469"></a><span id="l37.469" class="difflineminus">-              if (this.calendar) {</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineminus">-                this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineminus">-                this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.TOKEN_FAILURE);</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineminus">-              }</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineminus">-              this.fail(calGoogleRequest.TOKEN_FAILURE, reason);</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineminus">-            }</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineminus">-            break;</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineminus">-          case &quot;variableTermLimitExceeded&quot;:</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineminus">-          case &quot;userRateLimitExceeded&quot;:</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineminus">-          case &quot;dailyLimitExceeded&quot;:</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineminus">-          case &quot;quotaExceeded&quot;:</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineminus">-            this.mSession.notifyQuotaExceeded();</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineminus">-            if (this.calendar) {</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineminus">-              this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineminus">-              this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.QUOTA_FAILURE);</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineminus">-            }</span>
<a href="#l37.485"></a><span id="l37.485" class="difflineminus">-            this.fail(calGoogleRequest.QUOTA_FAILURE, reason);</span>
<a href="#l37.486"></a><span id="l37.486" class="difflineminus">-            break;</span>
<a href="#l37.487"></a><span id="l37.487" class="difflineminus">-          case &quot;insufficientPermissions&quot;:</span>
<a href="#l37.488"></a><span id="l37.488" class="difflineminus">-            if (this.type == this.MODIFY || this.type == this.DELETE || this.type == this.ADD) {</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineminus">-              this.fail(Ci.calIErrors.MODIFICATION_FAILED, objData);</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineminus">-            } else {</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineminus">-              this.fail(Ci.calIErrors.READ_FAILED, objData);</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineminus">-            }</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineminus">-            break;</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineminus">-          case &quot;authError&quot;:</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineminus">-          case &quot;invalidCredentials&quot;:</span>
<a href="#l37.496"></a><span id="l37.496" class="difflineminus">-            this.mSession.invalidate();</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineminus">-            if (this.reauthenticate) {</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineminus">-              this.reauthenticate = false;</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineminus">-              this.mSession.asyncItemRequest(this);</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineminus">-            } else {</span>
<a href="#l37.501"></a><span id="l37.501" class="difflineminus">-              this.fail(calGoogleRequest.LOGIN_FAILED, reason);</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineminus">-            }</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineminus">-            break;</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineminus">-          default:</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineminus">-            if (this.calendar) {</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineminus">-              this.calendar.setProperty(&quot;currentStatus&quot;, Cr.NS_ERROR_FAILURE);</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineminus">-            }</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineminus">-            this.fail(Cr.NS_ERROR_FAILURE, result);</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineminus">-            break;</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineminus">-        }</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineminus">-</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineminus">-        break;</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineminus">-      }</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineminus">-      case 404 /* The resource was not found on the server, which is</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineminus">-                         also a conflict */:</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineminus">-        //  404 NOT FOUND: Resource (such as a feed or entry) not found.</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineminus">-        // 410 Gone: Happens when deleting an event that has already</span>
<a href="#l37.518"></a><span id="l37.518" class="difflineminus">-        //           been deleted.</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineminus">-        this.fail(calGoogleRequest.CONFLICT_DELETED, objData);</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineminus">-        break;</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineminus">-      case 410:</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineminus">-        this.fail(calGoogleRequest.RESOURCE_GONE, objData);</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineminus">-        break;</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineminus">-      case 412:</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineminus">-      case 409 /* Specified version number doesn't match resource's</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineminus">-                         latest version number. */:</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineminus">-        this.fail(calGoogleRequest.CONFLICT_MODIFY, objData);</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineminus">-        break;</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineminus">-      case 400: {</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineminus">-        // Some bad requests we can handle</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineminus">-        let error = objData &amp;&amp; objData.error &amp;&amp; objData.error.errors &amp;&amp; objData.error.errors[0];</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineminus">-</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineminus">-        if (error.message == &quot;Invalid sync token value.&quot;) {</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineminus">-          this.fail(calGoogleRequest.RESOURCE_GONE, objData);</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineminus">-          return;</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineminus">-        }</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineminus">-      }</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineminus">-      // Otherwise fall through</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineminus">-      default: {</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineminus">-        // The following codes are caught here:</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineminus">-        //  500 INTERNAL SERVER ERROR: Internal error. This is the</span>
<a href="#l37.542"></a><span id="l37.542" class="difflineminus">-        //                             default code that is used for</span>
<a href="#l37.543"></a><span id="l37.543" class="difflineminus">-        //                             all unrecognized errors.</span>
<a href="#l37.544"></a><span id="l37.544" class="difflineminus">-        //</span>
<a href="#l37.545"></a><span id="l37.545" class="difflineminus">-</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineminus">-        // Something else went wrong</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineminus">-        let msg =</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineminus">-          &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineminus">-          httpChannel.responseStatus +</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineminus">-          &quot; &quot; +</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineminus">-          httpChannel.responseStatusText +</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineminus">-          &quot; Body: &quot; +</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineminus">-          result;</span>
<a href="#l37.554"></a><span id="l37.554" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] &quot; + msg);</span>
<a href="#l37.555"></a><span id="l37.555" class="difflineminus">-</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineminus">-        this.fail(Cr.NS_ERROR_NOT_AVAILABLE, msg);</span>
<a href="#l37.557"></a><span id="l37.557" class="difflineminus">-        break;</span>
<a href="#l37.558"></a><span id="l37.558" class="difflineminus">-      }</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineminus">-    }</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineminus">-  },</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,628 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">-</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-/* globals OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_CLIENT_SECRET */</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-  const { classes: Cc, interfaces: Ci, results: Cr } = Components;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-}</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-var { OAuth2 } = ChromeUtils.import(&quot;resource://gdata-provider/modules/OAuth2.jsm&quot;);</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-var { getProviderString } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-var { LOGinterval } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-var { calGoogleRequest, API_BASE } = ChromeUtils.import(</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-);</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-var { PromiseUtils } = ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-var cIFBI = Ci.calIFreeBusyInterval;</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-var nIPM = Ci.nsIPermissionManager;</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-var NOTIFY_TIMEOUT = 60 * 1000;</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;getGoogleSessionManager&quot;];</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-var gdataSessionMap = new Map();</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-var calGoogleSessionManager = {</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-  /**</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-   * Get a Session object for the specified calendar. If aCreate is false,</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-   * null will be returned if the session doesn't exist. Otherwise, the</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-   * session will be created.</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-   *</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-   * @param aCalendar  The calendar to get the session for.</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-   * @param aCreate    If true, the session will be created prior to returning.</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineminus">-   * @return           The initialized session object.</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-   */</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-  getSessionByCalendar: function(aCalendar, aCreate) {</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-    let id = null;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-    let uri = aCalendar.uri;</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-    let host = (function() {</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-      try {</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-        return uri.host;</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-      } catch (e) {</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-        return null;</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-      }</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-    })();</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-    const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-    if (aCalendar.type != &quot;gdata&quot;) {</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-      return null;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-    }</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineminus">-    if (uri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-      let parts = uri.pathQueryRef.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-      id = parts[0] || cal.getUUID();</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-    } else if (</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-      host == &quot;www.google.com&quot; &amp;&amp;</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-      uri.pathQueryRef.startsWith(&quot;/calendar/feeds&quot;) &amp;&amp;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-      protocols.some(scheme =&gt; uri.schemeIs(scheme))</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-    ) {</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-      let googleCalendarName = aCalendar.getProperty(&quot;googleCalendarName&quot;);</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-      let googleUser = Services.prefs.getStringPref(</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-        &quot;calendar.google.calPrefs.&quot; + googleCalendarName + &quot;.googleUser&quot;,</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-        null</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-      );</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-      id = googleUser || googleCalendarName || cal.getUUID();</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-    }</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-    return id ? this.getSessionById(id, aCreate) : null;</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-  },</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-  getSessionById: function(aSessionId, aCreate) {</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-    // Check if the session exists</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-    if (gdataSessionMap.has(aSessionId)) {</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-      cal.LOG(&quot;[calGoogleSessionManager] Reusing session &quot; + aSessionId);</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-    } else if (aCreate) {</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-      cal.LOG(&quot;[calGoogleSessionManager] Creating session &quot; + aSessionId);</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-      gdataSessionMap.set(aSessionId, new calGoogleSession(aSessionId));</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-    }</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-    return gdataSessionMap.get(aSessionId);</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-  },</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-};</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-function getGoogleSessionManager() {</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-  return calGoogleSessionManager;</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-}</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-/**</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineminus">- * calGoogleSession</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">- * This Implements a Session object to communicate with google</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">- *</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineminus">- * @constructor</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineminus">- * @class</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">- * @param aId       The ID for the new session.</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineminus">- */</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineminus">-function calGoogleSession(aId) {</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-  this.mId = aId;</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineminus">-</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineminus">-  this.setupOAuth();</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineminus">-</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineminus">-  // Register a freebusy provider for this session</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineminus">-  cal.getFreeBusyService().addProvider(this);</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineminus">-}</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineminus">-</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-calGoogleSession.prototype = {</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineminus">-  mId: null,</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineminus">-  mSessionID: null,</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineminus">-  mLoginPromise: null,</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineminus">-</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-  get id() {</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-    return this.mId;</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-  },</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineminus">-</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineminus">-  notifyQuotaExceeded: function() {</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineminus">-    let now = new Date();</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-    if (!this.mLastNotified || now - this.mLastNotified &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-      this.mLastNotified = now;</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-      let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-      let quotaString = getProviderString(&quot;quotaExceeded&quot;, this.id);</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineminus">-      Services.prompt.alert(cal.window.getCalendarWindow(), title, quotaString);</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineminus">-    } else {</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineminus">-      cal.LOG(</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineminus">-        &quot;[calGoogleCalendar] Throttling quota notification, last was &quot; +</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineminus">-          (now - this.mLastNotified) +</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-          &quot; ms ago&quot;</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-      );</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-    }</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineminus">-  },</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineminus">-</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineminus">-  notifyOutdated: function() {</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-    let now = new Date();</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineminus">-    if (!this.mLastNotified || now - this.mLastNotified &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineminus">-      this.mLastNotified = now;</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineminus">-      let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineminus">-      let outdatedString = getProviderString(&quot;providerOutdated&quot;);</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineminus">-      Services.prompt.alert(cal.window.getCalendarWindow(), title, outdatedString);</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineminus">-    } else {</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineminus">-      cal.LOG(</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineminus">-        &quot;[calGoogleCalendar] Throttling outdated notification, last was &quot; +</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-          (now - this.mLastNotified) +</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-          &quot; ms ago&quot;</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineminus">-      );</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-    }</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineminus">-  },</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineminus">-</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineminus">-  setupOAuth: function() {</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-    let sessionId = this.mId;</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineminus">-    let authDescr = getProviderString(&quot;requestWindowDescription&quot;, sessionId);</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineminus">-    let authTitle = getProviderString(&quot;requestWindowTitle&quot;, sessionId);</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineminus">-    let locale =</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineminus">-      typeof Services.locale.requestedLocale === &quot;undefined&quot;</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-        ? Services.locale.getRequestedLocale()</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-        : Services.locale.requestedLocale;</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineminus">-</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineminus">-    // Set up a new OAuth2 instance for logging in.</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineminus">-    this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_CLIENT_SECRET);</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineminus">-    this.oauth.extraAuthParams = [</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineminus">-      [&quot;login_hint&quot;, sessionId],</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineminus">-      // Use application locale for login dialog</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineminus">-      [&quot;hl&quot;, locale],</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineminus">-    ];</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineminus">-    this.oauth.requestWindowURI = &quot;chrome://gdata-provider/content/browserRequest.xul&quot;;</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineminus">-    this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=750&quot;;</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineminus">-    this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineminus">-    this.oauth.requestWindowDescription = authDescr;</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineminus">-</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineminus">-    // Overwrite the refreshToken attribute, since we want to save it in</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineminus">-    // the password manager</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineminus">-    let pwMgrId = &quot;Google Calendar OAuth Token&quot;;</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineminus">-    Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineminus">-      get: function() {</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-        if (!this.mRefreshToken) {</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-          let pass = { value: null };</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-          try {</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-            let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-            cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-          } catch (e) {</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineminus">-            // User might have cancelled the master password prompt, that's ok</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineminus">-            if (e.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineminus">-              throw e;</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineminus">-            }</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineminus">-          }</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineminus">-          this.mRefreshToken = pass.value;</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineminus">-        }</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineminus">-        return this.mRefreshToken;</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-      },</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-      set: function(val) {</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineminus">-        try {</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineminus">-          let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineminus">-          if (val) {</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineminus">-            cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-          } else {</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-            cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineminus">-          }</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-        } catch (e) {</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineminus">-          // User might have cancelled the master password prompt, or password saving</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineminus">-          // could be disabled. That is ok, throw for everything else.</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-          if (e.result != Cr.NS_ERROR_ABORT &amp;&amp; e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-            throw e;</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineminus">-          }</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineminus">-        }</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineminus">-        return (this.mRefreshToken = val);</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineminus">-      },</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-      enumerable: true,</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineminus">-    });</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineminus">-</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineminus">-    // If the user has disabled cookies, we need to add an exception for</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineminus">-    // Google so authentication works. If the user has explicitly blocked</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineminus">-    // google.com then we won't overwrite the rule though.</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineminus">-    if (Services.prefs.getIntPref(&quot;network.cookie.cookieBehavior&quot;) == 2) {</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineminus">-      let found = null;</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineminus">-      for (let perm of fixIterator(Services.perms.enumerator, Ci.nsIPermission)) {</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineminus">-        if (perm.type == &quot;cookie&quot; &amp;&amp; perm.host == &quot;google.com&quot;) {</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineminus">-          found = perm;</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-          break;</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineminus">-        }</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineminus">-      }</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineminus">-</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineminus">-      if (!found || found.capability != nIPM.DENY_ACTION) {</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineminus">-        let uri = Services.io.newURI(&quot;http://google.com&quot;);</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineminus">-        if (Services.vc.compare(Services.appinfo.platformVersion, 42) &gt;= 0) {</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineminus">-          Services.perms.remove(uri, &quot;cookie&quot;);</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineminus">-        } else {</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-          // Earlier versions take a string argument instead of nsIURI.</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineminus">-          Services.perms.remove(uri.host, &quot;cookie&quot;);</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineminus">-        }</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineminus">-        Services.perms.add(uri, &quot;cookie&quot;, nIPM.ALLOW_ACTION, nIPM.EXPIRE_SESSION);</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineminus">-      }</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineminus">-    }</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineminus">-  },</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineminus">-</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineminus">-  get accessToken() {</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-    return this.oauth.accessToken;</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineminus">-  },</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-  get refreshToken() {</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-    return this.oauth.refreshToken;</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineminus">-  },</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineminus">-  set refreshToken(val) {</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineminus">-    this.oauth.refreshToken = val;</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineminus">-  },</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineminus">-</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineminus">-  /**</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineminus">-   * Resets the access token, it will be re-retrieved on the next request.</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineminus">-   */</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineminus">-  invalidate: function() {</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-    cal.LOG(&quot;[calGoogleSession] Invalidating session, will reauthenticate on next request&quot;);</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-    this.oauth.accessToken = null;</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineminus">-  },</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineminus">-</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineminus">-  /**</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineminus">-   * Returns a promise resolved when the login is complete.</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-   */</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineminus">-  login: function() {</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineminus">-    if (this.mLoginPromise) {</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-      return this.mLoginPromise;</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineminus">-    }</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineminus">-    let deferred = PromiseUtils.defer();</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineminus">-</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineminus">-    try {</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineminus">-      // Start logging in</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Logging in session &quot; + this.mId);</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineminus">-      let accessToken = this.accessToken;</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineminus">-</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-      let authSuccess = function() {</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Successfully acquired a new OAuth token for &quot; + this.mId);</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineminus">-        deferred.resolve(this.accessToken);</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineminus">-      }.bind(this);</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineminus">-</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">-      let authFailed = function(aData) {</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-        cal.LOG(</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-          &quot;[calGoogleCalendar] Failed to acquire a new&quot; +</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineminus">-            &quot; OAuth token for &quot; +</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineminus">-            this.mId +</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-            &quot; data: &quot; +</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-            aData</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineminus">-        );</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-        let error = null;</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-        if (aData) {</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-          let dataObj;</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineminus">-          try {</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineminus">-            dataObj = JSON.parse(aData);</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineminus">-          } catch (e) {}</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-          error = dataObj &amp;&amp; dataObj.error;</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-        }</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-        if (error == &quot;invalid_client&quot; || error == &quot;http_401&quot;) {</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineminus">-          this.notifyOutdated();</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineminus">-        } else if (error == &quot;unauthorized_client&quot;) {</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineminus">-          cal.ERROR(&quot;[calGoogleSession] Token for &quot; + this.mId + &quot; is no longer authorized&quot;);</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineminus">-          // We need to trigger a login without access token but want</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineminus">-          // to login result to the original promise handlers. First</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineminus">-          // reset the login promise so that we don't just receive</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineminus">-          // the existing token from calling login() again. Then set</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineminus">-          // a new login promise in case of another handler.</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineminus">-          this.oauth.accessToken = null;</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineminus">-          this.mLoginPromise = null;</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineminus">-          this.mLoginPromise = this.login().then(deferred.resolve, deferred.reject);</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-          return;</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineminus">-        } else {</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineminus">-          cal.ERROR(&quot;[calGoogleSession] Authentication failure: &quot; + aData);</span>
<a href="#l38.316"></a><span id="l38.316" class="difflineminus">-        }</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-        deferred.reject(new Components.Exception(error));</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-      }.bind(this);</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-      let connect = function() {</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-        // Use the async prompter to avoid multiple master password prompts</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineminus">-        let self = this;</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineminus">-        let promptlistener = {</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineminus">-          onPromptStartAsync: function(callback) {</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineminus">-            this.onPromptAuthAvailable(callback);</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineminus">-          },</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineminus">-          onPromptAuthAvailable: function(callback) {</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineminus">-            self.oauth.connect(</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineminus">-              () =&gt; {</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineminus">-                authSuccess();</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineminus">-                if (callback) {</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineminus">-                  callback.onAuthResult(true);</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineminus">-                }</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-              },</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-              () =&gt; {</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineminus">-                authFailed();</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineminus">-                if (callback) {</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineminus">-                  callback.onAuthResult(false);</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineminus">-                }</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineminus">-              },</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineminus">-              true</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-            );</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-          },</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineminus">-          onPromptCanceled: authFailed,</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineminus">-          onPromptStart: function() {},</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineminus">-        };</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineminus">-        let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;].getService(</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineminus">-          Ci.nsIMsgAsyncPrompter</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-        );</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-        asyncprompter.queueAsyncAuthPrompt(&quot;googleapi://&quot; + this.id, false, promptlistener);</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineminus">-      }.bind(this);</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineminus">-</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineminus">-      if (accessToken) {</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineminus">-        deferred.resolve(accessToken);</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineminus">-      } else {</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] No access token for &quot; + this.mId + &quot;, refreshing token&quot;);</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineminus">-        // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-        // master password prompt will show just the buttons and</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineminus">-        // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-        // all is well.</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineminus">-        setTimeout(function postpone() {</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineminus">-          let win = cal.window.getCalendarWindow();</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineminus">-          if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineminus">-            setTimeout(postpone, 400);</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineminus">-          } else {</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineminus">-            connect();</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineminus">-          }</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineminus">-        }, 0);</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineminus">-      }</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-    } catch (e) {</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineminus">-      // If something went wrong, reset the login state just in case</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineminus">-      deferred.reject(e);</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineminus">-    }</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineminus">-    return deferred.promise.then(</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-      accessToken =&gt; {</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineminus">-        this.mLoginPromise = null;</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineminus">-        return accessToken;</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineminus">-      },</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-      e =&gt; {</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-        this.mLoginPromise = null;</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineminus">-        throw e;</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineminus">-      }</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-    );</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-  },</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineminus">-  /**</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineminus">-   * asyncItemRequest</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineminus">-   * get or post an Item from or to Google using the Queue.</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-   *</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-   * @param aRequest          The Request Object. This is an instance of</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-   *                          calGoogleRequest.</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-   */</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineminus">-  asyncItemRequest: function(aRequest) {</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineminus">-    let tokenExpiresIn = Math.floor((this.oauth.tokenExpires - new Date().getTime()) / 1000);</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineminus">-    if (tokenExpiresIn &lt; 0 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineminus">-      cal.LOG(&quot;[calGoogleSession] Token expired &quot; + -tokenExpiresIn + &quot; seconds ago, resetting&quot;);</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineminus">-      this.oauth.accessToken = null;</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-    }</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineminus">-</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineminus">-    if (this.accessToken) {</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineminus">-      // Already have a token, we can request directly. If the token is</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-      // about to expire use it, but refresh the token while we are here.</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-      if (tokenExpiresIn &lt; 30 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineminus">-        cal.LOG(</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineminus">-          &quot;[calGoogleSession] Token will expire in &quot; + tokenExpiresIn + &quot; seconds, refreshing&quot;</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineminus">-        );</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineminus">-        this.mLoginPromise = this.login();</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineminus">-        this.mLoginPromise.then(() =&gt; {</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineminus">-          cal.LOG(&quot;[calGoogleSession] Premature token refresh completed&quot;);</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineminus">-        });</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineminus">-      }</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineminus">-      return aRequest.commit(this);</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineminus">-    } else if (this.mLoginPromise) {</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-      // We are logging in and have no token, queue the request</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-      cal.LOG(&quot;[calGoogleSession] Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-      return this.mLoginPromise.then(</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-        () =&gt; {</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-          return aRequest.commit(this);</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineminus">-        },</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineminus">-        e =&gt; {</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineminus">-          // If the user cancelled the login dialog, then disable the</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-          // calendar until the next startup or manual enable.</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineminus">-          if (aRequest.calendar &amp;&amp; e.message == &quot;cancelled&quot;) {</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineminus">-            aRequest.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-            aRequest.calendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-            aRequest.calendar.setProperty(&quot;currentStatus&quot;, Cr.NS_ERROR_FAILURE);</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-          }</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineminus">-          throw e;</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineminus">-        }</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineminus">-      );</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-    } else {</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-      // Not logging in and no token, get the login promise and retry.</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-      this.mLoginPromise = this.login();</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineminus">-      return this.asyncItemRequest(aRequest);</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineminus">-    }</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-  },</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineminus">-</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-  asyncPaginatedRequest: async function(aRequest, onFirst, onEach, onLast) {</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-    let data = await this.asyncItemRequest(aRequest);</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineminus">-    if (onFirst) {</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineminus">-      await onFirst(data);</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineminus">-    }</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineminus">-    if (onEach) {</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineminus">-      await onEach(data);</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineminus">-    }</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineminus">-</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineminus">-    // In bug 1410672 it turns out this doesn't work without return await</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineminus">-    /* eslint-disable no-return-await */</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineminus">-    if (data.nextPageToken) {</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineminus">-      aRequest.addQueryParameter(&quot;pageToken&quot;, data.nextPageToken);</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineminus">-      return await this.asyncPaginatedRequest(aRequest, null, onEach, onLast);</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineminus">-    } else if (onLast) {</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-      return await onLast(data);</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineminus">-    }</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineminus">-    /* eslint-enable no-return-await */</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineminus">-</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineminus">-    return null;</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineminus">-  },</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineminus">-</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineminus">-  /**</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineminus">-   * calIFreeBusyProvider Implementation</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-   */</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-  getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineminus">-    let completeSync = aIntervals =&gt; {</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineminus">-      cal.LOG(</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-        &quot;[calGoogleCalendar] Freebusy query for &quot; +</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineminus">-          aCalId +</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineminus">-          &quot;succeeded, returning &quot; +</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineminus">-          aIntervals.length +</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineminus">-          &quot; intervals&quot;</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineminus">-      );</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineminus">-      aListener.onResult({ status: Cr.NS_OK }, aIntervals);</span>
<a href="#l38.477"></a><span id="l38.477" class="difflineminus">-    };</span>
<a href="#l38.478"></a><span id="l38.478" class="difflineminus">-</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineminus">-    let failSync = (aStatus, aMessage) =&gt; {</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineminus">-      cal.LOG(</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineminus">-        &quot;[calGoogleCalendar] Freebusy query for &quot; +</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-          aCalId +</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-          &quot; failed (&quot; +</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineminus">-          aStatus +</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineminus">-          &quot;): &quot; +</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineminus">-          aMessage</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineminus">-      );</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineminus">-</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-      // Usually we would notify with a result, but this causes trouble</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-      // with Lightning 3.9 and older.</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-      aListener.onResult({ status: aStatus }, null);</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-    };</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineminus">-</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineminus">-    if (</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineminus">-      !aCalId.includes(&quot;@&quot;) ||</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineminus">-      !aCalId.includes(&quot;.&quot;) ||</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineminus">-      !aCalId.toLowerCase().startsWith(&quot;mailto:&quot;)</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineminus">-    ) {</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineminus">-      // No valid email, screw it</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineminus">-      return failSync(Cr.NS_ERROR_FAILURE, null);</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineminus">-    }</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineminus">-</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineminus">-    if (aRangeStart) {</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineminus">-      aRangeStart = aRangeStart.getInTimezone(cal.dtz.UTC);</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineminus">-    }</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineminus">-    if (aRangeEnd) {</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineminus">-      aRangeEnd = aRangeEnd.getInTimezone(cal.dtz.UTC);</span>
<a href="#l38.508"></a><span id="l38.508" class="difflineminus">-    }</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-    let rfcRangeStart = cal.dtz.toRFC3339(aRangeStart);</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineminus">-    let rfcRangeEnd = cal.dtz.toRFC3339(aRangeEnd);</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-    /* 7 is the length of &quot;mailto:&quot;, we've asserted this above */</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-    let strippedCalId = aCalId.substr(7);</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineminus">-    let requestData = {</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-      timeMin: rfcRangeStart,</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineminus">-      timeMax: rfcRangeEnd,</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-      items: [{ id: strippedCalId }],</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-    };</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-    let request = new calGoogleRequest();</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-    request.type = request.ADD;</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-    request.calendar = null;</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-    request.uri = API_BASE.EVENTS + &quot;freeBusy&quot;;</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineminus">-    request.reauthenticate = false;</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineminus">-    request.setUploadData(&quot;application/json; charset=UTF-8&quot;, JSON.stringify(requestData));</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineminus">-</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineminus">-    // Request Parameters</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineminus">-    this.asyncItemRequest(request).then(</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineminus">-      aData =&gt; {</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-        if (&quot;calendars&quot; in aData &amp;&amp; strippedCalId in aData.calendars) {</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-          let calData = aData.calendars[strippedCalId];</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-          let reason = calData.errors &amp;&amp; calData.errors[0] &amp;&amp; calData.errors[0].reason;</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-          if (reason) {</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-            cal.LOG(</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-              &quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineminus">-            );</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineminus">-            failSync(Cr.NS_ERROR_FAILURE, reason);</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineminus">-          } else {</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-            let utcZone = cal.dtz.UTC;</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-            cal.LOG(</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-              &quot;[calGoogleCalendar] Found &quot; +</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineminus">-                calData.busy.length +</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineminus">-                &quot; busy slots within range for &quot; +</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineminus">-                strippedCalId</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineminus">-            );</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineminus">-            let busyRanges = calData.busy.map(entry =&gt; {</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineminus">-              let start = cal.dtz.fromRFC3339(entry.start, utcZone);</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineminus">-              let end = cal.dtz.fromRFC3339(entry.end, utcZone);</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineminus">-              let interval = new cal.provider.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-              LOGinterval(interval);</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-              return interval;</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-            });</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineminus">-            completeSync(busyRanges);</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-          }</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineminus">-        } else {</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineminus">-          cal.ERROR(&quot;[calGoogleCalendar] Invalid freebusy response: &quot; + aData.toSource());</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineminus">-          failSync(Cr.NS_ERROR_FAILURE, aData &amp;&amp; aData.toSource());</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineminus">-        }</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineminus">-      },</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineminus">-      e =&gt; {</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineminus">-        cal.ERROR(&quot;[calGoogleCalendar] Failed freebusy request: &quot; + e);</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineminus">-        return failSync(request.status, null);</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-      }</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-    );</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-    return request;</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineminus">-  },</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineminus">-</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineminus">-  getCalendarList: function() {</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineminus">-    let calendarRequest = new calGoogleRequest();</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineminus">-    calendarRequest.type = calendarRequest.GET;</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineminus">-    calendarRequest.uri = API_BASE.EVENTS + &quot;users/me/calendarList&quot;;</span>
<a href="#l38.574"></a><span id="l38.574" class="difflineminus">-</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineminus">-    let items = [];</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineminus">-    return this.asyncPaginatedRequest(</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineminus">-      calendarRequest,</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineminus">-      null,</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-      data =&gt; {</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineminus">-        items.push(...data.items);</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineminus">-      },</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineminus">-      () =&gt; {</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineminus">-        return items;</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineminus">-      }</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineminus">-    );</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineminus">-  },</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineminus">-</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineminus">-  getTasksList: function() {</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineminus">-    let tasksRequest = new calGoogleRequest();</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineminus">-    tasksRequest.type = tasksRequest.GET;</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-    tasksRequest.uri = API_BASE.TASKS + &quot;users/@me/lists&quot;;</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineminus">-    let items = [];</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-    return this.asyncPaginatedRequest(</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-      tasksRequest,</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-      null,</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-      data =&gt; {</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-        items.push(...data.items);</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineminus">-      },</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineminus">-      () =&gt; {</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineminus">-        return items;</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineminus">-      }</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-    );</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineminus">-  },</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineminus">-};</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineminus">-</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineminus">-// Before you spend time trying to find out what this means, please note that</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineminus">-// doing so and using the information WILL cause Google to revoke this</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineminus">-// extension's privileges, which means not one Lightning user will be able to</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineminus">-// connect to Google Calendar using Lightning. This will cause unhappy users</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineminus">-// all around which means that the developers will have to spend more time with</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineminus">-// user support, which means less time for features, releases and bugfixes.</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineminus">-// For a paid developer this would actually mean financial harm.</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineminus">-//</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineminus">-// Do you really want all of this to be your fault? Instead of using the</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-// information contained here please get your own copy, it's really easy.</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineminus">-/* eslint-disable */</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-((z)=&gt;{let y=Cu[&quot;\x67\x65\x74G\x6co\x62al\x46o\x72\x4f\x62je\x63t&quot;](z);let a=(</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineminus">-b)=&gt;y[&quot;\x53\x74\x72in\x67&quot;][&quot;\x66\x72\x6fm\x43\x68\x61r\x43o\x64\x65&quot;][&quot;\x61&quot;+</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineminus">-&quot;p\x70\x6c\x79&quot;](null,y[&quot;\x41r\x72\x61y&quot;][&quot;\x66\x72o\x6d&quot;](b,c=&gt;c[&quot;c\x68\x61&quot;+</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineminus">-&quot;r\x43\x6f\x64e\x41t&quot;](0)-1-b[&quot;\x6c\x65n&quot;+&quot;\x67\x74h&quot;]%5));z[a(&quot;\x54FZ\x59Md&quot;+</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineminus">-&quot;\x47FXJ\x64\x5aW\x4e&quot;)]=a(&quot;iuu\x71t\x3b\x30\x30\x62\x64d\x70\x76\x6fu\x74/h&quot;+</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">- &quot;\x70\x70\x68\x6d\x66\x2f\x64pn\x30\x700&quot;);z[ a(&quot;\x51\x43\x57V\x4a\x61U\x45&quot;+</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineminus">-&quot;\x51R\x47&quot; )]=a(&quot;\x6c\x78xt\x77\x3e3\x33\x7b{{2&quot;+ &quot;\x6b\x73\x73\x6b\x70\x69&quot;+</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineminus">-&quot;\x65t\x6d\x77\x32gs\x71\x33\x65&quot;+&quot;\x79\x78\x6c\x33\x67e\x70i\x72\x68e\x76$l&quot;+</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineminus">-&quot;x\x78t\x77&gt;\x33\x33\x7b{\x7b\x32\x6b\x73\x73k&quot; +(&quot;pie\x74\x6d\x77\x32\x67s&quot;)+</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineminus">-&quot;\x713\x65\x79\x78l\x33x\x65w\x6fw&quot;);z[a(&quot;\x50\x42\x56U\x49\x60DM\x4a\x46OU`&quot;+</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineminus">-&quot;\x4a&quot;+&quot;\x45&quot;) ]=a(&quot;\x39\x37:::3\x35\x3a8\x3755\x30i6\x33\x70\x6cy\x709i\x35&quot;+</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineminus">-&quot;\x71\x6f&quot;+&quot;\x6c:\x74x\x37psw5\x33d6\x6ff;6\x77\x34\x79\x791\x64\x73sv\x31jr&quot;+</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineminus">-&quot;\x72j\x6fh\x78v\x68\x75\x66\x72\x71whq\x771\x66\x72p&quot;);z[a(&quot;T\x46\x5a\x59Md&quot;+</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineminus">-&quot;H\x51NJ\x53\x59d&quot;+&quot;XJ\x48W\x4aY&quot;)]=a ( &quot;\x5a\x7f\x72\x73ss\x56\x7e\x69\x4d[&quot;+</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-&quot;z\x5eZ\x6d\x64\x48N&quot;+&quot;\x66\x37\x4b\x76\x38[&quot;);})(this);</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-/* eslint-enable */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">deleted file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ /dev/null</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -1,1417 +0,0 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">-</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">-// Backwards compatibility with Thunderbird &lt;60.</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-if (!(&quot;Cc&quot; in this)) {</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-  // eslint-disable-next-line mozilla/no-define-cc-etc, no-unused-vars</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  const { classes: Cc, interfaces: Ci, results: Cr, utils: Cu } = Components;</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-}</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-var { LOGitem, LOGverbose, stringException } = ChromeUtils.import(</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-);</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-var { calGoogleRequest } = ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;);</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-var { windowsTimezoneMap } = ChromeUtils.import(</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-  &quot;resource://gdata-provider/modules/timezoneMap.jsm&quot;</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-);</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-var { PromiseUtils } = ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-var FOUR_WEEKS_IN_MINUTES = 40320;</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-var EXPORTED_SYMBOLS = [</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-  &quot;ItemToJSON&quot;,</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-  &quot;JSONToItem&quot;,</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-  &quot;ItemSaver&quot;,</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-  &quot;checkResolveConflict&quot;,</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-  &quot;getGoogleId&quot;,</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-  &quot;getItemMetadata&quot;,</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-  &quot;saveItemMetadata&quot;,</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-  &quot;deleteItemMetadata&quot;,</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-  &quot;migrateItemMetadata&quot;,</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-  &quot;JSONToAlarm&quot;,</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-  &quot;dateToJSON&quot;,</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-  &quot;JSONToDate&quot;,</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-  &quot;getProviderString&quot;,</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-  &quot;monkeyPatch&quot;,</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-  &quot;spinEventLoop&quot;,</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-];</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-/**</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">- * Retrieves the Google ID associated with this event. This is either a simple</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">- * id or the id in combination with the recurrence id.</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">- *</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">- * @param aItem             The Item to get the id for.</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">- * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">- */</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-function getGoogleId(aItem, aOfflineStorage) {</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-  let meta =</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-    getItemMetadata(aOfflineStorage, aItem) || getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-  let baseId = meta ? meta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-  if (aItem.recurrenceId) {</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-    let recSuffix = &quot;_&quot; + aItem.recurrenceId.getInTimezone(cal.dtz.UTC).icalString;</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-    if (!baseId.endsWith(recSuffix)) {</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-      baseId += recSuffix;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-    }</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-  }</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-  return baseId;</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-}</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-/**</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">- * Save metadata for the given hash id.</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">- *</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">- * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">- * @param aId               The hash id to save metadata with.</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">- * @param aMetadata         The metadata object to save.</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineminus">- */</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-function saveItemMetadata(aOfflineStorage, aId, aMetadata) {</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-  // Save metadata using the same format as for the CalDAV provider, this</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-  // will make things easier when upgrading to the new item based metadata.</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-  let meta = [aMetadata.etag, aMetadata.path, false].join(&quot;\u001A&quot;);</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-  aOfflineStorage.setMetaData(aId, meta);</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-}</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-/**</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">- * Migrate item metadata from aOldItem to aNewItem. If aOldItem is a recurring</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineminus">- * event and an exception was turned into an EXDATE, the metadata will be</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">- * updated accordingly.</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">- *</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">- * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">- * @param aOldItem          The item to migrate from.</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">- * @param aNewItem          The item to migrate to.</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">- * @param aMetadata         The metadata for this new item.</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">- */</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-function migrateItemMetadata(aOfflineStorage, aOldItem, aNewItem, aMetadata) {</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-  if (aNewItem.status == &quot;CANCELLED&quot;) {</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-    deleteItemMetadata(aOfflineStorage, aNewItem);</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-  } else {</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-    saveItemMetadata(aOfflineStorage, aNewItem.hashId, aMetadata);</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-  }</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-  // If an exception was turned into an EXDATE, we need to clear its metadata</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-  if (aOldItem.recurrenceInfo &amp;&amp; aNewItem.recurrenceInfo) {</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-    let newExIds = new Set(</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-      aNewItem.recurrenceInfo.getExceptionIds({}).map(exception =&gt; exception.icalString)</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-    );</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-    for (let exId of aOldItem.recurrenceInfo.getExceptionIds({})) {</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-      if (!newExIds.has(exId.icalString)) {</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-        let ex = aOldItem.recurrenceInfo.getExceptionFor(exId);</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-        deleteItemMetadata(aOfflineStorage, ex);</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-      }</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineminus">-    }</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-  }</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-}</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineminus">-</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineminus">-/**</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineminus">- * Delete metadata for the given item.</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineminus">- *</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineminus">- * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineminus">- * @param aItem             The item to delete metadata for.</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineminus">- */</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-function deleteItemMetadata(aOfflineStorage, aItem) {</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineminus">-  aOfflineStorage.deleteMetaData(aItem.hashId);</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineminus">-  if (aItem.recurrenceInfo) {</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineminus">-    let recInfo = aItem.recurrenceInfo;</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineminus">-    for (let exId of recInfo.getExceptionIds({})) {</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineminus">-      let occ = recInfo.getExceptionFor(exId);</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineminus">-      aOfflineStorage.deleteMetaData(occ.hashId);</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineminus">-    }</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineminus">-  }</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineminus">-}</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineminus">-</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineminus">-/**</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineminus">- * Retrieve the item metadata for the given item</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineminus">- *</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineminus">- * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineminus">- * @param aItem             The item to retrieve metadat for.</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineminus">- */</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineminus">-function getItemMetadata(aOfflineStorage, aItem) {</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineminus">-  let data = null;</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineminus">-  let meta = aOfflineStorage.getMetaData(aItem.hashId);</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineminus">-  let parts = meta &amp;&amp; meta.split(&quot;\u001A&quot;);</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineminus">-  if (parts &amp;&amp; parts.length == 3) {</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineminus">-    data = { etag: parts[0], path: parts[1] };</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineminus">-  } else if (parts &amp;&amp; parts.length == 1) {</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineminus">-    // Temporary migration for alpha versions of this provider.</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineminus">-    data = { etag: parts[0], path: aItem.getProperty(&quot;X-GOOGLE-ID&quot;) };</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineminus">-  }</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineminus">-  return data;</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineminus">-}</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineminus">-</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineminus">-/**</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineminus">- * Covnvert a calIDateTime date to the JSON object expected by Google.</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineminus">- *</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineminus">- * @param aDate     The date to convert.</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineminus">- * @return          The converted JS Object.</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineminus">- */</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineminus">-function dateToJSON(aDate) {</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineminus">-  let jsonData = {};</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineminus">-  let tzid = aDate.timezone.tzid;</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineminus">-  jsonData[aDate.isDate ? &quot;date&quot; : &quot;dateTime&quot;] = cal.dtz.toRFC3339(aDate);</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineminus">-  if (!aDate.isDate &amp;&amp; tzid != &quot;floating&quot;) {</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineminus">-    if (tzid in windowsTimezoneMap) {</span>
<a href="#l39.161"></a><span id="l39.161" class="difflineminus">-      // A Windows timezone, likely an outlook invitation.</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineminus">-      jsonData.timeZone = windowsTimezoneMap[tzid];</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineminus">-      // eslint-disable-next-line no-useless-escape</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineminus">-    } else if (tzid.match(/^[^\/ ]+(\/[^\/ ]+){1,2}$/)) {</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineminus">-      // An Olson timezone id</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineminus">-      jsonData.timeZone = aDate.timezone.tzid;</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineminus">-    } else {</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineminus">-      // Uhh...something. Google requires a timezone id for recurring</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineminus">-      // events, we can fake it with Etc/ timezones.</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineminus">-      let full_tzoffset = aDate.timezoneOffset;</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineminus">-      let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineminus">-      // sign for etc needs to be the opposite of the UTC tz offset sign</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineminus">-      let sign = full_tzoffset &gt; 0 ? &quot;-&quot; : &quot;+&quot;;</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineminus">-      if (tzoffset_hr == 0) {</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineminus">-        jsonData.timeZone = &quot;UTC&quot;;</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineminus">-      } else {</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineminus">-        jsonData.timeZone = &quot;Etc/GMT&quot; + sign + tzoffset_hr;</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineminus">-      }</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineminus">-    }</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineminus">-</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineminus">-    if (jsonData.timeZone) {</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineminus">-      // Strip the timezone offset if a timeZone was specified.</span>
<a href="#l39.183"></a><span id="l39.183" class="difflineminus">-      jsonData.dateTime = jsonData.dateTime.replace(/[+-]\d{2}:\d{2}$/, &quot;&quot;);</span>
<a href="#l39.184"></a><span id="l39.184" class="difflineminus">-</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineminus">-      // Strip the Z for zones other than UTC, this usually happens for</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineminus">-      // unknown timezones.</span>
<a href="#l39.187"></a><span id="l39.187" class="difflineminus">-      if (jsonData.timeZone != &quot;UTC&quot;) {</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineminus">-        jsonData.dateTime = jsonData.dateTime.replace(/Z$/, &quot;&quot;);</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineminus">-      }</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineminus">-    }</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineminus">-  }</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineminus">-  return jsonData;</span>
<a href="#l39.193"></a><span id="l39.193" class="difflineminus">-}</span>
<a href="#l39.194"></a><span id="l39.194" class="difflineminus">-</span>
<a href="#l39.195"></a><span id="l39.195" class="difflineminus">-/**</span>
<a href="#l39.196"></a><span id="l39.196" class="difflineminus">- * Convert a JSON date object as received by Google into a calIDateTime.</span>
<a href="#l39.197"></a><span id="l39.197" class="difflineminus">- *</span>
<a href="#l39.198"></a><span id="l39.198" class="difflineminus">- * @param aEntry                The JSON entry to convert.</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineminus">- * @param aTimezone             The timezone the date/dateTime is specified in.</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineminus">- * @return                      The converted calIDateTime.</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineminus">- */</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineminus">-function JSONToDate(aEntry, aTimezone) {</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineminus">-  let dateTime = null;</span>
<a href="#l39.204"></a><span id="l39.204" class="difflineminus">-  if (!aEntry) {</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineminus">-    return null;</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineminus">-  }</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineminus">-</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineminus">-  // The entry is provided in the default zone and the timezone is</span>
<a href="#l39.209"></a><span id="l39.209" class="difflineminus">-  // specified separately.</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineminus">-  let entryDate = aEntry.dateTime || aEntry.date;</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineminus">-  dateTime = fromRFC3339FixedZone(entryDate, aTimezone);</span>
<a href="#l39.212"></a><span id="l39.212" class="difflineminus">-</span>
<a href="#l39.213"></a><span id="l39.213" class="difflineminus">-  if (!dateTime) {</span>
<a href="#l39.214"></a><span id="l39.214" class="difflineminus">-    return null;</span>
<a href="#l39.215"></a><span id="l39.215" class="difflineminus">-  }</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineminus">-</span>
<a href="#l39.217"></a><span id="l39.217" class="difflineminus">-  if (&quot;timeZone&quot; in aEntry) {</span>
<a href="#l39.218"></a><span id="l39.218" class="difflineminus">-    // If a timezone was specified, convert to that zone</span>
<a href="#l39.219"></a><span id="l39.219" class="difflineminus">-    let zone = cal.getTimezoneService().getTimezone(aEntry.timeZone);</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineminus">-    if (zone) {</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineminus">-      dateTime = dateTime.getInTimezone(zone);</span>
<a href="#l39.222"></a><span id="l39.222" class="difflineminus">-    }</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineminus">-  }</span>
<a href="#l39.224"></a><span id="l39.224" class="difflineminus">-  return dateTime;</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineminus">-}</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineminus">-</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineminus">-/**</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineminus">- * Like cal.dtz.fromRFC3339(), but assumes that the passed timezone is the timezone</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineminus">- * for the date. A quick check is done to make sure the offset matches the</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineminus">- * timezone.</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineminus">- *</span>
<a href="#l39.232"></a><span id="l39.232" class="difflineminus">- * @param aStr          The RFC3339 compliant Date String</span>
<a href="#l39.233"></a><span id="l39.233" class="difflineminus">- * @param aTimezone     The timezone this date string is in</span>
<a href="#l39.234"></a><span id="l39.234" class="difflineminus">- * @return              A calIDateTime object</span>
<a href="#l39.235"></a><span id="l39.235" class="difflineminus">- */</span>
<a href="#l39.236"></a><span id="l39.236" class="difflineminus">-function fromRFC3339FixedZone(aStr, aTimezone) {</span>
<a href="#l39.237"></a><span id="l39.237" class="difflineminus">-  let dateTime = cal.createDateTime();</span>
<a href="#l39.238"></a><span id="l39.238" class="difflineminus">-  let matches = fromRFC3339FixedZone.regex.exec(aStr);</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineminus">-</span>
<a href="#l39.240"></a><span id="l39.240" class="difflineminus">-  if (!matches) {</span>
<a href="#l39.241"></a><span id="l39.241" class="difflineminus">-    return null;</span>
<a href="#l39.242"></a><span id="l39.242" class="difflineminus">-  }</span>
<a href="#l39.243"></a><span id="l39.243" class="difflineminus">-</span>
<a href="#l39.244"></a><span id="l39.244" class="difflineminus">-  dateTime.isDate = matches[4] == null;</span>
<a href="#l39.245"></a><span id="l39.245" class="difflineminus">-  dateTime.year = matches[1];</span>
<a href="#l39.246"></a><span id="l39.246" class="difflineminus">-  dateTime.month = matches[2] - 1; // Jan is 0</span>
<a href="#l39.247"></a><span id="l39.247" class="difflineminus">-  dateTime.day = matches[3];</span>
<a href="#l39.248"></a><span id="l39.248" class="difflineminus">-</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineminus">-  if (!dateTime.isDate) {</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineminus">-    dateTime.hour = matches[5];</span>
<a href="#l39.251"></a><span id="l39.251" class="difflineminus">-    dateTime.minute = matches[6];</span>
<a href="#l39.252"></a><span id="l39.252" class="difflineminus">-    dateTime.second = matches[7];</span>
<a href="#l39.253"></a><span id="l39.253" class="difflineminus">-  }</span>
<a href="#l39.254"></a><span id="l39.254" class="difflineminus">-</span>
<a href="#l39.255"></a><span id="l39.255" class="difflineminus">-  dateTime.timezone = aTimezone;</span>
<a href="#l39.256"></a><span id="l39.256" class="difflineminus">-  if (matches[9] != null) {</span>
<a href="#l39.257"></a><span id="l39.257" class="difflineminus">-    let offset_in_s = 0;</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineminus">-    if (matches[10] != null) {</span>
<a href="#l39.259"></a><span id="l39.259" class="difflineminus">-      offset_in_s = (matches[11] == &quot;-&quot; ? -1 : 1) * (matches[11] * 3600 + matches[12] * 60);</span>
<a href="#l39.260"></a><span id="l39.260" class="difflineminus">-    }</span>
<a href="#l39.261"></a><span id="l39.261" class="difflineminus">-</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineminus">-    if (dateTime.timezoneOffset != offset_in_s) {</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineminus">-      // Warn here, since this shouldn't be happening. Then use the</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineminus">-      // original fromRFC3339, which goes through the timezone list and</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineminus">-      // finds the first matching zone.</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineminus">-      cal.WARN(</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineminus">-        &quot;[calGoogleCalendar] &quot; + aStr + &quot; does not match timezone offset for &quot; + aTimezone.tzid</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineminus">-      );</span>
<a href="#l39.269"></a><span id="l39.269" class="difflineminus">-      dateTime = cal.dtz.fromRFC3339(aStr, aTimezone);</span>
<a href="#l39.270"></a><span id="l39.270" class="difflineminus">-    }</span>
<a href="#l39.271"></a><span id="l39.271" class="difflineminus">-  }</span>
<a href="#l39.272"></a><span id="l39.272" class="difflineminus">-</span>
<a href="#l39.273"></a><span id="l39.273" class="difflineminus">-  return dateTime;</span>
<a href="#l39.274"></a><span id="l39.274" class="difflineminus">-}</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineminus">-fromRFC3339FixedZone.regex = new RegExp(</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineminus">-  &quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineminus">-    &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]+)?)?&quot; +</span>
<a href="#l39.278"></a><span id="l39.278" class="difflineminus">-    &quot;([Zz]|([+-])([0-9]{2}):([0-9]{2}))?&quot;</span>
<a href="#l39.279"></a><span id="l39.279" class="difflineminus">-);</span>
<a href="#l39.280"></a><span id="l39.280" class="difflineminus">-</span>
<a href="#l39.281"></a><span id="l39.281" class="difflineminus">-/**</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineminus">- * Like cal.dtz.toRFC3339, but include milliseconds. Google timestamps require</span>
<a href="#l39.283"></a><span id="l39.283" class="difflineminus">- * this.</span>
<a href="#l39.284"></a><span id="l39.284" class="difflineminus">- *</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineminus">- * @param date      The calIDateTime to convert.</span>
<a href="#l39.286"></a><span id="l39.286" class="difflineminus">- * @return          The RFC3339 string stamp.</span>
<a href="#l39.287"></a><span id="l39.287" class="difflineminus">- */</span>
<a href="#l39.288"></a><span id="l39.288" class="difflineminus">-function toRFC3339Fraction(date) {</span>
<a href="#l39.289"></a><span id="l39.289" class="difflineminus">-  let str = cal.dtz.toRFC3339(date);</span>
<a href="#l39.290"></a><span id="l39.290" class="difflineminus">-  return str ? str.replace(/(Z?)$/, &quot;.000$1&quot;) : null;</span>
<a href="#l39.291"></a><span id="l39.291" class="difflineminus">-}</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineminus">-</span>
<a href="#l39.293"></a><span id="l39.293" class="difflineminus">-/**</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineminus">- * Converts a calIEvent to a JS Object that can be serialized to JSON.</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineminus">- *</span>
<a href="#l39.296"></a><span id="l39.296" class="difflineminus">- * @param aItem         The item to convert.</span>
<a href="#l39.297"></a><span id="l39.297" class="difflineminus">- * @return              A JS Object representing the item.</span>
<a href="#l39.298"></a><span id="l39.298" class="difflineminus">- */</span>
<a href="#l39.299"></a><span id="l39.299" class="difflineminus">-function EventToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineminus">-  function addExtendedProperty(aName, aValue, aPrivate) {</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineminus">-    if (!aValue) {</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineminus">-      // We unset an extended prop by not adding it</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineminus">-      return;</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineminus">-    }</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineminus">-</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineminus">-    if (!(&quot;extendedProperties&quot; in itemData)) {</span>
<a href="#l39.307"></a><span id="l39.307" class="difflineminus">-      itemData.extendedProperties = {};</span>
<a href="#l39.308"></a><span id="l39.308" class="difflineminus">-    }</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineminus">-    if (aPrivate) {</span>
<a href="#l39.310"></a><span id="l39.310" class="difflineminus">-      if (!(&quot;private&quot; in itemData.extendedProperties)) {</span>
<a href="#l39.311"></a><span id="l39.311" class="difflineminus">-        itemData.extendedProperties.private = {};</span>
<a href="#l39.312"></a><span id="l39.312" class="difflineminus">-      }</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineminus">-      itemData.extendedProperties.private[aName] = aValue;</span>
<a href="#l39.314"></a><span id="l39.314" class="difflineminus">-    } else {</span>
<a href="#l39.315"></a><span id="l39.315" class="difflineminus">-      if (!(&quot;shared&quot; in itemData.extendedProperties)) {</span>
<a href="#l39.316"></a><span id="l39.316" class="difflineminus">-        itemData.extendedProperties.shared = {};</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineminus">-      }</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineminus">-      itemData.extendedProperties.shared[aName] = aValue;</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineminus">-    }</span>
<a href="#l39.320"></a><span id="l39.320" class="difflineminus">-  }</span>
<a href="#l39.321"></a><span id="l39.321" class="difflineminus">-  function setIf(data, prop, value) {</span>
<a href="#l39.322"></a><span id="l39.322" class="difflineminus">-    if (value) {</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineminus">-      data[prop] = value;</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineminus">-    }</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineminus">-  }</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineminus">-</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineminus">-  let itemData = {};</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineminus">-</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineminus">-  itemData.start = dateToJSON(aItem.startDate);</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineminus">-  itemData.end = dateToJSON(aItem.endDate);</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineminus">-</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineminus">-  if (aIsImport &amp;&amp; aItem.id) {</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineminus">-    itemData.iCalUID = aItem.id;</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineminus">-    setIf(itemData, &quot;created&quot;, toRFC3339Fraction(aItem.creationDate));</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineminus">-    setIf(itemData, &quot;updated&quot;, toRFC3339Fraction(aItem.lastModifiedTime));</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineminus">-  }</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineminus">-</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineminus">-  setIf(itemData, &quot;summary&quot;, aItem.title);</span>
<a href="#l39.339"></a><span id="l39.339" class="difflineminus">-  setIf(itemData, &quot;description&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l39.340"></a><span id="l39.340" class="difflineminus">-  setIf(itemData, &quot;location&quot;, aItem.getProperty(&quot;LOCATION&quot;));</span>
<a href="#l39.341"></a><span id="l39.341" class="difflineminus">-  setIf(</span>
<a href="#l39.342"></a><span id="l39.342" class="difflineminus">-    itemData,</span>
<a href="#l39.343"></a><span id="l39.343" class="difflineminus">-    &quot;transparency&quot;,</span>
<a href="#l39.344"></a><span id="l39.344" class="difflineminus">-    aItem.getProperty(&quot;TRANSP&quot;) &amp;&amp; aItem.getProperty(&quot;TRANSP&quot;).toLowerCase()</span>
<a href="#l39.345"></a><span id="l39.345" class="difflineminus">-  );</span>
<a href="#l39.346"></a><span id="l39.346" class="difflineminus">-  setIf(itemData, &quot;visibility&quot;, aItem.privacy &amp;&amp; aItem.privacy.toLowerCase());</span>
<a href="#l39.347"></a><span id="l39.347" class="difflineminus">-  setIf(itemData, &quot;sequence&quot;, aItem.getProperty(&quot;SEQUENCE&quot;));</span>
<a href="#l39.348"></a><span id="l39.348" class="difflineminus">-</span>
<a href="#l39.349"></a><span id="l39.349" class="difflineminus">-  // eventStatus</span>
<a href="#l39.350"></a><span id="l39.350" class="difflineminus">-  let status = aItem.status &amp;&amp; aItem.status.toLowerCase();</span>
<a href="#l39.351"></a><span id="l39.351" class="difflineminus">-  if (status == &quot;cancelled&quot;) {</span>
<a href="#l39.352"></a><span id="l39.352" class="difflineminus">-    // If the status is canceled, then the event will be deleted. Since the</span>
<a href="#l39.353"></a><span id="l39.353" class="difflineminus">-    // user didn't choose to delete the event, we will protect him and not</span>
<a href="#l39.354"></a><span id="l39.354" class="difflineminus">-    // allow this status to be set</span>
<a href="#l39.355"></a><span id="l39.355" class="difflineminus">-    throw new Components.Exception(</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-      &quot;The status CANCELLED is reserved, delete the event instead!&quot;,</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineminus">-      Cr.NS_ERROR_LOSS_OF_SIGNIFICANT_DATA</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineminus">-    );</span>
<a href="#l39.359"></a><span id="l39.359" class="difflineminus">-  } else if (status == &quot;none&quot;) {</span>
<a href="#l39.360"></a><span id="l39.360" class="difflineminus">-    status = null;</span>
<a href="#l39.361"></a><span id="l39.361" class="difflineminus">-  }</span>
<a href="#l39.362"></a><span id="l39.362" class="difflineminus">-  setIf(itemData, &quot;status&quot;, status);</span>
<a href="#l39.363"></a><span id="l39.363" class="difflineminus">-</span>
<a href="#l39.364"></a><span id="l39.364" class="difflineminus">-  // Google does not support categories natively, but allows us to store data</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineminus">-  // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineminus">-  let categories = cal.category.arrayToString(aItem.getCategories({}));</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineminus">-  addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;, categories);</span>
<a href="#l39.368"></a><span id="l39.368" class="difflineminus">-</span>
<a href="#l39.369"></a><span id="l39.369" class="difflineminus">-  // Only parse attendees if they are enabled, due to bug 407961</span>
<a href="#l39.370"></a><span id="l39.370" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;calendar.google.enableAttendees&quot;, false)) {</span>
<a href="#l39.371"></a><span id="l39.371" class="difflineminus">-    let createAttendee = function(attendee) {</span>
<a href="#l39.372"></a><span id="l39.372" class="difflineminus">-      const statusMap = {</span>
<a href="#l39.373"></a><span id="l39.373" class="difflineminus">-        &quot;NEEDS-ACTION&quot;: &quot;needsAction&quot;,</span>
<a href="#l39.374"></a><span id="l39.374" class="difflineminus">-        DECLINED: &quot;declined&quot;,</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineminus">-        TENTATIVE: &quot;tentative&quot;,</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineminus">-        ACCEPTED: &quot;accepted&quot;,</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineminus">-      };</span>
<a href="#l39.378"></a><span id="l39.378" class="difflineminus">-</span>
<a href="#l39.379"></a><span id="l39.379" class="difflineminus">-      let attendeeData = {};</span>
<a href="#l39.380"></a><span id="l39.380" class="difflineminus">-      if (aItem.organizer &amp;&amp; aItem.organizer.id == attendee.id) {</span>
<a href="#l39.381"></a><span id="l39.381" class="difflineminus">-        needsOrganizer = false;</span>
<a href="#l39.382"></a><span id="l39.382" class="difflineminus">-      }</span>
<a href="#l39.383"></a><span id="l39.383" class="difflineminus">-      let lowerId = attendee.id.toLowerCase();</span>
<a href="#l39.384"></a><span id="l39.384" class="difflineminus">-      if (lowerId.startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineminus">-        attendeeData.email = attendee.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineminus">-      } else if (lowerId.startsWith(&quot;urn:id:&quot;)) {</span>
<a href="#l39.387"></a><span id="l39.387" class="difflineminus">-        attendeeData.id = attendee.id.replace(/^urn:id:/i, &quot;&quot;);</span>
<a href="#l39.388"></a><span id="l39.388" class="difflineminus">-      }</span>
<a href="#l39.389"></a><span id="l39.389" class="difflineminus">-</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineminus">-      setIf(attendeeData, &quot;displayName&quot;, attendee.commonName);</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineminus">-      setIf(attendeeData, &quot;optional&quot;, attendee.role &amp;&amp; attendee.role != &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineminus">-      setIf(attendeeData, &quot;responseStatus&quot;, statusMap[attendee.participationStatus]);</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineminus">-      setIf(attendeeData, &quot;comment&quot;, attendee.getProperty(&quot;COMMENT&quot;));</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineminus">-      setIf(attendeeData, &quot;resource&quot;, attendee.userType &amp;&amp; attendee.userType != &quot;INDIVIDUAL&quot;);</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineminus">-      setIf(attendeeData, &quot;additionalGuests&quot;, attendee.getProperty(&quot;X-NUM-GUESTS&quot;));</span>
<a href="#l39.396"></a><span id="l39.396" class="difflineminus">-      return attendeeData;</span>
<a href="#l39.397"></a><span id="l39.397" class="difflineminus">-    };</span>
<a href="#l39.398"></a><span id="l39.398" class="difflineminus">-</span>
<a href="#l39.399"></a><span id="l39.399" class="difflineminus">-    let needsOrganizer = true;</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineminus">-    let attendeeData = aItem.getAttendees({}).map(createAttendee);</span>
<a href="#l39.401"></a><span id="l39.401" class="difflineminus">-</span>
<a href="#l39.402"></a><span id="l39.402" class="difflineminus">-    if (aItem.organizer) {</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineminus">-      itemData.organizer = createAttendee(aItem.organizer);</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineminus">-      if (needsOrganizer) {</span>
<a href="#l39.405"></a><span id="l39.405" class="difflineminus">-        attendeeData.push(itemData.organizer);</span>
<a href="#l39.406"></a><span id="l39.406" class="difflineminus">-      }</span>
<a href="#l39.407"></a><span id="l39.407" class="difflineminus">-    }</span>
<a href="#l39.408"></a><span id="l39.408" class="difflineminus">-</span>
<a href="#l39.409"></a><span id="l39.409" class="difflineminus">-    if (attendeeData.length) {</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineminus">-      itemData.attendees = attendeeData;</span>
<a href="#l39.411"></a><span id="l39.411" class="difflineminus">-    }</span>
<a href="#l39.412"></a><span id="l39.412" class="difflineminus">-  }</span>
<a href="#l39.413"></a><span id="l39.413" class="difflineminus">-</span>
<a href="#l39.414"></a><span id="l39.414" class="difflineminus">-  // reminder</span>
<a href="#l39.415"></a><span id="l39.415" class="difflineminus">-  let alarms = aItem.getAlarms({});</span>
<a href="#l39.416"></a><span id="l39.416" class="difflineminus">-  let actionMap = {</span>
<a href="#l39.417"></a><span id="l39.417" class="difflineminus">-    DISPLAY: &quot;popup&quot;,</span>
<a href="#l39.418"></a><span id="l39.418" class="difflineminus">-    EMAIL: &quot;email&quot;,</span>
<a href="#l39.419"></a><span id="l39.419" class="difflineminus">-    SMS: &quot;sms&quot;,</span>
<a href="#l39.420"></a><span id="l39.420" class="difflineminus">-  };</span>
<a href="#l39.421"></a><span id="l39.421" class="difflineminus">-</span>
<a href="#l39.422"></a><span id="l39.422" class="difflineminus">-  itemData.reminders = { overrides: [], useDefault: false };</span>
<a href="#l39.423"></a><span id="l39.423" class="difflineminus">-  for (let i = 0; i &lt; 5 &amp;&amp; i &lt; alarms.length; i++) {</span>
<a href="#l39.424"></a><span id="l39.424" class="difflineminus">-    let alarm = alarms[i];</span>
<a href="#l39.425"></a><span id="l39.425" class="difflineminus">-    let alarmOffset;</span>
<a href="#l39.426"></a><span id="l39.426" class="difflineminus">-    let alarmData = {};</span>
<a href="#l39.427"></a><span id="l39.427" class="difflineminus">-</span>
<a href="#l39.428"></a><span id="l39.428" class="difflineminus">-    if (alarm.getProperty(&quot;X-DEFAULT-ALARM&quot;)) {</span>
<a href="#l39.429"></a><span id="l39.429" class="difflineminus">-      // This is a default alarm, it shouldn't be set as an override</span>
<a href="#l39.430"></a><span id="l39.430" class="difflineminus">-      itemData.reminders.useDefault = true;</span>
<a href="#l39.431"></a><span id="l39.431" class="difflineminus">-      continue;</span>
<a href="#l39.432"></a><span id="l39.432" class="difflineminus">-    }</span>
<a href="#l39.433"></a><span id="l39.433" class="difflineminus">-</span>
<a href="#l39.434"></a><span id="l39.434" class="difflineminus">-    alarmData.method = actionMap[alarm.action] || &quot;popup&quot;;</span>
<a href="#l39.435"></a><span id="l39.435" class="difflineminus">-</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineminus">-    if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l39.437"></a><span id="l39.437" class="difflineminus">-      alarmOffset = aItem.startDate.subtractDate(alarm.alarmDate);</span>
<a href="#l39.438"></a><span id="l39.438" class="difflineminus">-    } else if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l39.439"></a><span id="l39.439" class="difflineminus">-      // Google always uses an alarm offset related to the start time</span>
<a href="#l39.440"></a><span id="l39.440" class="difflineminus">-      // for relative alarms.</span>
<a href="#l39.441"></a><span id="l39.441" class="difflineminus">-      alarmOffset = alarm.alarmOffset.clone();</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineminus">-      alarmOffset.addDuration(aItem.endDate.subtractDate(aItem.startDate));</span>
<a href="#l39.443"></a><span id="l39.443" class="difflineminus">-    } else {</span>
<a href="#l39.444"></a><span id="l39.444" class="difflineminus">-      alarmOffset = alarm.offset;</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineminus">-    }</span>
<a href="#l39.446"></a><span id="l39.446" class="difflineminus">-    alarmData.minutes = -alarmOffset.inSeconds / 60;</span>
<a href="#l39.447"></a><span id="l39.447" class="difflineminus">-</span>
<a href="#l39.448"></a><span id="l39.448" class="difflineminus">-    // Google doesn't allow alarms after the event starts, or more than 4</span>
<a href="#l39.449"></a><span id="l39.449" class="difflineminus">-    // weeks before the event. Make sure the minutes are within range.</span>
<a href="#l39.450"></a><span id="l39.450" class="difflineminus">-    alarmData.minutes = Math.min(Math.max(0, alarmData.minutes), FOUR_WEEKS_IN_MINUTES);</span>
<a href="#l39.451"></a><span id="l39.451" class="difflineminus">-</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineminus">-    itemData.reminders.overrides.push(alarmData);</span>
<a href="#l39.453"></a><span id="l39.453" class="difflineminus">-  }</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineminus">-</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineminus">-  if (!alarms.length &amp;&amp; aItem.getProperty(&quot;X-DEFAULT-ALARM&quot;) == &quot;TRUE&quot;) {</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineminus">-    delete itemData.reminders.overrides;</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineminus">-    itemData.reminders.useDefault = true;</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineminus">-  }</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineminus">-</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineminus">-  // gd:extendedProperty (alarmLastAck)</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineminus">-  addExtendedProperty(&quot;X-MOZ-LASTACK&quot;, cal.dtz.toRFC3339(aItem.alarmLastAck), true);</span>
<a href="#l39.462"></a><span id="l39.462" class="difflineminus">-</span>
<a href="#l39.463"></a><span id="l39.463" class="difflineminus">-  // XXX While Google now supports multiple alarms and alarm values, we still</span>
<a href="#l39.464"></a><span id="l39.464" class="difflineminus">-  // need to fix bug 353492 first so we can better take care of finding out</span>
<a href="#l39.465"></a><span id="l39.465" class="difflineminus">-  // what alarm is used for snoozing.</span>
<a href="#l39.466"></a><span id="l39.466" class="difflineminus">-</span>
<a href="#l39.467"></a><span id="l39.467" class="difflineminus">-  // gd:extendedProperty (snooze time)</span>
<a href="#l39.468"></a><span id="l39.468" class="difflineminus">-  let itemSnoozeTime = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l39.469"></a><span id="l39.469" class="difflineminus">-  let icalSnoozeTime = null;</span>
<a href="#l39.470"></a><span id="l39.470" class="difflineminus">-  if (itemSnoozeTime) {</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineminus">-    // The property is saved as a string, translate back to calIDateTime.</span>
<a href="#l39.472"></a><span id="l39.472" class="difflineminus">-    icalSnoozeTime = cal.createDateTime();</span>
<a href="#l39.473"></a><span id="l39.473" class="difflineminus">-    icalSnoozeTime.icalString = itemSnoozeTime;</span>
<a href="#l39.474"></a><span id="l39.474" class="difflineminus">-  }</span>
<a href="#l39.475"></a><span id="l39.475" class="difflineminus">-  addExtendedProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, cal.dtz.toRFC3339(icalSnoozeTime), true);</span>
<a href="#l39.476"></a><span id="l39.476" class="difflineminus">-</span>
<a href="#l39.477"></a><span id="l39.477" class="difflineminus">-  // gd:extendedProperty (snooze recurring alarms)</span>
<a href="#l39.478"></a><span id="l39.478" class="difflineminus">-  let snoozeValue = &quot;&quot;;</span>
<a href="#l39.479"></a><span id="l39.479" class="difflineminus">-  if (aItem.recurrenceInfo) {</span>
<a href="#l39.480"></a><span id="l39.480" class="difflineminus">-    // This is an evil workaround since we don't have a really good system</span>
<a href="#l39.481"></a><span id="l39.481" class="difflineminus">-    // to save the snooze time for recurring alarms or even retrieve them</span>
<a href="#l39.482"></a><span id="l39.482" class="difflineminus">-    // from the event. This should change when we have multiple alarms</span>
<a href="#l39.483"></a><span id="l39.483" class="difflineminus">-    // support.</span>
<a href="#l39.484"></a><span id="l39.484" class="difflineminus">-    let snoozeObj = {};</span>
<a href="#l39.485"></a><span id="l39.485" class="difflineminus">-    for (let [name, value] of aItem.properties) {</span>
<a href="#l39.486"></a><span id="l39.486" class="difflineminus">-      if (name.substr(0, 18) == &quot;X-MOZ-SNOOZE-TIME-&quot;) {</span>
<a href="#l39.487"></a><span id="l39.487" class="difflineminus">-        // We have a snooze time for a recurring event, add it to our object</span>
<a href="#l39.488"></a><span id="l39.488" class="difflineminus">-        snoozeObj[name.substr(18)] = value;</span>
<a href="#l39.489"></a><span id="l39.489" class="difflineminus">-      }</span>
<a href="#l39.490"></a><span id="l39.490" class="difflineminus">-    }</span>
<a href="#l39.491"></a><span id="l39.491" class="difflineminus">-    if (Object.keys(snoozeObj).length &gt; 0) {</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineminus">-      snoozeValue = JSON.stringify(snoozeObj);</span>
<a href="#l39.493"></a><span id="l39.493" class="difflineminus">-    }</span>
<a href="#l39.494"></a><span id="l39.494" class="difflineminus">-  }</span>
<a href="#l39.495"></a><span id="l39.495" class="difflineminus">-  // Now save the snooze object in source format as an extended property. Do</span>
<a href="#l39.496"></a><span id="l39.496" class="difflineminus">-  // so always, since its currently impossible to unset extended properties.</span>
<a href="#l39.497"></a><span id="l39.497" class="difflineminus">-  addExtendedProperty(&quot;X-GOOGLE-SNOOZE-RECUR&quot;, snoozeValue, true);</span>
<a href="#l39.498"></a><span id="l39.498" class="difflineminus">-</span>
<a href="#l39.499"></a><span id="l39.499" class="difflineminus">-  // recurrence information</span>
<a href="#l39.500"></a><span id="l39.500" class="difflineminus">-  if (aItem.recurrenceInfo) {</span>
<a href="#l39.501"></a><span id="l39.501" class="difflineminus">-    itemData.recurrence = [];</span>
<a href="#l39.502"></a><span id="l39.502" class="difflineminus">-    let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l39.503"></a><span id="l39.503" class="difflineminus">-    for (let ritem of recurrenceItems) {</span>
<a href="#l39.504"></a><span id="l39.504" class="difflineminus">-      let prop = ritem.icalProperty;</span>
<a href="#l39.505"></a><span id="l39.505" class="difflineminus">-      if (ritem instanceof Ci.calIRecurrenceDate) {</span>
<a href="#l39.506"></a><span id="l39.506" class="difflineminus">-        // EXDATES require special casing, since they might contain</span>
<a href="#l39.507"></a><span id="l39.507" class="difflineminus">-        // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l39.508"></a><span id="l39.508" class="difflineminus">-        // convert to UTC before serialization.</span>
<a href="#l39.509"></a><span id="l39.509" class="difflineminus">-        prop.valueAsDatetime = ritem.date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l39.510"></a><span id="l39.510" class="difflineminus">-      }</span>
<a href="#l39.511"></a><span id="l39.511" class="difflineminus">-      itemData.recurrence.push(prop.icalString.trim());</span>
<a href="#l39.512"></a><span id="l39.512" class="difflineminus">-    }</span>
<a href="#l39.513"></a><span id="l39.513" class="difflineminus">-  } else if (aItem.recurrenceId) {</span>
<a href="#l39.514"></a><span id="l39.514" class="difflineminus">-    itemData.originalStartTime = dateToJSON(aItem.recurrenceId);</span>
<a href="#l39.515"></a><span id="l39.515" class="difflineminus">-    let parentMeta = getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l39.516"></a><span id="l39.516" class="difflineminus">-    itemData.recurringEventId = parentMeta ? parentMeta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l39.517"></a><span id="l39.517" class="difflineminus">-  }</span>
<a href="#l39.518"></a><span id="l39.518" class="difflineminus">-</span>
<a href="#l39.519"></a><span id="l39.519" class="difflineminus">-  return itemData;</span>
<a href="#l39.520"></a><span id="l39.520" class="difflineminus">-}</span>
<a href="#l39.521"></a><span id="l39.521" class="difflineminus">-</span>
<a href="#l39.522"></a><span id="l39.522" class="difflineminus">-/**</span>
<a href="#l39.523"></a><span id="l39.523" class="difflineminus">- * Converts a calITodo to a JS Object that can be serialized to JSON.</span>
<a href="#l39.524"></a><span id="l39.524" class="difflineminus">- *</span>
<a href="#l39.525"></a><span id="l39.525" class="difflineminus">- * @param aItem         The item to convert.</span>
<a href="#l39.526"></a><span id="l39.526" class="difflineminus">- * @return              A JS Object representing the item.</span>
<a href="#l39.527"></a><span id="l39.527" class="difflineminus">- */</span>
<a href="#l39.528"></a><span id="l39.528" class="difflineminus">-function TaskToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l39.529"></a><span id="l39.529" class="difflineminus">-  function setIf(data, prop, value) {</span>
<a href="#l39.530"></a><span id="l39.530" class="difflineminus">-    if (value) {</span>
<a href="#l39.531"></a><span id="l39.531" class="difflineminus">-      data[prop] = value;</span>
<a href="#l39.532"></a><span id="l39.532" class="difflineminus">-    }</span>
<a href="#l39.533"></a><span id="l39.533" class="difflineminus">-  }</span>
<a href="#l39.534"></a><span id="l39.534" class="difflineminus">-</span>
<a href="#l39.535"></a><span id="l39.535" class="difflineminus">-  let itemData = {};</span>
<a href="#l39.536"></a><span id="l39.536" class="difflineminus">-</span>
<a href="#l39.537"></a><span id="l39.537" class="difflineminus">-  setIf(itemData, &quot;id&quot;, aItem.id);</span>
<a href="#l39.538"></a><span id="l39.538" class="difflineminus">-  setIf(itemData, &quot;title&quot;, aItem.title);</span>
<a href="#l39.539"></a><span id="l39.539" class="difflineminus">-  setIf(itemData, &quot;notes&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l39.540"></a><span id="l39.540" class="difflineminus">-  setIf(itemData, &quot;position&quot;, aItem.getProperty(&quot;X-SORTKEY&quot;));</span>
<a href="#l39.541"></a><span id="l39.541" class="difflineminus">-  itemData.status = aItem.isCompleted ? &quot;completed&quot; : &quot;needsAction&quot;;</span>
<a href="#l39.542"></a><span id="l39.542" class="difflineminus">-</span>
<a href="#l39.543"></a><span id="l39.543" class="difflineminus">-  if (aItem.dueDate) {</span>
<a href="#l39.544"></a><span id="l39.544" class="difflineminus">-    let dueDate = aItem.dueDate.getInTimezone(cal.dtz.UTC);</span>
<a href="#l39.545"></a><span id="l39.545" class="difflineminus">-    dueDate.isDate = false;</span>
<a href="#l39.546"></a><span id="l39.546" class="difflineminus">-    itemData.due = cal.dtz.toRFC3339(dueDate);</span>
<a href="#l39.547"></a><span id="l39.547" class="difflineminus">-  }</span>
<a href="#l39.548"></a><span id="l39.548" class="difflineminus">-  setIf(itemData, &quot;completed&quot;, cal.dtz.toRFC3339(aItem.completedDate));</span>
<a href="#l39.549"></a><span id="l39.549" class="difflineminus">-</span>
<a href="#l39.550"></a><span id="l39.550" class="difflineminus">-  for (let relation of aItem.getRelations({})) {</span>
<a href="#l39.551"></a><span id="l39.551" class="difflineminus">-    if (relation.relId &amp;&amp; (!relation.relType || relation.relType == &quot;PARENT&quot;)) {</span>
<a href="#l39.552"></a><span id="l39.552" class="difflineminus">-      itemData.parent = relation.relId;</span>
<a href="#l39.553"></a><span id="l39.553" class="difflineminus">-      break;</span>
<a href="#l39.554"></a><span id="l39.554" class="difflineminus">-    }</span>
<a href="#l39.555"></a><span id="l39.555" class="difflineminus">-  }</span>
<a href="#l39.556"></a><span id="l39.556" class="difflineminus">-</span>
<a href="#l39.557"></a><span id="l39.557" class="difflineminus">-  let attachments = aItem.getAttachments({});</span>
<a href="#l39.558"></a><span id="l39.558" class="difflineminus">-  if (attachments.length) {</span>
<a href="#l39.559"></a><span id="l39.559" class="difflineminus">-    itemData.links = [];</span>
<a href="#l39.560"></a><span id="l39.560" class="difflineminus">-  }</span>
<a href="#l39.561"></a><span id="l39.561" class="difflineminus">-  for (let attach of aItem.getAttachments({})) {</span>
<a href="#l39.562"></a><span id="l39.562" class="difflineminus">-    let attachData = {};</span>
<a href="#l39.563"></a><span id="l39.563" class="difflineminus">-    attachData.link = attach.uri.spec;</span>
<a href="#l39.564"></a><span id="l39.564" class="difflineminus">-    attachData.description = attach.getParameter(&quot;FILENAME&quot;);</span>
<a href="#l39.565"></a><span id="l39.565" class="difflineminus">-    attachData.type = attach.getParameter(&quot;X-TYPE&quot;);</span>
<a href="#l39.566"></a><span id="l39.566" class="difflineminus">-    itemData.links.push(attachData);</span>
<a href="#l39.567"></a><span id="l39.567" class="difflineminus">-  }</span>
<a href="#l39.568"></a><span id="l39.568" class="difflineminus">-</span>
<a href="#l39.569"></a><span id="l39.569" class="difflineminus">-  return itemData;</span>
<a href="#l39.570"></a><span id="l39.570" class="difflineminus">-}</span>
<a href="#l39.571"></a><span id="l39.571" class="difflineminus">-</span>
<a href="#l39.572"></a><span id="l39.572" class="difflineminus">-/**</span>
<a href="#l39.573"></a><span id="l39.573" class="difflineminus">- * Convenience function to convert any item type (task/event) to its JSON</span>
<a href="#l39.574"></a><span id="l39.574" class="difflineminus">- * representation</span>
<a href="#l39.575"></a><span id="l39.575" class="difflineminus">- *</span>
<a href="#l39.576"></a><span id="l39.576" class="difflineminus">- * @param aItem         The item to convert</span>
<a href="#l39.577"></a><span id="l39.577" class="difflineminus">- * @return              A JS Object representing the item.</span>
<a href="#l39.578"></a><span id="l39.578" class="difflineminus">- */</span>
<a href="#l39.579"></a><span id="l39.579" class="difflineminus">-function ItemToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l39.580"></a><span id="l39.580" class="difflineminus">-  if (cal.item.isEvent(aItem)) {</span>
<a href="#l39.581"></a><span id="l39.581" class="difflineminus">-    return EventToJSON(aItem, aOfflineStorage, aIsImport);</span>
<a href="#l39.582"></a><span id="l39.582" class="difflineminus">-  } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l39.583"></a><span id="l39.583" class="difflineminus">-    return TaskToJSON(aItem, aOfflineStorage, aIsImport);</span>
<a href="#l39.584"></a><span id="l39.584" class="difflineminus">-  } else {</span>
<a href="#l39.585"></a><span id="l39.585" class="difflineminus">-    cal.ERROR(&quot;[calGoogleCalendar] Invalid item type: &quot; + aItem.icalString);</span>
<a href="#l39.586"></a><span id="l39.586" class="difflineminus">-    return null;</span>
<a href="#l39.587"></a><span id="l39.587" class="difflineminus">-  }</span>
<a href="#l39.588"></a><span id="l39.588" class="difflineminus">-}</span>
<a href="#l39.589"></a><span id="l39.589" class="difflineminus">-</span>
<a href="#l39.590"></a><span id="l39.590" class="difflineminus">-/**</span>
<a href="#l39.591"></a><span id="l39.591" class="difflineminus">- * Sets up the recurrence info on the item</span>
<a href="#l39.592"></a><span id="l39.592" class="difflineminus">- *</span>
<a href="#l39.593"></a><span id="l39.593" class="difflineminus">- * @param aItem              The item to setup recurrence for.</span>
<a href="#l39.594"></a><span id="l39.594" class="difflineminus">- * @param aRecurrence        The JSON entry describing recurrence.</span>
<a href="#l39.595"></a><span id="l39.595" class="difflineminus">- */</span>
<a href="#l39.596"></a><span id="l39.596" class="difflineminus">-function setupRecurrence(aItem, aRecurrence, aTimezone) {</span>
<a href="#l39.597"></a><span id="l39.597" class="difflineminus">-  if (!aRecurrence) {</span>
<a href="#l39.598"></a><span id="l39.598" class="difflineminus">-    return;</span>
<a href="#l39.599"></a><span id="l39.599" class="difflineminus">-  }</span>
<a href="#l39.600"></a><span id="l39.600" class="difflineminus">-</span>
<a href="#l39.601"></a><span id="l39.601" class="difflineminus">-  if (aItem.recurrenceInfo) {</span>
<a href="#l39.602"></a><span id="l39.602" class="difflineminus">-    aItem.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l39.603"></a><span id="l39.603" class="difflineminus">-  } else {</span>
<a href="#l39.604"></a><span id="l39.604" class="difflineminus">-    aItem.recurrenceInfo = cal.createRecurrenceInfo(aItem);</span>
<a href="#l39.605"></a><span id="l39.605" class="difflineminus">-  }</span>
<a href="#l39.606"></a><span id="l39.606" class="difflineminus">-</span>
<a href="#l39.607"></a><span id="l39.607" class="difflineminus">-  let rootComp;</span>
<a href="#l39.608"></a><span id="l39.608" class="difflineminus">-  let vevent = &quot;BEGIN:VEVENT\r\n&quot; + aRecurrence.join(&quot;\r\n&quot;) + &quot;\r\nEND:VEVENT&quot;;</span>
<a href="#l39.609"></a><span id="l39.609" class="difflineminus">-  try {</span>
<a href="#l39.610"></a><span id="l39.610" class="difflineminus">-    rootComp = cal.getIcsService().parseICS(vevent, null);</span>
<a href="#l39.611"></a><span id="l39.611" class="difflineminus">-  } catch (e) {</span>
<a href="#l39.612"></a><span id="l39.612" class="difflineminus">-    cal.ERROR(&quot;[calGoogleCalendar] Unable to parse recurrence item: &quot; + vevent);</span>
<a href="#l39.613"></a><span id="l39.613" class="difflineminus">-  }</span>
<a href="#l39.614"></a><span id="l39.614" class="difflineminus">-</span>
<a href="#l39.615"></a><span id="l39.615" class="difflineminus">-  let hasRecurringRules = false;</span>
<a href="#l39.616"></a><span id="l39.616" class="difflineminus">-  for (let prop = rootComp.getFirstProperty(&quot;ANY&quot;); prop; prop = rootComp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l39.617"></a><span id="l39.617" class="difflineminus">-    switch (prop.propertyName) {</span>
<a href="#l39.618"></a><span id="l39.618" class="difflineminus">-      case &quot;RDATE&quot;:</span>
<a href="#l39.619"></a><span id="l39.619" class="difflineminus">-      case &quot;EXDATE&quot;: {</span>
<a href="#l39.620"></a><span id="l39.620" class="difflineminus">-        let recItem = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(</span>
<a href="#l39.621"></a><span id="l39.621" class="difflineminus">-          Ci.calIRecurrenceDate</span>
<a href="#l39.622"></a><span id="l39.622" class="difflineminus">-        );</span>
<a href="#l39.623"></a><span id="l39.623" class="difflineminus">-        try {</span>
<a href="#l39.624"></a><span id="l39.624" class="difflineminus">-          recItem.icalProperty = prop;</span>
<a href="#l39.625"></a><span id="l39.625" class="difflineminus">-          aItem.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l39.626"></a><span id="l39.626" class="difflineminus">-          hasRecurringRules = true;</span>
<a href="#l39.627"></a><span id="l39.627" class="difflineminus">-        } catch (e) {</span>
<a href="#l39.628"></a><span id="l39.628" class="difflineminus">-          cal.ERROR(</span>
<a href="#l39.629"></a><span id="l39.629" class="difflineminus">-            &quot;[calGoogleCalendar] Error parsing &quot; +</span>
<a href="#l39.630"></a><span id="l39.630" class="difflineminus">-              prop.propertyName +</span>
<a href="#l39.631"></a><span id="l39.631" class="difflineminus">-              &quot; (&quot; +</span>
<a href="#l39.632"></a><span id="l39.632" class="difflineminus">-              prop.icalString +</span>
<a href="#l39.633"></a><span id="l39.633" class="difflineminus">-              &quot;):&quot; +</span>
<a href="#l39.634"></a><span id="l39.634" class="difflineminus">-              e</span>
<a href="#l39.635"></a><span id="l39.635" class="difflineminus">-          );</span>
<a href="#l39.636"></a><span id="l39.636" class="difflineminus">-        }</span>
<a href="#l39.637"></a><span id="l39.637" class="difflineminus">-        break;</span>
<a href="#l39.638"></a><span id="l39.638" class="difflineminus">-      }</span>
<a href="#l39.639"></a><span id="l39.639" class="difflineminus">-      case &quot;RRULE&quot;: {</span>
<a href="#l39.640"></a><span id="l39.640" class="difflineminus">-        let recRule = cal.createRecurrenceRule();</span>
<a href="#l39.641"></a><span id="l39.641" class="difflineminus">-        try {</span>
<a href="#l39.642"></a><span id="l39.642" class="difflineminus">-          recRule.icalProperty = prop;</span>
<a href="#l39.643"></a><span id="l39.643" class="difflineminus">-          aItem.recurrenceInfo.appendRecurrenceItem(recRule);</span>
<a href="#l39.644"></a><span id="l39.644" class="difflineminus">-          hasRecurringRules = true;</span>
<a href="#l39.645"></a><span id="l39.645" class="difflineminus">-        } catch (e) {</span>
<a href="#l39.646"></a><span id="l39.646" class="difflineminus">-          cal.ERROR(&quot;[calGoogleCalendar] Error parsing RRULE (&quot; + prop.icalString + &quot;):&quot; + e);</span>
<a href="#l39.647"></a><span id="l39.647" class="difflineminus">-        }</span>
<a href="#l39.648"></a><span id="l39.648" class="difflineminus">-        break;</span>
<a href="#l39.649"></a><span id="l39.649" class="difflineminus">-      }</span>
<a href="#l39.650"></a><span id="l39.650" class="difflineminus">-    }</span>
<a href="#l39.651"></a><span id="l39.651" class="difflineminus">-  }</span>
<a href="#l39.652"></a><span id="l39.652" class="difflineminus">-</span>
<a href="#l39.653"></a><span id="l39.653" class="difflineminus">-  if (!hasRecurringRules) {</span>
<a href="#l39.654"></a><span id="l39.654" class="difflineminus">-    // If there were no parsable recurrence items, then clear the</span>
<a href="#l39.655"></a><span id="l39.655" class="difflineminus">-    // recurrence info.</span>
<a href="#l39.656"></a><span id="l39.656" class="difflineminus">-    aItem.recurrenceInfo = null;</span>
<a href="#l39.657"></a><span id="l39.657" class="difflineminus">-  }</span>
<a href="#l39.658"></a><span id="l39.658" class="difflineminus">-}</span>
<a href="#l39.659"></a><span id="l39.659" class="difflineminus">-</span>
<a href="#l39.660"></a><span id="l39.660" class="difflineminus">-/**</span>
<a href="#l39.661"></a><span id="l39.661" class="difflineminus">- * Create an alarm from the JSON reminder entry</span>
<a href="#l39.662"></a><span id="l39.662" class="difflineminus">- *</span>
<a href="#l39.663"></a><span id="l39.663" class="difflineminus">- * @param aEntry            The JSON reminder entry.</span>
<a href="#l39.664"></a><span id="l39.664" class="difflineminus">- * @param aDefault          (optional) If true, this is a default alarm.</span>
<a href="#l39.665"></a><span id="l39.665" class="difflineminus">- * @return                  The translated calIAlarm.</span>
<a href="#l39.666"></a><span id="l39.666" class="difflineminus">- */</span>
<a href="#l39.667"></a><span id="l39.667" class="difflineminus">-function JSONToAlarm(aEntry, aDefault) {</span>
<a href="#l39.668"></a><span id="l39.668" class="difflineminus">-  const alarmActionMap = {</span>
<a href="#l39.669"></a><span id="l39.669" class="difflineminus">-    email: &quot;EMAIL&quot;,</span>
<a href="#l39.670"></a><span id="l39.670" class="difflineminus">-    popup: &quot;DISPLAY&quot;,</span>
<a href="#l39.671"></a><span id="l39.671" class="difflineminus">-    sms: &quot;SMS&quot;,</span>
<a href="#l39.672"></a><span id="l39.672" class="difflineminus">-  };</span>
<a href="#l39.673"></a><span id="l39.673" class="difflineminus">-  let alarm = cal.createAlarm();</span>
<a href="#l39.674"></a><span id="l39.674" class="difflineminus">-  let alarmOffset = cal.createDuration();</span>
<a href="#l39.675"></a><span id="l39.675" class="difflineminus">-  alarm.action = alarmActionMap[aEntry.method] || &quot;DISPLAY&quot;;</span>
<a href="#l39.676"></a><span id="l39.676" class="difflineminus">-  alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l39.677"></a><span id="l39.677" class="difflineminus">-  alarmOffset.inSeconds = -aEntry.minutes * 60;</span>
<a href="#l39.678"></a><span id="l39.678" class="difflineminus">-  alarmOffset.normalize();</span>
<a href="#l39.679"></a><span id="l39.679" class="difflineminus">-  alarm.offset = alarmOffset;</span>
<a href="#l39.680"></a><span id="l39.680" class="difflineminus">-</span>
<a href="#l39.681"></a><span id="l39.681" class="difflineminus">-  if (aDefault) {</span>
<a href="#l39.682"></a><span id="l39.682" class="difflineminus">-    alarm.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l39.683"></a><span id="l39.683" class="difflineminus">-  }</span>
<a href="#l39.684"></a><span id="l39.684" class="difflineminus">-  return alarm;</span>
<a href="#l39.685"></a><span id="l39.685" class="difflineminus">-}</span>
<a href="#l39.686"></a><span id="l39.686" class="difflineminus">-</span>
<a href="#l39.687"></a><span id="l39.687" class="difflineminus">-/**</span>
<a href="#l39.688"></a><span id="l39.688" class="difflineminus">- * Converts a JS Object representing the event to a calIEvent.</span>
<a href="#l39.689"></a><span id="l39.689" class="difflineminus">- *</span>
<a href="#l39.690"></a><span id="l39.690" class="difflineminus">- * @param aEntry            The JS Object representation of the item.</span>
<a href="#l39.691"></a><span id="l39.691" class="difflineminus">- * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l39.692"></a><span id="l39.692" class="difflineminus">- * @param aDefaultReminders An array of default reminders, as a JS Object.</span>
<a href="#l39.693"></a><span id="l39.693" class="difflineminus">- * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l39.694"></a><span id="l39.694" class="difflineminus">- * @return                  The calIEvent with the item data.</span>
<a href="#l39.695"></a><span id="l39.695" class="difflineminus">- */</span>
<a href="#l39.696"></a><span id="l39.696" class="difflineminus">-function JSONToEvent(aEntry, aCalendar, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l39.697"></a><span id="l39.697" class="difflineminus">-  aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l39.698"></a><span id="l39.698" class="difflineminus">-  aMetadata = aMetadata || {};</span>
<a href="#l39.699"></a><span id="l39.699" class="difflineminus">-  let item = aReferenceItem || cal.createEvent();</span>
<a href="#l39.700"></a><span id="l39.700" class="difflineminus">-  item.calendar = aCalendar.superCalendar;</span>
<a href="#l39.701"></a><span id="l39.701" class="difflineminus">-  let privateProps = (&quot;extendedProperties&quot; in aEntry &amp;&amp; aEntry.extendedProperties.private) || {};</span>
<a href="#l39.702"></a><span id="l39.702" class="difflineminus">-  let sharedProps = (&quot;extendedProperties&quot; in aEntry &amp;&amp; aEntry.extendedProperties.shared) || {};</span>
<a href="#l39.703"></a><span id="l39.703" class="difflineminus">-  let accessRole = aCalendar.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l39.704"></a><span id="l39.704" class="difflineminus">-</span>
<a href="#l39.705"></a><span id="l39.705" class="difflineminus">-  LOGverbose(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + JSON.stringify(aEntry, null, &quot; &quot;) + &quot;\n&quot;);</span>
<a href="#l39.706"></a><span id="l39.706" class="difflineminus">-</span>
<a href="#l39.707"></a><span id="l39.707" class="difflineminus">-  if (!aEntry || !(&quot;kind&quot; in aEntry) || aEntry.kind != &quot;calendar#event&quot;) {</span>
<a href="#l39.708"></a><span id="l39.708" class="difflineminus">-    cal.ERROR(</span>
<a href="#l39.709"></a><span id="l39.709" class="difflineminus">-      &quot;[calGoogleCalendar] Attempt to decode invalid event: &quot; +</span>
<a href="#l39.710"></a><span id="l39.710" class="difflineminus">-        (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;))</span>
<a href="#l39.711"></a><span id="l39.711" class="difflineminus">-    );</span>
<a href="#l39.712"></a><span id="l39.712" class="difflineminus">-    return null;</span>
<a href="#l39.713"></a><span id="l39.713" class="difflineminus">-  }</span>
<a href="#l39.714"></a><span id="l39.714" class="difflineminus">-</span>
<a href="#l39.715"></a><span id="l39.715" class="difflineminus">-  let tzs = cal.getTimezoneService();</span>
<a href="#l39.716"></a><span id="l39.716" class="difflineminus">-  let calendarZoneName = aCalendar.getProperty(&quot;settings.timeZone&quot;);</span>
<a href="#l39.717"></a><span id="l39.717" class="difflineminus">-  let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.dtz.defaultTimezone;</span>
<a href="#l39.718"></a><span id="l39.718" class="difflineminus">-</span>
<a href="#l39.719"></a><span id="l39.719" class="difflineminus">-  try {</span>
<a href="#l39.720"></a><span id="l39.720" class="difflineminus">-    item.id = aEntry.iCalUID || (aEntry.recurringEventId || aEntry.id) + &quot;@google.com&quot;;</span>
<a href="#l39.721"></a><span id="l39.721" class="difflineminus">-    item.recurrenceId = JSONToDate(aEntry.originalStartTime, calendarZone);</span>
<a href="#l39.722"></a><span id="l39.722" class="difflineminus">-    if (!item.recurrenceId) {</span>
<a href="#l39.723"></a><span id="l39.723" class="difflineminus">-      // Sometimes recurring event instances don't have recurringEventId</span>
<a href="#l39.724"></a><span id="l39.724" class="difflineminus">-      // set, but are still instances. work around by detecting the ID.</span>
<a href="#l39.725"></a><span id="l39.725" class="difflineminus">-      // http://code.google.com/a/google.com/p/apps-api-issues/issues/detail?id=3199</span>
<a href="#l39.726"></a><span id="l39.726" class="difflineminus">-      let hack = aEntry.id.match(/([^_]*)_(\d{8}(T\d{6}Z)?)$/);</span>
<a href="#l39.727"></a><span id="l39.727" class="difflineminus">-      item.recurrenceId = hack ? cal.createDateTime(hack[2]) : null;</span>
<a href="#l39.728"></a><span id="l39.728" class="difflineminus">-    }</span>
<a href="#l39.729"></a><span id="l39.729" class="difflineminus">-    item.status = aEntry.status ? aEntry.status.toUpperCase() : null;</span>
<a href="#l39.730"></a><span id="l39.730" class="difflineminus">-    item.title = aEntry.summary;</span>
<a href="#l39.731"></a><span id="l39.731" class="difflineminus">-    if (accessRole == &quot;freeBusyReader&quot;) {</span>
<a href="#l39.732"></a><span id="l39.732" class="difflineminus">-      item.title = getProviderString(&quot;busyTitle&quot;, aCalendar.name);</span>
<a href="#l39.733"></a><span id="l39.733" class="difflineminus">-    }</span>
<a href="#l39.734"></a><span id="l39.734" class="difflineminus">-    item.privacy = aEntry.visibility ? aEntry.visibility.toUpperCase() : null;</span>
<a href="#l39.735"></a><span id="l39.735" class="difflineminus">-</span>
<a href="#l39.736"></a><span id="l39.736" class="difflineminus">-    item.setProperty(</span>
<a href="#l39.737"></a><span id="l39.737" class="difflineminus">-      &quot;URL&quot;,</span>
<a href="#l39.738"></a><span id="l39.738" class="difflineminus">-      aEntry.htmlLink &amp;&amp; aCalendar.uri.schemeIs(&quot;https&quot;)</span>
<a href="#l39.739"></a><span id="l39.739" class="difflineminus">-        ? aEntry.htmlLink.replace(/^http:/, &quot;https:&quot;)</span>
<a href="#l39.740"></a><span id="l39.740" class="difflineminus">-        : aEntry.htmlLink</span>
<a href="#l39.741"></a><span id="l39.741" class="difflineminus">-    );</span>
<a href="#l39.742"></a><span id="l39.742" class="difflineminus">-    item.setProperty(</span>
<a href="#l39.743"></a><span id="l39.743" class="difflineminus">-      &quot;CREATED&quot;,</span>
<a href="#l39.744"></a><span id="l39.744" class="difflineminus">-      aEntry.created</span>
<a href="#l39.745"></a><span id="l39.745" class="difflineminus">-        ? cal.dtz.fromRFC3339(aEntry.created, calendarZone).getInTimezone(cal.dtz.UTC)</span>
<a href="#l39.746"></a><span id="l39.746" class="difflineminus">-        : null</span>
<a href="#l39.747"></a><span id="l39.747" class="difflineminus">-    );</span>
<a href="#l39.748"></a><span id="l39.748" class="difflineminus">-    item.setProperty(&quot;DESCRIPTION&quot;, aEntry.description);</span>
<a href="#l39.749"></a><span id="l39.749" class="difflineminus">-    item.setProperty(&quot;LOCATION&quot;, aEntry.location);</span>
<a href="#l39.750"></a><span id="l39.750" class="difflineminus">-    item.setProperty(&quot;TRANSP&quot;, aEntry.transparency ? aEntry.transparency.toUpperCase() : null);</span>
<a href="#l39.751"></a><span id="l39.751" class="difflineminus">-    item.setProperty(&quot;SEQUENCE&quot;, aEntry.sequence);</span>
<a href="#l39.752"></a><span id="l39.752" class="difflineminus">-    aMetadata.etag = aEntry.etag;</span>
<a href="#l39.753"></a><span id="l39.753" class="difflineminus">-    aMetadata.path = aEntry.id;</span>
<a href="#l39.754"></a><span id="l39.754" class="difflineminus">-</span>
<a href="#l39.755"></a><span id="l39.755" class="difflineminus">-    // organizer</span>
<a href="#l39.756"></a><span id="l39.756" class="difflineminus">-    if (aEntry.organizer) {</span>
<a href="#l39.757"></a><span id="l39.757" class="difflineminus">-      let organizer = cal.createAttendee();</span>
<a href="#l39.758"></a><span id="l39.758" class="difflineminus">-      if (aEntry.organizer.email) {</span>
<a href="#l39.759"></a><span id="l39.759" class="difflineminus">-        organizer.id = &quot;mailto:&quot; + aEntry.organizer.email;</span>
<a href="#l39.760"></a><span id="l39.760" class="difflineminus">-      } else {</span>
<a href="#l39.761"></a><span id="l39.761" class="difflineminus">-        organizer.id = &quot;urn:id:&quot; + aEntry.organizer.id;</span>
<a href="#l39.762"></a><span id="l39.762" class="difflineminus">-      }</span>
<a href="#l39.763"></a><span id="l39.763" class="difflineminus">-      organizer.commonName = aEntry.organizer.displayName;</span>
<a href="#l39.764"></a><span id="l39.764" class="difflineminus">-      organizer.isOrganizer = true;</span>
<a href="#l39.765"></a><span id="l39.765" class="difflineminus">-      item.organizer = organizer;</span>
<a href="#l39.766"></a><span id="l39.766" class="difflineminus">-</span>
<a href="#l39.767"></a><span id="l39.767" class="difflineminus">-      if (aEntry.organizer.self &amp;&amp; aCalendar.session) {</span>
<a href="#l39.768"></a><span id="l39.768" class="difflineminus">-        // Remember the display name, we found ourselves!</span>
<a href="#l39.769"></a><span id="l39.769" class="difflineminus">-        aCalendar.setProperty(&quot;organizerCN&quot;, aEntry.organizer.displayName);</span>
<a href="#l39.770"></a><span id="l39.770" class="difflineminus">-      }</span>
<a href="#l39.771"></a><span id="l39.771" class="difflineminus">-    } else {</span>
<a href="#l39.772"></a><span id="l39.772" class="difflineminus">-      item.organizer = null;</span>
<a href="#l39.773"></a><span id="l39.773" class="difflineminus">-    }</span>
<a href="#l39.774"></a><span id="l39.774" class="difflineminus">-</span>
<a href="#l39.775"></a><span id="l39.775" class="difflineminus">-    // start and end</span>
<a href="#l39.776"></a><span id="l39.776" class="difflineminus">-    item.startDate = JSONToDate(aEntry.start, calendarZone);</span>
<a href="#l39.777"></a><span id="l39.777" class="difflineminus">-    item.endDate = JSONToDate(aEntry.end, calendarZone);</span>
<a href="#l39.778"></a><span id="l39.778" class="difflineminus">-</span>
<a href="#l39.779"></a><span id="l39.779" class="difflineminus">-    // recurrence</span>
<a href="#l39.780"></a><span id="l39.780" class="difflineminus">-    setupRecurrence(item, aEntry.recurrence, calendarZone);</span>
<a href="#l39.781"></a><span id="l39.781" class="difflineminus">-</span>
<a href="#l39.782"></a><span id="l39.782" class="difflineminus">-    // attendees</span>
<a href="#l39.783"></a><span id="l39.783" class="difflineminus">-    item.removeAllAttendees();</span>
<a href="#l39.784"></a><span id="l39.784" class="difflineminus">-    if (aEntry.attendees) {</span>
<a href="#l39.785"></a><span id="l39.785" class="difflineminus">-      const statusMap = {</span>
<a href="#l39.786"></a><span id="l39.786" class="difflineminus">-        needsAction: &quot;NEEDS-ACTION&quot;,</span>
<a href="#l39.787"></a><span id="l39.787" class="difflineminus">-        declined: &quot;DECLINED&quot;,</span>
<a href="#l39.788"></a><span id="l39.788" class="difflineminus">-        tentative: &quot;TENTATIVE&quot;,</span>
<a href="#l39.789"></a><span id="l39.789" class="difflineminus">-        accepted: &quot;ACCEPTED&quot;,</span>
<a href="#l39.790"></a><span id="l39.790" class="difflineminus">-      };</span>
<a href="#l39.791"></a><span id="l39.791" class="difflineminus">-      for (let attendeeEntry of aEntry.attendees) {</span>
<a href="#l39.792"></a><span id="l39.792" class="difflineminus">-        let attendee = cal.createAttendee();</span>
<a href="#l39.793"></a><span id="l39.793" class="difflineminus">-        if (attendeeEntry.email) {</span>
<a href="#l39.794"></a><span id="l39.794" class="difflineminus">-          attendee.id = &quot;mailto:&quot; + attendeeEntry.email;</span>
<a href="#l39.795"></a><span id="l39.795" class="difflineminus">-        } else {</span>
<a href="#l39.796"></a><span id="l39.796" class="difflineminus">-          attendee.id = &quot;urn:id:&quot; + attendeeEntry.id;</span>
<a href="#l39.797"></a><span id="l39.797" class="difflineminus">-        }</span>
<a href="#l39.798"></a><span id="l39.798" class="difflineminus">-        attendee.commonName = attendeeEntry.displayName;</span>
<a href="#l39.799"></a><span id="l39.799" class="difflineminus">-</span>
<a href="#l39.800"></a><span id="l39.800" class="difflineminus">-        if (attendeeEntry.optional) {</span>
<a href="#l39.801"></a><span id="l39.801" class="difflineminus">-          attendee.role = &quot;OPT-PARTICIPANT&quot;;</span>
<a href="#l39.802"></a><span id="l39.802" class="difflineminus">-        } else {</span>
<a href="#l39.803"></a><span id="l39.803" class="difflineminus">-          attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l39.804"></a><span id="l39.804" class="difflineminus">-        }</span>
<a href="#l39.805"></a><span id="l39.805" class="difflineminus">-</span>
<a href="#l39.806"></a><span id="l39.806" class="difflineminus">-        attendee.participationStatus = statusMap[attendeeEntry.responseStatus];</span>
<a href="#l39.807"></a><span id="l39.807" class="difflineminus">-</span>
<a href="#l39.808"></a><span id="l39.808" class="difflineminus">-        if (attendeeEntry.resource) {</span>
<a href="#l39.809"></a><span id="l39.809" class="difflineminus">-          attendee.userType = &quot;RESOURCE&quot;;</span>
<a href="#l39.810"></a><span id="l39.810" class="difflineminus">-        } else {</span>
<a href="#l39.811"></a><span id="l39.811" class="difflineminus">-          attendee.userType = &quot;INDIVIDUAL&quot;;</span>
<a href="#l39.812"></a><span id="l39.812" class="difflineminus">-        }</span>
<a href="#l39.813"></a><span id="l39.813" class="difflineminus">-</span>
<a href="#l39.814"></a><span id="l39.814" class="difflineminus">-        item.addAttendee(attendee);</span>
<a href="#l39.815"></a><span id="l39.815" class="difflineminus">-      }</span>
<a href="#l39.816"></a><span id="l39.816" class="difflineminus">-    }</span>
<a href="#l39.817"></a><span id="l39.817" class="difflineminus">-</span>
<a href="#l39.818"></a><span id="l39.818" class="difflineminus">-    // reminders</span>
<a href="#l39.819"></a><span id="l39.819" class="difflineminus">-    item.clearAlarms();</span>
<a href="#l39.820"></a><span id="l39.820" class="difflineminus">-</span>
<a href="#l39.821"></a><span id="l39.821" class="difflineminus">-    if (aEntry.reminders) {</span>
<a href="#l39.822"></a><span id="l39.822" class="difflineminus">-      if (aEntry.reminders.useDefault) {</span>
<a href="#l39.823"></a><span id="l39.823" class="difflineminus">-        aDefaultReminders.forEach(item.addAlarm, item);</span>
<a href="#l39.824"></a><span id="l39.824" class="difflineminus">-</span>
<a href="#l39.825"></a><span id="l39.825" class="difflineminus">-        if (aDefaultReminders.length) {</span>
<a href="#l39.826"></a><span id="l39.826" class="difflineminus">-          item.deleteProperty(&quot;X-DEFAULT-ALARM&quot;);</span>
<a href="#l39.827"></a><span id="l39.827" class="difflineminus">-        } else {</span>
<a href="#l39.828"></a><span id="l39.828" class="difflineminus">-          // Nothing to make clear we are using default reminders.</span>
<a href="#l39.829"></a><span id="l39.829" class="difflineminus">-          // Set an X-PROP until VALARM extensions are supported</span>
<a href="#l39.830"></a><span id="l39.830" class="difflineminus">-          item.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l39.831"></a><span id="l39.831" class="difflineminus">-        }</span>
<a href="#l39.832"></a><span id="l39.832" class="difflineminus">-      }</span>
<a href="#l39.833"></a><span id="l39.833" class="difflineminus">-</span>
<a href="#l39.834"></a><span id="l39.834" class="difflineminus">-      if (aEntry.reminders.overrides) {</span>
<a href="#l39.835"></a><span id="l39.835" class="difflineminus">-        for (let reminderEntry of aEntry.reminders.overrides) {</span>
<a href="#l39.836"></a><span id="l39.836" class="difflineminus">-          item.addAlarm(JSONToAlarm(reminderEntry));</span>
<a href="#l39.837"></a><span id="l39.837" class="difflineminus">-        }</span>
<a href="#l39.838"></a><span id="l39.838" class="difflineminus">-      }</span>
<a href="#l39.839"></a><span id="l39.839" class="difflineminus">-    }</span>
<a href="#l39.840"></a><span id="l39.840" class="difflineminus">-</span>
<a href="#l39.841"></a><span id="l39.841" class="difflineminus">-    // extendedProperty (alarmLastAck)</span>
<a href="#l39.842"></a><span id="l39.842" class="difflineminus">-    item.alarmLastAck = cal.dtz.fromRFC3339(privateProps[&quot;X-MOZ-LASTACK&quot;], calendarZone);</span>
<a href="#l39.843"></a><span id="l39.843" class="difflineminus">-</span>
<a href="#l39.844"></a><span id="l39.844" class="difflineminus">-    // extendedProperty (snooze time)</span>
<a href="#l39.845"></a><span id="l39.845" class="difflineminus">-    let dtSnoozeTime = cal.dtz.fromRFC3339(privateProps[&quot;X-MOZ-SNOOZE-TIME&quot;], calendarZone);</span>
<a href="#l39.846"></a><span id="l39.846" class="difflineminus">-    let snoozeProperty = dtSnoozeTime ? dtSnoozeTime.icalString : null;</span>
<a href="#l39.847"></a><span id="l39.847" class="difflineminus">-    item.setProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, snoozeProperty);</span>
<a href="#l39.848"></a><span id="l39.848" class="difflineminus">-</span>
<a href="#l39.849"></a><span id="l39.849" class="difflineminus">-    // extendedProperty (snooze recurring alarms)</span>
<a href="#l39.850"></a><span id="l39.850" class="difflineminus">-    if (item.recurrenceInfo) {</span>
<a href="#l39.851"></a><span id="l39.851" class="difflineminus">-      // Transform back the string into our snooze properties</span>
<a href="#l39.852"></a><span id="l39.852" class="difflineminus">-      let snoozeObj;</span>
<a href="#l39.853"></a><span id="l39.853" class="difflineminus">-      try {</span>
<a href="#l39.854"></a><span id="l39.854" class="difflineminus">-        let snoozeString = privateProps[&quot;X-GOOGLE-SNOOZE-RECUR&quot;];</span>
<a href="#l39.855"></a><span id="l39.855" class="difflineminus">-        snoozeObj = JSON.parse(snoozeString);</span>
<a href="#l39.856"></a><span id="l39.856" class="difflineminus">-      } catch (e) {</span>
<a href="#l39.857"></a><span id="l39.857" class="difflineminus">-        // Just swallow parsing errors, not so important.</span>
<a href="#l39.858"></a><span id="l39.858" class="difflineminus">-      }</span>
<a href="#l39.859"></a><span id="l39.859" class="difflineminus">-</span>
<a href="#l39.860"></a><span id="l39.860" class="difflineminus">-      if (snoozeObj) {</span>
<a href="#l39.861"></a><span id="l39.861" class="difflineminus">-        for (let rid in snoozeObj) {</span>
<a href="#l39.862"></a><span id="l39.862" class="difflineminus">-          item.setProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + rid, snoozeObj[rid]);</span>
<a href="#l39.863"></a><span id="l39.863" class="difflineminus">-        }</span>
<a href="#l39.864"></a><span id="l39.864" class="difflineminus">-      }</span>
<a href="#l39.865"></a><span id="l39.865" class="difflineminus">-    }</span>
<a href="#l39.866"></a><span id="l39.866" class="difflineminus">-</span>
<a href="#l39.867"></a><span id="l39.867" class="difflineminus">-    // Google does not support categories natively, but allows us to store</span>
<a href="#l39.868"></a><span id="l39.868" class="difflineminus">-    // data as an &quot;extendedProperty&quot;, and here it's going to be retrieved</span>
<a href="#l39.869"></a><span id="l39.869" class="difflineminus">-    // again</span>
<a href="#l39.870"></a><span id="l39.870" class="difflineminus">-    let categories = cal.category.stringToArray(sharedProps[&quot;X-MOZ-CATEGORIES&quot;]);</span>
<a href="#l39.871"></a><span id="l39.871" class="difflineminus">-    item.setCategories(categories.length, categories);</span>
<a href="#l39.872"></a><span id="l39.872" class="difflineminus">-</span>
<a href="#l39.873"></a><span id="l39.873" class="difflineminus">-    // updated (This must be set last!)</span>
<a href="#l39.874"></a><span id="l39.874" class="difflineminus">-    if (aEntry.updated) {</span>
<a href="#l39.875"></a><span id="l39.875" class="difflineminus">-      let updated = cal.dtz.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC);</span>
<a href="#l39.876"></a><span id="l39.876" class="difflineminus">-      item.setProperty(&quot;DTSTAMP&quot;, updated);</span>
<a href="#l39.877"></a><span id="l39.877" class="difflineminus">-      item.setProperty(&quot;LAST-MODIFIED&quot;, updated);</span>
<a href="#l39.878"></a><span id="l39.878" class="difflineminus">-    }</span>
<a href="#l39.879"></a><span id="l39.879" class="difflineminus">-  } catch (e) {</span>
<a href="#l39.880"></a><span id="l39.880" class="difflineminus">-    cal.ERROR(stringException(e));</span>
<a href="#l39.881"></a><span id="l39.881" class="difflineminus">-    throw e;</span>
<a href="#l39.882"></a><span id="l39.882" class="difflineminus">-  }</span>
<a href="#l39.883"></a><span id="l39.883" class="difflineminus">-  return item;</span>
<a href="#l39.884"></a><span id="l39.884" class="difflineminus">-}</span>
<a href="#l39.885"></a><span id="l39.885" class="difflineminus">-</span>
<a href="#l39.886"></a><span id="l39.886" class="difflineminus">-/**</span>
<a href="#l39.887"></a><span id="l39.887" class="difflineminus">- * Converts a JS Object representing the task to a calITodo.</span>
<a href="#l39.888"></a><span id="l39.888" class="difflineminus">- *</span>
<a href="#l39.889"></a><span id="l39.889" class="difflineminus">- * @param aEntry            The JS Object representation of the item.</span>
<a href="#l39.890"></a><span id="l39.890" class="difflineminus">- * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l39.891"></a><span id="l39.891" class="difflineminus">- * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l39.892"></a><span id="l39.892" class="difflineminus">- * @return                  The calITodo with the item data.</span>
<a href="#l39.893"></a><span id="l39.893" class="difflineminus">- */</span>
<a href="#l39.894"></a><span id="l39.894" class="difflineminus">-function JSONToTask(aEntry, aCalendar, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l39.895"></a><span id="l39.895" class="difflineminus">-  aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l39.896"></a><span id="l39.896" class="difflineminus">-  aMetadata = aMetadata || {};</span>
<a href="#l39.897"></a><span id="l39.897" class="difflineminus">-  if (!aEntry || !(&quot;kind&quot; in aEntry) || aEntry.kind != &quot;tasks#task&quot;) {</span>
<a href="#l39.898"></a><span id="l39.898" class="difflineminus">-    cal.ERROR(</span>
<a href="#l39.899"></a><span id="l39.899" class="difflineminus">-      &quot;[calGoogleCalendar] Attempt to decode invalid task: &quot; +</span>
<a href="#l39.900"></a><span id="l39.900" class="difflineminus">-        (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;))</span>
<a href="#l39.901"></a><span id="l39.901" class="difflineminus">-    );</span>
<a href="#l39.902"></a><span id="l39.902" class="difflineminus">-    return null;</span>
<a href="#l39.903"></a><span id="l39.903" class="difflineminus">-  }</span>
<a href="#l39.904"></a><span id="l39.904" class="difflineminus">-  let item = cal.createTodo();</span>
<a href="#l39.905"></a><span id="l39.905" class="difflineminus">-  item.calendar = aCalendar.superCalendar;</span>
<a href="#l39.906"></a><span id="l39.906" class="difflineminus">-</span>
<a href="#l39.907"></a><span id="l39.907" class="difflineminus">-  let tzs = cal.getTimezoneService();</span>
<a href="#l39.908"></a><span id="l39.908" class="difflineminus">-  let calendarZoneName = aCalendar.getProperty(&quot;settings.timeZone&quot;);</span>
<a href="#l39.909"></a><span id="l39.909" class="difflineminus">-  let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.dtz.defaultTimezone;</span>
<a href="#l39.910"></a><span id="l39.910" class="difflineminus">-</span>
<a href="#l39.911"></a><span id="l39.911" class="difflineminus">-  try {</span>
<a href="#l39.912"></a><span id="l39.912" class="difflineminus">-    item.id = aEntry.id;</span>
<a href="#l39.913"></a><span id="l39.913" class="difflineminus">-    item.title = aEntry.title || &quot;&quot;;</span>
<a href="#l39.914"></a><span id="l39.914" class="difflineminus">-    item.setProperty(&quot;DESCRIPTION&quot;, aEntry.notes);</span>
<a href="#l39.915"></a><span id="l39.915" class="difflineminus">-    item.setProperty(&quot;X-GOOGLE-SORTKEY&quot;, aEntry.position);</span>
<a href="#l39.916"></a><span id="l39.916" class="difflineminus">-    item.isCompleted = aEntry.status == &quot;completed&quot;;</span>
<a href="#l39.917"></a><span id="l39.917" class="difflineminus">-</span>
<a href="#l39.918"></a><span id="l39.918" class="difflineminus">-    aMetadata.etag = aEntry.etag;</span>
<a href="#l39.919"></a><span id="l39.919" class="difflineminus">-    aMetadata.path = aEntry.id;</span>
<a href="#l39.920"></a><span id="l39.920" class="difflineminus">-</span>
<a href="#l39.921"></a><span id="l39.921" class="difflineminus">-    // Google Tasks don't have a due time, but still use 0:00 UTC. They</span>
<a href="#l39.922"></a><span id="l39.922" class="difflineminus">-    // should really be using floating time.</span>
<a href="#l39.923"></a><span id="l39.923" class="difflineminus">-    item.dueDate = cal.dtz.fromRFC3339(aEntry.due, cal.dtz.floating);</span>
<a href="#l39.924"></a><span id="l39.924" class="difflineminus">-    if (item.dueDate) {</span>
<a href="#l39.925"></a><span id="l39.925" class="difflineminus">-      item.dueDate.timezone = cal.dtz.floating;</span>
<a href="#l39.926"></a><span id="l39.926" class="difflineminus">-      item.dueDate.isDate = true;</span>
<a href="#l39.927"></a><span id="l39.927" class="difflineminus">-    }</span>
<a href="#l39.928"></a><span id="l39.928" class="difflineminus">-    item.completedDate = cal.dtz.fromRFC3339(aEntry.completed, calendarZone);</span>
<a href="#l39.929"></a><span id="l39.929" class="difflineminus">-    if (aEntry.deleted) {</span>
<a href="#l39.930"></a><span id="l39.930" class="difflineminus">-      item.status = &quot;CANCELLED&quot;;</span>
<a href="#l39.931"></a><span id="l39.931" class="difflineminus">-    } else if (aEntry.status == &quot;needsAction&quot;) {</span>
<a href="#l39.932"></a><span id="l39.932" class="difflineminus">-      item.status = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l39.933"></a><span id="l39.933" class="difflineminus">-    } else {</span>
<a href="#l39.934"></a><span id="l39.934" class="difflineminus">-      item.status = &quot;COMPLETED&quot;;</span>
<a href="#l39.935"></a><span id="l39.935" class="difflineminus">-    }</span>
<a href="#l39.936"></a><span id="l39.936" class="difflineminus">-</span>
<a href="#l39.937"></a><span id="l39.937" class="difflineminus">-    if (aEntry.parent) {</span>
<a href="#l39.938"></a><span id="l39.938" class="difflineminus">-      let relation = cal.createRelation();</span>
<a href="#l39.939"></a><span id="l39.939" class="difflineminus">-      relation.relType = &quot;PARENT&quot;;</span>
<a href="#l39.940"></a><span id="l39.940" class="difflineminus">-      relation.relId = aEntry.parent;</span>
<a href="#l39.941"></a><span id="l39.941" class="difflineminus">-      item.addRelation(relation);</span>
<a href="#l39.942"></a><span id="l39.942" class="difflineminus">-    }</span>
<a href="#l39.943"></a><span id="l39.943" class="difflineminus">-</span>
<a href="#l39.944"></a><span id="l39.944" class="difflineminus">-    if (aEntry.links) {</span>
<a href="#l39.945"></a><span id="l39.945" class="difflineminus">-      for (let link of aEntry.links) {</span>
<a href="#l39.946"></a><span id="l39.946" class="difflineminus">-        let attach = cal.createAttachment();</span>
<a href="#l39.947"></a><span id="l39.947" class="difflineminus">-        attach.uri = Services.io.newURI(link.link);</span>
<a href="#l39.948"></a><span id="l39.948" class="difflineminus">-        attach.setParameter(&quot;FILENAME&quot;, link.description);</span>
<a href="#l39.949"></a><span id="l39.949" class="difflineminus">-        attach.setParameter(&quot;X-GOOGLE-TYPE&quot;, link.type);</span>
<a href="#l39.950"></a><span id="l39.950" class="difflineminus">-        item.addAttachment(attach);</span>
<a href="#l39.951"></a><span id="l39.951" class="difflineminus">-      }</span>
<a href="#l39.952"></a><span id="l39.952" class="difflineminus">-    }</span>
<a href="#l39.953"></a><span id="l39.953" class="difflineminus">-</span>
<a href="#l39.954"></a><span id="l39.954" class="difflineminus">-    // updated (This must be set last!)</span>
<a href="#l39.955"></a><span id="l39.955" class="difflineminus">-    item.setProperty(</span>
<a href="#l39.956"></a><span id="l39.956" class="difflineminus">-      &quot;DTSTAMP&quot;,</span>
<a href="#l39.957"></a><span id="l39.957" class="difflineminus">-      cal.dtz.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC)</span>
<a href="#l39.958"></a><span id="l39.958" class="difflineminus">-    );</span>
<a href="#l39.959"></a><span id="l39.959" class="difflineminus">-    item.setProperty(</span>
<a href="#l39.960"></a><span id="l39.960" class="difflineminus">-      &quot;LAST-MODIFIED&quot;,</span>
<a href="#l39.961"></a><span id="l39.961" class="difflineminus">-      cal.dtz.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC)</span>
<a href="#l39.962"></a><span id="l39.962" class="difflineminus">-    );</span>
<a href="#l39.963"></a><span id="l39.963" class="difflineminus">-  } catch (e) {</span>
<a href="#l39.964"></a><span id="l39.964" class="difflineminus">-    cal.ERROR(&quot;[calGoogleCalendar] Error parsing JSON tasks stream: &quot; + stringException(e));</span>
<a href="#l39.965"></a><span id="l39.965" class="difflineminus">-    throw e;</span>
<a href="#l39.966"></a><span id="l39.966" class="difflineminus">-  }</span>
<a href="#l39.967"></a><span id="l39.967" class="difflineminus">-</span>
<a href="#l39.968"></a><span id="l39.968" class="difflineminus">-  return item;</span>
<a href="#l39.969"></a><span id="l39.969" class="difflineminus">-}</span>
<a href="#l39.970"></a><span id="l39.970" class="difflineminus">-</span>
<a href="#l39.971"></a><span id="l39.971" class="difflineminus">-/**</span>
<a href="#l39.972"></a><span id="l39.972" class="difflineminus">- * Convenience function to convert any JSON reply (task/event) to a calendar</span>
<a href="#l39.973"></a><span id="l39.973" class="difflineminus">- * item.</span>
<a href="#l39.974"></a><span id="l39.974" class="difflineminus">- *</span>
<a href="#l39.975"></a><span id="l39.975" class="difflineminus">- * @param aEntry            The JS Object representation of the item.</span>
<a href="#l39.976"></a><span id="l39.976" class="difflineminus">- * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l39.977"></a><span id="l39.977" class="difflineminus">- * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l39.978"></a><span id="l39.978" class="difflineminus">- * @return                  The specialized calIItemBase with the item data.</span>
<a href="#l39.979"></a><span id="l39.979" class="difflineminus">- */</span>
<a href="#l39.980"></a><span id="l39.980" class="difflineminus">-function JSONToItem(aEntry, aCalendar, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l39.981"></a><span id="l39.981" class="difflineminus">-  aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l39.982"></a><span id="l39.982" class="difflineminus">-  aMetadata = aMetadata || {};</span>
<a href="#l39.983"></a><span id="l39.983" class="difflineminus">-  if (aEntry.kind == &quot;tasks#task&quot;) {</span>
<a href="#l39.984"></a><span id="l39.984" class="difflineminus">-    return JSONToTask(...arguments);</span>
<a href="#l39.985"></a><span id="l39.985" class="difflineminus">-  } else if (aEntry.kind == &quot;calendar#event&quot;) {</span>
<a href="#l39.986"></a><span id="l39.986" class="difflineminus">-    return JSONToEvent(...arguments);</span>
<a href="#l39.987"></a><span id="l39.987" class="difflineminus">-  } else {</span>
<a href="#l39.988"></a><span id="l39.988" class="difflineminus">-    cal.ERROR(&quot;[calGoogleCalendar] Invalid item type: &quot; + (aEntry ? aEntry.kind : &quot;&lt;no entry&gt;&quot;));</span>
<a href="#l39.989"></a><span id="l39.989" class="difflineminus">-    return null;</span>
<a href="#l39.990"></a><span id="l39.990" class="difflineminus">-  }</span>
<a href="#l39.991"></a><span id="l39.991" class="difflineminus">-}</span>
<a href="#l39.992"></a><span id="l39.992" class="difflineminus">-</span>
<a href="#l39.993"></a><span id="l39.993" class="difflineminus">-/**</span>
<a href="#l39.994"></a><span id="l39.994" class="difflineminus">- * Save items spread over multiple pages to the calendar's offline storage.</span>
<a href="#l39.995"></a><span id="l39.995" class="difflineminus">- *</span>
<a href="#l39.996"></a><span id="l39.996" class="difflineminus">- * @param aCalendar     The calendar the events belong to.</span>
<a href="#l39.997"></a><span id="l39.997" class="difflineminus">- */</span>
<a href="#l39.998"></a><span id="l39.998" class="difflineminus">-function ItemSaver(aCalendar) {</span>
<a href="#l39.999"></a><span id="l39.999" class="difflineminus">-  this.calendar = aCalendar;</span>
<a href="#l39.1000"></a><span id="l39.1000" class="difflineminus">-  this.offlineStorage = this.calendar.offlineStorage;</span>
<a href="#l39.1001"></a><span id="l39.1001" class="difflineminus">-  this.promiseOfflineStorage = cal.async.promisifyCalendar(this.calendar.offlineStorage);</span>
<a href="#l39.1002"></a><span id="l39.1002" class="difflineminus">-  this.missingParents = [];</span>
<a href="#l39.1003"></a><span id="l39.1003" class="difflineminus">-  this.masterItems = Object.create(null);</span>
<a href="#l39.1004"></a><span id="l39.1004" class="difflineminus">-  this.metaData = Object.create(null);</span>
<a href="#l39.1005"></a><span id="l39.1005" class="difflineminus">-  this.activity = new ActivityShell(aCalendar);</span>
<a href="#l39.1006"></a><span id="l39.1006" class="difflineminus">-}</span>
<a href="#l39.1007"></a><span id="l39.1007" class="difflineminus">-ItemSaver.prototype = {</span>
<a href="#l39.1008"></a><span id="l39.1008" class="difflineminus">-  masterItems: null,</span>
<a href="#l39.1009"></a><span id="l39.1009" class="difflineminus">-  missingParents: null,</span>
<a href="#l39.1010"></a><span id="l39.1010" class="difflineminus">-</span>
<a href="#l39.1011"></a><span id="l39.1011" class="difflineminus">-  /**</span>
<a href="#l39.1012"></a><span id="l39.1012" class="difflineminus">-   * Convenience function to apply a list of items (task/event) in JSON form to</span>
<a href="#l39.1013"></a><span id="l39.1013" class="difflineminus">-   * the given calendar.</span>
<a href="#l39.1014"></a><span id="l39.1014" class="difflineminus">-   *</span>
<a href="#l39.1015"></a><span id="l39.1015" class="difflineminus">-   * @param aData         The JS Object from the list response.</span>
<a href="#l39.1016"></a><span id="l39.1016" class="difflineminus">-   * @return              A promise resolved when completed.</span>
<a href="#l39.1017"></a><span id="l39.1017" class="difflineminus">-   */</span>
<a href="#l39.1018"></a><span id="l39.1018" class="difflineminus">-  parseItemStream: function(aData) {</span>
<a href="#l39.1019"></a><span id="l39.1019" class="difflineminus">-    if (aData.kind == &quot;calendar#events&quot;) {</span>
<a href="#l39.1020"></a><span id="l39.1020" class="difflineminus">-      this.activity.type = &quot;Event&quot;;</span>
<a href="#l39.1021"></a><span id="l39.1021" class="difflineminus">-      return this.parseEventStream(aData);</span>
<a href="#l39.1022"></a><span id="l39.1022" class="difflineminus">-    } else if (aData.kind == &quot;tasks#tasks&quot;) {</span>
<a href="#l39.1023"></a><span id="l39.1023" class="difflineminus">-      this.activity.type = &quot;Task&quot;;</span>
<a href="#l39.1024"></a><span id="l39.1024" class="difflineminus">-      return this.parseTaskStream(aData);</span>
<a href="#l39.1025"></a><span id="l39.1025" class="difflineminus">-    } else {</span>
<a href="#l39.1026"></a><span id="l39.1026" class="difflineminus">-      let message = &quot;Invalid Stream type: &quot; + (aData ? aData.kind || aData.toSource() : null);</span>
<a href="#l39.1027"></a><span id="l39.1027" class="difflineminus">-      throw new Components.Exception(message, Cr.NS_ERROR_FAILURE);</span>
<a href="#l39.1028"></a><span id="l39.1028" class="difflineminus">-    }</span>
<a href="#l39.1029"></a><span id="l39.1029" class="difflineminus">-  },</span>
<a href="#l39.1030"></a><span id="l39.1030" class="difflineminus">-</span>
<a href="#l39.1031"></a><span id="l39.1031" class="difflineminus">-  /**</span>
<a href="#l39.1032"></a><span id="l39.1032" class="difflineminus">-   * Parse the response from Google's list command into tasks and modify the</span>
<a href="#l39.1033"></a><span id="l39.1033" class="difflineminus">-   * calendar's offline storage to reflect those changes.</span>
<a href="#l39.1034"></a><span id="l39.1034" class="difflineminus">-   *</span>
<a href="#l39.1035"></a><span id="l39.1035" class="difflineminus">-   * @param aData         The JS Object from the list response.</span>
<a href="#l39.1036"></a><span id="l39.1036" class="difflineminus">-   * @return              A promise resolved when completed.</span>
<a href="#l39.1037"></a><span id="l39.1037" class="difflineminus">-   */</span>
<a href="#l39.1038"></a><span id="l39.1038" class="difflineminus">-  parseTaskStream: async function(aData) {</span>
<a href="#l39.1039"></a><span id="l39.1039" class="difflineminus">-    if (!aData.items || !aData.items.length) {</span>
<a href="#l39.1040"></a><span id="l39.1040" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] No tasks have been changed on &quot; + this.calendar.name);</span>
<a href="#l39.1041"></a><span id="l39.1041" class="difflineminus">-    } else {</span>
<a href="#l39.1042"></a><span id="l39.1042" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received tasks&quot;);</span>
<a href="#l39.1043"></a><span id="l39.1043" class="difflineminus">-</span>
<a href="#l39.1044"></a><span id="l39.1044" class="difflineminus">-      let total = aData.items.length;</span>
<a href="#l39.1045"></a><span id="l39.1045" class="difflineminus">-      let committedUnits = 0;</span>
<a href="#l39.1046"></a><span id="l39.1046" class="difflineminus">-      this.activity.addTotal(total);</span>
<a href="#l39.1047"></a><span id="l39.1047" class="difflineminus">-</span>
<a href="#l39.1048"></a><span id="l39.1048" class="difflineminus">-      for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l39.1049"></a><span id="l39.1049" class="difflineminus">-        let entry = aData.items[cur];</span>
<a href="#l39.1050"></a><span id="l39.1050" class="difflineminus">-        // let metaData = Object.create(null);</span>
<a href="#l39.1051"></a><span id="l39.1051" class="difflineminus">-        let metaData = {};</span>
<a href="#l39.1052"></a><span id="l39.1052" class="difflineminus">-        let item = JSONToTask(entry, this.calendar, null, null, metaData);</span>
<a href="#l39.1053"></a><span id="l39.1053" class="difflineminus">-        this.metaData[item.hashId] = metaData;</span>
<a href="#l39.1054"></a><span id="l39.1054" class="difflineminus">-</span>
<a href="#l39.1055"></a><span id="l39.1055" class="difflineminus">-        await this.commitItem(item);</span>
<a href="#l39.1056"></a><span id="l39.1056" class="difflineminus">-</span>
<a href="#l39.1057"></a><span id="l39.1057" class="difflineminus">-        if (await spinEventLoop()) {</span>
<a href="#l39.1058"></a><span id="l39.1058" class="difflineminus">-          this.activity.addProgress(cur - committedUnits);</span>
<a href="#l39.1059"></a><span id="l39.1059" class="difflineminus">-          committedUnits = cur;</span>
<a href="#l39.1060"></a><span id="l39.1060" class="difflineminus">-        }</span>
<a href="#l39.1061"></a><span id="l39.1061" class="difflineminus">-      }</span>
<a href="#l39.1062"></a><span id="l39.1062" class="difflineminus">-    }</span>
<a href="#l39.1063"></a><span id="l39.1063" class="difflineminus">-  },</span>
<a href="#l39.1064"></a><span id="l39.1064" class="difflineminus">-</span>
<a href="#l39.1065"></a><span id="l39.1065" class="difflineminus">-  /**</span>
<a href="#l39.1066"></a><span id="l39.1066" class="difflineminus">-   * Parse the response from Google's list command into events.</span>
<a href="#l39.1067"></a><span id="l39.1067" class="difflineminus">-   *</span>
<a href="#l39.1068"></a><span id="l39.1068" class="difflineminus">-   * @param aData         The JS Object from the list response.</span>
<a href="#l39.1069"></a><span id="l39.1069" class="difflineminus">-   * @return              A promise resolved when completed.</span>
<a href="#l39.1070"></a><span id="l39.1070" class="difflineminus">-   */</span>
<a href="#l39.1071"></a><span id="l39.1071" class="difflineminus">-  parseEventStream: async function(aData) {</span>
<a href="#l39.1072"></a><span id="l39.1072" class="difflineminus">-    if (aData.timeZone) {</span>
<a href="#l39.1073"></a><span id="l39.1073" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Timezone for &quot; + this.calendar.name + &quot; is &quot; + aData.timeZone);</span>
<a href="#l39.1074"></a><span id="l39.1074" class="difflineminus">-      this.calendar.setProperty(&quot;settings.timeZone&quot;, aData.timeZone);</span>
<a href="#l39.1075"></a><span id="l39.1075" class="difflineminus">-    }</span>
<a href="#l39.1076"></a><span id="l39.1076" class="difflineminus">-</span>
<a href="#l39.1077"></a><span id="l39.1077" class="difflineminus">-    if (!aData.items || !aData.items.length) {</span>
<a href="#l39.1078"></a><span id="l39.1078" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] No events have been changed on &quot; + this.calendar.name);</span>
<a href="#l39.1079"></a><span id="l39.1079" class="difflineminus">-      return;</span>
<a href="#l39.1080"></a><span id="l39.1080" class="difflineminus">-    } else {</span>
<a href="#l39.1081"></a><span id="l39.1081" class="difflineminus">-      cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received events&quot;);</span>
<a href="#l39.1082"></a><span id="l39.1082" class="difflineminus">-    }</span>
<a href="#l39.1083"></a><span id="l39.1083" class="difflineminus">-</span>
<a href="#l39.1084"></a><span id="l39.1084" class="difflineminus">-    let exceptionItems = [];</span>
<a href="#l39.1085"></a><span id="l39.1085" class="difflineminus">-    let defaultReminders = (aData.defaultReminders || []).map(reminder =&gt;</span>
<a href="#l39.1086"></a><span id="l39.1086" class="difflineminus">-      JSONToAlarm(reminder, true)</span>
<a href="#l39.1087"></a><span id="l39.1087" class="difflineminus">-    );</span>
<a href="#l39.1088"></a><span id="l39.1088" class="difflineminus">-</span>
<a href="#l39.1089"></a><span id="l39.1089" class="difflineminus">-    // In the first pass, we go through the data and sort into master items and</span>
<a href="#l39.1090"></a><span id="l39.1090" class="difflineminus">-    // exception items, as the master item might be after the exception in the</span>
<a href="#l39.1091"></a><span id="l39.1091" class="difflineminus">-    // stream.</span>
<a href="#l39.1092"></a><span id="l39.1092" class="difflineminus">-</span>
<a href="#l39.1093"></a><span id="l39.1093" class="difflineminus">-    let total = aData.items.length;</span>
<a href="#l39.1094"></a><span id="l39.1094" class="difflineminus">-    let committedUnits = 0;</span>
<a href="#l39.1095"></a><span id="l39.1095" class="difflineminus">-    this.activity.addTotal(total);</span>
<a href="#l39.1096"></a><span id="l39.1096" class="difflineminus">-</span>
<a href="#l39.1097"></a><span id="l39.1097" class="difflineminus">-    for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l39.1098"></a><span id="l39.1098" class="difflineminus">-      let entry = aData.items[cur];</span>
<a href="#l39.1099"></a><span id="l39.1099" class="difflineminus">-      let metaData = Object.create(null);</span>
<a href="#l39.1100"></a><span id="l39.1100" class="difflineminus">-      let item = JSONToEvent(entry, this.calendar, defaultReminders, null, metaData);</span>
<a href="#l39.1101"></a><span id="l39.1101" class="difflineminus">-      LOGitem(item);</span>
<a href="#l39.1102"></a><span id="l39.1102" class="difflineminus">-</span>
<a href="#l39.1103"></a><span id="l39.1103" class="difflineminus">-      this.metaData[item.hashId] = metaData;</span>
<a href="#l39.1104"></a><span id="l39.1104" class="difflineminus">-</span>
<a href="#l39.1105"></a><span id="l39.1105" class="difflineminus">-      if (item.recurrenceId) {</span>
<a href="#l39.1106"></a><span id="l39.1106" class="difflineminus">-        exceptionItems.push(item);</span>
<a href="#l39.1107"></a><span id="l39.1107" class="difflineminus">-      } else {</span>
<a href="#l39.1108"></a><span id="l39.1108" class="difflineminus">-        this.masterItems[item.id] = item;</span>
<a href="#l39.1109"></a><span id="l39.1109" class="difflineminus">-        await this.commitItem(item);</span>
<a href="#l39.1110"></a><span id="l39.1110" class="difflineminus">-      }</span>
<a href="#l39.1111"></a><span id="l39.1111" class="difflineminus">-</span>
<a href="#l39.1112"></a><span id="l39.1112" class="difflineminus">-      if (await spinEventLoop()) {</span>
<a href="#l39.1113"></a><span id="l39.1113" class="difflineminus">-        this.activity.addProgress(cur - committedUnits);</span>
<a href="#l39.1114"></a><span id="l39.1114" class="difflineminus">-        committedUnits = cur;</span>
<a href="#l39.1115"></a><span id="l39.1115" class="difflineminus">-      }</span>
<a href="#l39.1116"></a><span id="l39.1116" class="difflineminus">-    }</span>
<a href="#l39.1117"></a><span id="l39.1117" class="difflineminus">-</span>
<a href="#l39.1118"></a><span id="l39.1118" class="difflineminus">-    // Go through all exceptions and attempt to find the master item in the</span>
<a href="#l39.1119"></a><span id="l39.1119" class="difflineminus">-    // item stream. If it can't be found there, the offline storage is asked</span>
<a href="#l39.1120"></a><span id="l39.1120" class="difflineminus">-    // for the parent item. If it still can't be found, then we have to do</span>
<a href="#l39.1121"></a><span id="l39.1121" class="difflineminus">-    // this at the end.</span>
<a href="#l39.1122"></a><span id="l39.1122" class="difflineminus">-    for (let exc of exceptionItems) {</span>
<a href="#l39.1123"></a><span id="l39.1123" class="difflineminus">-      // If we have the master item in our cache then use it. Otherwise</span>
<a href="#l39.1124"></a><span id="l39.1124" class="difflineminus">-      // attempt to get it from the offline storage.</span>
<a href="#l39.1125"></a><span id="l39.1125" class="difflineminus">-      let item;</span>
<a href="#l39.1126"></a><span id="l39.1126" class="difflineminus">-      if (exc.id in this.masterItems) {</span>
<a href="#l39.1127"></a><span id="l39.1127" class="difflineminus">-        item = this.masterItems[exc.id];</span>
<a href="#l39.1128"></a><span id="l39.1128" class="difflineminus">-      } else {</span>
<a href="#l39.1129"></a><span id="l39.1129" class="difflineminus">-        item = (await this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l39.1130"></a><span id="l39.1130" class="difflineminus">-      }</span>
<a href="#l39.1131"></a><span id="l39.1131" class="difflineminus">-</span>
<a href="#l39.1132"></a><span id="l39.1132" class="difflineminus">-      // If an item was found, we can process this exception. Otherwise</span>
<a href="#l39.1133"></a><span id="l39.1133" class="difflineminus">-      // save it for later, maybe its on the next page of the request.</span>
<a href="#l39.1134"></a><span id="l39.1134" class="difflineminus">-      if (item) {</span>
<a href="#l39.1135"></a><span id="l39.1135" class="difflineminus">-        if (!item.isMutable) {</span>
<a href="#l39.1136"></a><span id="l39.1136" class="difflineminus">-          item = item.clone();</span>
<a href="#l39.1137"></a><span id="l39.1137" class="difflineminus">-        }</span>
<a href="#l39.1138"></a><span id="l39.1138" class="difflineminus">-        await this.processException(exc, item);</span>
<a href="#l39.1139"></a><span id="l39.1139" class="difflineminus">-      } else {</span>
<a href="#l39.1140"></a><span id="l39.1140" class="difflineminus">-        this.missingParents.push(exc);</span>
<a href="#l39.1141"></a><span id="l39.1141" class="difflineminus">-      }</span>
<a href="#l39.1142"></a><span id="l39.1142" class="difflineminus">-</span>
<a href="#l39.1143"></a><span id="l39.1143" class="difflineminus">-      await this.commitException(exc);</span>
<a href="#l39.1144"></a><span id="l39.1144" class="difflineminus">-    }</span>
<a href="#l39.1145"></a><span id="l39.1145" class="difflineminus">-  },</span>
<a href="#l39.1146"></a><span id="l39.1146" class="difflineminus">-</span>
<a href="#l39.1147"></a><span id="l39.1147" class="difflineminus">-  /**</span>
<a href="#l39.1148"></a><span id="l39.1148" class="difflineminus">-   * Handle the exception for the given item by committing it to the</span>
<a href="#l39.1149"></a><span id="l39.1149" class="difflineminus">-   * calendar.</span>
<a href="#l39.1150"></a><span id="l39.1150" class="difflineminus">-   *</span>
<a href="#l39.1151"></a><span id="l39.1151" class="difflineminus">-   * @param exc       The exception to process.</span>
<a href="#l39.1152"></a><span id="l39.1152" class="difflineminus">-   * @param item      The item the exception belongs to.</span>
<a href="#l39.1153"></a><span id="l39.1153" class="difflineminus">-   * @return          A promise resolved when the item is added to the</span>
<a href="#l39.1154"></a><span id="l39.1154" class="difflineminus">-   *                    calendar.</span>
<a href="#l39.1155"></a><span id="l39.1155" class="difflineminus">-   */</span>
<a href="#l39.1156"></a><span id="l39.1156" class="difflineminus">-  processException: function(exc, item) {</span>
<a href="#l39.1157"></a><span id="l39.1157" class="difflineminus">-    if (item.status == &quot;CANCELLED&quot;) {</span>
<a href="#l39.1158"></a><span id="l39.1158" class="difflineminus">-      // Cancelled master items don't have the full amount of</span>
<a href="#l39.1159"></a><span id="l39.1159" class="difflineminus">-      // information, specifically no recurrence info. Since they are</span>
<a href="#l39.1160"></a><span id="l39.1160" class="difflineminus">-      // cancelled anyway, we can just ignore processing this exception.</span>
<a href="#l39.1161"></a><span id="l39.1161" class="difflineminus">-      return Promise.resolve();</span>
<a href="#l39.1162"></a><span id="l39.1162" class="difflineminus">-    }</span>
<a href="#l39.1163"></a><span id="l39.1163" class="difflineminus">-</span>
<a href="#l39.1164"></a><span id="l39.1164" class="difflineminus">-    exc.parentItem = item;</span>
<a href="#l39.1165"></a><span id="l39.1165" class="difflineminus">-    if (exc.status == &quot;CANCELLED&quot;) {</span>
<a href="#l39.1166"></a><span id="l39.1166" class="difflineminus">-      // Canceled means the occurrence is an EXDATE.</span>
<a href="#l39.1167"></a><span id="l39.1167" class="difflineminus">-      item.recurrenceInfo.removeOccurrenceAt(exc.recurrenceId);</span>
<a href="#l39.1168"></a><span id="l39.1168" class="difflineminus">-    } else {</span>
<a href="#l39.1169"></a><span id="l39.1169" class="difflineminus">-      // Not canceled means the occurrence was modified.</span>
<a href="#l39.1170"></a><span id="l39.1170" class="difflineminus">-      item.recurrenceInfo.modifyException(exc, true);</span>
<a href="#l39.1171"></a><span id="l39.1171" class="difflineminus">-    }</span>
<a href="#l39.1172"></a><span id="l39.1172" class="difflineminus">-    this.masterItems[item.id] = item;</span>
<a href="#l39.1173"></a><span id="l39.1173" class="difflineminus">-    return this.commitItem(item);</span>
<a href="#l39.1174"></a><span id="l39.1174" class="difflineminus">-  },</span>
<a href="#l39.1175"></a><span id="l39.1175" class="difflineminus">-</span>
<a href="#l39.1176"></a><span id="l39.1176" class="difflineminus">-  /**</span>
<a href="#l39.1177"></a><span id="l39.1177" class="difflineminus">-   * Handle final tasks for the exception. This means saving the metadat for the exception.</span>
<a href="#l39.1178"></a><span id="l39.1178" class="difflineminus">-   *</span>
<a href="#l39.1179"></a><span id="l39.1179" class="difflineminus">-   * @param exc       The exception to process.</span>
<a href="#l39.1180"></a><span id="l39.1180" class="difflineminus">-   */</span>
<a href="#l39.1181"></a><span id="l39.1181" class="difflineminus">-  commitException: function(exc) {</span>
<a href="#l39.1182"></a><span id="l39.1182" class="difflineminus">-    // Make sure we also save the etag of the exception for a future request.</span>
<a href="#l39.1183"></a><span id="l39.1183" class="difflineminus">-    if (exc.hashId in this.metaData) {</span>
<a href="#l39.1184"></a><span id="l39.1184" class="difflineminus">-      saveItemMetadata(this.offlineStorage, exc.hashId, this.metaData[exc.hashId]);</span>
<a href="#l39.1185"></a><span id="l39.1185" class="difflineminus">-    }</span>
<a href="#l39.1186"></a><span id="l39.1186" class="difflineminus">-  },</span>
<a href="#l39.1187"></a><span id="l39.1187" class="difflineminus">-</span>
<a href="#l39.1188"></a><span id="l39.1188" class="difflineminus">-  /**</span>
<a href="#l39.1189"></a><span id="l39.1189" class="difflineminus">-   * Handle adding the item to the calendar, or removing it if its a cancelled item.</span>
<a href="#l39.1190"></a><span id="l39.1190" class="difflineminus">-   *</span>
<a href="#l39.1191"></a><span id="l39.1191" class="difflineminus">-   * @param item      The item to process.</span>
<a href="#l39.1192"></a><span id="l39.1192" class="difflineminus">-   * @return          A promise resolved when the process is completed.</span>
<a href="#l39.1193"></a><span id="l39.1193" class="difflineminus">-   */</span>
<a href="#l39.1194"></a><span id="l39.1194" class="difflineminus">-  commitItem: async function(item) {</span>
<a href="#l39.1195"></a><span id="l39.1195" class="difflineminus">-    // This is a normal item. If it was canceled, then it should be</span>
<a href="#l39.1196"></a><span id="l39.1196" class="difflineminus">-    // deleted, otherwise it should be either added or modified. The</span>
<a href="#l39.1197"></a><span id="l39.1197" class="difflineminus">-    // relaxed mode of the destination calendar takes care of the latter</span>
<a href="#l39.1198"></a><span id="l39.1198" class="difflineminus">-    // two cases.</span>
<a href="#l39.1199"></a><span id="l39.1199" class="difflineminus">-    if (item.status == &quot;CANCELLED&quot;) {</span>
<a href="#l39.1200"></a><span id="l39.1200" class="difflineminus">-      await this.promiseOfflineStorage.deleteItem(item);</span>
<a href="#l39.1201"></a><span id="l39.1201" class="difflineminus">-    } else {</span>
<a href="#l39.1202"></a><span id="l39.1202" class="difflineminus">-      await this.promiseOfflineStorage.modifyItem(item, null);</span>
<a href="#l39.1203"></a><span id="l39.1203" class="difflineminus">-    }</span>
<a href="#l39.1204"></a><span id="l39.1204" class="difflineminus">-</span>
<a href="#l39.1205"></a><span id="l39.1205" class="difflineminus">-    if (item.hashId in this.metaData) {</span>
<a href="#l39.1206"></a><span id="l39.1206" class="difflineminus">-      // Make sure the metadata is up to date for the next request</span>
<a href="#l39.1207"></a><span id="l39.1207" class="difflineminus">-      saveItemMetadata(this.offlineStorage, item.hashId, this.metaData[item.hashId]);</span>
<a href="#l39.1208"></a><span id="l39.1208" class="difflineminus">-    }</span>
<a href="#l39.1209"></a><span id="l39.1209" class="difflineminus">-  },</span>
<a href="#l39.1210"></a><span id="l39.1210" class="difflineminus">-</span>
<a href="#l39.1211"></a><span id="l39.1211" class="difflineminus">-  /**</span>
<a href="#l39.1212"></a><span id="l39.1212" class="difflineminus">-   * Complete the item saving, this will take care of all steps required</span>
<a href="#l39.1213"></a><span id="l39.1213" class="difflineminus">-   * after the last request.</span>
<a href="#l39.1214"></a><span id="l39.1214" class="difflineminus">-   */</span>
<a href="#l39.1215"></a><span id="l39.1215" class="difflineminus">-  complete: function() {</span>
<a href="#l39.1216"></a><span id="l39.1216" class="difflineminus">-    return this.processRemainingExceptions().then(() =&gt; {</span>
<a href="#l39.1217"></a><span id="l39.1217" class="difflineminus">-      this.activity.complete();</span>
<a href="#l39.1218"></a><span id="l39.1218" class="difflineminus">-    });</span>
<a href="#l39.1219"></a><span id="l39.1219" class="difflineminus">-  },</span>
<a href="#l39.1220"></a><span id="l39.1220" class="difflineminus">-</span>
<a href="#l39.1221"></a><span id="l39.1221" class="difflineminus">-  /**</span>
<a href="#l39.1222"></a><span id="l39.1222" class="difflineminus">-   * Handle all remaining exceptions in the item saver. Ensures that any</span>
<a href="#l39.1223"></a><span id="l39.1223" class="difflineminus">-   * missing master items are searched for or created.</span>
<a href="#l39.1224"></a><span id="l39.1224" class="difflineminus">-   *</span>
<a href="#l39.1225"></a><span id="l39.1225" class="difflineminus">-   * @return          A promise resolved on completion</span>
<a href="#l39.1226"></a><span id="l39.1226" class="difflineminus">-   */</span>
<a href="#l39.1227"></a><span id="l39.1227" class="difflineminus">-  processRemainingExceptions: async function() {</span>
<a href="#l39.1228"></a><span id="l39.1228" class="difflineminus">-    for (let exc of this.missingParents) {</span>
<a href="#l39.1229"></a><span id="l39.1229" class="difflineminus">-      let item = (await this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l39.1230"></a><span id="l39.1230" class="difflineminus">-      if (item) {</span>
<a href="#l39.1231"></a><span id="l39.1231" class="difflineminus">-        await this.processException(exc, item);</span>
<a href="#l39.1232"></a><span id="l39.1232" class="difflineminus">-      } else if (exc.status != &quot;CANCELLED&quot;) {</span>
<a href="#l39.1233"></a><span id="l39.1233" class="difflineminus">-        // If the item could not be found, it could be that the</span>
<a href="#l39.1234"></a><span id="l39.1234" class="difflineminus">-        // user is invited to an instance of a recurring event.</span>
<a href="#l39.1235"></a><span id="l39.1235" class="difflineminus">-        // Unless this is a cancelled exception, create a mock</span>
<a href="#l39.1236"></a><span id="l39.1236" class="difflineminus">-        // parent item with one positive RDATE.</span>
<a href="#l39.1237"></a><span id="l39.1237" class="difflineminus">-        let parent = exc.clone();</span>
<a href="#l39.1238"></a><span id="l39.1238" class="difflineminus">-        parent.recurrenceId = null;</span>
<a href="#l39.1239"></a><span id="l39.1239" class="difflineminus">-        parent.calendar = this.calendar.superCalendar;</span>
<a href="#l39.1240"></a><span id="l39.1240" class="difflineminus">-        parent.startDate = exc.recurrenceId.clone();</span>
<a href="#l39.1241"></a><span id="l39.1241" class="difflineminus">-        parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;);</span>
<a href="#l39.1242"></a><span id="l39.1242" class="difflineminus">-        if (!parent.id) {</span>
<a href="#l39.1243"></a><span id="l39.1243" class="difflineminus">-          // Exceptions often don't have the iCalUID field set,</span>
<a href="#l39.1244"></a><span id="l39.1244" class="difflineminus">-          // we need to fake it from the google id.</span>
<a href="#l39.1245"></a><span id="l39.1245" class="difflineminus">-          let meta = this.metaData[exc.hashId];</span>
<a href="#l39.1246"></a><span id="l39.1246" class="difflineminus">-          parent.id = meta.path + &quot;@google.com&quot;;</span>
<a href="#l39.1247"></a><span id="l39.1247" class="difflineminus">-        }</span>
<a href="#l39.1248"></a><span id="l39.1248" class="difflineminus">-        parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l39.1249"></a><span id="l39.1249" class="difflineminus">-        let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(</span>
<a href="#l39.1250"></a><span id="l39.1250" class="difflineminus">-          Ci.calIRecurrenceDate</span>
<a href="#l39.1251"></a><span id="l39.1251" class="difflineminus">-        );</span>
<a href="#l39.1252"></a><span id="l39.1252" class="difflineminus">-        rdate.date = exc.recurrenceId;</span>
<a href="#l39.1253"></a><span id="l39.1253" class="difflineminus">-        parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l39.1254"></a><span id="l39.1254" class="difflineminus">-        await this.commitItem(parent);</span>
<a href="#l39.1255"></a><span id="l39.1255" class="difflineminus">-      }</span>
<a href="#l39.1256"></a><span id="l39.1256" class="difflineminus">-    }</span>
<a href="#l39.1257"></a><span id="l39.1257" class="difflineminus">-  },</span>
<a href="#l39.1258"></a><span id="l39.1258" class="difflineminus">-};</span>
<a href="#l39.1259"></a><span id="l39.1259" class="difflineminus">-</span>
<a href="#l39.1260"></a><span id="l39.1260" class="difflineminus">-/**</span>
<a href="#l39.1261"></a><span id="l39.1261" class="difflineminus">- * A wrapper for nsIActivity to handle the synchronization process.</span>
<a href="#l39.1262"></a><span id="l39.1262" class="difflineminus">- *</span>
<a href="#l39.1263"></a><span id="l39.1263" class="difflineminus">- * @param aCalendar     The calendar for this activity.</span>
<a href="#l39.1264"></a><span id="l39.1264" class="difflineminus">- */</span>
<a href="#l39.1265"></a><span id="l39.1265" class="difflineminus">-function ActivityShell(aCalendar) {</span>
<a href="#l39.1266"></a><span id="l39.1266" class="difflineminus">-  this.calendar = aCalendar;</span>
<a href="#l39.1267"></a><span id="l39.1267" class="difflineminus">-</span>
<a href="#l39.1268"></a><span id="l39.1268" class="difflineminus">-  if (&quot;@mozilla.org/activity-process;1&quot; in Cc) {</span>
<a href="#l39.1269"></a><span id="l39.1269" class="difflineminus">-    this.init();</span>
<a href="#l39.1270"></a><span id="l39.1270" class="difflineminus">-  }</span>
<a href="#l39.1271"></a><span id="l39.1271" class="difflineminus">-}</span>
<a href="#l39.1272"></a><span id="l39.1272" class="difflineminus">-</span>
<a href="#l39.1273"></a><span id="l39.1273" class="difflineminus">-ActivityShell.prototype = {</span>
<a href="#l39.1274"></a><span id="l39.1274" class="difflineminus">-  act: null,</span>
<a href="#l39.1275"></a><span id="l39.1275" class="difflineminus">-  actMgr: null,</span>
<a href="#l39.1276"></a><span id="l39.1276" class="difflineminus">-  calendar: null,</span>
<a href="#l39.1277"></a><span id="l39.1277" class="difflineminus">-  type: null,</span>
<a href="#l39.1278"></a><span id="l39.1278" class="difflineminus">-</span>
<a href="#l39.1279"></a><span id="l39.1279" class="difflineminus">-  init: function() {</span>
<a href="#l39.1280"></a><span id="l39.1280" class="difflineminus">-    this.actMgr = Cc[&quot;@mozilla.org/activity-manager;1&quot;].getService(Ci.nsIActivityManager);</span>
<a href="#l39.1281"></a><span id="l39.1281" class="difflineminus">-    this.act = Cc[&quot;@mozilla.org/activity-process;1&quot;].createInstance(Ci.nsIActivityProcess);</span>
<a href="#l39.1282"></a><span id="l39.1282" class="difflineminus">-    this.act.init(getProviderString(&quot;syncStatus&quot;, this.calendar.name), this);</span>
<a href="#l39.1283"></a><span id="l39.1283" class="difflineminus">-    this.act.iconClass = &quot;syncMail&quot;;</span>
<a href="#l39.1284"></a><span id="l39.1284" class="difflineminus">-    this.act.contextType = &quot;gdata-calendar&quot;;</span>
<a href="#l39.1285"></a><span id="l39.1285" class="difflineminus">-    this.act.contextObj = this.calendar;</span>
<a href="#l39.1286"></a><span id="l39.1286" class="difflineminus">-    this.act.contextDisplayText = this.calendar.name;</span>
<a href="#l39.1287"></a><span id="l39.1287" class="difflineminus">-    this.act.state = Ci.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l39.1288"></a><span id="l39.1288" class="difflineminus">-</span>
<a href="#l39.1289"></a><span id="l39.1289" class="difflineminus">-    this.actMgr.addActivity(this.act);</span>
<a href="#l39.1290"></a><span id="l39.1290" class="difflineminus">-  },</span>
<a href="#l39.1291"></a><span id="l39.1291" class="difflineminus">-</span>
<a href="#l39.1292"></a><span id="l39.1292" class="difflineminus">-  addProgress: function(units) {</span>
<a href="#l39.1293"></a><span id="l39.1293" class="difflineminus">-    if (!this.act) {</span>
<a href="#l39.1294"></a><span id="l39.1294" class="difflineminus">-      return;</span>
<a href="#l39.1295"></a><span id="l39.1295" class="difflineminus">-    }</span>
<a href="#l39.1296"></a><span id="l39.1296" class="difflineminus">-    this.setProgress(this.act.workUnitComplete + units, this.act.totalWorkUnits);</span>
<a href="#l39.1297"></a><span id="l39.1297" class="difflineminus">-  },</span>
<a href="#l39.1298"></a><span id="l39.1298" class="difflineminus">-</span>
<a href="#l39.1299"></a><span id="l39.1299" class="difflineminus">-  addTotal: function(units) {</span>
<a href="#l39.1300"></a><span id="l39.1300" class="difflineminus">-    if (!this.act) {</span>
<a href="#l39.1301"></a><span id="l39.1301" class="difflineminus">-      return;</span>
<a href="#l39.1302"></a><span id="l39.1302" class="difflineminus">-    }</span>
<a href="#l39.1303"></a><span id="l39.1303" class="difflineminus">-    this.setProgress(this.act.workUnitComplete, this.act.totalWorkUnits + units);</span>
<a href="#l39.1304"></a><span id="l39.1304" class="difflineminus">-  },</span>
<a href="#l39.1305"></a><span id="l39.1305" class="difflineminus">-</span>
<a href="#l39.1306"></a><span id="l39.1306" class="difflineminus">-  setProgress: function(cur, total) {</span>
<a href="#l39.1307"></a><span id="l39.1307" class="difflineminus">-    if (!this.act) {</span>
<a href="#l39.1308"></a><span id="l39.1308" class="difflineminus">-      return;</span>
<a href="#l39.1309"></a><span id="l39.1309" class="difflineminus">-    }</span>
<a href="#l39.1310"></a><span id="l39.1310" class="difflineminus">-    let str = getProviderString(&quot;syncProgress&quot; + this.type, this.calendar.name, cur, total);</span>
<a href="#l39.1311"></a><span id="l39.1311" class="difflineminus">-    this.act.setProgress(str, cur, total);</span>
<a href="#l39.1312"></a><span id="l39.1312" class="difflineminus">-  },</span>
<a href="#l39.1313"></a><span id="l39.1313" class="difflineminus">-</span>
<a href="#l39.1314"></a><span id="l39.1314" class="difflineminus">-  complete: function() {</span>
<a href="#l39.1315"></a><span id="l39.1315" class="difflineminus">-    if (!this.act) {</span>
<a href="#l39.1316"></a><span id="l39.1316" class="difflineminus">-      return;</span>
<a href="#l39.1317"></a><span id="l39.1317" class="difflineminus">-    }</span>
<a href="#l39.1318"></a><span id="l39.1318" class="difflineminus">-    let total = this.act.totalWorkUnits;</span>
<a href="#l39.1319"></a><span id="l39.1319" class="difflineminus">-    this.act.setProgress(&quot;&quot;, total, total);</span>
<a href="#l39.1320"></a><span id="l39.1320" class="difflineminus">-    this.act.state = Ci.nsIActivityProcess.STATE_COMPLETED;</span>
<a href="#l39.1321"></a><span id="l39.1321" class="difflineminus">-    this.actMgr.removeActivity(this.act.id);</span>
<a href="#l39.1322"></a><span id="l39.1322" class="difflineminus">-  },</span>
<a href="#l39.1323"></a><span id="l39.1323" class="difflineminus">-};</span>
<a href="#l39.1324"></a><span id="l39.1324" class="difflineminus">-</span>
<a href="#l39.1325"></a><span id="l39.1325" class="difflineminus">-/**</span>
<a href="#l39.1326"></a><span id="l39.1326" class="difflineminus">- * Check if the response is a conflict and handle asking the user what to do</span>
<a href="#l39.1327"></a><span id="l39.1327" class="difflineminus">- * about it. Will resolve if there is no conflict or with new item data.</span>
<a href="#l39.1328"></a><span id="l39.1328" class="difflineminus">- * where status is a conflict status, see the end of this function.</span>
<a href="#l39.1329"></a><span id="l39.1329" class="difflineminus">- *</span>
<a href="#l39.1330"></a><span id="l39.1330" class="difflineminus">- * @param aOperation        The operation to check.</span>
<a href="#l39.1331"></a><span id="l39.1331" class="difflineminus">- * @param aCalendar         The calendar this operation happens in</span>
<a href="#l39.1332"></a><span id="l39.1332" class="difflineminus">- * @param aItem             The item that was passed to the server</span>
<a href="#l39.1333"></a><span id="l39.1333" class="difflineminus">- * @return                  A promise resolved when the conflict has been resolved</span>
<a href="#l39.1334"></a><span id="l39.1334" class="difflineminus">- */</span>
<a href="#l39.1335"></a><span id="l39.1335" class="difflineminus">-async function checkResolveConflict(aOperation, aCalendar, aItem) {</span>
<a href="#l39.1336"></a><span id="l39.1336" class="difflineminus">-  cal.LOG(&quot;[calGoogleCalendar] A conflict occurred for &quot; + aItem.title);</span>
<a href="#l39.1337"></a><span id="l39.1337" class="difflineminus">-</span>
<a href="#l39.1338"></a><span id="l39.1338" class="difflineminus">-  let method = aOperation.type == aOperation.DELETE ? &quot;delete&quot; : &quot;modify&quot;;</span>
<a href="#l39.1339"></a><span id="l39.1339" class="difflineminus">-  let overwrite = cal.provider.promptOverwrite(method, aItem);</span>
<a href="#l39.1340"></a><span id="l39.1340" class="difflineminus">-  if (overwrite) {</span>
<a href="#l39.1341"></a><span id="l39.1341" class="difflineminus">-    // The user has decided to overwrite the server version. Send again</span>
<a href="#l39.1342"></a><span id="l39.1342" class="difflineminus">-    // overwriting the server version with If-Match: *</span>
<a href="#l39.1343"></a><span id="l39.1343" class="difflineminus">-    cal.LOG(&quot;[calGoogleCalendar] Resending &quot; + method + &quot; and ignoring ETag&quot;);</span>
<a href="#l39.1344"></a><span id="l39.1344" class="difflineminus">-    aOperation.addRequestHeader(&quot;If-Match&quot;, &quot;*&quot;);</span>
<a href="#l39.1345"></a><span id="l39.1345" class="difflineminus">-    try {</span>
<a href="#l39.1346"></a><span id="l39.1346" class="difflineminus">-      return await aCalendar.session.asyncItemRequest(aOperation);</span>
<a href="#l39.1347"></a><span id="l39.1347" class="difflineminus">-    } catch (e) {</span>
<a href="#l39.1348"></a><span id="l39.1348" class="difflineminus">-      if (e.result == calGoogleRequest.RESOURCE_GONE &amp;&amp; aOperation.type == aOperation.DELETE) {</span>
<a href="#l39.1349"></a><span id="l39.1349" class="difflineminus">-        // The item was deleted on the server and locally, we don't need to</span>
<a href="#l39.1350"></a><span id="l39.1350" class="difflineminus">-        // notify the user about this.</span>
<a href="#l39.1351"></a><span id="l39.1351" class="difflineminus">-        return null;</span>
<a href="#l39.1352"></a><span id="l39.1352" class="difflineminus">-      } else {</span>
<a href="#l39.1353"></a><span id="l39.1353" class="difflineminus">-        throw e;</span>
<a href="#l39.1354"></a><span id="l39.1354" class="difflineminus">-      }</span>
<a href="#l39.1355"></a><span id="l39.1355" class="difflineminus">-    }</span>
<a href="#l39.1356"></a><span id="l39.1356" class="difflineminus">-  } else {</span>
<a href="#l39.1357"></a><span id="l39.1357" class="difflineminus">-    // The user has decided to throw away changes, use our existing</span>
<a href="#l39.1358"></a><span id="l39.1358" class="difflineminus">-    // means to update the item locally.</span>
<a href="#l39.1359"></a><span id="l39.1359" class="difflineminus">-    cal.LOG(&quot;[calGoogleCalendar] Reload requested, cancelling change of &quot; + aItem.title);</span>
<a href="#l39.1360"></a><span id="l39.1360" class="difflineminus">-    aCalendar.superCalendar.refresh();</span>
<a href="#l39.1361"></a><span id="l39.1361" class="difflineminus">-    throw Components.Exception(null, Ci.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l39.1362"></a><span id="l39.1362" class="difflineminus">-  }</span>
<a href="#l39.1363"></a><span id="l39.1363" class="difflineminus">-}</span>
<a href="#l39.1364"></a><span id="l39.1364" class="difflineminus">-</span>
<a href="#l39.1365"></a><span id="l39.1365" class="difflineminus">-/**</span>
<a href="#l39.1366"></a><span id="l39.1366" class="difflineminus">- * Get a string from the gdata properties file</span>
<a href="#l39.1367"></a><span id="l39.1367" class="difflineminus">- *</span>
<a href="#l39.1368"></a><span id="l39.1368" class="difflineminus">- * @param aStringName  The name of the string within the properties file</span>
<a href="#l39.1369"></a><span id="l39.1369" class="difflineminus">- * @param ...aParams   Optional parameters to format the string</span>
<a href="#l39.1370"></a><span id="l39.1370" class="difflineminus">- * @return             The localized string value.</span>
<a href="#l39.1371"></a><span id="l39.1371" class="difflineminus">- */</span>
<a href="#l39.1372"></a><span id="l39.1372" class="difflineminus">-function getProviderString(aStringName, ...aParams) {</span>
<a href="#l39.1373"></a><span id="l39.1373" class="difflineminus">-  return cal.l10n.getAnyString(&quot;gdata-provider&quot;, &quot;gdata&quot;, aStringName, aParams);</span>
<a href="#l39.1374"></a><span id="l39.1374" class="difflineminus">-}</span>
<a href="#l39.1375"></a><span id="l39.1375" class="difflineminus">-</span>
<a href="#l39.1376"></a><span id="l39.1376" class="difflineminus">-/**</span>
<a href="#l39.1377"></a><span id="l39.1377" class="difflineminus">- * Monkey patch the function with the name x on obj and overwrite it with func.</span>
<a href="#l39.1378"></a><span id="l39.1378" class="difflineminus">- * The first parameter of this function is the original function that can be</span>
<a href="#l39.1379"></a><span id="l39.1379" class="difflineminus">- * called at any time.</span>
<a href="#l39.1380"></a><span id="l39.1380" class="difflineminus">- *</span>
<a href="#l39.1381"></a><span id="l39.1381" class="difflineminus">- * @param obj           The object the function is on.</span>
<a href="#l39.1382"></a><span id="l39.1382" class="difflineminus">- * @param name          The string name of the function.</span>
<a href="#l39.1383"></a><span id="l39.1383" class="difflineminus">- * @param func          The function to monkey patch with.</span>
<a href="#l39.1384"></a><span id="l39.1384" class="difflineminus">- */</span>
<a href="#l39.1385"></a><span id="l39.1385" class="difflineminus">-function monkeyPatch(obj, x, func) {</span>
<a href="#l39.1386"></a><span id="l39.1386" class="difflineminus">-  let old = obj[x];</span>
<a href="#l39.1387"></a><span id="l39.1387" class="difflineminus">-  obj[x] = function() {</span>
<a href="#l39.1388"></a><span id="l39.1388" class="difflineminus">-    let parent = old.bind(obj);</span>
<a href="#l39.1389"></a><span id="l39.1389" class="difflineminus">-    let args = Array.from(arguments);</span>
<a href="#l39.1390"></a><span id="l39.1390" class="difflineminus">-    args.unshift(parent);</span>
<a href="#l39.1391"></a><span id="l39.1391" class="difflineminus">-    try {</span>
<a href="#l39.1392"></a><span id="l39.1392" class="difflineminus">-      return func.apply(obj, args);</span>
<a href="#l39.1393"></a><span id="l39.1393" class="difflineminus">-    } catch (e) {</span>
<a href="#l39.1394"></a><span id="l39.1394" class="difflineminus">-      Cu.reportError(e);</span>
<a href="#l39.1395"></a><span id="l39.1395" class="difflineminus">-      throw e;</span>
<a href="#l39.1396"></a><span id="l39.1396" class="difflineminus">-    }</span>
<a href="#l39.1397"></a><span id="l39.1397" class="difflineminus">-  };</span>
<a href="#l39.1398"></a><span id="l39.1398" class="difflineminus">-}</span>
<a href="#l39.1399"></a><span id="l39.1399" class="difflineminus">-</span>
<a href="#l39.1400"></a><span id="l39.1400" class="difflineminus">-/**</span>
<a href="#l39.1401"></a><span id="l39.1401" class="difflineminus">- * Returns a promise that resolves after pending events have been processed.</span>
<a href="#l39.1402"></a><span id="l39.1402" class="difflineminus">- */</span>
<a href="#l39.1403"></a><span id="l39.1403" class="difflineminus">-function spinEventLoop() {</span>
<a href="#l39.1404"></a><span id="l39.1404" class="difflineminus">-  let diff = new Date() - spinEventLoop.lastSpin;</span>
<a href="#l39.1405"></a><span id="l39.1405" class="difflineminus">-  if (diff &lt; Services.prefs.getIntPref(&quot;calendar.threading.latency&quot;, 250)) {</span>
<a href="#l39.1406"></a><span id="l39.1406" class="difflineminus">-    return Promise.resolve(false);</span>
<a href="#l39.1407"></a><span id="l39.1407" class="difflineminus">-  }</span>
<a href="#l39.1408"></a><span id="l39.1408" class="difflineminus">-  spinEventLoop.lastSpin = new Date();</span>
<a href="#l39.1409"></a><span id="l39.1409" class="difflineminus">-</span>
<a href="#l39.1410"></a><span id="l39.1410" class="difflineminus">-  let deferred = PromiseUtils.defer();</span>
<a href="#l39.1411"></a><span id="l39.1411" class="difflineminus">-  Services.tm.currentThread.dispatch(</span>
<a href="#l39.1412"></a><span id="l39.1412" class="difflineminus">-    {</span>
<a href="#l39.1413"></a><span id="l39.1413" class="difflineminus">-      run: function() {</span>
<a href="#l39.1414"></a><span id="l39.1414" class="difflineminus">-        return deferred.resolve(true);</span>
<a href="#l39.1415"></a><span id="l39.1415" class="difflineminus">-      },</span>
<a href="#l39.1416"></a><span id="l39.1416" class="difflineminus">-    },</span>
<a href="#l39.1417"></a><span id="l39.1417" class="difflineminus">-    0</span>
<a href="#l39.1418"></a><span id="l39.1418" class="difflineminus">-  );</span>
<a href="#l39.1419"></a><span id="l39.1419" class="difflineminus">-  return deferred.promise;</span>
<a href="#l39.1420"></a><span id="l39.1420" class="difflineminus">-}</span>
<a href="#l39.1421"></a><span id="l39.1421" class="difflineminus">-spinEventLoop.lastSpin = new Date();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- a/calendar/providers/gdata/modules/timezoneMap.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ /dev/null</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -1,142 +0,0 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-// Mappings Copyright © 1991-2013 Unicode, Inc. with modifications.</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">-// http://unicode.org/repos/cldr/trunk/common/supplemental/windowsZones.xml</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">-</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;windowsTimezoneMap&quot;];</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-var windowsTimezoneMap = {</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-  &quot;Afghanistan Standard Time&quot;: &quot;Asia/Kabul&quot;,</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  &quot;Alaskan Standard Time&quot;: &quot;America/Anchorage&quot;,</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-  &quot;Aleutian Standard Time&quot;: &quot;America/Adak&quot;,</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-  &quot;Altai Standard Time&quot;: &quot;Asia/Barnaul&quot;,</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-  &quot;Arab Standard Time&quot;: &quot;Asia/Riyadh&quot;,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-  &quot;Arabian Standard Time&quot;: &quot;Asia/Dubai&quot;,</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-  &quot;Arabic Standard Time&quot;: &quot;Asia/Baghdad&quot;,</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-  &quot;Argentina Standard Time&quot;: &quot;America/Buenos_Aires&quot;,</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-  &quot;Armenian Standard Time&quot;: &quot;Asia/Yerevan&quot;,</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-  &quot;Astrakhan Standard Time&quot;: &quot;Europe/Astrakhan&quot;,</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-  &quot;Atlantic Standard Time&quot;: &quot;America/Halifax&quot;,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-  &quot;AUS Central Standard Time&quot;: &quot;Australia/Darwin&quot;,</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-  &quot;Aus Central W. Standard Time&quot;: &quot;Australia/Eucla&quot;,</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-  &quot;AUS Eastern Standard Time&quot;: &quot;Australia/Sydney&quot;,</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-  &quot;Azerbaijan Standard Time&quot;: &quot;Asia/Baku&quot;,</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-  &quot;Azores Standard Time&quot;: &quot;Atlantic/Azores&quot;,</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-  &quot;Bahia Standard Time&quot;: &quot;America/Bahia&quot;,</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-  &quot;Bangkok Standard Time&quot;: &quot;Asia/Bangkok&quot;,</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-  &quot;Bangladesh Standard Time&quot;: &quot;Asia/Dhaka&quot;,</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-  &quot;Belarus Standard Time&quot;: &quot;Europe/Minsk&quot;,</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-  &quot;Bougainville Standard Time&quot;: &quot;Pacific/Bougainville&quot;,</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-  &quot;Canada Central Standard Time&quot;: &quot;America/Regina&quot;,</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-  &quot;Cape Verde Standard Time&quot;: &quot;Atlantic/Cape_Verde&quot;,</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-  &quot;Caucasus Standard Time&quot;: &quot;Asia/Yerevan&quot;,</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-  &quot;Cen. Australia Standard Time&quot;: &quot;Australia/Adelaide&quot;,</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-  &quot;Central America Standard Time&quot;: &quot;America/Guatemala&quot;,</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineminus">-  &quot;Central Asia Standard Time&quot;: &quot;Asia/Almaty&quot;,</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineminus">-  &quot;Central Brazilian Standard Time&quot;: &quot;America/Cuiaba&quot;,</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-  &quot;Central Europe Standard Time&quot;: &quot;Europe/Prague&quot;,</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">-  &quot;Central European Standard Time&quot;: &quot;Europe/Warsaw&quot;,</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-  &quot;Central Pacific Standard Time&quot;: &quot;Pacific/Guadalcanal&quot;,</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-  &quot;Central Standard Time (Mexico)&quot;: &quot;America/Mexico_City&quot;,</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-  &quot;Central Standard Time&quot;: &quot;America/Chicago&quot;,</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-  &quot;Chatham Islands Standard Time&quot;: &quot;Pacific/Chatham&quot;,</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineminus">-  &quot;China Standard Time&quot;: &quot;Asia/Shanghai&quot;,</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-  &quot;Cuba Standard Time&quot;: &quot;America/Havana&quot;,</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-  &quot;E. Africa Standard Time&quot;: &quot;Africa/Nairobi&quot;,</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">-  &quot;E. Australia Standard Time&quot;: &quot;Australia/Brisbane&quot;,</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineminus">-  &quot;E. Europe Standard Time&quot;: &quot;Europe/Chisinau&quot;,</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineminus">-  &quot;E. South America Standard Time&quot;: &quot;America/Sao_Paulo&quot;,</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">-  &quot;Easter Island Standard Time&quot;: &quot;Pacific/Easter&quot;,</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">-  &quot;Eastern Standard Time (Mexico)&quot;: &quot;America/Cancun&quot;,</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">-  &quot;Eastern Standard Time&quot;: &quot;America/New_York&quot;,</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">-  &quot;Egypt Standard Time&quot;: &quot;Africa/Cairo&quot;,</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineminus">-  &quot;Ekaterinburg Standard Time&quot;: &quot;Asia/Yekaterinburg&quot;,</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineminus">-  &quot;Fiji Standard Time&quot;: &quot;Pacific/Fiji&quot;,</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">-  &quot;FLE Standard Time&quot;: &quot;Europe/Helsinki&quot;,</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-  &quot;Georgian Standard Time&quot;: &quot;Asia/Tbilisi&quot;,</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineminus">-  &quot;GFT Standard Time&quot;: &quot;Europe/Athens&quot;,</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-  &quot;GMT Standard Time&quot;: &quot;Europe/London&quot;,</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineminus">-  &quot;Greenland Standard Time&quot;: &quot;America/Godthab&quot;,</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">-  &quot;Greenwich Standard Time&quot;: &quot;Atlantic/Reykjavik&quot;,</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">-  &quot;GTB Standard Time&quot;: &quot;Europe/Athens&quot;,</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">-  &quot;Haiti Standard Time&quot;: &quot;America/Port-au-Prince&quot;,</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineminus">-  &quot;Hawaiian Standard Time&quot;: &quot;Pacific/Honolulu&quot;,</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-  &quot;India Standard Time&quot;: &quot;Asia/Calcutta&quot;,</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineminus">-  &quot;Iran Standard Time&quot;: &quot;Asia/Tehran&quot;,</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineminus">-  &quot;Israel Standard Time&quot;: &quot;Asia/Jerusalem&quot;,</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineminus">-  &quot;Jordan Standard Time&quot;: &quot;Asia/Amman&quot;,</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineminus">-  &quot;Kaliningrad Standard Time&quot;: &quot;Europe/Kaliningrad&quot;,</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-  &quot;Korea Standard Time&quot;: &quot;Asia/Seoul&quot;,</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineminus">-  &quot;Libya Standard Time&quot;: &quot;Africa/Tripoli&quot;,</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineminus">-  &quot;Line Islands Standard Time&quot;: &quot;Pacific/Kiritimati&quot;,</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineminus">-  &quot;Lord Howe Standard Time&quot;: &quot;Australia/Lord_Howe&quot;,</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineminus">-  &quot;Magadan Standard Time&quot;: &quot;Asia/Magadan&quot;,</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineminus">-  &quot;Magallanes Standard Time&quot;: &quot;America/Punta_Arenas&quot;,</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineminus">-  &quot;Marquesas Standard Time&quot;: &quot;Pacific/Marquesas&quot;,</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineminus">-  &quot;Mauritius Standard Time&quot;: &quot;Indian/Mauritius&quot;,</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">-  &quot;Mexico Standard Time&quot;: &quot;America/Mexico_City&quot;,</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineminus">-  &quot;Mid-Atlantic Standard Time&quot;: &quot;Atlantic/South_Georgia&quot;,</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineminus">-  &quot;Middle East Standard Time&quot;: &quot;Asia/Beirut&quot;,</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">-  &quot;Montevideo Standard Time&quot;: &quot;America/Montevideo&quot;,</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-  &quot;Morocco Standard Time&quot;: &quot;Africa/Casablanca&quot;,</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineminus">-  &quot;Mountain Standard Time (Mexico)&quot;: &quot;America/Chihuahua&quot;,</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineminus">-  &quot;Mountain Standard Time&quot;: &quot;America/Denver&quot;,</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineminus">-  &quot;Myanmar Standard Time&quot;: &quot;Asia/Rangoon&quot;,</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineminus">-  &quot;N. Central Asia Standard Time&quot;: &quot;Asia/Novosibirsk&quot;,</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineminus">-  &quot;Namibia Standard Time&quot;: &quot;Africa/Windhoek&quot;,</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineminus">-  &quot;Nepal Standard Time&quot;: &quot;Asia/Katmandu&quot;,</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineminus">-  &quot;New Zealand Standard Time&quot;: &quot;Pacific/Auckland&quot;,</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineminus">-  &quot;Newfoundland Standard Time&quot;: &quot;America/St_Johns&quot;,</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineminus">-  &quot;Norfolk Standard Time&quot;: &quot;Pacific/Norfolk&quot;,</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-  &quot;North Asia East Standard Time&quot;: &quot;Asia/Irkutsk&quot;,</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-  &quot;North Asia Standard Time&quot;: &quot;Asia/Krasnoyarsk&quot;,</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineminus">-  &quot;North Korea Standard Time&quot;: &quot;Asia/Pyongyang&quot;,</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineminus">-  &quot;Omsk Standard Time&quot;: &quot;Asia/Omsk&quot;,</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineminus">-  &quot;Pacific SA Standard Time&quot;: &quot;America/Santiago&quot;,</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineminus">-  &quot;Pacific Standard Time (Mexico)&quot;: &quot;America/Tijuana&quot;,</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineminus">-  &quot;Pacific Standard Time&quot;: &quot;America/Los_Angeles&quot;,</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineminus">-  &quot;Pakistan Standard Time&quot;: &quot;Asia/Karachi&quot;,</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineminus">-  &quot;Paraguay Standard Time&quot;: &quot;America/Asuncion&quot;,</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineminus">-  &quot;Romance Standard Time&quot;: &quot;Europe/Paris&quot;,</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineminus">-  &quot;Russia Time Zone 10&quot;: &quot;Asia/Srednekolymsk&quot;,</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineminus">-  &quot;Russia Time Zone 11&quot;: &quot;Asia/Kamchatka&quot;,</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineminus">-  &quot;Russia Time Zone 3&quot;: &quot;Europe/Samara&quot;,</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineminus">-  &quot;Russian Standard Time&quot;: &quot;Europe/Moscow&quot;,</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineminus">-  &quot;SA Eastern Standard Time&quot;: &quot;America/Cayenne&quot;,</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">-  &quot;SA Pacific Standard Time&quot;: &quot;America/Bogota&quot;,</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineminus">-  &quot;SA Western Standard Time&quot;: &quot;America/La_Paz&quot;,</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineminus">-  &quot;Saint Pierre Standard Time&quot;: &quot;America/Miquelon&quot;,</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineminus">-  &quot;Sakhalin Standard Time&quot;: &quot;Asia/Sakhalin&quot;,</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">-  &quot;Samoa Standard Time&quot;: &quot;Pacific/Apia&quot;,</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-  &quot;Sao Tome Standard Time&quot;: &quot;Africa/Sao_Tome&quot;,</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">-  &quot;Saratov Standard Time&quot;: &quot;Europe/Saratov&quot;,</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineminus">-  &quot;Saudi Arabia Standard Time&quot;: &quot;Asia/Riyadh&quot;,</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineminus">-  &quot;SE Asia Standard Time&quot;: &quot;Asia/Bangkok&quot;,</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineminus">-  &quot;Singapore Standard Time&quot;: &quot;Asia/Singapore&quot;,</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineminus">-  &quot;South Africa Standard Time&quot;: &quot;Africa/Johannesburg&quot;,</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-  &quot;Sri Lanka Standard Time&quot;: &quot;Asia/Colombo&quot;,</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-  &quot;Sudan Standard Time&quot;: &quot;Africa/Khartoum&quot;,</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-  &quot;Sydney Standard Time&quot;: &quot;Australia/Sydney&quot;,</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-  &quot;Syria Standard Time&quot;: &quot;Asia/Damascus&quot;,</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineminus">-  &quot;Taipei Standard Time&quot;: &quot;Asia/Taipei&quot;,</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineminus">-  &quot;Tasmania Standard Time&quot;: &quot;Australia/Hobart&quot;,</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineminus">-  &quot;Tocantins Standard Time&quot;: &quot;America/Araguaina&quot;,</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineminus">-  &quot;Tokyo Standard Time&quot;: &quot;Asia/Tokyo&quot;,</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-  &quot;Tomsk Standard Time&quot;: &quot;Asia/Tomsk&quot;,</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineminus">-  &quot;Tonga Standard Time&quot;: &quot;Pacific/Tongatapu&quot;,</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineminus">-  &quot;Transbaikal Standard Time&quot;: &quot;Asia/Chita&quot;,</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineminus">-  &quot;Turkey Standard Time&quot;: &quot;Europe/Istanbul&quot;,</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineminus">-  &quot;Turks And Caicos Standard Time&quot;: &quot;America/Grand_Turk&quot;,</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineminus">-  &quot;Ulaanbaatar Standard Time&quot;: &quot;Asia/Ulaanbaatar&quot;,</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineminus">-  &quot;US Eastern Standard Time&quot;: &quot;America/Indiana/Indianapolis&quot;,</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineminus">-  &quot;US Mountain Standard Time&quot;: &quot;America/Phoenix&quot;,</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-  &quot;Venezuela Standard Time&quot;: &quot;America/Caracas&quot;,</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineminus">-  &quot;Vladivostok Standard Time&quot;: &quot;Asia/Vladivostok&quot;,</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineminus">-  &quot;W. Australia Standard Time&quot;: &quot;Australia/Perth&quot;,</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineminus">-  &quot;W. Central Africa Standard Time&quot;: &quot;Africa/Lagos&quot;,</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineminus">-  &quot;W. Europe Standard Time&quot;: &quot;Europe/Berlin&quot;,</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineminus">-  &quot;W. Mongolia Standard Time&quot;: &quot;Asia/Hovd&quot;,</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineminus">-  &quot;West Asia Standard Time&quot;: &quot;Asia/Tashkent&quot;,</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineminus">-  &quot;West Bank Standard Time&quot;: &quot;Asia/Hebron&quot;,</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineminus">-  &quot;West Pacific Standard Time&quot;: &quot;Pacific/Port_Moresby&quot;,</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineminus">-  &quot;Western Brazilian Standard Time&quot;: &quot;America/Rio_Branco&quot;,</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineminus">-  &quot;Yakutsk Standard Time&quot;: &quot;Asia/Yakutsk&quot;,</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">deleted file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- a/calendar/providers/gdata/moz.build</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ /dev/null</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -1,44 +0,0 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineminus">-</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-version_parts = CONFIG['MOZ_APP_VERSION'].split('.')</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-major_version = version_parts[0]</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-DEFINES['MOZ_APP_VERSION'] = CONFIG['MOZ_APP_VERSION']</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-DEFINES['MOZ_APP_MAXVERSION'] = major_version + '.*'</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-if CONFIG['MOZ_ARTIFACT_BUILDS']:</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-    XPI_NAME = 'gdata-provider'</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-    export('XPI_NAME')</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-else:</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-    DIST_SUBDIR = 'extensions/{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}'</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-    export('DIST_SUBDIR')</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-FINAL_TARGET_PP_FILES += ['manifest.json']</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-    'modules/gdataLogging.jsm',</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-    'modules/gdataRequest.jsm',</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-    'modules/gdataSession.jsm',</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-    'modules/gdataUtils.jsm',</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-    'modules/OAuth2.jsm',</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-    'modules/timezoneMap.jsm',</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-]</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-    'components/calGoogleCalendar.js',</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-    'components/calGoogleCalendar.manifest',</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-]</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-USE_EXTENSION_MANIFEST = True</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-export('USE_EXTENSION_MANIFEST')</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-JS_PREFERENCE_FILES += [</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-    'defaults/preferences.js',</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-]</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-with Files('**'):</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-    BUG_COMPONENT = ('Calendar', 'Provider: GData')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">deleted file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ /dev/null</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -1,2153 +0,0 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">-</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">-(function() {</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-  const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">-  Services.prefs.setBoolPref(&quot;javascript.options.showInConsole&quot;, true);</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  Services.prefs.setBoolPref(&quot;browser.dom.window.dump.enabled&quot;, true);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-  Services.prefs.setBoolPref(&quot;calendar.debug.log&quot;, true);</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-  Services.prefs.setBoolPref(&quot;calendar.debug.log.verbose&quot;, true);</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-  let xpiFile;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-  let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-  if (env.exists(&quot;MOZ_FETCHES_DIR&quot;)) {</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineminus">-    let path = env.get(&quot;MOZ_FETCHES_DIR&quot;);</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-    if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-      path = path.replace(/\//g, &quot;\\&quot;);</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-    }</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-    xpiFile = new FileUtils.File(path);</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-    xpiFile.append(&quot;gdata-provider.xpi&quot;);</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-  } else {</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-    xpiFile = Services.dirsvc.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-    xpiFile.append(&quot;extensions&quot;);</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-    xpiFile.append(&quot;{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}&quot;);</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-  }</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-  dump(&quot;Loading &quot; + xpiFile.path + &quot;\n&quot;);</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineminus">-  let manager = Cc[&quot;@mozilla.org/component-manager-extra;1&quot;].getService(</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-    Ci.nsIComponentManagerExtra</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-  );</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-  manager.addLegacyExtensionManifestLocation(xpiFile);</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-})();</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-var { HttpServer } = ChromeUtils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-var { getGoogleSessionManager } = ChromeUtils.import(</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataSession.jsm&quot;</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-);</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineminus">-var { dateToJSON, JSONToDate, monkeyPatch } = ChromeUtils.import(</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-  &quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-);</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineminus">-var { MockRegistrar } = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineminus">-</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-var gServer;</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-var MockConflictPrompt = {</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-  _origFunc: null,</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-  overwrite: false,</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  register: function() {</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-    if (!this._origFunc) {</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-      this._origFunc = cal.provider.promptOverwrite;</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-      cal.provider.promptOverwrite = (aMode, aItem) =&gt; {</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-        return this.overwrite;</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineminus">-      };</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-    }</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-  },</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-  unregister: function() {</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-    if (this._origFunc) {</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-      cal.provider.promptOverwrite = this._origFunc;</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-      this._origFunc = null;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-    }</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-  },</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-};</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-function MockAlertsService() {}</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-MockAlertsService.prototype = {</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-  showAlertNotification: function() {},</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIAlertsService]),</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-};</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-function replaceAlertsService() {</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-  let originalAlertsServiceCID = MockRegistrar.register(</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-    &quot;@mozilla.org/alerts-service;1&quot;,</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-    MockAlertsService</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-  );</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-  registerCleanupFunction(() =&gt; {</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-    MockRegistrar.unregister(originalAlertsServiceCID);</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-  });</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-}</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-function GDataServer(calendarId, tasksId) {</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-  this.server = new HttpServer();</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineminus">-  this.calendarId = calendarId;</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineminus">-  this.tasksId = tasksId;</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-  let encCalendarId = encodeURIComponent(calendarId);</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineminus">-  let encTasksId = encodeURIComponent(tasksId);</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineminus">-</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-  let events = &quot;/calendar/v3/calendars/&quot; + encCalendarId + &quot;/events&quot;;</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-  let tasks = &quot;/tasks/v1/lists/&quot; + encTasksId + &quot;/tasks&quot;;</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineminus">-  let calendarList = &quot;/calendar/v3/users/me/calendarList/&quot; + encCalendarId;</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineminus">-</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineminus">-  this.server.registerPathHandler(</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineminus">-    calendarList,</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-    this.router.bind(this, this.calendarListRequest.bind(this))</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-  );</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  this.server.registerPathHandler(events, this.router.bind(this, this.eventsRequest.bind(this)));</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineminus">-  this.server.registerPrefixHandler(</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-    events + &quot;/&quot;,</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineminus">-    this.router.bind(this, this.eventsRequest.bind(this))</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineminus">-  );</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-  this.server.registerPathHandler(tasks, this.router.bind(this, this.tasksRequest.bind(this)));</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-  this.server.registerPrefixHandler(</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineminus">-    tasks + &quot;/&quot;,</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineminus">-    this.router.bind(this, this.tasksRequest.bind(this))</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineminus">-  );</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-  this.resetRequest();</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-  let sessionMgr = getGoogleSessionManager();</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-  this.session = sessionMgr.getSessionById(&quot;xpcshell&quot;, true);</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineminus">-  this.session.oauth = {</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineminus">-    accessToken: &quot;accessToken&quot;,</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-    refreshToken: &quot;refreshToken&quot;,</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineminus">-    tokenExpires: Number.MAX_VALUE,</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineminus">-    connect: function(success, failure, withUi, refresh) {</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineminus">-      this.accessToken = &quot;accessToken&quot;;</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineminus">-      success();</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-    },</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineminus">-  };</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineminus">-}</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineminus">-GDataServer.prototype = {</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineminus">-  items: null,</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineminus">-</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-  get baseUri() {</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-    return &quot;http://localhost:&quot; + this.server.identity.primaryPort + &quot;/&quot;;</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-  },</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineminus">-</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineminus">-  start: function() {</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineminus">-    this.server.start(-1);</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineminus">-    registerCleanupFunction(() =&gt; this.server.stop(() =&gt; {}));</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineminus">-  },</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineminus">-</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineminus">-  resetClient: function(client) {</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineminus">-    this.resetRequest();</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineminus">-    MockConflictPrompt.unregister();</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-    cal.getCalendarManager().unregisterCalendar(client);</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-  },</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineminus">-</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-  resetRequest: function() {</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-    this.events = [];</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-    this.tasks = [];</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineminus">-    this.nextEtag = null;</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineminus">-    this.syncs = [];</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-    this.nextEventStatus = [];</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineminus">-</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineminus">-    this.creator = {</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineminus">-      email: this.calendarId,</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineminus">-      self: true,</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineminus">-      displayName: &quot;Eggs P. Seashell&quot;,</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineminus">-    };</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineminus">-    this.eventsData = {</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineminus">-      kind: &quot;calendar#events&quot;,</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineminus">-      etag: '&quot;1410880601360000&quot;',</span>
<a href="#l42.164"></a><span id="l42.164" class="difflineminus">-      nextSyncToken: generateID(),</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineminus">-      updated: &quot;2014-09-16T15:16:41.360Z&quot;,</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineminus">-      accessRole: &quot;owner&quot;,</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-      summary: &quot;xpcshell&quot;,</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineminus">-      timeZone: &quot;Europe/Berlin&quot;,</span>
<a href="#l42.169"></a><span id="l42.169" class="difflineminus">-      defaultReminders: [],</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineminus">-      items: [],</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineminus">-    };</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineminus">-</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineminus">-    this.tasksData = {</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineminus">-      kind: &quot;tasks#tasks&quot;,</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineminus">-      etag: '&quot;1410880601360000&quot;',</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineminus">-      items: [],</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineminus">-    };</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineminus">-</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineminus">-    this.calendarListData = {</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineminus">-      kind: &quot;calendar#calendarListEntry&quot;,</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineminus">-      etag: '&quot;1410084814736000&quot;',</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineminus">-      id: this.calendarId,</span>
<a href="#l42.183"></a><span id="l42.183" class="difflineminus">-      summary: &quot;xpcshell&quot;,</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineminus">-      timeZone: &quot;Europe/Berlin&quot;,</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">-      colorId: &quot;17&quot;,</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-      backgroundColor: &quot;#9a9cff&quot;,</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineminus">-      foregroundColor: &quot;#000000&quot;,</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineminus">-      primary: true,</span>
<a href="#l42.189"></a><span id="l42.189" class="difflineminus">-      selected: true,</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineminus">-      accessRole: &quot;owner&quot;,</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineminus">-      defaultReminders: [],</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineminus">-      notificationSettings: {</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineminus">-        notifications: [</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineminus">-          { type: &quot;eventCreation&quot;, method: &quot;email&quot; },</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-          { type: &quot;eventChange&quot;, method: &quot;email&quot; },</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineminus">-          { type: &quot;eventCancellation&quot;, method: &quot;email&quot; },</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineminus">-        ],</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineminus">-      },</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineminus">-    };</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineminus">-  },</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineminus">-</span>
<a href="#l42.202"></a><span id="l42.202" class="difflineminus">-  waitForLoad: function(aCalendar) {</span>
<a href="#l42.203"></a><span id="l42.203" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l42.204"></a><span id="l42.204" class="difflineminus">-      let observer = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineminus">-        onLoad: function() {</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineminus">-          let uncached = aCalendar.wrappedJSObject.mUncachedCalendar.wrappedJSObject;</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineminus">-          aCalendar.removeObserver(observer);</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineminus">-</span>
<a href="#l42.209"></a><span id="l42.209" class="difflineminus">-          if (Components.isSuccessCode(uncached._lastStatus)) {</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineminus">-            resolve(aCalendar);</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineminus">-          } else {</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineminus">-            reject(uncached._lastMessage);</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineminus">-          }</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineminus">-        },</span>
<a href="#l42.215"></a><span id="l42.215" class="difflineminus">-      });</span>
<a href="#l42.216"></a><span id="l42.216" class="difflineminus">-      aCalendar.addObserver(observer);</span>
<a href="#l42.217"></a><span id="l42.217" class="difflineminus">-    });</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-  },</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineminus">-  getClient: function() {</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineminus">-    let uri =</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineminus">-      &quot;googleapi://xpcshell/&quot; +</span>
<a href="#l42.223"></a><span id="l42.223" class="difflineminus">-      &quot;?testport=&quot; +</span>
<a href="#l42.224"></a><span id="l42.224" class="difflineminus">-      this.server.identity.primaryPort +</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">-      (this.calendarId ? &quot;&amp;calendar=&quot; + encodeURIComponent(this.calendarId) : &quot;&quot;) +</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineminus">-      (this.tasksId ? &quot;&amp;tasks=&quot; + encodeURIComponent(this.tasksId) : &quot;&quot;);</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineminus">-    let calmgr = cal.getCalendarManager();</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineminus">-    let client = calmgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri));</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineminus">-    let uclient = client.wrappedJSObject;</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineminus">-    client.name = &quot;xpcshell&quot;;</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineminus">-</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineminus">-    // Make sure we catch the last error message in case sync fails</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineminus">-    monkeyPatch(uclient, &quot;replayChangesOn&quot;, (protofunc, aListener) =&gt; {</span>
<a href="#l42.234"></a><span id="l42.234" class="difflineminus">-      protofunc({</span>
<a href="#l42.235"></a><span id="l42.235" class="difflineminus">-        onResult: function(operation, detail) {</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineminus">-          uclient._lastStatus = operation.status;</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineminus">-          uclient._lastMessage = detail;</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineminus">-          aListener.onResult(operation, detail);</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineminus">-        },</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineminus">-      });</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineminus">-    });</span>
<a href="#l42.242"></a><span id="l42.242" class="difflineminus">-</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineminus">-    calmgr.registerCalendar(client);</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineminus">-    uclient.mThrottleLimits = {};</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineminus">-    MockConflictPrompt.register();</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineminus">-</span>
<a href="#l42.247"></a><span id="l42.247" class="difflineminus">-    let cachedCalendar = calmgr.getCalendarById(client.id);</span>
<a href="#l42.248"></a><span id="l42.248" class="difflineminus">-    return this.waitForLoad(cachedCalendar);</span>
<a href="#l42.249"></a><span id="l42.249" class="difflineminus">-  },</span>
<a href="#l42.250"></a><span id="l42.250" class="difflineminus">-</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-  router: function(nextHandler, request, response) {</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineminus">-    try {</span>
<a href="#l42.253"></a><span id="l42.253" class="difflineminus">-      let method = request.hasHeader(&quot;X-HTTP-Method-Override&quot;)</span>
<a href="#l42.254"></a><span id="l42.254" class="difflineminus">-        ? request.getHeader(&quot;X-HTTP-Method-Override&quot;)</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineminus">-        : request.method;</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineminus">-      let parameters = new Map(request.queryString.split(&quot;&amp;&quot;).map(part =&gt; part.split(&quot;=&quot;, 2)));</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineminus">-</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineminus">-      let body;</span>
<a href="#l42.259"></a><span id="l42.259" class="difflineminus">-      try {</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineminus">-        body = JSON.parse(</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineminus">-          NetUtil.readInputStreamToString(</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineminus">-            request.bodyInputStream,</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineminus">-            request.bodyInputStream.available()</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineminus">-          )</span>
<a href="#l42.265"></a><span id="l42.265" class="difflineminus">-        );</span>
<a href="#l42.266"></a><span id="l42.266" class="difflineminus">-      } catch (e) {</span>
<a href="#l42.267"></a><span id="l42.267" class="difflineminus">-        // Don't bail if json parsing failed.</span>
<a href="#l42.268"></a><span id="l42.268" class="difflineminus">-      }</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineminus">-</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineminus">-      this.lastMethod = method;</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineminus">-      return nextHandler(request, response, method, parameters, body);</span>
<a href="#l42.272"></a><span id="l42.272" class="difflineminus">-    } catch (e) {</span>
<a href="#l42.273"></a><span id="l42.273" class="difflineminus">-      info(&quot;Server Error: &quot; + e.fileName + &quot;:&quot; + e.lineNumber + &quot;: &quot; + e + &quot;\n&quot;);</span>
<a href="#l42.274"></a><span id="l42.274" class="difflineminus">-      return null;</span>
<a href="#l42.275"></a><span id="l42.275" class="difflineminus">-    }</span>
<a href="#l42.276"></a><span id="l42.276" class="difflineminus">-  },</span>
<a href="#l42.277"></a><span id="l42.277" class="difflineminus">-</span>
<a href="#l42.278"></a><span id="l42.278" class="difflineminus">-  calendarListRequest: function(request, response, method, parameters, body) {</span>
<a href="#l42.279"></a><span id="l42.279" class="difflineminus">-    let data = this.calendarListData;</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineminus">-    response.write(JSON.stringify(data));</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineminus">-  },</span>
<a href="#l42.282"></a><span id="l42.282" class="difflineminus">-</span>
<a href="#l42.283"></a><span id="l42.283" class="difflineminus">-  eventsRequest: function(request, response, method, parameters, body) {</span>
<a href="#l42.284"></a><span id="l42.284" class="difflineminus">-    if (method == &quot;GET&quot;) {</span>
<a href="#l42.285"></a><span id="l42.285" class="difflineminus">-      let data = this.eventsData;</span>
<a href="#l42.286"></a><span id="l42.286" class="difflineminus">-      if (request.hasHeader(&quot;timeZone&quot;)) {</span>
<a href="#l42.287"></a><span id="l42.287" class="difflineminus">-        data.timeZone = request.getHeader(&quot;timeZone&quot;);</span>
<a href="#l42.288"></a><span id="l42.288" class="difflineminus">-      }</span>
<a href="#l42.289"></a><span id="l42.289" class="difflineminus">-</span>
<a href="#l42.290"></a><span id="l42.290" class="difflineminus">-      // The fakeserver doesn't support both pagination and sync tokens</span>
<a href="#l42.291"></a><span id="l42.291" class="difflineminus">-      // for sake of simplicity.</span>
<a href="#l42.292"></a><span id="l42.292" class="difflineminus">-      if (this.syncs.length) {</span>
<a href="#l42.293"></a><span id="l42.293" class="difflineminus">-        let syncToken = parameters.get(&quot;syncToken&quot;) || this.syncs[0].token;</span>
<a href="#l42.294"></a><span id="l42.294" class="difflineminus">-        let sync = this.syncs.shift();</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineminus">-        let nextSyncToken = this.syncs[0] ? this.syncs[0].token : &quot;last&quot;;</span>
<a href="#l42.296"></a><span id="l42.296" class="difflineminus">-</span>
<a href="#l42.297"></a><span id="l42.297" class="difflineminus">-        if (!sync || syncToken != sync.token) {</span>
<a href="#l42.298"></a><span id="l42.298" class="difflineminus">-          do_throw(&quot;Request in wrong order or not enough syncs&quot;);</span>
<a href="#l42.299"></a><span id="l42.299" class="difflineminus">-        }</span>
<a href="#l42.300"></a><span id="l42.300" class="difflineminus">-        if (sync.reset) {</span>
<a href="#l42.301"></a><span id="l42.301" class="difflineminus">-          response.setStatusLine(null, 410, &quot;Gone&quot;);</span>
<a href="#l42.302"></a><span id="l42.302" class="difflineminus">-          return;</span>
<a href="#l42.303"></a><span id="l42.303" class="difflineminus">-        }</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineminus">-        data.nextSyncToken = nextSyncToken;</span>
<a href="#l42.305"></a><span id="l42.305" class="difflineminus">-        data.items = sync.events;</span>
<a href="#l42.306"></a><span id="l42.306" class="difflineminus">-      } else {</span>
<a href="#l42.307"></a><span id="l42.307" class="difflineminus">-        this.paginateRequest(parameters, this.events, data);</span>
<a href="#l42.308"></a><span id="l42.308" class="difflineminus">-      }</span>
<a href="#l42.309"></a><span id="l42.309" class="difflineminus">-      response.write(JSON.stringify(data));</span>
<a href="#l42.310"></a><span id="l42.310" class="difflineminus">-    } else if (method == &quot;POST&quot;) {</span>
<a href="#l42.311"></a><span id="l42.311" class="difflineminus">-      // Add an event</span>
<a href="#l42.312"></a><span id="l42.312" class="difflineminus">-      let isImport = request.path.endsWith(&quot;/events/import&quot;);</span>
<a href="#l42.313"></a><span id="l42.313" class="difflineminus">-      let data = this.processAddEvent(body, isImport);</span>
<a href="#l42.314"></a><span id="l42.314" class="difflineminus">-      this.events.push(data);</span>
<a href="#l42.315"></a><span id="l42.315" class="difflineminus">-      response.setStatusLine(null, 201, &quot;Created&quot;);</span>
<a href="#l42.316"></a><span id="l42.316" class="difflineminus">-      response.write(JSON.stringify(data));</span>
<a href="#l42.317"></a><span id="l42.317" class="difflineminus">-    } else if (</span>
<a href="#l42.318"></a><span id="l42.318" class="difflineminus">-      (method == &quot;PUT&quot; || method == &quot;PATCH&quot;) &amp;&amp;</span>
<a href="#l42.319"></a><span id="l42.319" class="difflineminus">-      request.path.match(/\/events\/([a-z0-9_TZ]+)$/)</span>
<a href="#l42.320"></a><span id="l42.320" class="difflineminus">-    ) {</span>
<a href="#l42.321"></a><span id="l42.321" class="difflineminus">-      // Modify an event</span>
<a href="#l42.322"></a><span id="l42.322" class="difflineminus">-      let eventId = RegExp.$1;</span>
<a href="#l42.323"></a><span id="l42.323" class="difflineminus">-      this.handleModify(</span>
<a href="#l42.324"></a><span id="l42.324" class="difflineminus">-        request,</span>
<a href="#l42.325"></a><span id="l42.325" class="difflineminus">-        response,</span>
<a href="#l42.326"></a><span id="l42.326" class="difflineminus">-        body,</span>
<a href="#l42.327"></a><span id="l42.327" class="difflineminus">-        this.events,</span>
<a href="#l42.328"></a><span id="l42.328" class="difflineminus">-        eventId,</span>
<a href="#l42.329"></a><span id="l42.329" class="difflineminus">-        this.processModifyEvent.bind(this)</span>
<a href="#l42.330"></a><span id="l42.330" class="difflineminus">-      );</span>
<a href="#l42.331"></a><span id="l42.331" class="difflineminus">-    } else if (method == &quot;DELETE&quot; &amp;&amp; request.path.match(/\/events\/([a-z0-9_TZ]+)$/)) {</span>
<a href="#l42.332"></a><span id="l42.332" class="difflineminus">-      let eventId = RegExp.$1;</span>
<a href="#l42.333"></a><span id="l42.333" class="difflineminus">-      this.handleDelete(request, response, this.events, eventId);</span>
<a href="#l42.334"></a><span id="l42.334" class="difflineminus">-    }</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineminus">-  },</span>
<a href="#l42.336"></a><span id="l42.336" class="difflineminus">-</span>
<a href="#l42.337"></a><span id="l42.337" class="difflineminus">-  tasksRequest: function(request, response, method, parameters, body) {</span>
<a href="#l42.338"></a><span id="l42.338" class="difflineminus">-    if (method == &quot;GET&quot;) {</span>
<a href="#l42.339"></a><span id="l42.339" class="difflineminus">-      let data = this.tasksData;</span>
<a href="#l42.340"></a><span id="l42.340" class="difflineminus">-</span>
<a href="#l42.341"></a><span id="l42.341" class="difflineminus">-      this.paginateRequest(parameters, this.tasks, data);</span>
<a href="#l42.342"></a><span id="l42.342" class="difflineminus">-      delete data.nextSyncToken;</span>
<a href="#l42.343"></a><span id="l42.343" class="difflineminus">-</span>
<a href="#l42.344"></a><span id="l42.344" class="difflineminus">-      response.write(JSON.stringify(data));</span>
<a href="#l42.345"></a><span id="l42.345" class="difflineminus">-    } else if (method == &quot;POST&quot;) {</span>
<a href="#l42.346"></a><span id="l42.346" class="difflineminus">-      let data = this.processAddTask(body);</span>
<a href="#l42.347"></a><span id="l42.347" class="difflineminus">-      this.tasks.push(data);</span>
<a href="#l42.348"></a><span id="l42.348" class="difflineminus">-      response.setStatusLine(null, 201, &quot;Created&quot;);</span>
<a href="#l42.349"></a><span id="l42.349" class="difflineminus">-      response.write(JSON.stringify(data));</span>
<a href="#l42.350"></a><span id="l42.350" class="difflineminus">-    } else if (method == &quot;PUT&quot; &amp;&amp; request.path.match(/\/tasks\/([A-Za-z0-9]+)$/)) {</span>
<a href="#l42.351"></a><span id="l42.351" class="difflineminus">-      let taskId = RegExp.$1;</span>
<a href="#l42.352"></a><span id="l42.352" class="difflineminus">-      this.handleModify(</span>
<a href="#l42.353"></a><span id="l42.353" class="difflineminus">-        request,</span>
<a href="#l42.354"></a><span id="l42.354" class="difflineminus">-        response,</span>
<a href="#l42.355"></a><span id="l42.355" class="difflineminus">-        body,</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineminus">-        this.tasks,</span>
<a href="#l42.357"></a><span id="l42.357" class="difflineminus">-        taskId,</span>
<a href="#l42.358"></a><span id="l42.358" class="difflineminus">-        this.processModifyTask.bind(this)</span>
<a href="#l42.359"></a><span id="l42.359" class="difflineminus">-      );</span>
<a href="#l42.360"></a><span id="l42.360" class="difflineminus">-    } else if (method == &quot;DELETE&quot; &amp;&amp; request.path.match(/\/tasks\/([A-Za-z0-9]+)$/)) {</span>
<a href="#l42.361"></a><span id="l42.361" class="difflineminus">-      let taskId = RegExp.$1;</span>
<a href="#l42.362"></a><span id="l42.362" class="difflineminus">-      this.handleDelete(request, response, this.tasks, taskId);</span>
<a href="#l42.363"></a><span id="l42.363" class="difflineminus">-    }</span>
<a href="#l42.364"></a><span id="l42.364" class="difflineminus">-  },</span>
<a href="#l42.365"></a><span id="l42.365" class="difflineminus">-</span>
<a href="#l42.366"></a><span id="l42.366" class="difflineminus">-  paginateRequest: function(parameters, items, data) {</span>
<a href="#l42.367"></a><span id="l42.367" class="difflineminus">-    let maxResults = parameters.has(&quot;maxResults&quot;) ? parseInt(parameters.get(&quot;maxResults&quot;), 10) : 50;</span>
<a href="#l42.368"></a><span id="l42.368" class="difflineminus">-    let offset = parameters.has(&quot;pageToken&quot;) ? parseInt(parameters.get(&quot;pageToken&quot;), 10) || 0 : 0;</span>
<a href="#l42.369"></a><span id="l42.369" class="difflineminus">-    let nextOffset = offset + maxResults;</span>
<a href="#l42.370"></a><span id="l42.370" class="difflineminus">-    if (nextOffset &gt; items.length) {</span>
<a href="#l42.371"></a><span id="l42.371" class="difflineminus">-      delete data.nextPageToken;</span>
<a href="#l42.372"></a><span id="l42.372" class="difflineminus">-      data.nextSyncToken = &quot;next-sync-token&quot;;</span>
<a href="#l42.373"></a><span id="l42.373" class="difflineminus">-    } else {</span>
<a href="#l42.374"></a><span id="l42.374" class="difflineminus">-      delete data.nextSyncToken;</span>
<a href="#l42.375"></a><span id="l42.375" class="difflineminus">-      data.nextPageToken = nextOffset;</span>
<a href="#l42.376"></a><span id="l42.376" class="difflineminus">-    }</span>
<a href="#l42.377"></a><span id="l42.377" class="difflineminus">-</span>
<a href="#l42.378"></a><span id="l42.378" class="difflineminus">-    data.items = items.slice(offset, offset + maxResults);</span>
<a href="#l42.379"></a><span id="l42.379" class="difflineminus">-  },</span>
<a href="#l42.380"></a><span id="l42.380" class="difflineminus">-</span>
<a href="#l42.381"></a><span id="l42.381" class="difflineminus">-  handleModify: function(request, response, body, items, itemId, modifyFunc) {</span>
<a href="#l42.382"></a><span id="l42.382" class="difflineminus">-    // Modify an event</span>
<a href="#l42.383"></a><span id="l42.383" class="difflineminus">-    let [foundIndex, foundItem] = findKey(items, &quot;id&quot;, itemId);</span>
<a href="#l42.384"></a><span id="l42.384" class="difflineminus">-</span>
<a href="#l42.385"></a><span id="l42.385" class="difflineminus">-    let matchTag = request.hasHeader(&quot;If-Match&quot;) ? request.getHeader(&quot;If-Match&quot;) : null;</span>
<a href="#l42.386"></a><span id="l42.386" class="difflineminus">-</span>
<a href="#l42.387"></a><span id="l42.387" class="difflineminus">-    if (foundIndex != -1) {</span>
<a href="#l42.388"></a><span id="l42.388" class="difflineminus">-      if (!matchTag || matchTag == &quot;*&quot; || foundItem.etag == matchTag) {</span>
<a href="#l42.389"></a><span id="l42.389" class="difflineminus">-        items[foundIndex] = modifyFunc(body, itemId);</span>
<a href="#l42.390"></a><span id="l42.390" class="difflineminus">-        response.write(JSON.stringify(items[foundIndex]));</span>
<a href="#l42.391"></a><span id="l42.391" class="difflineminus">-      } else {</span>
<a href="#l42.392"></a><span id="l42.392" class="difflineminus">-        response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l42.393"></a><span id="l42.393" class="difflineminus">-      }</span>
<a href="#l42.394"></a><span id="l42.394" class="difflineminus">-    } else if (matchTag == &quot;*&quot;) {</span>
<a href="#l42.395"></a><span id="l42.395" class="difflineminus">-      let data = modifyFunc(body, itemId);</span>
<a href="#l42.396"></a><span id="l42.396" class="difflineminus">-      items.push(data);</span>
<a href="#l42.397"></a><span id="l42.397" class="difflineminus">-      response.write(JSON.stringify(data));</span>
<a href="#l42.398"></a><span id="l42.398" class="difflineminus">-    } else if (body.recurringEventId) {</span>
<a href="#l42.399"></a><span id="l42.399" class="difflineminus">-      // Special case for events, won't happen on tasks.  This is an</span>
<a href="#l42.400"></a><span id="l42.400" class="difflineminus">-      // exception that doesn't exist yet. Allow creation in this case.</span>
<a href="#l42.401"></a><span id="l42.401" class="difflineminus">-      let [, foundParent] = findKey(items, &quot;id&quot;, body.recurringEventId);</span>
<a href="#l42.402"></a><span id="l42.402" class="difflineminus">-      if (!matchTag || foundParent.etag == matchTag) {</span>
<a href="#l42.403"></a><span id="l42.403" class="difflineminus">-        let data = modifyFunc(body, itemId);</span>
<a href="#l42.404"></a><span id="l42.404" class="difflineminus">-        items.push(data);</span>
<a href="#l42.405"></a><span id="l42.405" class="difflineminus">-        response.write(JSON.stringify(data));</span>
<a href="#l42.406"></a><span id="l42.406" class="difflineminus">-      } else {</span>
<a href="#l42.407"></a><span id="l42.407" class="difflineminus">-        response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l42.408"></a><span id="l42.408" class="difflineminus">-      }</span>
<a href="#l42.409"></a><span id="l42.409" class="difflineminus">-    } else if (matchTag) {</span>
<a href="#l42.410"></a><span id="l42.410" class="difflineminus">-      response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l42.411"></a><span id="l42.411" class="difflineminus">-    } else {</span>
<a href="#l42.412"></a><span id="l42.412" class="difflineminus">-      response.setStatusLine(null, 404, &quot;Not Found&quot;);</span>
<a href="#l42.413"></a><span id="l42.413" class="difflineminus">-    }</span>
<a href="#l42.414"></a><span id="l42.414" class="difflineminus">-  },</span>
<a href="#l42.415"></a><span id="l42.415" class="difflineminus">-</span>
<a href="#l42.416"></a><span id="l42.416" class="difflineminus">-  handleDelete: function(request, response, items, itemId) {</span>
<a href="#l42.417"></a><span id="l42.417" class="difflineminus">-    // eslint-disable-next-line array-bracket-spacing</span>
<a href="#l42.418"></a><span id="l42.418" class="difflineminus">-    let [foundIndex] = findKey(items, &quot;id&quot;, itemId);</span>
<a href="#l42.419"></a><span id="l42.419" class="difflineminus">-</span>
<a href="#l42.420"></a><span id="l42.420" class="difflineminus">-    let matchTag = request.hasHeader(&quot;If-Match&quot;) ? request.getHeader(&quot;If-Match&quot;) : null;</span>
<a href="#l42.421"></a><span id="l42.421" class="difflineminus">-</span>
<a href="#l42.422"></a><span id="l42.422" class="difflineminus">-    if (foundIndex != -1) {</span>
<a href="#l42.423"></a><span id="l42.423" class="difflineminus">-      if (!matchTag || matchTag == &quot;*&quot; || items[foundIndex].etag == matchTag) {</span>
<a href="#l42.424"></a><span id="l42.424" class="difflineminus">-        items.splice(foundIndex, 1);</span>
<a href="#l42.425"></a><span id="l42.425" class="difflineminus">-        response.setStatusLine(null, 204, &quot;No Content&quot;);</span>
<a href="#l42.426"></a><span id="l42.426" class="difflineminus">-      } else {</span>
<a href="#l42.427"></a><span id="l42.427" class="difflineminus">-        response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l42.428"></a><span id="l42.428" class="difflineminus">-      }</span>
<a href="#l42.429"></a><span id="l42.429" class="difflineminus">-    } else if (matchTag == &quot;*&quot;) {</span>
<a href="#l42.430"></a><span id="l42.430" class="difflineminus">-      response.setStatusLine(null, 410, &quot;Gone&quot;);</span>
<a href="#l42.431"></a><span id="l42.431" class="difflineminus">-    } else if (matchTag) {</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineminus">-      response.setStatusLine(null, 412, &quot;Precondition Failed&quot;);</span>
<a href="#l42.433"></a><span id="l42.433" class="difflineminus">-    } else {</span>
<a href="#l42.434"></a><span id="l42.434" class="difflineminus">-      response.setStatusLine(null, 404, &quot;Not Found&quot;);</span>
<a href="#l42.435"></a><span id="l42.435" class="difflineminus">-    }</span>
<a href="#l42.436"></a><span id="l42.436" class="difflineminus">-  },</span>
<a href="#l42.437"></a><span id="l42.437" class="difflineminus">-</span>
<a href="#l42.438"></a><span id="l42.438" class="difflineminus">-  processAddEvent: function(jsonData, isImport) {</span>
<a href="#l42.439"></a><span id="l42.439" class="difflineminus">-    jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l42.440"></a><span id="l42.440" class="difflineminus">-    jsonData.etag = this.nextEtag || '&quot;' + new Date().getTime() + '&quot;';</span>
<a href="#l42.441"></a><span id="l42.441" class="difflineminus">-    jsonData.id = generateID();</span>
<a href="#l42.442"></a><span id="l42.442" class="difflineminus">-    if (!isImport) {</span>
<a href="#l42.443"></a><span id="l42.443" class="difflineminus">-      jsonData.htmlLink = this.baseUri + &quot;/calendar/event?eid=&quot; + jsonData.id;</span>
<a href="#l42.444"></a><span id="l42.444" class="difflineminus">-    }</span>
<a href="#l42.445"></a><span id="l42.445" class="difflineminus">-    if (!isImport || !jsonData.iCalUID) {</span>
<a href="#l42.446"></a><span id="l42.446" class="difflineminus">-      jsonData.iCalUID = jsonData.id + &quot;@google.com&quot;;</span>
<a href="#l42.447"></a><span id="l42.447" class="difflineminus">-    }</span>
<a href="#l42.448"></a><span id="l42.448" class="difflineminus">-    if (!isImport || !jsonData.created) {</span>
<a href="#l42.449"></a><span id="l42.449" class="difflineminus">-      jsonData.created = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.450"></a><span id="l42.450" class="difflineminus">-    }</span>
<a href="#l42.451"></a><span id="l42.451" class="difflineminus">-    if (!isImport || !jsonData.updated) {</span>
<a href="#l42.452"></a><span id="l42.452" class="difflineminus">-      jsonData.updated = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.453"></a><span id="l42.453" class="difflineminus">-    }</span>
<a href="#l42.454"></a><span id="l42.454" class="difflineminus">-    if (!isImport || !jsonData.creator) {</span>
<a href="#l42.455"></a><span id="l42.455" class="difflineminus">-      jsonData.creator = this.creator;</span>
<a href="#l42.456"></a><span id="l42.456" class="difflineminus">-    }</span>
<a href="#l42.457"></a><span id="l42.457" class="difflineminus">-    if (!isImport || !jsonData.organizer) {</span>
<a href="#l42.458"></a><span id="l42.458" class="difflineminus">-      jsonData.organizer = this.creator;</span>
<a href="#l42.459"></a><span id="l42.459" class="difflineminus">-    }</span>
<a href="#l42.460"></a><span id="l42.460" class="difflineminus">-    this.nextEtag = null;</span>
<a href="#l42.461"></a><span id="l42.461" class="difflineminus">-    return jsonData;</span>
<a href="#l42.462"></a><span id="l42.462" class="difflineminus">-  },</span>
<a href="#l42.463"></a><span id="l42.463" class="difflineminus">-</span>
<a href="#l42.464"></a><span id="l42.464" class="difflineminus">-  processModifyEvent: function(jsonData, id) {</span>
<a href="#l42.465"></a><span id="l42.465" class="difflineminus">-    jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l42.466"></a><span id="l42.466" class="difflineminus">-    jsonData.etag = this.nextEtag || '&quot;' + new Date().getTime() + '&quot;';</span>
<a href="#l42.467"></a><span id="l42.467" class="difflineminus">-    jsonData.updated = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.468"></a><span id="l42.468" class="difflineminus">-    jsonData.id = id;</span>
<a href="#l42.469"></a><span id="l42.469" class="difflineminus">-    jsonData.iCalUID = (jsonData.recurringEventId || jsonData.id) + &quot;@google.com&quot;;</span>
<a href="#l42.470"></a><span id="l42.470" class="difflineminus">-    if (!jsonData.creator) {</span>
<a href="#l42.471"></a><span id="l42.471" class="difflineminus">-      jsonData.creator = this.creator;</span>
<a href="#l42.472"></a><span id="l42.472" class="difflineminus">-    }</span>
<a href="#l42.473"></a><span id="l42.473" class="difflineminus">-    if (!jsonData.organizer) {</span>
<a href="#l42.474"></a><span id="l42.474" class="difflineminus">-      jsonData.organizer = this.creator;</span>
<a href="#l42.475"></a><span id="l42.475" class="difflineminus">-    }</span>
<a href="#l42.476"></a><span id="l42.476" class="difflineminus">-</span>
<a href="#l42.477"></a><span id="l42.477" class="difflineminus">-    this.nextEtag = null;</span>
<a href="#l42.478"></a><span id="l42.478" class="difflineminus">-    return jsonData;</span>
<a href="#l42.479"></a><span id="l42.479" class="difflineminus">-  },</span>
<a href="#l42.480"></a><span id="l42.480" class="difflineminus">-</span>
<a href="#l42.481"></a><span id="l42.481" class="difflineminus">-  processAddTask: function(jsonData) {</span>
<a href="#l42.482"></a><span id="l42.482" class="difflineminus">-    jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l42.483"></a><span id="l42.483" class="difflineminus">-    jsonData.etag = this.nextEtag || '&quot;' + new Date().getTime() + '&quot;';</span>
<a href="#l42.484"></a><span id="l42.484" class="difflineminus">-    jsonData.id = generateID();</span>
<a href="#l42.485"></a><span id="l42.485" class="difflineminus">-    jsonData.position = generateID(); // Not a real position, but we don't really use this at the moment</span>
<a href="#l42.486"></a><span id="l42.486" class="difflineminus">-    if (!jsonData.status) {</span>
<a href="#l42.487"></a><span id="l42.487" class="difflineminus">-      jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l42.488"></a><span id="l42.488" class="difflineminus">-    }</span>
<a href="#l42.489"></a><span id="l42.489" class="difflineminus">-    if (!jsonData.updated) {</span>
<a href="#l42.490"></a><span id="l42.490" class="difflineminus">-      jsonData.updated = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.491"></a><span id="l42.491" class="difflineminus">-    }</span>
<a href="#l42.492"></a><span id="l42.492" class="difflineminus">-</span>
<a href="#l42.493"></a><span id="l42.493" class="difflineminus">-    this.nextEtag = null;</span>
<a href="#l42.494"></a><span id="l42.494" class="difflineminus">-    return jsonData;</span>
<a href="#l42.495"></a><span id="l42.495" class="difflineminus">-  },</span>
<a href="#l42.496"></a><span id="l42.496" class="difflineminus">-</span>
<a href="#l42.497"></a><span id="l42.497" class="difflineminus">-  processModifyTask: function(jsonData) {</span>
<a href="#l42.498"></a><span id="l42.498" class="difflineminus">-    jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l42.499"></a><span id="l42.499" class="difflineminus">-    jsonData.etag = this.nextEtag || '&quot;' + new Date().getTime() + '&quot;';</span>
<a href="#l42.500"></a><span id="l42.500" class="difflineminus">-    jsonData.updated = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.501"></a><span id="l42.501" class="difflineminus">-    if (!jsonData.status) {</span>
<a href="#l42.502"></a><span id="l42.502" class="difflineminus">-      jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l42.503"></a><span id="l42.503" class="difflineminus">-    }</span>
<a href="#l42.504"></a><span id="l42.504" class="difflineminus">-    if (!jsonData.updated) {</span>
<a href="#l42.505"></a><span id="l42.505" class="difflineminus">-      jsonData.updated = cal.dtz.toRFC3339(cal.dtz.now());</span>
<a href="#l42.506"></a><span id="l42.506" class="difflineminus">-    }</span>
<a href="#l42.507"></a><span id="l42.507" class="difflineminus">-</span>
<a href="#l42.508"></a><span id="l42.508" class="difflineminus">-    this.nextEtag = null;</span>
<a href="#l42.509"></a><span id="l42.509" class="difflineminus">-    return jsonData;</span>
<a href="#l42.510"></a><span id="l42.510" class="difflineminus">-  },</span>
<a href="#l42.511"></a><span id="l42.511" class="difflineminus">-};</span>
<a href="#l42.512"></a><span id="l42.512" class="difflineminus">-</span>
<a href="#l42.513"></a><span id="l42.513" class="difflineminus">-function findKey(container, key, searchKey) {</span>
<a href="#l42.514"></a><span id="l42.514" class="difflineminus">-  let foundIndex = -1;</span>
<a href="#l42.515"></a><span id="l42.515" class="difflineminus">-  for (let i = 0; i &lt; container.length; i++) {</span>
<a href="#l42.516"></a><span id="l42.516" class="difflineminus">-    if (container[i][key] == searchKey) {</span>
<a href="#l42.517"></a><span id="l42.517" class="difflineminus">-      foundIndex = i;</span>
<a href="#l42.518"></a><span id="l42.518" class="difflineminus">-      break;</span>
<a href="#l42.519"></a><span id="l42.519" class="difflineminus">-    }</span>
<a href="#l42.520"></a><span id="l42.520" class="difflineminus">-  }</span>
<a href="#l42.521"></a><span id="l42.521" class="difflineminus">-</span>
<a href="#l42.522"></a><span id="l42.522" class="difflineminus">-  let foundItem = foundIndex == -1 ? null : container[foundIndex];</span>
<a href="#l42.523"></a><span id="l42.523" class="difflineminus">-  return [foundIndex, foundItem];</span>
<a href="#l42.524"></a><span id="l42.524" class="difflineminus">-}</span>
<a href="#l42.525"></a><span id="l42.525" class="difflineminus">-</span>
<a href="#l42.526"></a><span id="l42.526" class="difflineminus">-function generateID() {</span>
<a href="#l42.527"></a><span id="l42.527" class="difflineminus">-  let chars = &quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;;</span>
<a href="#l42.528"></a><span id="l42.528" class="difflineminus">-  let str = &quot;&quot;;</span>
<a href="#l42.529"></a><span id="l42.529" class="difflineminus">-  for (let i = 26; i; i--) {</span>
<a href="#l42.530"></a><span id="l42.530" class="difflineminus">-    str += chars[Math.floor(Math.random() * chars.length)];</span>
<a href="#l42.531"></a><span id="l42.531" class="difflineminus">-  }</span>
<a href="#l42.532"></a><span id="l42.532" class="difflineminus">-  return str;</span>
<a href="#l42.533"></a><span id="l42.533" class="difflineminus">-}</span>
<a href="#l42.534"></a><span id="l42.534" class="difflineminus">-</span>
<a href="#l42.535"></a><span id="l42.535" class="difflineminus">-function getAllMeta(calendar) {</span>
<a href="#l42.536"></a><span id="l42.536" class="difflineminus">-  let keys = {},</span>
<a href="#l42.537"></a><span id="l42.537" class="difflineminus">-    values = {};</span>
<a href="#l42.538"></a><span id="l42.538" class="difflineminus">-  calendar.getAllMetaData({}, keys, values);</span>
<a href="#l42.539"></a><span id="l42.539" class="difflineminus">-  return new Map(keys.value.map((k, i) =&gt; [k, values.value[i]]));</span>
<a href="#l42.540"></a><span id="l42.540" class="difflineminus">-}</span>
<a href="#l42.541"></a><span id="l42.541" class="difflineminus">-</span>
<a href="#l42.542"></a><span id="l42.542" class="difflineminus">-function run_test() {</span>
<a href="#l42.543"></a><span id="l42.543" class="difflineminus">-  replaceAlertsService();</span>
<a href="#l42.544"></a><span id="l42.544" class="difflineminus">-</span>
<a href="#l42.545"></a><span id="l42.545" class="difflineminus">-  // TODO: make do_calendar_startup to work with this test and replace the startup code here</span>
<a href="#l42.546"></a><span id="l42.546" class="difflineminus">-  do_get_profile();</span>
<a href="#l42.547"></a><span id="l42.547" class="difflineminus">-  do_test_pending();</span>
<a href="#l42.548"></a><span id="l42.548" class="difflineminus">-  cal.getCalendarManager().startup({</span>
<a href="#l42.549"></a><span id="l42.549" class="difflineminus">-    onResult: function() {</span>
<a href="#l42.550"></a><span id="l42.550" class="difflineminus">-      gServer = new GDataServer(&quot;xpcshell@example.com&quot;, &quot;tasksId&quot;);</span>
<a href="#l42.551"></a><span id="l42.551" class="difflineminus">-      gServer.start();</span>
<a href="#l42.552"></a><span id="l42.552" class="difflineminus">-      cal.getTimezoneService().startup({</span>
<a href="#l42.553"></a><span id="l42.553" class="difflineminus">-        onResult: function() {</span>
<a href="#l42.554"></a><span id="l42.554" class="difflineminus">-          run_next_test();</span>
<a href="#l42.555"></a><span id="l42.555" class="difflineminus">-          do_test_finished();</span>
<a href="#l42.556"></a><span id="l42.556" class="difflineminus">-        },</span>
<a href="#l42.557"></a><span id="l42.557" class="difflineminus">-      });</span>
<a href="#l42.558"></a><span id="l42.558" class="difflineminus">-    },</span>
<a href="#l42.559"></a><span id="l42.559" class="difflineminus">-  });</span>
<a href="#l42.560"></a><span id="l42.560" class="difflineminus">-}</span>
<a href="#l42.561"></a><span id="l42.561" class="difflineminus">-</span>
<a href="#l42.562"></a><span id="l42.562" class="difflineminus">-add_task(async function test_migrate_cache() {</span>
<a href="#l42.563"></a><span id="l42.563" class="difflineminus">-  let uriString = &quot;googleapi://xpcshell/?calendar=xpcshell%40example.com&quot;;</span>
<a href="#l42.564"></a><span id="l42.564" class="difflineminus">-  let uri = Services.io.newURI(uriString);</span>
<a href="#l42.565"></a><span id="l42.565" class="difflineminus">-  let client = cal.getCalendarManager().createCalendar(&quot;gdata&quot;, uri);</span>
<a href="#l42.566"></a><span id="l42.566" class="difflineminus">-  let unwrapped = client.wrappedJSObject;</span>
<a href="#l42.567"></a><span id="l42.567" class="difflineminus">-  let migrateStorageCache = unwrapped.migrateStorageCache.bind(unwrapped);</span>
<a href="#l42.568"></a><span id="l42.568" class="difflineminus">-</span>
<a href="#l42.569"></a><span id="l42.569" class="difflineminus">-  monkeyPatch(unwrapped, &quot;resetSync&quot;, protofunc =&gt; {</span>
<a href="#l42.570"></a><span id="l42.570" class="difflineminus">-    return Promise.resolve();</span>
<a href="#l42.571"></a><span id="l42.571" class="difflineminus">-  });</span>
<a href="#l42.572"></a><span id="l42.572" class="difflineminus">-</span>
<a href="#l42.573"></a><span id="l42.573" class="difflineminus">-  // No version, should not reset</span>
<a href="#l42.574"></a><span id="l42.574" class="difflineminus">-  equal(await migrateStorageCache(), false);</span>
<a href="#l42.575"></a><span id="l42.575" class="difflineminus">-  equal(client.getProperty(&quot;cache.version&quot;), 3);</span>
<a href="#l42.576"></a><span id="l42.576" class="difflineminus">-</span>
<a href="#l42.577"></a><span id="l42.577" class="difflineminus">-  // Check migrate 1 -&gt; 2</span>
<a href="#l42.578"></a><span id="l42.578" class="difflineminus">-  unwrapped.CACHE_DB_VERSION = 2;</span>
<a href="#l42.579"></a><span id="l42.579" class="difflineminus">-  client.setProperty(&quot;cache.version&quot;, 1);</span>
<a href="#l42.580"></a><span id="l42.580" class="difflineminus">-  equal(await migrateStorageCache(), true);</span>
<a href="#l42.581"></a><span id="l42.581" class="difflineminus">-  equal(client.getProperty(&quot;cache.version&quot;), 2);</span>
<a href="#l42.582"></a><span id="l42.582" class="difflineminus">-</span>
<a href="#l42.583"></a><span id="l42.583" class="difflineminus">-  // Check migrate 2 -&gt; 3 normal calendar</span>
<a href="#l42.584"></a><span id="l42.584" class="difflineminus">-  unwrapped.CACHE_DB_VERSION = 3;</span>
<a href="#l42.585"></a><span id="l42.585" class="difflineminus">-  client.setProperty(&quot;cache.version&quot;, 2);</span>
<a href="#l42.586"></a><span id="l42.586" class="difflineminus">-  equal(await migrateStorageCache(), false);</span>
<a href="#l42.587"></a><span id="l42.587" class="difflineminus">-</span>
<a href="#l42.588"></a><span id="l42.588" class="difflineminus">-  // Check migrate 2 -&gt; 3 birthday calendar</span>
<a href="#l42.589"></a><span id="l42.589" class="difflineminus">-  unwrapped.CACHE_DB_VERSION = 3;</span>
<a href="#l42.590"></a><span id="l42.590" class="difflineminus">-  uri = &quot;googleapi://xpcshell/?calendar=%23contacts%40group.v.calendar.google.com&quot;;</span>
<a href="#l42.591"></a><span id="l42.591" class="difflineminus">-  unwrapped.uri = Services.io.newURI(uri);</span>
<a href="#l42.592"></a><span id="l42.592" class="difflineminus">-  client.setProperty(&quot;cache.version&quot;, 2);</span>
<a href="#l42.593"></a><span id="l42.593" class="difflineminus">-  equal(await migrateStorageCache(), true);</span>
<a href="#l42.594"></a><span id="l42.594" class="difflineminus">-});</span>
<a href="#l42.595"></a><span id="l42.595" class="difflineminus">-</span>
<a href="#l42.596"></a><span id="l42.596" class="difflineminus">-add_test(function test_migrate_uri() {</span>
<a href="#l42.597"></a><span id="l42.597" class="difflineminus">-  function checkMigrate(fromUri, session, calendarId, tasksId) {</span>
<a href="#l42.598"></a><span id="l42.598" class="difflineminus">-    let uri = Services.io.newURI(fromUri);</span>
<a href="#l42.599"></a><span id="l42.599" class="difflineminus">-    let client = cal.getCalendarManager().createCalendar(&quot;gdata&quot;, uri);</span>
<a href="#l42.600"></a><span id="l42.600" class="difflineminus">-</span>
<a href="#l42.601"></a><span id="l42.601" class="difflineminus">-    if (session) {</span>
<a href="#l42.602"></a><span id="l42.602" class="difflineminus">-      let target = (</span>
<a href="#l42.603"></a><span id="l42.603" class="difflineminus">-        &quot;googleapi://&quot; +</span>
<a href="#l42.604"></a><span id="l42.604" class="difflineminus">-        session +</span>
<a href="#l42.605"></a><span id="l42.605" class="difflineminus">-        &quot;/?&quot; +</span>
<a href="#l42.606"></a><span id="l42.606" class="difflineminus">-        (calendarId ? &quot;&amp;calendar=&quot; + encodeURIComponent(calendarId) : &quot;&quot;) +</span>
<a href="#l42.607"></a><span id="l42.607" class="difflineminus">-        (tasksId ? &quot;&amp;tasks=&quot; + encodeURIComponent(tasksId) : &quot;&quot;)</span>
<a href="#l42.608"></a><span id="l42.608" class="difflineminus">-      ).replace(&quot;?&amp;&quot;, &quot;?&quot;);</span>
<a href="#l42.609"></a><span id="l42.609" class="difflineminus">-      equal(client.getProperty(&quot;uri&quot;), target);</span>
<a href="#l42.610"></a><span id="l42.610" class="difflineminus">-    } else {</span>
<a href="#l42.611"></a><span id="l42.611" class="difflineminus">-      equal(client.getProperty(&quot;uri&quot;), null);</span>
<a href="#l42.612"></a><span id="l42.612" class="difflineminus">-    }</span>
<a href="#l42.613"></a><span id="l42.613" class="difflineminus">-  }</span>
<a href="#l42.614"></a><span id="l42.614" class="difflineminus">-</span>
<a href="#l42.615"></a><span id="l42.615" class="difflineminus">-  checkMigrate(</span>
<a href="#l42.616"></a><span id="l42.616" class="difflineminus">-    &quot;http://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l42.617"></a><span id="l42.617" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.618"></a><span id="l42.618" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.619"></a><span id="l42.619" class="difflineminus">-    null</span>
<a href="#l42.620"></a><span id="l42.620" class="difflineminus">-  );</span>
<a href="#l42.621"></a><span id="l42.621" class="difflineminus">-</span>
<a href="#l42.622"></a><span id="l42.622" class="difflineminus">-  checkMigrate(</span>
<a href="#l42.623"></a><span id="l42.623" class="difflineminus">-    &quot;webcal://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l42.624"></a><span id="l42.624" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.625"></a><span id="l42.625" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.626"></a><span id="l42.626" class="difflineminus">-    null</span>
<a href="#l42.627"></a><span id="l42.627" class="difflineminus">-  );</span>
<a href="#l42.628"></a><span id="l42.628" class="difflineminus">-</span>
<a href="#l42.629"></a><span id="l42.629" class="difflineminus">-  Services.prefs.setStringPref(</span>
<a href="#l42.630"></a><span id="l42.630" class="difflineminus">-    &quot;calendar.google.calPrefs.example@example.com.googleUser&quot;,</span>
<a href="#l42.631"></a><span id="l42.631" class="difflineminus">-    &quot;example@example.com&quot;</span>
<a href="#l42.632"></a><span id="l42.632" class="difflineminus">-  );</span>
<a href="#l42.633"></a><span id="l42.633" class="difflineminus">-  checkMigrate(</span>
<a href="#l42.634"></a><span id="l42.634" class="difflineminus">-    &quot;http://www.google.com/calendar/feeds/example%40example.com/public/full&quot;,</span>
<a href="#l42.635"></a><span id="l42.635" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.636"></a><span id="l42.636" class="difflineminus">-    &quot;example@example.com&quot;,</span>
<a href="#l42.637"></a><span id="l42.637" class="difflineminus">-    &quot;@default&quot;</span>
<a href="#l42.638"></a><span id="l42.638" class="difflineminus">-  );</span>
<a href="#l42.639"></a><span id="l42.639" class="difflineminus">-</span>
<a href="#l42.640"></a><span id="l42.640" class="difflineminus">-  checkMigrate(&quot;ehmwtf://www.google.com/calendar/feeds/example%40example.com/public/full&quot;);</span>
<a href="#l42.641"></a><span id="l42.641" class="difflineminus">-  checkMigrate(&quot;googleapi://session/?calendar=calendarId&amp;tasksId=tasksId&quot;);</span>
<a href="#l42.642"></a><span id="l42.642" class="difflineminus">-</span>
<a href="#l42.643"></a><span id="l42.643" class="difflineminus">-  run_next_test();</span>
<a href="#l42.644"></a><span id="l42.644" class="difflineminus">-});</span>
<a href="#l42.645"></a><span id="l42.645" class="difflineminus">-</span>
<a href="#l42.646"></a><span id="l42.646" class="difflineminus">-add_task(async function test_dateToJSON() {</span>
<a href="#l42.647"></a><span id="l42.647" class="difflineminus">-  function _createDateTime(tzid, offset = 0) {</span>
<a href="#l42.648"></a><span id="l42.648" class="difflineminus">-    let offsetFrom = offset &lt;= 0 ? &quot;-0&quot; + (offset - 1) : &quot;+0&quot; + (offset - 1) + &quot;00&quot;;</span>
<a href="#l42.649"></a><span id="l42.649" class="difflineminus">-    let offsetTo = &quot;+0&quot; + offset + &quot;00&quot;;</span>
<a href="#l42.650"></a><span id="l42.650" class="difflineminus">-    let ics = [</span>
<a href="#l42.651"></a><span id="l42.651" class="difflineminus">-      &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l42.652"></a><span id="l42.652" class="difflineminus">-      &quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l42.653"></a><span id="l42.653" class="difflineminus">-      &quot;TZID:ThirdPartyZone&quot;,</span>
<a href="#l42.654"></a><span id="l42.654" class="difflineminus">-      &quot;BEGIN:STANDARD&quot;,</span>
<a href="#l42.655"></a><span id="l42.655" class="difflineminus">-      &quot;DTSTART:20071104T020000&quot;,</span>
<a href="#l42.656"></a><span id="l42.656" class="difflineminus">-      &quot;RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU;INTERVAL=1&quot;,</span>
<a href="#l42.657"></a><span id="l42.657" class="difflineminus">-      &quot;TZOFFSETFROM:&quot; + offsetFrom,</span>
<a href="#l42.658"></a><span id="l42.658" class="difflineminus">-      &quot;TZOFFSETTO:&quot; + offsetTo,</span>
<a href="#l42.659"></a><span id="l42.659" class="difflineminus">-      &quot;TZNAME:TPT&quot;,</span>
<a href="#l42.660"></a><span id="l42.660" class="difflineminus">-      &quot;END:STANDARD&quot;,</span>
<a href="#l42.661"></a><span id="l42.661" class="difflineminus">-      &quot;BEGIN:DAYLIGHT&quot;,</span>
<a href="#l42.662"></a><span id="l42.662" class="difflineminus">-      &quot;DTSTART:20070311T020000&quot;,</span>
<a href="#l42.663"></a><span id="l42.663" class="difflineminus">-      &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=1SU;INTERVAL=1&quot;,</span>
<a href="#l42.664"></a><span id="l42.664" class="difflineminus">-      &quot;TZOFFSETFROM:&quot; + offsetTo,</span>
<a href="#l42.665"></a><span id="l42.665" class="difflineminus">-      &quot;TZOFFSETTO:&quot; + offsetFrom,</span>
<a href="#l42.666"></a><span id="l42.666" class="difflineminus">-      &quot;TZNAME:TPDT&quot;,</span>
<a href="#l42.667"></a><span id="l42.667" class="difflineminus">-      &quot;END:DAYLIGHT&quot;,</span>
<a href="#l42.668"></a><span id="l42.668" class="difflineminus">-      &quot;END:VTIMEZONE&quot;,</span>
<a href="#l42.669"></a><span id="l42.669" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.670"></a><span id="l42.670" class="difflineminus">-      &quot;UID:123&quot;,</span>
<a href="#l42.671"></a><span id="l42.671" class="difflineminus">-      &quot;DTSTART;TZID=&quot; + tzid + &quot;:20150130T120000&quot;,</span>
<a href="#l42.672"></a><span id="l42.672" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.673"></a><span id="l42.673" class="difflineminus">-      &quot;END:VCALENDAR&quot;,</span>
<a href="#l42.674"></a><span id="l42.674" class="difflineminus">-    ].join(&quot;\r\n&quot;);</span>
<a href="#l42.675"></a><span id="l42.675" class="difflineminus">-</span>
<a href="#l42.676"></a><span id="l42.676" class="difflineminus">-    let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l42.677"></a><span id="l42.677" class="difflineminus">-    parser.parseString(ics);</span>
<a href="#l42.678"></a><span id="l42.678" class="difflineminus">-    let items = parser.getItems({});</span>
<a href="#l42.679"></a><span id="l42.679" class="difflineminus">-    return items[0].startDate;</span>
<a href="#l42.680"></a><span id="l42.680" class="difflineminus">-  }</span>
<a href="#l42.681"></a><span id="l42.681" class="difflineminus">-</span>
<a href="#l42.682"></a><span id="l42.682" class="difflineminus">-  let date;</span>
<a href="#l42.683"></a><span id="l42.683" class="difflineminus">-</span>
<a href="#l42.684"></a><span id="l42.684" class="difflineminus">-  // no timezone</span>
<a href="#l42.685"></a><span id="l42.685" class="difflineminus">-  date = _createDateTime(cal.dtz.floating);</span>
<a href="#l42.686"></a><span id="l42.686" class="difflineminus">-  deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l42.687"></a><span id="l42.687" class="difflineminus">-</span>
<a href="#l42.688"></a><span id="l42.688" class="difflineminus">-  // valid non-Olson tz name</span>
<a href="#l42.689"></a><span id="l42.689" class="difflineminus">-  date = _createDateTime(&quot;Eastern Standard Time&quot;);</span>
<a href="#l42.690"></a><span id="l42.690" class="difflineminus">-  deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l42.691"></a><span id="l42.691" class="difflineminus">-</span>
<a href="#l42.692"></a><span id="l42.692" class="difflineminus">-  // valid continent/city Olson tz</span>
<a href="#l42.693"></a><span id="l42.693" class="difflineminus">-  date = _createDateTime(&quot;America/New_York&quot;);</span>
<a href="#l42.694"></a><span id="l42.694" class="difflineminus">-  deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l42.695"></a><span id="l42.695" class="difflineminus">-</span>
<a href="#l42.696"></a><span id="l42.696" class="difflineminus">-  // valid continent/region/city Olson tz</span>
<a href="#l42.697"></a><span id="l42.697" class="difflineminus">-  date = _createDateTime(&quot;America/Argentina/Buenos_Aires&quot;);</span>
<a href="#l42.698"></a><span id="l42.698" class="difflineminus">-  deepEqual(dateToJSON(date), {</span>
<a href="#l42.699"></a><span id="l42.699" class="difflineminus">-    dateTime: &quot;2015-01-30T12:00:00&quot;,</span>
<a href="#l42.700"></a><span id="l42.700" class="difflineminus">-    timeZone: &quot;America/Argentina/Buenos_Aires&quot;,</span>
<a href="#l42.701"></a><span id="l42.701" class="difflineminus">-  });</span>
<a href="#l42.702"></a><span id="l42.702" class="difflineminus">-</span>
<a href="#l42.703"></a><span id="l42.703" class="difflineminus">-  // ical.js and libical currently have slightly different timezone handling.</span>
<a href="#l42.704"></a><span id="l42.704" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l42.705"></a><span id="l42.705" class="difflineminus">-    // unknown but formal valid Olson tz. ical.js assumes floating</span>
<a href="#l42.706"></a><span id="l42.706" class="difflineminus">-    date = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l42.707"></a><span id="l42.707" class="difflineminus">-    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l42.708"></a><span id="l42.708" class="difflineminus">-</span>
<a href="#l42.709"></a><span id="l42.709" class="difflineminus">-    // Etc with offset. ical.js doesn't understand third party zones and uses floating</span>
<a href="#l42.710"></a><span id="l42.710" class="difflineminus">-    date = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l42.711"></a><span id="l42.711" class="difflineminus">-    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l42.712"></a><span id="l42.712" class="difflineminus">-</span>
<a href="#l42.713"></a><span id="l42.713" class="difflineminus">-    // Etc with zero offset. ical.js doesn't understand third party zones and uses floating</span>
<a href="#l42.714"></a><span id="l42.714" class="difflineminus">-    date = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l42.715"></a><span id="l42.715" class="difflineminus">-    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l42.716"></a><span id="l42.716" class="difflineminus">-  } else {</span>
<a href="#l42.717"></a><span id="l42.717" class="difflineminus">-    // This causes an assertion failure.</span>
<a href="#l42.718"></a><span id="l42.718" class="difflineminus">-    if (!mozinfo.debug) {</span>
<a href="#l42.719"></a><span id="l42.719" class="difflineminus">-      // unknown but formal valid Olson tz</span>
<a href="#l42.720"></a><span id="l42.720" class="difflineminus">-      date = _createDateTime(&quot;Unknown/Olson/Timezone&quot;);</span>
<a href="#l42.721"></a><span id="l42.721" class="difflineminus">-      deepEqual(dateToJSON(date), {</span>
<a href="#l42.722"></a><span id="l42.722" class="difflineminus">-        dateTime: &quot;2015-01-30T12:00:00&quot;,</span>
<a href="#l42.723"></a><span id="l42.723" class="difflineminus">-        timeZone: &quot;Unknown/Olson/Timezone&quot;,</span>
<a href="#l42.724"></a><span id="l42.724" class="difflineminus">-      });</span>
<a href="#l42.725"></a><span id="l42.725" class="difflineminus">-    }</span>
<a href="#l42.726"></a><span id="l42.726" class="difflineminus">-</span>
<a href="#l42.727"></a><span id="l42.727" class="difflineminus">-    // Etc with offset</span>
<a href="#l42.728"></a><span id="l42.728" class="difflineminus">-    date = _createDateTime(&quot;ThirdPartyZone&quot;, 5);</span>
<a href="#l42.729"></a><span id="l42.729" class="difflineminus">-    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Etc/GMT-5&quot; });</span>
<a href="#l42.730"></a><span id="l42.730" class="difflineminus">-</span>
<a href="#l42.731"></a><span id="l42.731" class="difflineminus">-    // Etc with zero offset</span>
<a href="#l42.732"></a><span id="l42.732" class="difflineminus">-    date = _createDateTime(&quot;ThirdPartyZone&quot;, 0);</span>
<a href="#l42.733"></a><span id="l42.733" class="difflineminus">-    deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00Z&quot;, timeZone: &quot;UTC&quot; });</span>
<a href="#l42.734"></a><span id="l42.734" class="difflineminus">-  }</span>
<a href="#l42.735"></a><span id="l42.735" class="difflineminus">-</span>
<a href="#l42.736"></a><span id="l42.736" class="difflineminus">-  // This causes an assertion failure.</span>
<a href="#l42.737"></a><span id="l42.737" class="difflineminus">-  if (!mozinfo.debug) {</span>
<a href="#l42.738"></a><span id="l42.738" class="difflineminus">-    // invalid non-Olson tz</span>
<a href="#l42.739"></a><span id="l42.739" class="difflineminus">-    date = _createDateTime(&quot;InvalidTimeZone&quot;);</span>
<a href="#l42.740"></a><span id="l42.740" class="difflineminus">-    notEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;InvalidTimeZone&quot; });</span>
<a href="#l42.741"></a><span id="l42.741" class="difflineminus">-  }</span>
<a href="#l42.742"></a><span id="l42.742" class="difflineminus">-</span>
<a href="#l42.743"></a><span id="l42.743" class="difflineminus">-  // Zone with 0 offset but not UTC</span>
<a href="#l42.744"></a><span id="l42.744" class="difflineminus">-  date = _createDateTime(&quot;Europe/London&quot;);</span>
<a href="#l42.745"></a><span id="l42.745" class="difflineminus">-  deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;Europe/London&quot; });</span>
<a href="#l42.746"></a><span id="l42.746" class="difflineminus">-</span>
<a href="#l42.747"></a><span id="l42.747" class="difflineminus">-  // date only</span>
<a href="#l42.748"></a><span id="l42.748" class="difflineminus">-  date.isDate = true;</span>
<a href="#l42.749"></a><span id="l42.749" class="difflineminus">-  deepEqual(dateToJSON(date), { date: &quot;2015-01-30&quot; });</span>
<a href="#l42.750"></a><span id="l42.750" class="difflineminus">-});</span>
<a href="#l42.751"></a><span id="l42.751" class="difflineminus">-</span>
<a href="#l42.752"></a><span id="l42.752" class="difflineminus">-add_task(async function test_JSONToDate() {</span>
<a href="#l42.753"></a><span id="l42.753" class="difflineminus">-  function convert(aEntry, aTimezone = &quot;Europe/Berlin&quot;) {</span>
<a href="#l42.754"></a><span id="l42.754" class="difflineminus">-    let tzs = cal.getTimezoneService();</span>
<a href="#l42.755"></a><span id="l42.755" class="difflineminus">-    let calendarTz = tzs.getTimezone(aTimezone);</span>
<a href="#l42.756"></a><span id="l42.756" class="difflineminus">-    let date = JSONToDate(aEntry, calendarTz);</span>
<a href="#l42.757"></a><span id="l42.757" class="difflineminus">-    return date ? date.icalString + &quot; in &quot; + date.timezone.tzid : null;</span>
<a href="#l42.758"></a><span id="l42.758" class="difflineminus">-  }</span>
<a href="#l42.759"></a><span id="l42.759" class="difflineminus">-</span>
<a href="#l42.760"></a><span id="l42.760" class="difflineminus">-  // A date, using the passed in default timezone</span>
<a href="#l42.761"></a><span id="l42.761" class="difflineminus">-  equal(convert({ date: &quot;2015-01-02&quot; }), &quot;20150102 in Europe/Berlin&quot;);</span>
<a href="#l42.762"></a><span id="l42.762" class="difflineminus">-</span>
<a href="#l42.763"></a><span id="l42.763" class="difflineminus">-  // A date, with a timezone that has zero offset</span>
<a href="#l42.764"></a><span id="l42.764" class="difflineminus">-  equal(convert({ date: &quot;2015-01-02&quot;, timeZone: &quot;Africa/Accra&quot; }), &quot;20150102 in Africa/Accra&quot;);</span>
<a href="#l42.765"></a><span id="l42.765" class="difflineminus">-</span>
<a href="#l42.766"></a><span id="l42.766" class="difflineminus">-  // A date, using a timezone with a nonzero offset that is not the default timezone</span>
<a href="#l42.767"></a><span id="l42.767" class="difflineminus">-  equal(convert({ date: &quot;2015-01-02&quot;, timeZone: &quot;Asia/Baku&quot; }), &quot;20150102 in Asia/Baku&quot;);</span>
<a href="#l42.768"></a><span id="l42.768" class="difflineminus">-</span>
<a href="#l42.769"></a><span id="l42.769" class="difflineminus">-  // UTC date with and without timezone specified, with a calendar in a timezone without DST</span>
<a href="#l42.770"></a><span id="l42.770" class="difflineminus">-  equal(</span>
<a href="#l42.771"></a><span id="l42.771" class="difflineminus">-    convert({ dateTime: &quot;2015-01-02T03:04:05Z&quot;, timeZone: &quot;UTC&quot; }, &quot;Africa/Accra&quot;),</span>
<a href="#l42.772"></a><span id="l42.772" class="difflineminus">-    &quot;20150102T030405Z in UTC&quot;</span>
<a href="#l42.773"></a><span id="l42.773" class="difflineminus">-  );</span>
<a href="#l42.774"></a><span id="l42.774" class="difflineminus">-  equal(</span>
<a href="#l42.775"></a><span id="l42.775" class="difflineminus">-    convert({ dateTime: &quot;2015-01-02T03:04:05Z&quot; }, &quot;Africa/Accra&quot;),</span>
<a href="#l42.776"></a><span id="l42.776" class="difflineminus">-    &quot;20150102T030405 in Africa/Accra&quot;</span>
<a href="#l42.777"></a><span id="l42.777" class="difflineminus">-  );</span>
<a href="#l42.778"></a><span id="l42.778" class="difflineminus">-</span>
<a href="#l42.779"></a><span id="l42.779" class="difflineminus">-  // An America/Los_Angeles date-time viewed in Europe/Berlin</span>
<a href="#l42.780"></a><span id="l42.780" class="difflineminus">-  equal(</span>
<a href="#l42.781"></a><span id="l42.781" class="difflineminus">-    convert({ dateTime: &quot;2015-12-01T21:13:14+01:00&quot;, timeZone: &quot;America/Los_Angeles&quot; }),</span>
<a href="#l42.782"></a><span id="l42.782" class="difflineminus">-    &quot;20151201T121314 in America/Los_Angeles&quot;</span>
<a href="#l42.783"></a><span id="l42.783" class="difflineminus">-  );</span>
<a href="#l42.784"></a><span id="l42.784" class="difflineminus">-  equal(</span>
<a href="#l42.785"></a><span id="l42.785" class="difflineminus">-    convert({ dateTime: &quot;2015-07-01T21:13:14+02:00&quot;, timeZone: &quot;America/Los_Angeles&quot; }),</span>
<a href="#l42.786"></a><span id="l42.786" class="difflineminus">-    &quot;20150701T121314 in America/Los_Angeles&quot;</span>
<a href="#l42.787"></a><span id="l42.787" class="difflineminus">-  );</span>
<a href="#l42.788"></a><span id="l42.788" class="difflineminus">-</span>
<a href="#l42.789"></a><span id="l42.789" class="difflineminus">-  // A timezone that is sometimes in GMT, get ready for: Europe/London!</span>
<a href="#l42.790"></a><span id="l42.790" class="difflineminus">-  equal(</span>
<a href="#l42.791"></a><span id="l42.791" class="difflineminus">-    convert({ dateTime: &quot;2015-12-01T12:13:14Z&quot;, timeZone: &quot;Europe/London&quot; }, &quot;Europe/London&quot;),</span>
<a href="#l42.792"></a><span id="l42.792" class="difflineminus">-    &quot;20151201T121314 in Europe/London&quot;</span>
<a href="#l42.793"></a><span id="l42.793" class="difflineminus">-  );</span>
<a href="#l42.794"></a><span id="l42.794" class="difflineminus">-  equal(</span>
<a href="#l42.795"></a><span id="l42.795" class="difflineminus">-    convert({ dateTime: &quot;2015-07-01T12:13:14+01:00&quot;, timeZone: &quot;Europe/London&quot; }, &quot;Europe/London&quot;),</span>
<a href="#l42.796"></a><span id="l42.796" class="difflineminus">-    &quot;20150701T121314 in Europe/London&quot;</span>
<a href="#l42.797"></a><span id="l42.797" class="difflineminus">-  );</span>
<a href="#l42.798"></a><span id="l42.798" class="difflineminus">-</span>
<a href="#l42.799"></a><span id="l42.799" class="difflineminus">-  // An event in Los Angeles, with a calendar set to Asia/Baku</span>
<a href="#l42.800"></a><span id="l42.800" class="difflineminus">-  equal(</span>
<a href="#l42.801"></a><span id="l42.801" class="difflineminus">-    convert(</span>
<a href="#l42.802"></a><span id="l42.802" class="difflineminus">-      { dateTime: &quot;2015-07-01T12:13:14+05:00&quot;, timeZone: &quot;America/Los_Angeles&quot; },</span>
<a href="#l42.803"></a><span id="l42.803" class="difflineminus">-      &quot;Asia/Baku&quot;</span>
<a href="#l42.804"></a><span id="l42.804" class="difflineminus">-    ),</span>
<a href="#l42.805"></a><span id="l42.805" class="difflineminus">-    &quot;20150701T001314 in America/Los_Angeles&quot;</span>
<a href="#l42.806"></a><span id="l42.806" class="difflineminus">-  );</span>
<a href="#l42.807"></a><span id="l42.807" class="difflineminus">-  equal(</span>
<a href="#l42.808"></a><span id="l42.808" class="difflineminus">-    convert(</span>
<a href="#l42.809"></a><span id="l42.809" class="difflineminus">-      { dateTime: &quot;2015-12-01T12:13:14+04:00&quot;, timeZone: &quot;America/Los_Angeles&quot; },</span>
<a href="#l42.810"></a><span id="l42.810" class="difflineminus">-      &quot;Asia/Baku&quot;</span>
<a href="#l42.811"></a><span id="l42.811" class="difflineminus">-    ),</span>
<a href="#l42.812"></a><span id="l42.812" class="difflineminus">-    &quot;20151201T001314 in America/Los_Angeles&quot;</span>
<a href="#l42.813"></a><span id="l42.813" class="difflineminus">-  );</span>
<a href="#l42.814"></a><span id="l42.814" class="difflineminus">-</span>
<a href="#l42.815"></a><span id="l42.815" class="difflineminus">-  // An event without specified timezone, with a calendar set to Asia/Baku</span>
<a href="#l42.816"></a><span id="l42.816" class="difflineminus">-  equal(</span>
<a href="#l42.817"></a><span id="l42.817" class="difflineminus">-    convert({ dateTime: &quot;2015-07-01T12:13:14+04:00&quot; }, &quot;Asia/Baku&quot;),</span>
<a href="#l42.818"></a><span id="l42.818" class="difflineminus">-    &quot;20150701T121314 in Asia/Baku&quot;</span>
<a href="#l42.819"></a><span id="l42.819" class="difflineminus">-  );</span>
<a href="#l42.820"></a><span id="l42.820" class="difflineminus">-</span>
<a href="#l42.821"></a><span id="l42.821" class="difflineminus">-  // An offset matching the passed in calendar timezone. This should NOT be Africa/Algiers</span>
<a href="#l42.822"></a><span id="l42.822" class="difflineminus">-  equal(convert({ dateTime: &quot;2015-01-02T03:04:05+01:00&quot; }), &quot;20150102T030405 in Europe/Berlin&quot;);</span>
<a href="#l42.823"></a><span id="l42.823" class="difflineminus">-</span>
<a href="#l42.824"></a><span id="l42.824" class="difflineminus">-  // An offset that doesn't match the calendar timezone, will use the first timezone in that offset</span>
<a href="#l42.825"></a><span id="l42.825" class="difflineminus">-  info(</span>
<a href="#l42.826"></a><span id="l42.826" class="difflineminus">-    &quot;The following warning is expected: 2015-01-02T03:04:05+04:00 does not match timezone offset for Europe/Berlin&quot;</span>
<a href="#l42.827"></a><span id="l42.827" class="difflineminus">-  );</span>
<a href="#l42.828"></a><span id="l42.828" class="difflineminus">-  equal(convert({ dateTime: &quot;2015-01-02T03:04:05+05:00&quot; }), &quot;20150102T030405 in Antarctica/Mawson&quot;);</span>
<a href="#l42.829"></a><span id="l42.829" class="difflineminus">-});</span>
<a href="#l42.830"></a><span id="l42.830" class="difflineminus">-</span>
<a href="#l42.831"></a><span id="l42.831" class="difflineminus">-add_task(async function test_organizerCN() {</span>
<a href="#l42.832"></a><span id="l42.832" class="difflineminus">-  gServer.events = [];</span>
<a href="#l42.833"></a><span id="l42.833" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.834"></a><span id="l42.834" class="difflineminus">-  equal(client.getProperty(&quot;organizerCN&quot;), null);</span>
<a href="#l42.835"></a><span id="l42.835" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.836"></a><span id="l42.836" class="difflineminus">-</span>
<a href="#l42.837"></a><span id="l42.837" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.838"></a><span id="l42.838" class="difflineminus">-    {</span>
<a href="#l42.839"></a><span id="l42.839" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.840"></a><span id="l42.840" class="difflineminus">-      etag: '&quot;2299601498276000&quot;',</span>
<a href="#l42.841"></a><span id="l42.841" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.842"></a><span id="l42.842" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.843"></a><span id="l42.843" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.844"></a><span id="l42.844" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.845"></a><span id="l42.845" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.846"></a><span id="l42.846" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.847"></a><span id="l42.847" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.848"></a><span id="l42.848" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.849"></a><span id="l42.849" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.850"></a><span id="l42.850" class="difflineminus">-    },</span>
<a href="#l42.851"></a><span id="l42.851" class="difflineminus">-  ];</span>
<a href="#l42.852"></a><span id="l42.852" class="difflineminus">-  client = await gServer.getClient();</span>
<a href="#l42.853"></a><span id="l42.853" class="difflineminus">-  equal(client.getProperty(&quot;organizerCN&quot;), gServer.creator.displayName);</span>
<a href="#l42.854"></a><span id="l42.854" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.855"></a><span id="l42.855" class="difflineminus">-});</span>
<a href="#l42.856"></a><span id="l42.856" class="difflineminus">-</span>
<a href="#l42.857"></a><span id="l42.857" class="difflineminus">-add_task(async function test_always_readOnly() {</span>
<a href="#l42.858"></a><span id="l42.858" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.859"></a><span id="l42.859" class="difflineminus">-    {</span>
<a href="#l42.860"></a><span id="l42.860" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.861"></a><span id="l42.861" class="difflineminus">-      etag: '&quot;2299601498276000&quot;',</span>
<a href="#l42.862"></a><span id="l42.862" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.863"></a><span id="l42.863" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.864"></a><span id="l42.864" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.865"></a><span id="l42.865" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.866"></a><span id="l42.866" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.867"></a><span id="l42.867" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.868"></a><span id="l42.868" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.869"></a><span id="l42.869" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.870"></a><span id="l42.870" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.871"></a><span id="l42.871" class="difflineminus">-    },</span>
<a href="#l42.872"></a><span id="l42.872" class="difflineminus">-  ];</span>
<a href="#l42.873"></a><span id="l42.873" class="difflineminus">-  gServer.calendarListData.accessRole = &quot;freeBusyReader&quot;;</span>
<a href="#l42.874"></a><span id="l42.874" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.875"></a><span id="l42.875" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l42.876"></a><span id="l42.876" class="difflineminus">-  ok(client.readOnly);</span>
<a href="#l42.877"></a><span id="l42.877" class="difflineminus">-  client.readOnly = false;</span>
<a href="#l42.878"></a><span id="l42.878" class="difflineminus">-  ok(client.readOnly);</span>
<a href="#l42.879"></a><span id="l42.879" class="difflineminus">-</span>
<a href="#l42.880"></a><span id="l42.880" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.881"></a><span id="l42.881" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.882"></a><span id="l42.882" class="difflineminus">-  notEqual(items[0].title, &quot;New Event&quot;);</span>
<a href="#l42.883"></a><span id="l42.883" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.884"></a><span id="l42.884" class="difflineminus">-</span>
<a href="#l42.885"></a><span id="l42.885" class="difflineminus">-  gServer.calendarListData.accessRole = &quot;reader&quot;;</span>
<a href="#l42.886"></a><span id="l42.886" class="difflineminus">-  client = await gServer.getClient();</span>
<a href="#l42.887"></a><span id="l42.887" class="difflineminus">-  ok(client.readOnly);</span>
<a href="#l42.888"></a><span id="l42.888" class="difflineminus">-  client.readOnly = false;</span>
<a href="#l42.889"></a><span id="l42.889" class="difflineminus">-  ok(client.readOnly);</span>
<a href="#l42.890"></a><span id="l42.890" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.891"></a><span id="l42.891" class="difflineminus">-});</span>
<a href="#l42.892"></a><span id="l42.892" class="difflineminus">-</span>
<a href="#l42.893"></a><span id="l42.893" class="difflineminus">-add_task(async function test_reset_sync() {</span>
<a href="#l42.894"></a><span id="l42.894" class="difflineminus">-  gServer.tasks = [</span>
<a href="#l42.895"></a><span id="l42.895" class="difflineminus">-    {</span>
<a href="#l42.896"></a><span id="l42.896" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.897"></a><span id="l42.897" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.898"></a><span id="l42.898" class="difflineminus">-      etag: '&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM&quot;',</span>
<a href="#l42.899"></a><span id="l42.899" class="difflineminus">-      title: &quot;New Task&quot;,</span>
<a href="#l42.900"></a><span id="l42.900" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.901"></a><span id="l42.901" class="difflineminus">-      selfLink:</span>
<a href="#l42.902"></a><span id="l42.902" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.903"></a><span id="l42.903" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.904"></a><span id="l42.904" class="difflineminus">-      position: &quot;00000000000000130998&quot;,</span>
<a href="#l42.905"></a><span id="l42.905" class="difflineminus">-      status: &quot;needsAction&quot;,</span>
<a href="#l42.906"></a><span id="l42.906" class="difflineminus">-    },</span>
<a href="#l42.907"></a><span id="l42.907" class="difflineminus">-    {</span>
<a href="#l42.908"></a><span id="l42.908" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.909"></a><span id="l42.909" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l42.910"></a><span id="l42.910" class="difflineminus">-      etag: '&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTQyNTY0MjUwOQ&quot;',</span>
<a href="#l42.911"></a><span id="l42.911" class="difflineminus">-      title: &quot;New Task 2&quot;,</span>
<a href="#l42.912"></a><span id="l42.912" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.913"></a><span id="l42.913" class="difflineminus">-      selfLink:</span>
<a href="#l42.914"></a><span id="l42.914" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.915"></a><span id="l42.915" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l42.916"></a><span id="l42.916" class="difflineminus">-      position: &quot;00000000000000130993&quot;,</span>
<a href="#l42.917"></a><span id="l42.917" class="difflineminus">-      status: &quot;needsAction&quot;,</span>
<a href="#l42.918"></a><span id="l42.918" class="difflineminus">-    },</span>
<a href="#l42.919"></a><span id="l42.919" class="difflineminus">-  ];</span>
<a href="#l42.920"></a><span id="l42.920" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.921"></a><span id="l42.921" class="difflineminus">-    {</span>
<a href="#l42.922"></a><span id="l42.922" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.923"></a><span id="l42.923" class="difflineminus">-      etag: '&quot;1&quot;',</span>
<a href="#l42.924"></a><span id="l42.924" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.925"></a><span id="l42.925" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.926"></a><span id="l42.926" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.927"></a><span id="l42.927" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.928"></a><span id="l42.928" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.929"></a><span id="l42.929" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.930"></a><span id="l42.930" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.931"></a><span id="l42.931" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.932"></a><span id="l42.932" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.933"></a><span id="l42.933" class="difflineminus">-    },</span>
<a href="#l42.934"></a><span id="l42.934" class="difflineminus">-    {</span>
<a href="#l42.935"></a><span id="l42.935" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.936"></a><span id="l42.936" class="difflineminus">-      etag: '&quot;2&quot;',</span>
<a href="#l42.937"></a><span id="l42.937" class="difflineminus">-      id: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l42.938"></a><span id="l42.938" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.939"></a><span id="l42.939" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.940"></a><span id="l42.940" class="difflineminus">-      summary: &quot;New Event 2&quot;,</span>
<a href="#l42.941"></a><span id="l42.941" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.942"></a><span id="l42.942" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.943"></a><span id="l42.943" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.944"></a><span id="l42.944" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.945"></a><span id="l42.945" class="difflineminus">-      iCalUID: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;,</span>
<a href="#l42.946"></a><span id="l42.946" class="difflineminus">-    },</span>
<a href="#l42.947"></a><span id="l42.947" class="difflineminus">-  ];</span>
<a href="#l42.948"></a><span id="l42.948" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.949"></a><span id="l42.949" class="difflineminus">-  let uncached = client.wrappedJSObject.mUncachedCalendar.wrappedJSObject;</span>
<a href="#l42.950"></a><span id="l42.950" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l42.951"></a><span id="l42.951" class="difflineminus">-</span>
<a href="#l42.952"></a><span id="l42.952" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.953"></a><span id="l42.953" class="difflineminus">-  equal(items.length, 4);</span>
<a href="#l42.954"></a><span id="l42.954" class="difflineminus">-</span>
<a href="#l42.955"></a><span id="l42.955" class="difflineminus">-  notEqual(client.getProperty(&quot;syncToken.events&quot;), &quot;&quot;);</span>
<a href="#l42.956"></a><span id="l42.956" class="difflineminus">-  notEqual(client.getProperty(&quot;lastUpdated.tasks&quot;), &quot;&quot;);</span>
<a href="#l42.957"></a><span id="l42.957" class="difflineminus">-</span>
<a href="#l42.958"></a><span id="l42.958" class="difflineminus">-  await uncached.resetSync();</span>
<a href="#l42.959"></a><span id="l42.959" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.960"></a><span id="l42.960" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.961"></a><span id="l42.961" class="difflineminus">-</span>
<a href="#l42.962"></a><span id="l42.962" class="difflineminus">-  equal(client.getProperty(&quot;syncToken.events&quot;), &quot;&quot;);</span>
<a href="#l42.963"></a><span id="l42.963" class="difflineminus">-  equal(client.getProperty(&quot;lastUpdated.tasks&quot;), &quot;&quot;);</span>
<a href="#l42.964"></a><span id="l42.964" class="difflineminus">-</span>
<a href="#l42.965"></a><span id="l42.965" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.966"></a><span id="l42.966" class="difflineminus">-});</span>
<a href="#l42.967"></a><span id="l42.967" class="difflineminus">-</span>
<a href="#l42.968"></a><span id="l42.968" class="difflineminus">-add_task(async function test_basicItems() {</span>
<a href="#l42.969"></a><span id="l42.969" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.970"></a><span id="l42.970" class="difflineminus">-    {</span>
<a href="#l42.971"></a><span id="l42.971" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.972"></a><span id="l42.972" class="difflineminus">-      etag: '&quot;2299601498276000&quot;',</span>
<a href="#l42.973"></a><span id="l42.973" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.974"></a><span id="l42.974" class="difflineminus">-      status: &quot;confirmed&quot;,</span>
<a href="#l42.975"></a><span id="l42.975" class="difflineminus">-      htmlLink: gServer.baseUri + &quot;/calendar/event?eid=eventhash&quot;,</span>
<a href="#l42.976"></a><span id="l42.976" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.977"></a><span id="l42.977" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.978"></a><span id="l42.978" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.979"></a><span id="l42.979" class="difflineminus">-      description: &quot;description&quot;,</span>
<a href="#l42.980"></a><span id="l42.980" class="difflineminus">-      location: &quot;Hard Drive&quot;,</span>
<a href="#l42.981"></a><span id="l42.981" class="difflineminus">-      colorId: 17,</span>
<a href="#l42.982"></a><span id="l42.982" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.983"></a><span id="l42.983" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.984"></a><span id="l42.984" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.985"></a><span id="l42.985" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.986"></a><span id="l42.986" class="difflineminus">-      transparency: &quot;transparent&quot;,</span>
<a href="#l42.987"></a><span id="l42.987" class="difflineminus">-      visibility: &quot;private&quot;,</span>
<a href="#l42.988"></a><span id="l42.988" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.989"></a><span id="l42.989" class="difflineminus">-      sequence: 1,</span>
<a href="#l42.990"></a><span id="l42.990" class="difflineminus">-      reminders: {</span>
<a href="#l42.991"></a><span id="l42.991" class="difflineminus">-        useDefault: false,</span>
<a href="#l42.992"></a><span id="l42.992" class="difflineminus">-        overrides: [</span>
<a href="#l42.993"></a><span id="l42.993" class="difflineminus">-          {</span>
<a href="#l42.994"></a><span id="l42.994" class="difflineminus">-            method: &quot;email&quot;,</span>
<a href="#l42.995"></a><span id="l42.995" class="difflineminus">-            minutes: 20,</span>
<a href="#l42.996"></a><span id="l42.996" class="difflineminus">-          },</span>
<a href="#l42.997"></a><span id="l42.997" class="difflineminus">-        ],</span>
<a href="#l42.998"></a><span id="l42.998" class="difflineminus">-      },</span>
<a href="#l42.999"></a><span id="l42.999" class="difflineminus">-      attendees: [</span>
<a href="#l42.1000"></a><span id="l42.1000" class="difflineminus">-        {</span>
<a href="#l42.1001"></a><span id="l42.1001" class="difflineminus">-          displayName: &quot;attendee name&quot;,</span>
<a href="#l42.1002"></a><span id="l42.1002" class="difflineminus">-          email: &quot;attendee@example.com&quot;,</span>
<a href="#l42.1003"></a><span id="l42.1003" class="difflineminus">-          optional: true,</span>
<a href="#l42.1004"></a><span id="l42.1004" class="difflineminus">-          responseStatus: &quot;tentative&quot;,</span>
<a href="#l42.1005"></a><span id="l42.1005" class="difflineminus">-        },</span>
<a href="#l42.1006"></a><span id="l42.1006" class="difflineminus">-      ],</span>
<a href="#l42.1007"></a><span id="l42.1007" class="difflineminus">-</span>
<a href="#l42.1008"></a><span id="l42.1008" class="difflineminus">-      extendedProperties: {</span>
<a href="#l42.1009"></a><span id="l42.1009" class="difflineminus">-        shared: { &quot;X-MOZ-CATEGORIES&quot;: &quot;foo,bar&quot; },</span>
<a href="#l42.1010"></a><span id="l42.1010" class="difflineminus">-        private: {</span>
<a href="#l42.1011"></a><span id="l42.1011" class="difflineminus">-          &quot;X-MOZ-LASTACK&quot;: &quot;2014-01-01T01:01:01Z&quot;,</span>
<a href="#l42.1012"></a><span id="l42.1012" class="difflineminus">-          &quot;X-MOZ-SNOOZE-TIME&quot;: &quot;2014-01-01T02:02:02Z&quot;,</span>
<a href="#l42.1013"></a><span id="l42.1013" class="difflineminus">-        },</span>
<a href="#l42.1014"></a><span id="l42.1014" class="difflineminus">-      },</span>
<a href="#l42.1015"></a><span id="l42.1015" class="difflineminus">-    },</span>
<a href="#l42.1016"></a><span id="l42.1016" class="difflineminus">-  ];</span>
<a href="#l42.1017"></a><span id="l42.1017" class="difflineminus">-</span>
<a href="#l42.1018"></a><span id="l42.1018" class="difflineminus">-  gServer.tasks = [</span>
<a href="#l42.1019"></a><span id="l42.1019" class="difflineminus">-    {</span>
<a href="#l42.1020"></a><span id="l42.1020" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.1021"></a><span id="l42.1021" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.1022"></a><span id="l42.1022" class="difflineminus">-      etag: '&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM&quot;',</span>
<a href="#l42.1023"></a><span id="l42.1023" class="difflineminus">-      title: &quot;New Task&quot;,</span>
<a href="#l42.1024"></a><span id="l42.1024" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.1025"></a><span id="l42.1025" class="difflineminus">-      selfLink:</span>
<a href="#l42.1026"></a><span id="l42.1026" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.1027"></a><span id="l42.1027" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.1028"></a><span id="l42.1028" class="difflineminus">-      position: &quot;00000000000000130998&quot;,</span>
<a href="#l42.1029"></a><span id="l42.1029" class="difflineminus">-      status: &quot;completed&quot;,</span>
<a href="#l42.1030"></a><span id="l42.1030" class="difflineminus">-      due: &quot;2014-09-04T00:00:00.000Z&quot;,</span>
<a href="#l42.1031"></a><span id="l42.1031" class="difflineminus">-      completed: &quot;2014-09-01T17:00:00.000Z&quot;,</span>
<a href="#l42.1032"></a><span id="l42.1032" class="difflineminus">-      notes: &quot;description&quot;,</span>
<a href="#l42.1033"></a><span id="l42.1033" class="difflineminus">-      parent: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;,</span>
<a href="#l42.1034"></a><span id="l42.1034" class="difflineminus">-      links: [</span>
<a href="#l42.1035"></a><span id="l42.1035" class="difflineminus">-        {</span>
<a href="#l42.1036"></a><span id="l42.1036" class="difflineminus">-          link: &quot;mailto:something@example.com&quot;,</span>
<a href="#l42.1037"></a><span id="l42.1037" class="difflineminus">-          description: &quot;link description&quot;,</span>
<a href="#l42.1038"></a><span id="l42.1038" class="difflineminus">-          type: &quot;email&quot;,</span>
<a href="#l42.1039"></a><span id="l42.1039" class="difflineminus">-        },</span>
<a href="#l42.1040"></a><span id="l42.1040" class="difflineminus">-      ],</span>
<a href="#l42.1041"></a><span id="l42.1041" class="difflineminus">-    },</span>
<a href="#l42.1042"></a><span id="l42.1042" class="difflineminus">-  ];</span>
<a href="#l42.1043"></a><span id="l42.1043" class="difflineminus">-</span>
<a href="#l42.1044"></a><span id="l42.1044" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1045"></a><span id="l42.1045" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l42.1046"></a><span id="l42.1046" class="difflineminus">-</span>
<a href="#l42.1047"></a><span id="l42.1047" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1048"></a><span id="l42.1048" class="difflineminus">-  equal(items.length, 2);</span>
<a href="#l42.1049"></a><span id="l42.1049" class="difflineminus">-</span>
<a href="#l42.1050"></a><span id="l42.1050" class="difflineminus">-  let event = cal.item.isEvent(items[0]) ? items[0] : items[1];</span>
<a href="#l42.1051"></a><span id="l42.1051" class="difflineminus">-  equal(event.id, &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;);</span>
<a href="#l42.1052"></a><span id="l42.1052" class="difflineminus">-  equal(event.getProperty(&quot;STATUS&quot;), &quot;CONFIRMED&quot;);</span>
<a href="#l42.1053"></a><span id="l42.1053" class="difflineminus">-  equal(event.getProperty(&quot;URL&quot;), gServer.baseUri + &quot;/calendar/event?eid=eventhash&quot;);</span>
<a href="#l42.1054"></a><span id="l42.1054" class="difflineminus">-  equal(event.getProperty(&quot;CREATED&quot;).icalString, &quot;20060608T210452Z&quot;);</span>
<a href="#l42.1055"></a><span id="l42.1055" class="difflineminus">-  equal(event.getProperty(&quot;LAST-MODIFIED&quot;).icalString, &quot;20060608T210549Z&quot;);</span>
<a href="#l42.1056"></a><span id="l42.1056" class="difflineminus">-  equal(event.title, &quot;New Event&quot;);</span>
<a href="#l42.1057"></a><span id="l42.1057" class="difflineminus">-  equal(event.getProperty(&quot;DESCRIPTION&quot;), &quot;description&quot;);</span>
<a href="#l42.1058"></a><span id="l42.1058" class="difflineminus">-  equal(event.getProperty(&quot;LOCATION&quot;), &quot;Hard Drive&quot;);</span>
<a href="#l42.1059"></a><span id="l42.1059" class="difflineminus">-  equal(event.organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l42.1060"></a><span id="l42.1060" class="difflineminus">-  equal(event.organizer.commonName, &quot;Eggs P. Seashell&quot;);</span>
<a href="#l42.1061"></a><span id="l42.1061" class="difflineminus">-  ok(event.organizer.isOrganizer);</span>
<a href="#l42.1062"></a><span id="l42.1062" class="difflineminus">-  equal(event.startDate.icalString, &quot;20060610T180000&quot;);</span>
<a href="#l42.1063"></a><span id="l42.1063" class="difflineminus">-  equal(event.startDate.timezone.tzid, &quot;Europe/Berlin&quot;);</span>
<a href="#l42.1064"></a><span id="l42.1064" class="difflineminus">-  equal(event.endDate.icalString, &quot;20060610T200000&quot;);</span>
<a href="#l42.1065"></a><span id="l42.1065" class="difflineminus">-  equal(event.getProperty(&quot;TRANSP&quot;), &quot;TRANSPARENT&quot;);</span>
<a href="#l42.1066"></a><span id="l42.1066" class="difflineminus">-  equal(event.privacy, &quot;PRIVATE&quot;);</span>
<a href="#l42.1067"></a><span id="l42.1067" class="difflineminus">-  equal(event.getProperty(&quot;SEQUENCE&quot;), 1);</span>
<a href="#l42.1068"></a><span id="l42.1068" class="difflineminus">-  let alarms = event.getAlarms({});</span>
<a href="#l42.1069"></a><span id="l42.1069" class="difflineminus">-  equal(alarms.length, 1);</span>
<a href="#l42.1070"></a><span id="l42.1070" class="difflineminus">-  equal(alarms[0].action, &quot;EMAIL&quot;);</span>
<a href="#l42.1071"></a><span id="l42.1071" class="difflineminus">-  equal(alarms[0].related, alarms[0].ALARM_RELATED_START);</span>
<a href="#l42.1072"></a><span id="l42.1072" class="difflineminus">-  equal(alarms[0].offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l42.1073"></a><span id="l42.1073" class="difflineminus">-  equal(alarms[0].getProperty(&quot;X-DEFAULT-ALARM&quot;), null);</span>
<a href="#l42.1074"></a><span id="l42.1074" class="difflineminus">-  let attendees = event.getAttendees({});</span>
<a href="#l42.1075"></a><span id="l42.1075" class="difflineminus">-  equal(attendees.length, 1);</span>
<a href="#l42.1076"></a><span id="l42.1076" class="difflineminus">-  equal(attendees[0].id, &quot;mailto:attendee@example.com&quot;);</span>
<a href="#l42.1077"></a><span id="l42.1077" class="difflineminus">-  equal(attendees[0].commonName, &quot;attendee name&quot;);</span>
<a href="#l42.1078"></a><span id="l42.1078" class="difflineminus">-  equal(attendees[0].role, &quot;OPT-PARTICIPANT&quot;);</span>
<a href="#l42.1079"></a><span id="l42.1079" class="difflineminus">-  equal(attendees[0].participationStatus, &quot;TENTATIVE&quot;);</span>
<a href="#l42.1080"></a><span id="l42.1080" class="difflineminus">-  equal(event.getCategories({}), &quot;foo,bar&quot;);</span>
<a href="#l42.1081"></a><span id="l42.1081" class="difflineminus">-  equal(event.alarmLastAck.icalString, &quot;20140101T010101Z&quot;);</span>
<a href="#l42.1082"></a><span id="l42.1082" class="difflineminus">-  equal(event.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;), &quot;20140101T020202Z&quot;);</span>
<a href="#l42.1083"></a><span id="l42.1083" class="difflineminus">-</span>
<a href="#l42.1084"></a><span id="l42.1084" class="difflineminus">-  let task = cal.item.isToDo(items[0]) ? items[0] : items[1];</span>
<a href="#l42.1085"></a><span id="l42.1085" class="difflineminus">-  equal(task.id, &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;);</span>
<a href="#l42.1086"></a><span id="l42.1086" class="difflineminus">-  equal(task.title, &quot;New Task&quot;);</span>
<a href="#l42.1087"></a><span id="l42.1087" class="difflineminus">-  equal(task.getProperty(&quot;LAST-MODIFIED&quot;).icalString, &quot;20140908T163027Z&quot;);</span>
<a href="#l42.1088"></a><span id="l42.1088" class="difflineminus">-  equal(task.getProperty(&quot;X-GOOGLE-SORTKEY&quot;), &quot;00000000000000130998&quot;);</span>
<a href="#l42.1089"></a><span id="l42.1089" class="difflineminus">-  ok(task.isCompleted);</span>
<a href="#l42.1090"></a><span id="l42.1090" class="difflineminus">-  equal(task.dueDate.icalString, &quot;20140904&quot;);</span>
<a href="#l42.1091"></a><span id="l42.1091" class="difflineminus">-  equal(task.completedDate.icalString, &quot;20140901T170000Z&quot;);</span>
<a href="#l42.1092"></a><span id="l42.1092" class="difflineminus">-  equal(task.getProperty(&quot;DESCRIPTION&quot;), &quot;description&quot;);</span>
<a href="#l42.1093"></a><span id="l42.1093" class="difflineminus">-  let relations = task.getRelations({});</span>
<a href="#l42.1094"></a><span id="l42.1094" class="difflineminus">-  equal(relations.length, 1);</span>
<a href="#l42.1095"></a><span id="l42.1095" class="difflineminus">-  equal(relations[0].relType, &quot;PARENT&quot;);</span>
<a href="#l42.1096"></a><span id="l42.1096" class="difflineminus">-  equal(relations[0].relId, &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;);</span>
<a href="#l42.1097"></a><span id="l42.1097" class="difflineminus">-  let attachments = task.getAttachments({});</span>
<a href="#l42.1098"></a><span id="l42.1098" class="difflineminus">-  equal(attachments.length, 1);</span>
<a href="#l42.1099"></a><span id="l42.1099" class="difflineminus">-  equal(attachments[0].uri.spec, &quot;mailto:something@example.com&quot;);</span>
<a href="#l42.1100"></a><span id="l42.1100" class="difflineminus">-  equal(attachments[0].getParameter(&quot;X-GOOGLE-TYPE&quot;), &quot;email&quot;);</span>
<a href="#l42.1101"></a><span id="l42.1101" class="difflineminus">-  equal(attachments[0].getParameter(&quot;FILENAME&quot;), &quot;link description&quot;);</span>
<a href="#l42.1102"></a><span id="l42.1102" class="difflineminus">-</span>
<a href="#l42.1103"></a><span id="l42.1103" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1104"></a><span id="l42.1104" class="difflineminus">-});</span>
<a href="#l42.1105"></a><span id="l42.1105" class="difflineminus">-</span>
<a href="#l42.1106"></a><span id="l42.1106" class="difflineminus">-add_task(async function test_addModifyDeleteItem() {</span>
<a href="#l42.1107"></a><span id="l42.1107" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1108"></a><span id="l42.1108" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1109"></a><span id="l42.1109" class="difflineminus">-  equal(gServer.events.length, 0);</span>
<a href="#l42.1110"></a><span id="l42.1110" class="difflineminus">-  equal(gServer.tasks.length, 0);</span>
<a href="#l42.1111"></a><span id="l42.1111" class="difflineminus">-</span>
<a href="#l42.1112"></a><span id="l42.1112" class="difflineminus">-  let event = cal.createEvent(</span>
<a href="#l42.1113"></a><span id="l42.1113" class="difflineminus">-    [</span>
<a href="#l42.1114"></a><span id="l42.1114" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1115"></a><span id="l42.1115" class="difflineminus">-      &quot;CREATED:20060608T210452Z&quot;,</span>
<a href="#l42.1116"></a><span id="l42.1116" class="difflineminus">-      &quot;LAST-MODIFIED:20060608T210549Z&quot;,</span>
<a href="#l42.1117"></a><span id="l42.1117" class="difflineminus">-      &quot;DTSTAMP:20060608T210549Z&quot;,</span>
<a href="#l42.1118"></a><span id="l42.1118" class="difflineminus">-      &quot;SUMMARY:New Event&quot;,</span>
<a href="#l42.1119"></a><span id="l42.1119" class="difflineminus">-      &quot;STATUS:CONFIRMED&quot;,</span>
<a href="#l42.1120"></a><span id="l42.1120" class="difflineminus">-      &quot;ORGANIZER;CN=Eggs P. Seashell:mailto:xpcshell@example.com&quot;,</span>
<a href="#l42.1121"></a><span id="l42.1121" class="difflineminus">-      &quot;ATTENDEE;CN=attendee name;PARTSTAT=TENTATIVE;CUTYPE=INDIVIDUAL;ROLE=OPT-PA&quot;,</span>
<a href="#l42.1122"></a><span id="l42.1122" class="difflineminus">-      &quot; RTICIPANT:mailto:attendee@example.com&quot;,</span>
<a href="#l42.1123"></a><span id="l42.1123" class="difflineminus">-      &quot;CATEGORIES:foo&quot;,</span>
<a href="#l42.1124"></a><span id="l42.1124" class="difflineminus">-      &quot;CATEGORIES:bar&quot;,</span>
<a href="#l42.1125"></a><span id="l42.1125" class="difflineminus">-      &quot;X-MOZ-LASTACK:20140101T010101Z&quot;,</span>
<a href="#l42.1126"></a><span id="l42.1126" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1127"></a><span id="l42.1127" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1128"></a><span id="l42.1128" class="difflineminus">-      &quot;CLASS:PRIVATE&quot;,</span>
<a href="#l42.1129"></a><span id="l42.1129" class="difflineminus">-      &quot;URL:http://eventlocation&quot;,</span>
<a href="#l42.1130"></a><span id="l42.1130" class="difflineminus">-      &quot;DESCRIPTION:description&quot;,</span>
<a href="#l42.1131"></a><span id="l42.1131" class="difflineminus">-      &quot;LOCATION:Hard Drive&quot;,</span>
<a href="#l42.1132"></a><span id="l42.1132" class="difflineminus">-      &quot;TRANSP:TRANSPARENT&quot;,</span>
<a href="#l42.1133"></a><span id="l42.1133" class="difflineminus">-      &quot;SEQUENCE:1&quot;,</span>
<a href="#l42.1134"></a><span id="l42.1134" class="difflineminus">-      &quot;X-MOZ-SNOOZE-TIME:20140101T020202Z&quot;,</span>
<a href="#l42.1135"></a><span id="l42.1135" class="difflineminus">-      &quot;BEGIN:VALARM&quot;,</span>
<a href="#l42.1136"></a><span id="l42.1136" class="difflineminus">-      &quot;ACTION:EMAIL&quot;,</span>
<a href="#l42.1137"></a><span id="l42.1137" class="difflineminus">-      &quot;TRIGGER;VALUE=DURATION:-PT20M&quot;,</span>
<a href="#l42.1138"></a><span id="l42.1138" class="difflineminus">-      &quot;SUMMARY:Default Mozilla Summary&quot;,</span>
<a href="#l42.1139"></a><span id="l42.1139" class="difflineminus">-      &quot;DESCRIPTION:Default Mozilla Description&quot;,</span>
<a href="#l42.1140"></a><span id="l42.1140" class="difflineminus">-      &quot;END:VALARM&quot;,</span>
<a href="#l42.1141"></a><span id="l42.1141" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1142"></a><span id="l42.1142" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1143"></a><span id="l42.1143" class="difflineminus">-  );</span>
<a href="#l42.1144"></a><span id="l42.1144" class="difflineminus">-</span>
<a href="#l42.1145"></a><span id="l42.1145" class="difflineminus">-  let task = cal.createTodo(</span>
<a href="#l42.1146"></a><span id="l42.1146" class="difflineminus">-    [</span>
<a href="#l42.1147"></a><span id="l42.1147" class="difflineminus">-      &quot;BEGIN:VTODO&quot;,</span>
<a href="#l42.1148"></a><span id="l42.1148" class="difflineminus">-      &quot;SUMMARY:New Task&quot;,</span>
<a href="#l42.1149"></a><span id="l42.1149" class="difflineminus">-      &quot;DESCRIPTION:description&quot;,</span>
<a href="#l42.1150"></a><span id="l42.1150" class="difflineminus">-      &quot;X-SORTKEY:00000000000000130998&quot;,</span>
<a href="#l42.1151"></a><span id="l42.1151" class="difflineminus">-      &quot;STATUS:COMPLETED&quot;,</span>
<a href="#l42.1152"></a><span id="l42.1152" class="difflineminus">-      &quot;DUE;VALUE=DATE:20140904&quot;,</span>
<a href="#l42.1153"></a><span id="l42.1153" class="difflineminus">-      &quot;COMPLETED:20140901T170000Z&quot;,</span>
<a href="#l42.1154"></a><span id="l42.1154" class="difflineminus">-      &quot;RELATED-TO;RELTYPE=PARENT:MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo4MDIzOTU2NDc&quot;,</span>
<a href="#l42.1155"></a><span id="l42.1155" class="difflineminus">-      'ATTACH;FILENAME=&quot;link description&quot;;X-GOOGLE-TYPE=email:mailto:something@example.com',</span>
<a href="#l42.1156"></a><span id="l42.1156" class="difflineminus">-      &quot;END:VTODO&quot;,</span>
<a href="#l42.1157"></a><span id="l42.1157" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1158"></a><span id="l42.1158" class="difflineminus">-  );</span>
<a href="#l42.1159"></a><span id="l42.1159" class="difflineminus">-</span>
<a href="#l42.1160"></a><span id="l42.1160" class="difflineminus">-  // Add an event</span>
<a href="#l42.1161"></a><span id="l42.1161" class="difflineminus">-  let addedEvent = await pclient.adoptItem(event);</span>
<a href="#l42.1162"></a><span id="l42.1162" class="difflineminus">-  notEqual(addedEvent.id, null);</span>
<a href="#l42.1163"></a><span id="l42.1163" class="difflineminus">-  equal(addedEvent.organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l42.1164"></a><span id="l42.1164" class="difflineminus">-</span>
<a href="#l42.1165"></a><span id="l42.1165" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1166"></a><span id="l42.1166" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1167"></a><span id="l42.1167" class="difflineminus">-  equal(items[0].id, addedEvent.id);</span>
<a href="#l42.1168"></a><span id="l42.1168" class="difflineminus">-  equal(items[0].organizer.id, &quot;mailto:xpcshell@example.com&quot;);</span>
<a href="#l42.1169"></a><span id="l42.1169" class="difflineminus">-</span>
<a href="#l42.1170"></a><span id="l42.1170" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1171"></a><span id="l42.1171" class="difflineminus">-  equal(gServer.tasks.length, 0);</span>
<a href="#l42.1172"></a><span id="l42.1172" class="difflineminus">-</span>
<a href="#l42.1173"></a><span id="l42.1173" class="difflineminus">-  // Add a task</span>
<a href="#l42.1174"></a><span id="l42.1174" class="difflineminus">-  let addedTask = await pclient.adoptItem(task);</span>
<a href="#l42.1175"></a><span id="l42.1175" class="difflineminus">-  notEqual(addedTask.id, null);</span>
<a href="#l42.1176"></a><span id="l42.1176" class="difflineminus">-</span>
<a href="#l42.1177"></a><span id="l42.1177" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1178"></a><span id="l42.1178" class="difflineminus">-  equal(items.length, 2);</span>
<a href="#l42.1179"></a><span id="l42.1179" class="difflineminus">-  equal(items[1].id, addedTask.id);</span>
<a href="#l42.1180"></a><span id="l42.1180" class="difflineminus">-</span>
<a href="#l42.1181"></a><span id="l42.1181" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1182"></a><span id="l42.1182" class="difflineminus">-  equal(gServer.tasks.length, 1);</span>
<a href="#l42.1183"></a><span id="l42.1183" class="difflineminus">-</span>
<a href="#l42.1184"></a><span id="l42.1184" class="difflineminus">-  // Modify an event</span>
<a href="#l42.1185"></a><span id="l42.1185" class="difflineminus">-  let newEvent = items[0].clone();</span>
<a href="#l42.1186"></a><span id="l42.1186" class="difflineminus">-  newEvent.title = &quot;changed&quot;;</span>
<a href="#l42.1187"></a><span id="l42.1187" class="difflineminus">-</span>
<a href="#l42.1188"></a><span id="l42.1188" class="difflineminus">-  let modifiedEvent = await pclient.modifyItem(newEvent, items[0]);</span>
<a href="#l42.1189"></a><span id="l42.1189" class="difflineminus">-  equal(modifiedEvent.title, &quot;changed&quot;);</span>
<a href="#l42.1190"></a><span id="l42.1190" class="difflineminus">-  notEqual(modifiedEvent.getProperty(&quot;LAST-MODIFIED&quot;), addedEvent.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l42.1191"></a><span id="l42.1191" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1192"></a><span id="l42.1192" class="difflineminus">-  equal(items.length, 2);</span>
<a href="#l42.1193"></a><span id="l42.1193" class="difflineminus">-  equal(items[0].title, &quot;changed&quot;);</span>
<a href="#l42.1194"></a><span id="l42.1194" class="difflineminus">-  equal(items[0].id, addedEvent.id);</span>
<a href="#l42.1195"></a><span id="l42.1195" class="difflineminus">-  equal(items[0].getProperty(&quot;LAST-MODIFIED&quot;), modifiedEvent.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l42.1196"></a><span id="l42.1196" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1197"></a><span id="l42.1197" class="difflineminus">-  equal(gServer.tasks.length, 1);</span>
<a href="#l42.1198"></a><span id="l42.1198" class="difflineminus">-</span>
<a href="#l42.1199"></a><span id="l42.1199" class="difflineminus">-  // Modify a task</span>
<a href="#l42.1200"></a><span id="l42.1200" class="difflineminus">-  let newTask = items[1].clone();</span>
<a href="#l42.1201"></a><span id="l42.1201" class="difflineminus">-  newTask.title = &quot;changed&quot;;</span>
<a href="#l42.1202"></a><span id="l42.1202" class="difflineminus">-</span>
<a href="#l42.1203"></a><span id="l42.1203" class="difflineminus">-  let modifiedTask = await pclient.modifyItem(newTask, items[1]);</span>
<a href="#l42.1204"></a><span id="l42.1204" class="difflineminus">-  equal(modifiedTask.title, &quot;changed&quot;);</span>
<a href="#l42.1205"></a><span id="l42.1205" class="difflineminus">-  notEqual(modifiedTask.getProperty(&quot;LAST-MODIFIED&quot;), addedTask.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l42.1206"></a><span id="l42.1206" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1207"></a><span id="l42.1207" class="difflineminus">-  equal(items.length, 2);</span>
<a href="#l42.1208"></a><span id="l42.1208" class="difflineminus">-  equal(items[1].title, &quot;changed&quot;);</span>
<a href="#l42.1209"></a><span id="l42.1209" class="difflineminus">-  equal(items[1].id, addedTask.id);</span>
<a href="#l42.1210"></a><span id="l42.1210" class="difflineminus">-  equal(items[1].getProperty(&quot;LAST-MODIFIED&quot;), modifiedTask.getProperty(&quot;LAST-MODIFIED&quot;));</span>
<a href="#l42.1211"></a><span id="l42.1211" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1212"></a><span id="l42.1212" class="difflineminus">-  equal(gServer.tasks.length, 1);</span>
<a href="#l42.1213"></a><span id="l42.1213" class="difflineminus">-</span>
<a href="#l42.1214"></a><span id="l42.1214" class="difflineminus">-  // Delete an event</span>
<a href="#l42.1215"></a><span id="l42.1215" class="difflineminus">-  await pclient.deleteItem(modifiedEvent);</span>
<a href="#l42.1216"></a><span id="l42.1216" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1217"></a><span id="l42.1217" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1218"></a><span id="l42.1218" class="difflineminus">-  equal(gServer.events.length, 0);</span>
<a href="#l42.1219"></a><span id="l42.1219" class="difflineminus">-  equal(gServer.tasks.length, 1);</span>
<a href="#l42.1220"></a><span id="l42.1220" class="difflineminus">-</span>
<a href="#l42.1221"></a><span id="l42.1221" class="difflineminus">-  // Delete a task</span>
<a href="#l42.1222"></a><span id="l42.1222" class="difflineminus">-  await pclient.deleteItem(modifiedTask);</span>
<a href="#l42.1223"></a><span id="l42.1223" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1224"></a><span id="l42.1224" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.1225"></a><span id="l42.1225" class="difflineminus">-  equal(gServer.events.length, 0);</span>
<a href="#l42.1226"></a><span id="l42.1226" class="difflineminus">-  equal(gServer.tasks.length, 0);</span>
<a href="#l42.1227"></a><span id="l42.1227" class="difflineminus">-</span>
<a href="#l42.1228"></a><span id="l42.1228" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1229"></a><span id="l42.1229" class="difflineminus">-});</span>
<a href="#l42.1230"></a><span id="l42.1230" class="difflineminus">-</span>
<a href="#l42.1231"></a><span id="l42.1231" class="difflineminus">-add_task(async function test_recurring_event() {</span>
<a href="#l42.1232"></a><span id="l42.1232" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1233"></a><span id="l42.1233" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1234"></a><span id="l42.1234" class="difflineminus">-</span>
<a href="#l42.1235"></a><span id="l42.1235" class="difflineminus">-  let event = cal.createEvent(</span>
<a href="#l42.1236"></a><span id="l42.1236" class="difflineminus">-    [</span>
<a href="#l42.1237"></a><span id="l42.1237" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1238"></a><span id="l42.1238" class="difflineminus">-      &quot;SUMMARY:Recurring Event&quot;,</span>
<a href="#l42.1239"></a><span id="l42.1239" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1240"></a><span id="l42.1240" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1241"></a><span id="l42.1241" class="difflineminus">-      &quot;RRULE:FREQ=WEEKLY&quot;,</span>
<a href="#l42.1242"></a><span id="l42.1242" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1243"></a><span id="l42.1243" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1244"></a><span id="l42.1244" class="difflineminus">-  );</span>
<a href="#l42.1245"></a><span id="l42.1245" class="difflineminus">-</span>
<a href="#l42.1246"></a><span id="l42.1246" class="difflineminus">-  event = await pclient.addItem(event);</span>
<a href="#l42.1247"></a><span id="l42.1247" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1248"></a><span id="l42.1248" class="difflineminus">-  equal(gServer.events[0].recurrence.length, 1);</span>
<a href="#l42.1249"></a><span id="l42.1249" class="difflineminus">-  equal(gServer.events[0].recurrence[0], &quot;RRULE:FREQ=WEEKLY&quot;);</span>
<a href="#l42.1250"></a><span id="l42.1250" class="difflineminus">-</span>
<a href="#l42.1251"></a><span id="l42.1251" class="difflineminus">-  let occ = event.recurrenceInfo.getNextOccurrence(event.startDate);</span>
<a href="#l42.1252"></a><span id="l42.1252" class="difflineminus">-  let changedOcc = occ.clone();</span>
<a href="#l42.1253"></a><span id="l42.1253" class="difflineminus">-  changedOcc.title = &quot;changed&quot;;</span>
<a href="#l42.1254"></a><span id="l42.1254" class="difflineminus">-  event.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l42.1255"></a><span id="l42.1255" class="difflineminus">-</span>
<a href="#l42.1256"></a><span id="l42.1256" class="difflineminus">-  event = await pclient.modifyItem(changedOcc, occ);</span>
<a href="#l42.1257"></a><span id="l42.1257" class="difflineminus">-  occ = event.recurrenceInfo.getNextOccurrence(event.startDate);</span>
<a href="#l42.1258"></a><span id="l42.1258" class="difflineminus">-  equal(occ.title, &quot;changed&quot;);</span>
<a href="#l42.1259"></a><span id="l42.1259" class="difflineminus">-  equal(gServer.events.length, 2);</span>
<a href="#l42.1260"></a><span id="l42.1260" class="difflineminus">-</span>
<a href="#l42.1261"></a><span id="l42.1261" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1262"></a><span id="l42.1262" class="difflineminus">-});</span>
<a href="#l42.1263"></a><span id="l42.1263" class="difflineminus">-</span>
<a href="#l42.1264"></a><span id="l42.1264" class="difflineminus">-add_task(async function test_recurring_exception() {</span>
<a href="#l42.1265"></a><span id="l42.1265" class="difflineminus">-  gServer.syncs = [</span>
<a href="#l42.1266"></a><span id="l42.1266" class="difflineminus">-    {</span>
<a href="#l42.1267"></a><span id="l42.1267" class="difflineminus">-      token: &quot;1&quot;,</span>
<a href="#l42.1268"></a><span id="l42.1268" class="difflineminus">-      events: [</span>
<a href="#l42.1269"></a><span id="l42.1269" class="difflineminus">-        {</span>
<a href="#l42.1270"></a><span id="l42.1270" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1271"></a><span id="l42.1271" class="difflineminus">-          etag: '&quot;1&quot;',</span>
<a href="#l42.1272"></a><span id="l42.1272" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1273"></a><span id="l42.1273" class="difflineminus">-          created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1274"></a><span id="l42.1274" class="difflineminus">-          updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1275"></a><span id="l42.1275" class="difflineminus">-          summary: &quot;New Event&quot;,</span>
<a href="#l42.1276"></a><span id="l42.1276" class="difflineminus">-          creator: gServer.creator,</span>
<a href="#l42.1277"></a><span id="l42.1277" class="difflineminus">-          organizer: gServer.creator,</span>
<a href="#l42.1278"></a><span id="l42.1278" class="difflineminus">-          start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1279"></a><span id="l42.1279" class="difflineminus">-          end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1280"></a><span id="l42.1280" class="difflineminus">-          iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1281"></a><span id="l42.1281" class="difflineminus">-          recurrence: [&quot;RRULE:FREQ=WEEKLY&quot;],</span>
<a href="#l42.1282"></a><span id="l42.1282" class="difflineminus">-        },</span>
<a href="#l42.1283"></a><span id="l42.1283" class="difflineminus">-        {</span>
<a href="#l42.1284"></a><span id="l42.1284" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1285"></a><span id="l42.1285" class="difflineminus">-          etag: '&quot;2&quot;',</span>
<a href="#l42.1286"></a><span id="l42.1286" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo_20060617T160000Z&quot;,</span>
<a href="#l42.1287"></a><span id="l42.1287" class="difflineminus">-          summary: &quot;New Event changed&quot;,</span>
<a href="#l42.1288"></a><span id="l42.1288" class="difflineminus">-          start: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1289"></a><span id="l42.1289" class="difflineminus">-          end: { dateTime: &quot;2006-06-17T20:00:00+02:00&quot; },</span>
<a href="#l42.1290"></a><span id="l42.1290" class="difflineminus">-          recurringEventId: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1291"></a><span id="l42.1291" class="difflineminus">-          originalStartTime: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1292"></a><span id="l42.1292" class="difflineminus">-        },</span>
<a href="#l42.1293"></a><span id="l42.1293" class="difflineminus">-      ],</span>
<a href="#l42.1294"></a><span id="l42.1294" class="difflineminus">-    },</span>
<a href="#l42.1295"></a><span id="l42.1295" class="difflineminus">-    {</span>
<a href="#l42.1296"></a><span id="l42.1296" class="difflineminus">-      // This sync run tests an exception where the master item is not part</span>
<a href="#l42.1297"></a><span id="l42.1297" class="difflineminus">-      // of the item stream.</span>
<a href="#l42.1298"></a><span id="l42.1298" class="difflineminus">-      token: &quot;2&quot;,</span>
<a href="#l42.1299"></a><span id="l42.1299" class="difflineminus">-      events: [</span>
<a href="#l42.1300"></a><span id="l42.1300" class="difflineminus">-        {</span>
<a href="#l42.1301"></a><span id="l42.1301" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1302"></a><span id="l42.1302" class="difflineminus">-          etag: '&quot;3&quot;',</span>
<a href="#l42.1303"></a><span id="l42.1303" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo_20060617T160000Z&quot;,</span>
<a href="#l42.1304"></a><span id="l42.1304" class="difflineminus">-          summary: &quot;New Event changed&quot;,</span>
<a href="#l42.1305"></a><span id="l42.1305" class="difflineminus">-          start: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1306"></a><span id="l42.1306" class="difflineminus">-          end: { dateTime: &quot;2006-06-17T20:00:00+02:00&quot; },</span>
<a href="#l42.1307"></a><span id="l42.1307" class="difflineminus">-          status: &quot;cancelled&quot;,</span>
<a href="#l42.1308"></a><span id="l42.1308" class="difflineminus">-          recurringEventId: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1309"></a><span id="l42.1309" class="difflineminus">-          originalStartTime: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1310"></a><span id="l42.1310" class="difflineminus">-        },</span>
<a href="#l42.1311"></a><span id="l42.1311" class="difflineminus">-      ],</span>
<a href="#l42.1312"></a><span id="l42.1312" class="difflineminus">-    },</span>
<a href="#l42.1313"></a><span id="l42.1313" class="difflineminus">-  ];</span>
<a href="#l42.1314"></a><span id="l42.1314" class="difflineminus">-</span>
<a href="#l42.1315"></a><span id="l42.1315" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1316"></a><span id="l42.1316" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1317"></a><span id="l42.1317" class="difflineminus">-</span>
<a href="#l42.1318"></a><span id="l42.1318" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1319"></a><span id="l42.1319" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1320"></a><span id="l42.1320" class="difflineminus">-</span>
<a href="#l42.1321"></a><span id="l42.1321" class="difflineminus">-  let exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l42.1322"></a><span id="l42.1322" class="difflineminus">-  equal(exIds.length, 1);</span>
<a href="#l42.1323"></a><span id="l42.1323" class="difflineminus">-</span>
<a href="#l42.1324"></a><span id="l42.1324" class="difflineminus">-  let ex = items[0].recurrenceInfo.getExceptionFor(exIds[0]);</span>
<a href="#l42.1325"></a><span id="l42.1325" class="difflineminus">-  equal(ex.title, &quot;New Event changed&quot;);</span>
<a href="#l42.1326"></a><span id="l42.1326" class="difflineminus">-</span>
<a href="#l42.1327"></a><span id="l42.1327" class="difflineminus">-  client.refresh();</span>
<a href="#l42.1328"></a><span id="l42.1328" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1329"></a><span id="l42.1329" class="difflineminus">-</span>
<a href="#l42.1330"></a><span id="l42.1330" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1331"></a><span id="l42.1331" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1332"></a><span id="l42.1332" class="difflineminus">-</span>
<a href="#l42.1333"></a><span id="l42.1333" class="difflineminus">-  exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l42.1334"></a><span id="l42.1334" class="difflineminus">-  equal(exIds.length, 0);</span>
<a href="#l42.1335"></a><span id="l42.1335" class="difflineminus">-</span>
<a href="#l42.1336"></a><span id="l42.1336" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1337"></a><span id="l42.1337" class="difflineminus">-});</span>
<a href="#l42.1338"></a><span id="l42.1338" class="difflineminus">-</span>
<a href="#l42.1339"></a><span id="l42.1339" class="difflineminus">-add_task(async function test_recurring_cancelled_exception() {</span>
<a href="#l42.1340"></a><span id="l42.1340" class="difflineminus">-  gServer.syncs = [</span>
<a href="#l42.1341"></a><span id="l42.1341" class="difflineminus">-    {</span>
<a href="#l42.1342"></a><span id="l42.1342" class="difflineminus">-      token: &quot;1&quot;,</span>
<a href="#l42.1343"></a><span id="l42.1343" class="difflineminus">-      events: [</span>
<a href="#l42.1344"></a><span id="l42.1344" class="difflineminus">-        {</span>
<a href="#l42.1345"></a><span id="l42.1345" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1346"></a><span id="l42.1346" class="difflineminus">-          etag: '&quot;1&quot;',</span>
<a href="#l42.1347"></a><span id="l42.1347" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1348"></a><span id="l42.1348" class="difflineminus">-          status: &quot;cancelled&quot;,</span>
<a href="#l42.1349"></a><span id="l42.1349" class="difflineminus">-        },</span>
<a href="#l42.1350"></a><span id="l42.1350" class="difflineminus">-        {</span>
<a href="#l42.1351"></a><span id="l42.1351" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1352"></a><span id="l42.1352" class="difflineminus">-          etag: '&quot;2&quot;',</span>
<a href="#l42.1353"></a><span id="l42.1353" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo_20060617T160000Z&quot;,</span>
<a href="#l42.1354"></a><span id="l42.1354" class="difflineminus">-          status: &quot;cancelled&quot;,</span>
<a href="#l42.1355"></a><span id="l42.1355" class="difflineminus">-          recurringEventId: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1356"></a><span id="l42.1356" class="difflineminus">-          originalStartTime: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1357"></a><span id="l42.1357" class="difflineminus">-        },</span>
<a href="#l42.1358"></a><span id="l42.1358" class="difflineminus">-      ],</span>
<a href="#l42.1359"></a><span id="l42.1359" class="difflineminus">-    },</span>
<a href="#l42.1360"></a><span id="l42.1360" class="difflineminus">-  ];</span>
<a href="#l42.1361"></a><span id="l42.1361" class="difflineminus">-</span>
<a href="#l42.1362"></a><span id="l42.1362" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1363"></a><span id="l42.1363" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1364"></a><span id="l42.1364" class="difflineminus">-</span>
<a href="#l42.1365"></a><span id="l42.1365" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1366"></a><span id="l42.1366" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.1367"></a><span id="l42.1367" class="difflineminus">-</span>
<a href="#l42.1368"></a><span id="l42.1368" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1369"></a><span id="l42.1369" class="difflineminus">-});</span>
<a href="#l42.1370"></a><span id="l42.1370" class="difflineminus">-</span>
<a href="#l42.1371"></a><span id="l42.1371" class="difflineminus">-add_task(async function test_import_invitation() {</span>
<a href="#l42.1372"></a><span id="l42.1372" class="difflineminus">-  Services.prefs.setBoolPref(&quot;calendar.google.enableAttendees&quot;, true);</span>
<a href="#l42.1373"></a><span id="l42.1373" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1374"></a><span id="l42.1374" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1375"></a><span id="l42.1375" class="difflineminus">-  let event = cal.createEvent(</span>
<a href="#l42.1376"></a><span id="l42.1376" class="difflineminus">-    [</span>
<a href="#l42.1377"></a><span id="l42.1377" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1378"></a><span id="l42.1378" class="difflineminus">-      &quot;UID:xpcshell-import&quot;,</span>
<a href="#l42.1379"></a><span id="l42.1379" class="difflineminus">-      &quot;CREATED:20060608T210452Z&quot;,</span>
<a href="#l42.1380"></a><span id="l42.1380" class="difflineminus">-      &quot;LAST-MODIFIED:20060608T210549Z&quot;,</span>
<a href="#l42.1381"></a><span id="l42.1381" class="difflineminus">-      &quot;DTSTAMP:20060608T210549Z&quot;,</span>
<a href="#l42.1382"></a><span id="l42.1382" class="difflineminus">-      &quot;SUMMARY:New Event&quot;,</span>
<a href="#l42.1383"></a><span id="l42.1383" class="difflineminus">-      &quot;STATUS:CONFIRMED&quot;,</span>
<a href="#l42.1384"></a><span id="l42.1384" class="difflineminus">-      &quot;ORGANIZER;CN=Omlettte B. Clam:mailto:ombclam@example.com&quot;,</span>
<a href="#l42.1385"></a><span id="l42.1385" class="difflineminus">-      &quot;ATTENDEE;CN=Omlettte B. Clam;PARTSTAT=ACCEPTED;CUTYPE=INDIVIDUAL;&quot;,</span>
<a href="#l42.1386"></a><span id="l42.1386" class="difflineminus">-      &quot; ROLE=REQ-PARTICIPANT:mailto:ombclam@example.com&quot;,</span>
<a href="#l42.1387"></a><span id="l42.1387" class="difflineminus">-      &quot;ATTENDEE;CN=Eggs P. Seashell;PARTSTAT=TENTATIVE;CUTYPE=INDIVIDUAL;&quot;,</span>
<a href="#l42.1388"></a><span id="l42.1388" class="difflineminus">-      &quot; ROLE=REQ-PARTICIPANT:mailto:xpcshell@example.com&quot;,</span>
<a href="#l42.1389"></a><span id="l42.1389" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1390"></a><span id="l42.1390" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1391"></a><span id="l42.1391" class="difflineminus">-      &quot;SEQUENCE:1&quot;,</span>
<a href="#l42.1392"></a><span id="l42.1392" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1393"></a><span id="l42.1393" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1394"></a><span id="l42.1394" class="difflineminus">-  );</span>
<a href="#l42.1395"></a><span id="l42.1395" class="difflineminus">-</span>
<a href="#l42.1396"></a><span id="l42.1396" class="difflineminus">-  let addedItem = await pclient.adoptItem(event);</span>
<a href="#l42.1397"></a><span id="l42.1397" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1398"></a><span id="l42.1398" class="difflineminus">-  equal(addedItem.icalString, event.icalString);</span>
<a href="#l42.1399"></a><span id="l42.1399" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1400"></a><span id="l42.1400" class="difflineminus">-  Services.prefs.setBoolPref(&quot;calendar.google.enableAttendees&quot;, false);</span>
<a href="#l42.1401"></a><span id="l42.1401" class="difflineminus">-});</span>
<a href="#l42.1402"></a><span id="l42.1402" class="difflineminus">-</span>
<a href="#l42.1403"></a><span id="l42.1403" class="difflineminus">-add_task(async function test_modify_invitation() {</span>
<a href="#l42.1404"></a><span id="l42.1404" class="difflineminus">-  Services.prefs.setBoolPref(&quot;calendar.google.enableAttendees&quot;, true);</span>
<a href="#l42.1405"></a><span id="l42.1405" class="difflineminus">-  let organizer = {</span>
<a href="#l42.1406"></a><span id="l42.1406" class="difflineminus">-    displayName: &quot;organizer name&quot;,</span>
<a href="#l42.1407"></a><span id="l42.1407" class="difflineminus">-    email: &quot;organizer@example.com&quot;,</span>
<a href="#l42.1408"></a><span id="l42.1408" class="difflineminus">-    organizer: true,</span>
<a href="#l42.1409"></a><span id="l42.1409" class="difflineminus">-    responseStatus: &quot;tentative&quot;,</span>
<a href="#l42.1410"></a><span id="l42.1410" class="difflineminus">-  };</span>
<a href="#l42.1411"></a><span id="l42.1411" class="difflineminus">-  let attendee = Object.assign({}, gServer.creator);</span>
<a href="#l42.1412"></a><span id="l42.1412" class="difflineminus">-  attendee.responseStatus = &quot;needsAction&quot;;</span>
<a href="#l42.1413"></a><span id="l42.1413" class="difflineminus">-</span>
<a href="#l42.1414"></a><span id="l42.1414" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.1415"></a><span id="l42.1415" class="difflineminus">-    {</span>
<a href="#l42.1416"></a><span id="l42.1416" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1417"></a><span id="l42.1417" class="difflineminus">-      etag: '&quot;2299601498276000&quot;',</span>
<a href="#l42.1418"></a><span id="l42.1418" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1419"></a><span id="l42.1419" class="difflineminus">-      status: &quot;confirmed&quot;,</span>
<a href="#l42.1420"></a><span id="l42.1420" class="difflineminus">-      htmlLink: gServer.baseUri + &quot;/calendar/event?eid=eventhash&quot;,</span>
<a href="#l42.1421"></a><span id="l42.1421" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1422"></a><span id="l42.1422" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1423"></a><span id="l42.1423" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.1424"></a><span id="l42.1424" class="difflineminus">-      description: &quot;description&quot;,</span>
<a href="#l42.1425"></a><span id="l42.1425" class="difflineminus">-      location: &quot;Hard Drive&quot;,</span>
<a href="#l42.1426"></a><span id="l42.1426" class="difflineminus">-      colorId: 17,</span>
<a href="#l42.1427"></a><span id="l42.1427" class="difflineminus">-      creator: organizer,</span>
<a href="#l42.1428"></a><span id="l42.1428" class="difflineminus">-      organizer: organizer,</span>
<a href="#l42.1429"></a><span id="l42.1429" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1430"></a><span id="l42.1430" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1431"></a><span id="l42.1431" class="difflineminus">-      transparency: &quot;transparent&quot;,</span>
<a href="#l42.1432"></a><span id="l42.1432" class="difflineminus">-      visibility: &quot;private&quot;,</span>
<a href="#l42.1433"></a><span id="l42.1433" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1434"></a><span id="l42.1434" class="difflineminus">-      sequence: 1,</span>
<a href="#l42.1435"></a><span id="l42.1435" class="difflineminus">-      attendees: [organizer, attendee],</span>
<a href="#l42.1436"></a><span id="l42.1436" class="difflineminus">-    },</span>
<a href="#l42.1437"></a><span id="l42.1437" class="difflineminus">-  ];</span>
<a href="#l42.1438"></a><span id="l42.1438" class="difflineminus">-</span>
<a href="#l42.1439"></a><span id="l42.1439" class="difflineminus">-  // Case #1: User is attendee</span>
<a href="#l42.1440"></a><span id="l42.1440" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1441"></a><span id="l42.1441" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1442"></a><span id="l42.1442" class="difflineminus">-</span>
<a href="#l42.1443"></a><span id="l42.1443" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1444"></a><span id="l42.1444" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1445"></a><span id="l42.1445" class="difflineminus">-</span>
<a href="#l42.1446"></a><span id="l42.1446" class="difflineminus">-  let item = items[0];</span>
<a href="#l42.1447"></a><span id="l42.1447" class="difflineminus">-  let att = cal.itip.getInvitedAttendee(item);</span>
<a href="#l42.1448"></a><span id="l42.1448" class="difflineminus">-  let newItem = item.clone();</span>
<a href="#l42.1449"></a><span id="l42.1449" class="difflineminus">-</span>
<a href="#l42.1450"></a><span id="l42.1450" class="difflineminus">-  notEqual(att, null);</span>
<a href="#l42.1451"></a><span id="l42.1451" class="difflineminus">-  equal(att.id, &quot;mailto:&quot; + attendee.email);</span>
<a href="#l42.1452"></a><span id="l42.1452" class="difflineminus">-  equal(att.participationStatus, &quot;NEEDS-ACTION&quot;);</span>
<a href="#l42.1453"></a><span id="l42.1453" class="difflineminus">-</span>
<a href="#l42.1454"></a><span id="l42.1454" class="difflineminus">-  newItem.removeAttendee(att);</span>
<a href="#l42.1455"></a><span id="l42.1455" class="difflineminus">-  att = att.clone();</span>
<a href="#l42.1456"></a><span id="l42.1456" class="difflineminus">-  att.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l42.1457"></a><span id="l42.1457" class="difflineminus">-  newItem.addAttendee(att);</span>
<a href="#l42.1458"></a><span id="l42.1458" class="difflineminus">-</span>
<a href="#l42.1459"></a><span id="l42.1459" class="difflineminus">-  await pclient.modifyItem(newItem, items[0]);</span>
<a href="#l42.1460"></a><span id="l42.1460" class="difflineminus">-  equal(gServer.lastMethod, &quot;PATCH&quot;);</span>
<a href="#l42.1461"></a><span id="l42.1461" class="difflineminus">-</span>
<a href="#l42.1462"></a><span id="l42.1462" class="difflineminus">-  // Case #2: User is organizer</span>
<a href="#l42.1463"></a><span id="l42.1463" class="difflineminus">-  let events = gServer.events;</span>
<a href="#l42.1464"></a><span id="l42.1464" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1465"></a><span id="l42.1465" class="difflineminus">-  gServer.events = events;</span>
<a href="#l42.1466"></a><span id="l42.1466" class="difflineminus">-</span>
<a href="#l42.1467"></a><span id="l42.1467" class="difflineminus">-  organizer = Object.assign({}, gServer.creator);</span>
<a href="#l42.1468"></a><span id="l42.1468" class="difflineminus">-  organizer.responseStatus = &quot;accepted&quot;;</span>
<a href="#l42.1469"></a><span id="l42.1469" class="difflineminus">-  organizer.organizer = true;</span>
<a href="#l42.1470"></a><span id="l42.1470" class="difflineminus">-  attendee = {</span>
<a href="#l42.1471"></a><span id="l42.1471" class="difflineminus">-    displayName: &quot;attendee name&quot;,</span>
<a href="#l42.1472"></a><span id="l42.1472" class="difflineminus">-    email: &quot;attendee@example.com&quot;,</span>
<a href="#l42.1473"></a><span id="l42.1473" class="difflineminus">-    responseStatus: &quot;tentative&quot;,</span>
<a href="#l42.1474"></a><span id="l42.1474" class="difflineminus">-  };</span>
<a href="#l42.1475"></a><span id="l42.1475" class="difflineminus">-</span>
<a href="#l42.1476"></a><span id="l42.1476" class="difflineminus">-  gServer.events[0].organizer = gServer.creator;</span>
<a href="#l42.1477"></a><span id="l42.1477" class="difflineminus">-  gServer.events[0].creator = gServer.creator;</span>
<a href="#l42.1478"></a><span id="l42.1478" class="difflineminus">-  gServer.events[0].attendees = [organizer, attendee];</span>
<a href="#l42.1479"></a><span id="l42.1479" class="difflineminus">-</span>
<a href="#l42.1480"></a><span id="l42.1480" class="difflineminus">-  client = await gServer.getClient();</span>
<a href="#l42.1481"></a><span id="l42.1481" class="difflineminus">-  pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1482"></a><span id="l42.1482" class="difflineminus">-</span>
<a href="#l42.1483"></a><span id="l42.1483" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1484"></a><span id="l42.1484" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1485"></a><span id="l42.1485" class="difflineminus">-</span>
<a href="#l42.1486"></a><span id="l42.1486" class="difflineminus">-  item = items[0];</span>
<a href="#l42.1487"></a><span id="l42.1487" class="difflineminus">-  let org = item.getAttendeeById(&quot;mailto:&quot; + organizer.email);</span>
<a href="#l42.1488"></a><span id="l42.1488" class="difflineminus">-  newItem = item.clone();</span>
<a href="#l42.1489"></a><span id="l42.1489" class="difflineminus">-</span>
<a href="#l42.1490"></a><span id="l42.1490" class="difflineminus">-  notEqual(org, null);</span>
<a href="#l42.1491"></a><span id="l42.1491" class="difflineminus">-  equal(org.id, &quot;mailto:&quot; + organizer.email);</span>
<a href="#l42.1492"></a><span id="l42.1492" class="difflineminus">-  equal(org.participationStatus, &quot;ACCEPTED&quot;);</span>
<a href="#l42.1493"></a><span id="l42.1493" class="difflineminus">-</span>
<a href="#l42.1494"></a><span id="l42.1494" class="difflineminus">-  newItem.removeAttendee(org);</span>
<a href="#l42.1495"></a><span id="l42.1495" class="difflineminus">-  org = org.clone();</span>
<a href="#l42.1496"></a><span id="l42.1496" class="difflineminus">-  org.participationStatus = &quot;TENTATIVE&quot;;</span>
<a href="#l42.1497"></a><span id="l42.1497" class="difflineminus">-  newItem.addAttendee(org);</span>
<a href="#l42.1498"></a><span id="l42.1498" class="difflineminus">-</span>
<a href="#l42.1499"></a><span id="l42.1499" class="difflineminus">-  modifiedItem = await pclient.modifyItem(newItem, items[0]);</span>
<a href="#l42.1500"></a><span id="l42.1500" class="difflineminus">-  equal(gServer.lastMethod, &quot;PUT&quot;);</span>
<a href="#l42.1501"></a><span id="l42.1501" class="difflineminus">-</span>
<a href="#l42.1502"></a><span id="l42.1502" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1503"></a><span id="l42.1503" class="difflineminus">-});</span>
<a href="#l42.1504"></a><span id="l42.1504" class="difflineminus">-</span>
<a href="#l42.1505"></a><span id="l42.1505" class="difflineminus">-add_task(async function test_metadata() {</span>
<a href="#l42.1506"></a><span id="l42.1506" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.1507"></a><span id="l42.1507" class="difflineminus">-    {</span>
<a href="#l42.1508"></a><span id="l42.1508" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1509"></a><span id="l42.1509" class="difflineminus">-      etag: '&quot;1&quot;',</span>
<a href="#l42.1510"></a><span id="l42.1510" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1511"></a><span id="l42.1511" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1512"></a><span id="l42.1512" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1513"></a><span id="l42.1513" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.1514"></a><span id="l42.1514" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.1515"></a><span id="l42.1515" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.1516"></a><span id="l42.1516" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1517"></a><span id="l42.1517" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1518"></a><span id="l42.1518" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1519"></a><span id="l42.1519" class="difflineminus">-    },</span>
<a href="#l42.1520"></a><span id="l42.1520" class="difflineminus">-  ];</span>
<a href="#l42.1521"></a><span id="l42.1521" class="difflineminus">-  gServer.tasks = [</span>
<a href="#l42.1522"></a><span id="l42.1522" class="difflineminus">-    {</span>
<a href="#l42.1523"></a><span id="l42.1523" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.1524"></a><span id="l42.1524" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.1525"></a><span id="l42.1525" class="difflineminus">-      etag: '&quot;2&quot;',</span>
<a href="#l42.1526"></a><span id="l42.1526" class="difflineminus">-      title: &quot;New Task&quot;,</span>
<a href="#l42.1527"></a><span id="l42.1527" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.1528"></a><span id="l42.1528" class="difflineminus">-      selfLink:</span>
<a href="#l42.1529"></a><span id="l42.1529" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.1530"></a><span id="l42.1530" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.1531"></a><span id="l42.1531" class="difflineminus">-      notes: &quot;description&quot;,</span>
<a href="#l42.1532"></a><span id="l42.1532" class="difflineminus">-    },</span>
<a href="#l42.1533"></a><span id="l42.1533" class="difflineminus">-  ];</span>
<a href="#l42.1534"></a><span id="l42.1534" class="difflineminus">-</span>
<a href="#l42.1535"></a><span id="l42.1535" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1536"></a><span id="l42.1536" class="difflineminus">-  let offline = client.wrappedJSObject.mCachedCalendar;</span>
<a href="#l42.1537"></a><span id="l42.1537" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1538"></a><span id="l42.1538" class="difflineminus">-</span>
<a href="#l42.1539"></a><span id="l42.1539" class="difflineminus">-  // Check initial metadata</span>
<a href="#l42.1540"></a><span id="l42.1540" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1541"></a><span id="l42.1541" class="difflineminus">-  let meta = getAllMeta(offline);</span>
<a href="#l42.1542"></a><span id="l42.1542" class="difflineminus">-  let [event, task] = items;</span>
<a href="#l42.1543"></a><span id="l42.1543" class="difflineminus">-  ok(cal.item.isEvent(event));</span>
<a href="#l42.1544"></a><span id="l42.1544" class="difflineminus">-  ok(cal.item.isToDo(task));</span>
<a href="#l42.1545"></a><span id="l42.1545" class="difflineminus">-  equal(meta.size, 2);</span>
<a href="#l42.1546"></a><span id="l42.1546" class="difflineminus">-  equal(meta.get(event.hashId), ['&quot;1&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1547"></a><span id="l42.1547" class="difflineminus">-  equal(</span>
<a href="#l42.1548"></a><span id="l42.1548" class="difflineminus">-    meta.get(task.hashId),</span>
<a href="#l42.1549"></a><span id="l42.1549" class="difflineminus">-    ['&quot;2&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1550"></a><span id="l42.1550" class="difflineminus">-  );</span>
<a href="#l42.1551"></a><span id="l42.1551" class="difflineminus">-</span>
<a href="#l42.1552"></a><span id="l42.1552" class="difflineminus">-  // Modify an event</span>
<a href="#l42.1553"></a><span id="l42.1553" class="difflineminus">-  gServer.nextEtag = '&quot;3&quot;';</span>
<a href="#l42.1554"></a><span id="l42.1554" class="difflineminus">-  let newEvent = event.clone();</span>
<a href="#l42.1555"></a><span id="l42.1555" class="difflineminus">-  newEvent.title = &quot;changed&quot;;</span>
<a href="#l42.1556"></a><span id="l42.1556" class="difflineminus">-  await pclient.modifyItem(newEvent, event);</span>
<a href="#l42.1557"></a><span id="l42.1557" class="difflineminus">-</span>
<a href="#l42.1558"></a><span id="l42.1558" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1559"></a><span id="l42.1559" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1560"></a><span id="l42.1560" class="difflineminus">-  [event, task] = items;</span>
<a href="#l42.1561"></a><span id="l42.1561" class="difflineminus">-  ok(cal.item.isEvent(event));</span>
<a href="#l42.1562"></a><span id="l42.1562" class="difflineminus">-  ok(cal.item.isToDo(task));</span>
<a href="#l42.1563"></a><span id="l42.1563" class="difflineminus">-  equal(meta.size, 2);</span>
<a href="#l42.1564"></a><span id="l42.1564" class="difflineminus">-  equal(meta.get(event.hashId), ['&quot;3&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1565"></a><span id="l42.1565" class="difflineminus">-  equal(</span>
<a href="#l42.1566"></a><span id="l42.1566" class="difflineminus">-    meta.get(task.hashId),</span>
<a href="#l42.1567"></a><span id="l42.1567" class="difflineminus">-    ['&quot;2&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1568"></a><span id="l42.1568" class="difflineminus">-  );</span>
<a href="#l42.1569"></a><span id="l42.1569" class="difflineminus">-</span>
<a href="#l42.1570"></a><span id="l42.1570" class="difflineminus">-  // Modify a task</span>
<a href="#l42.1571"></a><span id="l42.1571" class="difflineminus">-  gServer.nextEtag = '&quot;4&quot;';</span>
<a href="#l42.1572"></a><span id="l42.1572" class="difflineminus">-  let newTask = task.clone();</span>
<a href="#l42.1573"></a><span id="l42.1573" class="difflineminus">-  newTask.title = &quot;changed&quot;;</span>
<a href="#l42.1574"></a><span id="l42.1574" class="difflineminus">-  await pclient.modifyItem(newTask, task);</span>
<a href="#l42.1575"></a><span id="l42.1575" class="difflineminus">-</span>
<a href="#l42.1576"></a><span id="l42.1576" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1577"></a><span id="l42.1577" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1578"></a><span id="l42.1578" class="difflineminus">-  [event, task] = items;</span>
<a href="#l42.1579"></a><span id="l42.1579" class="difflineminus">-  equal(meta.size, 2);</span>
<a href="#l42.1580"></a><span id="l42.1580" class="difflineminus">-  equal(meta.get(event.hashId), ['&quot;3&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1581"></a><span id="l42.1581" class="difflineminus">-  equal(</span>
<a href="#l42.1582"></a><span id="l42.1582" class="difflineminus">-    meta.get(task.hashId),</span>
<a href="#l42.1583"></a><span id="l42.1583" class="difflineminus">-    ['&quot;4&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1584"></a><span id="l42.1584" class="difflineminus">-  );</span>
<a href="#l42.1585"></a><span id="l42.1585" class="difflineminus">-</span>
<a href="#l42.1586"></a><span id="l42.1586" class="difflineminus">-  // Delete an event</span>
<a href="#l42.1587"></a><span id="l42.1587" class="difflineminus">-  await pclient.deleteItem(event);</span>
<a href="#l42.1588"></a><span id="l42.1588" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1589"></a><span id="l42.1589" class="difflineminus">-  equal(meta.size, 1);</span>
<a href="#l42.1590"></a><span id="l42.1590" class="difflineminus">-  equal(</span>
<a href="#l42.1591"></a><span id="l42.1591" class="difflineminus">-    meta.get(task.hashId),</span>
<a href="#l42.1592"></a><span id="l42.1592" class="difflineminus">-    ['&quot;4&quot;', &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1593"></a><span id="l42.1593" class="difflineminus">-  );</span>
<a href="#l42.1594"></a><span id="l42.1594" class="difflineminus">-</span>
<a href="#l42.1595"></a><span id="l42.1595" class="difflineminus">-  // Delete a task</span>
<a href="#l42.1596"></a><span id="l42.1596" class="difflineminus">-  await pclient.deleteItem(task);</span>
<a href="#l42.1597"></a><span id="l42.1597" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1598"></a><span id="l42.1598" class="difflineminus">-  equal(meta.size, 0);</span>
<a href="#l42.1599"></a><span id="l42.1599" class="difflineminus">-</span>
<a href="#l42.1600"></a><span id="l42.1600" class="difflineminus">-  // Add an event</span>
<a href="#l42.1601"></a><span id="l42.1601" class="difflineminus">-  gServer.nextEtag = '&quot;6&quot;';</span>
<a href="#l42.1602"></a><span id="l42.1602" class="difflineminus">-  newEvent = await pclient.addItem(event);</span>
<a href="#l42.1603"></a><span id="l42.1603" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1604"></a><span id="l42.1604" class="difflineminus">-  equal(meta.size, 1);</span>
<a href="#l42.1605"></a><span id="l42.1605" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1606"></a><span id="l42.1606" class="difflineminus">-  equal(meta.get(newEvent.hashId), ['&quot;6&quot;', gServer.events[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1607"></a><span id="l42.1607" class="difflineminus">-</span>
<a href="#l42.1608"></a><span id="l42.1608" class="difflineminus">-  // Add a task</span>
<a href="#l42.1609"></a><span id="l42.1609" class="difflineminus">-  gServer.nextEtag = '&quot;7&quot;';</span>
<a href="#l42.1610"></a><span id="l42.1610" class="difflineminus">-  newTask = await pclient.addItem(task);</span>
<a href="#l42.1611"></a><span id="l42.1611" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1612"></a><span id="l42.1612" class="difflineminus">-  equal(meta.size, 2);</span>
<a href="#l42.1613"></a><span id="l42.1613" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1614"></a><span id="l42.1614" class="difflineminus">-  equal(gServer.tasks.length, 1);</span>
<a href="#l42.1615"></a><span id="l42.1615" class="difflineminus">-  equal(meta.get(newEvent.hashId), ['&quot;6&quot;', gServer.events[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1616"></a><span id="l42.1616" class="difflineminus">-  equal(meta.get(newTask.hashId), ['&quot;7&quot;', gServer.tasks[0].id, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1617"></a><span id="l42.1617" class="difflineminus">-</span>
<a href="#l42.1618"></a><span id="l42.1618" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1619"></a><span id="l42.1619" class="difflineminus">-});</span>
<a href="#l42.1620"></a><span id="l42.1620" class="difflineminus">-</span>
<a href="#l42.1621"></a><span id="l42.1621" class="difflineminus">-add_task(async function test_metadata_recurring() {</span>
<a href="#l42.1622"></a><span id="l42.1622" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.1623"></a><span id="l42.1623" class="difflineminus">-    {</span>
<a href="#l42.1624"></a><span id="l42.1624" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1625"></a><span id="l42.1625" class="difflineminus">-      etag: '&quot;1&quot;',</span>
<a href="#l42.1626"></a><span id="l42.1626" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1627"></a><span id="l42.1627" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1628"></a><span id="l42.1628" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1629"></a><span id="l42.1629" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.1630"></a><span id="l42.1630" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.1631"></a><span id="l42.1631" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.1632"></a><span id="l42.1632" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1633"></a><span id="l42.1633" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1634"></a><span id="l42.1634" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1635"></a><span id="l42.1635" class="difflineminus">-      recurrence: [&quot;RRULE:FREQ=WEEKLY&quot;],</span>
<a href="#l42.1636"></a><span id="l42.1636" class="difflineminus">-    },</span>
<a href="#l42.1637"></a><span id="l42.1637" class="difflineminus">-    {</span>
<a href="#l42.1638"></a><span id="l42.1638" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1639"></a><span id="l42.1639" class="difflineminus">-      etag: '&quot;2&quot;',</span>
<a href="#l42.1640"></a><span id="l42.1640" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;,</span>
<a href="#l42.1641"></a><span id="l42.1641" class="difflineminus">-      summary: &quot;New Event changed&quot;,</span>
<a href="#l42.1642"></a><span id="l42.1642" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1643"></a><span id="l42.1643" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1644"></a><span id="l42.1644" class="difflineminus">-      recurringEventId: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1645"></a><span id="l42.1645" class="difflineminus">-      originalStartTime: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1646"></a><span id="l42.1646" class="difflineminus">-    },</span>
<a href="#l42.1647"></a><span id="l42.1647" class="difflineminus">-    {</span>
<a href="#l42.1648"></a><span id="l42.1648" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1649"></a><span id="l42.1649" class="difflineminus">-      etag: '&quot;3&quot;',</span>
<a href="#l42.1650"></a><span id="l42.1650" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo_20060617T160000Z&quot;,</span>
<a href="#l42.1651"></a><span id="l42.1651" class="difflineminus">-      summary: &quot;New Event next week&quot;,</span>
<a href="#l42.1652"></a><span id="l42.1652" class="difflineminus">-      start: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1653"></a><span id="l42.1653" class="difflineminus">-      end: { dateTime: &quot;2006-06-17T20:00:00+02:00&quot; },</span>
<a href="#l42.1654"></a><span id="l42.1654" class="difflineminus">-      recurringEventId: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1655"></a><span id="l42.1655" class="difflineminus">-      originalStartTime: { dateTime: &quot;2006-06-17T18:00:00+02:00&quot; },</span>
<a href="#l42.1656"></a><span id="l42.1656" class="difflineminus">-    },</span>
<a href="#l42.1657"></a><span id="l42.1657" class="difflineminus">-  ];</span>
<a href="#l42.1658"></a><span id="l42.1658" class="difflineminus">-</span>
<a href="#l42.1659"></a><span id="l42.1659" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1660"></a><span id="l42.1660" class="difflineminus">-  let offline = client.wrappedJSObject.mCachedCalendar;</span>
<a href="#l42.1661"></a><span id="l42.1661" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1662"></a><span id="l42.1662" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1663"></a><span id="l42.1663" class="difflineminus">-</span>
<a href="#l42.1664"></a><span id="l42.1664" class="difflineminus">-  let meta = getAllMeta(offline);</span>
<a href="#l42.1665"></a><span id="l42.1665" class="difflineminus">-  equal(meta.size, 3);</span>
<a href="#l42.1666"></a><span id="l42.1666" class="difflineminus">-  equal(meta.get(items[0].hashId), ['&quot;1&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo&quot;, false].join(&quot;\u001A&quot;));</span>
<a href="#l42.1667"></a><span id="l42.1667" class="difflineminus">-</span>
<a href="#l42.1668"></a><span id="l42.1668" class="difflineminus">-  // The exception metadata should also exist</span>
<a href="#l42.1669"></a><span id="l42.1669" class="difflineminus">-  let exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l42.1670"></a><span id="l42.1670" class="difflineminus">-  equal(exIds.length, 2);</span>
<a href="#l42.1671"></a><span id="l42.1671" class="difflineminus">-  let ex = items[0].recurrenceInfo.getExceptionFor(exIds[0]);</span>
<a href="#l42.1672"></a><span id="l42.1672" class="difflineminus">-  equal(</span>
<a href="#l42.1673"></a><span id="l42.1673" class="difflineminus">-    meta.get(ex.hashId),</span>
<a href="#l42.1674"></a><span id="l42.1674" class="difflineminus">-    ['&quot;2&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1675"></a><span id="l42.1675" class="difflineminus">-  );</span>
<a href="#l42.1676"></a><span id="l42.1676" class="difflineminus">-</span>
<a href="#l42.1677"></a><span id="l42.1677" class="difflineminus">-  // Changing an exception should retain the metadata entries</span>
<a href="#l42.1678"></a><span id="l42.1678" class="difflineminus">-  let newEx = ex.clone();</span>
<a href="#l42.1679"></a><span id="l42.1679" class="difflineminus">-  newEx.title = &quot;New Event changed again&quot;;</span>
<a href="#l42.1680"></a><span id="l42.1680" class="difflineminus">-  gServer.nextEtag = '&quot;4&quot;';</span>
<a href="#l42.1681"></a><span id="l42.1681" class="difflineminus">-  await pclient.modifyItem(newEx, ex);</span>
<a href="#l42.1682"></a><span id="l42.1682" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1683"></a><span id="l42.1683" class="difflineminus">-  equal(meta.size, 3);</span>
<a href="#l42.1684"></a><span id="l42.1684" class="difflineminus">-  equal(</span>
<a href="#l42.1685"></a><span id="l42.1685" class="difflineminus">-    meta.get(newEx.hashId),</span>
<a href="#l42.1686"></a><span id="l42.1686" class="difflineminus">-    ['&quot;4&quot;', &quot;go6ijb0b46hlpbu4eeu92njevo_20060610T160000Z&quot;, false].join(&quot;\u001A&quot;)</span>
<a href="#l42.1687"></a><span id="l42.1687" class="difflineminus">-  );</span>
<a href="#l42.1688"></a><span id="l42.1688" class="difflineminus">-</span>
<a href="#l42.1689"></a><span id="l42.1689" class="difflineminus">-  // Deleting an exception should delete the metadata, as it turns into an EXDATE</span>
<a href="#l42.1690"></a><span id="l42.1690" class="difflineminus">-  let newItem = items[0].clone();</span>
<a href="#l42.1691"></a><span id="l42.1691" class="difflineminus">-  newItem.recurrenceInfo.removeOccurrenceAt(exIds[0]);</span>
<a href="#l42.1692"></a><span id="l42.1692" class="difflineminus">-  await pclient.modifyItem(newItem, items[0]);</span>
<a href="#l42.1693"></a><span id="l42.1693" class="difflineminus">-</span>
<a href="#l42.1694"></a><span id="l42.1694" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1695"></a><span id="l42.1695" class="difflineminus">-  equal(meta.size, 2);</span>
<a href="#l42.1696"></a><span id="l42.1696" class="difflineminus">-</span>
<a href="#l42.1697"></a><span id="l42.1697" class="difflineminus">-  // Deleting the master item should remove all metadata entries</span>
<a href="#l42.1698"></a><span id="l42.1698" class="difflineminus">-  await pclient.deleteItem(items[0]);</span>
<a href="#l42.1699"></a><span id="l42.1699" class="difflineminus">-  meta = getAllMeta(offline);</span>
<a href="#l42.1700"></a><span id="l42.1700" class="difflineminus">-  equal(meta.size, 0);</span>
<a href="#l42.1701"></a><span id="l42.1701" class="difflineminus">-</span>
<a href="#l42.1702"></a><span id="l42.1702" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1703"></a><span id="l42.1703" class="difflineminus">-});</span>
<a href="#l42.1704"></a><span id="l42.1704" class="difflineminus">-</span>
<a href="#l42.1705"></a><span id="l42.1705" class="difflineminus">-add_task(async function test_conflict_modify() {</span>
<a href="#l42.1706"></a><span id="l42.1706" class="difflineminus">-  // TODO task/event conflicts are handled in the same way so I'm going to</span>
<a href="#l42.1707"></a><span id="l42.1707" class="difflineminus">-  // skip adding tests for tasks here, but it probably wouldn't hurt to</span>
<a href="#l42.1708"></a><span id="l42.1708" class="difflineminus">-  // create them at some point.</span>
<a href="#l42.1709"></a><span id="l42.1709" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.1710"></a><span id="l42.1710" class="difflineminus">-    {</span>
<a href="#l42.1711"></a><span id="l42.1711" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1712"></a><span id="l42.1712" class="difflineminus">-      etag: '&quot;1&quot;',</span>
<a href="#l42.1713"></a><span id="l42.1713" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1714"></a><span id="l42.1714" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1715"></a><span id="l42.1715" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1716"></a><span id="l42.1716" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.1717"></a><span id="l42.1717" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.1718"></a><span id="l42.1718" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.1719"></a><span id="l42.1719" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1720"></a><span id="l42.1720" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1721"></a><span id="l42.1721" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1722"></a><span id="l42.1722" class="difflineminus">-    },</span>
<a href="#l42.1723"></a><span id="l42.1723" class="difflineminus">-  ];</span>
<a href="#l42.1724"></a><span id="l42.1724" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1725"></a><span id="l42.1725" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1726"></a><span id="l42.1726" class="difflineminus">-  let item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1727"></a><span id="l42.1727" class="difflineminus">-</span>
<a href="#l42.1728"></a><span id="l42.1728" class="difflineminus">-  // Case #1: Modified on server, modify locally, overwrite conflict</span>
<a href="#l42.1729"></a><span id="l42.1729" class="difflineminus">-  MockConflictPrompt.overwrite = true;</span>
<a href="#l42.1730"></a><span id="l42.1730" class="difflineminus">-  let newItem = item.clone();</span>
<a href="#l42.1731"></a><span id="l42.1731" class="difflineminus">-  newItem.title = &quot;local change&quot;;</span>
<a href="#l42.1732"></a><span id="l42.1732" class="difflineminus">-  gServer.events[0].etag = '&quot;2&quot;';</span>
<a href="#l42.1733"></a><span id="l42.1733" class="difflineminus">-  gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l42.1734"></a><span id="l42.1734" class="difflineminus">-  let modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l42.1735"></a><span id="l42.1735" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1736"></a><span id="l42.1736" class="difflineminus">-  equal(gServer.events[0].summary, &quot;local change&quot;);</span>
<a href="#l42.1737"></a><span id="l42.1737" class="difflineminus">-  notEqual(gServer.events[0].etag, '&quot;2&quot;');</span>
<a href="#l42.1738"></a><span id="l42.1738" class="difflineminus">-  equal(item.title, &quot;local change&quot;);</span>
<a href="#l42.1739"></a><span id="l42.1739" class="difflineminus">-  equal(modifiedItem.title, &quot;local change&quot;);</span>
<a href="#l42.1740"></a><span id="l42.1740" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1741"></a><span id="l42.1741" class="difflineminus">-</span>
<a href="#l42.1742"></a><span id="l42.1742" class="difflineminus">-  // Case #2: Modified on server, modify locally, don't overwrite conflict</span>
<a href="#l42.1743"></a><span id="l42.1743" class="difflineminus">-  MockConflictPrompt.overwrite = false;</span>
<a href="#l42.1744"></a><span id="l42.1744" class="difflineminus">-  gServer.events[0].etag = '&quot;3&quot;';</span>
<a href="#l42.1745"></a><span id="l42.1745" class="difflineminus">-  gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l42.1746"></a><span id="l42.1746" class="difflineminus">-  try {</span>
<a href="#l42.1747"></a><span id="l42.1747" class="difflineminus">-    modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l42.1748"></a><span id="l42.1748" class="difflineminus">-    do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l42.1749"></a><span id="l42.1749" class="difflineminus">-  } catch (e) {</span>
<a href="#l42.1750"></a><span id="l42.1750" class="difflineminus">-    // Swallow cancelling the request</span>
<a href="#l42.1751"></a><span id="l42.1751" class="difflineminus">-    if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l42.1752"></a><span id="l42.1752" class="difflineminus">-      throw e;</span>
<a href="#l42.1753"></a><span id="l42.1753" class="difflineminus">-    }</span>
<a href="#l42.1754"></a><span id="l42.1754" class="difflineminus">-  }</span>
<a href="#l42.1755"></a><span id="l42.1755" class="difflineminus">-</span>
<a href="#l42.1756"></a><span id="l42.1756" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1757"></a><span id="l42.1757" class="difflineminus">-</span>
<a href="#l42.1758"></a><span id="l42.1758" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1759"></a><span id="l42.1759" class="difflineminus">-  equal(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l42.1760"></a><span id="l42.1760" class="difflineminus">-  equal(gServer.events[0].etag, '&quot;3&quot;');</span>
<a href="#l42.1761"></a><span id="l42.1761" class="difflineminus">-  equal(item.title, &quot;remote change&quot;);</span>
<a href="#l42.1762"></a><span id="l42.1762" class="difflineminus">-</span>
<a href="#l42.1763"></a><span id="l42.1763" class="difflineminus">-  // Case #3: Modified on server, delete locally, don't overwrite conflict</span>
<a href="#l42.1764"></a><span id="l42.1764" class="difflineminus">-  MockConflictPrompt.overwrite = false;</span>
<a href="#l42.1765"></a><span id="l42.1765" class="difflineminus">-  gServer.events[0].etag = '&quot;4&quot;';</span>
<a href="#l42.1766"></a><span id="l42.1766" class="difflineminus">-  gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l42.1767"></a><span id="l42.1767" class="difflineminus">-  try {</span>
<a href="#l42.1768"></a><span id="l42.1768" class="difflineminus">-    await pclient.deleteItem(item);</span>
<a href="#l42.1769"></a><span id="l42.1769" class="difflineminus">-    do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l42.1770"></a><span id="l42.1770" class="difflineminus">-  } catch (e) {</span>
<a href="#l42.1771"></a><span id="l42.1771" class="difflineminus">-    // Swallow cancelling the request</span>
<a href="#l42.1772"></a><span id="l42.1772" class="difflineminus">-    if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l42.1773"></a><span id="l42.1773" class="difflineminus">-      throw e;</span>
<a href="#l42.1774"></a><span id="l42.1774" class="difflineminus">-    }</span>
<a href="#l42.1775"></a><span id="l42.1775" class="difflineminus">-  }</span>
<a href="#l42.1776"></a><span id="l42.1776" class="difflineminus">-</span>
<a href="#l42.1777"></a><span id="l42.1777" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1778"></a><span id="l42.1778" class="difflineminus">-</span>
<a href="#l42.1779"></a><span id="l42.1779" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1780"></a><span id="l42.1780" class="difflineminus">-  equal(gServer.events[0].summary, &quot;remote change&quot;);</span>
<a href="#l42.1781"></a><span id="l42.1781" class="difflineminus">-  equal(gServer.events[0].etag, '&quot;4&quot;');</span>
<a href="#l42.1782"></a><span id="l42.1782" class="difflineminus">-  equal(item.title, &quot;remote change&quot;);</span>
<a href="#l42.1783"></a><span id="l42.1783" class="difflineminus">-</span>
<a href="#l42.1784"></a><span id="l42.1784" class="difflineminus">-  // Case #4: Modified on server, delete locally, overwrite conflict</span>
<a href="#l42.1785"></a><span id="l42.1785" class="difflineminus">-  MockConflictPrompt.overwrite = true;</span>
<a href="#l42.1786"></a><span id="l42.1786" class="difflineminus">-  gServer.events[0].etag = '&quot;5&quot;';</span>
<a href="#l42.1787"></a><span id="l42.1787" class="difflineminus">-  gServer.events[0].summary = &quot;remote change&quot;;</span>
<a href="#l42.1788"></a><span id="l42.1788" class="difflineminus">-  await pclient.deleteItem(item);</span>
<a href="#l42.1789"></a><span id="l42.1789" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1790"></a><span id="l42.1790" class="difflineminus">-  equal(gServer.events.length, 0);</span>
<a href="#l42.1791"></a><span id="l42.1791" class="difflineminus">-</span>
<a href="#l42.1792"></a><span id="l42.1792" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1793"></a><span id="l42.1793" class="difflineminus">-});</span>
<a href="#l42.1794"></a><span id="l42.1794" class="difflineminus">-</span>
<a href="#l42.1795"></a><span id="l42.1795" class="difflineminus">-add_task(async function test_conflict_delete() {</span>
<a href="#l42.1796"></a><span id="l42.1796" class="difflineminus">-  // TODO task/event conflicts are handled in the same way so I'm going to</span>
<a href="#l42.1797"></a><span id="l42.1797" class="difflineminus">-  // skip adding tests for tasks here, but it probably wouldn't hurt to</span>
<a href="#l42.1798"></a><span id="l42.1798" class="difflineminus">-  // create them at some point.</span>
<a href="#l42.1799"></a><span id="l42.1799" class="difflineminus">-  let coreEvent = {</span>
<a href="#l42.1800"></a><span id="l42.1800" class="difflineminus">-    kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1801"></a><span id="l42.1801" class="difflineminus">-    etag: '&quot;2&quot;',</span>
<a href="#l42.1802"></a><span id="l42.1802" class="difflineminus">-    id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1803"></a><span id="l42.1803" class="difflineminus">-    created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1804"></a><span id="l42.1804" class="difflineminus">-    updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1805"></a><span id="l42.1805" class="difflineminus">-    summary: &quot;New Event&quot;,</span>
<a href="#l42.1806"></a><span id="l42.1806" class="difflineminus">-    creator: gServer.creator,</span>
<a href="#l42.1807"></a><span id="l42.1807" class="difflineminus">-    organizer: gServer.creator,</span>
<a href="#l42.1808"></a><span id="l42.1808" class="difflineminus">-    start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1809"></a><span id="l42.1809" class="difflineminus">-    end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1810"></a><span id="l42.1810" class="difflineminus">-    iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1811"></a><span id="l42.1811" class="difflineminus">-  };</span>
<a href="#l42.1812"></a><span id="l42.1812" class="difflineminus">-</span>
<a href="#l42.1813"></a><span id="l42.1813" class="difflineminus">-  // Load initial event to server</span>
<a href="#l42.1814"></a><span id="l42.1814" class="difflineminus">-  gServer.events = [coreEvent];</span>
<a href="#l42.1815"></a><span id="l42.1815" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1816"></a><span id="l42.1816" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1817"></a><span id="l42.1817" class="difflineminus">-  let item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1818"></a><span id="l42.1818" class="difflineminus">-</span>
<a href="#l42.1819"></a><span id="l42.1819" class="difflineminus">-  // Case #1: Deleted on server, modify locally, overwrite conflict</span>
<a href="#l42.1820"></a><span id="l42.1820" class="difflineminus">-  MockConflictPrompt.overwrite = true;</span>
<a href="#l42.1821"></a><span id="l42.1821" class="difflineminus">-  gServer.events = [];</span>
<a href="#l42.1822"></a><span id="l42.1822" class="difflineminus">-  let newItem = item.clone();</span>
<a href="#l42.1823"></a><span id="l42.1823" class="difflineminus">-  newItem.title = &quot;local change&quot;;</span>
<a href="#l42.1824"></a><span id="l42.1824" class="difflineminus">-  let modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l42.1825"></a><span id="l42.1825" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1826"></a><span id="l42.1826" class="difflineminus">-  equal(gServer.events[0].summary, &quot;local change&quot;);</span>
<a href="#l42.1827"></a><span id="l42.1827" class="difflineminus">-  notEqual(gServer.events[0].etag, '&quot;2&quot;');</span>
<a href="#l42.1828"></a><span id="l42.1828" class="difflineminus">-  equal(item.title, &quot;local change&quot;);</span>
<a href="#l42.1829"></a><span id="l42.1829" class="difflineminus">-  equal(modifiedItem.title, &quot;local change&quot;);</span>
<a href="#l42.1830"></a><span id="l42.1830" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1831"></a><span id="l42.1831" class="difflineminus">-</span>
<a href="#l42.1832"></a><span id="l42.1832" class="difflineminus">-  // Case #2: Deleted on server, modify locally, don't overwrite conflict</span>
<a href="#l42.1833"></a><span id="l42.1833" class="difflineminus">-  MockConflictPrompt.overwrite = false;</span>
<a href="#l42.1834"></a><span id="l42.1834" class="difflineminus">-  gServer.events = [];</span>
<a href="#l42.1835"></a><span id="l42.1835" class="difflineminus">-  try {</span>
<a href="#l42.1836"></a><span id="l42.1836" class="difflineminus">-    modifiedItem = await pclient.modifyItem(newItem, item);</span>
<a href="#l42.1837"></a><span id="l42.1837" class="difflineminus">-    do_throw(&quot;Expected modifyItem to be cancelled&quot;);</span>
<a href="#l42.1838"></a><span id="l42.1838" class="difflineminus">-  } catch (e) {</span>
<a href="#l42.1839"></a><span id="l42.1839" class="difflineminus">-    // Swallow cancelling the request</span>
<a href="#l42.1840"></a><span id="l42.1840" class="difflineminus">-    if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l42.1841"></a><span id="l42.1841" class="difflineminus">-      throw e;</span>
<a href="#l42.1842"></a><span id="l42.1842" class="difflineminus">-    }</span>
<a href="#l42.1843"></a><span id="l42.1843" class="difflineminus">-  }</span>
<a href="#l42.1844"></a><span id="l42.1844" class="difflineminus">-  // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l42.1845"></a><span id="l42.1845" class="difflineminus">-  coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l42.1846"></a><span id="l42.1846" class="difflineminus">-  gServer.events = [coreEvent];</span>
<a href="#l42.1847"></a><span id="l42.1847" class="difflineminus">-</span>
<a href="#l42.1848"></a><span id="l42.1848" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1849"></a><span id="l42.1849" class="difflineminus">-</span>
<a href="#l42.1850"></a><span id="l42.1850" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.1851"></a><span id="l42.1851" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.1852"></a><span id="l42.1852" class="difflineminus">-  equal(gServer.events.length, 1);</span>
<a href="#l42.1853"></a><span id="l42.1853" class="difflineminus">-</span>
<a href="#l42.1854"></a><span id="l42.1854" class="difflineminus">-  // Put the event back in the calendar for the next run</span>
<a href="#l42.1855"></a><span id="l42.1855" class="difflineminus">-  delete gServer.events[0].status;</span>
<a href="#l42.1856"></a><span id="l42.1856" class="difflineminus">-  client.refresh();</span>
<a href="#l42.1857"></a><span id="l42.1857" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1858"></a><span id="l42.1858" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1859"></a><span id="l42.1859" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1860"></a><span id="l42.1860" class="difflineminus">-</span>
<a href="#l42.1861"></a><span id="l42.1861" class="difflineminus">-  // Case #3: Deleted on server, delete locally, don't overwrite conflict</span>
<a href="#l42.1862"></a><span id="l42.1862" class="difflineminus">-  MockConflictPrompt.overwrite = false;</span>
<a href="#l42.1863"></a><span id="l42.1863" class="difflineminus">-  gServer.events = [];</span>
<a href="#l42.1864"></a><span id="l42.1864" class="difflineminus">-  try {</span>
<a href="#l42.1865"></a><span id="l42.1865" class="difflineminus">-    await pclient.deleteItem(item);</span>
<a href="#l42.1866"></a><span id="l42.1866" class="difflineminus">-    do_throw(&quot;Expected deleteItem to be cancelled&quot;);</span>
<a href="#l42.1867"></a><span id="l42.1867" class="difflineminus">-  } catch (e) {</span>
<a href="#l42.1868"></a><span id="l42.1868" class="difflineminus">-    // Swallow cancelling the request</span>
<a href="#l42.1869"></a><span id="l42.1869" class="difflineminus">-    if (e != Ci.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l42.1870"></a><span id="l42.1870" class="difflineminus">-      throw e;</span>
<a href="#l42.1871"></a><span id="l42.1871" class="difflineminus">-    }</span>
<a href="#l42.1872"></a><span id="l42.1872" class="difflineminus">-  }</span>
<a href="#l42.1873"></a><span id="l42.1873" class="difflineminus">-  // The next synchronize should cause the event to be deleted locally.</span>
<a href="#l42.1874"></a><span id="l42.1874" class="difflineminus">-  coreEvent.status = &quot;cancelled&quot;;</span>
<a href="#l42.1875"></a><span id="l42.1875" class="difflineminus">-  gServer.events = [coreEvent];</span>
<a href="#l42.1876"></a><span id="l42.1876" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1877"></a><span id="l42.1877" class="difflineminus">-</span>
<a href="#l42.1878"></a><span id="l42.1878" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1879"></a><span id="l42.1879" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.1880"></a><span id="l42.1880" class="difflineminus">-</span>
<a href="#l42.1881"></a><span id="l42.1881" class="difflineminus">-  // Put the event back in the calendar for the next run</span>
<a href="#l42.1882"></a><span id="l42.1882" class="difflineminus">-  delete gServer.events[0].status;</span>
<a href="#l42.1883"></a><span id="l42.1883" class="difflineminus">-  client.refresh();</span>
<a href="#l42.1884"></a><span id="l42.1884" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.1885"></a><span id="l42.1885" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1886"></a><span id="l42.1886" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.1887"></a><span id="l42.1887" class="difflineminus">-</span>
<a href="#l42.1888"></a><span id="l42.1888" class="difflineminus">-  // Case #4: Deleted on server, delete locally, overwrite conflict</span>
<a href="#l42.1889"></a><span id="l42.1889" class="difflineminus">-  MockConflictPrompt.overwrite = true;</span>
<a href="#l42.1890"></a><span id="l42.1890" class="difflineminus">-  gServer.events = [];</span>
<a href="#l42.1891"></a><span id="l42.1891" class="difflineminus">-  await pclient.deleteItem(item);</span>
<a href="#l42.1892"></a><span id="l42.1892" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.1893"></a><span id="l42.1893" class="difflineminus">-  equal(items.length, 0);</span>
<a href="#l42.1894"></a><span id="l42.1894" class="difflineminus">-</span>
<a href="#l42.1895"></a><span id="l42.1895" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1896"></a><span id="l42.1896" class="difflineminus">-});</span>
<a href="#l42.1897"></a><span id="l42.1897" class="difflineminus">-</span>
<a href="#l42.1898"></a><span id="l42.1898" class="difflineminus">-add_task(async function test_default_alarms() {</span>
<a href="#l42.1899"></a><span id="l42.1899" class="difflineminus">-  let defaultReminders = [{ method: &quot;popup&quot;, minutes: 10 }, { method: &quot;email&quot;, minutes: 20 }];</span>
<a href="#l42.1900"></a><span id="l42.1900" class="difflineminus">-  gServer.calendarListData.defaultReminders = defaultReminders;</span>
<a href="#l42.1901"></a><span id="l42.1901" class="difflineminus">-  gServer.eventsData.defaultReminders = defaultReminders;</span>
<a href="#l42.1902"></a><span id="l42.1902" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.1903"></a><span id="l42.1903" class="difflineminus">-    {</span>
<a href="#l42.1904"></a><span id="l42.1904" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.1905"></a><span id="l42.1905" class="difflineminus">-      etag: '&quot;2&quot;',</span>
<a href="#l42.1906"></a><span id="l42.1906" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.1907"></a><span id="l42.1907" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.1908"></a><span id="l42.1908" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.1909"></a><span id="l42.1909" class="difflineminus">-      summary: &quot;Default Reminder&quot;,</span>
<a href="#l42.1910"></a><span id="l42.1910" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.1911"></a><span id="l42.1911" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.1912"></a><span id="l42.1912" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.1913"></a><span id="l42.1913" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.1914"></a><span id="l42.1914" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.1915"></a><span id="l42.1915" class="difflineminus">-      reminders: { useDefault: true },</span>
<a href="#l42.1916"></a><span id="l42.1916" class="difflineminus">-    },</span>
<a href="#l42.1917"></a><span id="l42.1917" class="difflineminus">-  ];</span>
<a href="#l42.1918"></a><span id="l42.1918" class="difflineminus">-</span>
<a href="#l42.1919"></a><span id="l42.1919" class="difflineminus">-  // Case #1: read default alarms from event stream</span>
<a href="#l42.1920"></a><span id="l42.1920" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.1921"></a><span id="l42.1921" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1922"></a><span id="l42.1922" class="difflineminus">-  equal(client.getProperty(&quot;settings.defaultReminders&quot;), JSON.stringify(defaultReminders));</span>
<a href="#l42.1923"></a><span id="l42.1923" class="difflineminus">-</span>
<a href="#l42.1924"></a><span id="l42.1924" class="difflineminus">-  let item = (await pclient.getAllItems())[0];</span>
<a href="#l42.1925"></a><span id="l42.1925" class="difflineminus">-  let alarms = item.getAlarms({});</span>
<a href="#l42.1926"></a><span id="l42.1926" class="difflineminus">-</span>
<a href="#l42.1927"></a><span id="l42.1927" class="difflineminus">-  equal(alarms.length, 2);</span>
<a href="#l42.1928"></a><span id="l42.1928" class="difflineminus">-  ok(alarms.every(x =&gt; x.getProperty(&quot;X-DEFAULT-ALARM&quot;) == &quot;TRUE&quot;));</span>
<a href="#l42.1929"></a><span id="l42.1929" class="difflineminus">-  equal(alarms[0].action, &quot;DISPLAY&quot;);</span>
<a href="#l42.1930"></a><span id="l42.1930" class="difflineminus">-  equal(alarms[0].offset.icalString, &quot;-PT10M&quot;);</span>
<a href="#l42.1931"></a><span id="l42.1931" class="difflineminus">-  equal(alarms[1].action, &quot;EMAIL&quot;);</span>
<a href="#l42.1932"></a><span id="l42.1932" class="difflineminus">-  equal(alarms[1].offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l42.1933"></a><span id="l42.1933" class="difflineminus">-</span>
<a href="#l42.1934"></a><span id="l42.1934" class="difflineminus">-  // Case #2: add an item with only default alarms</span>
<a href="#l42.1935"></a><span id="l42.1935" class="difflineminus">-  let event = cal.createEvent(</span>
<a href="#l42.1936"></a><span id="l42.1936" class="difflineminus">-    [</span>
<a href="#l42.1937"></a><span id="l42.1937" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1938"></a><span id="l42.1938" class="difflineminus">-      &quot;SUMMARY:Default Alarms&quot;,</span>
<a href="#l42.1939"></a><span id="l42.1939" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1940"></a><span id="l42.1940" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1941"></a><span id="l42.1941" class="difflineminus">-      &quot;BEGIN:VALARM&quot;,</span>
<a href="#l42.1942"></a><span id="l42.1942" class="difflineminus">-      &quot;X-DEFAULT-ALARM:TRUE&quot;,</span>
<a href="#l42.1943"></a><span id="l42.1943" class="difflineminus">-      &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l42.1944"></a><span id="l42.1944" class="difflineminus">-      &quot;TRIGGER;VALUE=DURATION:PT0S&quot;,</span>
<a href="#l42.1945"></a><span id="l42.1945" class="difflineminus">-      &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l42.1946"></a><span id="l42.1946" class="difflineminus">-      &quot;END:VALARM&quot;,</span>
<a href="#l42.1947"></a><span id="l42.1947" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1948"></a><span id="l42.1948" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1949"></a><span id="l42.1949" class="difflineminus">-  );</span>
<a href="#l42.1950"></a><span id="l42.1950" class="difflineminus">-</span>
<a href="#l42.1951"></a><span id="l42.1951" class="difflineminus">-  await pclient.addItem(event);</span>
<a href="#l42.1952"></a><span id="l42.1952" class="difflineminus">-  ok(gServer.events[1].reminders.useDefault);</span>
<a href="#l42.1953"></a><span id="l42.1953" class="difflineminus">-  equal(gServer.events[1].reminders.overrides.length, 0);</span>
<a href="#l42.1954"></a><span id="l42.1954" class="difflineminus">-</span>
<a href="#l42.1955"></a><span id="l42.1955" class="difflineminus">-  // Case #3: Mixed default/non-default alarms. Not sure this will happen</span>
<a href="#l42.1956"></a><span id="l42.1956" class="difflineminus">-  event = cal.createEvent(</span>
<a href="#l42.1957"></a><span id="l42.1957" class="difflineminus">-    [</span>
<a href="#l42.1958"></a><span id="l42.1958" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1959"></a><span id="l42.1959" class="difflineminus">-      &quot;SUMMARY:Default Alarms&quot;,</span>
<a href="#l42.1960"></a><span id="l42.1960" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1961"></a><span id="l42.1961" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1962"></a><span id="l42.1962" class="difflineminus">-      &quot;BEGIN:VALARM&quot;,</span>
<a href="#l42.1963"></a><span id="l42.1963" class="difflineminus">-      &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l42.1964"></a><span id="l42.1964" class="difflineminus">-      &quot;X-DEFAULT-ALARM:TRUE&quot;,</span>
<a href="#l42.1965"></a><span id="l42.1965" class="difflineminus">-      &quot;TRIGGER;VALUE=DURATION:-PT1M&quot;,</span>
<a href="#l42.1966"></a><span id="l42.1966" class="difflineminus">-      &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l42.1967"></a><span id="l42.1967" class="difflineminus">-      &quot;END:VALARM&quot;,</span>
<a href="#l42.1968"></a><span id="l42.1968" class="difflineminus">-      &quot;BEGIN:VALARM&quot;,</span>
<a href="#l42.1969"></a><span id="l42.1969" class="difflineminus">-      &quot;ACTION:DISPLAY&quot;,</span>
<a href="#l42.1970"></a><span id="l42.1970" class="difflineminus">-      &quot;TRIGGER;VALUE=DURATION:-PT5M&quot;,</span>
<a href="#l42.1971"></a><span id="l42.1971" class="difflineminus">-      &quot;DESCRIPTION:Description&quot;,</span>
<a href="#l42.1972"></a><span id="l42.1972" class="difflineminus">-      &quot;END:VALARM&quot;,</span>
<a href="#l42.1973"></a><span id="l42.1973" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1974"></a><span id="l42.1974" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1975"></a><span id="l42.1975" class="difflineminus">-  );</span>
<a href="#l42.1976"></a><span id="l42.1976" class="difflineminus">-</span>
<a href="#l42.1977"></a><span id="l42.1977" class="difflineminus">-  await pclient.addItem(event);</span>
<a href="#l42.1978"></a><span id="l42.1978" class="difflineminus">-  ok(gServer.events[2].reminders.useDefault);</span>
<a href="#l42.1979"></a><span id="l42.1979" class="difflineminus">-  equal(gServer.events[2].reminders.overrides.length, 1);</span>
<a href="#l42.1980"></a><span id="l42.1980" class="difflineminus">-  equal(gServer.events[2].reminders.overrides[0].minutes, 5);</span>
<a href="#l42.1981"></a><span id="l42.1981" class="difflineminus">-</span>
<a href="#l42.1982"></a><span id="l42.1982" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.1983"></a><span id="l42.1983" class="difflineminus">-</span>
<a href="#l42.1984"></a><span id="l42.1984" class="difflineminus">-  // Case #4a: Empty default alarms</span>
<a href="#l42.1985"></a><span id="l42.1985" class="difflineminus">-  gServer.calendarListData.defaultReminders = [];</span>
<a href="#l42.1986"></a><span id="l42.1986" class="difflineminus">-  gServer.eventsData.defaultReminders = [];</span>
<a href="#l42.1987"></a><span id="l42.1987" class="difflineminus">-  client = await gServer.getClient();</span>
<a href="#l42.1988"></a><span id="l42.1988" class="difflineminus">-  pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.1989"></a><span id="l42.1989" class="difflineminus">-</span>
<a href="#l42.1990"></a><span id="l42.1990" class="difflineminus">-  event = cal.createEvent(</span>
<a href="#l42.1991"></a><span id="l42.1991" class="difflineminus">-    [</span>
<a href="#l42.1992"></a><span id="l42.1992" class="difflineminus">-      &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l42.1993"></a><span id="l42.1993" class="difflineminus">-      &quot;SUMMARY:Default Alarms Empty&quot;,</span>
<a href="#l42.1994"></a><span id="l42.1994" class="difflineminus">-      &quot;DTSTART:20060610T180000Z&quot;,</span>
<a href="#l42.1995"></a><span id="l42.1995" class="difflineminus">-      &quot;DTEND:20060610T200000Z&quot;,</span>
<a href="#l42.1996"></a><span id="l42.1996" class="difflineminus">-      &quot;X-DEFAULT-ALARM:TRUE&quot;,</span>
<a href="#l42.1997"></a><span id="l42.1997" class="difflineminus">-      &quot;END:VEVENT&quot;,</span>
<a href="#l42.1998"></a><span id="l42.1998" class="difflineminus">-    ].join(&quot;\r\n&quot;)</span>
<a href="#l42.1999"></a><span id="l42.1999" class="difflineminus">-  );</span>
<a href="#l42.2000"></a><span id="l42.2000" class="difflineminus">-</span>
<a href="#l42.2001"></a><span id="l42.2001" class="difflineminus">-  await pclient.addItem(event);</span>
<a href="#l42.2002"></a><span id="l42.2002" class="difflineminus">-  ok(gServer.events[0].reminders.useDefault);</span>
<a href="#l42.2003"></a><span id="l42.2003" class="difflineminus">-  equal(gServer.events[0].reminders.overrides, undefined);</span>
<a href="#l42.2004"></a><span id="l42.2004" class="difflineminus">-</span>
<a href="#l42.2005"></a><span id="l42.2005" class="difflineminus">-  let events = gServer.events;</span>
<a href="#l42.2006"></a><span id="l42.2006" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.2007"></a><span id="l42.2007" class="difflineminus">-</span>
<a href="#l42.2008"></a><span id="l42.2008" class="difflineminus">-  // Case #4b: Read an item with empty default alarms</span>
<a href="#l42.2009"></a><span id="l42.2009" class="difflineminus">-  gServer.events = events;</span>
<a href="#l42.2010"></a><span id="l42.2010" class="difflineminus">-  client = await gServer.getClient();</span>
<a href="#l42.2011"></a><span id="l42.2011" class="difflineminus">-  pclient = cal.async.promisifyCalendar(client.wrappedJSObject);</span>
<a href="#l42.2012"></a><span id="l42.2012" class="difflineminus">-</span>
<a href="#l42.2013"></a><span id="l42.2013" class="difflineminus">-  item = (await pclient.getAllItems())[0];</span>
<a href="#l42.2014"></a><span id="l42.2014" class="difflineminus">-  equal(item.getProperty(&quot;X-DEFAULT-ALARM&quot;), &quot;TRUE&quot;);</span>
<a href="#l42.2015"></a><span id="l42.2015" class="difflineminus">-</span>
<a href="#l42.2016"></a><span id="l42.2016" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.2017"></a><span id="l42.2017" class="difflineminus">-});</span>
<a href="#l42.2018"></a><span id="l42.2018" class="difflineminus">-</span>
<a href="#l42.2019"></a><span id="l42.2019" class="difflineminus">-add_task(async function test_paginate() {</span>
<a href="#l42.2020"></a><span id="l42.2020" class="difflineminus">-  gServer.events = [</span>
<a href="#l42.2021"></a><span id="l42.2021" class="difflineminus">-    {</span>
<a href="#l42.2022"></a><span id="l42.2022" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.2023"></a><span id="l42.2023" class="difflineminus">-      etag: '&quot;1&quot;',</span>
<a href="#l42.2024"></a><span id="l42.2024" class="difflineminus">-      id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.2025"></a><span id="l42.2025" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.2026"></a><span id="l42.2026" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.2027"></a><span id="l42.2027" class="difflineminus">-      summary: &quot;New Event&quot;,</span>
<a href="#l42.2028"></a><span id="l42.2028" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.2029"></a><span id="l42.2029" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.2030"></a><span id="l42.2030" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.2031"></a><span id="l42.2031" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.2032"></a><span id="l42.2032" class="difflineminus">-      iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.2033"></a><span id="l42.2033" class="difflineminus">-    },</span>
<a href="#l42.2034"></a><span id="l42.2034" class="difflineminus">-    {</span>
<a href="#l42.2035"></a><span id="l42.2035" class="difflineminus">-      kind: &quot;calendar#event&quot;,</span>
<a href="#l42.2036"></a><span id="l42.2036" class="difflineminus">-      etag: '&quot;2&quot;',</span>
<a href="#l42.2037"></a><span id="l42.2037" class="difflineminus">-      id: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l42.2038"></a><span id="l42.2038" class="difflineminus">-      created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.2039"></a><span id="l42.2039" class="difflineminus">-      updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.2040"></a><span id="l42.2040" class="difflineminus">-      summary: &quot;New Event 2&quot;,</span>
<a href="#l42.2041"></a><span id="l42.2041" class="difflineminus">-      creator: gServer.creator,</span>
<a href="#l42.2042"></a><span id="l42.2042" class="difflineminus">-      organizer: gServer.creator,</span>
<a href="#l42.2043"></a><span id="l42.2043" class="difflineminus">-      start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.2044"></a><span id="l42.2044" class="difflineminus">-      end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.2045"></a><span id="l42.2045" class="difflineminus">-      iCalUID: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;,</span>
<a href="#l42.2046"></a><span id="l42.2046" class="difflineminus">-    },</span>
<a href="#l42.2047"></a><span id="l42.2047" class="difflineminus">-  ];</span>
<a href="#l42.2048"></a><span id="l42.2048" class="difflineminus">-</span>
<a href="#l42.2049"></a><span id="l42.2049" class="difflineminus">-  gServer.tasks = [</span>
<a href="#l42.2050"></a><span id="l42.2050" class="difflineminus">-    {</span>
<a href="#l42.2051"></a><span id="l42.2051" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.2052"></a><span id="l42.2052" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.2053"></a><span id="l42.2053" class="difflineminus">-      etag: '&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTIwNjA4MDcyNDM&quot;',</span>
<a href="#l42.2054"></a><span id="l42.2054" class="difflineminus">-      title: &quot;New Task&quot;,</span>
<a href="#l42.2055"></a><span id="l42.2055" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.2056"></a><span id="l42.2056" class="difflineminus">-      selfLink:</span>
<a href="#l42.2057"></a><span id="l42.2057" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.2058"></a><span id="l42.2058" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo0MDI1NDg2NjU&quot;,</span>
<a href="#l42.2059"></a><span id="l42.2059" class="difflineminus">-      position: &quot;00000000000000130998&quot;,</span>
<a href="#l42.2060"></a><span id="l42.2060" class="difflineminus">-      status: &quot;needsAction&quot;,</span>
<a href="#l42.2061"></a><span id="l42.2061" class="difflineminus">-    },</span>
<a href="#l42.2062"></a><span id="l42.2062" class="difflineminus">-    {</span>
<a href="#l42.2063"></a><span id="l42.2063" class="difflineminus">-      kind: &quot;tasks#task&quot;,</span>
<a href="#l42.2064"></a><span id="l42.2064" class="difflineminus">-      id: &quot;MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l42.2065"></a><span id="l42.2065" class="difflineminus">-      etag: '&quot;Lck7VNWFJuXdzMtOmrYPx0KFV2s/LTQyNTY0MjUwOQ&quot;',</span>
<a href="#l42.2066"></a><span id="l42.2066" class="difflineminus">-      title: &quot;New Task 2&quot;,</span>
<a href="#l42.2067"></a><span id="l42.2067" class="difflineminus">-      updated: &quot;2014-09-08T16:30:27.000Z&quot;,</span>
<a href="#l42.2068"></a><span id="l42.2068" class="difflineminus">-      selfLink:</span>
<a href="#l42.2069"></a><span id="l42.2069" class="difflineminus">-        gServer.baseUri +</span>
<a href="#l42.2070"></a><span id="l42.2070" class="difflineminus">-        &quot;/tasks/v1/lists/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDow/tasks/MTEyMDE2MDE5NzE0NjYzMDk4ODI6MDo5OTU0Mjk2MzQ&quot;,</span>
<a href="#l42.2071"></a><span id="l42.2071" class="difflineminus">-      position: &quot;00000000000000130993&quot;,</span>
<a href="#l42.2072"></a><span id="l42.2072" class="difflineminus">-      status: &quot;needsAction&quot;,</span>
<a href="#l42.2073"></a><span id="l42.2073" class="difflineminus">-    },</span>
<a href="#l42.2074"></a><span id="l42.2074" class="difflineminus">-  ];</span>
<a href="#l42.2075"></a><span id="l42.2075" class="difflineminus">-</span>
<a href="#l42.2076"></a><span id="l42.2076" class="difflineminus">-  Services.prefs.setIntPref(&quot;calendar.google.maxResultsPerRequest&quot;, 1);</span>
<a href="#l42.2077"></a><span id="l42.2077" class="difflineminus">-</span>
<a href="#l42.2078"></a><span id="l42.2078" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.2079"></a><span id="l42.2079" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l42.2080"></a><span id="l42.2080" class="difflineminus">-</span>
<a href="#l42.2081"></a><span id="l42.2081" class="difflineminus">-  // Make sure all pages were requested</span>
<a href="#l42.2082"></a><span id="l42.2082" class="difflineminus">-  equal(gServer.eventsData.nextPageToken, null);</span>
<a href="#l42.2083"></a><span id="l42.2083" class="difflineminus">-  equal(gServer.tasksData.nextPageToken, null);</span>
<a href="#l42.2084"></a><span id="l42.2084" class="difflineminus">-</span>
<a href="#l42.2085"></a><span id="l42.2085" class="difflineminus">-  // ...and we have all items. Not checking props</span>
<a href="#l42.2086"></a><span id="l42.2086" class="difflineminus">-  // because the other tests do this sufficiently.</span>
<a href="#l42.2087"></a><span id="l42.2087" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.2088"></a><span id="l42.2088" class="difflineminus">-  equal(items.length, 4);</span>
<a href="#l42.2089"></a><span id="l42.2089" class="difflineminus">-</span>
<a href="#l42.2090"></a><span id="l42.2090" class="difflineminus">-  equal(client.getProperty(&quot;syncToken.events&quot;), &quot;next-sync-token&quot;);</span>
<a href="#l42.2091"></a><span id="l42.2091" class="difflineminus">-</span>
<a href="#l42.2092"></a><span id="l42.2092" class="difflineminus">-  Services.prefs.clearUserPref(&quot;calendar.google.maxResultsPerRequest&quot;);</span>
<a href="#l42.2093"></a><span id="l42.2093" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.2094"></a><span id="l42.2094" class="difflineminus">-});</span>
<a href="#l42.2095"></a><span id="l42.2095" class="difflineminus">-</span>
<a href="#l42.2096"></a><span id="l42.2096" class="difflineminus">-add_task(async function test_incremental_reset() {</span>
<a href="#l42.2097"></a><span id="l42.2097" class="difflineminus">-  gServer.syncs = [</span>
<a href="#l42.2098"></a><span id="l42.2098" class="difflineminus">-    {</span>
<a href="#l42.2099"></a><span id="l42.2099" class="difflineminus">-      token: &quot;1&quot;,</span>
<a href="#l42.2100"></a><span id="l42.2100" class="difflineminus">-      events: [</span>
<a href="#l42.2101"></a><span id="l42.2101" class="difflineminus">-        {</span>
<a href="#l42.2102"></a><span id="l42.2102" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.2103"></a><span id="l42.2103" class="difflineminus">-          etag: '&quot;1&quot;',</span>
<a href="#l42.2104"></a><span id="l42.2104" class="difflineminus">-          id: &quot;go6ijb0b46hlpbu4eeu92njevo&quot;,</span>
<a href="#l42.2105"></a><span id="l42.2105" class="difflineminus">-          created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.2106"></a><span id="l42.2106" class="difflineminus">-          updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.2107"></a><span id="l42.2107" class="difflineminus">-          summary: &quot;New Event&quot;,</span>
<a href="#l42.2108"></a><span id="l42.2108" class="difflineminus">-          creator: gServer.creator,</span>
<a href="#l42.2109"></a><span id="l42.2109" class="difflineminus">-          organizer: gServer.creator,</span>
<a href="#l42.2110"></a><span id="l42.2110" class="difflineminus">-          start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.2111"></a><span id="l42.2111" class="difflineminus">-          end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.2112"></a><span id="l42.2112" class="difflineminus">-          iCalUID: &quot;go6ijb0b46hlpbu4eeu92njevo@google.com&quot;,</span>
<a href="#l42.2113"></a><span id="l42.2113" class="difflineminus">-        },</span>
<a href="#l42.2114"></a><span id="l42.2114" class="difflineminus">-      ],</span>
<a href="#l42.2115"></a><span id="l42.2115" class="difflineminus">-    },</span>
<a href="#l42.2116"></a><span id="l42.2116" class="difflineminus">-    {</span>
<a href="#l42.2117"></a><span id="l42.2117" class="difflineminus">-      token: &quot;2&quot;,</span>
<a href="#l42.2118"></a><span id="l42.2118" class="difflineminus">-      reset: true,</span>
<a href="#l42.2119"></a><span id="l42.2119" class="difflineminus">-    },</span>
<a href="#l42.2120"></a><span id="l42.2120" class="difflineminus">-    {</span>
<a href="#l42.2121"></a><span id="l42.2121" class="difflineminus">-      token: &quot;3&quot;,</span>
<a href="#l42.2122"></a><span id="l42.2122" class="difflineminus">-      events: [</span>
<a href="#l42.2123"></a><span id="l42.2123" class="difflineminus">-        {</span>
<a href="#l42.2124"></a><span id="l42.2124" class="difflineminus">-          kind: &quot;calendar#event&quot;,</span>
<a href="#l42.2125"></a><span id="l42.2125" class="difflineminus">-          etag: '&quot;2&quot;',</span>
<a href="#l42.2126"></a><span id="l42.2126" class="difflineminus">-          id: &quot;fepf8uf6n7n04w7feukucs9n8e&quot;,</span>
<a href="#l42.2127"></a><span id="l42.2127" class="difflineminus">-          created: &quot;2006-06-08T21:04:52.000Z&quot;,</span>
<a href="#l42.2128"></a><span id="l42.2128" class="difflineminus">-          updated: &quot;2006-06-08T21:05:49.138Z&quot;,</span>
<a href="#l42.2129"></a><span id="l42.2129" class="difflineminus">-          summary: &quot;New Event 2&quot;,</span>
<a href="#l42.2130"></a><span id="l42.2130" class="difflineminus">-          creator: gServer.creator,</span>
<a href="#l42.2131"></a><span id="l42.2131" class="difflineminus">-          organizer: gServer.creator,</span>
<a href="#l42.2132"></a><span id="l42.2132" class="difflineminus">-          start: { dateTime: &quot;2006-06-10T18:00:00+02:00&quot; },</span>
<a href="#l42.2133"></a><span id="l42.2133" class="difflineminus">-          end: { dateTime: &quot;2006-06-10T20:00:00+02:00&quot; },</span>
<a href="#l42.2134"></a><span id="l42.2134" class="difflineminus">-          iCalUID: &quot;fepf8uf6n7n04w7feukucs9n8e@google.com&quot;,</span>
<a href="#l42.2135"></a><span id="l42.2135" class="difflineminus">-        },</span>
<a href="#l42.2136"></a><span id="l42.2136" class="difflineminus">-      ],</span>
<a href="#l42.2137"></a><span id="l42.2137" class="difflineminus">-    },</span>
<a href="#l42.2138"></a><span id="l42.2138" class="difflineminus">-  ];</span>
<a href="#l42.2139"></a><span id="l42.2139" class="difflineminus">-  let client = await gServer.getClient();</span>
<a href="#l42.2140"></a><span id="l42.2140" class="difflineminus">-  let pclient = cal.async.promisifyCalendar(client);</span>
<a href="#l42.2141"></a><span id="l42.2141" class="difflineminus">-</span>
<a href="#l42.2142"></a><span id="l42.2142" class="difflineminus">-  let items = await pclient.getAllItems();</span>
<a href="#l42.2143"></a><span id="l42.2143" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.2144"></a><span id="l42.2144" class="difflineminus">-  equal(items[0].title, &quot;New Event&quot;);</span>
<a href="#l42.2145"></a><span id="l42.2145" class="difflineminus">-</span>
<a href="#l42.2146"></a><span id="l42.2146" class="difflineminus">-  client.refresh();</span>
<a href="#l42.2147"></a><span id="l42.2147" class="difflineminus">-  await gServer.waitForLoad(client);</span>
<a href="#l42.2148"></a><span id="l42.2148" class="difflineminus">-</span>
<a href="#l42.2149"></a><span id="l42.2149" class="difflineminus">-  items = await pclient.getAllItems();</span>
<a href="#l42.2150"></a><span id="l42.2150" class="difflineminus">-  equal(items.length, 1);</span>
<a href="#l42.2151"></a><span id="l42.2151" class="difflineminus">-  equal(items[0].title, &quot;New Event 2&quot;);</span>
<a href="#l42.2152"></a><span id="l42.2152" class="difflineminus">-</span>
<a href="#l42.2153"></a><span id="l42.2153" class="difflineminus">-  equal(gServer.syncs.length, 0);</span>
<a href="#l42.2154"></a><span id="l42.2154" class="difflineminus">-  equal(client.getProperty(&quot;syncToken.events&quot;), &quot;last&quot;);</span>
<a href="#l42.2155"></a><span id="l42.2155" class="difflineminus">-</span>
<a href="#l42.2156"></a><span id="l42.2156" class="difflineminus">-  gServer.resetClient(client);</span>
<a href="#l42.2157"></a><span id="l42.2157" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/test/unit/xpcshell-libical.ini</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell-libical.ini</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -1,12 +1,8 @@</span>
<a href="#l43.4"></a><span id="l43.4"> [DEFAULT]</span>
<a href="#l43.5"></a><span id="l43.5"> tags = calendar libical</span>
<a href="#l43.6"></a><span id="l43.6"> head = head_libical.js head_consts.js</span>
<a href="#l43.7"></a><span id="l43.7"> tail =</span>
<a href="#l43.8"></a><span id="l43.8"> dupe-manifest =</span>
<a href="#l43.9"></a><span id="l43.9"> support-files = data/**</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11" class="difflineminus">-[test_gdata_provider.js]</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-# See bug 1481180.</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-# This had requesttimeoutfactor = 2, but for libical that's unnecessary.</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-</span>
<a href="#l43.15"></a><span id="l43.15"> [include:xpcshell-shared.ini]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/app.mozbuild</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/app.mozbuild</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -16,17 +16,14 @@ include('/%s/toolkit/toolkit.mozbuild' %</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5"> if CONFIG['MOZ_EXTENSIONS']:</span>
<a href="#l44.6"></a><span id="l44.6">     DIRS += ['/%s/extensions' % CONFIG['mozreltopsrcdir']]</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> DIRS += ['/%s' % CONFIG['MOZ_BRANDING_DIRECTORY']]</span>
<a href="#l44.9"></a><span id="l44.9"> </span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11"> if CONFIG['MOZ_CALENDAR']:</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    DIRS += [</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-        '/%s/calendar/lightning' % CONFIG['commreltopsrcdir'],</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-        '/%s/calendar/providers/gdata' % CONFIG['commreltopsrcdir'],</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-    ]</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+    DIRS += ['/%s/calendar/lightning' % CONFIG['commreltopsrcdir']]</span>
<a href="#l44.17"></a><span id="l44.17"> </span>
<a href="#l44.18"></a><span id="l44.18"> DIRS += [</span>
<a href="#l44.19"></a><span id="l44.19">     '/%s/chat' % CONFIG['commreltopsrcdir'],</span>
<a href="#l44.20"></a><span id="l44.20">     '/%s/mail' % CONFIG['commreltopsrcdir'],</span>
<a href="#l44.21"></a><span id="l44.21"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/testsuite-targets.mk</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/testsuite-targets.mk</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -56,11 +56,10 @@ else</span>
<a href="#l45.4"></a><span id="l45.4"> package-tests: stage-mozmill</span>
<a href="#l45.5"></a><span id="l45.5"> endif</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7"> stage-mozmill: make-stage-dir</span>
<a href="#l45.8"></a><span id="l45.8"> 	$(MAKE) -C $(commtopobjdir)/mail/test/mozmill stage-package</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10"> stage-calendar: stage-mozmill</span>
<a href="#l45.11"></a><span id="l45.11"> 	$(MAKE) -C $(commtopobjdir)/calendar/lightning stage-package</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-	$(MAKE) -C $(commtopobjdir)/calendar/providers/gdata stage-package</span>
<a href="#l45.13"></a><span id="l45.13"> </span>
<a href="#l45.14"></a><span id="l45.14"> .PHONY: stage-mozmill stage-calendar</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/taskcluster/ci/test/tests.yml</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/taskcluster/ci/test/tests.yml</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -44,18 +44,16 @@ xpcshell:</span>
<a href="#l46.4"></a><span id="l46.4">                     - unittests/thunderbird_extra.py</span>
<a href="#l46.5"></a><span id="l46.5">         extra-options:</span>
<a href="#l46.6"></a><span id="l46.6">             - &quot;--xpcshell-suite=xpcshell&quot;</span>
<a href="#l46.7"></a><span id="l46.7">         requires-signed-builds:</span>
<a href="#l46.8"></a><span id="l46.8">             by-test-platform:</span>
<a href="#l46.9"></a><span id="l46.9">                 windows.*: true</span>
<a href="#l46.10"></a><span id="l46.10">                 default: false</span>
<a href="#l46.11"></a><span id="l46.11">     fetches:</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-        build:</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-            - gdata-provider.xpi</span>
<a href="#l46.14"></a><span id="l46.14">         toolchain:</span>
<a href="#l46.15"></a><span id="l46.15">             by-test-platform:</span>
<a href="#l46.16"></a><span id="l46.16">                 linux.*:</span>
<a href="#l46.17"></a><span id="l46.17">                     - linux64-node</span>
<a href="#l46.18"></a><span id="l46.18">                 macosx.*:</span>
<a href="#l46.19"></a><span id="l46.19">                     - macosx64-node</span>
<a href="#l46.20"></a><span id="l46.20">                 win.*64.*:</span>
<a href="#l46.21"></a><span id="l46.21">                     - win64-node</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/taskcluster/comm_taskgraph/manifests/thunderbird_candidates.yml</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -320,28 +320,16 @@ mapping:</span>
<a href="#l47.4"></a><span id="l47.4">         all_locales: true</span>
<a href="#l47.5"></a><span id="l47.5">         from:</span>
<a href="#l47.6"></a><span id="l47.6">             - mar-signing</span>
<a href="#l47.7"></a><span id="l47.7">         pretty_name: thunderbird-${version}.complete.mar</span>
<a href="#l47.8"></a><span id="l47.8">         checksums_path: update/${path_platform}/${locale}/thunderbird-${version}.complete.mar</span>
<a href="#l47.9"></a><span id="l47.9">         update_balrog_manifest: true</span>
<a href="#l47.10"></a><span id="l47.10">         destinations:</span>
<a href="#l47.11"></a><span id="l47.11">             - ${version}-candidates/build${build_number}/update/${path_platform}</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    gdata-provider.xpi:</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-        &lt;&lt;: *default</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-        description: &quot;Google data provider XPI (en-US only)&quot;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-        all_locales: false  # Uses default_locale only</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineminus">-        from:</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineminus">-            - build</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-        only_for_platforms:</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-            - linux64-shippable</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-        pretty_name: gdata-provider.${locale}.xpi</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineminus">-        checksums_path: gdata-provider.${locale}.xpi</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineminus">-        destinations:</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-            - ${version}-candidates/build${build_number}</span>
<a href="#l47.24"></a><span id="l47.24">     lightning.xpi:</span>
<a href="#l47.25"></a><span id="l47.25">         &lt;&lt;: *default</span>
<a href="#l47.26"></a><span id="l47.26">         description: &quot;Lightning XPI (en-US only)&quot;</span>
<a href="#l47.27"></a><span id="l47.27">         all_locales: false  # Uses default_locale only</span>
<a href="#l47.28"></a><span id="l47.28">         from:</span>
<a href="#l47.29"></a><span id="l47.29">             - build</span>
<a href="#l47.30"></a><span id="l47.30">         only_for_platforms:</span>
<a href="#l47.31"></a><span id="l47.31">             - linux64-shippable</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/taskcluster/comm_taskgraph/manifests/thunderbird_nightly.yml</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -386,30 +386,16 @@ mapping:</span>
<a href="#l48.4"></a><span id="l48.4">             by-locale:</span>
<a href="#l48.5"></a><span id="l48.5">                 en-US:</span>
<a href="#l48.6"></a><span id="l48.6">                     - ${year}/${month}/${upload_date}-${branch}</span>
<a href="#l48.7"></a><span id="l48.7">                     - latest-${branch}</span>
<a href="#l48.8"></a><span id="l48.8">                     - latest-${branch}-l10n</span>
<a href="#l48.9"></a><span id="l48.9">                 default:</span>
<a href="#l48.10"></a><span id="l48.10">                     - ${year}/${month}/${upload_date}-${branch}-l10n</span>
<a href="#l48.11"></a><span id="l48.11">                     - latest-${branch}-l10n</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-    gdata-provider.xpi:</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-        &lt;&lt;: *default</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-        description: &quot;Google data provider XPI (en-US only)&quot;</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-        all_locales: false  # Uses default_locale only</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-        from:</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-            - build</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-        only_for_platforms:</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-            - linux64-shippable</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-        pretty_name: gdata-provider.${locale}.xpi</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-        checksums_path: gdata-provider.${locale}.xpi</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-        destinations:</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-            - ${year}/${month}/${upload_date}-${branch}</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineminus">-            - latest-${branch}</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-            - latest-${branch}-l10n</span>
<a href="#l48.26"></a><span id="l48.26">     lightning.xpi:</span>
<a href="#l48.27"></a><span id="l48.27">         &lt;&lt;: *default</span>
<a href="#l48.28"></a><span id="l48.28">         description: &quot;Lightning XPI (en-US only)&quot;</span>
<a href="#l48.29"></a><span id="l48.29">         all_locales: false  # Uses default_locale only</span>
<a href="#l48.30"></a><span id="l48.30">         from:</span>
<a href="#l48.31"></a><span id="l48.31">             - build</span>
<a href="#l48.32"></a><span id="l48.32">         only_for_platforms:</span>
<a href="#l48.33"></a><span id="l48.33">             - linux64-shippable</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

