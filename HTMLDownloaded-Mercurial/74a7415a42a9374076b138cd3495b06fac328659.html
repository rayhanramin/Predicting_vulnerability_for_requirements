<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1022:74a7415a42a9374076b138cd3495b06fac328659</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 74a7415a42a9374076b138cd3495b06fac328659" />
<meta property="og:url" content="/comm-central/rev/74a7415a42a9374076b138cd3495b06fac328659" />
<meta property="og:description" content="Bug 419356 - &quot;Allow extensions to add custom filter actions&quot; [r=Neil,sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 74a7415a42a9374076b138cd3495b06fac328659 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/74a7415a42a9374076b138cd3495b06fac328659">shortlog</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/74a7415a42a9374076b138cd3495b06fac328659">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659">files</a> |
changeset |
<a href="/comm-central/raw-rev/74a7415a42a9374076b138cd3495b06fac328659">raw</a>  | <a href="/comm-central/archive/74a7415a42a9374076b138cd3495b06fac328659.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419356">Bug 419356</a> - &quot;Allow extensions to add custom filter actions&quot; [r=Neil,sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 05 Nov 2008 14:37:08 +0000</td></tr>

<tr>
 <td>changeset 1022</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/74a7415a42a9374076b138cd3495b06fac328659">74a7415a42a9374076b138cd3495b06fac328659</a></td>
</tr>



<tr>
<td>parent 1021</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4ae62e9a43c3dc39feeea1039d866ee6346afa7d">4ae62e9a43c3dc39feeea1039d866ee6346afa7d</a>
</td>
</tr>

<tr>
<td>child 1023</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7384fe415d491a04b314a273226ca39795b0144">b7384fe415d491a04b314a273226ca39795b0144</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=74a7415a42a9374076b138cd3495b06fac328659">760</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 05 Nov 2008 14:37:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@74a7415a42a9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=74a7415a42a9374076b138cd3495b06fac328659">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=74a7415a42a9374076b138cd3495b06fac328659&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74a7415a42a9374076b138cd3495b06fac328659&newProject=comm-central&newRevision=4ae62e9a43c3dc39feeea1039d866ee6346afa7d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74a7415a42a9374076b138cd3495b06fac328659&newProject=comm-central&newRevision=4ae62e9a43c3dc39feeea1039d866ee6346afa7d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74a7415a42a9374076b138cd3495b06fac328659&newProject=comm-central&newRevision=4ae62e9a43c3dc39feeea1039d866ee6346afa7d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419356">419356</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419356">Bug 419356</a> - &quot;Allow extensions to add custom filter actions&quot; [r=Neil,sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">mail/locales/en-US/chrome/messenger/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mail/locales/en-US/chrome/messenger/filter.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">mailnews/base/search/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">mailnews/base/search/public/nsIMsgFilter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilter.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">mailnews/base/search/public/nsIMsgFilterCustomAction.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterCustomAction.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">mailnews/base/search/public/nsIMsgFilterList.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterList.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">mailnews/base/search/public/nsIMsgFilterService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsIMsgFilterService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">mailnews/base/search/public/nsMsgFilterCore.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/public/nsMsgFilterCore.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">mailnews/base/search/resources/content/FilterEditor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">mailnews/base/search/resources/content/FilterEditor.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/FilterEditor.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">mailnews/base/search/resources/content/searchWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/resources/content/searchWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">mailnews/base/search/src/nsMsgFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">mailnews/base/search/src/nsMsgFilterService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/base/search/src/nsMsgFilterService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">suite/locales/en-US/chrome/mailnews/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">file</a> |
<a href="/comm-central/annotate/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">annotate</a> |
<a href="/comm-central/diff/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">diff</a> |
<a href="/comm-central/comparison/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">comparison</a> |
<a href="/comm-central/log/74a7415a42a9374076b138cd3495b06fac328659/suite/locales/en-US/chrome/mailnews/filter.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -26,16 +26,17 @@ junkLogDetectStr=Detected junk message f</span>
<a href="#l1.4"></a><span id="l1.4"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l1.5"></a><span id="l1.5"> logMoveStr=moved message id = %1$S to %2$S</span>
<a href="#l1.6"></a><span id="l1.6"> # LOCALIZATION NOTE(logCopyStr)</span>
<a href="#l1.7"></a><span id="l1.7"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l1.8"></a><span id="l1.8"> logCopyStr=copied message id = %1$S to %2$S</span>
<a href="#l1.9"></a><span id="l1.9"> # LOCALIZATION NOTE(filterLogDetectStr)</span>
<a href="#l1.10"></a><span id="l1.10"> # %1$S=filter name %2$S=author, %3$S=subject, %4$S=date</span>
<a href="#l1.11"></a><span id="l1.11"> filterLogDetectStr=Applied filter &quot;%1$S&quot; to message from %2$S - %3$S at %4$S</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+filterMissingCustomAction=Missing Custom Action</span>
<a href="#l1.13"></a><span id="l1.13"> filterAction2=priority changed</span>
<a href="#l1.14"></a><span id="l1.14"> filterAction3=deleted</span>
<a href="#l1.15"></a><span id="l1.15"> filterAction4=marked as read</span>
<a href="#l1.16"></a><span id="l1.16"> filterAction5=thread killed</span>
<a href="#l1.17"></a><span id="l1.17"> filterAction6=thread watched</span>
<a href="#l1.18"></a><span id="l1.18"> filterAction7=starred</span>
<a href="#l1.19"></a><span id="l1.19"> filterAction8=tagged</span>
<a href="#l1.20"></a><span id="l1.20"> filterAction9=replied</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -66,12 +66,13 @@ XPIDLSRCS	= \</span>
<a href="#l2.4"></a><span id="l2.4"> 		nsIMsgSearchAdapter.idl \</span>
<a href="#l2.5"></a><span id="l2.5"> 		nsIMsgSearchSession.idl \</span>
<a href="#l2.6"></a><span id="l2.6"> 		nsIMsgSearchScopeTerm.idl \</span>
<a href="#l2.7"></a><span id="l2.7"> 		nsIMsgSearchNotify.idl \</span>
<a href="#l2.8"></a><span id="l2.8"> 		nsIMsgSearchValidityTable.idl \</span>
<a href="#l2.9"></a><span id="l2.9"> 		nsIMsgSearchValidityManager.idl \</span>
<a href="#l2.10"></a><span id="l2.10"> 		nsMsgFilterCore.idl \</span>
<a href="#l2.11"></a><span id="l2.11"> 		nsMsgSearchCore.idl \</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+		nsIMsgFilterCustomAction.idl \</span>
<a href="#l2.13"></a><span id="l2.13"> 		$(NULL)</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l2.16"></a><span id="l2.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilter.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilter.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -16,16 +16,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  *</span>
<a href="#l3.5"></a><span id="l3.5">  * The Initial Developer of the Original Code is</span>
<a href="#l3.6"></a><span id="l3.6">  * Netscape Communications Corporation.</span>
<a href="#l3.7"></a><span id="l3.7">  * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l3.8"></a><span id="l3.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.9"></a><span id="l3.9">  *</span>
<a href="#l3.10"></a><span id="l3.10">  * Contributor(s):</span>
<a href="#l3.11"></a><span id="l3.11">  *</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *</span>
<a href="#l3.14"></a><span id="l3.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.15"></a><span id="l3.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l3.16"></a><span id="l3.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.17"></a><span id="l3.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.18"></a><span id="l3.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.19"></a><span id="l3.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.20"></a><span id="l3.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.21"></a><span id="l3.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -39,35 +41,43 @@</span>
<a href="#l3.23"></a><span id="l3.23"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.24"></a><span id="l3.24"> #include &quot;nsMsgFilterCore.idl&quot;</span>
<a href="#l3.25"></a><span id="l3.25"> #include &quot;nsIMsgSearchScopeTerm.idl&quot;</span>
<a href="#l3.26"></a><span id="l3.26"> #include &quot;nsIMsgSearchValue.idl&quot;</span>
<a href="#l3.27"></a><span id="l3.27"> #include &quot;nsIMsgSearchTerm.idl&quot;</span>
<a href="#l3.28"></a><span id="l3.28"> #include &quot;nsISupportsArray.idl&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30"> interface nsOutputStream;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+interface nsIMsgFilterCustomAction;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-[scriptable, uuid(FFC5D40D-7527-4286-9765-136617D32624)]</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+[scriptable, uuid(190A2A18-D245-473a-A402-9F0814598C7F)]</span>
<a href="#l3.35"></a><span id="l3.35"> interface nsIMsgRuleAction : nsISupports {</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   attribute nsMsgRuleActionType type;</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">   // target priority.. throws an exception if the action is not priority</span>
<a href="#l3.40"></a><span id="l3.40">   attribute nsMsgPriorityValue priority;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">   // target folder.. throws an exception if the action is not move to folder</span>
<a href="#l3.43"></a><span id="l3.43">   attribute ACString targetFolderUri;</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   // target label. throws an exception if the action is not label</span>
<a href="#l3.46"></a><span id="l3.46">   attribute nsMsgLabelValue label;</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   attribute long junkScore; </span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  attribute ACString strValue;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  attribute AUTF8String strValue;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  // action id if type is Custom</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  attribute ACString customId;</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  // custom action associated with customId</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  // (which must be set prior to reading this attribute)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  readonly attribute nsIMsgFilterCustomAction customAction;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  </span>
<a href="#l3.60"></a><span id="l3.60"> };</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62"> [scriptable, uuid(346C8CC6-35EA-4F44-B348-94E84D7C03E0)]</span>
<a href="#l3.63"></a><span id="l3.63"> interface nsIMsgFilter : nsISupports {</span>
<a href="#l3.64"></a><span id="l3.64">     attribute nsMsgFilterTypeType filterType;</span>
<a href="#l3.65"></a><span id="l3.65">     /**</span>
<a href="#l3.66"></a><span id="l3.66">      * some filters are &quot;temporary&quot;.  For example, the filters we create when the user</span>
<a href="#l3.67"></a><span id="l3.67">      * filters return receipts to the Sent folder.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterCustomAction.idl</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,115 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is mozilla.org code</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ *</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+#include &quot;nsMsgFilterCore.idl&quot;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+/**</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ * describes a custom action added to a message filter</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ */</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+[scriptable,uuid(EDD6E135-6790-475e-9547-3C1408CF2F07)]</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+interface nsIMsgFilterCustomAction : nsISupports</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+{</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  /* globally unique string to identify this filter action.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+   * recommended form: ExtensionName@example.com#ActionName</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+   */</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  readonly attribute ACString id;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  /* action name to display in action list. This should be localized. */</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  readonly attribute AString name;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  /**</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+   * Is this custom action valid for a particular filter type? </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+   *</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+   * @param type    the filter type</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+   * @param scope   the search scope</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+   *</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+   * @return        true if valid</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+   */</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  boolean isValidForType(in nsMsgFilterTypeType type, in nsMsgSearchScopeValue scope);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  /**</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+   * After the user inputs a particular action value for the action, determine</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+   * if that value is valid.</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+   *</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+   * @param actionValue          The value entered.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+   * @param actionFolder         Folder in the filter list</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+   * @param filterType           Filter Type (Manual, OfflineMail, etc.)</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+   *</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+   * @return errorMessage        A localized message to display if invalid</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+   *                             Set to null if the actionValue is valid</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+   */</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  AUTF8String validateActionValue(in AUTF8String actionValue,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+                                  in nsIMsgFolder actionFolder,</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+                                  in nsMsgFilterTypeType filterType);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  /* allow duplicate actions in the same filter list? Default No. */</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  attribute boolean allowDuplicates;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  /*</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+   * The custom action itself</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+   *</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   * Generally for the apply method, folder-based methods give correct</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+   * results and are preferred if available. Otherwise, be careful</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   * that the action does correct notifications to maintain counts, and correct</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+   * manipulations of both IMAP and local non-database storage of message</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   * metadata.</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+   */</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  /**</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+   * Apply the custom action to an array of messages</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+   *</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+   * @param msgHdrs      array of nsIMsgDBHdr objects of messages</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+   * @param actionValue  user-set value to use in the action</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+   * @param copyListener calling method (filterType Manual only)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+   * @param filterType   type of filter being applied</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+   * @param msgWindow    message window</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+   */</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  void apply(in nsIArray msgHdrs /* nsIMsgDBHdr array */,</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+             in AUTF8String actionValue,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+             in nsIMsgCopyServiceListener copyListener,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+             in nsMsgFilterTypeType filterType,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+             in nsIMsgWindow msgWindow);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  /* does this action start an async action? If so, a copy listener must</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+   * be used to continue filter processing after the action. This only</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+   * applies to after-the-fact (manual) filters. Call OnStopCopy when done</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+   * using the copyListener to continue.</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+   */</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  readonly attribute boolean isAsync;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+};</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterList.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterList.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">  *</span>
<a href="#l5.5"></a><span id="l5.5">  * The Initial Developer of the Original Code is</span>
<a href="#l5.6"></a><span id="l5.6">  * Netscape Communications Corporation.</span>
<a href="#l5.7"></a><span id="l5.7">  * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l5.8"></a><span id="l5.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * Contributor(s):</span>
<a href="#l5.11"></a><span id="l5.11">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l5.13"></a><span id="l5.13">  *</span>
<a href="#l5.14"></a><span id="l5.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.15"></a><span id="l5.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.16"></a><span id="l5.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.17"></a><span id="l5.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.18"></a><span id="l5.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.19"></a><span id="l5.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.20"></a><span id="l5.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -61,16 +62,17 @@ interface nsIMsgFilterList : nsISupports</span>
<a href="#l5.22"></a><span id="l5.22">     const nsMsgFilterFileAttribValue attribName = 3;</span>
<a href="#l5.23"></a><span id="l5.23">     const nsMsgFilterFileAttribValue attribEnabled = 4; </span>
<a href="#l5.24"></a><span id="l5.24">     const nsMsgFilterFileAttribValue attribDescription = 5; </span>
<a href="#l5.25"></a><span id="l5.25">     const nsMsgFilterFileAttribValue attribType = 6;</span>
<a href="#l5.26"></a><span id="l5.26">     const nsMsgFilterFileAttribValue attribScriptFile = 7; </span>
<a href="#l5.27"></a><span id="l5.27">     const nsMsgFilterFileAttribValue attribAction = 8; </span>
<a href="#l5.28"></a><span id="l5.28">     const nsMsgFilterFileAttribValue attribActionValue = 9; </span>
<a href="#l5.29"></a><span id="l5.29">     const nsMsgFilterFileAttribValue attribCondition = 10;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    const nsMsgFilterFileAttribValue attribCustomId = 11;</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">     attribute nsIMsgFolder folder;</span>
<a href="#l5.33"></a><span id="l5.33">     readonly attribute short version;</span>
<a href="#l5.34"></a><span id="l5.34">     readonly attribute ACString arbitraryHeaders;</span>
<a href="#l5.35"></a><span id="l5.35">     readonly attribute boolean shouldDownloadAllHeaders;</span>
<a href="#l5.36"></a><span id="l5.36">     readonly attribute unsigned long filterCount;</span>
<a href="#l5.37"></a><span id="l5.37">     nsIMsgFilter getFilterAt(in unsigned long filterIndex);</span>
<a href="#l5.38"></a><span id="l5.38">     nsIMsgFilter getFilterNamed(in AString filterName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  *</span>
<a href="#l6.5"></a><span id="l6.5">  * The Initial Developer of the Original Code is</span>
<a href="#l6.6"></a><span id="l6.6">  * Netscape Communications Corporation.</span>
<a href="#l6.7"></a><span id="l6.7">  * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l6.8"></a><span id="l6.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * Contributor(s):</span>
<a href="#l6.11"></a><span id="l6.11">  *     Jeff Beckley &lt;beckley@qualcomm.com&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *     Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l6.13"></a><span id="l6.13">  *</span>
<a href="#l6.14"></a><span id="l6.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.15"></a><span id="l6.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l6.16"></a><span id="l6.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.17"></a><span id="l6.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.18"></a><span id="l6.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.19"></a><span id="l6.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.20"></a><span id="l6.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -36,17 +37,20 @@</span>
<a href="#l6.22"></a><span id="l6.22">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.23"></a><span id="l6.23">  *</span>
<a href="#l6.24"></a><span id="l6.24">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l6.27"></a><span id="l6.27"> #include &quot;nsIMsgFilterList.idl&quot;</span>
<a href="#l6.28"></a><span id="l6.28"> #include &quot;nsIMsgWindow.idl&quot;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-[scriptable, uuid(6f9cecfb-ee4d-42fa-836f-a3a1da8d40a9)]</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+interface nsIMsgFilterCustomAction;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+interface nsISimpleEnumerator;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+[scriptable, uuid(5D7DF40A-CD9C-4729-A715-D5666C3AA713)]</span>
<a href="#l6.35"></a><span id="l6.35"> interface nsIMsgFilterService : nsISupports {</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">     nsIMsgFilterList OpenFilterList(in nsILocalFile filterFile, in nsIMsgFolder rootFolder, in nsIMsgWindow msgWindow);</span>
<a href="#l6.38"></a><span id="l6.38">     void CloseFilterList(in nsIMsgFilterList filterList);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">     void SaveFilterList(in nsIMsgFilterList filterList,</span>
<a href="#l6.41"></a><span id="l6.41">                         in nsILocalFile filterFile);</span>
<a href="#l6.42"></a><span id="l6.42">     </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineat">@@ -60,9 +64,32 @@ interface nsIMsgFilterService : nsISuppo</span>
<a href="#l6.44"></a><span id="l6.44">      * @param  aMsgHdrList  The list of message headers (nsIMsgDBHdr objects)</span>
<a href="#l6.45"></a><span id="l6.45">      * @param  aFolder      The folder the messages belong to</span>
<a href="#l6.46"></a><span id="l6.46">      * @param  aMsgWindow   A UI window for attaching progress/dialogs</span>
<a href="#l6.47"></a><span id="l6.47">      */</span>
<a href="#l6.48"></a><span id="l6.48">     void applyFilters(in nsMsgFilterTypeType aFilterType,</span>
<a href="#l6.49"></a><span id="l6.49">                       in nsIArray aMsgHdrList,</span>
<a href="#l6.50"></a><span id="l6.50">                       in nsIMsgFolder aFolder,</span>
<a href="#l6.51"></a><span id="l6.51">                       in nsIMsgWindow aMsgWindow);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    /**</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+     * add a custom filter action</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+     *</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+     * @param  aAction   the custom action to add</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+     */</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    void addCustomAction(in nsIMsgFilterCustomAction aAction);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    /**</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+     * get the list of custom actions</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+     *</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+     * @return   enumerator of nsIMsgFilterCustomAction objects</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+     */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    nsISimpleEnumerator getCustomActions();</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    /**</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+     * lookup a custom action given its id</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+     *</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+     * @param  id  unique identifier for a particular custom action</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+     *</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+     * @return     the custom action, or null if not found</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+     */</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    nsIMsgFilterCustomAction getCustomAction(in ACString id);</span>
<a href="#l6.75"></a><span id="l6.75"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgFilterCore.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgFilterCore.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -57,19 +57,21 @@ interface nsMsgFilterType {</span>
<a href="#l7.4"></a><span id="l7.4"> };</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> typedef long nsMsgFilterMotionValue;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> typedef long nsMsgFilterIndex;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> typedef long nsMsgRuleActionType;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-[scriptable, uuid(59af7696-1e28-4642-a400-fa327ae0b8d8)]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+[scriptable, uuid(7726FE79-AFA3-4a39-8292-733AEE288737)]</span>
<a href="#l7.14"></a><span id="l7.14"> interface nsMsgFilterAction {</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    // Custom Action.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    const long Custom=-1;</span>
<a href="#l7.18"></a><span id="l7.18">     /* if you change these, you need to update filter.properties,</span>
<a href="#l7.19"></a><span id="l7.19">        look for filterActionX */</span>
<a href="#l7.20"></a><span id="l7.20">     /* these longs are all actually of type nsMsgFilterActionType */</span>
<a href="#l7.21"></a><span id="l7.21">     const long None=0;        /* uninitialized state */</span>
<a href="#l7.22"></a><span id="l7.22">     const long MoveToFolder=1;</span>
<a href="#l7.23"></a><span id="l7.23">     const long ChangePriority=2;</span>
<a href="#l7.24"></a><span id="l7.24">     const long Delete=3;</span>
<a href="#l7.25"></a><span id="l7.25">     const long MarkRead=4;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/resources/content/FilterEditor.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/resources/content/FilterEditor.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -19,16 +19,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l8.5"></a><span id="l8.5">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.6"></a><span id="l8.6">  *</span>
<a href="#l8.7"></a><span id="l8.7">  * Contributor(s):</span>
<a href="#l8.8"></a><span id="l8.8">  *   Alec Flett &lt;alecf@netscape.com&gt;</span>
<a href="#l8.9"></a><span id="l8.9">  *   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l8.10"></a><span id="l8.10">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l8.11"></a><span id="l8.11">  *   Mark Banner &lt;mark@standard8.demon.co.uk&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l8.13"></a><span id="l8.13">  *</span>
<a href="#l8.14"></a><span id="l8.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.15"></a><span id="l8.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l8.16"></a><span id="l8.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.17"></a><span id="l8.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.18"></a><span id="l8.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.19"></a><span id="l8.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.20"></a><span id="l8.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -50,30 +51,33 @@ var gFilterList;</span>
<a href="#l8.22"></a><span id="l8.22"> var gFilterNameElement;</span>
<a href="#l8.23"></a><span id="l8.23"> var gFilterContext;</span>
<a href="#l8.24"></a><span id="l8.24"> var gFilterBundle;</span>
<a href="#l8.25"></a><span id="l8.25"> var gPreFillName;</span>
<a href="#l8.26"></a><span id="l8.26"> var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l8.27"></a><span id="l8.27"> var gPrefBranch;</span>
<a href="#l8.28"></a><span id="l8.28"> var gMailSession = null;</span>
<a href="#l8.29"></a><span id="l8.29"> var gFilterActionList;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+var gCustomActions = null;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+var gFilterType;</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33"> var gFilterActionStrings = [&quot;none&quot;, &quot;movemessage&quot;, &quot;setpriorityto&quot;, &quot;deletemessage&quot;, </span>
<a href="#l8.34"></a><span id="l8.34">                             &quot;markasread&quot;, &quot;ignorethread&quot;, &quot;watchthread&quot;, &quot;markasflagged&quot;,</span>
<a href="#l8.35"></a><span id="l8.35">                             &quot;label&quot;, &quot;replytomessage&quot;, &quot;forwardmessage&quot;, &quot;stopexecution&quot;,</span>
<a href="#l8.36"></a><span id="l8.36">                             &quot;deletefrompopserver&quot;,  &quot;leaveonpopserver&quot;, &quot;setjunkscore&quot;,</span>
<a href="#l8.37"></a><span id="l8.37">                             &quot;fetchfrompopserver&quot;, &quot;copymessage&quot;, &quot;addtagtomessage&quot;,</span>
<a href="#l8.38"></a><span id="l8.38">                             &quot;ignoresubthread&quot;];</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40"> var nsMsgFilterAction = Components.interfaces.nsMsgFilterAction;</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42"> var gFilterEditorMsgWindow = null;</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> function filterEditorOnLoad()</span>
<a href="#l8.45"></a><span id="l8.45"> {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  getCustomActions();</span>
<a href="#l8.47"></a><span id="l8.47">   initializeSearchWidgets();</span>
<a href="#l8.48"></a><span id="l8.48">   initializeFilterWidgets();</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService).getBranch(null);</span>
<a href="#l8.51"></a><span id="l8.51">   gFilterBundle = document.getElementById(&quot;bundle_filter&quot;);</span>
<a href="#l8.52"></a><span id="l8.52">   InitMessageMark();</span>
<a href="#l8.53"></a><span id="l8.53">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) </span>
<a href="#l8.54"></a><span id="l8.54">   {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineat">@@ -108,46 +112,50 @@ function filterEditorOnLoad()</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">         term.value = termValue;</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">         gFilter.appendTerm(term);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">         // the default action for news filters is Delete</span>
<a href="#l8.62"></a><span id="l8.62">         // for everything else, it's MoveToFolder</span>
<a href="#l8.63"></a><span id="l8.63">         var filterAction = gFilter.createAction();</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-        filterAction.type = (getScopeFromFilterList(gFilterList) == Components.interfaces.nsMsgSearchScope.newsFilter) ? nsMsgFilterAction.Delete : nsMsgFilterAction.MoveToFolder;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+        filterAction.type = (getScopeFromFilterList(gFilterList) ==</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+            Components.interfaces.nsMsgSearchScope.newsFilter) ?</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+            nsMsgFilterAction.Delete : nsMsgFilterAction.MoveToFolder;</span>
<a href="#l8.68"></a><span id="l8.68">         gFilter.appendAction(filterAction);</span>
<a href="#l8.69"></a><span id="l8.69">         initializeDialog(gFilter);</span>
<a href="#l8.70"></a><span id="l8.70">       }</span>
<a href="#l8.71"></a><span id="l8.71">       else</span>
<a href="#l8.72"></a><span id="l8.72">       {</span>
<a href="#l8.73"></a><span id="l8.73">         // fake the first more button press</span>
<a href="#l8.74"></a><span id="l8.74">         onMore(null);</span>
<a href="#l8.75"></a><span id="l8.75">       }</span>
<a href="#l8.76"></a><span id="l8.76">     }</span>
<a href="#l8.77"></a><span id="l8.77">   }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  // in the case of a new filter, we may not have an action row yet.</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  ensureActionRow();</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-</span>
<a href="#l8.82"></a><span id="l8.82">   if (!gFilter)</span>
<a href="#l8.83"></a><span id="l8.83">   {</span>
<a href="#l8.84"></a><span id="l8.84">     var stub = gFilterBundle.getString(&quot;untitledFilterName&quot;);</span>
<a href="#l8.85"></a><span id="l8.85">     var count = 1;</span>
<a href="#l8.86"></a><span id="l8.86">     var name = stub;</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88">     // Set the default filter name to be &quot;Untitled Filter&quot;</span>
<a href="#l8.89"></a><span id="l8.89">     while (duplicateFilterNameExists(name)) </span>
<a href="#l8.90"></a><span id="l8.90">     {</span>
<a href="#l8.91"></a><span id="l8.91">       count++;</span>
<a href="#l8.92"></a><span id="l8.92">       name = stub + &quot; &quot; + count.toString();</span>
<a href="#l8.93"></a><span id="l8.93">     }</span>
<a href="#l8.94"></a><span id="l8.94">     gFilterNameElement.value = name;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    gFilterContext.selectedIndex = 2; // both</span>
<a href="#l8.96"></a><span id="l8.96">   }</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  // in the case of a new filter, we may not have an action row yet.</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  ensureActionRow();</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  updateFilterType();</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102">   gFilterNameElement.select();</span>
<a href="#l8.103"></a><span id="l8.103">   // This call is required on mac and linux.  It has no effect under win32.  See bug 94800.</span>
<a href="#l8.104"></a><span id="l8.104">   gFilterNameElement.focus();</span>
<a href="#l8.105"></a><span id="l8.105">   moveToAlertPosition();</span>
<a href="#l8.106"></a><span id="l8.106"> }</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108"> function filterEditorOnUnload()</span>
<a href="#l8.109"></a><span id="l8.109"> {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineat">@@ -247,17 +255,19 @@ function initializeDialog(filter)</span>
<a href="#l8.111"></a><span id="l8.111">   for (var actionIndex=0; actionIndex &lt; numActions; actionIndex++)</span>
<a href="#l8.112"></a><span id="l8.112">   {</span>
<a href="#l8.113"></a><span id="l8.113">     var filterAction = actionList.QueryElementAt(actionIndex, Components.interfaces.nsIMsgRuleAction);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">     var newActionRow = document.createElement('listitem');</span>
<a href="#l8.116"></a><span id="l8.116">     newActionRow.setAttribute('initialActionIndex', actionIndex);</span>
<a href="#l8.117"></a><span id="l8.117">     newActionRow.className = 'ruleaction';</span>
<a href="#l8.118"></a><span id="l8.118">     gFilterActionList.appendChild(newActionRow);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-    newActionRow.setAttribute('value', gFilterActionStrings[filterAction.type]);    </span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+    newActionRow.setAttribute('value',</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+        filterAction.type == Components.interfaces.nsMsgFilterAction.Custom ?</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+        filterAction.customId : gFilterActionStrings[filterAction.type]);</span>
<a href="#l8.123"></a><span id="l8.123">   }</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">   var scope = getScope(filter);</span>
<a href="#l8.126"></a><span id="l8.126">   setSearchScope(scope);</span>
<a href="#l8.127"></a><span id="l8.127">   initializeSearchRows(scope, filter.searchTerms);</span>
<a href="#l8.128"></a><span id="l8.128"> }</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130"> function ensureActionRow()</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineat">@@ -272,17 +282,16 @@ function ensureActionRow()</span>
<a href="#l8.132"></a><span id="l8.132">   }</span>
<a href="#l8.133"></a><span id="l8.133"> }</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135"> // move to overlay</span>
<a href="#l8.136"></a><span id="l8.136"> function saveFilter() </span>
<a href="#l8.137"></a><span id="l8.137"> {</span>
<a href="#l8.138"></a><span id="l8.138">   var isNewFilter;</span>
<a href="#l8.139"></a><span id="l8.139">   var filterAction; </span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-  var targetUri;</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142">   var filterName= gFilterNameElement.value;</span>
<a href="#l8.143"></a><span id="l8.143">   if (!filterName || filterName == &quot;&quot;) </span>
<a href="#l8.144"></a><span id="l8.144">   {</span>
<a href="#l8.145"></a><span id="l8.145">     if (gPromptService)</span>
<a href="#l8.146"></a><span id="l8.146">       gPromptService.alert(window, null,</span>
<a href="#l8.147"></a><span id="l8.147">                            gFilterBundle.getString(&quot;mustEnterName&quot;));</span>
<a href="#l8.148"></a><span id="l8.148">     gFilterNameElement.focus();</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineat">@@ -332,33 +341,17 @@ function saveFilter()</span>
<a href="#l8.150"></a><span id="l8.150">     </span>
<a href="#l8.151"></a><span id="l8.151">     gFilter.clearActionList();</span>
<a href="#l8.152"></a><span id="l8.152">   }</span>
<a href="#l8.153"></a><span id="l8.153"> </span>
<a href="#l8.154"></a><span id="l8.154">   // add each filteraction to the filter</span>
<a href="#l8.155"></a><span id="l8.155">   for (index = 0; index &lt; gFilterActionList.getRowCount(); index++)</span>
<a href="#l8.156"></a><span id="l8.156">     gFilterActionList.getItemAtIndex(index).saveToFilter(gFilter);</span>
<a href="#l8.157"></a><span id="l8.157"> </span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-  var contextIndex = gFilterContext.selectedIndex;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-  if (contextIndex &lt; 0 || contextIndex == 1)</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-  {</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-    gFilter.filterType = Components.interfaces.nsMsgFilterType.None;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-  }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-  else</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-  {</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    if (getScope(gFilter) == Components.interfaces.nsMsgSearchScope.newsFilter)</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-      gFilter.filterType = Components.interfaces.nsMsgFilterType.NewsRule;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    else</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-      gFilter.filterType = Components.interfaces.nsMsgFilterType.InboxRule;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-  }</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-  if (contextIndex &gt; 0)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-    gFilter.filterType |= Components.interfaces.nsMsgFilterType.Manual;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-  if (gFilter.filterType == Components.interfaces.nsMsgFilterType.None)</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    gFilter.enabled = false;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  updateFilterType();</span>
<a href="#l8.176"></a><span id="l8.176">   saveSearchTerms(gFilter.searchTerms, gFilter);</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178">   if (isNewFilter) </span>
<a href="#l8.179"></a><span id="l8.179">   {</span>
<a href="#l8.180"></a><span id="l8.180">     // new filter - insert into gFilterList</span>
<a href="#l8.181"></a><span id="l8.181">     gFilterList.insertFilterAt(0, gFilter);</span>
<a href="#l8.182"></a><span id="l8.182">   }</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184" class="difflineat">@@ -450,8 +443,53 @@ function SetBusyCursor(window, enable)</span>
<a href="#l8.185"></a><span id="l8.185">   }</span>
<a href="#l8.186"></a><span id="l8.186"> }</span>
<a href="#l8.187"></a><span id="l8.187"> </span>
<a href="#l8.188"></a><span id="l8.188"> function doHelpButton()</span>
<a href="#l8.189"></a><span id="l8.189"> {</span>
<a href="#l8.190"></a><span id="l8.190">   openHelp(&quot;mail-filters&quot;);</span>
<a href="#l8.191"></a><span id="l8.191"> }</span>
<a href="#l8.192"></a><span id="l8.192"> </span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+function getCustomActions()</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+{</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+  if (!gCustomActions)</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    gCustomActions = [];</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    var filterService = Components.classes[</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+                        &quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+                        .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    var customActionsEnum = filterService.getCustomActions();</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    while (customActionsEnum.hasMoreElements())</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      gCustomActions.push(customActionsEnum.getNext().QueryInterface(</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+                           Components.interfaces.nsIMsgFilterCustomAction));</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+  }</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+}</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+function updateFilterType()</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+{</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  var contextIndex = gFilterContext.selectedIndex;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  if (contextIndex &lt; 0 || contextIndex == 1)</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  {</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+    gFilterType = Components.interfaces.nsMsgFilterType.None;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  }</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+  else</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  {</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+    if (getScopeFromFilterList(gFilterList) == Components.interfaces.nsMsgSearchScope.newsFilter)</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+      gFilterType = Components.interfaces.nsMsgFilterType.NewsRule;</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    else</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+      gFilterType = Components.interfaces.nsMsgFilterType.InboxRule;</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+  }</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+  if (contextIndex &gt; 0)</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+    gFilterType |= Components.interfaces.nsMsgFilterType.Manual;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  if (gFilter)</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+  {</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+    gFilter.filterType = gFilterType;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+    if (gFilter.filterType == Components.interfaces.nsMsgFilterType.None)</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+      gFilter.enabled = false;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+  }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  // set valid actions</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+  var ruleActions = gFilterActionList.getElementsByAttribute('class', 'ruleaction');</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+  for (var i = 0; i &lt; ruleActions.length; i++)</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+    ruleActions[i].mRuleActionType.hideInvalidActions();</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/search/resources/content/FilterEditor.xul</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/search/resources/content/FilterEditor.xul</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -78,24 +78,24 @@</span>
<a href="#l9.4"></a><span id="l9.4">   &lt;separator/&gt;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l9.7"></a><span id="l9.7">     &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l9.8"></a><span id="l9.8">       &lt;label value=&quot;&amp;contextDesc.label;&quot;</span>
<a href="#l9.9"></a><span id="l9.9">              accesskey=&quot;&amp;contextDesc.accesskey;&quot;</span>
<a href="#l9.10"></a><span id="l9.10">              control=&quot;contextMenuList&quot;/&gt;</span>
<a href="#l9.11"></a><span id="l9.11">       &lt;menulist id=&quot;contextMenuList&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                value=&quot;&amp;contextBoth.label;&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                value=&quot;both&quot; oncommand=&quot;updateFilterType();&quot;&gt;</span>
<a href="#l9.14"></a><span id="l9.14">         &lt;menupopup&gt;</span>
<a href="#l9.15"></a><span id="l9.15">           &lt;menuitem label=&quot;&amp;contextIncoming.label;&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-                    value=&quot;&amp;contextIncoming.label;&quot;/&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+                    value=&quot;incoming&quot;/&gt;</span>
<a href="#l9.18"></a><span id="l9.18">           &lt;menuitem label=&quot;&amp;contextManual.label;&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-                    value=&quot;&amp;contextManual.label;&quot;/&gt;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+                    value=&quot;manual&quot;/&gt;</span>
<a href="#l9.21"></a><span id="l9.21">           &lt;menuitem label=&quot;&amp;contextBoth.label;&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-                    value=&quot;&amp;contextBoth.label;&quot;/&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+                    value=&quot;both&quot;/&gt;</span>
<a href="#l9.24"></a><span id="l9.24">         &lt;/menupopup&gt;</span>
<a href="#l9.25"></a><span id="l9.25">       &lt;/menulist&gt;</span>
<a href="#l9.26"></a><span id="l9.26">     &lt;/hbox&gt;</span>
<a href="#l9.27"></a><span id="l9.27">     &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l9.28"></a><span id="l9.28">       &lt;vbox id=&quot;searchTermListBox&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l9.29"></a><span id="l9.29">     &lt;/hbox&gt;</span>
<a href="#l9.30"></a><span id="l9.30">   &lt;/vbox&gt;</span>
<a href="#l9.31"></a><span id="l9.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/search/resources/content/searchWidgets.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/search/resources/content/searchWidgets.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -17,36 +17,40 @@</span>
<a href="#l10.4"></a><span id="l10.4">    -</span>
<a href="#l10.5"></a><span id="l10.5">    - The Initial Developer of the Original Code is</span>
<a href="#l10.6"></a><span id="l10.6">    -    Scott MacGregor &lt;mscott@mozilla.org&gt;.</span>
<a href="#l10.7"></a><span id="l10.7">    - Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l10.8"></a><span id="l10.8">    - the Initial Developer. All Rights Reserved.</span>
<a href="#l10.9"></a><span id="l10.9">    -</span>
<a href="#l10.10"></a><span id="l10.10">    - Contributor(s):</span>
<a href="#l10.11"></a><span id="l10.11">    -    Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+   -    Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l10.13"></a><span id="l10.13">    -</span>
<a href="#l10.14"></a><span id="l10.14">    - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.15"></a><span id="l10.15">    - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.16"></a><span id="l10.16">    - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.17"></a><span id="l10.17">    - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.18"></a><span id="l10.18">    - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.19"></a><span id="l10.19">    - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.20"></a><span id="l10.20">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.21"></a><span id="l10.21">    - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.22"></a><span id="l10.22">    - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l10.23"></a><span id="l10.23">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.24"></a><span id="l10.24">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.25"></a><span id="l10.25">    -</span>
<a href="#l10.26"></a><span id="l10.26">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-&lt;!-- </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+&lt;!--</span>
<a href="#l10.30"></a><span id="l10.30">   This file has the following external dependencies:</span>
<a href="#l10.31"></a><span id="l10.31">       -gFilterActionStrings from FilterEditor.js</span>
<a href="#l10.32"></a><span id="l10.32">       -gFilterList from FilterEditor.js</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+      -gFilter from FilterEditor.js</span>
<a href="#l10.34"></a><span id="l10.34">       -gPromptService from FilterEditor.js</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+      -gCustomActions from FilterEditor.js</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+      -gFilterType from FilterEditor.js</span>
<a href="#l10.37"></a><span id="l10.37">       -gMessengerBundle from msgFolderPickerOverlay.js</span>
<a href="#l10.38"></a><span id="l10.38">       -GetMsgFolderFromUri, SetFolderPickerElement from msgFolderPickerOverlay.js</span>
<a href="#l10.39"></a><span id="l10.39"> --&gt;</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41"> &lt;!DOCTYPE dialog [</span>
<a href="#l10.42"></a><span id="l10.42">   &lt;!ENTITY % filterEditorDTD SYSTEM &quot;chrome://messenger/locale/FilterEditor.dtd&quot; &gt;</span>
<a href="#l10.43"></a><span id="l10.43"> %filterEditorDTD;</span>
<a href="#l10.44"></a><span id="l10.44">   &lt;!ENTITY % msgFolderPickerOverlayDTD SYSTEM &quot;chrome://messenger/locale/msgFolderPickerOverlay.dtd&quot; &gt;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineat">@@ -62,17 +66,17 @@</span>
<a href="#l10.46"></a><span id="l10.46">   &lt;binding id=&quot;ruleactiontype-menulist&quot;&gt;</span>
<a href="#l10.47"></a><span id="l10.47">     &lt;content&gt;</span>
<a href="#l10.48"></a><span id="l10.48">       &lt;xul:menulist class=&quot;ruleaction-type&quot;&gt;</span>
<a href="#l10.49"></a><span id="l10.49">           &lt;xul:menupopup&gt;</span>
<a href="#l10.50"></a><span id="l10.50">             &lt;xul:menuitem label=&quot;&amp;moveMessage.label;&quot; value=&quot;movemessage&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l10.51"></a><span id="l10.51">             &lt;xul:menuitem label=&quot;&amp;copyMessage.label;&quot; value=&quot;copymessage&quot;/&gt;</span>
<a href="#l10.52"></a><span id="l10.52">             &lt;xul:menuseparator enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l10.53"></a><span id="l10.53">             &lt;xul:menuitem label=&quot;&amp;forwardTo.label;&quot; value=&quot;forwardmessage&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-            &lt;xul:menuitem label=&quot;&amp;replyWithTemplate.label;&quot; value=&quot;replytomessage&quot; enablefornews=&quot;false&quot;/&gt;         </span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+            &lt;xul:menuitem label=&quot;&amp;replyWithTemplate.label;&quot; value=&quot;replytomessage&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l10.56"></a><span id="l10.56">             &lt;xul:menuseparator/&gt;</span>
<a href="#l10.57"></a><span id="l10.57">             &lt;xul:menuitem label=&quot;&amp;markMessageRead.label;&quot; value=&quot;markasread&quot;/&gt;</span>
<a href="#l10.58"></a><span id="l10.58">             &lt;xul:menuitem label=&quot;&amp;markMessageStarred.label;&quot; value=&quot;markasflagged&quot;/&gt;</span>
<a href="#l10.59"></a><span id="l10.59">             &lt;xul:menuitem label=&quot;&amp;setPriority.label;&quot;  value=&quot;setpriorityto&quot;/&gt;</span>
<a href="#l10.60"></a><span id="l10.60">             &lt;xul:menuitem label=&quot;&amp;addTag.label;&quot;  value=&quot;addtagtomessage&quot;/&gt;</span>
<a href="#l10.61"></a><span id="l10.61">             &lt;xul:menuitem label=&quot;&amp;setJunkScore.label;&quot; value=&quot;setjunkscore&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l10.62"></a><span id="l10.62">             &lt;xul:menuseparator enableforpop3=&quot;true&quot;/&gt;</span>
<a href="#l10.63"></a><span id="l10.63">             &lt;xul:menuitem label=&quot;&amp;deleteMessage.label;&quot; value=&quot;deletemessage&quot;/&gt;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineat">@@ -86,108 +90,149 @@</span>
<a href="#l10.65"></a><span id="l10.65">             &lt;xul:menuitem label=&quot;&amp;stopExecution.label;&quot; value=&quot;stopexecution&quot;/&gt;</span>
<a href="#l10.66"></a><span id="l10.66">           &lt;/xul:menupopup&gt;</span>
<a href="#l10.67"></a><span id="l10.67">       &lt;/xul:menulist&gt;</span>
<a href="#l10.68"></a><span id="l10.68">     &lt;/content&gt;</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">     &lt;implementation&gt;</span>
<a href="#l10.71"></a><span id="l10.71">       &lt;constructor&gt;</span>
<a href="#l10.72"></a><span id="l10.72">         &lt;![CDATA[</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+          this.addCustomActions();</span>
<a href="#l10.74"></a><span id="l10.74">           this.hideInvalidActions();</span>
<a href="#l10.75"></a><span id="l10.75">           // differentiate between creating a new, next available action,</span>
<a href="#l10.76"></a><span id="l10.76">           // and creating a row which will be initialized with an action</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-          if (!this.parentNode.hasAttribute('initialActionIndex')) </span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-          {        </span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+          if (!this.parentNode.hasAttribute('initialActionIndex'))</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+          {</span>
<a href="#l10.81"></a><span id="l10.81">             var unavailableActions = this.usedActionsList();</span>
<a href="#l10.82"></a><span id="l10.82">             // select the first one that's not in the list</span>
<a href="#l10.83"></a><span id="l10.83">             for (var index = 0; index &lt; this.menuitems.length; index++)</span>
<a href="#l10.84"></a><span id="l10.84">             {</span>
<a href="#l10.85"></a><span id="l10.85">               var menu = this.menuitems[index];</span>
<a href="#l10.86"></a><span id="l10.86">               if (!(menu.value in unavailableActions) &amp;&amp; !menu.hidden)</span>
<a href="#l10.87"></a><span id="l10.87">               {</span>
<a href="#l10.88"></a><span id="l10.88">                 this.menulist.value = menu.value;</span>
<a href="#l10.89"></a><span id="l10.89">                 this.parentNode.setAttribute('value', menu.value);</span>
<a href="#l10.90"></a><span id="l10.90">                 break;</span>
<a href="#l10.91"></a><span id="l10.91">               }</span>
<a href="#l10.92"></a><span id="l10.92">             }</span>
<a href="#l10.93"></a><span id="l10.93">           }</span>
<a href="#l10.94"></a><span id="l10.94">           else</span>
<a href="#l10.95"></a><span id="l10.95">           {</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-            this.parentNode.mActionTypeInitialized = true; </span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+            this.parentNode.mActionTypeInitialized = true;</span>
<a href="#l10.98"></a><span id="l10.98">             this.parentNode.clearInitialActionIndex();</span>
<a href="#l10.99"></a><span id="l10.99">           }</span>
<a href="#l10.100"></a><span id="l10.100">         ]]&gt;</span>
<a href="#l10.101"></a><span id="l10.101">       &lt;/constructor&gt;</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103">       &lt;field name=&quot;menulist&quot;&gt;document.getAnonymousNodes(this)[0]&lt;/field&gt;</span>
<a href="#l10.104"></a><span id="l10.104">       &lt;field name=&quot;menuitems&quot;&gt;this.menulist.getElementsByTagNameNS(this.menulist.namespaceURI, 'menuitem')&lt;/field&gt;</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106">       &lt;method name=&quot;hideInvalidActions&quot;&gt;</span>
<a href="#l10.107"></a><span id="l10.107">         &lt;body&gt;</span>
<a href="#l10.108"></a><span id="l10.108">           &lt;![CDATA[</span>
<a href="#l10.109"></a><span id="l10.109">             var menupopup = this.menulist.menupopup;</span>
<a href="#l10.110"></a><span id="l10.110">             var scope = getScopeFromFilterList(gFilterList);</span>
<a href="#l10.111"></a><span id="l10.111"> </span>
<a href="#l10.112"></a><span id="l10.112">             // walk through the list of filter actions and hide any actions which aren't valid</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-            // for our given scope (news, imap, pop, etc)</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+            // for our given scope (news, imap, pop, etc) and context</span>
<a href="#l10.115"></a><span id="l10.115">             var elements, i;</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117">             // disable / enable all elements in the &quot;filteractionlist&quot;</span>
<a href="#l10.118"></a><span id="l10.118">             // based on the scope and the &quot;enablefornews&quot; attribute</span>
<a href="#l10.119"></a><span id="l10.119">             elements = menupopup.getElementsByAttribute(&quot;enablefornews&quot;, &quot;true&quot;);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-            for (i = 0; i &lt; elements.length; i++) </span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+            for (i = 0; i &lt; elements.length; i++)</span>
<a href="#l10.122"></a><span id="l10.122">               elements[i].hidden = scope != Components.interfaces.nsMsgSearchScope.newsFilter;</span>
<a href="#l10.123"></a><span id="l10.123"> </span>
<a href="#l10.124"></a><span id="l10.124">             elements = menupopup.getElementsByAttribute(&quot;enablefornews&quot;, &quot;false&quot;);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-            for (i = 0; i &lt; elements.length; i++) </span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+            for (i = 0; i &lt; elements.length; i++)</span>
<a href="#l10.127"></a><span id="l10.127">               elements[i].hidden = scope == Components.interfaces.nsMsgSearchScope.newsFilter;</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">             elements = menupopup.getElementsByAttribute(&quot;enableforpop3&quot;, &quot;true&quot;);</span>
<a href="#l10.130"></a><span id="l10.130">             for (i = 0; i &lt; elements.length; i++)</span>
<a href="#l10.131"></a><span id="l10.131">               elements[i].hidden = scope != Components.interfaces.nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+            elements = menupopup.getElementsByAttribute(&quot;isCustom&quot;, &quot;true&quot;);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+            // Note there might be an additional element here as a placeholder</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+            // for a missing action, so we iterate over the known actions</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+            // instead of the elements</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+            for (i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+              elements[i].hidden = !gCustomActions[i]</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+                                     .isValidForType(gFilterType, scope);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+          ]]&gt;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+      &lt;method name=&quot;addCustomActions&quot;&gt;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+            var menupopup = this.menulist.menupopup;</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+            for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+            {</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+              var customAction = gCustomActions[i];</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+              var menuitem = document.createElementNS(</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+                &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+                &quot;xul:menuitem&quot;);</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+              menuitem.setAttribute(&quot;label&quot;, customAction.name);</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+              menuitem.setAttribute(&quot;value&quot;, customAction.id);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+              menuitem.setAttribute(&quot;isCustom&quot;, &quot;true&quot;);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+              menupopup.appendChild(menuitem);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+            }</span>
<a href="#l10.159"></a><span id="l10.159">           ]]&gt;</span>
<a href="#l10.160"></a><span id="l10.160">         &lt;/body&gt;</span>
<a href="#l10.161"></a><span id="l10.161">       &lt;/method&gt;</span>
<a href="#l10.162"></a><span id="l10.162"> </span>
<a href="#l10.163"></a><span id="l10.163">       &lt;method name=&quot;numVisibleActions&quot;&gt;</span>
<a href="#l10.164"></a><span id="l10.164">         &lt;body&gt;</span>
<a href="#l10.165"></a><span id="l10.165">           &lt;![CDATA[</span>
<a href="#l10.166"></a><span id="l10.166">             var numVisibleActions = 0;</span>
<a href="#l10.167"></a><span id="l10.167">             // only count the items that are visible</span>
<a href="#l10.168"></a><span id="l10.168">             for (var index = 0; index &lt; this.menuitems.length; index++)</span>
<a href="#l10.169"></a><span id="l10.169">               if (!this.menuitems[index].hidden)</span>
<a href="#l10.170"></a><span id="l10.170">                 numVisibleActions++;</span>
<a href="#l10.171"></a><span id="l10.171">             return numVisibleActions;</span>
<a href="#l10.172"></a><span id="l10.172">           ]]&gt;</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-        &lt;/body&gt;       </span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l10.175"></a><span id="l10.175">       &lt;/method&gt;</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-      </span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+</span>
<a href="#l10.178"></a><span id="l10.178">       &lt;!-- returns a hash containing all of the filter actions which are currently being used by other filteractionrows --&gt;</span>
<a href="#l10.179"></a><span id="l10.179">       &lt;method name=&quot;usedActionsList&quot;&gt;</span>
<a href="#l10.180"></a><span id="l10.180">         &lt;body&gt;</span>
<a href="#l10.181"></a><span id="l10.181">           &lt;![CDATA[</span>
<a href="#l10.182"></a><span id="l10.182">             var usedActions = {};</span>
<a href="#l10.183"></a><span id="l10.183">             var currentFilterActionRow = this.parentNode;</span>
<a href="#l10.184"></a><span id="l10.184">             var listBox = currentFilterActionRow.mListBox; // need to account for the list item</span>
<a href="#l10.185"></a><span id="l10.185">             // now iterate over each list item in the list box</span>
<a href="#l10.186"></a><span id="l10.186">             for (var index = 0; index &lt; listBox.getRowCount(); index++)</span>
<a href="#l10.187"></a><span id="l10.187">             {</span>
<a href="#l10.188"></a><span id="l10.188">               var filterActionRow = listBox.getItemAtIndex(index);</span>
<a href="#l10.189"></a><span id="l10.189">               if (filterActionRow != currentFilterActionRow)</span>
<a href="#l10.190"></a><span id="l10.190">               {</span>
<a href="#l10.191"></a><span id="l10.191">                 var actionValue = filterActionRow.getAttribute('value');</span>
<a href="#l10.192"></a><span id="l10.192"> </span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+                // let custom actions decide if dups are allowed</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+                var isCustom = false;</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+                {</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+                  if (gCustomActions[i].id == actionValue)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+                  {</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+                    isCustom = true;</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+                    if (!gCustomActions[i].allowDuplicates)</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+                      usedActions[actionValue] = true;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+                    break;</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+                  }</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+                }</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+</span>
<a href="#l10.206"></a><span id="l10.206">                 // don't add the tag action, several tags can be set</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-                if (actionValue != 'addtagtomessage')</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+                if (!isCustom &amp;&amp; actionValue != 'addtagtomessage')</span>
<a href="#l10.209"></a><span id="l10.209">                   usedActions[actionValue] = true;</span>
<a href="#l10.210"></a><span id="l10.210">               }</span>
<a href="#l10.211"></a><span id="l10.211">             }</span>
<a href="#l10.212"></a><span id="l10.212">             return usedActions;</span>
<a href="#l10.213"></a><span id="l10.213">           ]]&gt;</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-        &lt;/body&gt;       </span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l10.216"></a><span id="l10.216">       &lt;/method&gt;</span>
<a href="#l10.217"></a><span id="l10.217">     &lt;/implementation&gt;</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219">     &lt;handlers&gt;</span>
<a href="#l10.220"></a><span id="l10.220">       &lt;handler event=&quot;command&quot;&gt;</span>
<a href="#l10.221"></a><span id="l10.221">         &lt;![CDATA[</span>
<a href="#l10.222"></a><span id="l10.222">           this.parentNode.setAttribute('value', this.menulist.value);</span>
<a href="#l10.223"></a><span id="l10.223">         ]]&gt;</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineat">@@ -195,17 +240,17 @@</span>
<a href="#l10.225"></a><span id="l10.225"> </span>
<a href="#l10.226"></a><span id="l10.226">       &lt;handler event=&quot;popupshowing&quot;&gt;</span>
<a href="#l10.227"></a><span id="l10.227">         &lt;![CDATA[</span>
<a href="#l10.228"></a><span id="l10.228">           var unavailableActions = this.usedActionsList();</span>
<a href="#l10.229"></a><span id="l10.229">           for (var index = 0; index &lt; this.menuitems.length; index++)</span>
<a href="#l10.230"></a><span id="l10.230">           {</span>
<a href="#l10.231"></a><span id="l10.231">             var menu = this.menuitems[index];</span>
<a href="#l10.232"></a><span id="l10.232">             menu.setAttribute('disabled', menu.value in unavailableActions);</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-          }   </span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+          }</span>
<a href="#l10.235"></a><span id="l10.235">         ]]&gt;</span>
<a href="#l10.236"></a><span id="l10.236">       &lt;/handler&gt;</span>
<a href="#l10.237"></a><span id="l10.237">     &lt;/handlers&gt;</span>
<a href="#l10.238"></a><span id="l10.238">   &lt;/binding&gt;</span>
<a href="#l10.239"></a><span id="l10.239"> </span>
<a href="#l10.240"></a><span id="l10.240">   &lt;binding id=&quot;ruleaction&quot;&gt;</span>
<a href="#l10.241"></a><span id="l10.241">     &lt;content allowevents=&quot;true&quot;&gt;</span>
<a href="#l10.242"></a><span id="l10.242">       &lt;xul:listcell class=&quot;ruleactiontype&quot;/&gt;</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineat">@@ -218,180 +263,245 @@</span>
<a href="#l10.244"></a><span id="l10.244">       &lt;xul:listcell/&gt;</span>
<a href="#l10.245"></a><span id="l10.245">     &lt;/content&gt;</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247">     &lt;implementation&gt;</span>
<a href="#l10.248"></a><span id="l10.248">       &lt;field name=&quot;mListBox&quot;&gt;this.parentNode&lt;/field&gt;</span>
<a href="#l10.249"></a><span id="l10.249">       &lt;field name=&quot;mRemoveButton&quot;&gt;document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;removeButton&quot;)&lt;/field&gt;</span>
<a href="#l10.250"></a><span id="l10.250">       &lt;field name=&quot;mActionTypeInitialized&quot;&gt;false&lt;/field&gt;</span>
<a href="#l10.251"></a><span id="l10.251">       &lt;field name=&quot;mRuleActionTargetInitialized&quot;&gt;false&lt;/field&gt;</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+      &lt;field name=&quot;mRuleActionType&quot;&gt;document.getAnonymousNodes(this)[0]&lt;/field&gt;</span>
<a href="#l10.253"></a><span id="l10.253"> </span>
<a href="#l10.254"></a><span id="l10.254">       &lt;method name=&quot;clearInitialActionIndex&quot;&gt;</span>
<a href="#l10.255"></a><span id="l10.255">         &lt;body&gt;</span>
<a href="#l10.256"></a><span id="l10.256">           &lt;![CDATA[</span>
<a href="#l10.257"></a><span id="l10.257">             // we should only remove the initialActionIndex after we have been told that</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-            // both the rule action type and the rule action target hvae both been built since they both need </span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+            // both the rule action type and the rule action target have both been built since they both need</span>
<a href="#l10.260"></a><span id="l10.260">             // this piece of information. This complication arises because both of these child elements are getting</span>
<a href="#l10.261"></a><span id="l10.261">             // bound asynchronously after the search row has been constructed</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-            </span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+</span>
<a href="#l10.264"></a><span id="l10.264">             if (this.mActionTypeInitialized &amp;&amp; this.mRuleActionTargetInitialized)</span>
<a href="#l10.265"></a><span id="l10.265">               this.removeAttribute('initialActionIndex');</span>
<a href="#l10.266"></a><span id="l10.266">           ]]&gt;</span>
<a href="#l10.267"></a><span id="l10.267">         &lt;/body&gt;</span>
<a href="#l10.268"></a><span id="l10.268">       &lt;/method&gt;</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270">       &lt;method name=&quot;initWithAction&quot;&gt;</span>
<a href="#l10.271"></a><span id="l10.271">         &lt;parameter name=&quot;aFilterAction&quot;/&gt;</span>
<a href="#l10.272"></a><span id="l10.272">         &lt;body&gt;</span>
<a href="#l10.273"></a><span id="l10.273">           &lt;![CDATA[</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-            var filterActionStr = gFilterActionStrings[aFilterAction.type];</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-            document.getAnonymousNodes(document.getAnonymousNodes(this)[0])[0].value = filterActionStr;</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+            var filterActionStr;</span>
<a href="#l10.277"></a><span id="l10.277">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-            switch (gFilterActionStrings[aFilterAction.type])</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+            var actionItem = document.getAnonymousNodes(actionTarget);</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+            var nsMsgFilterAction = Components.interfaces.nsMsgFilterAction;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+            switch (aFilterAction.type)</span>
<a href="#l10.282"></a><span id="l10.282">             {</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-              case &quot;movemessage&quot;:</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-              case &quot;copymessage&quot;:</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-                SetFolderPickerElement(aFilterAction.targetFolderUri, actionTarget.menulist);</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+              case nsMsgFilterAction.Custom:</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+                filterActionStr = aFilterAction.customId;</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+                if (actionItem)</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+                  actionItem[0].value = aFilterAction.strValue;</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+                // Make sure the custom action has been added. If not, it</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+                // probably was from an extension that has been removed. We'll</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+                // show a dummy menuitem to warn the user.</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+                var needCustomLabel = true;</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+                {</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+                  if (gCustomActions[i].id == filterActionStr)</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+                  {</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+                    needCustomLabel = false;</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+                    break;</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+                  }</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+                }</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+                if (needCustomLabel)</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+                {</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+                  var menuitem = document.createElementNS(</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+                      &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+                      &quot;xul:menuitem&quot;);</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+                  menuitem.setAttribute(&quot;label&quot;,</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+                      gFilterBundle.getString(&quot;filterMissingCustomAction&quot;));</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+                  menuitem.setAttribute(&quot;value&quot;, filterActionStr);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+                  menuitem.disabled = true;</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+                  this.mRuleActionType.menulist.menupopup.appendChild(menuitem);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+                  var consoleService = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+                      .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+                  var scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+                      .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+                  scriptError.init(&quot;Missing custom action &quot; + filterActionStr,</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+                      null, null, 0, 0,</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+                      Components.interfaces.nsIScriptError.errorFlag,</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+                      &quot;component javascript&quot;);</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+                  consoleService.logMessage(scriptError);</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+                }</span>
<a href="#l10.323"></a><span id="l10.323">                 break;</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-              case &quot;replytomessage&quot;:</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-              case &quot;forwardmessage&quot;:</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-                document.getAnonymousNodes(actionTarget)[0].value = aFilterAction.strValue; </span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+              case nsMsgFilterAction.MoveToFolder:</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+              case nsMsgFilterAction.CopyToFolder:</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+                actionItem[0].value = aFilterAction.targetFolderUri;</span>
<a href="#l10.330"></a><span id="l10.330">                 break;</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-              case &quot;labelmessageas&quot;:</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-                document.getAnonymousNodes(actionTarget)[0].value = aFilterAction.label;</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+              case nsMsgFilterAction.Reply:</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+              case nsMsgFilterAction.Forward:</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+                actionItem[0].value = aFilterAction.strValue;</span>
<a href="#l10.336"></a><span id="l10.336">                 break;</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-              case &quot;setpriorityto&quot;:</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-                document.getAnonymousNodes(actionTarget)[0].value = aFilterAction.priority;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+              case nsMsgFilterAction.Label:</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+                actionItem[0].value = aFilterAction.label;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+                break;</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+              case nsMsgFilterAction.ChangePriority:</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+                actionItem[0].value = aFilterAction.priority;</span>
<a href="#l10.344"></a><span id="l10.344">                 break;</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-              case &quot;setjunkscore&quot;:</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-                document.getAnonymousNodes(actionTarget)[0].value = aFilterAction.junkScore;</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+              case nsMsgFilterAction.JunkScore:</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+                actionItem[0].value = aFilterAction.junkScore;</span>
<a href="#l10.349"></a><span id="l10.349">                 break;</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-              case &quot;addtagtomessage&quot;:</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-                document.getAnonymousNodes(actionTarget)[0].value = aFilterAction.strValue;</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+              case nsMsgFilterAction.Tag:</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+                actionItem[0].value = aFilterAction.strValue;</span>
<a href="#l10.354"></a><span id="l10.354">                 break;</span>
<a href="#l10.355"></a><span id="l10.355">               default:</span>
<a href="#l10.356"></a><span id="l10.356">                 break;</span>
<a href="#l10.357"></a><span id="l10.357">             }</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-            this.mRuleActionTargetInitialized = true; </span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+            if (aFilterAction.type != nsMsgFilterAction.Custom)</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+              filterActionStr = gFilterActionStrings[aFilterAction.type];</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+            document.getAnonymousNodes(this.mRuleActionType)[0]</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+                    .value = filterActionStr;</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+            this.mRuleActionTargetInitialized = true;</span>
<a href="#l10.365"></a><span id="l10.365">             this.clearInitialActionIndex();</span>
<a href="#l10.366"></a><span id="l10.366">           ]]&gt;</span>
<a href="#l10.367"></a><span id="l10.367">         &lt;/body&gt;</span>
<a href="#l10.368"></a><span id="l10.368">       &lt;/method&gt;</span>
<a href="#l10.369"></a><span id="l10.369"> </span>
<a href="#l10.370"></a><span id="l10.370">       &lt;method name=&quot;validateAction&quot;&gt;</span>
<a href="#l10.371"></a><span id="l10.371">         &lt;body&gt;</span>
<a href="#l10.372"></a><span id="l10.372">           &lt;![CDATA[</span>
<a href="#l10.373"></a><span id="l10.373">             // returns true if this row represents a valid filter action and false otherwise.</span>
<a href="#l10.374"></a><span id="l10.374">             // This routine also prompts the user.</span>
<a href="#l10.375"></a><span id="l10.375">             var filterActionString = this.getAttribute('value');</span>
<a href="#l10.376"></a><span id="l10.376">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-            var errorString;</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+            var errorString, customError;</span>
<a href="#l10.379"></a><span id="l10.379"> </span>
<a href="#l10.380"></a><span id="l10.380">             switch (filterActionString)</span>
<a href="#l10.381"></a><span id="l10.381">             {</span>
<a href="#l10.382"></a><span id="l10.382">               case &quot;movemessage&quot;:</span>
<a href="#l10.383"></a><span id="l10.383">               case &quot;copymessage&quot;:</span>
<a href="#l10.384"></a><span id="l10.384">                 var msgFolder = actionTarget.uri ? GetMsgFolderFromUri(actionTarget.uri) : null;</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineminus">-                if (!msgFolder || !msgFolder.canFileMessages) </span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+                if (!msgFolder || !msgFolder.canFileMessages)</span>
<a href="#l10.387"></a><span id="l10.387">                   errorString = &quot;mustSelectFolder&quot;;</span>
<a href="#l10.388"></a><span id="l10.388">                 break;</span>
<a href="#l10.389"></a><span id="l10.389">               case &quot;forwardmessage&quot;:</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-                if (document.getAnonymousNodes(actionTarget)[0].value.length &lt; 3 || </span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+                if (document.getAnonymousNodes(actionTarget)[0].value.length &lt; 3 ||</span>
<a href="#l10.392"></a><span id="l10.392">                     document.getAnonymousNodes(actionTarget)[0].value.indexOf('@') &lt; 1)</span>
<a href="#l10.393"></a><span id="l10.393">                   errorString = &quot;enterValidEmailAddress&quot;;</span>
<a href="#l10.394"></a><span id="l10.394">                 break;</span>
<a href="#l10.395"></a><span id="l10.395">               case &quot;replytomessage&quot;:</span>
<a href="#l10.396"></a><span id="l10.396">                 if (!document.getAnonymousNodes(actionTarget)[0].selectedItem)</span>
<a href="#l10.397"></a><span id="l10.397">                    errorString = &quot;pickTemplateToReplyWith&quot;;</span>
<a href="#l10.398"></a><span id="l10.398">                 break;</span>
<a href="#l10.399"></a><span id="l10.399">               default:</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+                // some custom actions have no action value node</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+                if (!document.getAnonymousNodes(actionTarget))</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+                  return true;</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+                // locate the correct custom action, and check validity</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+                  if (gCustomActions[i].id == filterActionString)</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+                  {</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+                    customError = </span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+                        gCustomActions[i].validateActionValue(</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+                          document.getAnonymousNodes(actionTarget)[0].value,</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+                          gFilterList.folder, gFilterType);</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+                    break;</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+                  }</span>
<a href="#l10.413"></a><span id="l10.413">                 break;</span>
<a href="#l10.414"></a><span id="l10.414">             }</span>
<a href="#l10.415"></a><span id="l10.415"> </span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-            if (errorString &amp;&amp; gPromptService)</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-              gPromptService.alert(window, null, gFilterBundle.getString(errorString));</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-              </span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-            return !errorString;              </span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+            if (gPromptService)</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+            {</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+              errorString = errorString ?</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+                              gFilterBundle.getString(errorString) :</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+                              customError;</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+              if (errorString)</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+                gPromptService.alert(window, null, errorString);</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+            }</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+            return !errorString;</span>
<a href="#l10.430"></a><span id="l10.430">           ]]&gt;</span>
<a href="#l10.431"></a><span id="l10.431">         &lt;/body&gt;</span>
<a href="#l10.432"></a><span id="l10.432">       &lt;/method&gt;</span>
<a href="#l10.433"></a><span id="l10.433"> </span>
<a href="#l10.434"></a><span id="l10.434">       &lt;method name=&quot;saveToFilter&quot;&gt;</span>
<a href="#l10.435"></a><span id="l10.435">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l10.436"></a><span id="l10.436">         &lt;body&gt;</span>
<a href="#l10.437"></a><span id="l10.437">           &lt;![CDATA[</span>
<a href="#l10.438"></a><span id="l10.438">             // create a new filter action, fill it in, and then append it to the filter</span>
<a href="#l10.439"></a><span id="l10.439">             var filterAction = aFilter.createAction();</span>
<a href="#l10.440"></a><span id="l10.440">             var filterActionString = this.getAttribute('value');</span>
<a href="#l10.441"></a><span id="l10.441">             filterAction.type = gFilterActionStrings.indexOf(filterActionString);</span>
<a href="#l10.442"></a><span id="l10.442">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-            switch (filterActionString)</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+            var actionItem = document.getAnonymousNodes(actionTarget);</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+            var nsMsgFilterAction = Components.interfaces.nsMsgFilterAction;</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+            switch (filterAction.type)</span>
<a href="#l10.448"></a><span id="l10.448">             {</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-              case &quot;labelmessageas&quot;:              </span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-                filterAction.label = document.getAnonymousNodes(actionTarget)[0].getAttribute(&quot;value&quot;);</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+              case nsMsgFilterAction.Label:</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+                filterAction.label = actionItem[0].getAttribute(&quot;value&quot;);</span>
<a href="#l10.453"></a><span id="l10.453">                 break;</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-              case &quot;setpriorityto&quot;:</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-                filterAction.priority = document.getAnonymousNodes(actionTarget)[0].getAttribute(&quot;value&quot;);   </span>
<a href="#l10.456"></a><span id="l10.456" class="difflineplus">+              case nsMsgFilterAction.ChangePriority:</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineplus">+                filterAction.priority = actionItem[0].getAttribute(&quot;value&quot;);</span>
<a href="#l10.458"></a><span id="l10.458">                 break;</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineminus">-              case &quot;movemessage&quot;:</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-              case &quot;copymessage&quot;:</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineplus">+              case nsMsgFilterAction.MoveToFolder:</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+              case nsMsgFilterAction.CopyToFolder:</span>
<a href="#l10.463"></a><span id="l10.463">                 filterAction.targetFolderUri = actionTarget.uri;</span>
<a href="#l10.464"></a><span id="l10.464">                 break;</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-              case &quot;setjunkscore&quot;:</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-                filterAction.junkScore = document.getAnonymousNodes(actionTarget)[0].value;    </span>
<a href="#l10.467"></a><span id="l10.467" class="difflineplus">+              case nsMsgFilterAction.JunkScore:</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+                filterAction.junkScore = actionItem[0].value;</span>
<a href="#l10.469"></a><span id="l10.469">                 break;</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-              case &quot;addtagtomessage&quot;:</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-              case &quot;replytomessage&quot;:</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-              case &quot;forwardmessage&quot;:</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineminus">-                filterAction.strValue = document.getAnonymousNodes(actionTarget)[0].value; </span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+              case nsMsgFilterAction.Custom:</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+                filterAction.customId = filterActionString;</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+                // fall through to set the value</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+              default:</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+                if (actionItem)</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+                  filterAction.strValue = actionItem[0].value;</span>
<a href="#l10.480"></a><span id="l10.480">                 break;</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-              default:</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-                break;</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-            }</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+              }</span>
<a href="#l10.485"></a><span id="l10.485">             aFilter.appendAction(filterAction);</span>
<a href="#l10.486"></a><span id="l10.486">           ]]&gt;</span>
<a href="#l10.487"></a><span id="l10.487">         &lt;/body&gt;</span>
<a href="#l10.488"></a><span id="l10.488">       &lt;/method&gt;</span>
<a href="#l10.489"></a><span id="l10.489"> </span>
<a href="#l10.490"></a><span id="l10.490">       &lt;method name=&quot;addRow&quot;&gt;</span>
<a href="#l10.491"></a><span id="l10.491">         &lt;body&gt;</span>
<a href="#l10.492"></a><span id="l10.492">           &lt;![CDATA[</span>
<a href="#l10.493"></a><span id="l10.493">             if (this.mListBox.getRowCount() &lt; document.getAnonymousNodes(this)[0].numVisibleActions())</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-            {             </span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+            {</span>
<a href="#l10.496"></a><span id="l10.496">               var listItem = document.createElement('listitem');</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-              listItem.className = 'ruleaction';             </span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+              listItem.className = 'ruleaction';</span>
<a href="#l10.499"></a><span id="l10.499">               this.mListBox.insertBefore(listItem, this.nextSibling);</span>
<a href="#l10.500"></a><span id="l10.500">               this.mListBox.ensureElementIsVisible(listItem);</span>
<a href="#l10.501"></a><span id="l10.501"> </span>
<a href="#l10.502"></a><span id="l10.502">               // make sure the first remove button is enabled</span>
<a href="#l10.503"></a><span id="l10.503">               this.mListBox.getItemAtIndex(0).mRemoveButton.disabled = false;</span>
<a href="#l10.504"></a><span id="l10.504">             }</span>
<a href="#l10.505"></a><span id="l10.505">           ]]&gt;</span>
<a href="#l10.506"></a><span id="l10.506">         &lt;/body&gt;</span>
<a href="#l10.507"></a><span id="l10.507">       &lt;/method&gt;</span>
<a href="#l10.508"></a><span id="l10.508"> </span>
<a href="#l10.509"></a><span id="l10.509">       &lt;method name=&quot;removeRow&quot;&gt;</span>
<a href="#l10.510"></a><span id="l10.510">         &lt;body&gt;</span>
<a href="#l10.511"></a><span id="l10.511">           &lt;![CDATA[</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-            if (this.mListBox.getRowCount() &gt; 1)</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-              this.mListBox.removeChild(this);</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineplus">+            // this.mListBox will fail after the row is removed, so save</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+            var listBox = this.mListBox;</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+            if (listBox.getRowCount() &gt; 1)</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+              listBox.removeChild(this);</span>
<a href="#l10.518"></a><span id="l10.518">             // if we only have one row left, then disable the remove button for that row</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-            this.mListBox.getItemAtIndex(0).mRemoveButton.disabled = this.mListBox.getRowCount() == 1;</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+            listBox.getItemAtIndex(0).mRemoveButton.disabled = listBox.getRowCount() == 1;</span>
<a href="#l10.521"></a><span id="l10.521">           ]]&gt;</span>
<a href="#l10.522"></a><span id="l10.522">         &lt;/body&gt;</span>
<a href="#l10.523"></a><span id="l10.523">       &lt;/method&gt;</span>
<a href="#l10.524"></a><span id="l10.524">     &lt;/implementation&gt;</span>
<a href="#l10.525"></a><span id="l10.525">   &lt;/binding&gt;</span>
<a href="#l10.526"></a><span id="l10.526"> </span>
<a href="#l10.527"></a><span id="l10.527">   &lt;binding id=&quot;ruleactiontarget-base&quot;&gt;</span>
<a href="#l10.528"></a><span id="l10.528">     &lt;implementation&gt;</span>
<a href="#l10.529"></a><span id="l10.529">       &lt;constructor&gt;</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineminus">-        &lt;![CDATA[                    </span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l10.532"></a><span id="l10.532">           if (this.parentNode.hasAttribute('initialActionIndex'))</span>
<a href="#l10.533"></a><span id="l10.533">           {</span>
<a href="#l10.534"></a><span id="l10.534">             var actionIndex = this.parentNode.getAttribute('initialActionIndex');</span>
<a href="#l10.535"></a><span id="l10.535">             var filterAction = gFilter.actionList.QueryElementAt(actionIndex, Components.interfaces.nsIMsgRuleAction);</span>
<a href="#l10.536"></a><span id="l10.536">             this.parentNode.initWithAction(filterAction);</span>
<a href="#l10.537"></a><span id="l10.537">           }</span>
<a href="#l10.538"></a><span id="l10.538">         ]]&gt;</span>
<a href="#l10.539"></a><span id="l10.539">       &lt;/constructor&gt;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineat">@@ -406,17 +516,17 @@</span>
<a href="#l10.541"></a><span id="l10.541">       &lt;/xul:menulist&gt;</span>
<a href="#l10.542"></a><span id="l10.542">     &lt;/content&gt;</span>
<a href="#l10.543"></a><span id="l10.543"> </span>
<a href="#l10.544"></a><span id="l10.544">     &lt;implementation&gt;</span>
<a href="#l10.545"></a><span id="l10.545">       &lt;constructor&gt;</span>
<a href="#l10.546"></a><span id="l10.546">         &lt;![CDATA[</span>
<a href="#l10.547"></a><span id="l10.547">             var menuPopup = document.getAnonymousNodes(this)[0].menupopup;</span>
<a href="#l10.548"></a><span id="l10.548">             var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-                                       .getService(Components.interfaces.nsIMsgTagService); </span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+                                       .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l10.551"></a><span id="l10.551">             var tagArray = tagService.getAllTags({});</span>
<a href="#l10.552"></a><span id="l10.552">             for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l10.553"></a><span id="l10.553">             {</span>
<a href="#l10.554"></a><span id="l10.554">               var taginfo = tagArray[i];</span>
<a href="#l10.555"></a><span id="l10.555">               var newMenuItem = document.createElement('menuitem');</span>
<a href="#l10.556"></a><span id="l10.556">               newMenuItem.setAttribute('label', taginfo.tag);</span>
<a href="#l10.557"></a><span id="l10.557">               newMenuItem.setAttribute('value', taginfo.key);</span>
<a href="#l10.558"></a><span id="l10.558">               menuPopup.appendChild(newMenuItem);</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineat">@@ -486,39 +596,49 @@</span>
<a href="#l10.560"></a><span id="l10.560">                 if (header instanceof Components.interfaces.nsIMsgDBHdr)</span>
<a href="#l10.561"></a><span id="l10.561">                 {</span>
<a href="#l10.562"></a><span id="l10.562">                   var msgTemplateUri = msgFolder.URI + &quot;?messageId=&quot; + header.messageId + '&amp;subject=' + header.mime2DecodedSubject;</span>
<a href="#l10.563"></a><span id="l10.563">                   var newItem = document.getAnonymousNodes(this)[0].appendItem(header.mime2DecodedSubject, msgTemplateUri);</span>
<a href="#l10.564"></a><span id="l10.564">                 }</span>
<a href="#l10.565"></a><span id="l10.565">               }</span>
<a href="#l10.566"></a><span id="l10.566">             }</span>
<a href="#l10.567"></a><span id="l10.567">         ]]&gt;</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-      &lt;/constructor&gt;      </span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l10.570"></a><span id="l10.570">     &lt;/implementation&gt;</span>
<a href="#l10.571"></a><span id="l10.571">   &lt;/binding&gt;</span>
<a href="#l10.572"></a><span id="l10.572"> </span>
<a href="#l10.573"></a><span id="l10.573">   &lt;binding id=&quot;ruleactiontarget-forwardto&quot; extends=&quot;chrome://messenger/content/searchWidgets.xml#ruleactiontarget-base&quot;&gt;</span>
<a href="#l10.574"></a><span id="l10.574">     &lt;content&gt;</span>
<a href="#l10.575"></a><span id="l10.575">       &lt;xul:textbox class=&quot;ruleactionitem&quot;/&gt;</span>
<a href="#l10.576"></a><span id="l10.576">     &lt;/content&gt;</span>
<a href="#l10.577"></a><span id="l10.577">   &lt;/binding&gt;</span>
<a href="#l10.578"></a><span id="l10.578"> </span>
<a href="#l10.579"></a><span id="l10.579">   &lt;binding id=&quot;ruleactiontarget-folder&quot; extends=&quot;chrome://messenger/content/searchWidgets.xml#ruleactiontarget-base&quot;&gt;</span>
<a href="#l10.580"></a><span id="l10.580">     &lt;content&gt;</span>
<a href="#l10.581"></a><span id="l10.581">       &lt;xul:menulist class=&quot;ruleactionitem&quot;&gt;</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-        &lt;xul:menupopup class=&quot;folderTargetPopup&quot; oncommand=&quot;SetFolderPickerElement(this.getAttribute('uri'), this.parentNode);&quot;/&gt;</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+        &lt;xul:menupopup class=&quot;folderTargetPopup&quot;</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+                       oncommand=&quot;SetFolderPickerElement(</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+                                    this.getAttribute('uri'), this.parentNode);</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+                                  this.parentNode.setAttribute(</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+                                    'value', this.getAttribute('uri'));&quot;/&gt;</span>
<a href="#l10.588"></a><span id="l10.588">       &lt;/xul:menulist&gt;</span>
<a href="#l10.589"></a><span id="l10.589">     &lt;/content&gt;</span>
<a href="#l10.590"></a><span id="l10.590"> </span>
<a href="#l10.591"></a><span id="l10.591">     &lt;implementation&gt;</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-      </span>
<a href="#l10.593"></a><span id="l10.593" class="difflineplus">+</span>
<a href="#l10.594"></a><span id="l10.594">       &lt;constructor&gt;</span>
<a href="#l10.595"></a><span id="l10.595">         &lt;![CDATA[</span>
<a href="#l10.596"></a><span id="l10.596">           if (!this.uri)</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-            SetFolderPickerElement(this.menulist.firstChild.tree.builderView.getResourceAtIndex(0).Value, this.menulist);</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+          {</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+            if (!this.menulist.value)</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+              this.menulist.value = this.menulist.firstChild.tree.builderView</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineplus">+                                        .getResourceAtIndex(0).Value;</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+            SetFolderPickerElement(this.menulist.value, this.menulist);</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineplus">+          }</span>
<a href="#l10.604"></a><span id="l10.604">         ]]&gt;</span>
<a href="#l10.605"></a><span id="l10.605">       &lt;/constructor&gt;</span>
<a href="#l10.606"></a><span id="l10.606"> </span>
<a href="#l10.607"></a><span id="l10.607">       &lt;property name=&quot;uri&quot; readonly=&quot;true&quot; onget=&quot;return document.getAnonymousNodes(this)[0].getAttribute('uri');&quot;/&gt;</span>
<a href="#l10.608"></a><span id="l10.608">       &lt;field name=&quot;menulist&quot;&gt;document.getAnonymousNodes(this)[0]&lt;/field&gt;</span>
<a href="#l10.609"></a><span id="l10.609">     &lt;/implementation&gt;</span>
<a href="#l10.610"></a><span id="l10.610">   &lt;/binding&gt;</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+</span>
<a href="#l10.612"></a><span id="l10.612"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -54,16 +54,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsMsgSearchValue.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsDateTimeFormatCID.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;prmem.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> static const char *kImapPrefix = &quot;//imap:&quot;;</span>
<a href="#l11.16"></a><span id="l11.16"> static const char *kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> nsMsgRuleAction::nsMsgRuleAction()</span>
<a href="#l11.19"></a><span id="l11.19"> {</span>
<a href="#l11.20"></a><span id="l11.20"> }</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -159,16 +160,54 @@ nsMsgRuleAction::SetStrValue(const nsACS</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> NS_IMETHODIMP</span>
<a href="#l11.24"></a><span id="l11.24"> nsMsgRuleAction::GetStrValue(nsACString &amp;aStrValue)</span>
<a href="#l11.25"></a><span id="l11.25"> {</span>
<a href="#l11.26"></a><span id="l11.26">   aStrValue = m_strValue;</span>
<a href="#l11.27"></a><span id="l11.27">   return NS_OK;</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+/* attribute ACString customId; */</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::GetCustomId(nsACString &amp; aCustomId)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+{</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  aCustomId = m_customId;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+}</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::SetCustomId(const nsACString &amp; aCustomId)</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+{</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  m_customId = aCustomId;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+}</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+// this can only be called after the customId is set</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::GetCustomAction(nsIMsgFilterCustomAction **aCustomAction)</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+{</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCustomAction);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  if (!m_customAction)</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+    if (m_customId.IsEmpty())</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+      NS_ERROR(&quot;Need to set CustomId&quot;);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    }</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    nsresult rv;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+    rv = filterService-&gt;GetCustomAction(m_customId, getter_AddRefs(m_customAction));</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  }</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  // found the correct custom action</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  NS_ADDREF(*aCustomAction = m_customAction);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+}</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+</span>
<a href="#l11.68"></a><span id="l11.68"> nsMsgFilter::nsMsgFilter():</span>
<a href="#l11.69"></a><span id="l11.69">     m_temporary(PR_FALSE),</span>
<a href="#l11.70"></a><span id="l11.70">     m_unparseable(PR_FALSE),</span>
<a href="#l11.71"></a><span id="l11.71">     m_filterList(nsnull),</span>
<a href="#l11.72"></a><span id="l11.72">     m_expressionTree(nsnull)</span>
<a href="#l11.73"></a><span id="l11.73"> {</span>
<a href="#l11.74"></a><span id="l11.74">   NS_NewISupportsArray(getter_AddRefs(m_termList));</span>
<a href="#l11.75"></a><span id="l11.75">   NS_NewISupportsArray(getter_AddRefs(m_actionList));</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineat">@@ -533,16 +572,29 @@ NS_IMETHODIMP nsMsgFilter::LogRuleHit(ns</span>
<a href="#l11.77"></a><span id="l11.77">           NS_LITERAL_STRING(&quot;logMoveStr&quot;).get() :</span>
<a href="#l11.78"></a><span id="l11.78">           NS_LITERAL_STRING(&quot;logCopyStr&quot;).get(),</span>
<a href="#l11.79"></a><span id="l11.79">         logMoveFormatStrings, 2,</span>
<a href="#l11.80"></a><span id="l11.80">         getter_Copies(logMoveStr));</span>
<a href="#l11.81"></a><span id="l11.81">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">       buffer += NS_ConvertUTF16toUTF8(logMoveStr);</span>
<a href="#l11.84"></a><span id="l11.84">     }</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+    else if (actionType == nsMsgFilterAction::Custom)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+    {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+      nsAutoString filterActionName;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+      rv = aFilterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; customAction)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+        customAction-&gt;GetName(filterActionName);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+      if (filterActionName.IsEmpty())</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+        bundle-&gt;GetStringFromName(</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+                  NS_LITERAL_STRING(&quot;filterMissingCustomAction&quot;).get(),</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+                  getter_Copies(filterActionName));</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+      buffer += NS_ConvertUTF16toUTF8(filterActionName);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+    }</span>
<a href="#l11.98"></a><span id="l11.98">     else</span>
<a href="#l11.99"></a><span id="l11.99">     {</span>
<a href="#l11.100"></a><span id="l11.100">       nsString actionValue;</span>
<a href="#l11.101"></a><span id="l11.101">       nsAutoString filterActionID;</span>
<a href="#l11.102"></a><span id="l11.102">       filterActionID = NS_LITERAL_STRING(&quot;filterAction&quot;);</span>
<a href="#l11.103"></a><span id="l11.103">       filterActionID.AppendInt(actionType);</span>
<a href="#l11.104"></a><span id="l11.104">       rv = bundle-&gt;GetStringFromName(filterActionID.get(), getter_Copies(actionValue));</span>
<a href="#l11.105"></a><span id="l11.105">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineat">@@ -803,16 +855,30 @@ nsresult nsMsgFilter::SaveRule(nsIOutput</span>
<a href="#l11.107"></a><span id="l11.107">       case nsMsgFilterAction::Forward:</span>
<a href="#l11.108"></a><span id="l11.108">       {</span>
<a href="#l11.109"></a><span id="l11.109">         nsCString strValue;</span>
<a href="#l11.110"></a><span id="l11.110">         action-&gt;GetStrValue(strValue);</span>
<a href="#l11.111"></a><span id="l11.111">         // strValue is e-mail address</span>
<a href="#l11.112"></a><span id="l11.112">         err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue, strValue.get(), aStream);</span>
<a href="#l11.113"></a><span id="l11.113">       }</span>
<a href="#l11.114"></a><span id="l11.114">       break;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+      case nsMsgFilterAction::Custom:</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+      {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+        nsCAutoString id;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+        action-&gt;GetCustomId(id);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribCustomId, id.get(), aStream);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+        nsCAutoString strValue;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+        action-&gt;GetStrValue(strValue);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+        if (strValue.Length())</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+          err = filterList-&gt;WriteWstrAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+                                          NS_ConvertUTF8toUTF16(strValue).get(),</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+                                          aStream);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      }</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+      break;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+</span>
<a href="#l11.129"></a><span id="l11.129">       default:</span>
<a href="#l11.130"></a><span id="l11.130">         break;</span>
<a href="#l11.131"></a><span id="l11.131">     }</span>
<a href="#l11.132"></a><span id="l11.132">   }</span>
<a href="#l11.133"></a><span id="l11.133">   // and here the fun begins - file out term list...</span>
<a href="#l11.134"></a><span id="l11.134">   PRUint32 searchIndex;</span>
<a href="#l11.135"></a><span id="l11.135">   nsCAutoString  condition;</span>
<a href="#l11.136"></a><span id="l11.136">   PRUint32 count;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineat">@@ -882,16 +948,17 @@ static struct RuleActionsTableEntry rule</span>
<a href="#l11.138"></a><span id="l11.138">   { nsMsgFilterAction::Reply,                   &quot;Reply&quot;},</span>
<a href="#l11.139"></a><span id="l11.139">   { nsMsgFilterAction::Forward,                 &quot;Forward&quot;},</span>
<a href="#l11.140"></a><span id="l11.140">   { nsMsgFilterAction::StopExecution,           &quot;Stop execution&quot;},</span>
<a href="#l11.141"></a><span id="l11.141">   { nsMsgFilterAction::DeleteFromPop3Server,    &quot;Delete from Pop3 server&quot;},</span>
<a href="#l11.142"></a><span id="l11.142">   { nsMsgFilterAction::LeaveOnPop3Server,       &quot;Leave on Pop3 server&quot;},</span>
<a href="#l11.143"></a><span id="l11.143">   { nsMsgFilterAction::JunkScore,               &quot;JunkScore&quot;},</span>
<a href="#l11.144"></a><span id="l11.144">   { nsMsgFilterAction::FetchBodyFromPop3Server, &quot;Fetch body from Pop3Server&quot;},</span>
<a href="#l11.145"></a><span id="l11.145">   { nsMsgFilterAction::AddTag,                  &quot;AddTag&quot;},</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  { nsMsgFilterAction::Custom,                  &quot;Custom&quot;},</span>
<a href="#l11.147"></a><span id="l11.147"> };</span>
<a href="#l11.148"></a><span id="l11.148"> </span>
<a href="#l11.149"></a><span id="l11.149"> const char *nsMsgFilter::GetActionStr(nsMsgRuleActionType action)</span>
<a href="#l11.150"></a><span id="l11.150"> {</span>
<a href="#l11.151"></a><span id="l11.151">   int  numActions = sizeof(ruleActionsTable) / sizeof(ruleActionsTable[0]);</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153">   for (int i = 0; i &lt; numActions; i++)</span>
<a href="#l11.154"></a><span id="l11.154">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -42,16 +42,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nscore.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsISupports.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsMsgSearchArray.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsMsgSearchBoolExpression.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIDateTimeFormat.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> class nsMsgRuleAction : public nsIMsgRuleAction</span>
<a href="#l12.15"></a><span id="l12.15"> {</span>
<a href="#l12.16"></a><span id="l12.16"> public:</span>
<a href="#l12.17"></a><span id="l12.17">   NS_DECL_ISUPPORTS</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   nsMsgRuleAction();</span>
<a href="#l12.20"></a><span id="l12.20">   virtual ~nsMsgRuleAction();</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -62,16 +63,18 @@ private:</span>
<a href="#l12.22"></a><span id="l12.22">     nsMsgRuleActionType      m_type;</span>
<a href="#l12.23"></a><span id="l12.23">     // this used to be a union - why bother?</span>
<a href="#l12.24"></a><span id="l12.24">     nsMsgPriorityValue  m_priority;  /* priority to set rule to */</span>
<a href="#l12.25"></a><span id="l12.25">     nsMsgLabelValue         m_label;  /* label to set rule to */</span>
<a href="#l12.26"></a><span id="l12.26">     nsCString    m_folderUri;</span>
<a href="#l12.27"></a><span id="l12.27">     PRInt32             m_junkScore;  /* junk score (or arbitrary int value?) */</span>
<a href="#l12.28"></a><span id="l12.28">     // arbitrary string value. Currently, email address to forward to</span>
<a href="#l12.29"></a><span id="l12.29">     nsCString           m_strValue;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    nsCString           m_customId;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; m_customAction;</span>
<a href="#l12.32"></a><span id="l12.32"> } ;</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35"> class nsMsgFilter : public nsIMsgFilter</span>
<a href="#l12.36"></a><span id="l12.36"> {</span>
<a href="#l12.37"></a><span id="l12.37"> public:</span>
<a href="#l12.38"></a><span id="l12.38">   NS_DECL_ISUPPORTS</span>
<a href="#l12.39"></a><span id="l12.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -407,17 +407,18 @@ static FilterFileAttribEntry FilterFileA</span>
<a href="#l13.4"></a><span id="l13.4">   {nsIMsgFilterList::attribLogging,    &quot;logging&quot;},</span>
<a href="#l13.5"></a><span id="l13.5">   {nsIMsgFilterList::attribName,      &quot;name&quot;},</span>
<a href="#l13.6"></a><span id="l13.6">   {nsIMsgFilterList::attribEnabled,    &quot;enabled&quot;},</span>
<a href="#l13.7"></a><span id="l13.7">   {nsIMsgFilterList::attribDescription,  &quot;description&quot;},</span>
<a href="#l13.8"></a><span id="l13.8">   {nsIMsgFilterList::attribType,      &quot;type&quot;},</span>
<a href="#l13.9"></a><span id="l13.9">   {nsIMsgFilterList::attribScriptFile,  &quot;scriptName&quot;},</span>
<a href="#l13.10"></a><span id="l13.10">   {nsIMsgFilterList::attribAction,    &quot;action&quot;},</span>
<a href="#l13.11"></a><span id="l13.11">   {nsIMsgFilterList::attribActionValue,  &quot;actionValue&quot;},</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  {nsIMsgFilterList::attribCondition,    &quot;condition&quot;}</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  {nsIMsgFilterList::attribCondition,    &quot;condition&quot;},</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  {nsIMsgFilterList::attribCustomId,  &quot;customId&quot;},</span>
<a href="#l13.15"></a><span id="l13.15"> };</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> // If we want to buffer file IO, wrap it in here.</span>
<a href="#l13.18"></a><span id="l13.18"> char nsMsgFilterList::ReadChar(nsIInputStream *aStream)</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20">   char  newChar;</span>
<a href="#l13.21"></a><span id="l13.21">   PRUint32 bytesRead;</span>
<a href="#l13.22"></a><span id="l13.22">   nsresult rv = aStream-&gt;Read(&amp;newChar, 1, &amp;bytesRead);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineat">@@ -711,18 +712,20 @@ nsresult nsMsgFilterList::LoadTextFilter</span>
<a href="#l13.24"></a><span id="l13.24">           PRInt32 junkScore = value.ToInteger(&amp;res, 10);</span>
<a href="#l13.25"></a><span id="l13.25"> #ifdef MOZILLA_INTERNAL_API</span>
<a href="#l13.26"></a><span id="l13.26">           if (!res)</span>
<a href="#l13.27"></a><span id="l13.27"> #else</span>
<a href="#l13.28"></a><span id="l13.28">           if (NS_FAILED(res))</span>
<a href="#l13.29"></a><span id="l13.29"> #endif</span>
<a href="#l13.30"></a><span id="l13.30">             currentFilterAction-&gt;SetJunkScore(junkScore);</span>
<a href="#l13.31"></a><span id="l13.31">         }</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        else if (type == nsMsgFilterAction::Forward || type == nsMsgFilterAction::Reply</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-          || type == nsMsgFilterAction::AddTag)</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        else if (type == nsMsgFilterAction::Forward ||</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+                 type == nsMsgFilterAction::Reply ||</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+                 type == nsMsgFilterAction::AddTag ||</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                 type == nsMsgFilterAction::Custom)</span>
<a href="#l13.38"></a><span id="l13.38">         {</span>
<a href="#l13.39"></a><span id="l13.39">           currentFilterAction-&gt;SetStrValue(value);</span>
<a href="#l13.40"></a><span id="l13.40">         }</span>
<a href="#l13.41"></a><span id="l13.41">       }</span>
<a href="#l13.42"></a><span id="l13.42">       break;</span>
<a href="#l13.43"></a><span id="l13.43">     case nsIMsgFilterList::attribCondition:</span>
<a href="#l13.44"></a><span id="l13.44">       if (m_curFilter)</span>
<a href="#l13.45"></a><span id="l13.45">       {</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineat">@@ -739,16 +742,24 @@ nsresult nsMsgFilterList::LoadTextFilter</span>
<a href="#l13.47"></a><span id="l13.47">           nsMemory::Free(utf8);</span>
<a href="#l13.48"></a><span id="l13.48">         }</span>
<a href="#l13.49"></a><span id="l13.49">         err = ParseCondition(m_curFilter, value.get());</span>
<a href="#l13.50"></a><span id="l13.50">         if (err == NS_ERROR_INVALID_ARG)</span>
<a href="#l13.51"></a><span id="l13.51">           err = m_curFilter-&gt;SetUnparseable(PR_TRUE);</span>
<a href="#l13.52"></a><span id="l13.52">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l13.53"></a><span id="l13.53">       }</span>
<a href="#l13.54"></a><span id="l13.54">       break;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    case nsIMsgFilterList::attribCustomId:</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      if (m_curFilter &amp;&amp; currentFilterAction)</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+      {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+        err = currentFilterAction-&gt;SetCustomId(value);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+        NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      }</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      break;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+</span>
<a href="#l13.63"></a><span id="l13.63">     }</span>
<a href="#l13.64"></a><span id="l13.64">   } while (NS_SUCCEEDED(aStream-&gt;Available(&amp;bytesAvailable)));</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   if (m_curFilter)</span>
<a href="#l13.67"></a><span id="l13.67">   {</span>
<a href="#l13.68"></a><span id="l13.68">     PRBool unparseableFilter;</span>
<a href="#l13.69"></a><span id="l13.69">     m_curFilter-&gt;GetUnparseable(&amp;unparseableFilter);</span>
<a href="#l13.70"></a><span id="l13.70">     if (unparseableFilter)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -66,16 +66,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+#include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> NS_IMPL_ISUPPORTS1(nsMsgFilterService, nsIMsgFilterService)</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> nsMsgFilterService::nsMsgFilterService()</span>
<a href="#l14.18"></a><span id="l14.18"> {</span>
<a href="#l14.19"></a><span id="l14.19"> }</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> nsMsgFilterService::~nsMsgFilterService()</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -747,16 +749,34 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">       case nsMsgFilterAction::StopExecution:</span>
<a href="#l14.25"></a><span id="l14.25">       {</span>
<a href="#l14.26"></a><span id="l14.26">         // don't apply any more filters</span>
<a href="#l14.27"></a><span id="l14.27">         *aApplyMore = PR_FALSE;</span>
<a href="#l14.28"></a><span id="l14.28">       }</span>
<a href="#l14.29"></a><span id="l14.29">       break;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+      case nsMsgFilterAction::Custom:</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+        nsCAutoString value;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+        filterAction-&gt;GetStrValue(value);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+        customAction-&gt;Apply(m_searchHitHdrs, value, this,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+                            nsMsgFilterType::Manual, m_msgWindow);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+        PRBool isAsync = PR_FALSE;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+        customAction-&gt;GetIsAsync(&amp;isAsync);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+        if (isAsync)</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+          return NS_OK;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+      }</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+      break;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+</span>
<a href="#l14.49"></a><span id="l14.49">       default:</span>
<a href="#l14.50"></a><span id="l14.50">         break;</span>
<a href="#l14.51"></a><span id="l14.51">       }</span>
<a href="#l14.52"></a><span id="l14.52">     }</span>
<a href="#l14.53"></a><span id="l14.53">   }</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55">   if (*aApplyMore)</span>
<a href="#l14.56"></a><span id="l14.56">     rv = RunNextFilter();</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineat">@@ -779,16 +799,45 @@ NS_IMETHODIMP nsMsgFilterService::ApplyF</span>
<a href="#l14.58"></a><span id="l14.58"> {</span>
<a href="#l14.59"></a><span id="l14.59">   nsMsgFilterAfterTheFact *filterExecutor = new nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolders);</span>
<a href="#l14.60"></a><span id="l14.60">   if (filterExecutor)</span>
<a href="#l14.61"></a><span id="l14.61">     return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l14.62"></a><span id="l14.62">   else</span>
<a href="#l14.63"></a><span id="l14.63">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.64"></a><span id="l14.64"> }</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::AddCustomAction(nsIMsgFilterCustomAction *aAction)</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+{</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  mCustomActions.AppendObject(aAction);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+}</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::GetCustomActions(nsISimpleEnumerator** aResult)</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+{</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mCustomActions);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+}</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+NS_IMETHODIMP </span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+nsMsgFilterService::GetCustomAction(const nsACString &amp; aId,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+                                    nsIMsgFilterCustomAction** aResult)</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+{</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  for (PRInt32 i = 0; i &lt; mCustomActions.Count(); i++)</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    nsCAutoString id;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    nsresult rv = mCustomActions[i]-&gt;GetId(id);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aId.Equals(id))</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+      NS_ADDREF(*aResult = mCustomActions[i]);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+      return NS_OK;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    }</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  }</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  aResult = nsnull;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+}</span>
<a href="#l14.95"></a><span id="l14.95"> </span>
<a href="#l14.96"></a><span id="l14.96"> // nsMsgApplyFiltersToMessages overrides nsMsgFilterAfterTheFact in order to</span>
<a href="#l14.97"></a><span id="l14.97"> // apply filters to a list of messages, rather than an entire folder</span>
<a href="#l14.98"></a><span id="l14.98"> class nsMsgApplyFiltersToMessages : public nsMsgFilterAfterTheFact</span>
<a href="#l14.99"></a><span id="l14.99"> {</span>
<a href="#l14.100"></a><span id="l14.100"> public:</span>
<a href="#l14.101"></a><span id="l14.101">   nsMsgApplyFiltersToMessages(nsIMsgWindow *aMsgWindow, nsIMsgFilterList *aFilterList, nsISupportsArray *aFolderList, nsIArray *aMsgHdrList, nsMsgFilterTypeType aFilterType);</span>
<a href="#l14.102"></a><span id="l14.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -34,16 +34,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.5"></a><span id="l15.5">  *</span>
<a href="#l15.6"></a><span id="l15.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> #ifndef _nsMsgFilterService_H_</span>
<a href="#l15.9"></a><span id="l15.9"> #define _nsMsgFilterService_H_</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> class nsIMsgWindow;</span>
<a href="#l15.15"></a><span id="l15.15"> class nsIStringBundle;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19"> // The filter service is used to acquire and manipulate filter lists.</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -61,12 +62,15 @@ public:</span>
<a href="#l15.22"></a><span id="l15.22">    with dialog boxes. To apply the new list call MSG_CloseFilterList.</span>
<a href="#l15.23"></a><span id="l15.23"> */</span>
<a href="#l15.24"></a><span id="l15.24">   nsresult BackUpFilterFile(nsILocalFile *aFilterFile, nsIMsgWindow *aMsgWindow);</span>
<a href="#l15.25"></a><span id="l15.25">   nsresult AlertBackingUpFilterFile(nsIMsgWindow *aMsgWindow);</span>
<a href="#l15.26"></a><span id="l15.26">   nsresult ThrowAlertMsg(const char*aMsgName, nsIMsgWindow *aMsgWindow);</span>
<a href="#l15.27"></a><span id="l15.27">   nsresult GetStringFromBundle(const char *aMsgName, PRUnichar **aResult);</span>
<a href="#l15.28"></a><span id="l15.28">   nsresult GetFilterStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+protected:</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  nsCOMArray&lt;nsIMsgFilterCustomAction&gt; mCustomActions; // defined custom action list</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33"> };</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35"> #endif  // _nsMsgFilterService_H_</span>
<a href="#l15.36"></a><span id="l15.36"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -119,16 +119,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;prprf.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l16.15"></a><span id="l16.15"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l16.16"></a><span id="l16.16"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> nsIAtom* nsImapMailFolder::mImapHdrDownloadedAtom=nsnull;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> #define FOUR_K 4096</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -3334,16 +3335,35 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">         case nsMsgFilterAction::StopExecution:</span>
<a href="#l16.24"></a><span id="l16.24">         {</span>
<a href="#l16.25"></a><span id="l16.25">           // don't apply any more filters</span>
<a href="#l16.26"></a><span id="l16.26">           *applyMore = PR_FALSE;</span>
<a href="#l16.27"></a><span id="l16.27">         }</span>
<a href="#l16.28"></a><span id="l16.28">         break;</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+        case nsMsgFilterAction::Custom:</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+        {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+          rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+          nsCAutoString value;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+          filterAction-&gt;GetStrValue(value);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+          messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+          customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+                              nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+        }</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+        break;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+</span>
<a href="#l16.49"></a><span id="l16.49">         default:</span>
<a href="#l16.50"></a><span id="l16.50">           break;</span>
<a href="#l16.51"></a><span id="l16.51">       }</span>
<a href="#l16.52"></a><span id="l16.52">       if (loggingEnabled)</span>
<a href="#l16.53"></a><span id="l16.53">       {</span>
<a href="#l16.54"></a><span id="l16.54">         // only log if successful move, or non-move action</span>
<a href="#l16.55"></a><span id="l16.55">         if (m_msgMovedByFilter || (actionType != nsMsgFilterAction::MoveToFolder &amp;&amp;</span>
<a href="#l16.56"></a><span id="l16.56">              (actionType != nsMsgFilterAction::Delete || !deleteToTrash)))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -88,16 +88,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsICryptoHash.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+#include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13"> </span>
<a href="#l17.14"></a><span id="l17.14"> static NS_DEFINE_CID(kCMailDB, NS_MAILDB_CID);</span>
<a href="#l17.15"></a><span id="l17.15"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> /* the following macros actually implement addref, release and query interface for our component. */</span>
<a href="#l17.18"></a><span id="l17.18"> NS_IMPL_ISUPPORTS_INHERITED3(nsMsgMailboxParser,</span>
<a href="#l17.19"></a><span id="l17.19">                              nsParseMailMessageState,</span>
<a href="#l17.20"></a><span id="l17.20">                              nsIStreamListener,</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -2132,16 +2133,36 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23">       case nsMsgFilterAction::StopExecution:</span>
<a href="#l17.24"></a><span id="l17.24">       {</span>
<a href="#l17.25"></a><span id="l17.25">         // don't apply any more filters</span>
<a href="#l17.26"></a><span id="l17.26">         *applyMore = PR_FALSE;</span>
<a href="#l17.27"></a><span id="l17.27">       }</span>
<a href="#l17.28"></a><span id="l17.28">       break;</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+      case nsMsgFilterAction::Custom:</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+      {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+        rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+        nsCAutoString value;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+        filterAction-&gt;GetStrValue(value);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+            do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+        NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+        messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+        customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+                            nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+      }</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+      break;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+</span>
<a href="#l17.50"></a><span id="l17.50">       default:</span>
<a href="#l17.51"></a><span id="l17.51">         break;</span>
<a href="#l17.52"></a><span id="l17.52">       }</span>
<a href="#l17.53"></a><span id="l17.53">       if (loggingEnabled &amp;&amp; actionType != nsMsgFilterAction::MoveToFolder &amp;&amp; actionType != nsMsgFilterAction::Delete)</span>
<a href="#l17.54"></a><span id="l17.54">         (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l17.55"></a><span id="l17.55">     }</span>
<a href="#l17.56"></a><span id="l17.56">   }</span>
<a href="#l17.57"></a><span id="l17.57">   if (!msgIsNew)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -87,16 +87,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> // update status on header download once per second</span>
<a href="#l18.15"></a><span id="l18.15"> #define MIN_STATUS_UPDATE_INTERVAL PR_USEC_PER_SEC</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> nsNNTPNewsgroupList::nsNNTPNewsgroupList()</span>
<a href="#l18.19"></a><span id="l18.19">   : m_finishingXover(PR_FALSE),</span>
<a href="#l18.20"></a><span id="l18.20">   m_getOldMessages(PR_FALSE),</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -737,16 +738,35 @@ NS_IMETHODIMP nsNNTPNewsgroupList::Apply</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">       case nsMsgFilterAction::StopExecution:</span>
<a href="#l18.24"></a><span id="l18.24">       {</span>
<a href="#l18.25"></a><span id="l18.25">         // don't apply any more filters</span>
<a href="#l18.26"></a><span id="l18.26">         *aApplyMore = PR_FALSE;</span>
<a href="#l18.27"></a><span id="l18.27">       }</span>
<a href="#l18.28"></a><span id="l18.28">       break;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+      case nsMsgFilterAction::Custom:</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+      {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+        rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+        nsCAutoString value;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+        filterAction-&gt;GetStrValue(value);</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+            do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+        NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+        messageArray-&gt;AppendElement(m_newMsgHdr, PR_FALSE);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+        customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+                            nsMsgFilterType::NewsRule, aMsgWindow);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+      }</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+      break;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+</span>
<a href="#l18.49"></a><span id="l18.49">       default:</span>
<a href="#l18.50"></a><span id="l18.50">         NS_ASSERTION(0, &quot;unexpected action&quot;);</span>
<a href="#l18.51"></a><span id="l18.51">         break;</span>
<a href="#l18.52"></a><span id="l18.52">       }</span>
<a href="#l18.53"></a><span id="l18.53"> </span>
<a href="#l18.54"></a><span id="l18.54">       if (loggingEnabled)</span>
<a href="#l18.55"></a><span id="l18.55">         (void) aFilter-&gt;LogRuleHit(filterAction, m_newMsgHdr);</span>
<a href="#l18.56"></a><span id="l18.56">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -26,16 +26,17 @@ junkLogDetectStr=Detected junk message f</span>
<a href="#l19.4"></a><span id="l19.4"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l19.5"></a><span id="l19.5"> logMoveStr=moved message id = %1$S to %2$S</span>
<a href="#l19.6"></a><span id="l19.6"> # LOCALIZATION NOTE(logCopyStr)</span>
<a href="#l19.7"></a><span id="l19.7"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l19.8"></a><span id="l19.8"> logCopyStr=copied message id = %1$S to %2$S</span>
<a href="#l19.9"></a><span id="l19.9"> # LOCALIZATION NOTE(filterLogDetectStr)</span>
<a href="#l19.10"></a><span id="l19.10"> # %1$S=filter name %2$S=author, %3$S=subject, %4$S=date</span>
<a href="#l19.11"></a><span id="l19.11"> filterLogDetectStr=Applied filter &quot;%1$S&quot; to message from %2$S - %3$S at %4$S</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+filterMissingCustomAction=Missing Custom Action</span>
<a href="#l19.13"></a><span id="l19.13"> filterAction2=priority changed</span>
<a href="#l19.14"></a><span id="l19.14"> filterAction3=deleted</span>
<a href="#l19.15"></a><span id="l19.15"> filterAction4=marked as read</span>
<a href="#l19.16"></a><span id="l19.16"> filterAction5=thread killed</span>
<a href="#l19.17"></a><span id="l19.17"> filterAction6=thread watched</span>
<a href="#l19.18"></a><span id="l19.18"> filterAction7=flagged</span>
<a href="#l19.19"></a><span id="l19.19"> filterAction8=tagged</span>
<a href="#l19.20"></a><span id="l19.20"> filterAction9=replied</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

