<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5249:d4ef96917d25868732847a35f941f973f7001c10</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d4ef96917d25868732847a35f941f973f7001c10" />
<meta property="og:url" content="/comm-central/rev/d4ef96917d25868732847a35f941f973f7001c10" />
<meta property="og:description" content="Bug 545625 - back-fork ifdef'd mozStorage of bug 507414 into comm-central or mozilla-1.9.2 for TB 3.1 release.  Now that the patch for bug 507414 has landed on trunk, update our copy to be identical to that one (plus our patches to make it build for mail/).  rs=Standard8 from previous authorization for this patch." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d4ef96917d25868732847a35f941f973f7001c10 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d4ef96917d25868732847a35f941f973f7001c10">shortlog</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d4ef96917d25868732847a35f941f973f7001c10">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10">files</a> |
changeset |
<a href="/comm-central/raw-rev/d4ef96917d25868732847a35f941f973f7001c10">raw</a>  | <a href="/comm-central/archive/d4ef96917d25868732847a35f941f973f7001c10.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">Bug 545625</a> - back-fork ifdef'd mozStorage of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> into comm-central or mozilla-1.9.2 for TB 3.1 release.  Now that the patch for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> has landed on trunk, update our copy to be identical to that one (plus our patches to make it build for mail/).  rs=Standard8 from previous authorization for this patch.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Mar 2010 05:56:26 -0700</td></tr>

<tr>
 <td>changeset 5249</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d4ef96917d25868732847a35f941f973f7001c10">d4ef96917d25868732847a35f941f973f7001c10</a></td>
</tr>



<tr>
<td>parent 5248</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3147aad42dfe780debee6da7fdb2f83dffd55f95">3147aad42dfe780debee6da7fdb2f83dffd55f95</a>
</td>
</tr>

<tr>
<td>child 5250</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5528d77d0a2156aa89827f4c1ba403601330c501">5528d77d0a2156aa89827f4c1ba403601330c501</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d4ef96917d25868732847a35f941f973f7001c10">4051</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Mar 2010 12:56:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d4ef96917d25 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d4ef96917d25868732847a35f941f973f7001c10">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d4ef96917d25868732847a35f941f973f7001c10&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d4ef96917d25868732847a35f941f973f7001c10&newProject=comm-central&newRevision=d4ef96917d25868732847a35f941f973f7001c10&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d4ef96917d25868732847a35f941f973f7001c10&newProject=comm-central&newRevision=d4ef96917d25868732847a35f941f973f7001c10&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d4ef96917d25868732847a35f941f973f7001c10&newProject=comm-central&newRevision=d4ef96917d25868732847a35f941f973f7001c10&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">545625</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">507414</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">Bug 545625</a> - back-fork ifdef'd mozStorage of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> into comm-central or mozilla-1.9.2 for TB 3.1 release.  Now that the patch for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> has landed on trunk, update our copy to be identical to that one (plus our patches to make it build for mail/).  rs=Standard8 from previous authorization for this patch.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">mail/build.mk</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/mail/build.mk">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">mail/makefiles.sh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/mail/makefiles.sh">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">storage-backport/public/mozIStorageBaseStatement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBaseStatement.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">storage-backport/public/mozIStorageBindingParamsArray.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageBindingParamsArray.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">storage-backport/public/mozIStorageConnection.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/mozIStorageConnection.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">storage-backport/public/storage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/public/storage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">storage-backport/src/StorageBaseStatementInternal.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/StorageBaseStatementInternal.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">storage-backport/src/mozStorageAsyncStatement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">storage-backport/src/mozStorageAsyncStatementExecution.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">storage-backport/src/mozStorageAsyncStatementExecution.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementExecution.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">storage-backport/src/mozStorageAsyncStatementJSHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">storage-backport/src/mozStorageBindingParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">storage-backport/src/mozStorageBindingParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParams.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">storage-backport/src/mozStorageBindingParamsArray.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageBindingParamsArray.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">storage-backport/src/mozStorageConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">storage-backport/src/mozStorageStatement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">storage-backport/src/mozStorageStatement.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatement.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">storage-backport/src/mozStorageStatementData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementData.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">storage-backport/src/mozStorageStatementJSHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/src/mozStorageStatementJSHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">storage-backport/style.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/style.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">storage-backport/test/test_true_async.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/test_true_async.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">storage-backport/test/unit/test_statement_executeAsync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">file</a> |
<a href="/comm-central/annotate/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">annotate</a> |
<a href="/comm-central/diff/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">diff</a> |
<a href="/comm-central/comparison/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">comparison</a> |
<a href="/comm-central/log/d4ef96917d25868732847a35f941f973f7001c10/storage-backport/test/unit/test_statement_executeAsync.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/build.mk</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/build.mk</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -37,16 +37,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> ifndef COMM_BUILD # Mozilla Makefile</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> ifndef LIBXUL_SDK</span>
<a href="#l1.8"></a><span id="l1.8"> include $(topsrcdir)/toolkit/toolkit-tiers.mk</span>
<a href="#l1.9"></a><span id="l1.9"> endif</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> ## storage backfork.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# this is temporary until we branch for MOZILLA_1_9_2_BRANCH</span>
<a href="#l1.13"></a><span id="l1.13"> # replace toolkit's storage with our own</span>
<a href="#l1.14"></a><span id="l1.14"> tier_gecko_dirs := $(patsubst storage,../storage-backport,$(tier_gecko_dirs))</span>
<a href="#l1.15"></a><span id="l1.15"> # necko also has a dependency...</span>
<a href="#l1.16"></a><span id="l1.16"> tier_necko_dirs := $(patsubst storage/public,../storage-backport/public,$(tier_necko_dirs))</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> TIERS += app</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/makefiles.sh</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/makefiles.sh</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -59,17 +59,18 @@ mail/test/mozmill/Makefile</span>
<a href="#l2.4"></a><span id="l2.4"> mail/themes/Makefile</span>
<a href="#l2.5"></a><span id="l2.5"> mail/themes/gnomestripe/Makefile</span>
<a href="#l2.6"></a><span id="l2.6"> mail/themes/pinstripe/Makefile</span>
<a href="#l2.7"></a><span id="l2.7"> mail/themes/qute/Makefile</span>
<a href="#l2.8"></a><span id="l2.8"> $MOZ_BRANDING_DIRECTORY/Makefile</span>
<a href="#l2.9"></a><span id="l2.9"> $MOZ_BRANDING_DIRECTORY/locales/Makefile</span>
<a href="#l2.10"></a><span id="l2.10"> &quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-# storage-backport stuff</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+# storage-backport stuff.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+# this is temporary until we branch for MOZILLA_1_9_2_BRANCH</span>
<a href="#l2.15"></a><span id="l2.15"> add_makefiles &quot;</span>
<a href="#l2.16"></a><span id="l2.16"> storage-backport/Makefile</span>
<a href="#l2.17"></a><span id="l2.17"> storage-backport/public/Makefile</span>
<a href="#l2.18"></a><span id="l2.18"> storage-backport/src/Makefile</span>
<a href="#l2.19"></a><span id="l2.19"> storage-backport/build/Makefile</span>
<a href="#l2.20"></a><span id="l2.20"> storage-backport/test/Makefile</span>
<a href="#l2.21"></a><span id="l2.21"> &quot;</span>
<a href="#l2.22"></a><span id="l2.22"> fi</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/storage-backport/public/mozIStorageBaseStatement.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/storage-backport/public/mozIStorageBaseStatement.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -75,17 +75,20 @@ interface mozIStorageBaseStatement : moz</span>
<a href="#l3.4"></a><span id="l3.4">   void finalize();</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   /**</span>
<a href="#l3.7"></a><span id="l3.7">    * Bind the given value at the given numeric index.</span>
<a href="#l3.8"></a><span id="l3.8">    *</span>
<a href="#l3.9"></a><span id="l3.9">    * @param aParamIndex</span>
<a href="#l3.10"></a><span id="l3.10">    *        0-based index, 0 corresponding to the first numbered argument or</span>
<a href="#l3.11"></a><span id="l3.11">    *        &quot;?1&quot;.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-   * @param aValue Argument value.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+   * @param aValue</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+   *        Argument value.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+   * @param aValueSize</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+   *        Length of aValue in bytes.</span>
<a href="#l3.17"></a><span id="l3.17">    * @{</span>
<a href="#l3.18"></a><span id="l3.18">    */</span>
<a href="#l3.19"></a><span id="l3.19">   [deprecated] void bindUTF8StringParameter(in unsigned long aParamIndex,</span>
<a href="#l3.20"></a><span id="l3.20">                                             in AUTF8String aValue);</span>
<a href="#l3.21"></a><span id="l3.21">   [deprecated] void bindStringParameter(in unsigned long aParamIndex,</span>
<a href="#l3.22"></a><span id="l3.22">                                         in AString aValue);</span>
<a href="#l3.23"></a><span id="l3.23">   [deprecated] void bindDoubleParameter(in unsigned long aParamIndex,</span>
<a href="#l3.24"></a><span id="l3.24">                                         in double aValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/storage-backport/public/mozIStorageBindingParamsArray.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/storage-backport/public/mozIStorageBindingParamsArray.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -36,27 +36,32 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> interface mozIStorageBindingParams;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(e676e1a3-1dc6-4802-ac03-291fa9de7f93)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(67eea5c3-4881-41ff-b0fe-09f2356aeadb)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface mozIStorageBindingParamsArray : nsISupports {</span>
<a href="#l4.15"></a><span id="l4.15">   /**</span>
<a href="#l4.16"></a><span id="l4.16">    * Creates a new mozIStorageBindingParams object that can be added to this</span>
<a href="#l4.17"></a><span id="l4.17">    * array.</span>
<a href="#l4.18"></a><span id="l4.18">    *</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-   * @returns a mozIStorageBindingParams object that can be used to specify</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-   *          parameters that need to be bound.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+   * @return a mozIStorageBindingParams object that can be used to specify</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+   *         parameters that need to be bound.</span>
<a href="#l4.23"></a><span id="l4.23">    */</span>
<a href="#l4.24"></a><span id="l4.24">   mozIStorageBindingParams newBindingParams();</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   /**</span>
<a href="#l4.27"></a><span id="l4.27">    * Adds the parameters to the end of this array.</span>
<a href="#l4.28"></a><span id="l4.28">    *</span>
<a href="#l4.29"></a><span id="l4.29">    * @param aParameters</span>
<a href="#l4.30"></a><span id="l4.30">    *        The parameters to add to this array.</span>
<a href="#l4.31"></a><span id="l4.31">    */</span>
<a href="#l4.32"></a><span id="l4.32">   void addParams(in mozIStorageBindingParams aParameters);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  /**</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+   * The number of mozIStorageBindingParams this object contains.</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   */</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  readonly attribute unsigned long length;</span>
<a href="#l4.38"></a><span id="l4.38"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/storage-backport/public/mozIStorageConnection.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/storage-backport/public/mozIStorageConnection.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -252,18 +252,19 @@ interface mozIStorageConnection : nsISup</span>
<a href="#l5.4"></a><span id="l5.4">    *</span>
<a href="#l5.5"></a><span id="l5.5">    * @param aTableName</span>
<a href="#l5.6"></a><span id="l5.6">    *        The table name to be created, consisting of [A-Za-z0-9_], and</span>
<a href="#l5.7"></a><span id="l5.7">    *        beginning with a letter.</span>
<a href="#l5.8"></a><span id="l5.8">    * @param aTableSchema</span>
<a href="#l5.9"></a><span id="l5.9">    *        The schema of the table; what would normally go between the parens</span>
<a href="#l5.10"></a><span id="l5.10">    *        in a CREATE TABLE statement: e.g., &quot;foo  INTEGER, bar STRING&quot;.</span>
<a href="#l5.11"></a><span id="l5.11">    *</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   * @throws NS_ERROR_FAILURE if the table already exists or could not be</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-   *         created for any other reason.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+   * @throws NS_ERROR_FAILURE</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+   *         If the table already exists or could not be created for any other</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+   *         reason.</span>
<a href="#l5.17"></a><span id="l5.17">    */</span>
<a href="#l5.18"></a><span id="l5.18">   void createTable(in string aTableName,</span>
<a href="#l5.19"></a><span id="l5.19">                    in string aTableSchema);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.22"></a><span id="l5.22">   //// Functions</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/storage-backport/public/storage.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/storage-backport/public/storage.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,29 +38,31 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #ifndef mozilla_storage_h_</span>
<a href="#l6.7"></a><span id="l6.7"> #define mozilla_storage_h_</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.10"></a><span id="l6.10"> //// Public Interfaces</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#include &quot;mozStorageCID.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13"> #include &quot;mozIStorageAggregateFunction.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;mozIStorageError.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;mozIStorageFunction.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;mozIStoragePendingStatement.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18"> #include &quot;mozIStorageProgressHandler.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> #include &quot;mozIStorageResultSet.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> #include &quot;mozIStorageRow.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21"> #include &quot;mozIStorageService.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22"> #include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23"> #include &quot;mozIStorageStatementCallback.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+#include &quot;mozIStorageBindingParamsArray.h&quot;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+#include &quot;mozIStorageBindingParams.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.28"></a><span id="l6.28"> //// Native Language Helpers</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> #include &quot;mozStorageHelper.h&quot;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-#include &quot;mozStorageCID.h&quot;</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> #include &quot;mozilla/storage/Variant.h&quot;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35"> #endif // mozilla_storage_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/storage-backport/src/StorageBaseStatementInternal.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/storage-backport/src/StorageBaseStatementInternal.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -232,21 +232,26 @@ NS_DEFINE_STATIC_IID_ACCESSOR(StorageBas</span>
<a href="#l7.4"></a><span id="l7.4">  * 3 different forms; 2 by index, 1 by name.  The following macro allows</span>
<a href="#l7.5"></a><span id="l7.5">  * us to avoid having to define repetitive things by hand.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * Because of limitations of macros and our desire to avoid requiring special</span>
<a href="#l7.8"></a><span id="l7.8">  * permutations for the null and blob cases (whose argument count varies),</span>
<a href="#l7.9"></a><span id="l7.9">  * we require that the argument declarations and corresponding invocation</span>
<a href="#l7.10"></a><span id="l7.10">  * usages are passed in.</span>
<a href="#l7.11"></a><span id="l7.11">  *</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- * @param _class The class name.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">- * @param _guard The guard clause to inject.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * @param _declName The argument list (with parens) for the ByName variants.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * @param _declIndex The argument list (with parens) for the index variants.</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * @param _invArgs The invocation argumment list.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ * @param _class</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ *        The class name.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ * @param _guard</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ *        The guard clause to inject.</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * @param _declName</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ *        The argument list (with parens) for the ByName variants.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * @param _declIndex</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *        The argument list (with parens) for the index variants.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * @param _invArgs</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *        The invocation argumment list.</span>
<a href="#l7.27"></a><span id="l7.27">  */</span>
<a href="#l7.28"></a><span id="l7.28"> #define BIND_GEN_IMPL(_class, _guard, _name, _declName, _declIndex, _invArgs) \</span>
<a href="#l7.29"></a><span id="l7.29">   NS_IMETHODIMP _class::BIND_NAME_CONCAT(_name, ByName) _declName             \</span>
<a href="#l7.30"></a><span id="l7.30">   {                                                                           \</span>
<a href="#l7.31"></a><span id="l7.31">     _guard                                                                    \</span>
<a href="#l7.32"></a><span id="l7.32">     mozIStorageBindingParams *params = getParams();                           \</span>
<a href="#l7.33"></a><span id="l7.33">     NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);                           \</span>
<a href="#l7.34"></a><span id="l7.34">     return params-&gt;BIND_NAME_CONCAT(_name, ByName) _invArgs;                  \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/storage-backport/src/mozStorageAsyncStatement.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatement.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -419,16 +419,19 @@ AsyncStatement::BindParameters(mozIStora</span>
<a href="#l8.4"></a><span id="l8.4"> {</span>
<a href="#l8.5"></a><span id="l8.5">   if (mFinalized)</span>
<a href="#l8.6"></a><span id="l8.6">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   BindingParamsArray *array = static_cast&lt;BindingParamsArray *&gt;(aParameters);</span>
<a href="#l8.9"></a><span id="l8.9">   if (array-&gt;getOwner() != this)</span>
<a href="#l8.10"></a><span id="l8.10">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  if (array-&gt;length() == 0)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15">   mParamsArray = array;</span>
<a href="#l8.16"></a><span id="l8.16">   mParamsArray-&gt;lock();</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   return NS_OK;</span>
<a href="#l8.19"></a><span id="l8.19"> }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> NS_IMETHODIMP</span>
<a href="#l8.22"></a><span id="l8.22"> AsyncStatement::GetState(PRInt32 *_state)</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -441,12 +444,13 @@ AsyncStatement::GetState(PRInt32 *_state</span>
<a href="#l8.24"></a><span id="l8.24">   return NS_OK;</span>
<a href="#l8.25"></a><span id="l8.25"> }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.28"></a><span id="l8.28"> //// mozIStorageBindingParams</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> BOILERPLATE_BIND_PROXIES(</span>
<a href="#l8.31"></a><span id="l8.31">   AsyncStatement, </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  if (mFinalized) return NS_ERROR_UNEXPECTED;)</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  if (mFinalized) return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+)</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> } // namespace storage</span>
<a href="#l8.37"></a><span id="l8.37"> } // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/storage-backport/src/mozStorageAsyncStatementExecution.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementExecution.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -239,19 +239,20 @@ AsyncExecuteStatements::shouldNotify()</span>
<a href="#l9.4"></a><span id="l9.4"> }</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> bool</span>
<a href="#l9.7"></a><span id="l9.7"> AsyncExecuteStatements::bindExecuteAndProcessStatement(StatementData &amp;aData,</span>
<a href="#l9.8"></a><span id="l9.8">                                                        bool aLastStatement)</span>
<a href="#l9.9"></a><span id="l9.9"> {</span>
<a href="#l9.10"></a><span id="l9.10">   mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  sqlite3_stmt *aStatement;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  sqlite3_stmt *aStatement = nsnull;</span>
<a href="#l9.14"></a><span id="l9.14">   // This cannot fail; we are only called if it's available.</span>
<a href="#l9.15"></a><span id="l9.15">   (void)aData.getSqliteStatement(&amp;aStatement);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  NS_ASSERTION(aStatement, &quot;You broke the code; do not call here like that!&quot;);</span>
<a href="#l9.17"></a><span id="l9.17">   BindingParamsArray *paramsArray(aData);</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   // Iterate through all of our parameters, bind them, and execute.</span>
<a href="#l9.20"></a><span id="l9.20">   bool continueProcessing = true;</span>
<a href="#l9.21"></a><span id="l9.21">   BindingParamsArray::iterator itr = paramsArray-&gt;begin();</span>
<a href="#l9.22"></a><span id="l9.22">   BindingParamsArray::iterator end = paramsArray-&gt;end();</span>
<a href="#l9.23"></a><span id="l9.23">   while (itr != end &amp;&amp; continueProcessing) {</span>
<a href="#l9.24"></a><span id="l9.24">     // Bind the data to our statement.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/storage-backport/src/mozStorageAsyncStatementExecution.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementExecution.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -234,21 +234,20 @@ private:</span>
<a href="#l10.4"></a><span id="l10.4">    * This includes the following variables:</span>
<a href="#l10.5"></a><span id="l10.5">    *   - mCancelRequested is only set on the calling thread while the lock is</span>
<a href="#l10.6"></a><span id="l10.6">    *     held.  It is always read from within the lock on the background thread,</span>
<a href="#l10.7"></a><span id="l10.7">    *     but not on the calling thread (see shouldNotify for why).</span>
<a href="#l10.8"></a><span id="l10.8">    */</span>
<a href="#l10.9"></a><span id="l10.9">   Mutex &amp;mMutex;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   /**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-   * The wrapped SQLite recursive connection mutex used by sqlite3_step.  We use</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-   * it whenever we call sqlite3_step and care about having reliable error</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-   * messages.  By taking it prior to the call and holding it until the point</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-   * where we no longer care about the error message, the user gets reliable</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-   * error messages.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+   * The wrapped SQLite recursive connection mutex.  We use it whenever we call</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+   * sqlite3_step and care about having reliable error messages.  By taking it</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+   * prior to the call and holding it until the point where we no longer care</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+   * about the error message, the user gets reliable error messages.</span>
<a href="#l10.21"></a><span id="l10.21">    */</span>
<a href="#l10.22"></a><span id="l10.22">   SQLiteMutex &amp;mDBMutex;</span>
<a href="#l10.23"></a><span id="l10.23"> };</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> } // namespace storage</span>
<a href="#l10.26"></a><span id="l10.26"> } // namespace mozilla</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> #endif // _mozStorageAsyncStatementExecution_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -10,18 +10,17 @@</span>
<a href="#l11.4"></a><span id="l11.4">  *</span>
<a href="#l11.5"></a><span id="l11.5">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.6"></a><span id="l11.6">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.7"></a><span id="l11.7">  * for the specific language governing rights and limitations under the</span>
<a href="#l11.8"></a><span id="l11.8">  * License.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * The Original Code is mozStorage code.</span>
<a href="#l11.11"></a><span id="l11.11">  *</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- * Mozilla Corporation.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l11.15"></a><span id="l11.15">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l11.16"></a><span id="l11.16">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.17"></a><span id="l11.17">  *</span>
<a href="#l11.18"></a><span id="l11.18">  * Contributor(s):</span>
<a href="#l11.19"></a><span id="l11.19">  *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l11.20"></a><span id="l11.20">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l11.21"></a><span id="l11.21">  *</span>
<a href="#l11.22"></a><span id="l11.22">  * Alternatively, the contents of this file may be used under the terms of</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/storage-backport/src/mozStorageBindingParams.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParams.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -198,23 +198,22 @@ AsyncBindingParams::iterateOverNamedPara</span>
<a href="#l12.4"></a><span id="l12.4">   NamedParameterIterationClosureThunk *closureThunk =</span>
<a href="#l12.5"></a><span id="l12.5">     static_cast&lt;NamedParameterIterationClosureThunk *&gt;(voidClosureThunk);</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">   // We do not accept any forms of names other than &quot;:name&quot;, but we need to add</span>
<a href="#l12.8"></a><span id="l12.8">   // the colon for SQLite.</span>
<a href="#l12.9"></a><span id="l12.9">   nsCAutoString name(&quot;:&quot;);</span>
<a href="#l12.10"></a><span id="l12.10">   name.Append(aName);</span>
<a href="#l12.11"></a><span id="l12.11">   int oneIdx = ::sqlite3_bind_parameter_index(closureThunk-&gt;statement,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                                              PromiseFlatCString(name).get());</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                                              name.get());</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   if (oneIdx == 0) {</span>
<a href="#l12.16"></a><span id="l12.16">     nsCAutoString errMsg(aName);</span>
<a href="#l12.17"></a><span id="l12.17">     errMsg.Append(NS_LITERAL_CSTRING(&quot; is not a valid named parameter.&quot;));</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    closureThunk-&gt;err = new Error(SQLITE_RANGE,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                                  PromiseFlatCString(errMsg).get());</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    closureThunk-&gt;err = new Error(SQLITE_RANGE, errMsg.get());</span>
<a href="#l12.21"></a><span id="l12.21">     return PL_DHASH_STOP;</span>
<a href="#l12.22"></a><span id="l12.22">   }</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24">   // XPCVariant's AddRef and Release are not thread-safe and so we must not do</span>
<a href="#l12.25"></a><span id="l12.25">   // anything that would invoke them here on the async thread.  As such we can't</span>
<a href="#l12.26"></a><span id="l12.26">   // cram aValue into self-&gt;mParameters using ReplaceObjectAt so that we can</span>
<a href="#l12.27"></a><span id="l12.27">   // freeload off of the BindingParams::Bind implementation.</span>
<a href="#l12.28"></a><span id="l12.28">   int rc = variantToSQLiteT(BindingColumnData(closureThunk-&gt;statement,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/storage-backport/src/mozStorageBindingParams.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParams.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -67,19 +67,20 @@ public:</span>
<a href="#l13.4"></a><span id="l13.4">    * Locks the parameters and prevents further modification to it (such as</span>
<a href="#l13.5"></a><span id="l13.5">    * binding more elements to it).</span>
<a href="#l13.6"></a><span id="l13.6">    */</span>
<a href="#l13.7"></a><span id="l13.7">   void lock();</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   /**</span>
<a href="#l13.10"></a><span id="l13.10">    * Unlocks the parameters and allows modification to it again.</span>
<a href="#l13.11"></a><span id="l13.11">    *</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-   * @param aOwningStatement The statement that owns us.  We cleared this when</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-   *        we were locked, and our invariant requires us to have this, so you</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-   *        need to tell us again.</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+   * @param aOwningStatement</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+   *        The statement that owns us.  We cleared this when we were locked,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+   *        and our invariant requires us to have this, so you need to tell us</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+   *        again.</span>
<a href="#l13.19"></a><span id="l13.19">    */</span>
<a href="#l13.20"></a><span id="l13.20">   void unlock(Statement *aOwningStatement);</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">   /**</span>
<a href="#l13.23"></a><span id="l13.23">    * @returns the pointer to the owning BindingParamsArray.  Used by a</span>
<a href="#l13.24"></a><span id="l13.24">    *          BindingParamsArray to verify that we belong to it when added.</span>
<a href="#l13.25"></a><span id="l13.25">    */</span>
<a href="#l13.26"></a><span id="l13.26">   const mozIStorageBindingParamsArray *getOwner() const;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/storage-backport/src/mozStorageBindingParamsArray.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParamsArray.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -107,10 +107,17 @@ BindingParamsArray::AddParams(mozIStorag</span>
<a href="#l14.4"></a><span id="l14.4">   NS_ENSURE_TRUE(mArray.AppendElement(params), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">   // Lock the parameters only after we've successfully added them.</span>
<a href="#l14.7"></a><span id="l14.7">   params-&gt;lock();</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">   return NS_OK;</span>
<a href="#l14.10"></a><span id="l14.10"> }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+BindingParamsArray::GetLength(PRUint32 *_length)</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+{</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  *_length = length();</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+}</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19"> } // namespace storage</span>
<a href="#l14.20"></a><span id="l14.20"> } // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/storage-backport/src/mozStorageConnection.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/storage-backport/src/mozStorageConnection.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -255,50 +255,45 @@ aggregateFunctionFinalHelper(sqlite3_con</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> namespace {</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> class AsyncCloseConnection : public nsRunnable</span>
<a href="#l15.8"></a><span id="l15.8"> {</span>
<a href="#l15.9"></a><span id="l15.9"> public:</span>
<a href="#l15.10"></a><span id="l15.10">   AsyncCloseConnection(Connection *aConnection,</span>
<a href="#l15.11"></a><span id="l15.11">                        nsIEventTarget *aCallingThread,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-                       nsIRunnable *aCallbackEvent,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                       nsIThread *aAsyncThread)</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+                       nsIRunnable *aCallbackEvent)</span>
<a href="#l15.15"></a><span id="l15.15">   : mConnection(aConnection)</span>
<a href="#l15.16"></a><span id="l15.16">   , mCallingThread(aCallingThread)</span>
<a href="#l15.17"></a><span id="l15.17">   , mCallbackEvent(aCallbackEvent)</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  , mAsyncThread(aAsyncThread)</span>
<a href="#l15.19"></a><span id="l15.19">   {</span>
<a href="#l15.20"></a><span id="l15.20">   }</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">   NS_METHOD Run()</span>
<a href="#l15.23"></a><span id="l15.23">   {</span>
<a href="#l15.24"></a><span id="l15.24">     // This event is first dispatched to the background thread to ensure that</span>
<a href="#l15.25"></a><span id="l15.25">     // all pending asynchronous events are completed, and then back to the</span>
<a href="#l15.26"></a><span id="l15.26">     // calling thread to actually close and notify.</span>
<a href="#l15.27"></a><span id="l15.27">     PRBool onCallingThread = PR_FALSE;</span>
<a href="#l15.28"></a><span id="l15.28">     (void)mCallingThread-&gt;IsOnCurrentThread(&amp;onCallingThread);</span>
<a href="#l15.29"></a><span id="l15.29">     if (!onCallingThread) {</span>
<a href="#l15.30"></a><span id="l15.30">       (void)mCallingThread-&gt;Dispatch(this, NS_DISPATCH_NORMAL);</span>
<a href="#l15.31"></a><span id="l15.31">       return NS_OK;</span>
<a href="#l15.32"></a><span id="l15.32">     }</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    if (mConnection)</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-      (void)mConnection-&gt;internalClose();</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    (void)mConnection-&gt;internalClose();</span>
<a href="#l15.37"></a><span id="l15.37">     if (mCallbackEvent)</span>
<a href="#l15.38"></a><span id="l15.38">       (void)mCallingThread-&gt;Dispatch(mCallbackEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-    mAsyncThread-&gt;Shutdown();</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">     return NS_OK;</span>
<a href="#l15.42"></a><span id="l15.42">   }</span>
<a href="#l15.43"></a><span id="l15.43"> private:</span>
<a href="#l15.44"></a><span id="l15.44">   nsCOMPtr&lt;Connection&gt; mConnection;</span>
<a href="#l15.45"></a><span id="l15.45">   nsCOMPtr&lt;nsIEventTarget&gt; mCallingThread;</span>
<a href="#l15.46"></a><span id="l15.46">   nsCOMPtr&lt;nsIRunnable&gt; mCallbackEvent;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt; mAsyncThread;</span>
<a href="#l15.48"></a><span id="l15.48"> };</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50"> } // anonymous namespace</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.53"></a><span id="l15.53"> //// Connection</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55"> Connection::Connection(Service *aService)</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineat">@@ -312,32 +307,16 @@ Connection::Connection(Service *aService</span>
<a href="#l15.57"></a><span id="l15.57"> , mStorageService(aService)</span>
<a href="#l15.58"></a><span id="l15.58"> {</span>
<a href="#l15.59"></a><span id="l15.59">   mFunctions.Init();</span>
<a href="#l15.60"></a><span id="l15.60"> }</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62"> Connection::~Connection()</span>
<a href="#l15.63"></a><span id="l15.63"> {</span>
<a href="#l15.64"></a><span id="l15.64">   (void)Close();</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  // If we know about an async execution thread then we need to take steps to</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  // trigger its shutdown.  (AsyncClose is the only other code to trigger</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-  // something like this and it nulls out our reference so there is no risk of</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-  // double triggering.)</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  if (mAsyncExecutionThread) {</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    // Note: Obviously, we can't tell it about us since we are dying.  We also</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    // skimp on using a mutex since there's no point.</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; closeEvent =</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      new AsyncCloseConnection(nsnull, NS_GetCurrentThread(), nsnull,</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-                               mAsyncExecutionThread);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-    if (!closeEvent)</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-      return;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-    (void)mAsyncExecutionThread-&gt;Dispatch(closeEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-  }</span>
<a href="#l15.81"></a><span id="l15.81"> }</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83"> NS_IMPL_THREADSAFE_ISUPPORTS1(</span>
<a href="#l15.84"></a><span id="l15.84">   Connection,</span>
<a href="#l15.85"></a><span id="l15.85">   mozIStorageConnection</span>
<a href="#l15.86"></a><span id="l15.86"> )</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88"> nsIEventTarget *</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineat">@@ -640,25 +619,18 @@ Connection::AsyncClose(mozIStorageComple</span>
<a href="#l15.90"></a><span id="l15.90">   // Create our callback event if we were given a callback.</span>
<a href="#l15.91"></a><span id="l15.91">   nsCOMPtr&lt;nsIRunnable&gt; completeEvent;</span>
<a href="#l15.92"></a><span id="l15.92">   if (aCallback) {</span>
<a href="#l15.93"></a><span id="l15.93">     completeEvent = newCompletionEvent(aCallback);</span>
<a href="#l15.94"></a><span id="l15.94">     NS_ENSURE_TRUE(completeEvent, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l15.95"></a><span id="l15.95">   }</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97">   // Create and dispatch our close event to the background thread.</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-  nsCOMPtr&lt;nsIRunnable&gt; closeEvent;</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  {</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-    MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-    closeEvent = new AsyncCloseConnection(this, NS_GetCurrentThread(),</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-                                          completeEvent,</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-                                          mAsyncExecutionThread);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-    // forget about the async thread (this is why we're holding the mutex)</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-    mAsyncExecutionThread = nsnull;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-  }</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; closeEvent =</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+    new AsyncCloseConnection(this, NS_GetCurrentThread(), completeEvent);</span>
<a href="#l15.109"></a><span id="l15.109">   NS_ENSURE_TRUE(closeEvent, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111">   rv = asyncThread-&gt;Dispatch(closeEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l15.112"></a><span id="l15.112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114">   return NS_OK;</span>
<a href="#l15.115"></a><span id="l15.115"> }</span>
<a href="#l15.116"></a><span id="l15.116"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/storage-backport/src/mozStorageStatement.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/storage-backport/src/mozStorageStatement.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -381,33 +381,33 @@ Statement::Clone(mozIStorageStatement **</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> NS_IMETHODIMP</span>
<a href="#l16.6"></a><span id="l16.6"> Statement::Finalize()</span>
<a href="#l16.7"></a><span id="l16.7"> {</span>
<a href="#l16.8"></a><span id="l16.8">   return internalFinalize(false);</span>
<a href="#l16.9"></a><span id="l16.9"> }</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> nsresult</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-Statement::internalFinalize(bool destructing)</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+Statement::internalFinalize(bool aDestructing)</span>
<a href="#l16.14"></a><span id="l16.14"> {</span>
<a href="#l16.15"></a><span id="l16.15">   if (!mDBStatement)</span>
<a href="#l16.16"></a><span id="l16.16">     return NS_OK;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> #ifdef PR_LOGGING</span>
<a href="#l16.19"></a><span id="l16.19">   PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Finalizing statement '%s'&quot;,</span>
<a href="#l16.20"></a><span id="l16.20">                                       ::sqlite3_sql(mDBStatement)));</span>
<a href="#l16.21"></a><span id="l16.21"> #endif</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">   int srv = ::sqlite3_finalize(mDBStatement);</span>
<a href="#l16.24"></a><span id="l16.24">   mDBStatement = NULL;</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">   if (mAsyncStatement) {</span>
<a href="#l16.27"></a><span id="l16.27">     // If the destructor called us, there are no pending async statements (they</span>
<a href="#l16.28"></a><span id="l16.28">     // hold a reference to us) and we can/must just kill the statement directly.</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-    if (destructing)</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+    if (aDestructing)</span>
<a href="#l16.31"></a><span id="l16.31">       internalAsyncFinalize();</span>
<a href="#l16.32"></a><span id="l16.32">     else</span>
<a href="#l16.33"></a><span id="l16.33">       asyncFinalize();</span>
<a href="#l16.34"></a><span id="l16.34">   }</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   // We are considered dead at this point, so any wrappers for row or params</span>
<a href="#l16.37"></a><span id="l16.37">   // need to lose their reference to us.</span>
<a href="#l16.38"></a><span id="l16.38">   if (mStatementParamsHolder) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineat">@@ -557,16 +557,19 @@ Statement::BindParameters(mozIStorageBin</span>
<a href="#l16.40"></a><span id="l16.40"> {</span>
<a href="#l16.41"></a><span id="l16.41">   if (!mDBStatement)</span>
<a href="#l16.42"></a><span id="l16.42">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44">   BindingParamsArray *array = static_cast&lt;BindingParamsArray *&gt;(aParameters);</span>
<a href="#l16.45"></a><span id="l16.45">   if (array-&gt;getOwner() != this)</span>
<a href="#l16.46"></a><span id="l16.46">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  if (array-&gt;length() == 0)</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+</span>
<a href="#l16.51"></a><span id="l16.51">   mParamsArray = array;</span>
<a href="#l16.52"></a><span id="l16.52">   mParamsArray-&gt;lock();</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">   return NS_OK;</span>
<a href="#l16.55"></a><span id="l16.55"> }</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57"> NS_IMETHODIMP</span>
<a href="#l16.58"></a><span id="l16.58"> Statement::Execute()</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineat">@@ -886,12 +889,13 @@ Statement::GetIsNull(PRUint32 aIndex,</span>
<a href="#l16.60"></a><span id="l16.60">   return NS_OK;</span>
<a href="#l16.61"></a><span id="l16.61"> }</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.64"></a><span id="l16.64"> //// mozIStorageBindingParams</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66"> BOILERPLATE_BIND_PROXIES(</span>
<a href="#l16.67"></a><span id="l16.67">   Statement, </span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  if (!mDBStatement) return NS_ERROR_NOT_INITIALIZED;)</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  if (!mDBStatement) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+)</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72"> } // namespace storage</span>
<a href="#l16.73"></a><span id="l16.73"> } // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/storage-backport/src/mozStorageStatement.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/storage-backport/src/mozStorageStatement.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -128,19 +128,20 @@ private:</span>
<a href="#l17.4"></a><span id="l17.4">     nsCOMPtr&lt;nsIXPConnectJSObjectHolder&gt; mStatementParamsHolder;</span>
<a href="#l17.5"></a><span id="l17.5">     nsCOMPtr&lt;nsIXPConnectJSObjectHolder&gt; mStatementRowHolder;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   /**</span>
<a href="#l17.8"></a><span id="l17.8">    * Internal version of finalize that allows us to tell it if it is being</span>
<a href="#l17.9"></a><span id="l17.9">    * called from the destructor so it can know not to dispatch events that</span>
<a href="#l17.10"></a><span id="l17.10">    * require a reference to us.</span>
<a href="#l17.11"></a><span id="l17.11">    *</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-   * @param destructing Is the destructor calling?</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+   * @param aDestructing</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+   *        Is the destructor calling?</span>
<a href="#l17.15"></a><span id="l17.15">    */</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  nsresult internalFinalize(bool destructing);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  nsresult internalFinalize(bool aDestructing);</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">     friend class StatementJSHelper;</span>
<a href="#l17.20"></a><span id="l17.20"> };</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22"> } // storage</span>
<a href="#l17.23"></a><span id="l17.23"> } // mozilla</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25"> #endif // _mozStorageStatement_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/storage-backport/src/mozStorageStatementData.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementData.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -79,18 +79,17 @@ public:</span>
<a href="#l18.4"></a><span id="l18.4">   /**</span>
<a href="#l18.5"></a><span id="l18.5">    * Return the sqlite statement, fetching it from the storage statement.  In</span>
<a href="#l18.6"></a><span id="l18.6">    * the case of AsyncStatements this may actually create the statement </span>
<a href="#l18.7"></a><span id="l18.7">    */</span>
<a href="#l18.8"></a><span id="l18.8">   inline int getSqliteStatement(sqlite3_stmt **_stmt)</span>
<a href="#l18.9"></a><span id="l18.9">   {</span>
<a href="#l18.10"></a><span id="l18.10">     if (!mStatement) {</span>
<a href="#l18.11"></a><span id="l18.11">       int rc = mStatementOwner-&gt;getAsyncStatement(&amp;mStatement);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-      if (rc != SQLITE_OK)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-        return rc;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+      NS_ENSURE_TRUE(rc == SQLITE_OK, rc);</span>
<a href="#l18.15"></a><span id="l18.15">     }</span>
<a href="#l18.16"></a><span id="l18.16">     *_stmt = mStatement;</span>
<a href="#l18.17"></a><span id="l18.17">     return SQLITE_OK;</span>
<a href="#l18.18"></a><span id="l18.18">   }</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">   operator BindingParamsArray *() const { return mParamsArray; }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/storage-backport/src/mozStorageStatementJSHelper.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementJSHelper.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -69,29 +69,29 @@ stepFunc(JSContext *aCtx,</span>
<a href="#l19.4"></a><span id="l19.4">   nsresult rv = xpc-&gt;GetWrappedNativeOfJSObject(</span>
<a href="#l19.5"></a><span id="l19.5">     aCtx, JS_THIS_OBJECT(aCtx, _vp), getter_AddRefs(wrapper)</span>
<a href="#l19.6"></a><span id="l19.6">   );</span>
<a href="#l19.7"></a><span id="l19.7">   if (NS_FAILED(rv)) {</span>
<a href="#l19.8"></a><span id="l19.8">     ::JS_ReportError(aCtx, &quot;mozIStorageStatement::step() could not obtain native statement&quot;);</span>
<a href="#l19.9"></a><span id="l19.9">     return JS_FALSE;</span>
<a href="#l19.10"></a><span id="l19.10">   }</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    static_cast&lt;mozIStorageStatement *&gt;(wrapper-&gt;Native())</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-  );</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16"> #ifdef DEBUG</span>
<a href="#l19.17"></a><span id="l19.17">   {</span>
<a href="#l19.18"></a><span id="l19.18">     nsCOMPtr&lt;mozIStorageStatement&gt; isStatement(</span>
<a href="#l19.19"></a><span id="l19.19">       do_QueryInterface(wrapper-&gt;Native())</span>
<a href="#l19.20"></a><span id="l19.20">     );</span>
<a href="#l19.21"></a><span id="l19.21">     NS_ASSERTION(isStatement, &quot;How is this not a statement?!&quot;);</span>
<a href="#l19.22"></a><span id="l19.22">   }</span>
<a href="#l19.23"></a><span id="l19.23"> #endif</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+    static_cast&lt;mozIStorageStatement *&gt;(wrapper-&gt;Native())</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+  );</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+</span>
<a href="#l19.29"></a><span id="l19.29">   PRBool hasMore = PR_FALSE;</span>
<a href="#l19.30"></a><span id="l19.30">   rv = stmt-&gt;ExecuteStep(&amp;hasMore);</span>
<a href="#l19.31"></a><span id="l19.31">   if (NS_SUCCEEDED(rv) &amp;&amp; !hasMore) {</span>
<a href="#l19.32"></a><span id="l19.32">     *_vp = JSVAL_FALSE;</span>
<a href="#l19.33"></a><span id="l19.33">     (void)stmt-&gt;Reset();</span>
<a href="#l19.34"></a><span id="l19.34">     return JS_TRUE;</span>
<a href="#l19.35"></a><span id="l19.35">   }</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37" class="difflineat">@@ -207,28 +207,28 @@ StatementJSHelper::GetProperty(nsIXPConn</span>
<a href="#l19.38"></a><span id="l19.38">                                JSObject *aScopeObj,</span>
<a href="#l19.39"></a><span id="l19.39">                                jsval aId,</span>
<a href="#l19.40"></a><span id="l19.40">                                jsval *_result,</span>
<a href="#l19.41"></a><span id="l19.41">                                PRBool *_retval)</span>
<a href="#l19.42"></a><span id="l19.42"> {</span>
<a href="#l19.43"></a><span id="l19.43">   if (!JSVAL_IS_STRING(aId))</span>
<a href="#l19.44"></a><span id="l19.44">     return NS_OK;</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-    static_cast&lt;mozIStorageStatement *&gt;(aWrapper-&gt;Native())</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-  );</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-</span>
<a href="#l19.50"></a><span id="l19.50"> #ifdef DEBUG</span>
<a href="#l19.51"></a><span id="l19.51">   {</span>
<a href="#l19.52"></a><span id="l19.52">     nsCOMPtr&lt;mozIStorageStatement&gt; isStatement(</span>
<a href="#l19.53"></a><span id="l19.53">                                      do_QueryInterface(aWrapper-&gt;Native()));</span>
<a href="#l19.54"></a><span id="l19.54">     NS_ASSERTION(isStatement, &quot;How is this not a statement?!&quot;);</span>
<a href="#l19.55"></a><span id="l19.55">   }</span>
<a href="#l19.56"></a><span id="l19.56"> #endif</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+    static_cast&lt;mozIStorageStatement *&gt;(aWrapper-&gt;Native())</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  );</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+</span>
<a href="#l19.62"></a><span id="l19.62">   const char *propName = ::JS_GetStringBytes(JSVAL_TO_STRING(aId));</span>
<a href="#l19.63"></a><span id="l19.63">   if (::strcmp(propName, &quot;row&quot;) == 0)</span>
<a href="#l19.64"></a><span id="l19.64">     return getRow(stmt, aCtx, aScopeObj, _result);</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66">   if (::strcmp(propName, &quot;params&quot;) == 0)</span>
<a href="#l19.67"></a><span id="l19.67">     return getParams(stmt, aCtx, aScopeObj, _result);</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/storage-backport/style.txt</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/storage-backport/style.txt</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -26,16 +26,20 @@ will be enforcing them, so please obey t</span>
<a href="#l20.4"></a><span id="l20.4"> * Function declarations should include javadoc style comments.</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> * Javadoc @param tags should have the parameter description start on a new line</span>
<a href="#l20.7"></a><span id="l20.7">   aligned with the variable name.  See the example below.</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> * Javadoc @return (note: non-plural) continuation lines should be lined up with</span>
<a href="#l20.10"></a><span id="l20.10">   the initial comment.  See the example below.</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+* Javadoc @throws, like @param, should have the exception type on the same line</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  as the @throws and the description on a new line indented to line up with</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  the type of the exception.</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+</span>
<a href="#l20.16"></a><span id="l20.16"> * For function implementations, each argument should be on its own line.</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> * All variables should use camelCase.</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> * The use of bool is encouraged whenever the variable does not have the</span>
<a href="#l20.21"></a><span id="l20.21">   potential to go through xpconnect.</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23"> * For pointer variable types, include a space after the type before the asterisk</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineat">@@ -63,30 +67,34 @@ BIG EXAMPLE:</span>
<a href="#l20.25"></a><span id="l20.25">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27"> #ifndef mozilla_storage_FILENAME_h_</span>
<a href="#l20.28"></a><span id="l20.28"> #define mozilla_storage_FILENAME_h_</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30"> namespace mozilla {</span>
<a href="#l20.31"></a><span id="l20.31"> namespace storage {</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-class Foo : Bar</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-          , Baz</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+class Foo : public Bar</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+          , public Baz</span>
<a href="#l20.37"></a><span id="l20.37"> {</span>
<a href="#l20.38"></a><span id="l20.38"> public:</span>
<a href="#l20.39"></a><span id="l20.39">   /**</span>
<a href="#l20.40"></a><span id="l20.40">    * Brief function summary.</span>
<a href="#l20.41"></a><span id="l20.41">    *</span>
<a href="#l20.42"></a><span id="l20.42">    * @param aArg1</span>
<a href="#l20.43"></a><span id="l20.43">    *        Description description description description description etc etc</span>
<a href="#l20.44"></a><span id="l20.44">    *        next line of description.</span>
<a href="#l20.45"></a><span id="l20.45">    * @param aArg2</span>
<a href="#l20.46"></a><span id="l20.46">    *        Description description description.</span>
<a href="#l20.47"></a><span id="l20.47">    * @return Description description description description description etc etc</span>
<a href="#l20.48"></a><span id="l20.48">    *         next line of description.</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+   *</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+   * @throws NS_ERROR_FAILURE</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+   *         Okay, so this is for JavaScript code, but you probably get the</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+   *         idea.</span>
<a href="#l20.53"></a><span id="l20.53">    */</span>
<a href="#l20.54"></a><span id="l20.54">   int chew(int aArg1, int aArg2);</span>
<a href="#l20.55"></a><span id="l20.55"> };</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57"> } // storage</span>
<a href="#l20.58"></a><span id="l20.58"> } // mozilla</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60"> #endif // mozilla_storage_FILENAME_h_</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineat">@@ -107,16 +115,21 @@ NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l20.62"></a><span id="l20.62"> )</span>
<a href="#l20.63"></a><span id="l20.63"> </span>
<a href="#l20.64"></a><span id="l20.64"> Foo::Foo(</span>
<a href="#l20.65"></a><span id="l20.65">   LongArgumentLineThatWouldOtherwiseOverflow *aArgument1</span>
<a href="#l20.66"></a><span id="l20.66"> )</span>
<a href="#l20.67"></a><span id="l20.67"> : mField1(0)</span>
<a href="#l20.68"></a><span id="l20.68"> , mField2(0)</span>
<a href="#l20.69"></a><span id="l20.69"> {</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  someMethodWithLotsOfParamsOrJustLongParameters(</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+    mLongFieldNameThatIsJustified,</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    mMaybeThisOneIsLessJustifiedButBoyIsItLong,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    15</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+  );</span>
<a href="#l20.75"></a><span id="l20.75"> }</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.78"></a><span id="l20.78"> //// Separate sections of the file like this</span>
<a href="#l20.79"></a><span id="l20.79"> </span>
<a href="#l20.80"></a><span id="l20.80"> int</span>
<a href="#l20.81"></a><span id="l20.81"> Foo::chew(int aArg1, int aArg2)</span>
<a href="#l20.82"></a><span id="l20.82"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/storage-backport/test/test_true_async.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/storage-backport/test/test_true_async.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -248,43 +248,46 @@ private:</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l21.6"></a><span id="l21.6"> //// Async Helpers</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> /**</span>
<a href="#l21.9"></a><span id="l21.9">  * Execute an async statement, blocking the main thread until we get the</span>
<a href="#l21.10"></a><span id="l21.10">  * callback completion notification.</span>
<a href="#l21.11"></a><span id="l21.11">  */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-void blocking_async_execute(mozIStorageBaseStatement *stmt)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+void</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+blocking_async_execute(mozIStorageBaseStatement *stmt)</span>
<a href="#l21.15"></a><span id="l21.15"> {</span>
<a href="#l21.16"></a><span id="l21.16">   nsRefPtr&lt;AsyncStatementSpinner&gt; spinner(new AsyncStatementSpinner());</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18">   nsCOMPtr&lt;mozIStoragePendingStatement&gt; pendy;</span>
<a href="#l21.19"></a><span id="l21.19">   (void)stmt-&gt;ExecuteAsync(spinner, getter_AddRefs(pendy));</span>
<a href="#l21.20"></a><span id="l21.20">   spinner-&gt;SpinUntilCompleted();</span>
<a href="#l21.21"></a><span id="l21.21"> }</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23"> /**</span>
<a href="#l21.24"></a><span id="l21.24">  * Invoke AsyncClose on the given connection, blocking the main thread until we</span>
<a href="#l21.25"></a><span id="l21.25">  * get the completion notification.</span>
<a href="#l21.26"></a><span id="l21.26">  */</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-void blocking_async_close(mozIStorageConnection *db)</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+void</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+blocking_async_close(mozIStorageConnection *db)</span>
<a href="#l21.30"></a><span id="l21.30"> {</span>
<a href="#l21.31"></a><span id="l21.31">   nsRefPtr&lt;AsyncStatementSpinner&gt; spinner(new AsyncStatementSpinner());</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33">   db-&gt;AsyncClose(spinner);</span>
<a href="#l21.34"></a><span id="l21.34">   spinner-&gt;SpinUntilCompleted();</span>
<a href="#l21.35"></a><span id="l21.35"> }</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37"> /**</span>
<a href="#l21.38"></a><span id="l21.38">  * A horrible hack to figure out what the connection's async thread is.  By</span>
<a href="#l21.39"></a><span id="l21.39">  * creating a statement and async dispatching we can tell from the mutex who</span>
<a href="#l21.40"></a><span id="l21.40">  * is the async thread, PRThread style.  Then we map that to an nsIThread.</span>
<a href="#l21.41"></a><span id="l21.41">  */</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-already_AddRefed&lt;nsIThread&gt; get_conn_async_thread(mozIStorageConnection *db)</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+already_AddRefed&lt;nsIThread&gt;</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+get_conn_async_thread(mozIStorageConnection *db)</span>
<a href="#l21.45"></a><span id="l21.45"> {</span>
<a href="#l21.46"></a><span id="l21.46">   // Make sure we are tracking the current thread as the watched thread</span>
<a href="#l21.47"></a><span id="l21.47">   watch_for_mutex_use_on_this_thread();</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49">   // - statement with nothing to bind</span>
<a href="#l21.50"></a><span id="l21.50">   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt;</span>
<a href="#l21.51"></a><span id="l21.51">   db-&gt;CreateAsyncStatement(</span>
<a href="#l21.52"></a><span id="l21.52">     NS_LITERAL_CSTRING(&quot;SELECT 1&quot;),</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineat">@@ -313,34 +316,37 @@ test_TrueAsyncStatement()</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   // Start watching for forbidden mutex usage.</span>
<a href="#l21.56"></a><span id="l21.56">   watch_for_mutex_use_on_this_thread();</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58">   // - statement with nothing to bind</span>
<a href="#l21.59"></a><span id="l21.59">   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt;</span>
<a href="#l21.60"></a><span id="l21.60">   db-&gt;CreateAsyncStatement(</span>
<a href="#l21.61"></a><span id="l21.61">     NS_LITERAL_CSTRING(&quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-    getter_AddRefs(stmt));</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+    getter_AddRefs(stmt)</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+  );</span>
<a href="#l21.65"></a><span id="l21.65">   blocking_async_execute(stmt);</span>
<a href="#l21.66"></a><span id="l21.66">   stmt-&gt;Finalize();</span>
<a href="#l21.67"></a><span id="l21.67">   do_check_false(mutex_used_on_watched_thread);</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   // - statement with something to bind ordinally</span>
<a href="#l21.70"></a><span id="l21.70">   db-&gt;CreateAsyncStatement(</span>
<a href="#l21.71"></a><span id="l21.71">     NS_LITERAL_CSTRING(&quot;INSERT INTO test (id) VALUES (?)&quot;),</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    getter_AddRefs(stmt));</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+    getter_AddRefs(stmt)</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  );</span>
<a href="#l21.75"></a><span id="l21.75">   stmt-&gt;BindInt32Parameter(0, 1);</span>
<a href="#l21.76"></a><span id="l21.76">   blocking_async_execute(stmt);</span>
<a href="#l21.77"></a><span id="l21.77">   stmt-&gt;Finalize();</span>
<a href="#l21.78"></a><span id="l21.78">   do_check_false(mutex_used_on_watched_thread);</span>
<a href="#l21.79"></a><span id="l21.79">   </span>
<a href="#l21.80"></a><span id="l21.80">   // - statement with something to bind by name</span>
<a href="#l21.81"></a><span id="l21.81">   db-&gt;CreateAsyncStatement(</span>
<a href="#l21.82"></a><span id="l21.82">     NS_LITERAL_CSTRING(&quot;INSERT INTO test (id) VALUES (:id)&quot;),</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-    getter_AddRefs(stmt));</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+    getter_AddRefs(stmt)</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+  );</span>
<a href="#l21.86"></a><span id="l21.86">   nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; paramsArray;</span>
<a href="#l21.87"></a><span id="l21.87">   stmt-&gt;NewBindingParamsArray(getter_AddRefs(paramsArray));</span>
<a href="#l21.88"></a><span id="l21.88">   nsCOMPtr&lt;mozIStorageBindingParams&gt; params;</span>
<a href="#l21.89"></a><span id="l21.89">   paramsArray-&gt;NewBindingParams(getter_AddRefs(params));</span>
<a href="#l21.90"></a><span id="l21.90">   params-&gt;BindInt32ByName(NS_LITERAL_CSTRING(&quot;id&quot;), 2);</span>
<a href="#l21.91"></a><span id="l21.91">   paramsArray-&gt;AddParams(params);</span>
<a href="#l21.92"></a><span id="l21.92">   params = nsnull;</span>
<a href="#l21.93"></a><span id="l21.93">   stmt-&gt;BindParameters(paramsArray);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineat">@@ -374,29 +380,31 @@ test_AsyncCancellation()</span>
<a href="#l21.95"></a><span id="l21.95">   do_check_true(target);</span>
<a href="#l21.96"></a><span id="l21.96">   nsRefPtr&lt;ThreadWedger&gt; wedger (new ThreadWedger(target));</span>
<a href="#l21.97"></a><span id="l21.97"> </span>
<a href="#l21.98"></a><span id="l21.98">   // -- create statements and cancel them</span>
<a href="#l21.99"></a><span id="l21.99">   // - async</span>
<a href="#l21.100"></a><span id="l21.100">   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; asyncStmt;</span>
<a href="#l21.101"></a><span id="l21.101">   db-&gt;CreateAsyncStatement(</span>
<a href="#l21.102"></a><span id="l21.102">     NS_LITERAL_CSTRING(&quot;CREATE TABLE asyncTable (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-    getter_AddRefs(asyncStmt));</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+    getter_AddRefs(asyncStmt)</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+  );</span>
<a href="#l21.106"></a><span id="l21.106"> </span>
<a href="#l21.107"></a><span id="l21.107">   nsRefPtr&lt;AsyncStatementSpinner&gt; asyncSpin(new AsyncStatementSpinner());</span>
<a href="#l21.108"></a><span id="l21.108">   nsCOMPtr&lt;mozIStoragePendingStatement&gt; asyncPend;</span>
<a href="#l21.109"></a><span id="l21.109">   (void)asyncStmt-&gt;ExecuteAsync(asyncSpin, getter_AddRefs(asyncPend));</span>
<a href="#l21.110"></a><span id="l21.110">   do_check_true(asyncPend);</span>
<a href="#l21.111"></a><span id="l21.111">   asyncPend-&gt;Cancel();</span>
<a href="#l21.112"></a><span id="l21.112"> </span>
<a href="#l21.113"></a><span id="l21.113">   // - sync</span>
<a href="#l21.114"></a><span id="l21.114">   nsCOMPtr&lt;mozIStorageStatement&gt; syncStmt;</span>
<a href="#l21.115"></a><span id="l21.115">   db-&gt;CreateStatement(</span>
<a href="#l21.116"></a><span id="l21.116">     NS_LITERAL_CSTRING(&quot;CREATE TABLE syncTable (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-    getter_AddRefs(syncStmt));</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+    getter_AddRefs(syncStmt)</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+  );</span>
<a href="#l21.120"></a><span id="l21.120"> </span>
<a href="#l21.121"></a><span id="l21.121">   nsRefPtr&lt;AsyncStatementSpinner&gt; syncSpin(new AsyncStatementSpinner());</span>
<a href="#l21.122"></a><span id="l21.122">   nsCOMPtr&lt;mozIStoragePendingStatement&gt; syncPend;</span>
<a href="#l21.123"></a><span id="l21.123">   (void)syncStmt-&gt;ExecuteAsync(syncSpin, getter_AddRefs(syncPend));</span>
<a href="#l21.124"></a><span id="l21.124">   do_check_true(syncPend);</span>
<a href="#l21.125"></a><span id="l21.125">   syncPend-&gt;Cancel();</span>
<a href="#l21.126"></a><span id="l21.126"> </span>
<a href="#l21.127"></a><span id="l21.127">   // -- unwedge the async thread</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/storage-backport/test/unit/test_statement_executeAsync.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/storage-backport/test/unit/test_statement_executeAsync.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -603,16 +603,17 @@ function test_bind_multiple_rows_by_inde</span>
<a href="#l22.4"></a><span id="l22.4">   for (let i = 0; i &lt; AMOUNT_TO_ADD; i++) {</span>
<a href="#l22.5"></a><span id="l22.5">     let bp = array.newBindingParams();</span>
<a href="#l22.6"></a><span id="l22.6">     bp.bindByIndex(0, INTEGER);</span>
<a href="#l22.7"></a><span id="l22.7">     bp.bindByIndex(1, TEXT);</span>
<a href="#l22.8"></a><span id="l22.8">     bp.bindByIndex(2, REAL);</span>
<a href="#l22.9"></a><span id="l22.9">     bp.bindByIndex(3, null);</span>
<a href="#l22.10"></a><span id="l22.10">     bp.bindBlobByIndex(4, BLOB, BLOB.length);</span>
<a href="#l22.11"></a><span id="l22.11">     array.addParams(bp);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+    do_check_eq(array.length, i + 1);</span>
<a href="#l22.13"></a><span id="l22.13">   }</span>
<a href="#l22.14"></a><span id="l22.14">   stmt.bindParameters(array);</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">   let rowCount = getTableRowCount(&quot;test&quot;);</span>
<a href="#l22.17"></a><span id="l22.17">   execAsync(stmt);</span>
<a href="#l22.18"></a><span id="l22.18">   do_check_eq(rowCount + AMOUNT_TO_ADD, getTableRowCount(&quot;test&quot;));</span>
<a href="#l22.19"></a><span id="l22.19">   stmt.finalize();</span>
<a href="#l22.20"></a><span id="l22.20">   run_next_test();</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -629,16 +630,17 @@ function test_bind_multiple_rows_by_name</span>
<a href="#l22.22"></a><span id="l22.22">   for (let i = 0; i &lt; AMOUNT_TO_ADD; i++) {</span>
<a href="#l22.23"></a><span id="l22.23">     let bp = array.newBindingParams();</span>
<a href="#l22.24"></a><span id="l22.24">     bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l22.25"></a><span id="l22.25">     bp.bindByName(&quot;text&quot;, TEXT);</span>
<a href="#l22.26"></a><span id="l22.26">     bp.bindByName(&quot;real&quot;, REAL);</span>
<a href="#l22.27"></a><span id="l22.27">     bp.bindByName(&quot;null&quot;, null);</span>
<a href="#l22.28"></a><span id="l22.28">     bp.bindBlobByName(&quot;blob&quot;, BLOB, BLOB.length);</span>
<a href="#l22.29"></a><span id="l22.29">     array.addParams(bp);</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+    do_check_eq(array.length, i + 1);</span>
<a href="#l22.31"></a><span id="l22.31">   }</span>
<a href="#l22.32"></a><span id="l22.32">   stmt.bindParameters(array);</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">   let rowCount = getTableRowCount(&quot;test&quot;);</span>
<a href="#l22.35"></a><span id="l22.35">   execAsync(stmt);</span>
<a href="#l22.36"></a><span id="l22.36">   do_check_eq(rowCount + AMOUNT_TO_ADD, getTableRowCount(&quot;test&quot;));</span>
<a href="#l22.37"></a><span id="l22.37">   stmt.finalize();</span>
<a href="#l22.38"></a><span id="l22.38">   run_next_test();</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineat">@@ -885,16 +887,34 @@ function test_not_right_owning_statement</span>
<a href="#l22.40"></a><span id="l22.40">   expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l22.41"></a><span id="l22.41">               function() stmt2.bindParameters(array1));</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">   stmt1.finalize();</span>
<a href="#l22.44"></a><span id="l22.44">   stmt2.finalize();</span>
<a href="#l22.45"></a><span id="l22.45">   run_next_test();</span>
<a href="#l22.46"></a><span id="l22.46"> }</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+function test_bind_empty_array()</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+{</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  );</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+  let paramsArray = stmt.newBindingParamsArray();</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+  // We should not be able to bind this array to the statement because it is</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+  // empty.</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+              function() stmt.bindParameters(paramsArray));</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  stmt.finalize();</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+  run_next_test();</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+}</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+</span>
<a href="#l22.66"></a><span id="l22.66"> function test_multiple_results()</span>
<a href="#l22.67"></a><span id="l22.67"> {</span>
<a href="#l22.68"></a><span id="l22.68">   let expectedResults = getTableRowCount(&quot;test&quot;);</span>
<a href="#l22.69"></a><span id="l22.69">   // Sanity check - we should have more than one result, but let's be sure.</span>
<a href="#l22.70"></a><span id="l22.70">   do_check_true(expectedResults &gt; 1);</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72">   // Now check that we get back two rows of data from our async query.</span>
<a href="#l22.73"></a><span id="l22.73">   let stmt = makeTestStatement(&quot;SELECT * FROM test&quot;);</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineat">@@ -960,16 +980,17 @@ var tests =</span>
<a href="#l22.75"></a><span id="l22.75">   test_bind_out_of_bounds_sync_immediate,</span>
<a href="#l22.76"></a><span id="l22.76">   test_bind_out_of_bounds_async_deferred,</span>
<a href="#l22.77"></a><span id="l22.77">   test_bind_no_such_name_sync_immediate,</span>
<a href="#l22.78"></a><span id="l22.78">   test_bind_no_such_name_async_deferred,</span>
<a href="#l22.79"></a><span id="l22.79">   test_bind_bogus_type_by_index,</span>
<a href="#l22.80"></a><span id="l22.80">   test_bind_bogus_type_by_name,</span>
<a href="#l22.81"></a><span id="l22.81">   test_bind_params_already_locked,</span>
<a href="#l22.82"></a><span id="l22.82">   test_bind_params_array_already_locked,</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+  test_bind_empty_array,</span>
<a href="#l22.84"></a><span id="l22.84">   test_no_binding_params_from_locked_array,</span>
<a href="#l22.85"></a><span id="l22.85">   test_not_right_owning_array,</span>
<a href="#l22.86"></a><span id="l22.86">   test_not_right_owning_statement,</span>
<a href="#l22.87"></a><span id="l22.87">   test_multiple_results,</span>
<a href="#l22.88"></a><span id="l22.88"> ];</span>
<a href="#l22.89"></a><span id="l22.89"> let index = 0;</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91"> const STARTING_UNIQUE_ID = 2;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

